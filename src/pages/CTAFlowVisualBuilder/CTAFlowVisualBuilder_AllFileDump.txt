Folder and File Content Report
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\CTAFlowLogs.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../api/axiosClient";
import { Card } from "../../components/ui/card";
import { Table, Thead, Tbody, Tr, Th, Td } from "../../components/ui/table";
import { format } from "date-fns";

const CTAFlowLogs = () => {
  const [logs, setLogs] = useState([]);

  useEffect(() => {
    axiosClient.get("/tracking/flow-clicks").then(res => {
      setLogs(res.data);
    });
  }, []);

  return (
    <div className="p-6">
      <h2 className="text-2xl font-bold mb-4">CTA Flow Click Logs</h2>
      <Card className="overflow-x-auto">
        <Table>
          <Thead>
            <Tr>
              <Th>Date</Th>
              <Th>Recipient</Th>
              <Th>Button</Th>
              <Th>Template</Th>
              <Th>Step ID</Th>
              <Th>Follow-Up</Th>
            </Tr>
          </Thead>
          <Tbody>
            {logs.map(log => (
              <Tr key={log.id}>
                <Td>
                  {format(new Date(log.clickedAt), "dd MMM yyyy hh:mm a")}
                </Td>
                <Td>{log.contactPhone}</Td>
                <Td>{log.buttonText}</Td>
                <Td>{log.templateId}</Td>
                <Td className="text-xs">{log.stepId}</Td>
                <Td>
                  {log.followUpSent ? (
                    <span className="text-green-600 font-semibold">‚úÖ Yes</span>
                  ) : (
                    <span className="text-gray-500">‚Äî</span>
                  )}
                </Td>
              </Tr>
            ))}
          </Tbody>
        </Table>
      </Card>
    </div>
  );
};

export default CTAFlowLogs;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\CTAFlowManager.jsx 
====================================================== 
 
// üìÑ File: src/pages/CTAFlowVisualBuilder/CTAFlowManager.jsx
import React, { useEffect, useMemo, useRef, useState } from "react";
import { useNavigate, useSearchParams } from "react-router-dom";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";

export default function CTAFlowManager() {
  const [flows, setFlows] = useState([]);
  const [loading, setLoading] = useState(true);

  const [modalOpen, setModalOpen] = useState(false);
  const [modalMode, setModalMode] = useState("confirm"); // confirm | attached
  const [modalCampaigns, setModalCampaigns] = useState([]);
  const [targetFlow, setTargetFlow] = useState(null);

  const [query, setQuery] = useState("");
  const [sortKey, setSortKey] = useState("updated");
  const closeBtnRef = useRef(null);
  const navigate = useNavigate();

  // NEW: read ?tab= from URL (published | draft). Default to 'published'
  const [searchParams, setSearchParams] = useSearchParams();
  const tabFromUrl =
    searchParams.get("tab") === "draft" ? "draft" : "published";
  const [activeTab, setActiveTab] = useState(tabFromUrl);

  const formatDate = date =>
    date
      ? new Date(date).toLocaleString("en-IN", {
          day: "2-digit",
          month: "short",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        })
      : "‚Äî";

  const statusPill = isPublished =>
    isPublished ? (
      <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">
        <span>‚óè</span> Published
      </span>
    ) : (
      <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">
        <span>‚óè</span> Draft
      </span>
    );

  const fetchFlows = async (tab = "published") => {
    setLoading(true);
    try {
      const endpoint =
        tab === "published" ? "/cta-flow/all-published" : "/cta-flow/all-draft";
      const res = await axiosClient.get(endpoint);
      setFlows(Array.isArray(res.data) ? res.data : [res.data]);
    } catch (err) {
      setFlows([]);
      toast.error("‚ùå Failed to load flows.");
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  // NEW: whenever ?tab changes (or on first render), sync state and fetch
  useEffect(() => {
    const tab = searchParams.get("tab") === "draft" ? "draft" : "published";
    setActiveTab(tab);
    fetchFlows(tab);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [searchParams]);

  const filtered = useMemo(() => {
    const q = query.trim().toLowerCase();
    let out = flows;
    if (q) {
      out = out.filter(f =>
        [f.flowName, f.createdBy]
          .filter(Boolean)
          .some(v => String(v).toLowerCase().includes(q))
      );
    }
    switch (sortKey) {
      case "name":
        return [...out].sort((a, b) => a.flowName.localeCompare(b.flowName));
      case "created":
        return [...out].sort(
          (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
        );
      default:
        return [...out].sort(
          (a, b) =>
            new Date(b.updatedAt || b.createdAt) -
            new Date(a.updatedAt || a.createdAt)
        );
    }
  }, [flows, query, sortKey]);

  // ---- delete UX (checks usage) ----
  const openDeleteModal = async flow => {
    if (loading) return; // guard
    setTargetFlow(flow);
    setLoading(true);
    try {
      const { data } = await axiosClient.get(`/cta-flow/${flow.id}/usage`);
      if (data?.canDelete) {
        setModalMode("confirm");
        setModalCampaigns([]);
      } else {
        setModalMode("attached");
        setModalCampaigns(Array.isArray(data?.campaigns) ? data.campaigns : []);
      }
      setModalOpen(true);
      setTimeout(() => closeBtnRef.current?.focus(), 0);
    } catch (err) {
      toast.error("‚ùå Could not check usage for this flow.");
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  const confirmDelete = async () => {
    if (!targetFlow) return;
    setLoading(true);
    try {
      const res = await axiosClient.delete(`/cta-flow/${targetFlow.id}`);
      if (res.status === 204 || res.status === 200) {
        toast.success("‚úÖ Flow deleted permanently.");
        setModalOpen(false);
        setTargetFlow(null);
        await fetchFlows(activeTab);
      } else {
        toast.info("‚ÑπÔ∏è Unexpected response while deleting the flow.");
      }
    } catch (err) {
      const status = err?.response?.status;
      if (status === 409) {
        const campaigns = err.response?.data?.campaigns ?? [];
        setModalMode("attached");
        setModalCampaigns(campaigns);
      } else if (status === 404) {
        toast.error("‚ùå Flow not found.");
        setModalOpen(false);
      } else {
        toast.error("‚ùå Failed to delete flow.");
        setModalOpen(false);
      }
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  // ---- publish from draft tab ----
  const publishFlow = async flow => {
    if (loading) return;
    try {
      setLoading(true);
      await axiosClient.post(`/cta-flow/${flow.id}/publish`);
      toast.success("‚úÖ Flow published.");
      // NEW: when publishing, move to Published tab (and reflect in URL)
      setSearchParams({ tab: "published" });
    } catch (err) {
      const status = err?.response?.status;
      if (status === 409) {
        toast.error(
          err?.response?.data?.message || "‚ùå Cannot publish right now."
        );
      } else if (status === 404) {
        toast.error("‚ùå Flow not found.");
      } else {
        toast.error("‚ùå Failed to publish flow.");
      }
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  const goView = flow => {
    if (loading) return;
    navigate(`/app/cta-flow/visual-builder?id=${flow.id}&mode=view`);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 to-emerald-50 relative">
      <div className="mx-auto max-w-7xl px-4 py-8">
        {/* Loading overlay */}
        {loading && (
          <>
            <div className="absolute inset-0 z-40 bg-white/60 backdrop-blur-[1px] flex items-center justify-center">
              <div className="flex items-center gap-3 text-gray-700">
                <svg
                  className="xafb-spin h-6 w-6 text-purple-600"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                >
                  <circle
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    strokeWidth="4"
                    opacity="0.25"
                  />
                  <path
                    d="M4 12a8 8 0 018-8"
                    stroke="currentColor"
                    strokeWidth="4"
                    strokeLinecap="round"
                    opacity="0.85"
                  />
                </svg>
                <span className="text-sm">Loading‚Ä¶</span>
              </div>
            </div>
            <style>{`@keyframes xafb-spin{to{transform:rotate(360deg)}}.xafb-spin{animation:xafb-spin 1s linear infinite}`}</style>
          </>
        )}

        {/* Header */}
        <div className="mb-8">
          <div className="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
            <div className="flex items-center gap-4">
              <div className="flex items-center gap-3">
                <div className="w-12 h-12 border border-gray-300 bg-gray-50 rounded-lg flex items-center justify-center">
                  <span className="text-gray-600 text-xl">üß©</span>
                </div>
                <div>
                  <h1
                    className="text-2xl font-bold text-gray-900 flex items-center gap-2"
                    style={{ fontFamily: "Plus Jakarta Sans, sans-serif" }}
                  >
                    <span className="text-blue-600">üß©</span>
                    CTA Flow Manager
                  </h1>
                  <p className="text-sm text-gray-600">
                    Create, publish, and manage your visual flows.
                  </p>
                </div>
              </div>
            </div>
            <div className="flex items-center gap-3">
              <button
                onClick={() => navigate("/app/cta-flow/visual-builder")}
                className="border-2 border-emerald-600 text-emerald-600 hover:bg-emerald-600 hover:text-white px-4 py-2 rounded-lg shadow-sm hover:shadow-lg transition-all duration-200 disabled:opacity-50 flex items-center gap-1.5 text-sm"
                disabled={loading}
              >
                <span className="text-sm text-gray-600">‚ûï</span>
                New Flow
              </button>
            </div>
          </div>
        </div>

        {/* Sticky controls */}
        <div className="sticky top-0 z-10 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70 rounded-lg border border-gray-200 p-4 mb-6 shadow-sm">
          <div className="flex flex-col lg:flex-row lg:items-center gap-4">
            {/* Tabs */}
            <div className="flex gap-2">
              {[
                { key: "published", label: "Published Flows", icon: "‚úÖ" },
                { key: "draft", label: "Draft Flows", icon: "üìù" },
              ].map(t => (
                <button
                  key={t.key}
                  className={`px-4 py-2.5 rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-2 ${
                    activeTab === t.key
                      ? "bg-emerald-600 text-white shadow-lg"
                      : "border border-gray-300 text-gray-600 hover:border-emerald-600 hover:text-emerald-600 hover:bg-emerald-50"
                  }`}
                  onClick={() => {
                    if (loading) return;
                    setSearchParams({ tab: t.key });
                  }}
                  disabled={loading}
                >
                  <span>{t.icon}</span>
                  {t.label}
                </button>
              ))}
            </div>

            <div className="flex-1" />

            {/* Search + sort */}
            <div className="flex items-center gap-3">
              <div className="relative">
                <input
                  type="text"
                  className="w-64 max-w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 text-sm pl-10 pr-4 py-2.5"
                  placeholder="Search by name or creator‚Ä¶"
                  value={query}
                  onChange={e => setQuery(e.target.value)}
                />
                <div className="absolute inset-y-0 left-3 grid place-items-center pointer-events-none text-gray-400">
                  üîé
                </div>
              </div>
              <select
                className="rounded-lg border-gray-300 text-sm focus:ring-blue-500 focus:border-blue-500 px-4 py-2.5"
                value={sortKey}
                onChange={e => setSortKey(e.target.value)}
              >
                <option value="updated">Sort: Last updated</option>
                <option value="name">Sort: Name (A‚ÄìZ)</option>
                <option value="created">Sort: Created (newest)</option>
              </select>
            </div>
          </div>
        </div>

        {/* Content */}
        {filtered.length === 0 ? (
          <div className="text-center py-16">
            <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <span className="text-2xl text-gray-400">üß©</span>
            </div>
            <h3 className="text-lg font-medium text-gray-900 mb-2">
              {query
                ? "No flows match your search"
                : activeTab === "published"
                ? "No published flows yet"
                : "No draft flows yet"}
            </h3>
            <p className="text-gray-500 mb-6">
              {query
                ? "Try adjusting your search terms"
                : activeTab === "published"
                ? "Publish a draft to see it here"
                : "Create a new flow to get started"}
            </p>
            {!query && (
              <button
                onClick={() => navigate("/app/cta-flow/visual-builder")}
                className="border-2 border-emerald-600 text-emerald-600 hover:bg-emerald-600 hover:text-white px-6 py-3 rounded-lg shadow-sm hover:shadow-lg transition-all duration-200 flex items-center gap-2 mx-auto"
              >
                <span className="text-lg">‚ûï</span>
                Create Your First Flow
              </button>
            )}
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {filtered.map(flow => (
              <div
                key={flow.id}
                className="bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-lg transition-all duration-200 overflow-hidden"
              >
                <div className="p-6">
                  <div className="flex items-start justify-between mb-4">
                    <div className="flex-1">
                      <h3 className="text-lg font-semibold text-gray-900 mb-1">
                        {flow.flowName}
                      </h3>
                      <p className="text-sm text-gray-500">
                        Created {formatDate(flow.createdAt)}
                      </p>
                    </div>
                    <div className="ml-3">{statusPill(flow.isPublished)}</div>
                  </div>

                  <div className="text-sm text-gray-600 mb-4">
                    <div className="flex items-center gap-2">
                      <span className="text-gray-400">üìÖ</span>
                      <span>
                        Last modified:{" "}
                        {formatDate(flow.updatedAt || flow.createdAt)}
                      </span>
                    </div>
                  </div>

                  <div className="flex items-center gap-2">
                    <button
                      onClick={() => goView(flow)}
                      className="flex-1 border-2 border-gray-300 bg-white hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 disabled:opacity-50"
                      disabled={loading}
                    >
                      üëÅÔ∏è View
                    </button>

                    {/* PUBLISH (only for drafts) */}
                    {!flow.isPublished && (
                      <button
                        onClick={() => publishFlow(flow)}
                        className="flex-1 border-2 border-transparent bg-gradient-to-r from-emerald-200 to-emerald-300 hover:from-emerald-300 hover:to-emerald-400 text-emerald-700 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 disabled:opacity-50"
                        disabled={loading}
                        title="Publish this draft"
                      >
                        üöÄ Publish
                      </button>
                    )}

                    <button
                      onClick={() => openDeleteModal(flow)}
                      className="border-2 border-transparent bg-gradient-to-r from-gray-200 to-gray-300 hover:from-gray-300 hover:to-gray-400 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 disabled:opacity-50"
                      disabled={loading}
                    >
                      üóëÔ∏è
                    </button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Modal */}
      {modalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
          <div
            className="absolute inset-0 bg-black/50 backdrop-blur-sm"
            onClick={() => setModalOpen(false)}
          />
          <div
            role="dialog"
            aria-modal="true"
            className="relative bg-white rounded-lg shadow-2xl w-full max-w-xl p-8"
          >
            {modalMode === "attached" ? (
              <>
                <div className="flex items-start gap-4 mb-6">
                  <div className="shrink-0 mt-1 h-10 w-10 rounded-full bg-rose-100 text-rose-600 grid place-items-center">
                    ‚ö†Ô∏è
                  </div>
                  <div>
                    <h3 className="text-xl font-bold text-gray-900 mb-2">
                      Cannot delete this flow
                    </h3>
                    <p className="text-gray-600">
                      <span className="font-semibold text-gray-900">
                        {targetFlow?.flowName}
                      </span>{" "}
                      is attached to the following campaign
                      {modalCampaigns.length > 1 ? "s" : ""}. Delete those
                      first.
                    </p>
                  </div>
                </div>
                <div className="max-h-72 overflow-auto rounded-lg border divide-y">
                  {modalCampaigns.map(c => (
                    <div key={c.id} className="p-3 text-sm">
                      <div className="flex items-center justify-between">
                        <div className="font-semibold text-gray-900">
                          {c.name}
                        </div>
                        <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-700">
                          {c.status || "‚Äî"}
                        </span>
                      </div>
                      <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
                        <div>
                          Created:{" "}
                          <span className="font-medium text-gray-800">
                            {formatDate(c.createdAt)}
                          </span>
                        </div>
                        <div>
                          Created by:{" "}
                          <span className="font-medium text-gray-800">
                            {c.createdBy || "‚Äî"}
                          </span>
                        </div>
                        <div>
                          Scheduled:{" "}
                          <span className="font-medium text-gray-800">
                            {formatDate(c.scheduledAt)}
                          </span>
                        </div>
                        <div>
                          First sent:{" "}
                          <span className="font-medium text-gray-800">
                            {formatDate(c.firstSentAt)}
                          </span>
                        </div>
                      </div>
                    </div>
                  ))}
                  {modalCampaigns.length === 0 && (
                    <div className="p-3 text-sm text-gray-600">
                      Could not load campaigns.
                    </div>
                  )}
                </div>
                <div className="mt-6 flex justify-end">
                  <button
                    ref={closeBtnRef}
                    className="px-6 py-3 text-sm font-medium rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors"
                    onClick={() => setModalOpen(false)}
                  >
                    Close
                  </button>
                </div>
              </>
            ) : (
              <>
                <div className="flex items-start gap-4 mb-6">
                  <div className="shrink-0 mt-1 h-10 w-10 rounded-full bg-rose-100 text-rose-600 grid place-items-center">
                    üóëÔ∏è
                  </div>
                  <div>
                    <h3 className="text-xl font-bold text-gray-900 mb-2">
                      Delete this flow permanently?
                    </h3>
                    <p className="text-gray-600">
                      This will remove{" "}
                      <span className="font-semibold text-gray-900">
                        {targetFlow?.flowName}
                      </span>{" "}
                      and all of its steps and button links. This action cannot
                      be undone.
                    </p>
                  </div>
                </div>
                <div className="rounded-lg border border-rose-200 p-4 bg-rose-50 text-rose-700 text-sm mb-6">
                  <span className="font-semibold">Warning:</span> Permanent
                  deletion cannot be recovered.
                </div>
                <div className="flex justify-end gap-3">
                  <button
                    className="px-6 py-3 text-sm font-medium rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors"
                    onClick={() => setModalOpen(false)}
                  >
                    Cancel
                  </button>
                  <button
                    onClick={confirmDelete}
                    className="px-6 py-3 text-sm font-medium rounded-lg bg-rose-600 text-white hover:bg-rose-700 transition-colors"
                  >
                    Permanently delete
                  </button>
                </div>
              </>
            )}
          </div>
        </div>
      )}
    </div>
  );
}

// // üìÑ File: xbytechat-ui/src/pages/CTAFlowVisualBuilder/CTAFlowManager.jsx
// import React, { useEffect, useMemo, useRef, useState } from "react";
// import { useNavigate } from "react-router-dom";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";

// export default function CTAFlowManager() {
//   const [flows, setFlows] = useState([]);
//   const [activeTab, setActiveTab] = useState("published"); // default Published
//   const [loading, setLoading] = useState(true);

//   const [modalOpen, setModalOpen] = useState(false);
//   const [modalMode, setModalMode] = useState("confirm"); // confirm | attached
//   const [modalCampaigns, setModalCampaigns] = useState([]);
//   const [targetFlow, setTargetFlow] = useState(null);

//   const [query, setQuery] = useState("");
//   const [sortKey, setSortKey] = useState("updated");
//   const closeBtnRef = useRef(null);
//   const navigate = useNavigate();

//   const formatDate = date =>
//     date
//       ? new Date(date).toLocaleString("en-IN", {
//           day: "2-digit",
//           month: "short",
//           year: "numeric",
//           hour: "2-digit",
//           minute: "2-digit",
//         })
//       : "‚Äî";

//   const statusPill = isPublished =>
//     isPublished ? (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">
//         <span>‚óè</span> Published
//       </span>
//     ) : (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">
//         <span>‚óè</span> Draft
//       </span>
//     );

//   const fetchFlows = async (tab = "published") => {
//     setLoading(true);
//     try {
//       const endpoint =
//         tab === "published" ? "/cta-flow/all-published" : "/cta-flow/all-draft";
//       const res = await axiosClient.get(endpoint);
//       setFlows(Array.isArray(res.data) ? res.data : [res.data]);
//     } catch (err) {
//       setFlows([]);
//       toast.error("‚ùå Failed to load flows.");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   useEffect(() => {
//     fetchFlows("published");
//   }, []);

//   const filtered = useMemo(() => {
//     const q = query.trim().toLowerCase();
//     let out = flows;
//     if (q) {
//       out = out.filter(f =>
//         [f.flowName, f.createdBy]
//           .filter(Boolean)
//           .some(v => String(v).toLowerCase().includes(q))
//       );
//     }
//     switch (sortKey) {
//       case "name":
//         return [...out].sort((a, b) => a.flowName.localeCompare(b.flowName));
//       case "created":
//         return [...out].sort(
//           (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
//         );
//       default:
//         return [...out].sort(
//           (a, b) =>
//             new Date(b.updatedAt || b.createdAt) -
//             new Date(a.updatedAt || a.createdAt)
//         );
//     }
//   }, [flows, query, sortKey]);

//   // ---- delete UX (checks usage) ----
//   const openDeleteModal = async flow => {
//     if (loading) return; // guard
//     setTargetFlow(flow);
//     setLoading(true);
//     try {
//       const { data } = await axiosClient.get(`/cta-flow/${flow.id}/usage`);
//       if (data?.canDelete) {
//         setModalMode("confirm");
//         setModalCampaigns([]);
//       } else {
//         setModalMode("attached");
//         setModalCampaigns(Array.isArray(data?.campaigns) ? data.campaigns : []);
//       }
//       setModalOpen(true);
//       setTimeout(() => closeBtnRef.current?.focus(), 0);
//     } catch (err) {
//       toast.error("‚ùå Could not check usage for this flow.");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   const confirmDelete = async () => {
//     if (!targetFlow) return;
//     setLoading(true);
//     try {
//       const res = await axiosClient.delete(`/cta-flow/${targetFlow.id}`);
//       if (res.status === 204 || res.status === 200) {
//         toast.success("‚úÖ Flow deleted permanently.");
//         setModalOpen(false);
//         setTargetFlow(null);
//         await fetchFlows(activeTab);
//       } else {
//         toast.info("‚ÑπÔ∏è Unexpected response while deleting the flow.");
//       }
//     } catch (err) {
//       const status = err?.response?.status;
//       if (status === 409) {
//         const campaigns = err.response?.data?.campaigns ?? [];
//         setModalMode("attached");
//         setModalCampaigns(campaigns);
//       } else if (status === 404) {
//         toast.error("‚ùå Flow not found.");
//         setModalOpen(false);
//       } else {
//         toast.error("‚ùå Failed to delete flow.");
//         setModalOpen(false);
//       }
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   // ---- publish from draft tab ----
//   const publishFlow = async flow => {
//     if (loading) return; // guard against spam clicks
//     try {
//       setLoading(true);
//       await axiosClient.post(`/cta-flow/${flow.id}/publish`);
//       toast.success("‚úÖ Flow published.");
//       // After publish, jump user to Published tab
//       setActiveTab("published");
//       await fetchFlows("published");
//     } catch (err) {
//       const status = err?.response?.status;
//       if (status === 409) {
//         // If backend blocks due to attachments (unlikely for drafts), surface message
//         toast.error(
//           err?.response?.data?.message || "‚ùå Cannot publish right now."
//         );
//       } else if (status === 404) {
//         toast.error("‚ùå Flow not found.");
//       } else {
//         toast.error("‚ùå Failed to publish flow.");
//       }
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   // ---- edit navigation (fix: ignore click while loading) ----
//   const goEdit = flow => {
//     if (loading) return;
//     // Always open builder in edit mode; builder enforces policies (fork/republish etc.)
//     navigate(`/app/cta-flow/visual-builder?id=${flow.id}&mode=edit`);
//   };

//   const goView = flow => {
//     if (loading) return;
//     navigate(`/app/cta-flow/visual-builder?id=${flow.id}&mode=view`);
//   };

//   return (
//     <div className="p-6 relative">
//       {/* Loading overlay */}
//       {loading && (
//         <>
//           <div className="absolute inset-0 z-40 bg-white/60 backdrop-blur-[1px] flex items-center justify-center">
//             <div className="flex items-center gap-3 text-gray-700">
//               <svg
//                 className="xafb-spin h-6 w-6 text-purple-600"
//                 xmlns="http://www.w3.org/2000/svg"
//                 viewBox="0 0 24 24"
//                 fill="none"
//               >
//                 <circle
//                   cx="12"
//                   cy="12"
//                   r="10"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   opacity="0.25"
//                 />
//                 <path
//                   d="M4 12a8 8 0 018-8"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   strokeLinecap="round"
//                   opacity="0.85"
//                 />
//               </svg>
//               <span className="text-sm">Loading‚Ä¶</span>
//             </div>
//           </div>
//           <style>{`@keyframes xafb-spin{to{transform:rotate(360deg)}}.xafb-spin{animation:xafb-spin 1s linear infinite}`}</style>
//         </>
//       )}

//       {/* Header */}
//       <div className="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between mb-6">
//         <div>
//           <h1 className="text-2xl font-bold text-gray-900">
//             üß© CTA Flow Manager
//           </h1>
//           <p className="text-sm text-gray-500">
//             Create, publish, and manage your visual flows.
//           </p>
//         </div>
//         <div className="flex items-center gap-2">
//           <button
//             onClick={() => navigate("/app/cta-flow/visual-builder")}
//             className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md shadow disabled:opacity-50"
//             disabled={loading}
//           >
//             ‚ûï New Flow
//           </button>
//         </div>
//       </div>

//       {/* Sticky controls */}
//       <div className="sticky top-0 z-10 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70 rounded-xl border p-3 mb-4">
//         <div className="flex flex-col sm:flex-row sm:items-center gap-3">
//           <div className="flex gap-3">
//             {[
//               { key: "published", label: "‚úÖ Published Flows" },
//               { key: "draft", label: "üìù Draft Flows" },
//             ].map(t => (
//               <button
//                 key={t.key}
//                 className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${
//                   activeTab === t.key
//                     ? "bg-purple-600 text-white shadow"
//                     : "text-gray-600 hover:text-purple-700 hover:bg-purple-50"
//                 }`}
//                 onClick={() => {
//                   if (loading) return;
//                   setActiveTab(t.key);
//                   fetchFlows(t.key);
//                 }}
//                 disabled={loading}
//               >
//                 {t.label}
//               </button>
//             ))}
//           </div>

//           <div className="flex-1" />

//           {/* Search + sort */}
//           <div className="flex items-center gap-2">
//             <div className="relative">
//               <input
//                 type="text"
//                 className="w-64 max-w-full rounded-md border-gray-300 focus:ring-purple-500 focus:border-purple-500 text-sm"
//                 placeholder="Search by name or creator‚Ä¶"
//                 value={query}
//                 onChange={e => setQuery(e.target.value)}
//               />
//               <div className="absolute inset-y-0 right-2 grid place-items-center pointer-events-none text-gray-400">
//                 üîé
//               </div>
//             </div>
//             <select
//               className="rounded-md border-gray-300 text-sm focus:ring-purple-500 focus:border-purple-500"
//               value={sortKey}
//               onChange={e => setSortKey(e.target.value)}
//             >
//               <option value="updated">Sort: Last updated</option>
//               <option value="name">Sort: Name (A‚ÄìZ)</option>
//               <option value="created">Sort: Created (newest)</option>
//             </select>
//           </div>
//         </div>
//       </div>

//       {/* Table */}
//       {filtered.length === 0 ? (
//         <div className="text-gray-500 text-center py-16">
//           {query
//             ? "No flows match your search."
//             : activeTab === "published"
//             ? "No published flows yet. Publish a draft to see it here."
//             : "No draft flows yet. Create a new flow to get started."}
//         </div>
//       ) : (
//         <div className="bg-white rounded-xl shadow overflow-hidden">
//           <table className="w-full text-sm">
//             <thead className="bg-gray-50 border-b text-gray-500 uppercase text-xs tracking-wide">
//               <tr>
//                 <th className="px-4 py-3 text-left">Flow Name</th>
//                 <th className="px-4 py-3 text-left">Status</th>
//                 <th className="px-4 py-3 text-left">Last Modified</th>
//                 <th className="px-4 py-3 text-right">Actions</th>
//               </tr>
//             </thead>
//             <tbody className="divide-y divide-gray-100">
//               {filtered.map(flow => (
//                 <tr key={flow.id} className="hover:bg-gray-50">
//                   <td className="px-4 py-3">
//                     <div className="font-medium text-gray-900">
//                       {flow.flowName}
//                     </div>
//                     <div className="text-xs text-gray-500">
//                       Created {formatDate(flow.createdAt)}
//                     </div>
//                   </td>
//                   <td className="px-4 py-3">{statusPill(flow.isPublished)}</td>
//                   <td className="px-4 py-3 text-gray-700">
//                     {formatDate(flow.updatedAt || flow.createdAt)}
//                   </td>
//                   <td className="px-4 py-3">
//                     <div className="flex justify-end gap-3">
//                       <button
//                         onClick={() => goView(flow)}
//                         className="text-blue-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üëÅÔ∏è View
//                       </button>

//                       {/* EDIT */}
//                       {/* <button
//                         onClick={() => goEdit(flow)}
//                         className="text-amber-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         ‚úèÔ∏è {flow.isPublished ? "Edit" : "Edit Draft"}
//                       </button> */}

//                       {/* PUBLISH (only show for drafts) */}
//                       {!flow.isPublished && (
//                         <button
//                           onClick={() => publishFlow(flow)}
//                           className="text-emerald-600 hover:underline text-xs disabled:opacity-50"
//                           disabled={loading}
//                           title="Publish this draft"
//                         >
//                           üöÄ Publish
//                         </button>
//                       )}

//                       {/* DELETE */}
//                       <button
//                         onClick={() => openDeleteModal(flow)}
//                         className="text-rose-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üóëÔ∏è Delete
//                       </button>
//                     </div>
//                   </td>
//                 </tr>
//               ))}
//             </tbody>
//           </table>
//         </div>
//       )}

//       {/* Modal */}
//       {modalOpen && (
//         <div className="fixed inset-0 z-50 flex items-center justify-center">
//           <div
//             className="absolute inset-0 bg-black/40"
//             onClick={() => setModalOpen(false)}
//           />
//           <div
//             role="dialog"
//             aria-modal="true"
//             className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
//           >
//             {modalMode === "attached" ? (
//               <>
//                 <div className="flex items-start gap-3 mb-4">
//                   <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                     ‚ö†Ô∏è
//                   </div>
//                   <div>
//                     <h3 className="text-lg font-semibold text-gray-900">
//                       Cannot delete this flow
//                     </h3>
//                     <p className="text-sm text-gray-600">
//                       <span className="font-medium">
//                         {targetFlow?.flowName}
//                       </span>{" "}
//                       is attached to the following campaign
//                       {modalCampaigns.length > 1 ? "s" : ""}. Delete those
//                       first.
//                     </p>
//                   </div>
//                 </div>
//                 <div className="max-h-72 overflow-auto rounded-lg border divide-y">
//                   {modalCampaigns.map(c => (
//                     <div key={c.id} className="p-3 text-sm">
//                       <div className="flex items-center justify-between">
//                         <div className="font-semibold text-gray-900">
//                           {c.name}
//                         </div>
//                         <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-700">
//                           {c.status || "‚Äî"}
//                         </span>
//                       </div>
//                       <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
//                         <div>
//                           Created:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.createdAt)}
//                           </span>
//                         </div>
//                         <div>
//                           Created by:{" "}
//                           <span className="font-medium text-gray-800">
//                             {c.createdBy || "‚Äî"}
//                           </span>
//                         </div>
//                         <div>
//                           Scheduled:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.scheduledAt)}
//                           </span>
//                         </div>
//                         <div>
//                           First sent:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.firstSentAt)}
//                           </span>
//                         </div>
//                       </div>
//                     </div>
//                   ))}
//                   {modalCampaigns.length === 0 && (
//                     <div className="p-3 text-sm text-gray-600">
//                       Could not load campaigns.
//                     </div>
//                   )}
//                 </div>
//                 <div className="mt-5 flex justify-end">
//                   <button
//                     ref={closeBtnRef}
//                     className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                     onClick={() => setModalOpen(false)}
//                   >
//                     Close
//                   </button>
//                 </div>
//               </>
//             ) : (
//               <>
//                 <div className="flex items-start gap-3 mb-4">
//                   <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                     üóëÔ∏è
//                   </div>
//                   <div>
//                     <h3 className="text-lg font-semibold text-gray-900">
//                       Delete this flow permanently?
//                     </h3>
//                     <p className="text-sm text-gray-600">
//                       This will remove{" "}
//                       <span className="font-medium">
//                         {targetFlow?.flowName}
//                       </span>{" "}
//                       and all of its steps and button links. This action cannot
//                       be undone.
//                     </p>
//                   </div>
//                 </div>
//                 <div className="rounded-lg border p-3 bg-rose-50 text-rose-700 text-sm">
//                   <span className="font-semibold">Warning:</span> Permanent
//                   deletion cannot be recovered.
//                 </div>
//                 <div className="mt-5 flex justify-end gap-2">
//                   <button
//                     className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                     onClick={() => setModalOpen(false)}
//                   >
//                     Cancel
//                   </button>
//                   <button
//                     onClick={confirmDelete}
//                     className="px-3 py-2 text-sm rounded bg-rose-600 text-white hover:bg-rose-700"
//                   >
//                     Permanently delete
//                   </button>
//                 </div>
//               </>
//             )}
//           </div>
//         </div>
//       )}
//     </div>
//   );
// }

// // üìÑ File: xbytechat-ui/src/pages/CTAFlowVisualBuilder/CTAFlowManager.jsx
// import React, { useEffect, useMemo, useRef, useState } from "react";
// import { useNavigate } from "react-router-dom";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";

// export default function CTAFlowManager() {
//   const [flows, setFlows] = useState([]);
//   const [activeTab, setActiveTab] = useState("published"); // default Published
//   const [loading, setLoading] = useState(true);

//   const [modalOpen, setModalOpen] = useState(false);
//   const [modalMode, setModalMode] = useState("confirm"); // confirm | attached
//   const [modalCampaigns, setModalCampaigns] = useState([]);
//   const [targetFlow, setTargetFlow] = useState(null);

//   const [query, setQuery] = useState("");
//   const [sortKey, setSortKey] = useState("updated");
//   const closeBtnRef = useRef(null);
//   const navigate = useNavigate();

//   const formatDate = date =>
//     date
//       ? new Date(date).toLocaleString("en-IN", {
//           day: "2-digit",
//           month: "short",
//           year: "numeric",
//           hour: "2-digit",
//           minute: "2-digit",
//         })
//       : "‚Äî";

//   const statusPill = isPublished =>
//     isPublished ? (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">
//         <span>‚óè</span> Published
//       </span>
//     ) : (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">
//         <span>‚óè</span> Draft
//       </span>
//     );

//   const fetchFlows = async (tab = "published") => {
//     setLoading(true);
//     try {
//       const endpoint =
//         tab === "published" ? "/cta-flow/all-published" : "/cta-flow/all-draft";
//       const res = await axiosClient.get(endpoint);
//       setFlows(Array.isArray(res.data) ? res.data : [res.data]);
//     } catch (err) {
//       setFlows([]);
//       toast.error("‚ùå Failed to load flows");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   useEffect(() => {
//     fetchFlows("published");
//   }, []);

//   const filtered = useMemo(() => {
//     const q = query.trim().toLowerCase();
//     let out = flows;
//     if (q) {
//       out = out.filter(f =>
//         [f.flowName, f.createdBy]
//           .filter(Boolean)
//           .some(v => String(v).toLowerCase().includes(q))
//       );
//     }
//     switch (sortKey) {
//       case "name":
//         return [...out].sort((a, b) => a.flowName.localeCompare(b.flowName));
//       case "created":
//         return [...out].sort(
//           (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
//         );
//       default:
//         return [...out].sort(
//           (a, b) =>
//             new Date(b.updatedAt || b.createdAt) -
//             new Date(a.updatedAt || a.createdAt)
//         );
//     }
//   }, [flows, query, sortKey]);

//   // ---- delete UX (checks usage) ----
//   const openDeleteModal = async flow => {
//     setTargetFlow(flow);
//     setLoading(true);
//     try {
//       const { data } = await axiosClient.get(`/cta-flow/${flow.id}/usage`);
//       if (data?.canDelete) {
//         setModalMode("confirm");
//         setModalCampaigns([]);
//       } else {
//         setModalMode("attached");
//         setModalCampaigns(Array.isArray(data?.campaigns) ? data.campaigns : []);
//       }
//       setModalOpen(true);
//       setTimeout(() => closeBtnRef.current?.focus(), 0);
//     } catch (err) {
//       toast.error("‚ùå Could not check usage for this flow.");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   const confirmDelete = async () => {
//     if (!targetFlow) return;
//     setLoading(true);
//     try {
//       const res = await axiosClient.delete(`/cta-flow/${targetFlow.id}`);
//       if (res.status === 204 || res.status === 200) {
//         toast.success("‚úÖ Flow deleted permanently.");
//         setModalOpen(false);
//         setTargetFlow(null);
//         await fetchFlows(activeTab);
//       } else {
//         toast.info("Unexpected response while deleting the flow.");
//       }
//     } catch (err) {
//       const status = err?.response?.status;
//       if (status === 409) {
//         const campaigns = err.response?.data?.campaigns ?? [];
//         setModalMode("attached");
//         setModalCampaigns(campaigns);
//       } else if (status === 404) {
//         toast.error("‚ùå Flow not found.");
//         setModalOpen(false);
//       } else {
//         toast.error("‚ùå Failed to delete flow.");
//         setModalOpen(false);
//       }
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   return (
//     <div className="p-6 relative">
//       {/* Loading overlay */}
//       {loading && (
//         <>
//           <div className="absolute inset-0 z-40 bg-white/60 backdrop-blur-[1px] flex items-center justify-center">
//             <div className="flex items-center gap-3 text-gray-700">
//               <svg
//                 className="xafb-spin h-6 w-6 text-purple-600"
//                 xmlns="http://www.w3.org/2000/svg"
//                 viewBox="0 0 24 24"
//                 fill="none"
//               >
//                 <circle
//                   cx="12"
//                   cy="12"
//                   r="10"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   opacity="0.25"
//                 />
//                 <path
//                   d="M4 12a8 8 0 018-8"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   strokeLinecap="round"
//                   opacity="0.85"
//                 />
//               </svg>
//               <span className="text-sm">Loading‚Ä¶</span>
//             </div>
//           </div>
//           <style>{`@keyframes xafb-spin{to{transform:rotate(360deg)}}.xafb-spin{animation:xafb-spin 1s linear infinite}`}</style>
//         </>
//       )}

//       {/* Header */}
//       <div className="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between mb-6">
//         <div>
//           <h1 className="text-2xl font-bold text-gray-900">
//             üß© CTA Flow Manager
//           </h1>
//           <p className="text-sm text-gray-500">
//             Create, publish, and manage your visual flows.
//           </p>
//         </div>
//         <div className="flex items-center gap-2">
//           <button
//             onClick={() => navigate("/app/cta-flow/visual-builder")}
//             className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md shadow disabled:opacity-50"
//             disabled={loading}
//           >
//             ‚ûï New Flow
//           </button>
//         </div>
//       </div>

//       {/* Sticky controls */}
//       <div className="sticky top-0 z-10 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70 rounded-xl border p-3 mb-4">
//         <div className="flex flex-col sm:flex-row sm:items-center gap-3">
//           <div className="flex gap-3">
//             {[
//               { key: "published", label: "‚úÖ Published Flows" },
//               { key: "draft", label: "üìù Draft Flows" },
//             ].map(t => (
//               <button
//                 key={t.key}
//                 className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${
//                   activeTab === t.key
//                     ? "bg-purple-600 text-white shadow"
//                     : "text-gray-600 hover:text-purple-700 hover:bg-purple-50"
//                 }`}
//                 onClick={() => {
//                   setActiveTab(t.key);
//                   fetchFlows(t.key);
//                 }}
//                 disabled={loading}
//               >
//                 {t.label}
//               </button>
//             ))}
//           </div>

//           <div className="flex-1" />

//           {/* Search + sort */}
//           <div className="flex items-center gap-2">
//             <div className="relative">
//               <input
//                 type="text"
//                 className="w-64 max-w-full rounded-md border-gray-300 focus:ring-purple-500 focus:border-purple-500 text-sm"
//                 placeholder="Search by name or creator‚Ä¶"
//                 value={query}
//                 onChange={e => setQuery(e.target.value)}
//               />
//               <div className="absolute inset-y-0 right-2 grid place-items-center pointer-events-none text-gray-400">
//                 üîé
//               </div>
//             </div>
//             <select
//               className="rounded-md border-gray-300 text-sm focus:ring-purple-500 focus:border-purple-500"
//               value={sortKey}
//               onChange={e => setSortKey(e.target.value)}
//             >
//               <option value="updated">Sort: Last updated</option>
//               <option value="name">Sort: Name (A‚ÄìZ)</option>
//               <option value="created">Sort: Created (newest)</option>
//             </select>
//           </div>
//         </div>
//       </div>

//       {/* Table */}
//       {filtered.length === 0 ? (
//         <div className="text-gray-500 text-center py-16">
//           {query
//             ? "No flows match your search."
//             : activeTab === "published"
//             ? "No published flows yet. Publish a draft to see it here."
//             : "No draft flows yet. Create a new flow to get started."}
//         </div>
//       ) : (
//         <div className="bg-white rounded-xl shadow overflow-hidden">
//           <table className="w-full text-sm">
//             <thead className="bg-gray-50 border-b text-gray-500 uppercase text-xs tracking-wide">
//               <tr>
//                 <th className="px-4 py-3 text-left">Flow Name</th>
//                 <th className="px-4 py-3 text-left">Status</th>
//                 <th className="px-4 py-3 text-left">Last Modified</th>
//                 <th className="px-4 py-3 text-right">Actions</th>
//               </tr>
//             </thead>
//             <tbody className="divide-y divide-gray-100">
//               {filtered.map(flow => (
//                 <tr key={flow.id} className="hover:bg-gray-50">
//                   <td className="px-4 py-3">
//                     <div className="font-medium text-gray-900">
//                       {flow.flowName}
//                     </div>
//                     <div className="text-xs text-gray-500">
//                       Created {formatDate(flow.createdAt)}
//                     </div>
//                   </td>
//                   <td className="px-4 py-3">{statusPill(flow.isPublished)}</td>
//                   <td className="px-4 py-3 text-gray-700">
//                     {formatDate(flow.updatedAt || flow.createdAt)}
//                   </td>
//                   <td className="px-4 py-3">
//                     <div className="flex justify-end gap-3">
//                       <button
//                         onClick={() =>
//                           navigate(
//                             `/app/cta-flow/visual-builder?id=${flow.id}&mode=view`
//                           )
//                         }
//                         className="text-blue-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üëÅÔ∏è View
//                       </button>

//                       {/* EDIT gate: if published, we'll decide in the builder whether republish is needed or fork */}
//                       <button
//                         onClick={() =>
//                           navigate(
//                             `/app/cta-flow/visual-builder?id=${flow.id}&mode=edit`
//                           )
//                         }
//                         className="text-amber-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         ‚úèÔ∏è Edit
//                       </button>

//                       <button
//                         onClick={() => openDeleteModal(flow)}
//                         className="text-rose-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üóëÔ∏è Delete
//                       </button>
//                     </div>
//                   </td>
//                 </tr>
//               ))}
//             </tbody>
//           </table>
//         </div>
//       )}

//       {/* Modal */}
//       {modalOpen && (
//         <div className="fixed inset-0 z-50 flex items-center justify-center">
//           <div
//             className="absolute inset-0 bg-black/40"
//             onClick={() => setModalOpen(false)}
//           />
//           <div
//             role="dialog"
//             aria-modal="true"
//             className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
//           >
//             {modalMode === "attached" ? (
//               <>
//                 <div className="flex items-start gap-3 mb-4">
//                   <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                     ‚ö†Ô∏è
//                   </div>
//                   <div>
//                     <h3 className="text-lg font-semibold text-gray-900">
//                       Cannot delete this flow
//                     </h3>
//                     <p className="text-sm text-gray-600">
//                       <span className="font-medium">
//                         {targetFlow?.flowName}
//                       </span>{" "}
//                       is attached to the following campaign
//                       {modalCampaigns.length > 1 ? "s" : ""}. Delete those
//                       first.
//                     </p>
//                   </div>
//                 </div>
//                 <div className="max-h-72 overflow-auto rounded-lg border divide-y">
//                   {modalCampaigns.map(c => (
//                     <div key={c.id} className="p-3 text-sm">
//                       <div className="flex items-center justify-between">
//                         <div className="font-semibold text-gray-900">
//                           {c.name}
//                         </div>
//                         <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-700">
//                           {c.status || "‚Äî"}
//                         </span>
//                       </div>
//                       <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
//                         <div>
//                           Created:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.createdAt)}
//                           </span>
//                         </div>
//                         <div>
//                           Created by:{" "}
//                           <span className="font-medium text-gray-800">
//                             {c.createdBy || "‚Äî"}
//                           </span>
//                         </div>
//                         <div>
//                           Scheduled:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.scheduledAt)}
//                           </span>
//                         </div>
//                         <div>
//                           First sent:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.firstSentAt)}
//                           </span>
//                         </div>
//                       </div>
//                     </div>
//                   ))}
//                 </div>
//                 <div className="mt-5 flex justify-end">
//                   <button
//                     ref={closeBtnRef}
//                     className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                     onClick={() => setModalOpen(false)}
//                   >
//                     Close
//                   </button>
//                 </div>
//               </>
//             ) : (
//               <>
//                 <div className="flex items-start gap-3 mb-4">
//                   <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                     üóëÔ∏è
//                   </div>
//                   <div>
//                     <h3 className="text-lg font-semibold text-gray-900">
//                       Delete this flow permanently?
//                     </h3>
//                     <p className="text-sm text-gray-600">
//                       This will remove{" "}
//                       <span className="font-medium">
//                         {targetFlow?.flowName}
//                       </span>{" "}
//                       and all of its steps and button links. This action cannot
//                       be undone.
//                     </p>
//                   </div>
//                 </div>
//                 <div className="rounded-lg border p-3 bg-rose-50 text-rose-700 text-sm">
//                   <span className="font-semibold">Warning:</span> Permanent
//                   deletion cannot be recovered.
//                 </div>
//                 <div className="mt-5 flex justify-end gap-2">
//                   <button
//                     className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                     onClick={() => setModalOpen(false)}
//                   >
//                     Cancel
//                   </button>
//                   <button
//                     onClick={confirmDelete}
//                     className="px-3 py-2 text-sm rounded bg-rose-600 text-white hover:bg-rose-700"
//                   >
//                     Permanently delete
//                   </button>
//                 </div>
//               </>
//             )}
//           </div>
//         </div>
//       )}
//     </div>
//   );
// }

// import React, { useEffect, useMemo, useRef, useState } from "react";
// import { useNavigate } from "react-router-dom";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";

// export default function CTAFlowManager() {
//   // ---------- state ----------
//   const [flows, setFlows] = useState([]);
//   const [activeTab, setActiveTab] = useState("published"); // ‚úÖ default to published
//   const [loading, setLoading] = useState(true);

//   // Search + sort (client-side)
//   const [query, setQuery] = useState("");
//   const [sortKey, setSortKey] = useState("updated"); // updated | name | created

//   // Modal
//   const [modalOpen, setModalOpen] = useState(false);
//   const [modalMode, setModalMode] = useState("confirm"); // confirm | attached
//   const [modalCampaigns, setModalCampaigns] = useState([]);
//   const [targetFlow, setTargetFlow] = useState(null);

//   const navigate = useNavigate();
//   const closeBtnRef = useRef(null);

//   // ---------- helpers ----------
//   const formatDate = date => {
//     if (!date) return "‚Äî";
//     const d = new Date(date);
//     return d.toLocaleString("en-IN", {
//       day: "2-digit",
//       month: "short",
//       year: "numeric",
//       hour: "2-digit",
//       minute: "2-digit",
//     });
//   };

//   const statusPill = isPublished =>
//     isPublished ? (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">
//         <span>‚óè</span> Published
//       </span>
//     ) : (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">
//         <span>‚óè</span> Draft
//       </span>
//     );

//   const renderStatusBadge = status => {
//     const s = (status || "").toLowerCase();
//     const map = {
//       draft: "bg-amber-100 text-amber-700",
//       scheduled: "bg-sky-100 text-sky-700",
//       running: "bg-blue-100 text-blue-700",
//       sent: "bg-emerald-100 text-emerald-700",
//       completed: "bg-emerald-100 text-emerald-700",
//       failed: "bg-rose-100 text-rose-700",
//     };
//     const cls = map[s] || "bg-gray-100 text-gray-700";
//     return (
//       <span
//         className={`inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium ${cls}`}
//       >
//         {status || "‚Äî"}
//       </span>
//     );
//   };

//   // ---------- data ----------
//   const fetchFlows = async (tab = "published") => {
//     setLoading(true);
//     try {
//       const endpoint =
//         tab === "published" ? "/cta-flow/all-published" : "/cta-flow/all-draft";
//       const res = await axiosClient.get(endpoint);
//       const list = Array.isArray(res.data) ? res.data : [res.data];
//       setFlows(list);
//     } catch (err) {
//       setFlows([]);
//       toast.error("‚ùå Failed to load flows");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   useEffect(() => {
//     fetchFlows("published"); // ‚úÖ first load = published
//   }, []);

//   // ---------- search + sort (client-side) ----------
//   const filtered = useMemo(() => {
//     const q = query.trim().toLowerCase();
//     let out = flows;
//     if (q) {
//       out = out.filter(f =>
//         [f.flowName, f.createdBy]
//           .filter(Boolean)
//           .some(v => String(v).toLowerCase().includes(q))
//       );
//     }
//     switch (sortKey) {
//       case "name":
//         out = [...out].sort((a, b) => a.flowName.localeCompare(b.flowName));
//         break;
//       case "created":
//         out = [...out].sort(
//           (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
//         );
//         break;
//       default:
//         out = [...out].sort(
//           (a, b) =>
//             new Date(b.updatedAt || b.createdAt) -
//             new Date(a.updatedAt || a.createdAt)
//         );
//     }
//     return out;
//   }, [flows, query, sortKey]);

//   // ---------- delete flow UX ----------
//   const openDeleteModal = async flow => {
//     setTargetFlow(flow);
//     setLoading(true);
//     try {
//       const { data } = await axiosClient.get(`/cta-flow/${flow.id}/usage`);
//       if (data?.canDelete) {
//         setModalMode("confirm");
//         setModalCampaigns([]);
//       } else {
//         setModalMode("attached");
//         setModalCampaigns(Array.isArray(data?.campaigns) ? data.campaigns : []);
//       }
//       setModalOpen(true);
//       setTimeout(() => closeBtnRef.current?.focus(), 0);
//     } catch (err) {
//       toast.error("‚ùå Could not check usage for this flow.");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   const confirmDelete = async () => {
//     if (!targetFlow) return;
//     setLoading(true);
//     try {
//       const res = await axiosClient.delete(`/cta-flow/${targetFlow.id}`);
//       if (res.status === 204 || res.status === 200) {
//         toast.success("‚úÖ Flow deleted permanently.");
//         setModalOpen(false);
//         setTargetFlow(null);
//         await fetchFlows(activeTab);
//       } else {
//         toast.info("Unexpected response while deleting the flow.");
//       }
//     } catch (err) {
//       const status = err?.response?.status;
//       if (status === 409) {
//         const campaigns = err.response?.data?.campaigns ?? [];
//         setModalMode("attached");
//         setModalCampaigns(campaigns);
//       } else if (status === 404) {
//         toast.error("‚ùå Flow not found.");
//         setModalOpen(false);
//       } else {
//         toast.error("‚ùå Failed to delete flow.");
//         setModalOpen(false);
//       }
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   // ---------- UI ----------
//   return (
//     <div className="p-6 relative">
//       {/* Loading overlay */}
//       {loading && (
//         <>
//           <div className="absolute inset-0 z-40 bg-white/60 backdrop-blur-[1px] flex items-center justify-center">
//             <div className="flex items-center gap-3 text-gray-700">
//               <svg
//                 className="xafb-spin h-6 w-6 text-purple-600"
//                 xmlns="http://www.w3.org/2000/svg"
//                 viewBox="0 0 24 24"
//                 fill="none"
//               >
//                 <circle
//                   cx="12"
//                   cy="12"
//                   r="10"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   opacity="0.25"
//                 />
//                 <path
//                   d="M4 12a8 8 0 018-8"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   strokeLinecap="round"
//                   opacity="0.85"
//                 />
//               </svg>
//               <span className="text-sm">Loading‚Ä¶</span>
//             </div>
//           </div>
//           <style>{`@keyframes xafb-spin{to{transform:rotate(360deg)}}.xafb-spin{animation:xafb-spin 1s linear infinite}`}</style>
//         </>
//       )}

//       {/* Page header */}
//       <div className="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between mb-6">
//         <div>
//           <h1 className="text-2xl font-bold text-gray-900">
//             üß© CTA Flow Manager
//           </h1>
//           <p className="text-sm text-gray-500">
//             Create, publish, and manage your visual flows.
//           </p>
//         </div>
//         <div className="flex items-center gap-2">
//           <button
//             onClick={() => navigate("/app/cta-flow/visual-builder")}
//             className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md shadow disabled:opacity-50"
//             disabled={loading}
//           >
//             ‚ûï New Flow
//           </button>
//         </div>
//       </div>

//       {/* Sticky controls */}
//       <div className="sticky top-0 z-10 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70 rounded-xl border p-3 mb-4">
//         <div className="flex flex-col sm:flex-row sm:items-center gap-3">
//           {/* Tabs */}
//           <div className="flex gap-3">
//             {[
//               { key: "published", label: "‚úÖ Published Flows" },
//               { key: "draft", label: "üìù Draft Flows" },
//             ].map(t => (
//               <button
//                 key={t.key}
//                 className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${
//                   activeTab === t.key
//                     ? "bg-purple-600 text-white shadow"
//                     : "text-gray-600 hover:text-purple-700 hover:bg-purple-50"
//                 }`}
//                 onClick={() => {
//                   setActiveTab(t.key);
//                   fetchFlows(t.key);
//                 }}
//                 disabled={loading}
//               >
//                 {t.label}
//               </button>
//             ))}
//           </div>

//           {/* Spacer */}
//           <div className="flex-1" />

//           {/* Search */}
//           <div className="flex items-center gap-2">
//             <div className="relative">
//               <input
//                 type="text"
//                 className="w-64 max-w-full rounded-md border-gray-300 focus:ring-purple-500 focus:border-purple-500 text-sm"
//                 placeholder="Search by name or creator‚Ä¶"
//                 value={query}
//                 onChange={e => setQuery(e.target.value)}
//               />
//               <div className="absolute inset-y-0 right-2 grid place-items-center pointer-events-none text-gray-400">
//                 üîé
//               </div>
//             </div>

//             {/* Sort */}
//             <select
//               className="rounded-md border-gray-300 text-sm focus:ring-purple-500 focus:border-purple-500"
//               value={sortKey}
//               onChange={e => setSortKey(e.target.value)}
//             >
//               <option value="updated">Sort: Last updated</option>
//               <option value="name">Sort: Name (A‚ÄìZ)</option>
//               <option value="created">Sort: Created (newest)</option>
//             </select>
//           </div>
//         </div>
//       </div>

//       {/* Content */}
//       {filtered.length === 0 ? (
//         <div className="text-gray-500 text-center py-16">
//           {query
//             ? "No flows match your search."
//             : activeTab === "published"
//             ? "No published flows yet. Publish a draft to see it here."
//             : "No draft flows yet. Create a new flow to get started."}
//         </div>
//       ) : (
//         <div className="bg-white rounded-xl shadow overflow-hidden">
//           <table className="w-full text-sm">
//             <thead className="bg-gray-50 border-b text-gray-500 uppercase text-xs tracking-wide">
//               <tr>
//                 <th className="px-4 py-3 text-left">Flow Name</th>
//                 <th className="px-4 py-3 text-left">Status</th>
//                 <th className="px-4 py-3 text-left">Last Modified</th>
//                 <th className="px-4 py-3 text-right">Actions</th>
//               </tr>
//             </thead>
//             <tbody className="divide-y divide-gray-100">
//               {filtered.map(flow => (
//                 <tr key={flow.id} className="hover:bg-gray-50">
//                   <td className="px-4 py-3">
//                     <div className="font-medium text-gray-900">
//                       {flow.flowName}
//                     </div>
//                     <div className="text-xs text-gray-500">
//                       Created {formatDate(flow.createdAt)}
//                     </div>
//                   </td>
//                   <td className="px-4 py-3">{statusPill(flow.isPublished)}</td>
//                   <td className="px-4 py-3 text-gray-700">
//                     {formatDate(flow.updatedAt || flow.createdAt)}
//                   </td>
//                   <td className="px-4 py-3">
//                     <div className="flex justify-end gap-3">
//                       <button
//                         onClick={() =>
//                           navigate(
//                             `/app/cta-flow/visual-builder?id=${flow.id}&mode=view`
//                           )
//                         }
//                         className="text-blue-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üëÅÔ∏è View
//                       </button>
//                       {!flow.isPublished && (
//                         <button
//                           onClick={() =>
//                             navigate(
//                               `/app/cta-flow/visual-builder?id=${flow.id}&mode=edit`
//                             )
//                           }
//                           className="text-amber-600 hover:underline text-xs disabled:opacity-50"
//                           disabled={loading}
//                         >
//                           ‚úèÔ∏è Edit
//                         </button>
//                       )}
//                       <button
//                         onClick={() => openDeleteModal(flow)}
//                         className="text-rose-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üóëÔ∏è Delete
//                       </button>
//                     </div>
//                   </td>
//                 </tr>
//               ))}
//             </tbody>
//           </table>
//         </div>
//       )}

//       {/* Modal */}
//       {modalOpen && (
//         <div className="fixed inset-0 z-50 flex items-center justify-center">
//           <div
//             className="absolute inset-0 bg-black/40"
//             onClick={() => setModalOpen(false)}
//           />
//           <div
//             role="dialog"
//             aria-modal="true"
//             className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
//           >
//             {/* Header */}
//             {modalMode === "attached" ? (
//               <div className="flex items-start gap-3 mb-4">
//                 <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                   ‚ö†Ô∏è
//                 </div>
//                 <div>
//                   <h3 className="text-lg font-semibold text-gray-900">
//                     Cannot delete this flow
//                   </h3>
//                   <p className="text-sm text-gray-600">
//                     <span className="font-medium">{targetFlow?.flowName}</span>{" "}
//                     is attached to the campaign
//                     {modalCampaigns.length > 1 ? "s" : ""} below. Delete those
//                     campaign
//                     {modalCampaigns.length > 1 ? "s" : ""} first.
//                   </p>
//                 </div>
//               </div>
//             ) : (
//               <div className="flex items-start gap-3 mb-4">
//                 <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                   üóëÔ∏è
//                 </div>
//                 <div>
//                   <h3 className="text-lg font-semibold text-gray-900">
//                     Delete this flow permanently?
//                   </h3>
//                   <p className="text-sm text-gray-600">
//                     This will remove{" "}
//                     <span className="font-medium">{targetFlow?.flowName}</span>{" "}
//                     and all of its steps and button links. This action cannot be
//                     undone.
//                   </p>
//                 </div>
//               </div>
//             )}

//             {/* Body */}
//             {modalMode === "attached" ? (
//               <div className="max-h-72 overflow-auto rounded-lg border divide-y">
//                 {modalCampaigns.map(c => (
//                   <div key={c.id} className="p-3 text-sm">
//                     <div className="flex items-center justify-between">
//                       <div className="font-semibold text-gray-900">
//                         {c.name}
//                       </div>
//                       {renderStatusBadge(c.status)}
//                     </div>
//                     <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
//                       <div>
//                         Created:{" "}
//                         <span className="font-medium text-gray-800">
//                           {formatDate(c.createdAt)}
//                         </span>
//                       </div>
//                       <div>
//                         Created by:{" "}
//                         <span className="font-medium text-gray-800">
//                           {c.createdBy || "‚Äî"}
//                         </span>
//                       </div>
//                       <div>
//                         Scheduled:{" "}
//                         <span className="font-medium text-gray-800">
//                           {formatDate(c.scheduledAt)}
//                         </span>
//                       </div>
//                       <div>
//                         First sent:{" "}
//                         <span className="font-medium text-gray-800">
//                           {formatDate(c.firstSentAt)}
//                         </span>
//                       </div>
//                     </div>
//                   </div>
//                 ))}
//               </div>
//             ) : (
//               <div className="rounded-lg border p-3 bg-rose-50 text-rose-700 text-sm">
//                 <span className="font-semibold">Warning:</span> This will
//                 permanently delete the flow and its data.
//               </div>
//             )}

//             {/* Footer */}
//             <div className="mt-5 flex justify-end gap-2">
//               <button
//                 ref={closeBtnRef}
//                 className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                 onClick={() => setModalOpen(false)}
//               >
//                 Close
//               </button>
//               {modalMode === "confirm" && (
//                 <button
//                   onClick={confirmDelete}
//                   className="px-3 py-2 text-sm rounded bg-rose-600 text-white hover:bg-rose-700"
//                 >
//                   Permanently delete
//                 </button>
//               )}
//             </div>
//           </div>
//         </div>
//       )}
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\ctaFlowVisualApi.js 
====================================================== 
 
// üìÑ File: xbytechat-ui/src/pages/CTAFlowVisualBuilder/ctaFlowVisualApi.js
import axiosClient from "../../api/axiosClient";

const toBool = v => v === true || v === "true" || v === 1;
const toPosInt = (v, def = 1) => {
  const n = parseInt(v, 10);
  return Number.isFinite(n) && n > 0 ? n : def;
};

// ---- shared payload normalizer ----
function normalizePayload(payload) {
  const safeNodes = (payload.Nodes || []).map(node => ({
    Id: node.Id || "",
    TemplateName: node.TemplateName || "",
    TemplateType: node.TemplateType || "text_template",
    MessageBody: node.MessageBody || "",
    PositionX: node.PositionX ?? 0,
    PositionY: node.PositionY ?? 0,
    TriggerButtonText: node.TriggerButtonText || "",
    TriggerButtonType: node.TriggerButtonType || "cta",
    UseProfileName: toBool(node.UseProfileName),
    ProfileNameSlot: toPosInt(node.ProfileNameSlot ?? 1, 1),
    Buttons: (node.Buttons || []).map((btn, idx) => ({
      Text: btn.Text || "",
      Type: btn.Type || "",
      SubType: btn.SubType || "",
      Value: btn.Value || "",
      Index: Number.isFinite(btn.Index) ? btn.Index : idx,
      TargetNodeId: btn.TargetNodeId || null,
    })),
  }));

  const safeEdges = (payload.Edges || []).map(e => ({
    FromNodeId: e.FromNodeId || "",
    ToNodeId: e.ToNodeId || "",
    SourceHandle: e.SourceHandle || "",
  }));

  return {
    FlowName: payload.FlowName || "Untitled",
    IsPublished: !!payload.IsPublished,
    Nodes: safeNodes,
    Edges: safeEdges,
  };
}

// ---- CREATE (by name) ----
export async function saveVisualFlow(payload) {
  const res = await axiosClient.post(
    "/cta-flow/save-visual",
    normalizePayload(payload)
  );
  return res.data;
}

// ---- LOAD BY ID ----
export async function getVisualFlowById(flowId) {
  if (!flowId) throw new Error("flowId is required");
  const res = await axiosClient.get(`/cta-flow/by-id/${flowId}`);
  return res.data;
}

// ---- USAGE (edit/delete gates) ----
export async function getFlowUsage(flowId) {
  if (!flowId) throw new Error("flowId is required");
  const { data } = await axiosClient.get(`/cta-flow/${flowId}/usage`);
  return data; // { canDelete, count, campaigns }
}

// ---- UPDATE BY ID ----
export async function updateVisualFlow(flowId, payload) {
  if (!flowId) throw new Error("flowId is required");
  const res = await axiosClient.put(
    `/cta-flow/${flowId}`,
    normalizePayload(payload)
  );
  return res.data; // { message, needsRepublish? }
}

// ---- PUBLISH ----
export async function publishFlow(flowId) {
  if (!flowId) throw new Error("flowId is required");
  const res = await axiosClient.post(`/cta-flow/${flowId}/publish`);
  return res.data;
}

// ---- FORK (create draft version) ----
export async function forkFlow(flowId) {
  if (!flowId) throw new Error("flowId is required");
  const res = await axiosClient.post(`/cta-flow/${flowId}/fork`);
  return res.data; // { flowId }
}

// ---- (Optional) DELETE helper for manager page ----
export async function deleteFlow(flowId) {
  if (!flowId) throw new Error("flowId is required");
  const res = await axiosClient.delete(`/cta-flow/${flowId}`);
  return res.data;
}

// // üìÑ File: xbytechat-ui/src/pages/CTAFlowVisualBuilder/ctaFlowVisualApi.js
// import axiosClient from "../../api/axiosClient";

// const toBool = v => v === true || v === "true" || v === 1;
// const toPosInt = (v, def = 1) => {
//   const n = parseInt(v, 10);
//   return Number.isFinite(n) && n > 0 ? n : def;
// };

// // ---- CREATE / UPSERT BY NAME (existing) ----
// export async function saveVisualFlow(payload) {
//   const safeNodes = (payload.Nodes || []).map(node => ({
//     Id: node.Id || "",
//     TemplateName: node.TemplateName || "",
//     TemplateType: node.TemplateType || "text_template",
//     MessageBody: node.MessageBody || "",
//     PositionX: node.PositionX ?? 0,
//     PositionY: node.PositionY ?? 0,
//     TriggerButtonText: node.TriggerButtonText || "",
//     TriggerButtonType: node.TriggerButtonType || "cta",
//     UseProfileName: toBool(node.UseProfileName),
//     ProfileNameSlot: toPosInt(node.ProfileNameSlot ?? 1, 1),
//     Buttons: (node.Buttons || []).map((btn, idx) => ({
//       Text: btn.Text || "",
//       Type: btn.Type || "",
//       SubType: btn.SubType || "",
//       Value: btn.Value || "",
//       Index: Number.isFinite(btn.Index) ? btn.Index : idx,
//       TargetNodeId: btn.TargetNodeId || null,
//     })),
//   }));

//   const safeEdges = (payload.Edges || []).map(e => ({
//     FromNodeId: e.FromNodeId || "",
//     ToNodeId: e.ToNodeId || "",
//     SourceHandle: e.SourceHandle || "",
//   }));

//   const fixedPayload = {
//     FlowName: payload.FlowName || "Untitled",
//     IsPublished: !!payload.IsPublished,
//     Nodes: safeNodes,
//     Edges: safeEdges,
//   };

//   const res = await axiosClient.post("/cta-flow/save-visual", fixedPayload);
//   return res.data;
// }

// // ---- LOAD BY ID (existing consumer in builder) ----
// export async function getVisualFlowById(flowId) {
//   const res = await axiosClient.get(`/cta-flow/by-id/${flowId}`);
//   return res.data;
// }

// // ---- NEW: usage for delete/edit gates ----
// export async function getFlowUsage(flowId) {
//   const { data } = await axiosClient.get(`/cta-flow/${flowId}/usage`);
//   return data; // { canDelete: boolean, campaigns: [] }
// }

// // ---- NEW: update by id (two-state policy on backend) ----
// export async function updateVisualFlow(flowId, payload) {
//   const res = await axiosClient.put(`/cta-flow/${flowId}`, payload);
//   return res.data; // { message, needsRepublish? }
// }

// // ---- NEW: publish ----
// export async function publishFlow(flowId) {
//   const res = await axiosClient.post(`/cta-flow/${flowId}/publish`);
//   return res.data;
// }

// // ---- NEW: fork ----
// export async function forkFlow(flowId) {
//   const res = await axiosClient.post(`/cta-flow/${flowId}/fork`);
//   return res.data; // { flowId }
// }

// import axiosClient from "../../api/axiosClient";
// /**
//  * Coerce values coming from the UI into clean types for the API.
//  */
// const toBool = v => v === true || v === "true" || v === 1;
// const toPosInt = (v, def = 1) => {
//   const n = parseInt(v, 10);
//   return Number.isFinite(n) && n > 0 ? n : def;
// };

// /**
//  * Save a visual flow (nodes + edges).
//  * Includes UseProfileName/ProfileNameSlot so the runtime knows where to inject the WA profile name.
//  */
// export async function saveVisualFlow(payload) {
//   const safeNodes = (payload.Nodes || []).map(node => ({
//     Id: node.Id || "",
//     TemplateName: node.TemplateName || "",
//     TemplateType: node.TemplateType || "text_template",
//     MessageBody: node.MessageBody || "",
//     PositionX: node.PositionX ?? 0,
//     PositionY: node.PositionY ?? 0,
//     TriggerButtonText: node.TriggerButtonText || "",
//     TriggerButtonType: node.TriggerButtonType || "cta",

//     // üëá NEW: persist the greeting controls per-step
//     UseProfileName: toBool(node.UseProfileName),
//     ProfileNameSlot: toPosInt(node.ProfileNameSlot ?? 1, 1),

//     // buttons with stable Index (used later to map clicks)
//     Buttons: (node.Buttons || []).map((btn, idx) => ({
//       Text: btn.Text || "",
//       Type: btn.Type || "",
//       SubType: btn.SubType || "",
//       Value: btn.Value || "",
//       TargetNodeId: btn.TargetNodeId || null,
//       Index: Number.isFinite(btn.Index) ? btn.Index : idx,
//     })),
//   }));

//   const safeEdges = (payload.Edges || []).map(e => ({
//     FromNodeId: e.FromNodeId || "",
//     ToNodeId: e.ToNodeId || "",
//     SourceHandle: e.SourceHandle || "", // button text
//   }));

//   const fixedPayload = {
//     FlowName: payload.FlowName || "Untitled",
//     IsPublished: !!payload.IsPublished,
//     Nodes: safeNodes,
//     Edges: safeEdges,
//   };

//   const res = await axiosClient.post("/cta-flow/save-visual", fixedPayload);
//   return res.data;
// }

// /**
//  * Load a visual flow by ID.
//  * The builder expects the response shape to include: { flowName, nodes: [...], edges: [...] }.
//  */
// export async function getVisualFlowById(flowId) {
//   const res = await axiosClient.get(`/cta-flow/by-id/${flowId}`);
//   return res.data;
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\CTAFlowVisualBuilder.jsx 
====================================================== 
 
// src/pages/CTAFlowVisualBuilder/CTAFlowVisualBuilder.jsx
import React, {
  useCallback,
  useState,
  useEffect,
  useMemo,
  useRef,
} from "react";
import {
  ReactFlow,
  ReactFlowProvider,
  Background,
  Controls,
  MiniMap,
  useNodesState,
  useEdgesState,
  addEdge,
  MarkerType,
  ConnectionMode,
  useReactFlow,
} from "@xyflow/react";
import "@xyflow/react/dist/style.css";
import { Eye, Minus } from "lucide-react";
import { useSearchParams, useNavigate } from "react-router-dom";
import TemplatePickerModal from "./components/TemplatePickerModal";
import FlowNodeBubble from "./components/FlowNodeBubble";
import {
  saveVisualFlow,
  getVisualFlowById,
  updateVisualFlow,
  publishFlow,
  forkFlow,
  getFlowUsage,
} from "./ctaFlowVisualApi";
import { v4 as uuidv4 } from "uuid";
import { toast } from "react-toastify";
import dagre from "dagre";
import SmartLabeledEdge from "./components/edges/SmartLabeledEdge";

const GRID = 16;
const NODE_DEFAULT = { width: 260, height: 140 };

function CTAFlowVisualBuilderInner() {
  const [nodes, setNodes, onNodesChange] = useNodesState([]);
  const [edges, setEdges, onEdgesChange] = useEdgesState([]);
  const nodesRef = useRef([]);
  const [showPicker, setShowPicker] = useState(false);
  const [flowName, setFlowName] = useState("");
  const flowNameRef = useRef(null);
  const [showMiniMap, setShowMiniMap] = useState(false);
  const [readonly, setReadonly] = useState(false);

  // policy state
  const [isPublished, setIsPublished] = useState(false);
  const [republishNeeded, setRepublishNeeded] = useState(false);
  const [lockInfo, setLockInfo] = useState({ locked: false, campaigns: [] });
  const [forkModalOpen, setForkModalOpen] = useState(false);

  // async state
  const [saving, setSaving] = useState(false);
  const [loading, setLoading] = useState(false);

  const [dirty, setDirty] = useState(false);

  const [searchParams] = useSearchParams();
  const navigate = useNavigate();
  const { fitView, zoomIn, zoomOut } = useReactFlow();

  const mode = searchParams.get("mode"); // 'edit' | 'view' | null
  const flowId = searchParams.get("id");
  const visualDebug = true;

  // figure out source tab for Back button
  const fromTab = (searchParams.get("from") || "draft").toLowerCase();
  const backTab = fromTab === "published" ? "published" : "draft";

  const goBackToManager = useCallback(() => {
    if (!readonly && dirty) {
      const ok = window.confirm("You have unsaved changes. Leave this page?");
      if (!ok) return;
    }
    navigate(`/app/cta-flow/flow-manager?tab=${backTab}`);
  }, [readonly, dirty, backTab, navigate]);

  useEffect(() => {
    nodesRef.current = [...nodes];
  }, [nodes]);

  // warn on unload if dirty
  useEffect(() => {
    const onBeforeUnload = e => {
      if (!dirty) return;
      e.preventDefault();
      e.returnValue = "";
    };
    window.addEventListener("beforeunload", onBeforeUnload);
    return () => window.removeEventListener("beforeunload", onBeforeUnload);
  }, [dirty]);

  // --- Node helpers
  const handleDeleteNode = useCallback(
    nodeId => {
      if (readonly) return;
      setDirty(true);
      setNodes(nds => nds.filter(n => n.id !== nodeId));
      setEdges(eds =>
        eds.filter(e => e.source !== nodeId && e.target !== nodeId)
      );
    },
    [readonly, setNodes, setEdges]
  );

  const handleNodeDataChange = useCallback(
    (nodeId, newData) => {
      setDirty(true);
      setNodes(nds =>
        nds.map(n =>
          n.id === nodeId ? { ...n, data: { ...n.data, ...newData } } : n
        )
      );
    },
    [setNodes]
  );

  const nodeTypes = useMemo(
    () => ({
      customBubble: props => (
        <FlowNodeBubble
          {...props}
          onDelete={handleDeleteNode}
          onDataChange={newData => handleNodeDataChange(props.id, newData)}
          readonly={readonly}
          visualDebug={visualDebug}
        />
      ),
    }),
    [handleDeleteNode, readonly, visualDebug, handleNodeDataChange]
  );

  const edgeTypes = useMemo(() => ({ smart: SmartLabeledEdge }), []);

  // --- Load / Bootstrap + policy checks
  useEffect(() => {
    const load = async () => {
      setLoading(true);
      if (mode === "edit" || mode === "view") {
        try {
          const data = await getVisualFlowById(flowId);

          const builtNodes = (data.nodes || []).map((node, index) => ({
            id: node.id,
            type: "customBubble",
            position: {
              x: node.positionX ?? 120 + index * 120,
              y: node.positionY ?? 150 + (index % 5) * 60,
            },
            data: {
              templateName: node.templateName,
              templateType: node.templateType,
              messageBody: node.messageBody,
              triggerButtonText: node.triggerButtonText || "",
              triggerButtonType: node.triggerButtonType || "cta",
              requiredTag: node.requiredTag || "",
              requiredSource: node.requiredSource || "",
              useProfileName: !!node.useProfileName,
              profileNameSlot:
                typeof node.profileNameSlot === "number" &&
                node.profileNameSlot > 0
                  ? node.profileNameSlot
                  : 1,
              buttons: (node.buttons || []).map((btn, i) => ({
                text: btn.text,
                type: btn.type,
                subType: btn.subType,
                value: btn.value,
                targetNodeId: btn.targetNodeId || null,
                index: typeof btn.index === "number" ? btn.index : i,
              })),
            },
          }));

          const builtEdges = (data.edges || []).map(edge => ({
            id: `e-${edge.fromNodeId}-${edge.toNodeId}-${
              edge.sourceHandle || "h"
            }`,
            source: edge.fromNodeId,
            target: edge.toNodeId,
            sourceHandle: edge.sourceHandle || null,
            type: "smart",
            animated: true,
            style: { stroke: "#9333ea" },
            markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
            label: edge.sourceHandle || "",
          }));

          const nodesWithIncoming = new Set(builtEdges.map(e => e.target));
          const nodesWithWarnings = builtNodes.map(node => ({
            ...node,
            data: {
              ...node.data,
              isUnreachable: false,
              hasNoIncoming: !nodesWithIncoming.has(node.id),
            },
          }));

          setNodes(nodesWithWarnings);
          setEdges(builtEdges);
          setFlowName(data.flowName || "Untitled Flow");
          setIsPublished(!!data.isPublished);
          setDirty(false);

          // policy: if editing a published flow, check attachment
          if (mode === "edit" && data.isPublished) {
            try {
              const usage = await getFlowUsage(flowId);
              if (usage?.campaigns?.length > 0) {
                setLockInfo({ locked: true, campaigns: usage.campaigns });
                setForkModalOpen(true);
                setReadonly(true);
              } else {
                setReadonly(false);
              }
            } catch {
              setLockInfo({ locked: true, campaigns: [] });
              setForkModalOpen(true);
              setReadonly(true);
            }
          } else {
            setReadonly(mode === "view");
          }

          // initial fit
          setTimeout(() => fitView({ padding: 0.25 }), 80);
        } catch {
          toast.error("‚ùå Failed to load flow");
        } finally {
          setLoading(false);
        }
      } else {
        // creating new flow
        setNodes([]);
        setEdges([]);
        setFlowName("Untitled Flow");
        setIsPublished(false);
        setReadonly(false);
        setDirty(false);
        setLoading(false);
        setTimeout(() => fitView({ padding: 0.25 }), 80);
      }
    };

    load();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [flowId, mode]);

  // Auto-fit when viewing, and refit on window resize
  useEffect(() => {
    if (mode !== "view") return;
    const t = setTimeout(() => fitView({ padding: 0.25 }), 80);
    const onResize = () => fitView({ padding: 0.25 });
    window.addEventListener("resize", onResize);
    return () => {
      clearTimeout(t);
      window.removeEventListener("resize", onResize);
    };
  }, [mode, nodes.length, edges.length, fitView]);

  // --- Add template
  const handleTemplateSelect = ({ name, type, body, buttons = [] }) => {
    if (readonly) return;
    const id = uuidv4();
    const newNode = {
      id,
      position: { x: Math.random() * 400 + 100, y: Math.random() * 300 + 100 },
      type: "customBubble",
      data: {
        templateName: name || "Untitled",
        templateType: type || "text_template",
        messageBody: body || "Message body preview...",
        triggerButtonText: buttons[0]?.text || "",
        triggerButtonType: "cta",
        useProfileName: false,
        profileNameSlot: 1,
        buttons: buttons.map((btn, idx) => ({
          text: btn.text || "",
          type: btn.type || "QUICK_REPLY",
          subType: btn.subType || "",
          value: btn.parameterValue || "",
          targetNodeId: null,
          index: idx,
        })),
      },
    };
    setDirty(true);
    setNodes(nds => [...nds, newNode]);
    setShowPicker(false);
    toast.success(
      `‚úÖ Step added with ${type?.replace("_", " ") || "template"}`
    );
    setTimeout(() => fitView({ padding: 0.25 }), 50);
  };

  // --- Connection rules
  const isValidConnection = useCallback(
    params => {
      if (!params?.source || !params?.sourceHandle) return false;
      const duplicate = edges.some(
        e =>
          e.source === params.source && e.sourceHandle === params.sourceHandle
      );
      return !duplicate;
    },
    [edges]
  );

  const onConnect = useCallback(
    params => {
      if (readonly) return;
      setDirty(true);
      const label = params.sourceHandle || "";

      setEdges(eds =>
        addEdge(
          {
            ...params,
            id: uuidv4(),
            type: "smart",
            animated: true,
            style: { stroke: "#9333ea" },
            markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
            label,
          },
          eds
        )
      );

      setNodes(nds =>
        nds.map(node => {
          if (node.id !== params.source) return node;
          const sourceHandle = params.sourceHandle || "";
          const updatedButtons = [...(node.data.buttons || [])];

          const idx = updatedButtons.findIndex(
            b =>
              (b.text || "").toLowerCase().trim() ===
              sourceHandle.toLowerCase().trim()
          );

          if (idx >= 0) {
            updatedButtons[idx] = {
              ...updatedButtons[idx],
              targetNodeId: params.target,
            };
          } else {
            const free = updatedButtons.findIndex(b => !b.targetNodeId);
            if (free >= 0)
              updatedButtons[free] = {
                ...updatedButtons[free],
                targetNodeId: params.target,
              };
          }

          return { ...node, data: { ...node.data, buttons: updatedButtons } };
        })
      );
    },
    [readonly, setEdges, setNodes]
  );

  // --- Keyboard UX
  useEffect(() => {
    const onKey = e => {
      if (readonly) return;
      if (e.key === "Delete" || e.key === "Backspace") {
        setDirty(true);
        setNodes(nds => nds.filter(n => !n.selected));
        setEdges(eds => eds.filter(ed => !ed.selected));
      }
      if (e.key === "Escape") {
        setNodes(nds => nds.map(n => ({ ...n, selected: false })));
        setEdges(eds => eds.map(ed => ({ ...ed, selected: false })));
      }
    };
    window.addEventListener("keydown", onKey);
    return () => window.removeEventListener("keydown", onKey);
  }, [readonly, setNodes, setEdges]);

  // --- Auto layout (dagre)
  const applyLayout = useCallback(
    (direction = "LR") => {
      const g = new dagre.graphlib.Graph();
      g.setGraph({
        rankdir: direction,
        nodesep: 50,
        ranksep: 90,
        marginx: 20,
        marginy: 20,
      });
      g.setDefaultEdgeLabel(() => ({}));

      nodes.forEach(n => {
        const width = n?.measured?.width || NODE_DEFAULT.width;
        const height = n?.measured?.height || NODE_DEFAULT.height;
        g.setNode(n.id, { width, height });
      });
      edges.forEach(e => g.setEdge(e.source, e.target));

      dagre.layout(g);

      const laidOut = nodes.map(n => {
        const { x, y } = g.node(n.id);
        const width = n?.measured?.width || NODE_DEFAULT.width;
        const height = n?.measured?.height || NODE_DEFAULT.height;
        return { ...n, position: { x: x - width / 2, y: y - height / 2 } };
      });

      setDirty(true);
      setNodes(laidOut);
      setTimeout(() => fitView({ padding: 0.25 }), 50);
    },
    [nodes, edges, setNodes, fitView]
  );

  // --- Build payload (draft by default; publish is separate)
  const buildPayload = () => {
    const transformedNodes = nodes
      .filter(n => n?.data?.templateName)
      .map(node => ({
        Id: node.id,
        TemplateName: node.data.templateName || "Untitled",
        TemplateType: node.data.templateType || "text_template",
        MessageBody: node.data.messageBody || "",
        PositionX: node.position?.x || 0,
        PositionY: node.position?.y || 0,
        TriggerButtonText: node.data.triggerButtonText || "",
        TriggerButtonType: node.data.triggerButtonType || "cta",
        RequiredTag: node.data.requiredTag || "",
        RequiredSource: node.data.requiredSource || "",
        UseProfileName: !!node.data.useProfileName,
        ProfileNameSlot:
          typeof node.data.profileNameSlot === "number" &&
          node.data.profileNameSlot > 0
            ? node.data.profileNameSlot
            : 1,
        Buttons: (node.data.buttons || [])
          .filter(btn => (btn.text || "").trim().length > 0)
          .map((btn, idx) => ({
            Text: (btn.text || "").trim(),
            Type: btn.type || "QUICK_REPLY",
            SubType: btn.subType || "",
            Value: btn.value || "",
            TargetNodeId: btn.targetNodeId || null,
            Index: typeof btn.index === "number" ? btn.index : idx,
          })),
      }));

    const transformedEdges = edges.map(edge => ({
      FromNodeId: edge.source,
      ToNodeId: edge.target,
      SourceHandle: edge.sourceHandle || "",
    }));

    return {
      FlowName: flowName || "Untitled",
      IsPublished: false, // always draft; publish is explicit
      Nodes: transformedNodes,
      Edges: transformedEdges,
    };
  };

  // --- Save Draft
  const handleSaveDraft = async () => {
    try {
      setSaving(true);
      const payload = buildPayload();

      if (mode === "edit" && flowId) {
        const res = await updateVisualFlow(flowId, payload);
        if (res?.needsRepublish) setRepublishNeeded(true);
        toast.success("‚úÖ Flow updated (draft)");
      } else {
        const res = await saveVisualFlow(payload); // create new draft
        if (res?.flowId) {
          navigate(`/app/cta-flow/flow-manager?tab=draft`);
          return;
        }
        toast.success("‚úÖ Flow saved (draft)");
      }
      setDirty(false);
      navigate(`/app/cta-flow/flow-manager?tab=draft`);
    } catch (error) {
      console.error("‚ùå Save draft failed: ", error);
      if (error?.response?.status === 409) {
        const camps = error?.response?.data?.campaigns || [];
        setLockInfo({ locked: true, campaigns: camps });
        setForkModalOpen(true);
        setReadonly(true);
      } else {
        toast.error("‚ùå Failed to save draft");
      }
    } finally {
      setSaving(false);
    }
  };

  // --- Publish / Republish
  const handlePublish = async () => {
    try {
      setSaving(true);

      if (mode === "edit" && flowId) {
        const payload = buildPayload();
        await updateVisualFlow(flowId, payload);
        await publishFlow(flowId);
        setRepublishNeeded(false);
        setIsPublished(true);
        setDirty(false);
        toast.success("‚úÖ Flow published");
        navigate("/app/cta-flow/flow-manager?tab=published");
        return;
      }

      // NEW flow: create as draft, get id, then publish that id
      const createPayload = { ...buildPayload(), IsPublished: false };
      const res = await saveVisualFlow(createPayload);
      const newId = res?.flowId;

      if (newId) {
        await publishFlow(newId);
        toast.success("‚úÖ Flow created & published");
        navigate("/app/cta-flow/flow-manager?tab=published");
        return;
      }

      toast.success("‚úÖ Flow created (but publish step uncertain)");
      navigate("/app/cta-flow/flow-manager?tab=published");
    } catch (error) {
      console.error("‚ùå Publish failed: ", error);
      if (error?.response?.status === 409) {
        const camps = error?.response?.data?.campaigns || [];
        setLockInfo({ locked: true, campaigns: camps });
        setForkModalOpen(true);
        setReadonly(true);
      } else {
        toast.error("‚ùå Failed to publish");
      }
    } finally {
      setSaving(false);
    }
  };

  const defaultEdgeOptions = useMemo(
    () => ({
      type: "smart",
      animated: true,
      style: { stroke: "#9333ea" },
      markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
    }),
    []
  );

  return (
    <div className="p-6 relative">
      {/* Page-level spinner overlay */}
      {(loading || saving) && (
        <div className="absolute inset-0 z-[60] bg-white/70 backdrop-blur-[1px] grid place-items-center">
          <div className="flex items-center gap-3 px-4 py-2 bg-white rounded-xl shadow border">
            <svg
              className="animate-spin h-5 w-5 text-purple-600"
              viewBox="0 0 24 24"
            >
              <circle
                className="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                strokeWidth="4"
                fill="none"
              />
              <path
                className="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
              />
            </svg>
            <span className="text-sm text-gray-700">
              {loading ? "Loading..." : "Working..."}
            </span>
          </div>
        </div>
      )}

      {/* ===== Header: title on left, ALL actions to top-right ===== */}
      <div className="flex flex-wrap items-center justify-between gap-3 mb-4">
        {/* Left: Title + Name */}
        <div className="flex items-center gap-3 min-w-0">
          <h2 className="text-xl sm:text-2xl font-bold text-gray-900 tracking-tight">
            üß† CTA Flow Visual Builder
          </h2>

          {/* Flow name input / badge inline with title */}
          {readonly ? (
            <span className="truncate max-w-[40ch] px-2 py-1 rounded-md bg-purple-50 text-purple-700 text-sm font-medium">
              {flowName || "Untitled Flow"}
            </span>
          ) : (
            <input
              id="flowName"
              name="flowName"
              ref={flowNameRef}
              value={flowName}
              onChange={e => {
                setFlowName(e.target.value);
                setDirty(true);
              }}
              placeholder="Add flow name"
              className="truncate max-w-[40ch] border border-gray-300 px-3 py-1.5 rounded-md shadow-sm text-sm focus:outline-none focus:ring-2 focus:ring-purple-500/50"
            />
          )}
        </div>

        {/* Right: Toolbar */}
        <div className="flex flex-wrap items-center gap-2">
          {/* Back / Manage ‚Äî keep both as small, neutral actions */}
          <button
            onClick={goBackToManager}
            className="px-3 py-2 rounded-md text-sm border border-gray-300 text-gray-700 bg-white hover:bg-gray-50"
            title={`Back to ${
              backTab === "published" ? "Published" : "Drafts"
            }`}
            disabled={saving}
          >
            ‚Üê Back to {backTab === "published" ? "Published" : "Drafts"}
          </button>

          <button
            onClick={() =>
              navigate(`/app/cta-flow/flow-manager?tab=${backTab}`)
            }
            className="px-3 py-2 rounded-md text-sm border border-gray-300 text-gray-700 bg-white hover:bg-gray-50"
            title="Manage all flows"
            disabled={saving}
          >
            ‚ñ§ Manage Flows
          </button>

          {/* Primary actions (hidden in readonly) */}
          {!readonly && (
            <>
              <button
                onClick={() => setShowPicker(true)}
                className="px-3 py-2 rounded-md text-sm bg-purple-600 text-white shadow hover:bg-purple-700"
                disabled={saving}
              >
                ‚ûï Add Step
              </button>

              <button
                onClick={handleSaveDraft}
                className="px-3 py-2 rounded-md text-sm bg-gray-800 text-white hover:bg-gray-900 disabled:opacity-50"
                disabled={saving}
              >
                üíæ Save Draft
              </button>

              <button
                onClick={handlePublish}
                className="px-3 py-2 rounded-md text-sm bg-green-600 text-white hover:bg-green-700 disabled:opacity-50"
                disabled={saving}
              >
                üöÄ {isPublished ? "Republish" : "Publish"}
              </button>
            </>
          )}
        </div>
      </div>
      {/* üîß CHANGED: removed ‚Äú‚ûï Add New Flow‚Äù from header; all buttons are now on the right */}

      {/* Republish banner (kept for clarity) */}
      {!readonly && mode === "edit" && republishNeeded && (
        <div className="mb-3 rounded-md border bg-amber-50 text-amber-800 px-3 py-2 text-sm flex items-center justify-between">
          <div>
            Changes saved as <span className="font-semibold">draft</span>. Click{" "}
            <span className="font-semibold">Republish</span> to make them live.
          </div>
          <button
            onClick={handlePublish}
            className="px-3 py-1 rounded bg-amber-600 text-white hover:bg-amber-700 text-xs"
            disabled={saving}
          >
            Republish
          </button>
        </div>
      )}

      {/* Canvas */}
      <div className="h-[70vh] border rounded-xl bg-gray-50 relative">
        {/* Minimap + tools */}
        <div className="absolute bottom-5 right-4 z-50 flex gap-2">
          <button
            onClick={() => setShowMiniMap(prev => !prev)}
            className="bg-purple-600 text-white p-2 rounded-full shadow hover:bg-purple-700"
            title={showMiniMap ? "Hide MiniMap" : "Show MiniMap"}
          >
            {showMiniMap ? <Minus size={15} /> : <Eye size={15} />}
          </button>

          <div className="flex items-center gap-2 bg-white/90 px-2 py-1 rounded-full border">
            <button
              onClick={() => fitView({ padding: 0.25 })}
              className="text-xs px-2 py-1 rounded hover:bg-gray-100 font-medium"
              title="Fit to screen"
            >
              Fit
            </button>
            <button
              onClick={() => zoomIn()}
              className="text-xs px-2 py-1 rounded hover:bg-gray-100"
              title="Zoom In"
            >
              +
            </button>
            <button
              onClick={() => zoomOut()}
              className="text-xs px-2 py-1 rounded hover:bg-gray-100"
              title="Zoom Out"
            >
              ‚àí
            </button>

            {!readonly && (
              <>
                <button
                  onClick={() => applyLayout("LR")}
                  className="text-xs px-2 py-1 rounded hover:bg-gray-100"
                  title="Auto-layout (Left‚ÜíRight)"
                >
                  Auto TB
                </button>
                <button
                  onClick={() => applyLayout("TB")}
                  className="text-xs px-2 py-1 rounded hover:bg-gray-100"
                  title="Auto-layout (Top‚ÜíBottom)"
                >
                  Auto LR
                </button>
              </>
            )}
          </div>
        </div>

        <ReactFlow
          nodes={nodes}
          edges={edges}
          onNodesChange={onNodesChange}
          onEdgesChange={onEdgesChange}
          onConnect={onConnect}
          onEdgeClick={(e, edge) => {
            if (!readonly) {
              setDirty(true);
              setEdges(eds => eds.filter(ed => ed.id !== edge.id));
            }
          }}
          nodeTypes={nodeTypes}
          edgeTypes={edgeTypes}
          fitView
          fitViewOptions={{ padding: 0.25 }}
          defaultEdgeOptions={defaultEdgeOptions}
          connectionMode={ConnectionMode.Strict}
          isValidConnection={isValidConnection}
          snapToGrid
          snapGrid={[GRID, GRID]}
          panOnScroll
          zoomOnPinch
          panOnDrag={[1, 2]}
          selectionOnDrag
          nodesDraggable={!readonly}
          nodesConnectable={!readonly}
          elementsSelectable={!readonly}
        >
          {showMiniMap && (
            <MiniMap
              nodeColor="#9333ea"
              nodeStrokeWidth={2}
              maskColor="rgba(255,255,255,0.6)"
            />
          )}
          <Controls />
          <Background variant="dots" gap={GRID} size={1} />
        </ReactFlow>
      </div>

      {/* üîß CHANGED: Footer actions removed (buttons now live in header) */}

      {/* Fork modal: when published & attached */}
      {forkModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          <div
            className="absolute inset-0 bg-black/40"
            onClick={() => setForkModalOpen(false)}
          />
          <div
            role="dialog"
            aria-modal="true"
            className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
          >
            <div className="flex items-start gap-3 mb-4">
              <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
                ‚ö†Ô∏è
              </div>
              <div>
                <h3 className="text-lg font-semibold text-gray-900">
                  Editing is blocked for this flow
                </h3>
                <p className="text-sm text-gray-600">
                  This flow is <span className="font-medium">published</span>{" "}
                  and attached to active campaign(s). To make changes, create a{" "}
                  <span className="font-medium">new draft version</span>.
                </p>
              </div>
            </div>

            <div className="max-h-60 overflow-auto rounded-lg border divide-y mb-4">
              {lockInfo.campaigns.map(c => (
                <div key={c.id} className="p-3 text-sm">
                  <div className="flex items-center justify-between">
                    <div className="font-semibold text-gray-900">{c.name}</div>
                    <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-700">
                      {c.status || "‚Äî"}
                    </span>
                  </div>
                  <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
                    <div>
                      Created:{" "}
                      <span className="font-medium text-gray-800">
                        {c.createdAt
                          ? new Date(c.createdAt).toLocaleString("en-IN")
                          : "‚Äî"}
                      </span>
                    </div>
                    <div>
                      Created by:{" "}
                      <span className="font-medium text-gray-800">
                        {c.createdBy || "‚Äî"}
                      </span>
                    </div>
                    <div>
                      Scheduled:{" "}
                      <span className="font-medium text-gray-800">
                        {c.scheduledAt
                          ? new Date(c.scheduledAt).toLocaleString("en-IN")
                          : "‚Äî"}
                      </span>
                    </div>
                    <div>
                      First sent:{" "}
                      <span className="font-medium text-gray-800">
                        {c.firstSentAt
                          ? new Date(c.firstSentAt).toLocaleString("en-IN")
                          : "‚Äî"}
                      </span>
                    </div>
                  </div>
                </div>
              ))}
              {lockInfo.campaigns.length === 0 && (
                <div className="p-3 text-sm text-gray-600">
                  Could not load campaign details. You can still create a new
                  draft version.
                </div>
              )}
            </div>

            <div className="flex justify-end gap-2">
              <button
                className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
                onClick={() => setForkModalOpen(false)}
              >
                Close
              </button>
              <button
                onClick={async () => {
                  try {
                    if (!flowId) return;
                    const { flowId: newId } = await forkFlow(flowId);
                    setForkModalOpen(false);
                    toast.success("‚úÖ New draft version created");
                    navigate(
                      `/app/cta-flow/visual-builder?id=${newId}&mode=edit`
                    );
                  } catch (e) {
                    console.error(e);
                    toast.error("‚ùå Failed to create draft copy");
                  }
                }}
                className="px-3 py-2 text-sm rounded bg-purple-600 text-white hover:bg-purple-700"
              >
                Create new draft version
              </button>
            </div>
          </div>
        </div>
      )}

      <TemplatePickerModal
        open={showPicker}
        onClose={() => setShowPicker(false)}
        onSelect={handleTemplateSelect}
      />
    </div>
  );
}

export default function CTAFlowVisualBuilder() {
  return (
    <ReactFlowProvider>
      <CTAFlowVisualBuilderInner />
    </ReactFlowProvider>
  );
}

// // src/pages/CTAFlowVisualBuilder/CTAFlowVisualBuilder.jsx
// import React, {
//   useCallback,
//   useState,
//   useEffect,
//   useMemo,
//   useRef,
// } from "react";
// import {
//   ReactFlow,
//   ReactFlowProvider,
//   Background,
//   Controls,
//   MiniMap,
//   useNodesState,
//   useEdgesState,
//   addEdge,
//   MarkerType,
//   ConnectionMode,
//   useReactFlow,
// } from "@xyflow/react";
// import "@xyflow/react/dist/style.css";
// import { Eye, Minus } from "lucide-react";
// import { useSearchParams, useNavigate } from "react-router-dom";
// import TemplatePickerModal from "./components/TemplatePickerModal";
// import FlowNodeBubble from "./components/FlowNodeBubble";
// import {
//   saveVisualFlow,
//   getVisualFlowById,
//   updateVisualFlow,
//   publishFlow,
//   forkFlow,
//   getFlowUsage,
// } from "./ctaFlowVisualApi";
// import { v4 as uuidv4 } from "uuid";
// import { toast } from "react-toastify";
// import dagre from "dagre";
// import SmartLabeledEdge from "./components/edges/SmartLabeledEdge";

// const GRID = 16;
// const NODE_DEFAULT = { width: 260, height: 140 };

// function CTAFlowVisualBuilderInner() {
//   const [nodes, setNodes, onNodesChange] = useNodesState([]);
//   const [edges, setEdges, onEdgesChange] = useEdgesState([]);
//   const nodesRef = useRef([]);
//   const [showPicker, setShowPicker] = useState(false);
//   const [flowName, setFlowName] = useState("");
//   const flowNameRef = useRef(null);
//   const [showMiniMap, setShowMiniMap] = useState(false);
//   const [readonly, setReadonly] = useState(false);

//   // policy state
//   const [isPublished, setIsPublished] = useState(false);
//   const [republishNeeded, setRepublishNeeded] = useState(false);
//   const [lockInfo, setLockInfo] = useState({ locked: false, campaigns: [] });
//   const [forkModalOpen, setForkModalOpen] = useState(false);

//   // async state
//   const [saving, setSaving] = useState(false);
//   const [loading, setLoading] = useState(false);

//   const [dirty, setDirty] = useState(false);

//   const [searchParams] = useSearchParams();
//   const navigate = useNavigate();
//   const { fitView, zoomIn, zoomOut } = useReactFlow();

//   const mode = searchParams.get("mode"); // 'edit' | 'view' | null
//   const flowId = searchParams.get("id");
//   const visualDebug = true;

//   // figure out source tab for Back button
//   const fromTab = (searchParams.get("from") || "draft").toLowerCase();
//   const backTab = fromTab === "published" ? "published" : "draft";

//   const goBackToManager = useCallback(() => {
//     if (!readonly && dirty) {
//       const ok = window.confirm("You have unsaved changes. Leave this page?");
//       if (!ok) return;
//     }
//     navigate(`/app/cta-flow/flow-manager?tab=${backTab}`);
//   }, [readonly, dirty, backTab, navigate]);

//   useEffect(() => {
//     nodesRef.current = [...nodes];
//   }, [nodes]);

//   // warn on unload if dirty
//   useEffect(() => {
//     const onBeforeUnload = e => {
//       if (!dirty) return;
//       e.preventDefault();
//       e.returnValue = "";
//     };
//     window.addEventListener("beforeunload", onBeforeUnload);
//     return () => window.removeEventListener("beforeunload", onBeforeUnload);
//   }, [dirty]);

//   // --- Node helpers
//   const handleDeleteNode = useCallback(
//     nodeId => {
//       if (readonly) return;
//       setDirty(true);
//       setNodes(nds => nds.filter(n => n.id !== nodeId));
//       setEdges(eds =>
//         eds.filter(e => e.source !== nodeId && e.target !== nodeId)
//       );
//     },
//     [readonly, setNodes, setEdges]
//   );

//   const handleNodeDataChange = useCallback(
//     (nodeId, newData) => {
//       setDirty(true);
//       setNodes(nds =>
//         nds.map(n =>
//           n.id === nodeId ? { ...n, data: { ...n.data, ...newData } } : n
//         )
//       );
//     },
//     [setNodes]
//   );

//   const nodeTypes = useMemo(
//     () => ({
//       customBubble: props => (
//         <FlowNodeBubble
//           {...props}
//           onDelete={handleDeleteNode}
//           onDataChange={newData => handleNodeDataChange(props.id, newData)}
//           readonly={readonly}
//           visualDebug={visualDebug}
//         />
//       ),
//     }),
//     [handleDeleteNode, readonly, visualDebug, handleNodeDataChange]
//   );

//   const edgeTypes = useMemo(() => ({ smart: SmartLabeledEdge }), []);

//   // --- Load / Bootstrap + policy checks
//   useEffect(() => {
//     const load = async () => {
//       setLoading(true);
//       if (mode === "edit" || mode === "view") {
//         try {
//           const data = await getVisualFlowById(flowId);

//           const builtNodes = (data.nodes || []).map((node, index) => ({
//             id: node.id,
//             type: "customBubble",
//             position: {
//               x: node.positionX ?? 120 + index * 120,
//               y: node.positionY ?? 150 + (index % 5) * 60,
//             },
//             data: {
//               templateName: node.templateName,
//               templateType: node.templateType,
//               messageBody: node.messageBody,
//               triggerButtonText: node.triggerButtonText || "",
//               triggerButtonType: node.triggerButtonType || "cta",
//               requiredTag: node.requiredTag || "",
//               requiredSource: node.requiredSource || "",
//               useProfileName: !!node.useProfileName,
//               profileNameSlot:
//                 typeof node.profileNameSlot === "number" &&
//                 node.profileNameSlot > 0
//                   ? node.profileNameSlot
//                   : 1,
//               buttons: (node.buttons || []).map((btn, i) => ({
//                 text: btn.text,
//                 type: btn.type,
//                 subType: btn.subType,
//                 value: btn.value,
//                 targetNodeId: btn.targetNodeId || null,
//                 index: typeof btn.index === "number" ? btn.index : i,
//               })),
//             },
//           }));

//           const builtEdges = (data.edges || []).map(edge => ({
//             id: `e-${edge.fromNodeId}-${edge.toNodeId}-${
//               edge.sourceHandle || "h"
//             }`,
//             source: edge.fromNodeId,
//             target: edge.toNodeId,
//             sourceHandle: edge.sourceHandle || null,
//             type: "smart",
//             animated: true,
//             style: { stroke: "#9333ea" },
//             markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
//             label: edge.sourceHandle || "",
//           }));

//           const nodesWithIncoming = new Set(builtEdges.map(e => e.target));
//           const nodesWithWarnings = builtNodes.map(node => ({
//             ...node,
//             data: {
//               ...node.data,
//               isUnreachable: false,
//               hasNoIncoming: !nodesWithIncoming.has(node.id),
//             },
//           }));

//           setNodes(nodesWithWarnings);
//           setEdges(builtEdges);
//           setFlowName(data.flowName || "Untitled Flow");
//           setIsPublished(!!data.isPublished);
//           setDirty(false);

//           // policy: if editing a published flow, check attachment
//           if (mode === "edit" && data.isPublished) {
//             try {
//               const usage = await getFlowUsage(flowId);
//               if (usage?.campaigns?.length > 0) {
//                 setLockInfo({ locked: true, campaigns: usage.campaigns });
//                 setForkModalOpen(true);
//                 setReadonly(true);
//               } else {
//                 setReadonly(false);
//               }
//             } catch {
//               setLockInfo({ locked: true, campaigns: [] });
//               setForkModalOpen(true);
//               setReadonly(true);
//             }
//           } else {
//             setReadonly(mode === "view");
//           }

//           // initial fit
//           setTimeout(() => fitView({ padding: 0.25 }), 80);
//         } catch {
//           toast.error("‚ùå Failed to load flow");
//         } finally {
//           setLoading(false);
//         }
//       } else {
//         // creating new flow
//         setNodes([]);
//         setEdges([]);
//         setFlowName("Untitled Flow");
//         setIsPublished(false);
//         setReadonly(false);
//         setDirty(false);
//         setLoading(false);
//         setTimeout(() => fitView({ padding: 0.25 }), 80);
//       }
//     };

//     load();
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, [flowId, mode]);

//   // Auto-fit when viewing, and refit on window resize
//   useEffect(() => {
//     if (mode !== "view") return;
//     const t = setTimeout(() => fitView({ padding: 0.25 }), 80);
//     const onResize = () => fitView({ padding: 0.25 });
//     window.addEventListener("resize", onResize);
//     return () => {
//       clearTimeout(t);
//       window.removeEventListener("resize", onResize);
//     };
//   }, [mode, nodes.length, edges.length, fitView]);

//   // --- Add template
//   const handleTemplateSelect = ({ name, type, body, buttons = [] }) => {
//     if (readonly) return;
//     const id = uuidv4();
//     const newNode = {
//       id,
//       position: { x: Math.random() * 400 + 100, y: Math.random() * 300 + 100 },
//       type: "customBubble",
//       data: {
//         templateName: name || "Untitled",
//         templateType: type || "text_template",
//         messageBody: body || "Message body preview...",
//         triggerButtonText: buttons[0]?.text || "",
//         triggerButtonType: "cta",
//         useProfileName: false,
//         profileNameSlot: 1,
//         buttons: buttons.map((btn, idx) => ({
//           text: btn.text || "",
//           type: btn.type || "QUICK_REPLY",
//           subType: btn.subType || "",
//           value: btn.parameterValue || "",
//           targetNodeId: null,
//           index: idx,
//         })),
//       },
//     };
//     setDirty(true);
//     setNodes(nds => [...nds, newNode]);
//     setShowPicker(false);
//     toast.success(
//       `‚úÖ Step added with ${type?.replace("_", " ") || "template"}`
//     );
//     setTimeout(() => fitView({ padding: 0.25 }), 50);
//   };

//   // --- Connection rules
//   const isValidConnection = useCallback(
//     params => {
//       if (!params?.source || !params?.sourceHandle) return false;
//       const duplicate = edges.some(
//         e =>
//           e.source === params.source && e.sourceHandle === params.sourceHandle
//       );
//       return !duplicate;
//     },
//     [edges]
//   );

//   const onConnect = useCallback(
//     params => {
//       if (readonly) return;
//       setDirty(true);
//       const label = params.sourceHandle || "";

//       setEdges(eds =>
//         addEdge(
//           {
//             ...params,
//             id: uuidv4(),
//             type: "smart",
//             animated: true,
//             style: { stroke: "#9333ea" },
//             markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
//             label,
//           },
//           eds
//         )
//       );

//       setNodes(nds =>
//         nds.map(node => {
//           if (node.id !== params.source) return node;
//           const sourceHandle = params.sourceHandle || "";
//           const updatedButtons = [...(node.data.buttons || [])];

//           const idx = updatedButtons.findIndex(
//             b =>
//               (b.text || "").toLowerCase().trim() ===
//               sourceHandle.toLowerCase().trim()
//           );

//           if (idx >= 0) {
//             updatedButtons[idx] = {
//               ...updatedButtons[idx],
//               targetNodeId: params.target,
//             };
//           } else {
//             const free = updatedButtons.findIndex(b => !b.targetNodeId);
//             if (free >= 0)
//               updatedButtons[free] = {
//                 ...updatedButtons[free],
//                 targetNodeId: params.target,
//               };
//           }

//           return { ...node, data: { ...node.data, buttons: updatedButtons } };
//         })
//       );
//     },
//     [readonly, setEdges, setNodes]
//   );

//   // --- Keyboard UX
//   useEffect(() => {
//     const onKey = e => {
//       if (readonly) return;
//       if (e.key === "Delete" || e.key === "Backspace") {
//         setDirty(true);
//         setNodes(nds => nds.filter(n => !n.selected));
//         setEdges(eds => eds.filter(ed => !ed.selected));
//       }
//       if (e.key === "Escape") {
//         setNodes(nds => nds.map(n => ({ ...n, selected: false })));
//         setEdges(eds => eds.map(ed => ({ ...ed, selected: false })));
//       }
//     };
//     window.addEventListener("keydown", onKey);
//     return () => window.removeEventListener("keydown", onKey);
//   }, [readonly, setNodes, setEdges]);

//   // --- Auto layout (dagre)
//   const applyLayout = useCallback(
//     (direction = "LR") => {
//       const g = new dagre.graphlib.Graph();
//       g.setGraph({
//         rankdir: direction,
//         nodesep: 50,
//         ranksep: 90,
//         marginx: 20,
//         marginy: 20,
//       });
//       g.setDefaultEdgeLabel(() => ({}));

//       nodes.forEach(n => {
//         const width = n?.measured?.width || NODE_DEFAULT.width;
//         const height = n?.measured?.height || NODE_DEFAULT.height;
//         g.setNode(n.id, { width, height });
//       });
//       edges.forEach(e => g.setEdge(e.source, e.target));

//       dagre.layout(g);

//       const laidOut = nodes.map(n => {
//         const { x, y } = g.node(n.id);
//         const width = n?.measured?.width || NODE_DEFAULT.width;
//         const height = n?.measured?.height || NODE_DEFAULT.height;
//         return { ...n, position: { x: x - width / 2, y: y - height / 2 } };
//       });

//       setDirty(true);
//       setNodes(laidOut);
//       setTimeout(() => fitView({ padding: 0.25 }), 50);
//     },
//     [nodes, edges, setNodes, fitView]
//   );

//   // --- Build payload (draft by default; publish is separate)
//   const buildPayload = () => {
//     const transformedNodes = nodes
//       .filter(n => n?.data?.templateName)
//       .map(node => ({
//         Id: node.id,
//         TemplateName: node.data.templateName || "Untitled",
//         TemplateType: node.data.templateType || "text_template",
//         MessageBody: node.data.messageBody || "",
//         PositionX: node.position?.x || 0,
//         PositionY: node.position?.y || 0,
//         TriggerButtonText: node.data.triggerButtonText || "",
//         TriggerButtonType: node.data.triggerButtonType || "cta",
//         RequiredTag: node.data.requiredTag || "",
//         RequiredSource: node.data.requiredSource || "",
//         UseProfileName: !!node.data.useProfileName,
//         ProfileNameSlot:
//           typeof node.data.profileNameSlot === "number" &&
//           node.data.profileNameSlot > 0
//             ? node.data.profileNameSlot
//             : 1,
//         Buttons: (node.data.buttons || [])
//           .filter(btn => (btn.text || "").trim().length > 0)
//           .map((btn, idx) => ({
//             Text: (btn.text || "").trim(),
//             Type: btn.type || "QUICK_REPLY",
//             SubType: btn.subType || "",
//             Value: btn.value || "",
//             TargetNodeId: btn.targetNodeId || null,
//             Index: typeof btn.index === "number" ? btn.index : idx,
//           })),
//       }));

//     const transformedEdges = edges.map(edge => ({
//       FromNodeId: edge.source,
//       ToNodeId: edge.target,
//       SourceHandle: edge.sourceHandle || "",
//     }));

//     return {
//       FlowName: flowName || "Untitled",
//       IsPublished: false, // always draft; publish is explicit
//       Nodes: transformedNodes,
//       Edges: transformedEdges,
//     };
//   };

//   // --- Save Draft (then go to Drafts tab)
//   const handleSaveDraft = async () => {
//     try {
//       setSaving(true);
//       const payload = buildPayload();

//       if (mode === "edit" && flowId) {
//         const res = await updateVisualFlow(flowId, payload);
//         if (res?.needsRepublish) setRepublishNeeded(true);
//         toast.success("‚úÖ Flow updated (draft)");
//       } else {
//         const res = await saveVisualFlow(payload); // create new draft
//         if (res?.flowId) {
//           // move the user to manager drafts list
//           navigate(`/app/cta-flow/flow-manager?tab=draft`);
//           return; // stop further state updates in this screen
//         }
//         toast.success("‚úÖ Flow saved (draft)");
//       }
//       setDirty(false);
//       navigate(`/app/cta-flow/flow-manager?tab=draft`);
//     } catch (error) {
//       console.error("‚ùå Save draft failed: ", error);
//       if (error?.response?.status === 409) {
//         const camps = error?.response?.data?.campaigns || [];
//         setLockInfo({ locked: true, campaigns: camps });
//         setForkModalOpen(true);
//         setReadonly(true);
//       } else {
//         toast.error("‚ùå Failed to save draft");
//       }
//     } finally {
//       setSaving(false);
//     }
//   };

//   // --- Publish / Republish (on new ‚Üí create then publish) then go to Published tab
//   const handlePublish = async () => {
//     try {
//       setSaving(true);

//       if (mode === "edit" && flowId) {
//         const payload = buildPayload();
//         await updateVisualFlow(flowId, payload);
//         await publishFlow(flowId);
//         setRepublishNeeded(false);
//         setIsPublished(true);
//         setDirty(false);
//         toast.success("‚úÖ Flow published");
//         navigate("/app/cta-flow/flow-manager?tab=published");
//         return;
//       }

//       // NEW flow: create as draft, get id, then publish that id
//       const createPayload = { ...buildPayload(), IsPublished: false };
//       const res = await saveVisualFlow(createPayload);
//       const newId = res?.flowId;

//       if (newId) {
//         await publishFlow(newId);
//         toast.success("‚úÖ Flow created & published");
//         navigate("/app/cta-flow/flow-manager?tab=published");
//         return;
//       }

//       // fallback
//       toast.success("‚úÖ Flow created (but publish step uncertain)");
//       navigate("/app/cta-flow/flow-manager?tab=published");
//     } catch (error) {
//       console.error("‚ùå Publish failed: ", error);
//       if (error?.response?.status === 409) {
//         const camps = error?.response?.data?.campaigns || [];
//         setLockInfo({ locked: true, campaigns: camps });
//         setForkModalOpen(true);
//         setReadonly(true);
//       } else {
//         toast.error("‚ùå Failed to publish");
//       }
//     } finally {
//       setSaving(false);
//     }
//   };

//   const defaultEdgeOptions = useMemo(
//     () => ({
//       type: "smart",
//       animated: true,
//       style: { stroke: "#9333ea" },
//       markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
//     }),
//     []
//   );

//   return (
//     <div className="p-6 relative">
//       {/* Page-level spinner overlay */}
//       {(loading || saving) && (
//         <div className="absolute inset-0 z-[60] bg-white/70 backdrop-blur-[1px] grid place-items-center">
//           <div className="flex items-center gap-3 px-4 py-2 bg-white rounded-xl shadow border">
//             <svg
//               className="animate-spin h-5 w-5 text-purple-600"
//               viewBox="0 0 24 24"
//             >
//               <circle
//                 className="opacity-25"
//                 cx="12"
//                 cy="12"
//                 r="10"
//                 stroke="currentColor"
//                 strokeWidth="4"
//                 fill="none"
//               />
//               <path
//                 className="opacity-75"
//                 fill="currentColor"
//                 d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
//               />
//             </svg>
//             <span className="text-sm text-gray-700">
//               {loading ? "Loading..." : "Working..."}
//             </span>
//           </div>
//         </div>
//       )}

//       {/* Header */}
//       <div className="flex flex-wrap items-center justify-between gap-3 mb-4">
//         <div className="flex items-center gap-2">
//           <button
//             onClick={goBackToManager}
//             className="bg-white border border-gray-300 text-gray-700 px-3 py-2 rounded-md shadow-sm hover:bg-gray-50 text-sm"
//             title={`Back to ${
//               backTab === "published" ? "Published" : "Drafts"
//             }`}
//           >
//             ‚Üê Back to {backTab === "published" ? "Published" : "Drafts"}
//           </button>

//           <h2 className="text-2xl font-bold text-purple-700 ml-1">
//             üß† CTA Flow Visual Builder
//           </h2>
//         </div>

//         <div className="flex items-center gap-2">
//           {readonly ? (
//             <div className="px-3 py-2 rounded-md bg-purple-50 text-purple-700 text-sm font-medium">
//               {flowName || "Untitled Flow"}
//             </div>
//           ) : (
//             <input
//               id="flowName"
//               name="flowName"
//               ref={flowNameRef}
//               value={flowName}
//               onChange={e => {
//                 setFlowName(e.target.value);
//                 setDirty(true);
//               }}
//               placeholder="Add flow name"
//               className="border border-gray-300 px-3 py-2 rounded-md shadow-sm text-sm"
//             />
//           )}

//           {/* Always available */}
//           <button
//             onClick={() => navigate(`/app/cta-flow/visual-builder`)}
//             className="bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700 text-sm"
//             title="Create a new flow"
//             disabled={saving}
//           >
//             ‚ûï Add New Flow
//           </button>

//           {!readonly && (
//             <>
//               <button
//                 onClick={() => setShowPicker(true)}
//                 className="bg-purple-600 text-white px-4 py-2 rounded shadow hover:bg-purple-700 text-sm"
//                 disabled={saving}
//               >
//                 ‚ûï Add Step
//               </button>
//               <button
//                 onClick={goBackToManager}
//                 className="bg-white border border-purple-600 text-purple-700 font-medium text-sm px-4 py-2 rounded-md shadow-sm hover:bg-purple-50"
//                 disabled={saving}
//               >
//                 ‚Ü©Ô∏è Manage All Flows
//               </button>
//             </>
//           )}
//         </div>
//       </div>

//       {/* Republish banner */}
//       {!readonly && mode === "edit" && republishNeeded && (
//         <div className="mb-3 rounded-md border bg-amber-50 text-amber-800 px-3 py-2 text-sm flex items-center justify-between">
//           <div>
//             Changes saved as <span className="font-semibold">draft</span>. Click{" "}
//             <span className="font-semibold">Republish</span> to make them live.
//           </div>
//           <button
//             onClick={handlePublish}
//             className="px-3 py-1 rounded bg-amber-600 text-white hover:bg-amber-700 text-xs"
//             disabled={saving}
//           >
//             Republish
//           </button>
//         </div>
//       )}

//       {/* Canvas */}
//       <div className="h-[70vh] border rounded-xl bg-gray-50 relative">
//         {/* Minimap + tools */}
//         <div className="absolute bottom-5 right-4 z-50 flex gap-2">
//           <button
//             onClick={() => setShowMiniMap(prev => !prev)}
//             className="bg-purple-600 text-white p-2 rounded-full shadow hover:bg-purple-700"
//             title={showMiniMap ? "Hide MiniMap" : "Show MiniMap"}
//           >
//             {showMiniMap ? <Minus size={15} /> : <Eye size={15} />}
//           </button>

//           <div className="flex items-center gap-2 bg-white/90 px-2 py-1 rounded-full border">
//             <button
//               onClick={() => fitView({ padding: 0.25 })}
//               className="text-xs px-2 py-1 rounded hover:bg-gray-100 font-medium"
//               title="Fit to screen"
//             >
//               Fit
//             </button>
//             <button
//               onClick={() => zoomIn()}
//               className="text-xs px-2 py-1 rounded hover:bg-gray-100"
//               title="Zoom In"
//             >
//               +
//             </button>
//             <button
//               onClick={() => zoomOut()}
//               className="text-xs px-2 py-1 rounded hover:bg-gray-100"
//               title="Zoom Out"
//             >
//               ‚àí
//             </button>

//             {!readonly && (
//               <>
//                 <button
//                   onClick={() => applyLayout("LR")}
//                   className="text-xs px-2 py-1 rounded hover:bg-gray-100"
//                   title="Auto-layout (Left‚ÜíRight)"
//                 >
//                   Auto LR
//                 </button>
//                 <button
//                   onClick={() => applyLayout("TB")}
//                   className="text-xs px-2 py-1 rounded hover:bg-gray-100"
//                   title="Auto-layout (Top‚ÜíBottom)"
//                 >
//                   Auto TB
//                 </button>
//               </>
//             )}
//           </div>
//         </div>

//         <ReactFlow
//           nodes={nodes}
//           edges={edges}
//           onNodesChange={onNodesChange}
//           onEdgesChange={onEdgesChange}
//           onConnect={onConnect}
//           onEdgeClick={(e, edge) => {
//             if (!readonly) {
//               setDirty(true);
//               setEdges(eds => eds.filter(ed => ed.id !== edge.id));
//             }
//           }}
//           nodeTypes={nodeTypes}
//           edgeTypes={edgeTypes}
//           fitView
//           fitViewOptions={{ padding: 0.25 }}
//           defaultEdgeOptions={defaultEdgeOptions}
//           connectionMode={ConnectionMode.Strict}
//           isValidConnection={isValidConnection}
//           snapToGrid
//           snapGrid={[GRID, GRID]}
//           panOnScroll
//           zoomOnPinch
//           panOnDrag={[1, 2]}
//           selectionOnDrag
//           nodesDraggable={!readonly}
//           nodesConnectable={!readonly}
//           elementsSelectable={!readonly}
//         >
//           {showMiniMap && (
//             <MiniMap
//               nodeColor="#9333ea"
//               nodeStrokeWidth={2}
//               maskColor="rgba(255,255,255,0.6)"
//             />
//           )}
//           <Controls />
//           <Background variant="dots" gap={GRID} size={1} />
//         </ReactFlow>
//       </div>

//       {/* Footer actions */}
//       {!readonly && (
//         <div className="mt-6 flex flex-wrap gap-3">
//           <button
//             onClick={handleSaveDraft}
//             className="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 text-sm disabled:opacity-50"
//             disabled={saving}
//           >
//             üíæ Save Draft
//           </button>

//           <button
//             onClick={handlePublish}
//             className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm disabled:opacity-50"
//             disabled={saving}
//           >
//             üöÄ {isPublished ? "Republish" : "Publish Flow"}
//           </button>
//         </div>
//       )}

//       {/* Fork modal: when published & attached */}
//       {forkModalOpen && (
//         <div className="fixed inset-0 z-50 flex items-center justify-center">
//           <div
//             className="absolute inset-0 bg-black/40"
//             onClick={() => setForkModalOpen(false)}
//           />
//           <div
//             role="dialog"
//             aria-modal="true"
//             className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
//           >
//             <div className="flex items-start gap-3 mb-4">
//               <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                 ‚ö†Ô∏è
//               </div>
//               <div>
//                 <h3 className="text-lg font-semibold text-gray-900">
//                   Editing is blocked for this flow
//                 </h3>
//                 <p className="text-sm text-gray-600">
//                   This flow is <span className="font-medium">published</span>{" "}
//                   and attached to active campaign(s). To make changes, create a{" "}
//                   <span className="font-medium">new draft version</span>.
//                 </p>
//               </div>
//             </div>

//             <div className="max-h-60 overflow-auto rounded-lg border divide-y mb-4">
//               {lockInfo.campaigns.map(c => (
//                 <div key={c.id} className="p-3 text-sm">
//                   <div className="flex items-center justify-between">
//                     <div className="font-semibold text-gray-900">{c.name}</div>
//                     <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-700">
//                       {c.status || "‚Äî"}
//                     </span>
//                   </div>
//                   <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
//                     <div>
//                       Created:{" "}
//                       <span className="font-medium text-gray-800">
//                         {c.createdAt
//                           ? new Date(c.createdAt).toLocaleString("en-IN")
//                           : "‚Äî"}
//                       </span>
//                     </div>
//                     <div>
//                       Created by:{" "}
//                       <span className="font-medium text-gray-800">
//                         {c.createdBy || "‚Äî"}
//                       </span>
//                     </div>
//                     <div>
//                       Scheduled:{" "}
//                       <span className="font-medium text-gray-800">
//                         {c.scheduledAt
//                           ? new Date(c.scheduledAt).toLocaleString("en-IN")
//                           : "‚Äî"}
//                       </span>
//                     </div>
//                     <div>
//                       First sent:{" "}
//                       <span className="font-medium text-gray-800">
//                         {c.firstSentAt
//                           ? new Date(c.firstSentAt).toLocaleString("en-IN")
//                           : "‚Äî"}
//                       </span>
//                     </div>
//                   </div>
//                 </div>
//               ))}
//               {lockInfo.campaigns.length === 0 && (
//                 <div className="p-3 text-sm text-gray-600">
//                   Could not load campaign details. You can still create a new
//                   draft version.
//                 </div>
//               )}
//             </div>

//             <div className="flex justify-end gap-2">
//               <button
//                 className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                 onClick={() => setForkModalOpen(false)}
//               >
//                 Close
//               </button>
//               <button
//                 onClick={async () => {
//                   try {
//                     if (!flowId) return;
//                     const { flowId: newId } = await forkFlow(flowId);
//                     setForkModalOpen(false);
//                     toast.success("‚úÖ New draft version created");
//                     navigate(
//                       `/app/cta-flow/visual-builder?id=${newId}&mode=edit`
//                     );
//                   } catch (e) {
//                     console.error(e);
//                     toast.error("‚ùå Failed to create draft copy");
//                   }
//                 }}
//                 className="px-3 py-2 text-sm rounded bg-purple-600 text-white hover:bg-purple-700"
//               >
//                 Create new draft version
//               </button>
//             </div>
//           </div>
//         </div>
//       )}

//       <TemplatePickerModal
//         open={showPicker}
//         onClose={() => setShowPicker(false)}
//         onSelect={handleTemplateSelect}
//       />
//     </div>
//   );
// }

// export default function CTAFlowVisualBuilder() {
//   return (
//     <ReactFlowProvider>
//       <CTAFlowVisualBuilderInner />
//     </ReactFlowProvider>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\CTAFlowVisualBuilder_AllFileDump.txt 
====================================================== 
 
Folder and File Content Report
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\CTAFlowLogs.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../api/axiosClient";
import { Card } from "../../components/ui/card";
import { Table, Thead, Tbody, Tr, Th, Td } from "../../components/ui/table";
import { format } from "date-fns";

const CTAFlowLogs = () => {
  const [logs, setLogs] = useState([]);

  useEffect(() => {
    axiosClient.get("/tracking/flow-clicks").then(res => {
      setLogs(res.data);
    });
  }, []);

  return (
    <div className="p-6">
      <h2 className="text-2xl font-bold mb-4">CTA Flow Click Logs</h2>
      <Card className="overflow-x-auto">
        <Table>
          <Thead>
            <Tr>
              <Th>Date</Th>
              <Th>Recipient</Th>
              <Th>Button</Th>
              <Th>Template</Th>
              <Th>Step ID</Th>
              <Th>Follow-Up</Th>
            </Tr>
          </Thead>
          <Tbody>
            {logs.map(log => (
              <Tr key={log.id}>
                <Td>
                  {format(new Date(log.clickedAt), "dd MMM yyyy hh:mm a")}
                </Td>
                <Td>{log.contactPhone}</Td>
                <Td>{log.buttonText}</Td>
                <Td>{log.templateId}</Td>
                <Td className="text-xs">{log.stepId}</Td>
                <Td>
                  {log.followUpSent ? (
                    <span className="text-green-600 font-semibold">‚úÖ Yes</span>
                  ) : (
                    <span className="text-gray-500">‚Äî</span>
                  )}
                </Td>
              </Tr>
            ))}
          </Tbody>
        </Table>
      </Card>
    </div>
  );
};

export default CTAFlowLogs;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\CTAFlowManager.jsx 
====================================================== 
 
// üìÑ File: src/pages/CTAFlowVisualBuilder/CTAFlowManager.jsx
import React, { useEffect, useMemo, useRef, useState } from "react";
import { useNavigate, useSearchParams } from "react-router-dom";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";

export default function CTAFlowManager() {
  const [flows, setFlows] = useState([]);
  const [loading, setLoading] = useState(true);

  const [modalOpen, setModalOpen] = useState(false);
  const [modalMode, setModalMode] = useState("confirm"); // confirm | attached
  const [modalCampaigns, setModalCampaigns] = useState([]);
  const [targetFlow, setTargetFlow] = useState(null);

  const [query, setQuery] = useState("");
  const [sortKey, setSortKey] = useState("updated");
  const closeBtnRef = useRef(null);
  const navigate = useNavigate();

  // NEW: read ?tab= from URL (published | draft). Default to 'published'
  const [searchParams, setSearchParams] = useSearchParams();
  const tabFromUrl =
    searchParams.get("tab") === "draft" ? "draft" : "published";
  const [activeTab, setActiveTab] = useState(tabFromUrl);

  const formatDate = date =>
    date
      ? new Date(date).toLocaleString("en-IN", {
          day: "2-digit",
          month: "short",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        })
      : "‚Äî";

  const statusPill = isPublished =>
    isPublished ? (
      <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">
        <span>‚óè</span> Published
      </span>
    ) : (
      <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">
        <span>‚óè</span> Draft
      </span>
    );

  const fetchFlows = async (tab = "published") => {
    setLoading(true);
    try {
      const endpoint =
        tab === "published" ? "/cta-flow/all-published" : "/cta-flow/all-draft";
      const res = await axiosClient.get(endpoint);
      setFlows(Array.isArray(res.data) ? res.data : [res.data]);
    } catch (err) {
      setFlows([]);
      toast.error("‚ùå Failed to load flows.");
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  // NEW: whenever ?tab changes (or on first render), sync state and fetch
  useEffect(() => {
    const tab = searchParams.get("tab") === "draft" ? "draft" : "published";
    setActiveTab(tab);
    fetchFlows(tab);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [searchParams]);

  const filtered = useMemo(() => {
    const q = query.trim().toLowerCase();
    let out = flows;
    if (q) {
      out = out.filter(f =>
        [f.flowName, f.createdBy]
          .filter(Boolean)
          .some(v => String(v).toLowerCase().includes(q))
      );
    }
    switch (sortKey) {
      case "name":
        return [...out].sort((a, b) => a.flowName.localeCompare(b.flowName));
      case "created":
        return [...out].sort(
          (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
        );
      default:
        return [...out].sort(
          (a, b) =>
            new Date(b.updatedAt || b.createdAt) -
            new Date(a.updatedAt || a.createdAt)
        );
    }
  }, [flows, query, sortKey]);

  // ---- delete UX (checks usage) ----
  const openDeleteModal = async flow => {
    if (loading) return; // guard
    setTargetFlow(flow);
    setLoading(true);
    try {
      const { data } = await axiosClient.get(`/cta-flow/${flow.id}/usage`);
      if (data?.canDelete) {
        setModalMode("confirm");
        setModalCampaigns([]);
      } else {
        setModalMode("attached");
        setModalCampaigns(Array.isArray(data?.campaigns) ? data.campaigns : []);
      }
      setModalOpen(true);
      setTimeout(() => closeBtnRef.current?.focus(), 0);
    } catch (err) {
      toast.error("‚ùå Could not check usage for this flow.");
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  const confirmDelete = async () => {
    if (!targetFlow) return;
    setLoading(true);
    try {
      const res = await axiosClient.delete(`/cta-flow/${targetFlow.id}`);
      if (res.status === 204 || res.status === 200) {
        toast.success("‚úÖ Flow deleted permanently.");
        setModalOpen(false);
        setTargetFlow(null);
        await fetchFlows(activeTab);
      } else {
        toast.info("‚ÑπÔ∏è Unexpected response while deleting the flow.");
      }
    } catch (err) {
      const status = err?.response?.status;
      if (status === 409) {
        const campaigns = err.response?.data?.campaigns ?? [];
        setModalMode("attached");
        setModalCampaigns(campaigns);
      } else if (status === 404) {
        toast.error("‚ùå Flow not found.");
        setModalOpen(false);
      } else {
        toast.error("‚ùå Failed to delete flow.");
        setModalOpen(false);
      }
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  // ---- publish from draft tab ----
  const publishFlow = async flow => {
    if (loading) return;
    try {
      setLoading(true);
      await axiosClient.post(`/cta-flow/${flow.id}/publish`);
      toast.success("‚úÖ Flow published.");
      // NEW: when publishing, move to Published tab (and reflect in URL)
      setSearchParams({ tab: "published" });
    } catch (err) {
      const status = err?.response?.status;
      if (status === 409) {
        toast.error(
          err?.response?.data?.message || "‚ùå Cannot publish right now."
        );
      } else if (status === 404) {
        toast.error("‚ùå Flow not found.");
      } else {
        toast.error("‚ùå Failed to publish flow.");
      }
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  const goView = flow => {
    if (loading) return;
    navigate(`/app/cta-flow/visual-builder?id=${flow.id}&mode=view`);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 to-emerald-50 relative">
      <div className="mx-auto max-w-7xl px-4 py-8">
        {/* Loading overlay */}
        {loading && (
          <>
            <div className="absolute inset-0 z-40 bg-white/60 backdrop-blur-[1px] flex items-center justify-center">
              <div className="flex items-center gap-3 text-gray-700">
                <svg
                  className="xafb-spin h-6 w-6 text-purple-600"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                >
                  <circle
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    strokeWidth="4"
                    opacity="0.25"
                  />
                  <path
                    d="M4 12a8 8 0 018-8"
                    stroke="currentColor"
                    strokeWidth="4"
                    strokeLinecap="round"
                    opacity="0.85"
                  />
                </svg>
                <span className="text-sm">Loading‚Ä¶</span>
              </div>
            </div>
            <style>{`@keyframes xafb-spin{to{transform:rotate(360deg)}}.xafb-spin{animation:xafb-spin 1s linear infinite}`}</style>
          </>
        )}

        {/* Header */}
        <div className="mb-8">
          <div className="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
            <div className="flex items-center gap-4">
              <div className="flex items-center gap-3">
                <div className="w-12 h-12 border border-gray-300 bg-gray-50 rounded-lg flex items-center justify-center">
                  <span className="text-gray-600 text-xl">üß©</span>
                </div>
                <div>
                  <h1
                    className="text-2xl font-bold text-gray-900 flex items-center gap-2"
                    style={{ fontFamily: "Plus Jakarta Sans, sans-serif" }}
                  >
                    <span className="text-blue-600">üß©</span>
                    CTA Flow Manager
                  </h1>
                  <p className="text-sm text-gray-600">
                    Create, publish, and manage your visual flows.
                  </p>
                </div>
              </div>
            </div>
            <div className="flex items-center gap-3">
              <button
                onClick={() => navigate("/app/cta-flow/visual-builder")}
                className="border-2 border-emerald-600 text-emerald-600 hover:bg-emerald-600 hover:text-white px-4 py-2 rounded-lg shadow-sm hover:shadow-lg transition-all duration-200 disabled:opacity-50 flex items-center gap-1.5 text-sm"
                disabled={loading}
              >
                <span className="text-sm text-gray-600">‚ûï</span>
                New Flow
              </button>
            </div>
          </div>
        </div>

        {/* Sticky controls */}
        <div className="sticky top-0 z-10 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70 rounded-lg border border-gray-200 p-4 mb-6 shadow-sm">
          <div className="flex flex-col lg:flex-row lg:items-center gap-4">
            {/* Tabs */}
            <div className="flex gap-2">
              {[
                { key: "published", label: "Published Flows", icon: "‚úÖ" },
                { key: "draft", label: "Draft Flows", icon: "üìù" },
              ].map(t => (
                <button
                  key={t.key}
                  className={`px-4 py-2.5 rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-2 ${
                    activeTab === t.key
                      ? "bg-emerald-600 text-white shadow-lg"
                      : "border border-gray-300 text-gray-600 hover:border-emerald-600 hover:text-emerald-600 hover:bg-emerald-50"
                  }`}
                  onClick={() => {
                    if (loading) return;
                    setSearchParams({ tab: t.key });
                  }}
                  disabled={loading}
                >
                  <span>{t.icon}</span>
                  {t.label}
                </button>
              ))}
            </div>

            <div className="flex-1" />

            {/* Search + sort */}
            <div className="flex items-center gap-3">
              <div className="relative">
                <input
                  type="text"
                  className="w-64 max-w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 text-sm pl-10 pr-4 py-2.5"
                  placeholder="Search by name or creator‚Ä¶"
                  value={query}
                  onChange={e => setQuery(e.target.value)}
                />
                <div className="absolute inset-y-0 left-3 grid place-items-center pointer-events-none text-gray-400">
                  üîé
                </div>
              </div>
              <select
                className="rounded-lg border-gray-300 text-sm focus:ring-blue-500 focus:border-blue-500 px-4 py-2.5"
                value={sortKey}
                onChange={e => setSortKey(e.target.value)}
              >
                <option value="updated">Sort: Last updated</option>
                <option value="name">Sort: Name (A‚ÄìZ)</option>
                <option value="created">Sort: Created (newest)</option>
              </select>
            </div>
          </div>
        </div>

        {/* Content */}
        {filtered.length === 0 ? (
          <div className="text-center py-16">
            <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <span className="text-2xl text-gray-400">üß©</span>
            </div>
            <h3 className="text-lg font-medium text-gray-900 mb-2">
              {query
                ? "No flows match your search"
                : activeTab === "published"
                ? "No published flows yet"
                : "No draft flows yet"}
            </h3>
            <p className="text-gray-500 mb-6">
              {query
                ? "Try adjusting your search terms"
                : activeTab === "published"
                ? "Publish a draft to see it here"
                : "Create a new flow to get started"}
            </p>
            {!query && (
              <button
                onClick={() => navigate("/app/cta-flow/visual-builder")}
                className="border-2 border-emerald-600 text-emerald-600 hover:bg-emerald-600 hover:text-white px-6 py-3 rounded-lg shadow-sm hover:shadow-lg transition-all duration-200 flex items-center gap-2 mx-auto"
              >
                <span className="text-lg">‚ûï</span>
                Create Your First Flow
              </button>
            )}
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {filtered.map(flow => (
              <div
                key={flow.id}
                className="bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-lg transition-all duration-200 overflow-hidden"
              >
                <div className="p-6">
                  <div className="flex items-start justify-between mb-4">
                    <div className="flex-1">
                      <h3 className="text-lg font-semibold text-gray-900 mb-1">
                        {flow.flowName}
                      </h3>
                      <p className="text-sm text-gray-500">
                        Created {formatDate(flow.createdAt)}
                      </p>
                    </div>
                    <div className="ml-3">{statusPill(flow.isPublished)}</div>
                  </div>

                  <div className="text-sm text-gray-600 mb-4">
                    <div className="flex items-center gap-2">
                      <span className="text-gray-400">üìÖ</span>
                      <span>
                        Last modified:{" "}
                        {formatDate(flow.updatedAt || flow.createdAt)}
                      </span>
                    </div>
                  </div>

                  <div className="flex items-center gap-2">
                    <button
                      onClick={() => goView(flow)}
                      className="flex-1 border-2 border-gray-300 bg-white hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 disabled:opacity-50"
                      disabled={loading}
                    >
                      üëÅÔ∏è View
                    </button>

                    {/* PUBLISH (only for drafts) */}
                    {!flow.isPublished && (
                      <button
                        onClick={() => publishFlow(flow)}
                        className="flex-1 border-2 border-transparent bg-gradient-to-r from-emerald-200 to-emerald-300 hover:from-emerald-300 hover:to-emerald-400 text-emerald-700 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 disabled:opacity-50"
                        disabled={loading}
                        title="Publish this draft"
                      >
                        üöÄ Publish
                      </button>
                    )}

                    <button
                      onClick={() => openDeleteModal(flow)}
                      className="border-2 border-transparent bg-gradient-to-r from-gray-200 to-gray-300 hover:from-gray-300 hover:to-gray-400 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 disabled:opacity-50"
                      disabled={loading}
                    >
                      üóëÔ∏è
                    </button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Modal */}
      {modalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
          <div
            className="absolute inset-0 bg-black/50 backdrop-blur-sm"
            onClick={() => setModalOpen(false)}
          />
          <div
            role="dialog"
            aria-modal="true"
            className="relative bg-white rounded-lg shadow-2xl w-full max-w-xl p-8"
          >
            {modalMode === "attached" ? (
              <>
                <div className="flex items-start gap-4 mb-6">
                  <div className="shrink-0 mt-1 h-10 w-10 rounded-full bg-rose-100 text-rose-600 grid place-items-center">
                    ‚ö†Ô∏è
                  </div>
                  <div>
                    <h3 className="text-xl font-bold text-gray-900 mb-2">
                      Cannot delete this flow
                    </h3>
                    <p className="text-gray-600">
                      <span className="font-semibold text-gray-900">
                        {targetFlow?.flowName}
                      </span>{" "}
                      is attached to the following campaign
                      {modalCampaigns.length > 1 ? "s" : ""}. Delete those
                      first.
                    </p>
                  </div>
                </div>
                <div className="max-h-72 overflow-auto rounded-lg border divide-y">
                  {modalCampaigns.map(c => (
                    <div key={c.id} className="p-3 text-sm">
                      <div className="flex items-center justify-between">
                        <div className="font-semibold text-gray-900">
                          {c.name}
                        </div>
                        <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-700">
                          {c.status || "‚Äî"}
                        </span>
                      </div>
                      <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
                        <div>
                          Created:{" "}
                          <span className="font-medium text-gray-800">
                            {formatDate(c.createdAt)}
                          </span>
                        </div>
                        <div>
                          Created by:{" "}
                          <span className="font-medium text-gray-800">
                            {c.createdBy || "‚Äî"}
                          </span>
                        </div>
                        <div>
                          Scheduled:{" "}
                          <span className="font-medium text-gray-800">
                            {formatDate(c.scheduledAt)}
                          </span>
                        </div>
                        <div>
                          First sent:{" "}
                          <span className="font-medium text-gray-800">
                            {formatDate(c.firstSentAt)}
                          </span>
                        </div>
                      </div>
                    </div>
                  ))}
                  {modalCampaigns.length === 0 && (
                    <div className="p-3 text-sm text-gray-600">
                      Could not load campaigns.
                    </div>
                  )}
                </div>
                <div className="mt-6 flex justify-end">
                  <button
                    ref={closeBtnRef}
                    className="px-6 py-3 text-sm font-medium rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors"
                    onClick={() => setModalOpen(false)}
                  >
                    Close
                  </button>
                </div>
              </>
            ) : (
              <>
                <div className="flex items-start gap-4 mb-6">
                  <div className="shrink-0 mt-1 h-10 w-10 rounded-full bg-rose-100 text-rose-600 grid place-items-center">
                    üóëÔ∏è
                  </div>
                  <div>
                    <h3 className="text-xl font-bold text-gray-900 mb-2">
                      Delete this flow permanently?
                    </h3>
                    <p className="text-gray-600">
                      This will remove{" "}
                      <span className="font-semibold text-gray-900">
                        {targetFlow?.flowName}
                      </span>{" "}
                      and all of its steps and button links. This action cannot
                      be undone.
                    </p>
                  </div>
                </div>
                <div className="rounded-lg border border-rose-200 p-4 bg-rose-50 text-rose-700 text-sm mb-6">
                  <span className="font-semibold">Warning:</span> Permanent
                  deletion cannot be recovered.
                </div>
                <div className="flex justify-end gap-3">
                  <button
                    className="px-6 py-3 text-sm font-medium rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors"
                    onClick={() => setModalOpen(false)}
                  >
                    Cancel
                  </button>
                  <button
                    onClick={confirmDelete}
                    className="px-6 py-3 text-sm font-medium rounded-lg bg-rose-600 text-white hover:bg-rose-700 transition-colors"
                  >
                    Permanently delete
                  </button>
                </div>
              </>
            )}
          </div>
        </div>
      )}
    </div>
  );
}

// // üìÑ File: xbytechat-ui/src/pages/CTAFlowVisualBuilder/CTAFlowManager.jsx
// import React, { useEffect, useMemo, useRef, useState } from "react";
// import { useNavigate } from "react-router-dom";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";

// export default function CTAFlowManager() {
//   const [flows, setFlows] = useState([]);
//   const [activeTab, setActiveTab] = useState("published"); // default Published
//   const [loading, setLoading] = useState(true);

//   const [modalOpen, setModalOpen] = useState(false);
//   const [modalMode, setModalMode] = useState("confirm"); // confirm | attached
//   const [modalCampaigns, setModalCampaigns] = useState([]);
//   const [targetFlow, setTargetFlow] = useState(null);

//   const [query, setQuery] = useState("");
//   const [sortKey, setSortKey] = useState("updated");
//   const closeBtnRef = useRef(null);
//   const navigate = useNavigate();

//   const formatDate = date =>
//     date
//       ? new Date(date).toLocaleString("en-IN", {
//           day: "2-digit",
//           month: "short",
//           year: "numeric",
//           hour: "2-digit",
//           minute: "2-digit",
//         })
//       : "‚Äî";

//   const statusPill = isPublished =>
//     isPublished ? (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">
//         <span>‚óè</span> Published
//       </span>
//     ) : (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">
//         <span>‚óè</span> Draft
//       </span>
//     );

//   const fetchFlows = async (tab = "published") => {
//     setLoading(true);
//     try {
//       const endpoint =
//         tab === "published" ? "/cta-flow/all-published" : "/cta-flow/all-draft";
//       const res = await axiosClient.get(endpoint);
//       setFlows(Array.isArray(res.data) ? res.data : [res.data]);
//     } catch (err) {
//       setFlows([]);
//       toast.error("‚ùå Failed to load flows.");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   useEffect(() => {
//     fetchFlows("published");
//   }, []);

//   const filtered = useMemo(() => {
//     const q = query.trim().toLowerCase();
//     let out = flows;
//     if (q) {
//       out = out.filter(f =>
//         [f.flowName, f.createdBy]
//           .filter(Boolean)
//           .some(v => String(v).toLowerCase().includes(q))
//       );
//     }
//     switch (sortKey) {
//       case "name":
//         return [...out].sort((a, b) => a.flowName.localeCompare(b.flowName));
//       case "created":
//         return [...out].sort(
//           (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
//         );
//       default:
//         return [...out].sort(
//           (a, b) =>
//             new Date(b.updatedAt || b.createdAt) -
//             new Date(a.updatedAt || a.createdAt)
//         );
//     }
//   }, [flows, query, sortKey]);

//   // ---- delete UX (checks usage) ----
//   const openDeleteModal = async flow => {
//     if (loading) return; // guard
//     setTargetFlow(flow);
//     setLoading(true);
//     try {
//       const { data } = await axiosClient.get(`/cta-flow/${flow.id}/usage`);
//       if (data?.canDelete) {
//         setModalMode("confirm");
//         setModalCampaigns([]);
//       } else {
//         setModalMode("attached");
//         setModalCampaigns(Array.isArray(data?.campaigns) ? data.campaigns : []);
//       }
//       setModalOpen(true);
//       setTimeout(() => closeBtnRef.current?.focus(), 0);
//     } catch (err) {
//       toast.error("‚ùå Could not check usage for this flow.");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   const confirmDelete = async () => {
//     if (!targetFlow) return;
//     setLoading(true);
//     try {
//       const res = await axiosClient.delete(`/cta-flow/${targetFlow.id}`);
//       if (res.status === 204 || res.status === 200) {
//         toast.success("‚úÖ Flow deleted permanently.");
//         setModalOpen(false);
//         setTargetFlow(null);
//         await fetchFlows(activeTab);
//       } else {
//         toast.info("‚ÑπÔ∏è Unexpected response while deleting the flow.");
//       }
//     } catch (err) {
//       const status = err?.response?.status;
//       if (status === 409) {
//         const campaigns = err.response?.data?.campaigns ?? [];
//         setModalMode("attached");
//         setModalCampaigns(campaigns);
//       } else if (status === 404) {
//         toast.error("‚ùå Flow not found.");
//         setModalOpen(false);
//       } else {
//         toast.error("‚ùå Failed to delete flow.");
//         setModalOpen(false);
//       }
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   // ---- publish from draft tab ----
//   const publishFlow = async flow => {
//     if (loading) return; // guard against spam clicks
//     try {
//       setLoading(true);
//       await axiosClient.post(`/cta-flow/${flow.id}/publish`);
//       toast.success("‚úÖ Flow published.");
//       // After publish, jump user to Published tab
//       setActiveTab("published");
//       await fetchFlows("published");
//     } catch (err) {
//       const status = err?.response?.status;
//       if (status === 409) {
//         // If backend blocks due to attachments (unlikely for drafts), surface message
//         toast.error(
//           err?.response?.data?.message || "‚ùå Cannot publish right now."
//         );
//       } else if (status === 404) {
//         toast.error("‚ùå Flow not found.");
//       } else {
//         toast.error("‚ùå Failed to publish flow.");
//       }
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   // ---- edit navigation (fix: ignore click while loading) ----
//   const goEdit = flow => {
//     if (loading) return;
//     // Always open builder in edit mode; builder enforces policies (fork/republish etc.)
//     navigate(`/app/cta-flow/visual-builder?id=${flow.id}&mode=edit`);
//   };

//   const goView = flow => {
//     if (loading) return;
//     navigate(`/app/cta-flow/visual-builder?id=${flow.id}&mode=view`);
//   };

//   return (
//     <div className="p-6 relative">
//       {/* Loading overlay */}
//       {loading && (
//         <>
//           <div className="absolute inset-0 z-40 bg-white/60 backdrop-blur-[1px] flex items-center justify-center">
//             <div className="flex items-center gap-3 text-gray-700">
//               <svg
//                 className="xafb-spin h-6 w-6 text-purple-600"
//                 xmlns="http://www.w3.org/2000/svg"
//                 viewBox="0 0 24 24"
//                 fill="none"
//               >
//                 <circle
//                   cx="12"
//                   cy="12"
//                   r="10"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   opacity="0.25"
//                 />
//                 <path
//                   d="M4 12a8 8 0 018-8"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   strokeLinecap="round"
//                   opacity="0.85"
//                 />
//               </svg>
//               <span className="text-sm">Loading‚Ä¶</span>
//             </div>
//           </div>
//           <style>{`@keyframes xafb-spin{to{transform:rotate(360deg)}}.xafb-spin{animation:xafb-spin 1s linear infinite}`}</style>
//         </>
//       )}

//       {/* Header */}
//       <div className="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between mb-6">
//         <div>
//           <h1 className="text-2xl font-bold text-gray-900">
//             üß© CTA Flow Manager
//           </h1>
//           <p className="text-sm text-gray-500">
//             Create, publish, and manage your visual flows.
//           </p>
//         </div>
//         <div className="flex items-center gap-2">
//           <button
//             onClick={() => navigate("/app/cta-flow/visual-builder")}
//             className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md shadow disabled:opacity-50"
//             disabled={loading}
//           >
//             ‚ûï New Flow
//           </button>
//         </div>
//       </div>

//       {/* Sticky controls */}
//       <div className="sticky top-0 z-10 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70 rounded-xl border p-3 mb-4">
//         <div className="flex flex-col sm:flex-row sm:items-center gap-3">
//           <div className="flex gap-3">
//             {[
//               { key: "published", label: "‚úÖ Published Flows" },
//               { key: "draft", label: "üìù Draft Flows" },
//             ].map(t => (
//               <button
//                 key={t.key}
//                 className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${
//                   activeTab === t.key
//                     ? "bg-purple-600 text-white shadow"
//                     : "text-gray-600 hover:text-purple-700 hover:bg-purple-50"
//                 }`}
//                 onClick={() => {
//                   if (loading) return;
//                   setActiveTab(t.key);
//                   fetchFlows(t.key);
//                 }}
//                 disabled={loading}
//               >
//                 {t.label}
//               </button>
//             ))}
//           </div>

//           <div className="flex-1" />

//           {/* Search + sort */}
//           <div className="flex items-center gap-2">
//             <div className="relative">
//               <input
//                 type="text"
//                 className="w-64 max-w-full rounded-md border-gray-300 focus:ring-purple-500 focus:border-purple-500 text-sm"
//                 placeholder="Search by name or creator‚Ä¶"
//                 value={query}
//                 onChange={e => setQuery(e.target.value)}
//               />
//               <div className="absolute inset-y-0 right-2 grid place-items-center pointer-events-none text-gray-400">
//                 üîé
//               </div>
//             </div>
//             <select
//               className="rounded-md border-gray-300 text-sm focus:ring-purple-500 focus:border-purple-500"
//               value={sortKey}
//               onChange={e => setSortKey(e.target.value)}
//             >
//               <option value="updated">Sort: Last updated</option>
//               <option value="name">Sort: Name (A‚ÄìZ)</option>
//               <option value="created">Sort: Created (newest)</option>
//             </select>
//           </div>
//         </div>
//       </div>

//       {/* Table */}
//       {filtered.length === 0 ? (
//         <div className="text-gray-500 text-center py-16">
//           {query
//             ? "No flows match your search."
//             : activeTab === "published"
//             ? "No published flows yet. Publish a draft to see it here."
//             : "No draft flows yet. Create a new flow to get started."}
//         </div>
//       ) : (
//         <div className="bg-white rounded-xl shadow overflow-hidden">
//           <table className="w-full text-sm">
//             <thead className="bg-gray-50 border-b text-gray-500 uppercase text-xs tracking-wide">
//               <tr>
//                 <th className="px-4 py-3 text-left">Flow Name</th>
//                 <th className="px-4 py-3 text-left">Status</th>
//                 <th className="px-4 py-3 text-left">Last Modified</th>
//                 <th className="px-4 py-3 text-right">Actions</th>
//               </tr>
//             </thead>
//             <tbody className="divide-y divide-gray-100">
//               {filtered.map(flow => (
//                 <tr key={flow.id} className="hover:bg-gray-50">
//                   <td className="px-4 py-3">
//                     <div className="font-medium text-gray-900">
//                       {flow.flowName}
//                     </div>
//                     <div className="text-xs text-gray-500">
//                       Created {formatDate(flow.createdAt)}
//                     </div>
//                   </td>
//                   <td className="px-4 py-3">{statusPill(flow.isPublished)}</td>
//                   <td className="px-4 py-3 text-gray-700">
//                     {formatDate(flow.updatedAt || flow.createdAt)}
//                   </td>
//                   <td className="px-4 py-3">
//                     <div className="flex justify-end gap-3">
//                       <button
//                         onClick={() => goView(flow)}
//                         className="text-blue-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üëÅÔ∏è View
//                       </button>

//                       {/* EDIT */}
//                       {/* <button
//                         onClick={() => goEdit(flow)}
//                         className="text-amber-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         ‚úèÔ∏è {flow.isPublished ? "Edit" : "Edit Draft"}
//                       </button> */}

//                       {/* PUBLISH (only show for drafts) */}
//                       {!flow.isPublished && (
//                         <button
//                           onClick={() => publishFlow(flow)}
//                           className="text-emerald-600 hover:underline text-xs disabled:opacity-50"
//                           disabled={loading}
//                           title="Publish this draft"
//                         >
//                           üöÄ Publish
//                         </button>
//                       )}

//                       {/* DELETE */}
//                       <button
//                         onClick={() => openDeleteModal(flow)}
//                         className="text-rose-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üóëÔ∏è Delete
//                       </button>
//                     </div>
//                   </td>
//                 </tr>
//               ))}
//             </tbody>
//           </table>
//         </div>
//       )}

//       {/* Modal */}
//       {modalOpen && (
//         <div className="fixed inset-0 z-50 flex items-center justify-center">
//           <div
//             className="absolute inset-0 bg-black/40"
//             onClick={() => setModalOpen(false)}
//           />
//           <div
//             role="dialog"
//             aria-modal="true"
//             className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
//           >
//             {modalMode === "attached" ? (
//               <>
//                 <div className="flex items-start gap-3 mb-4">
//                   <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                     ‚ö†Ô∏è
//                   </div>
//                   <div>
//                     <h3 className="text-lg font-semibold text-gray-900">
//                       Cannot delete this flow
//                     </h3>
//                     <p className="text-sm text-gray-600">
//                       <span className="font-medium">
//                         {targetFlow?.flowName}
//                       </span>{" "}
//                       is attached to the following campaign
//                       {modalCampaigns.length > 1 ? "s" : ""}. Delete those
//                       first.
//                     </p>
//                   </div>
//                 </div>
//                 <div className="max-h-72 overflow-auto rounded-lg border divide-y">
//                   {modalCampaigns.map(c => (
//                     <div key={c.id} className="p-3 text-sm">
//                       <div className="flex items-center justify-between">
//                         <div className="font-semibold text-gray-900">
//                           {c.name}
//                         </div>
//                         <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-700">
//                           {c.status || "‚Äî"}
//                         </span>
//                       </div>
//                       <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
//                         <div>
//                           Created:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.createdAt)}
//                           </span>
//                         </div>
//                         <div>
//                           Created by:{" "}
//                           <span className="font-medium text-gray-800">
//                             {c.createdBy || "‚Äî"}
//                           </span>
//                         </div>
//                         <div>
//                           Scheduled:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.scheduledAt)}
//                           </span>
//                         </div>
//                         <div>
//                           First sent:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.firstSentAt)}
//                           </span>
//                         </div>
//                       </div>
//                     </div>
//                   ))}
//                   {modalCampaigns.length === 0 && (
//                     <div className="p-3 text-sm text-gray-600">
//                       Could not load campaigns.
//                     </div>
//                   )}
//                 </div>
//                 <div className="mt-5 flex justify-end">
//                   <button
//                     ref={closeBtnRef}
//                     className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                     onClick={() => setModalOpen(false)}
//                   >
//                     Close
//                   </button>
//                 </div>
//               </>
//             ) : (
//               <>
//                 <div className="flex items-start gap-3 mb-4">
//                   <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                     üóëÔ∏è
//                   </div>
//                   <div>
//                     <h3 className="text-lg font-semibold text-gray-900">
//                       Delete this flow permanently?
//                     </h3>
//                     <p className="text-sm text-gray-600">
//                       This will remove{" "}
//                       <span className="font-medium">
//                         {targetFlow?.flowName}
//                       </span>{" "}
//                       and all of its steps and button links. This action cannot
//                       be undone.
//                     </p>
//                   </div>
//                 </div>
//                 <div className="rounded-lg border p-3 bg-rose-50 text-rose-700 text-sm">
//                   <span className="font-semibold">Warning:</span> Permanent
//                   deletion cannot be recovered.
//                 </div>
//                 <div className="mt-5 flex justify-end gap-2">
//                   <button
//                     className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                     onClick={() => setModalOpen(false)}
//                   >
//                     Cancel
//                   </button>
//                   <button
//                     onClick={confirmDelete}
//                     className="px-3 py-2 text-sm rounded bg-rose-600 text-white hover:bg-rose-700"
//                   >
//                     Permanently delete
//                   </button>
//                 </div>
//               </>
//             )}
//           </div>
//         </div>
//       )}
//     </div>
//   );
// }

// // üìÑ File: xbytechat-ui/src/pages/CTAFlowVisualBuilder/CTAFlowManager.jsx
// import React, { useEffect, useMemo, useRef, useState } from "react";
// import { useNavigate } from "react-router-dom";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";

// export default function CTAFlowManager() {
//   const [flows, setFlows] = useState([]);
//   const [activeTab, setActiveTab] = useState("published"); // default Published
//   const [loading, setLoading] = useState(true);

//   const [modalOpen, setModalOpen] = useState(false);
//   const [modalMode, setModalMode] = useState("confirm"); // confirm | attached
//   const [modalCampaigns, setModalCampaigns] = useState([]);
//   const [targetFlow, setTargetFlow] = useState(null);

//   const [query, setQuery] = useState("");
//   const [sortKey, setSortKey] = useState("updated");
//   const closeBtnRef = useRef(null);
//   const navigate = useNavigate();

//   const formatDate = date =>
//     date
//       ? new Date(date).toLocaleString("en-IN", {
//           day: "2-digit",
//           month: "short",
//           year: "numeric",
//           hour: "2-digit",
//           minute: "2-digit",
//         })
//       : "‚Äî";

//   const statusPill = isPublished =>
//     isPublished ? (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">
//         <span>‚óè</span> Published
//       </span>
//     ) : (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">
//         <span>‚óè</span> Draft
//       </span>
//     );

//   const fetchFlows = async (tab = "published") => {
//     setLoading(true);
//     try {
//       const endpoint =
//         tab === "published" ? "/cta-flow/all-published" : "/cta-flow/all-draft";
//       const res = await axiosClient.get(endpoint);
//       setFlows(Array.isArray(res.data) ? res.data : [res.data]);
//     } catch (err) {
//       setFlows([]);
//       toast.error("‚ùå Failed to load flows");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   useEffect(() => {
//     fetchFlows("published");
//   }, []);

//   const filtered = useMemo(() => {
//     const q = query.trim().toLowerCase();
//     let out = flows;
//     if (q) {
//       out = out.filter(f =>
//         [f.flowName, f.createdBy]
//           .filter(Boolean)
//           .some(v => String(v).toLowerCase().includes(q))
//       );
//     }
//     switch (sortKey) {
//       case "name":
//         return [...out].sort((a, b) => a.flowName.localeCompare(b.flowName));
//       case "created":
//         return [...out].sort(
//           (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
//         );
//       default:
//         return [...out].sort(
//           (a, b) =>
//             new Date(b.updatedAt || b.createdAt) -
//             new Date(a.updatedAt || a.createdAt)
//         );
//     }
//   }, [flows, query, sortKey]);

//   // ---- delete UX (checks usage) ----
//   const openDeleteModal = async flow => {
//     setTargetFlow(flow);
//     setLoading(true);
//     try {
//       const { data } = await axiosClient.get(`/cta-flow/${flow.id}/usage`);
//       if (data?.canDelete) {
//         setModalMode("confirm");
//         setModalCampaigns([]);
//       } else {
//         setModalMode("attached");
//         setModalCampaigns(Array.isArray(data?.campaigns) ? data.campaigns : []);
//       }
//       setModalOpen(true);
//       setTimeout(() => closeBtnRef.current?.focus(), 0);
//     } catch (err) {
//       toast.error("‚ùå Could not check usage for this flow.");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   const confirmDelete = async () => {
//     if (!targetFlow) return;
//     setLoading(true);
//     try {
//       const res = await axiosClient.delete(`/cta-flow/${targetFlow.id}`);
//       if (res.status === 204 || res.status === 200) {
//         toast.success("‚úÖ Flow deleted permanently.");
//         setModalOpen(false);
//         setTargetFlow(null);
//         await fetchFlows(activeTab);
//       } else {
//         toast.info("Unexpected response while deleting the flow.");
//       }
//     } catch (err) {
//       const status = err?.response?.status;
//       if (status === 409) {
//         const campaigns = err.response?.data?.campaigns ?? [];
//         setModalMode("attached");
//         setModalCampaigns(campaigns);
//       } else if (status === 404) {
//         toast.error("‚ùå Flow not found.");
//         setModalOpen(false);
//       } else {
//         toast.error("‚ùå Failed to delete flow.");
//         setModalOpen(false);
//       }
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   return (
//     <div className="p-6 relative">
//       {/* Loading overlay */}
//       {loading && (
//         <>
//           <div className="absolute inset-0 z-40 bg-white/60 backdrop-blur-[1px] flex items-center justify-center">
//             <div className="flex items-center gap-3 text-gray-700">
//               <svg
//                 className="xafb-spin h-6 w-6 text-purple-600"
//                 xmlns="http://www.w3.org/2000/svg"
//                 viewBox="0 0 24 24"
//                 fill="none"
//               >
//                 <circle
//                   cx="12"
//                   cy="12"
//                   r="10"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   opacity="0.25"
//                 />
//                 <path
//                   d="M4 12a8 8 0 018-8"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   strokeLinecap="round"
//                   opacity="0.85"
//                 />
//               </svg>
//               <span className="text-sm">Loading‚Ä¶</span>
//             </div>
//           </div>
//           <style>{`@keyframes xafb-spin{to{transform:rotate(360deg)}}.xafb-spin{animation:xafb-spin 1s linear infinite}`}</style>
//         </>
//       )}

//       {/* Header */}
//       <div className="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between mb-6">
//         <div>
//           <h1 className="text-2xl font-bold text-gray-900">
//             üß© CTA Flow Manager
//           </h1>
//           <p className="text-sm text-gray-500">
//             Create, publish, and manage your visual flows.
//           </p>
//         </div>
//         <div className="flex items-center gap-2">
//           <button
//             onClick={() => navigate("/app/cta-flow/visual-builder")}
//             className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md shadow disabled:opacity-50"
//             disabled={loading}
//           >
//             ‚ûï New Flow
//           </button>
//         </div>
//       </div>

//       {/* Sticky controls */}
//       <div className="sticky top-0 z-10 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70 rounded-xl border p-3 mb-4">
//         <div className="flex flex-col sm:flex-row sm:items-center gap-3">
//           <div className="flex gap-3">
//             {[
//               { key: "published", label: "‚úÖ Published Flows" },
//               { key: "draft", label: "üìù Draft Flows" },
//             ].map(t => (
//               <button
//                 key={t.key}
//                 className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${
//                   activeTab === t.key
//                     ? "bg-purple-600 text-white shadow"
//                     : "text-gray-600 hover:text-purple-700 hover:bg-purple-50"
//                 }`}
//                 onClick={() => {
//                   setActiveTab(t.key);
//                   fetchFlows(t.key);
//                 }}
//                 disabled={loading}
//               >
//                 {t.label}
//               </button>
//             ))}
//           </div>

//           <div className="flex-1" />

//           {/* Search + sort */}
//           <div className="flex items-center gap-2">
//             <div className="relative">
//               <input
//                 type="text"
//                 className="w-64 max-w-full rounded-md border-gray-300 focus:ring-purple-500 focus:border-purple-500 text-sm"
//                 placeholder="Search by name or creator‚Ä¶"
//                 value={query}
//                 onChange={e => setQuery(e.target.value)}
//               />
//               <div className="absolute inset-y-0 right-2 grid place-items-center pointer-events-none text-gray-400">
//                 üîé
//               </div>
//             </div>
//             <select
//               className="rounded-md border-gray-300 text-sm focus:ring-purple-500 focus:border-purple-500"
//               value={sortKey}
//               onChange={e => setSortKey(e.target.value)}
//             >
//               <option value="updated">Sort: Last updated</option>
//               <option value="name">Sort: Name (A‚ÄìZ)</option>
//               <option value="created">Sort: Created (newest)</option>
//             </select>
//           </div>
//         </div>
//       </div>

//       {/* Table */}
//       {filtered.length === 0 ? (
//         <div className="text-gray-500 text-center py-16">
//           {query
//             ? "No flows match your search."
//             : activeTab === "published"
//             ? "No published flows yet. Publish a draft to see it here."
//             : "No draft flows yet. Create a new flow to get started."}
//         </div>
//       ) : (
//         <div className="bg-white rounded-xl shadow overflow-hidden">
//           <table className="w-full text-sm">
//             <thead className="bg-gray-50 border-b text-gray-500 uppercase text-xs tracking-wide">
//               <tr>
//                 <th className="px-4 py-3 text-left">Flow Name</th>
//                 <th className="px-4 py-3 text-left">Status</th>
//                 <th className="px-4 py-3 text-left">Last Modified</th>
//                 <th className="px-4 py-3 text-right">Actions</th>
//               </tr>
//             </thead>
//             <tbody className="divide-y divide-gray-100">
//               {filtered.map(flow => (
//                 <tr key={flow.id} className="hover:bg-gray-50">
//                   <td className="px-4 py-3">
//                     <div className="font-medium text-gray-900">
//                       {flow.flowName}
//                     </div>
//                     <div className="text-xs text-gray-500">
//                       Created {formatDate(flow.createdAt)}
//                     </div>
//                   </td>
//                   <td className="px-4 py-3">{statusPill(flow.isPublished)}</td>
//                   <td className="px-4 py-3 text-gray-700">
//                     {formatDate(flow.updatedAt || flow.createdAt)}
//                   </td>
//                   <td className="px-4 py-3">
//                     <div className="flex justify-end gap-3">
//                       <button
//                         onClick={() =>
//                           navigate(
//                             `/app/cta-flow/visual-builder?id=${flow.id}&mode=view`
//                           )
//                         }
//                         className="text-blue-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üëÅÔ∏è View
//                       </button>

//                       {/* EDIT gate: if published, we'll decide in the builder whether republish is needed or fork */}
//                       <button
//                         onClick={() =>
//                           navigate(
//                             `/app/cta-flow/visual-builder?id=${flow.id}&mode=edit`
//                           )
//                         }
//                         className="text-amber-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         ‚úèÔ∏è Edit
//                       </button>

//                       <button
//                         onClick={() => openDeleteModal(flow)}
//                         className="text-rose-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üóëÔ∏è Delete
//                       </button>
//                     </div>
//                   </td>
//                 </tr>
//               ))}
//             </tbody>
//           </table>
//         </div>
//       )}

//       {/* Modal */}
//       {modalOpen && (
//         <div className="fixed inset-0 z-50 flex items-center justify-center">
//           <div
//             className="absolute inset-0 bg-black/40"
//             onClick={() => setModalOpen(false)}
//           />
//           <div
//             role="dialog"
//             aria-modal="true"
//             className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
//           >
//             {modalMode === "attached" ? (
//               <>
//                 <div className="flex items-start gap-3 mb-4">
//                   <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                     ‚ö†Ô∏è
//                   </div>
//                   <div>
//                     <h3 className="text-lg font-semibold text-gray-900">
//                       Cannot delete this flow
//                     </h3>
//                     <p className="text-sm text-gray-600">
//                       <span className="font-medium">
//                         {targetFlow?.flowName}
//                       </span>{" "}
//                       is attached to the following campaign
//                       {modalCampaigns.length > 1 ? "s" : ""}. Delete those
//                       first.
//                     </p>
//                   </div>
//                 </div>
//                 <div className="max-h-72 overflow-auto rounded-lg border divide-y">
//                   {modalCampaigns.map(c => (
//                     <div key={c.id} className="p-3 text-sm">
//                       <div className="flex items-center justify-between">
//                         <div className="font-semibold text-gray-900">
//                           {c.name}
//                         </div>
//                         <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-700">
//                           {c.status || "‚Äî"}
//                         </span>
//                       </div>
//                       <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
//                         <div>
//                           Created:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.createdAt)}
//                           </span>
//                         </div>
//                         <div>
//                           Created by:{" "}
//                           <span className="font-medium text-gray-800">
//                             {c.createdBy || "‚Äî"}
//                           </span>
//                         </div>
//                         <div>
//                           Scheduled:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.scheduledAt)}
//                           </span>
//                         </div>
//                         <div>
//                           First sent:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.firstSentAt)}
//                           </span>
//                         </div>
//                       </div>
//                     </div>
//                   ))}
//                 </div>
//                 <div className="mt-5 flex justify-end">
//                   <button
//                     ref={closeBtnRef}
//                     className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                     onClick={() => setModalOpen(false)}
//                   >
//                     Close
//                   </button>
//                 </div>
//               </>
//             ) : (
//               <>
//                 <div className="flex items-start gap-3 mb-4">
//                   <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                     üóëÔ∏è
//                   </div>
//                   <div>
//                     <h3 className="text-lg font-semibold text-gray-900">
//                       Delete this flow permanently?
//                     </h3>
//                     <p className="text-sm text-gray-600">
//                       This will remove{" "}
//                       <span className="font-medium">
//                         {targetFlow?.flowName}
//                       </span>{" "}
//                       and all of its steps and button links. This action cannot
//                       be undone.
//                     </p>
//                   </div>
//                 </div>
//                 <div className="rounded-lg border p-3 bg-rose-50 text-rose-700 text-sm">
//                   <span className="font-semibold">Warning:</span> Permanent
//                   deletion cannot be recovered.
//                 </div>
//                 <div className="mt-5 flex justify-end gap-2">
//                   <button
//                     className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                     onClick={() => setModalOpen(false)}
//                   >
//                     Cancel
//                   </button>
//                   <button
//                     onClick={confirmDelete}
//                     className="px-3 py-2 text-sm rounded bg-rose-600 text-white hover:bg-rose-700"
//                   >
//                     Permanently delete
//                   </button>
//                 </div>
//               </>
//             )}
//           </div>
//         </div>
//       )}
//     </div>
//   );
// }

// import React, { useEffect, useMemo, useRef, useState } from "react";
// import { useNavigate } from "react-router-dom";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";

// export default function CTAFlowManager() {
//   // ---------- state ----------
//   const [flows, setFlows] = useState([]);
//   const [activeTab, setActiveTab] = useState("published"); // ‚úÖ default to published
//   const [loading, setLoading] = useState(true);

//   // Search + sort (client-side)
//   const [query, setQuery] = useState("");
//   const [sortKey, setSortKey] = useState("updated"); // updated | name | created

//   // Modal
//   const [modalOpen, setModalOpen] = useState(false);
//   const [modalMode, setModalMode] = useState("confirm"); // confirm | attached
//   const [modalCampaigns, setModalCampaigns] = useState([]);
//   const [targetFlow, setTargetFlow] = useState(null);

//   const navigate = useNavigate();
//   const closeBtnRef = useRef(null);

//   // ---------- helpers ----------
//   const formatDate = date => {
//     if (!date) return "‚Äî";
//     const d = new Date(date);
//     return d.toLocaleString("en-IN", {
//       day: "2-digit",
//       month: "short",
//       year: "numeric",
//       hour: "2-digit",
//       minute: "2-digit",
//     });
//   };

//   const statusPill = isPublished =>
//     isPublished ? (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">
//         <span>‚óè</span> Published
//       </span>
//     ) : (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">
//         <span>‚óè</span> Draft
//       </span>
//     );

//   const renderStatusBadge = status => {
//     const s = (status || "").toLowerCase();
//     const map = {
//       draft: "bg-amber-100 text-amber-700",
//       scheduled: "bg-sky-100 text-sky-700",
//       running: "bg-blue-100 text-blue-700",
//       sent: "bg-emerald-100 text-emerald-700",
//       completed: "bg-emerald-100 text-emerald-700",
//       failed: "bg-rose-100 text-rose-700",
//     };
//     const cls = map[s] || "bg-gray-100 text-gray-700";
//     return (
//       <span
//         className={`inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium ${cls}`}
//       >
//         {status || "‚Äî"}
//       </span>
//     );
//   };

//   // ---------- data ----------
//   const fetchFlows = async (tab = "published") => {
//     setLoading(true);
//     try {
//       const endpoint =
//         tab === "published" ? "/cta-flow/all-published" : "/cta-flow/all-draft";
//       const res = await axiosClient.get(endpoint);
//       const list = Array.isArray(res.data) ? res.data : [res.data];
//       setFlows(list);
//     } catch (err) {
//       setFlows([]);
//       toast.error("‚ùå Failed to load flows");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   useEffect(() => {
//     fetchFlows("published"); // ‚úÖ first load = published
//   }, []);

//   // ---------- search + sort (client-side) ----------
//   const filtered = useMemo(() => {
//     const q = query.trim().toLowerCase();
//     let out = flows;
//     if (q) {
//       out = out.filter(f =>
//         [f.flowName, f.createdBy]
//           .filter(Boolean)
//           .some(v => String(v).toLowerCase().includes(q))
//       );
//     }
//     switch (sortKey) {
//       case "name":
//         out = [...out].sort((a, b) => a.flowName.localeCompare(b.flowName));
//         break;
//       case "created":
//         out = [...out].sort(
//           (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
//         );
//         break;
//       default:
//         out = [...out].sort(
//           (a, b) =>
//             new Date(b.updatedAt || b.createdAt) -
//             new Date(a.updatedAt || a.createdAt)
//         );
//     }
//     return out;
//   }, [flows, query, sortKey]);

//   // ---------- delete flow UX ----------
//   const openDeleteModal = async flow => {
//     setTargetFlow(flow);
//     setLoading(true);
//     try {
//       const { data } = await axiosClient.get(`/cta-flow/${flow.id}/usage`);
//       if (data?.canDelete) {
//         setModalMode("confirm");
//         setModalCampaigns([]);
//       } else {
//         setModalMode("attached");
//         setModalCampaigns(Array.isArray(data?.campaigns) ? data.campaigns : []);
//       }
//       setModalOpen(true);
//       setTimeout(() => closeBtnRef.current?.focus(), 0);
//     } catch (err) {
//       toast.error("‚ùå Could not check usage for this flow.");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   const confirmDelete = async () => {
//     if (!targetFlow) return;
//     setLoading(true);
//     try {
//       const res = await axiosClient.delete(`/cta-flow/${targetFlow.id}`);
//       if (res.status === 204 || res.status === 200) {
//         toast.success("‚úÖ Flow deleted permanently.");
//         setModalOpen(false);
//         setTargetFlow(null);
//         await fetchFlows(activeTab);
//       } else {
//         toast.info("Unexpected response while deleting the flow.");
//       }
//     } catch (err) {
//       const status = err?.response?.status;
//       if (status === 409) {
//         const campaigns = err.response?.data?.campaigns ?? [];
//         setModalMode("attached");
//         setModalCampaigns(campaigns);
//       } else if (status === 404) {
//         toast.error("‚ùå Flow not found.");
//         setModalOpen(false);
//       } else {
//         toast.error("‚ùå Failed to delete flow.");
//         setModalOpen(false);
//       }
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   // ---------- UI ----------
//   return (
//     <div className="p-6 relative">
//       {/* Loading overlay */}
//       {loading && (
//         <>
//           <div className="absolute inset-0 z-40 bg-white/60 backdrop-blur-[1px] flex items-center justify-center">
//             <div className="flex items-center gap-3 text-gray-700">
//               <svg
//                 className="xafb-spin h-6 w-6 text-purple-600"
//                 xmlns="http://www.w3.org/2000/svg"
//                 viewBox="0 0 24 24"
//                 fill="none"
//               >
//                 <circle
//                   cx="12"
//                   cy="12"
//                   r="10"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   opacity="0.25"
//                 />
//                 <path
//                   d="M4 12a8 8 0 018-8"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   strokeLinecap="round"
//                   opacity="0.85"
//                 />
//               </svg>
//               <span className="text-sm">Loading‚Ä¶</span>
//             </div>
//           </div>
//           <style>{`@keyframes xafb-spin{to{transform:rotate(360deg)}}.xafb-spin{animation:xafb-spin 1s linear infinite}`}</style>
//         </>
//       )}

//       {/* Page header */}
//       <div className="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between mb-6">
//         <div>
//           <h1 className="text-2xl font-bold text-gray-900">
//             üß© CTA Flow Manager
//           </h1>
//           <p className="text-sm text-gray-500">
//             Create, publish, and manage your visual flows.
//           </p>
//         </div>
//         <div className="flex items-center gap-2">
//           <button
//             onClick={() => navigate("/app/cta-flow/visual-builder")}
//             className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md shadow disabled:opacity-50"
//             disabled={loading}
//           >
//             ‚ûï New Flow
//           </button>
//         </div>
//       </div>

//       {/* Sticky controls */}
//       <div className="sticky top-0 z-10 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70 rounded-xl border p-3 mb-4">
//         <div className="flex flex-col sm:flex-row sm:items-center gap-3">
//           {/* Tabs */}
//           <div className="flex gap-3">
//             {[
//               { key: "published", label: "‚úÖ Published Flows" },
//               { key: "draft", label: "üìù Draft Flows" },
//             ].map(t => (
//               <button
//                 key={t.key}
//                 className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${
//                   activeTab === t.key
//                     ? "bg-purple-600 text-white shadow"
//                     : "text-gray-600 hover:text-purple-700 hover:bg-purple-50"
//                 }`}
//                 onClick={() => {
//                   setActiveTab(t.key);
//                   fetchFlows(t.key);
//                 }}
//                 disabled={loading}
//               >
//                 {t.label}
//               </button>
//             ))}
//           </div>

//           {/* Spacer */}
//           <div className="flex-1" />

//           {/* Search */}
//           <div className="flex items-center gap-2">
//             <div className="relative">
//               <input
//                 type="text"
//                 className="w-64 max-w-full rounded-md border-gray-300 focus:ring-purple-500 focus:border-purple-500 text-sm"
//                 placeholder="Search by name or creator‚Ä¶"
//                 value={query}
//                 onChange={e => setQuery(e.target.value)}
//               />
//               <div className="absolute inset-y-0 right-2 grid place-items-center pointer-events-none text-gray-400">
//                 üîé
//               </div>
//             </div>

//             {/* Sort */}
//             <select
//               className="rounded-md border-gray-300 text-sm focus:ring-purple-500 focus:border-purple-500"
//               value={sortKey}
//               onChange={e => setSortKey(e.target.value)}
//             >
//               <option value="updated">Sort: Last updated</option>
//               <option value="name">Sort: Name (A‚ÄìZ)</option>
//               <option value="created">Sort: Created (newest)</option>
//             </select>
//           </div>
//         </div>
//       </div>

//       {/* Content */}
//       {filtered.length === 0 ? (
//         <div className="text-gray-500 text-center py-16">
//           {query
//             ? "No flows match your search."
//             : activeTab === "published"
//             ? "No published flows yet. Publish a draft to see it here."
//             : "No draft flows yet. Create a new flow to get started."}
//         </div>
//       ) : (
//         <div className="bg-white rounded-xl shadow overflow-hidden">
//           <table className="w-full text-sm">
//             <thead className="bg-gray-50 border-b text-gray-500 uppercase text-xs tracking-wide">
//               <tr>
//                 <th className="px-4 py-3 text-left">Flow Name</th>
//                 <th className="px-4 py-3 text-left">Status</th>
//                 <th className="px-4 py-3 text-left">Last Modified</th>
//                 <th className="px-4 py-3 text-right">Actions</th>
//               </tr>
//             </thead>
//             <tbody className="divide-y divide-gray-100">
//               {filtered.map(flow => (
//                 <tr key={flow.id} className="hover:bg-gray-50">
//                   <td className="px-4 py-3">
//                     <div className="font-medium text-gray-900">
//                       {flow.flowName}
//                     </div>
//                     <div className="text-xs text-gray-500">
//                       Created {formatDate(flow.createdAt)}
//                     </div>
//                   </td>
//                   <td className="px-4 py-3">{statusPill(flow.isPublished)}</td>
//                   <td className="px-4 py-3 text-gray-700">
//                     {formatDate(flow.updatedAt || flow.createdAt)}
//                   </td>
//                   <td className="px-4 py-3">
//                     <div className="flex justify-end gap-3">
//                       <button
//                         onClick={() =>
//                           navigate(
//                             `/app/cta-flow/visual-builder?id=${flow.id}&mode=view`
//                           )
//                         }
//                         className="text-blue-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üëÅÔ∏è View
//                       </button>
//                       {!flow.isPublished && (
//                         <button
//                           onClick={() =>
//                             navigate(
//                               `/app/cta-flow/visual-builder?id=${flow.id}&mode=edit`
//                             )
//                           }
//                           className="text-amber-600 hover:underline text-xs disabled:opacity-50"
//                           disabled={loading}
//                         >
//                           ‚úèÔ∏è Edit
//                         </button>
//                       )}
//                       <button
//                         onClick={() => openDeleteModal(flow)}
//                         className="text-rose-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üóëÔ∏è Delete
//                       </button>
//                     </div>
//                   </td>
//                 </tr>
//               ))}
//             </tbody>
//           </table>
//         </div>
//       )}

//       {/* Modal */}
//       {modalOpen && (
//         <div className="fixed inset-0 z-50 flex items-center justify-center">
//           <div
//             className="absolute inset-0 bg-black/40"
//             onClick={() => setModalOpen(false)}
//           />
//           <div
//             role="dialog"
//             aria-modal="true"
//             className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
//           >
//             {/* Header */}
//             {modalMode === "attached" ? (
//               <div className="flex items-start gap-3 mb-4">
//                 <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                   ‚ö†Ô∏è
//                 </div>
//                 <div>
//                   <h3 className="text-lg font-semibold text-gray-900">
//                     Cannot delete this flow
//                   </h3>
//                   <p className="text-sm text-gray-600">
//                     <span className="font-medium">{targetFlow?.flowName}</span>{" "}
//                     is attached to the campaign
//                     {modalCampaigns.length > 1 ? "s" : ""} below. Delete those
//                     campaign
//                     {modalCampaigns.length > 1 ? "s" : ""} first.
//                   </p>
//                 </div>
//               </div>
//             ) : (
//               <div className="flex items-start gap-3 mb-4">
//                 <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                   üóëÔ∏è
//                 </div>
//                 <div>
//                   <h3 className="text-lg font-semibold text-gray-900">
//                     Delete this flow permanently?
//                   </h3>
//                   <p className="text-sm text-gray-600">
//                     This will remove{" "}
//                     <span className="font-medium">{targetFlow?.flowName}</span>{" "}
//                     and all of its steps and button links. This action cannot be
//                     undone.
//                   </p>
//                 </div>
//               </div>
//             )}

//             {/* Body */}
//             {modalMode === "attached" ? (
//               <div className="max-h-72 overflow-auto rounded-lg border divide-y">
//                 {modalCampaigns.map(c => (
//                   <div key={c.id} className="p-3 text-sm">
//                     <div className="flex items-center justify-between">
//                       <div className="font-semibold text-gray-900">
//                         {c.name}
//                       </div>
//                       {renderStatusBadge(c.status)}
//                     </div>
//                     <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
//                       <div>
//                         Created:{" "}
//                         <span className="font-medium text-gray-800">
//                           {formatDate(c.createdAt)}
//                         </span>
//                       </div>
//                       <div>
//                         Created by:{" "}
//                         <span className="font-medium text-gray-800">
//                           {c.createdBy || "‚Äî"}
//                         </span>
//                       </div>
//                       <div>
//                         Scheduled:{" "}
//                         <span className="font-medium text-gray-800">
//                           {formatDate(c.scheduledAt)}
//                         </span>
//                       </div>
//                       <div>
//                         First sent:{" "}
//                         <span className="font-medium text-gray-800">
//                           {formatDate(c.firstSentAt)}
//                         </span>
//                       </div>
//                     </div>
//                   </div>
//                 ))}
//               </div>
//             ) : (
//               <div className="rounded-lg border p-3 bg-rose-50 text-rose-700 text-sm">
//                 <span className="font-semibold">Warning:</span> This will
//                 permanently delete the flow and its data.
//               </div>
//             )}

//             {/* Footer */}
//             <div className="mt-5 flex justify-end gap-2">
//               <button
//                 ref={closeBtnRef}
//                 className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                 onClick={() => setModalOpen(false)}
//               >
//                 Close
//               </button>
//               {modalMode === "confirm" && (
//                 <button
//                   onClick={confirmDelete}
//                   className="px-3 py-2 text-sm rounded bg-rose-600 text-white hover:bg-rose-700"
//                 >
//                   Permanently delete
//                 </button>
//               )}
//             </div>
//           </div>
//         </div>
//       )}
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\ctaFlowVisualApi.js 
====================================================== 
 
// üìÑ File: xbytechat-ui/src/pages/CTAFlowVisualBuilder/ctaFlowVisualApi.js
import axiosClient from "../../api/axiosClient";

const toBool = v => v === true || v === "true" || v === 1;
const toPosInt = (v, def = 1) => {
  const n = parseInt(v, 10);
  return Number.isFinite(n) && n > 0 ? n : def;
};

// ---- shared payload normalizer ----
function normalizePayload(payload) {
  const safeNodes = (payload.Nodes || []).map(node => ({
    Id: node.Id || "",
    TemplateName: node.TemplateName || "",
    TemplateType: node.TemplateType || "text_template",
    MessageBody: node.MessageBody || "",
    PositionX: node.PositionX ?? 0,
    PositionY: node.PositionY ?? 0,
    TriggerButtonText: node.TriggerButtonText || "",
    TriggerButtonType: node.TriggerButtonType || "cta",
    UseProfileName: toBool(node.UseProfileName),
    ProfileNameSlot: toPosInt(node.ProfileNameSlot ?? 1, 1),
    Buttons: (node.Buttons || []).map((btn, idx) => ({
      Text: btn.Text || "",
      Type: btn.Type || "",
      SubType: btn.SubType || "",
      Value: btn.Value || "",
      Index: Number.isFinite(btn.Index) ? btn.Index : idx,
      TargetNodeId: btn.TargetNodeId || null,
    })),
  }));

  const safeEdges = (payload.Edges || []).map(e => ({
    FromNodeId: e.FromNodeId || "",
    ToNodeId: e.ToNodeId || "",
    SourceHandle: e.SourceHandle || "",
  }));

  return {
    FlowName: payload.FlowName || "Untitled",
    IsPublished: !!payload.IsPublished,
    Nodes: safeNodes,
    Edges: safeEdges,
  };
}

// ---- CREATE (by name) ----
export async function saveVisualFlow(payload) {
  const res = await axiosClient.post(
    "/cta-flow/save-visual",
    normalizePayload(payload)
  );
  return res.data;
}

// ---- LOAD BY ID ----
export async function getVisualFlowById(flowId) {
  if (!flowId) throw new Error("flowId is required");
  const res = await axiosClient.get(`/cta-flow/by-id/${flowId}`);
  return res.data;
}

// ---- USAGE (edit/delete gates) ----
export async function getFlowUsage(flowId) {
  if (!flowId) throw new Error("flowId is required");
  const { data } = await axiosClient.get(`/cta-flow/${flowId}/usage`);
  return data; // { canDelete, count, campaigns }
}

// ---- UPDATE BY ID ----
export async function updateVisualFlow(flowId, payload) {
  if (!flowId) throw new Error("flowId is required");
  const res = await axiosClient.put(
    `/cta-flow/${flowId}`,
    normalizePayload(payload)
  );
  return res.data; // { message, needsRepublish? }
}

// ---- PUBLISH ----
export async function publishFlow(flowId) {
  if (!flowId) throw new Error("flowId is required");
  const res = await axiosClient.post(`/cta-flow/${flowId}/publish`);
  return res.data;
}

// ---- FORK (create draft version) ----
export async function forkFlow(flowId) {
  if (!flowId) throw new Error("flowId is required");
  const res = await axiosClient.post(`/cta-flow/${flowId}/fork`);
  return res.data; // { flowId }
}

// ---- (Optional) DELETE helper for manager page ----
export async function deleteFlow(flowId) {
  if (!flowId) throw new Error("flowId is required");
  const res = await axiosClient.delete(`/cta-flow/${flowId}`);
  return res.data;
}

// // üìÑ File: xbytechat-ui/src/pages/CTAFlowVisualBuilder/ctaFlowVisualApi.js
// import axiosClient from "../../api/axiosClient";

// const toBool = v => v === true || v === "true" || v === 1;
// const toPosInt = (v, def = 1) => {
//   const n = parseInt(v, 10);
//   return Number.isFinite(n) && n > 0 ? n : def;
// };

// // ---- CREATE / UPSERT BY NAME (existing) ----
// export async function saveVisualFlow(payload) {
//   const safeNodes = (payload.Nodes || []).map(node => ({
//     Id: node.Id || "",
//     TemplateName: node.TemplateName || "",
//     TemplateType: node.TemplateType || "text_template",
//     MessageBody: node.MessageBody || "",
//     PositionX: node.PositionX ?? 0,
//     PositionY: node.PositionY ?? 0,
//     TriggerButtonText: node.TriggerButtonText || "",
//     TriggerButtonType: node.TriggerButtonType || "cta",
//     UseProfileName: toBool(node.UseProfileName),
//     ProfileNameSlot: toPosInt(node.ProfileNameSlot ?? 1, 1),
//     Buttons: (node.Buttons || []).map((btn, idx) => ({
//       Text: btn.Text || "",
//       Type: btn.Type || "",
//       SubType: btn.SubType || "",
//       Value: btn.Value || "",
//       Index: Number.isFinite(btn.Index) ? btn.Index : idx,
//       TargetNodeId: btn.TargetNodeId || null,
//     })),
//   }));

//   const safeEdges = (payload.Edges || []).map(e => ({
//     FromNodeId: e.FromNodeId || "",
//     ToNodeId: e.ToNodeId || "",
//     SourceHandle: e.SourceHandle || "",
//   }));

//   const fixedPayload = {
//     FlowName: payload.FlowName || "Untitled",
//     IsPublished: !!payload.IsPublished,
//     Nodes: safeNodes,
//     Edges: safeEdges,
//   };

//   const res = await axiosClient.post("/cta-flow/save-visual", fixedPayload);
//   return res.data;
// }

// // ---- LOAD BY ID (existing consumer in builder) ----
// export async function getVisualFlowById(flowId) {
//   const res = await axiosClient.get(`/cta-flow/by-id/${flowId}`);
//   return res.data;
// }

// // ---- NEW: usage for delete/edit gates ----
// export async function getFlowUsage(flowId) {
//   const { data } = await axiosClient.get(`/cta-flow/${flowId}/usage`);
//   return data; // { canDelete: boolean, campaigns: [] }
// }

// // ---- NEW: update by id (two-state policy on backend) ----
// export async function updateVisualFlow(flowId, payload) {
//   const res = await axiosClient.put(`/cta-flow/${flowId}`, payload);
//   return res.data; // { message, needsRepublish? }
// }

// // ---- NEW: publish ----
// export async function publishFlow(flowId) {
//   const res = await axiosClient.post(`/cta-flow/${flowId}/publish`);
//   return res.data;
// }

// // ---- NEW: fork ----
// export async function forkFlow(flowId) {
//   const res = await axiosClient.post(`/cta-flow/${flowId}/fork`);
//   return res.data; // { flowId }
// }

// import axiosClient from "../../api/axiosClient";
// /**
//  * Coerce values coming from the UI into clean types for the API.
//  */
// const toBool = v => v === true || v === "true" || v === 1;
// const toPosInt = (v, def = 1) => {
//   const n = parseInt(v, 10);
//   return Number.isFinite(n) && n > 0 ? n : def;
// };

// /**
//  * Save a visual flow (nodes + edges).
//  * Includes UseProfileName/ProfileNameSlot so the runtime knows where to inject the WA profile name.
//  */
// export async function saveVisualFlow(payload) {
//   const safeNodes = (payload.Nodes || []).map(node => ({
//     Id: node.Id || "",
//     TemplateName: node.TemplateName || "",
//     TemplateType: node.TemplateType || "text_template",
//     MessageBody: node.MessageBody || "",
//     PositionX: node.PositionX ?? 0,
//     PositionY: node.PositionY ?? 0,
//     TriggerButtonText: node.TriggerButtonText || "",
//     TriggerButtonType: node.TriggerButtonType || "cta",

//     // üëá NEW: persist the greeting controls per-step
//     UseProfileName: toBool(node.UseProfileName),
//     ProfileNameSlot: toPosInt(node.ProfileNameSlot ?? 1, 1),

//     // buttons with stable Index (used later to map clicks)
//     Buttons: (node.Buttons || []).map((btn, idx) => ({
//       Text: btn.Text || "",
//       Type: btn.Type || "",
//       SubType: btn.SubType || "",
//       Value: btn.Value || "",
//       TargetNodeId: btn.TargetNodeId || null,
//       Index: Number.isFinite(btn.Index) ? btn.Index : idx,
//     })),
//   }));

//   const safeEdges = (payload.Edges || []).map(e => ({
//     FromNodeId: e.FromNodeId || "",
//     ToNodeId: e.ToNodeId || "",
//     SourceHandle: e.SourceHandle || "", // button text
//   }));

//   const fixedPayload = {
//     FlowName: payload.FlowName || "Untitled",
//     IsPublished: !!payload.IsPublished,
//     Nodes: safeNodes,
//     Edges: safeEdges,
//   };

//   const res = await axiosClient.post("/cta-flow/save-visual", fixedPayload);
//   return res.data;
// }

// /**
//  * Load a visual flow by ID.
//  * The builder expects the response shape to include: { flowName, nodes: [...], edges: [...] }.
//  */
// export async function getVisualFlowById(flowId) {
//   const res = await axiosClient.get(`/cta-flow/by-id/${flowId}`);
//   return res.data;
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\CTAFlowVisualBuilder.jsx 
====================================================== 
 
// src/pages/CTAFlowVisualBuilder/CTAFlowVisualBuilder.jsx
import React, {
  useCallback,
  useState,
  useEffect,
  useMemo,
  useRef,
} from "react";
import {
  ReactFlow,
  ReactFlowProvider,
  Background,
  Controls,
  MiniMap,
  useNodesState,
  useEdgesState,
  addEdge,
  MarkerType,
  ConnectionMode,
  useReactFlow,
} from "@xyflow/react";
import "@xyflow/react/dist/style.css";
import { Eye, Minus } from "lucide-react";
import { useSearchParams, useNavigate } from "react-router-dom";
import TemplatePickerModal from "./components/TemplatePickerModal";
import FlowNodeBubble from "./components/FlowNodeBubble";
import {
  saveVisualFlow,
  getVisualFlowById,
  updateVisualFlow,
  publishFlow,
  forkFlow,
  getFlowUsage,
} from "./ctaFlowVisualApi";
import { v4 as uuidv4 } from "uuid";
import { toast } from "react-toastify";
import dagre from "dagre";
import SmartLabeledEdge from "./components/edges/SmartLabeledEdge";

const GRID = 16;
const NODE_DEFAULT = { width: 260, height: 140 };

function CTAFlowVisualBuilderInner() {
  const [nodes, setNodes, onNodesChange] = useNodesState([]);
  const [edges, setEdges, onEdgesChange] = useEdgesState([]);
  const nodesRef = useRef([]);
  const [showPicker, setShowPicker] = useState(false);
  const [flowName, setFlowName] = useState("");
  const flowNameRef = useRef(null);
  const [showMiniMap, setShowMiniMap] = useState(false);
  const [readonly, setReadonly] = useState(false);

  // policy state
  const [isPublished, setIsPublished] = useState(false);
  const [republishNeeded, setRepublishNeeded] = useState(false);
  const [lockInfo, setLockInfo] = useState({ locked: false, campaigns: [] });
  const [forkModalOpen, setForkModalOpen] = useState(false);

  // async state
  const [saving, setSaving] = useState(false);
  const [loading, setLoading] = useState(false);

  const [dirty, setDirty] = useState(false);

  const [searchParams] = useSearchParams();
  const navigate = useNavigate();
  const { fitView, zoomIn, zoomOut } = useReactFlow();

  const mode = searchParams.get("mode"); // 'edit' | 'view' | null
  const flowId = searchParams.get("id");
  const visualDebug = true;

  // figure out source tab for Back button
  const fromTab = (searchParams.get("from") || "draft").toLowerCase();
  const backTab = fromTab === "published" ? "published" : "draft";

  const goBackToManager = useCallback(() => {
    if (!readonly && dirty) {
      const ok = window.confirm("You have unsaved changes. Leave this page?");
      if (!ok) return;
    }
    navigate(`/app/cta-flow/flow-manager?tab=${backTab}`);
  }, [readonly, dirty, backTab, navigate]);

  useEffect(() => {
    nodesRef.current = [...nodes];
  }, [nodes]);

  // warn on unload if dirty
  useEffect(() => {
    const onBeforeUnload = e => {
      if (!dirty) return;
      e.preventDefault();
      e.returnValue = "";
    };
    window.addEventListener("beforeunload", onBeforeUnload);
    return () => window.removeEventListener("beforeunload", onBeforeUnload);
  }, [dirty]);

  // --- Node helpers
  const handleDeleteNode = useCallback(
    nodeId => {
      if (readonly) return;
      setDirty(true);
      setNodes(nds => nds.filter(n => n.id !== nodeId));
      setEdges(eds =>
        eds.filter(e => e.source !== nodeId && e.target !== nodeId)
      );
    },
    [readonly, setNodes, setEdges]
  );

  const handleNodeDataChange = useCallback(
    (nodeId, newData) => {
      setDirty(true);
      setNodes(nds =>
        nds.map(n =>
          n.id === nodeId ? { ...n, data: { ...n.data, ...newData } } : n
        )
      );
    },
    [setNodes]
  );

  const nodeTypes = useMemo(
    () => ({
      customBubble: props => (
        <FlowNodeBubble
          {...props}
          onDelete={handleDeleteNode}
          onDataChange={newData => handleNodeDataChange(props.id, newData)}
          readonly={readonly}
          visualDebug={visualDebug}
        />
      ),
    }),
    [handleDeleteNode, readonly, visualDebug, handleNodeDataChange]
  );

  const edgeTypes = useMemo(() => ({ smart: SmartLabeledEdge }), []);

  // --- Load / Bootstrap + policy checks
  useEffect(() => {
    const load = async () => {
      setLoading(true);
      if (mode === "edit" || mode === "view") {
        try {
          const data = await getVisualFlowById(flowId);

          const builtNodes = (data.nodes || []).map((node, index) => ({
            id: node.id,
            type: "customBubble",
            position: {
              x: node.positionX ?? 120 + index * 120,
              y: node.positionY ?? 150 + (index % 5) * 60,
            },
            data: {
              templateName: node.templateName,
              templateType: node.templateType,
              messageBody: node.messageBody,
              triggerButtonText: node.triggerButtonText || "",
              triggerButtonType: node.triggerButtonType || "cta",
              requiredTag: node.requiredTag || "",
              requiredSource: node.requiredSource || "",
              useProfileName: !!node.useProfileName,
              profileNameSlot:
                typeof node.profileNameSlot === "number" &&
                node.profileNameSlot > 0
                  ? node.profileNameSlot
                  : 1,
              buttons: (node.buttons || []).map((btn, i) => ({
                text: btn.text,
                type: btn.type,
                subType: btn.subType,
                value: btn.value,
                targetNodeId: btn.targetNodeId || null,
                index: typeof btn.index === "number" ? btn.index : i,
              })),
            },
          }));

          const builtEdges = (data.edges || []).map(edge => ({
            id: `e-${edge.fromNodeId}-${edge.toNodeId}-${
              edge.sourceHandle || "h"
            }`,
            source: edge.fromNodeId,
            target: edge.toNodeId,
            sourceHandle: edge.sourceHandle || null,
            type: "smart",
            animated: true,
            style: { stroke: "#9333ea" },
            markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
            label: edge.sourceHandle || "",
          }));

          const nodesWithIncoming = new Set(builtEdges.map(e => e.target));
          const nodesWithWarnings = builtNodes.map(node => ({
            ...node,
            data: {
              ...node.data,
              isUnreachable: false,
              hasNoIncoming: !nodesWithIncoming.has(node.id),
            },
          }));

          setNodes(nodesWithWarnings);
          setEdges(builtEdges);
          setFlowName(data.flowName || "Untitled Flow");
          setIsPublished(!!data.isPublished);
          setDirty(false);

          // policy: if editing a published flow, check attachment
          if (mode === "edit" && data.isPublished) {
            try {
              const usage = await getFlowUsage(flowId);
              if (usage?.campaigns?.length > 0) {
                setLockInfo({ locked: true, campaigns: usage.campaigns });
                setForkModalOpen(true);
                setReadonly(true);
              } else {
                setReadonly(false);
              }
            } catch {
              setLockInfo({ locked: true, campaigns: [] });
              setForkModalOpen(true);
              setReadonly(true);
            }
          } else {
            setReadonly(mode === "view");
          }

          // initial fit
          setTimeout(() => fitView({ padding: 0.25 }), 80);
        } catch {
          toast.error("‚ùå Failed to load flow");
        } finally {
          setLoading(false);
        }
      } else {
        // creating new flow
        setNodes([]);
        setEdges([]);
        setFlowName("Untitled Flow");
        setIsPublished(false);
        setReadonly(false);
        setDirty(false);
        setLoading(false);
        setTimeout(() => fitView({ padding: 0.25 }), 80);
      }
    };

    load();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [flowId, mode]);

  // Auto-fit when viewing, and refit on window resize
  useEffect(() => {
    if (mode !== "view") return;
    const t = setTimeout(() => fitView({ padding: 0.25 }), 80);
    const onResize = () => fitView({ padding: 0.25 });
    window.addEventListener("resize", onResize);
    return () => {
      clearTimeout(t);
      window.removeEventListener("resize", onResize);
    };
  }, [mode, nodes.length, edges.length, fitView]);

  // --- Add template
  const handleTemplateSelect = ({ name, type, body, buttons = [] }) => {
    if (readonly) return;
    const id = uuidv4();
    const newNode = {
      id,
      position: { x: Math.random() * 400 + 100, y: Math.random() * 300 + 100 },
      type: "customBubble",
      data: {
        templateName: name || "Untitled",
        templateType: type || "text_template",
        messageBody: body || "Message body preview...",
        triggerButtonText: buttons[0]?.text || "",
        triggerButtonType: "cta",
        useProfileName: false,
        profileNameSlot: 1,
        buttons: buttons.map((btn, idx) => ({
          text: btn.text || "",
          type: btn.type || "QUICK_REPLY",
          subType: btn.subType || "",
          value: btn.parameterValue || "",
          targetNodeId: null,
          index: idx,
        })),
      },
    };
    setDirty(true);
    setNodes(nds => [...nds, newNode]);
    setShowPicker(false);
    toast.success(
      `‚úÖ Step added with ${type?.replace("_", " ") || "template"}`
    );
    setTimeout(() => fitView({ padding: 0.25 }), 50);
  };

  // --- Connection rules
  const isValidConnection = useCallback(
    params => {
      if (!params?.source || !params?.sourceHandle) return false;
      const duplicate = edges.some(
        e =>
          e.source === params.source && e.sourceHandle === params.sourceHandle
      );
      return !duplicate;
    },
    [edges]
  );

  const onConnect = useCallback(
    params => {
      if (readonly) return;
      setDirty(true);
      const label = params.sourceHandle || "";

      setEdges(eds =>
        addEdge(
          {
            ...params,
            id: uuidv4(),
            type: "smart",
            animated: true,
            style: { stroke: "#9333ea" },
            markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
            label,
          },
          eds
        )
      );

      setNodes(nds =>
        nds.map(node => {
          if (node.id !== params.source) return node;
          const sourceHandle = params.sourceHandle || "";
          const updatedButtons = [...(node.data.buttons || [])];

          const idx = updatedButtons.findIndex(
            b =>
              (b.text || "").toLowerCase().trim() ===
              sourceHandle.toLowerCase().trim()
          );

          if (idx >= 0) {
            updatedButtons[idx] = {
              ...updatedButtons[idx],
              targetNodeId: params.target,
            };
          } else {
            const free = updatedButtons.findIndex(b => !b.targetNodeId);
            if (free >= 0)
              updatedButtons[free] = {
                ...updatedButtons[free],
                targetNodeId: params.target,
              };
          }

          return { ...node, data: { ...node.data, buttons: updatedButtons } };
        })
      );
    },
    [readonly, setEdges, setNodes]
  );

  // --- Keyboard UX
  useEffect(() => {
    const onKey = e => {
      if (readonly) return;
      if (e.key === "Delete" || e.key === "Backspace") {
        setDirty(true);
        setNodes(nds => nds.filter(n => !n.selected));
        setEdges(eds => eds.filter(ed => !ed.selected));
      }
      if (e.key === "Escape") {
        setNodes(nds => nds.map(n => ({ ...n, selected: false })));
        setEdges(eds => eds.map(ed => ({ ...ed, selected: false })));
      }
    };
    window.addEventListener("keydown", onKey);
    return () => window.removeEventListener("keydown", onKey);
  }, [readonly, setNodes, setEdges]);

  // --- Auto layout (dagre)
  const applyLayout = useCallback(
    (direction = "LR") => {
      const g = new dagre.graphlib.Graph();
      g.setGraph({
        rankdir: direction,
        nodesep: 50,
        ranksep: 90,
        marginx: 20,
        marginy: 20,
      });
      g.setDefaultEdgeLabel(() => ({}));

      nodes.forEach(n => {
        const width = n?.measured?.width || NODE_DEFAULT.width;
        const height = n?.measured?.height || NODE_DEFAULT.height;
        g.setNode(n.id, { width, height });
      });
      edges.forEach(e => g.setEdge(e.source, e.target));

      dagre.layout(g);

      const laidOut = nodes.map(n => {
        const { x, y } = g.node(n.id);
        const width = n?.measured?.width || NODE_DEFAULT.width;
        const height = n?.measured?.height || NODE_DEFAULT.height;
        return { ...n, position: { x: x - width / 2, y: y - height / 2 } };
      });

      setDirty(true);
      setNodes(laidOut);
      setTimeout(() => fitView({ padding: 0.25 }), 50);
    },
    [nodes, edges, setNodes, fitView]
  );

  // --- Build payload (draft by default; publish is separate)
  const buildPayload = () => {
    const transformedNodes = nodes
      .filter(n => n?.data?.templateName)
      .map(node => ({
        Id: node.id,
        TemplateName: node.data.templateName || "Untitled",
        TemplateType: node.data.templateType || "text_template",
        MessageBody: node.data.messageBody || "",
        PositionX: node.position?.x || 0,
        PositionY: node.position?.y || 0,
        TriggerButtonText: node.data.triggerButtonText || "",
        TriggerButtonType: node.data.triggerButtonType || "cta",
        RequiredTag: node.data.requiredTag || "",
        RequiredSource: node.data.requiredSource || "",
        UseProfileName: !!node.data.useProfileName,
        ProfileNameSlot:
          typeof node.data.profileNameSlot === "number" &&
          node.data.profileNameSlot > 0
            ? node.data.profileNameSlot
            : 1,
        Buttons: (node.data.buttons || [])
          .filter(btn => (btn.text || "").trim().length > 0)
          .map((btn, idx) => ({
            Text: (btn.text || "").trim(),
            Type: btn.type || "QUICK_REPLY",
            SubType: btn.subType || "",
            Value: btn.value || "",
            TargetNodeId: btn.targetNodeId || null,
            Index: typeof btn.index === "number" ? btn.index : idx,
          })),
      }));

    const transformedEdges = edges.map(edge => ({
      FromNodeId: edge.source,
      ToNodeId: edge.target,
      SourceHandle: edge.sourceHandle || "",
    }));

    return {
      FlowName: flowName || "Untitled",
      IsPublished: false, // always draft; publish is explicit
      Nodes: transformedNodes,
      Edges: transformedEdges,
    };
  };

  // --- Save Draft
  const handleSaveDraft = async () => {
    try {
      setSaving(true);
      const payload = buildPayload();

      if (mode === "edit" && flowId) {
        const res = await updateVisualFlow(flowId, payload);
        if (res?.needsRepublish) setRepublishNeeded(true);
        toast.success("‚úÖ Flow updated (draft)");
      } else {
        const res = await saveVisualFlow(payload); // create new draft
        if (res?.flowId) {
          navigate(`/app/cta-flow/flow-manager?tab=draft`);
          return;
        }
        toast.success("‚úÖ Flow saved (draft)");
      }
      setDirty(false);
      navigate(`/app/cta-flow/flow-manager?tab=draft`);
    } catch (error) {
      console.error("‚ùå Save draft failed: ", error);
      if (error?.response?.status === 409) {
        const camps = error?.response?.data?.campaigns || [];
        setLockInfo({ locked: true, campaigns: camps });
        setForkModalOpen(true);
        setReadonly(true);
      } else {
        toast.error("‚ùå Failed to save draft");
      }
    } finally {
      setSaving(false);
    }
  };

  // --- Publish / Republish
  const handlePublish = async () => {
    try {
      setSaving(true);

      if (mode === "edit" && flowId) {
        const payload = buildPayload();
        await updateVisualFlow(flowId, payload);
        await publishFlow(flowId);
        setRepublishNeeded(false);
        setIsPublished(true);
        setDirty(false);
        toast.success("‚úÖ Flow published");
        navigate("/app/cta-flow/flow-manager?tab=published");
        return;
      }

      // NEW flow: create as draft, get id, then publish that id
      const createPayload = { ...buildPayload(), IsPublished: false };
      const res = await saveVisualFlow(createPayload);
      const newId = res?.flowId;

      if (newId) {
        await publishFlow(newId);
        toast.success("‚úÖ Flow created & published");
        navigate("/app/cta-flow/flow-manager?tab=published");
        return;
      }

      toast.success("‚úÖ Flow created (but publish step uncertain)");
      navigate("/app/cta-flow/flow-manager?tab=published");
    } catch (error) {
      console.error("‚ùå Publish failed: ", error);
      if (error?.response?.status === 409) {
        const camps = error?.response?.data?.campaigns || [];
        setLockInfo({ locked: true, campaigns: camps });
        setForkModalOpen(true);
        setReadonly(true);
      } else {
        toast.error("‚ùå Failed to publish");
      }
    } finally {
      setSaving(false);
    }
  };

  const defaultEdgeOptions = useMemo(
    () => ({
      type: "smart",
      animated: true,
      style: { stroke: "#9333ea" },
      markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
    }),
    []
  );

  return (
    <div className="p-6 relative">
      {/* Page-level spinner overlay */}
      {(loading || saving) && (
        <div className="absolute inset-0 z-[60] bg-white/70 backdrop-blur-[1px] grid place-items-center">
          <div className="flex items-center gap-3 px-4 py-2 bg-white rounded-xl shadow border">
            <svg
              className="animate-spin h-5 w-5 text-purple-600"
              viewBox="0 0 24 24"
            >
              <circle
                className="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                strokeWidth="4"
                fill="none"
              />
              <path
                className="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
              />
            </svg>
            <span className="text-sm text-gray-700">
              {loading ? "Loading..." : "Working..."}
            </span>
          </div>
        </div>
      )}

      {/* ===== Header: title on left, ALL actions to top-right ===== */}
      <div className="flex flex-wrap items-center justify-between gap-3 mb-4">
        {/* Left: Title + Name */}
        <div className="flex items-center gap-3 min-w-0">
          <h2 className="text-xl sm:text-2xl font-bold text-gray-900 tracking-tight">
            üß† CTA Flow Visual Builder
          </h2>

          {/* Flow name input / badge inline with title */}
          {readonly ? (
            <span className="truncate max-w-[40ch] px-2 py-1 rounded-md bg-purple-50 text-purple-700 text-sm font-medium">
              {flowName || "Untitled Flow"}
            </span>
          ) : (
            <input
              id="flowName"
              name="flowName"
              ref={flowNameRef}
              value={flowName}
              onChange={e => {
                setFlowName(e.target.value);
                setDirty(true);
              }}
              placeholder="Add flow name"
              className="truncate max-w-[40ch] border border-gray-300 px-3 py-1.5 rounded-md shadow-sm text-sm focus:outline-none focus:ring-2 focus:ring-purple-500/50"
            />
          )}
        </div>

        {/* Right: Toolbar */}
        <div className="flex flex-wrap items-center gap-2">
          {/* Back / Manage ‚Äî keep both as small, neutral actions */}
          <button
            onClick={goBackToManager}
            className="px-3 py-2 rounded-md text-sm border border-gray-300 text-gray-700 bg-white hover:bg-gray-50"
            title={`Back to ${
              backTab === "published" ? "Published" : "Drafts"
            }`}
            disabled={saving}
          >
            ‚Üê Back to {backTab === "published" ? "Published" : "Drafts"}
          </button>

          <button
            onClick={() =>
              navigate(`/app/cta-flow/flow-manager?tab=${backTab}`)
            }
            className="px-3 py-2 rounded-md text-sm border border-gray-300 text-gray-700 bg-white hover:bg-gray-50"
            title="Manage all flows"
            disabled={saving}
          >
            ‚ñ§ Manage Flows
          </button>

          {/* Primary actions (hidden in readonly) */}
          {!readonly && (
            <>
              <button
                onClick={() => setShowPicker(true)}
                className="px-3 py-2 rounded-md text-sm bg-purple-600 text-white shadow hover:bg-purple-700"
                disabled={saving}
              >
                ‚ûï Add Step
              </button>

              <button
                onClick={handleSaveDraft}
                className="px-3 py-2 rounded-md text-sm bg-gray-800 text-white hover:bg-gray-900 disabled:opacity-50"
                disabled={saving}
              >
                üíæ Save Draft
              </button>

              <button
                onClick={handlePublish}
                className="px-3 py-2 rounded-md text-sm bg-green-600 text-white hover:bg-green-700 disabled:opacity-50"
                disabled={saving}
              >
                üöÄ {isPublished ? "Republish" : "Publish"}
              </button>
            </>
          )}
        </div>
      </div>
      {/* üîß CHANGED: removed ‚Äú‚ûï Add New Flow‚Äù from header; all buttons are now on the right */}

      {/* Republish banner (kept for clarity) */}
      {!readonly && mode === "edit" && republishNeeded && (
        <div className="mb-3 rounded-md border bg-amber-50 text-amber-800 px-3 py-2 text-sm flex items-center justify-between">
          <div>
            Changes saved as <span className="font-semibold">draft</span>. Click{" "}
            <span className="font-semibold">Republish</span> to make them live.
          </div>
          <button
            onClick={handlePublish}
            className="px-3 py-1 rounded bg-amber-600 text-white hover:bg-amber-700 text-xs"
            disabled={saving}
          >
            Republish
          </button>
        </div>
      )}

      {/* Canvas */}
      <div className="h-[70vh] border rounded-xl bg-gray-50 relative">
        {/* Minimap + tools */}
        <div className="absolute bottom-5 right-4 z-50 flex gap-2">
          <button
            onClick={() => setShowMiniMap(prev => !prev)}
            className="bg-purple-600 text-white p-2 rounded-full shadow hover:bg-purple-700"
            title={showMiniMap ? "Hide MiniMap" : "Show MiniMap"}
          >
            {showMiniMap ? <Minus size={15} /> : <Eye size={15} />}
          </button>

          <div className="flex items-center gap-2 bg-white/90 px-2 py-1 rounded-full border">
            <button
              onClick={() => fitView({ padding: 0.25 })}
              className="text-xs px-2 py-1 rounded hover:bg-gray-100 font-medium"
              title="Fit to screen"
            >
              Fit
            </button>
            <button
              onClick={() => zoomIn()}
              className="text-xs px-2 py-1 rounded hover:bg-gray-100"
              title="Zoom In"
            >
              +
            </button>
            <button
              onClick={() => zoomOut()}
              className="text-xs px-2 py-1 rounded hover:bg-gray-100"
              title="Zoom Out"
            >
              ‚àí
            </button>

            {!readonly && (
              <>
                <button
                  onClick={() => applyLayout("LR")}
                  className="text-xs px-2 py-1 rounded hover:bg-gray-100"
                  title="Auto-layout (Left‚ÜíRight)"
                >
                  Auto TB
                </button>
                <button
                  onClick={() => applyLayout("TB")}
                  className="text-xs px-2 py-1 rounded hover:bg-gray-100"
                  title="Auto-layout (Top‚ÜíBottom)"
                >
                  Auto LR
                </button>
              </>
            )}
          </div>
        </div>

        <ReactFlow
          nodes={nodes}
          edges={edges}
          onNodesChange={onNodesChange}
          onEdgesChange={onEdgesChange}
          onConnect={onConnect}
          onEdgeClick={(e, edge) => {
            if (!readonly) {
              setDirty(true);
              setEdges(eds => eds.filter(ed => ed.id !== edge.id));
            }
          }}
          nodeTypes={nodeTypes}
          edgeTypes={edgeTypes}
          fitView
          fitViewOptions={{ padding: 0.25 }}
          defaultEdgeOptions={defaultEdgeOptions}
          connectionMode={ConnectionMode.Strict}
          isValidConnection={isValidConnection}
          snapToGrid
          snapGrid={[GRID, GRID]}
          panOnScroll
          zoomOnPinch
          panOnDrag={[1, 2]}
          selectionOnDrag
          nodesDraggable={!readonly}
          nodesConnectable={!readonly}
          elementsSelectable={!readonly}
        >
          {showMiniMap && (
            <MiniMap
              nodeColor="#9333ea"
              nodeStrokeWidth={2}
              maskColor="rgba(255,255,255,0.6)"
            />
          )}
          <Controls />
          <Background variant="dots" gap={GRID} size={1} />
        </ReactFlow>
      </div>

      {/* üîß CHANGED: Footer actions removed (buttons now live in header) */}

      {/* Fork modal: when published & attached */}
      {forkModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          <div
            className="absolute inset-0 bg-black/40"
            onClick={() => setForkModalOpen(false)}
          />
          <div
            role="dialog"
            aria-modal="true"
            className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
          >
            <div className="flex items-start gap-3 mb-4">
              <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
                ‚ö†Ô∏è
              </div>
              <div>
                <h3 className="text-lg font-semibold text-gray-900">
                  Editing is blocked for this flow
                </h3>
                <p className="text-sm text-gray-600">
                  This flow is <span className="font-medium">published</span>{" "}
                  and attached to active campaign(s). To make changes, create a{" "}
                  <span className="font-medium">new draft version</span>.
                </p>
              </div>
            </div>

            <div className="max-h-60 overflow-auto rounded-lg border divide-y mb-4">
              {lockInfo.campaigns.map(c => (
                <div key={c.id} className="p-3 text-sm">
                  <div className="flex items-center justify-between">
                    <div className="font-semibold text-gray-900">{c.name}</div>
                    <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-700">
                      {c.status || "‚Äî"}
                    </span>
                  </div>
                  <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
                    <div>
                      Created:{" "}
                      <span className="font-medium text-gray-800">
                        {c.createdAt
                          ? new Date(c.createdAt).toLocaleString("en-IN")
                          : "‚Äî"}
                      </span>
                    </div>
                    <div>
                      Created by:{" "}
                      <span className="font-medium text-gray-800">
                        {c.createdBy || "‚Äî"}
                      </span>
                    </div>
                    <div>
                      Scheduled:{" "}
                      <span className="font-medium text-gray-800">
                        {c.scheduledAt
                          ? new Date(c.scheduledAt).toLocaleString("en-IN")
                          : "‚Äî"}
                      </span>
                    </div>
                    <div>
                      First sent:{" "}
                      <span className="font-medium text-gray-800">
                        {c.firstSentAt
                          ? new Date(c.firstSentAt).toLocaleString("en-IN")
                          : "‚Äî"}
                      </span>
                    </div>
                  </div>
                </div>
              ))}
              {lockInfo.campaigns.length === 0 && (
                <div className="p-3 text-sm text-gray-600">
                  Could not load campaign details. You can still create a new
                  draft version.
                </div>
              )}
            </div>

            <div className="flex justify-end gap-2">
              <button
                className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
                onClick={() => setForkModalOpen(false)}
              >
                Close
              </button>
              <button
                onClick={async () => {
                  try {
                    if (!flowId) return;
                    const { flowId: newId } = await forkFlow(flowId);
                    setForkModalOpen(false);
                    toast.success("‚úÖ New draft version created");
                    navigate(
                      `/app/cta-flow/visual-builder?id=${newId}&mode=edit`
                    );
                  } catch (e) {
                    console.error(e);
                    toast.error("‚ùå Failed to create draft copy");
                  }
                }}
                className="px-3 py-2 text-sm rounded bg-purple-600 text-white hover:bg-purple-700"
              >
                Create new draft version
              </button>
            </div>
          </div>
        </div>
      )}

      <TemplatePickerModal
        open={showPicker}
        onClose={() => setShowPicker(false)}
        onSelect={handleTemplateSelect}
      />
    </div>
  );
}

export default function CTAFlowVisualBuilder() {
  return (
    <ReactFlowProvider>
      <CTAFlowVisualBuilderInner />
    </ReactFlowProvider>
  );
}

// // src/pages/CTAFlowVisualBuilder/CTAFlowVisualBuilder.jsx
// import React, {
//   useCallback,
//   useState,
//   useEffect,
//   useMemo,
//   useRef,
// } from "react";
// import {
//   ReactFlow,
//   ReactFlowProvider,
//   Background,
//   Controls,
//   MiniMap,
//   useNodesState,
//   useEdgesState,
//   addEdge,
//   MarkerType,
//   ConnectionMode,
//   useReactFlow,
// } from "@xyflow/react";
// import "@xyflow/react/dist/style.css";
// import { Eye, Minus } from "lucide-react";
// import { useSearchParams, useNavigate } from "react-router-dom";
// import TemplatePickerModal from "./components/TemplatePickerModal";
// import FlowNodeBubble from "./components/FlowNodeBubble";
// import {
//   saveVisualFlow,
//   getVisualFlowById,
//   updateVisualFlow,
//   publishFlow,
//   forkFlow,
//   getFlowUsage,
// } from "./ctaFlowVisualApi";
// import { v4 as uuidv4 } from "uuid";
// import { toast } from "react-toastify";
// import dagre from "dagre";
// import SmartLabeledEdge from "./components/edges/SmartLabeledEdge";

// const GRID = 16;
// const NODE_DEFAULT = { width: 260, height: 140 };

// function CTAFlowVisualBuilderInner() {
//   const [nodes, setNodes, onNodesChange] = useNodesState([]);
//   const [edges, setEdges, onEdgesChange] = useEdgesState([]);
//   const nodesRef = useRef([]);
//   const [showPicker, setShowPicker] = useState(false);
//   const [flowName, setFlowName] = useState("");
//   const flowNameRef = useRef(null);
//   const [showMiniMap, setShowMiniMap] = useState(false);
//   const [readonly, setReadonly] = useState(false);

//   // policy state
//   const [isPublished, setIsPublished] = useState(false);
//   const [republishNeeded, setRepublishNeeded] = useState(false);
//   const [lockInfo, setLockInfo] = useState({ locked: false, campaigns: [] });
//   const [forkModalOpen, setForkModalOpen] = useState(false);

//   // async state
//   const [saving, setSaving] = useState(false);
//   const [loading, setLoading] = useState(false);

//   const [dirty, setDirty] = useState(false);

//   const [searchParams] = useSearchParams();
//   const navigate = useNavigate();
//   const { fitView, zoomIn, zoomOut } = useReactFlow();

//   const mode = searchParams.get("mode"); // 'edit' | 'view' | null
//   const flowId = searchParams.get("id");
//   const visualDebug = true;

//   // figure out source tab for Back button
//   const fromTab = (searchParams.get("from") || "draft").toLowerCase();
//   const backTab = fromTab === "published" ? "published" : "draft";

//   const goBackToManager = useCallback(() => {
//     if (!readonly && dirty) {
//       const ok = window.confirm("You have unsaved changes. Leave this page?");
//       if (!ok) return;
//     }
//     navigate(`/app/cta-flow/flow-manager?tab=${backTab}`);
//   }, [readonly, dirty, backTab, navigate]);

//   useEffect(() => {
//     nodesRef.current = [...nodes];
//   }, [nodes]);

//   // warn on unload if dirty
//   useEffect(() => {
//     const onBeforeUnload = e => {
//       if (!dirty) return;
//       e.preventDefault();
//       e.returnValue = "";
//     };
//     window.addEventListener("beforeunload", onBeforeUnload);
//     return () => window.removeEventListener("beforeunload", onBeforeUnload);
//   }, [dirty]);

//   // --- Node helpers
//   const handleDeleteNode = useCallback(
//     nodeId => {
//       if (readonly) return;
//       setDirty(true);
//       setNodes(nds => nds.filter(n => n.id !== nodeId));
//       setEdges(eds =>
//         eds.filter(e => e.source !== nodeId && e.target !== nodeId)
//       );
//     },
//     [readonly, setNodes, setEdges]
//   );

//   const handleNodeDataChange = useCallback(
//     (nodeId, newData) => {
//       setDirty(true);
//       setNodes(nds =>
//         nds.map(n =>
//           n.id === nodeId ? { ...n, data: { ...n.data, ...newData } } : n
//         )
//       );
//     },
//     [setNodes]
//   );

//   const nodeTypes = useMemo(
//     () => ({
//       customBubble: props => (
//         <FlowNodeBubble
//           {...props}
//           onDelete={handleDeleteNode}
//           onDataChange={newData => handleNodeDataChange(props.id, newData)}
//           readonly={readonly}
//           visualDebug={visualDebug}
//         />
//       ),
//     }),
//     [handleDeleteNode, readonly, visualDebug, handleNodeDataChange]
//   );

//   const edgeTypes = useMemo(() => ({ smart: SmartLabeledEdge }), []);

//   // --- Load / Bootstrap + policy checks
//   useEffect(() => {
//     const load = async () => {
//       setLoading(true);
//       if (mode === "edit" || mode === "view") {
//         try {
//           const data = await getVisualFlowById(flowId);

//           const builtNodes = (data.nodes || []).map((node, index) => ({
//             id: node.id,
//             type: "customBubble",
//             position: {
//               x: node.positionX ?? 120 + index * 120,
//               y: node.positionY ?? 150 + (index % 5) * 60,
//             },
//             data: {
//               templateName: node.templateName,
//               templateType: node.templateType,
//               messageBody: node.messageBody,
//               triggerButtonText: node.triggerButtonText || "",
//               triggerButtonType: node.triggerButtonType || "cta",
//               requiredTag: node.requiredTag || "",
//               requiredSource: node.requiredSource || "",
//               useProfileName: !!node.useProfileName,
//               profileNameSlot:
//                 typeof node.profileNameSlot === "number" &&
//                 node.profileNameSlot > 0
//                   ? node.profileNameSlot
//                   : 1,
//               buttons: (node.buttons || []).map((btn, i) => ({
//                 text: btn.text,
//                 type: btn.type,
//                 subType: btn.subType,
//                 value: btn.value,
//                 targetNodeId: btn.targetNodeId || null,
//                 index: typeof btn.index === "number" ? btn.index : i,
//               })),
//             },
//           }));

//           const builtEdges = (data.edges || []).map(edge => ({
//             id: `e-${edge.fromNodeId}-${edge.toNodeId}-${
//               edge.sourceHandle || "h"
//             }`,
//             source: edge.fromNodeId,
//             target: edge.toNodeId,
//             sourceHandle: edge.sourceHandle || null,
//             type: "smart",
//             animated: true,
//             style: { stroke: "#9333ea" },
//             markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
//             label: edge.sourceHandle || "",
//           }));

//           const nodesWithIncoming = new Set(builtEdges.map(e => e.target));
//           const nodesWithWarnings = builtNodes.map(node => ({
//             ...node,
//             data: {
//               ...node.data,
//               isUnreachable: false,
//               hasNoIncoming: !nodesWithIncoming.has(node.id),
//             },
//           }));

//           setNodes(nodesWithWarnings);
//           setEdges(builtEdges);
//           setFlowName(data.flowName || "Untitled Flow");
//           setIsPublished(!!data.isPublished);
//           setDirty(false);

//           // policy: if editing a published flow, check attachment
//           if (mode === "edit" && data.isPublished) {
//             try {
//               const usage = await getFlowUsage(flowId);
//               if (usage?.campaigns?.length > 0) {
//                 setLockInfo({ locked: true, campaigns: usage.campaigns });
//                 setForkModalOpen(true);
//                 setReadonly(true);
//               } else {
//                 setReadonly(false);
//               }
//             } catch {
//               setLockInfo({ locked: true, campaigns: [] });
//               setForkModalOpen(true);
//               setReadonly(true);
//             }
//           } else {
//             setReadonly(mode === "view");
//           }

//           // initial fit
//           setTimeout(() => fitView({ padding: 0.25 }), 80);
//         } catch {
//           toast.error("‚ùå Failed to load flow");
//         } finally {
//           setLoading(false);
//         }
//       } else {
//         // creating new flow
//         setNodes([]);
//         setEdges([]);
//         setFlowName("Untitled Flow");
//         setIsPublished(false);
//         setReadonly(false);
//         setDirty(false);
//         setLoading(false);
//         setTimeout(() => fitView({ padding: 0.25 }), 80);
//       }
//     };

//     load();
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, [flowId, mode]);

//   // Auto-fit when viewing, and refit on window resize
//   useEffect(() => {
//     if (mode !== "view") return;
//     const t = setTimeout(() => fitView({ padding: 0.25 }), 80);
//     const onResize = () => fitView({ padding: 0.25 });
//     window.addEventListener("resize", onResize);
//     return () => {
//       clearTimeout(t);
//       window.removeEventListener("resize", onResize);
//     };
//   }, [mode, nodes.length, edges.length, fitView]);

//   // --- Add template
//   const handleTemplateSelect = ({ name, type, body, buttons = [] }) => {
//     if (readonly) return;
//     const id = uuidv4();
//     const newNode = {
//       id,
//       position: { x: Math.random() * 400 + 100, y: Math.random() * 300 + 100 },
//       type: "customBubble",
//       data: {
//         templateName: name || "Untitled",
//         templateType: type || "text_template",
//         messageBody: body || "Message body preview...",
//         triggerButtonText: buttons[0]?.text || "",
//         triggerButtonType: "cta",
//         useProfileName: false,
//         profileNameSlot: 1,
//         buttons: buttons.map((btn, idx) => ({
//           text: btn.text || "",
//           type: btn.type || "QUICK_REPLY",
//           subType: btn.subType || "",
//           value: btn.parameterValue || "",
//           targetNodeId: null,
//           index: idx,
//         })),
//       },
//     };
//     setDirty(true);
//     setNodes(nds => [...nds, newNode]);
//     setShowPicker(false);
//     toast.success(
//       `‚úÖ Step added with ${type?.replace("_", " ") || "template"}`
//     );
//     setTimeout(() => fitView({ padding: 0.25 }), 50);
//   };

//   // --- Connection rules
//   const isValidConnection = useCallback(
//     params => {
//       if (!params?.source || !params?.sourceHandle) return false;
//       const duplicate = edges.some(
//         e =>
//           e.source === params.source && e.sourceHandle === params.sourceHandle
//       );
//       return !duplicate;
//     },
//     [edges]
//   );

//   const onConnect = useCallback(
//     params => {
//       if (readonly) return;
//       setDirty(true);
//       const label = params.sourceHandle || "";

//       setEdges(eds =>
//         addEdge(
//           {
//             ...params,
//             id: uuidv4(),
//             type: "smart",
//             animated: true,
//             style: { stroke: "#9333ea" },
//             markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
//             label,
//           },
//           eds
//         )
//       );

//       setNodes(nds =>
//         nds.map(node => {
//           if (node.id !== params.source) return node;
//           const sourceHandle = params.sourceHandle || "";
//           const updatedButtons = [...(node.data.buttons || [])];

//           const idx = updatedButtons.findIndex(
//             b =>
//               (b.text || "").toLowerCase().trim() ===
//               sourceHandle.toLowerCase().trim()
//           );

//           if (idx >= 0) {
//             updatedButtons[idx] = {
//               ...updatedButtons[idx],
//               targetNodeId: params.target,
//             };
//           } else {
//             const free = updatedButtons.findIndex(b => !b.targetNodeId);
//             if (free >= 0)
//               updatedButtons[free] = {
//                 ...updatedButtons[free],
//                 targetNodeId: params.target,
//               };
//           }

//           return { ...node, data: { ...node.data, buttons: updatedButtons } };
//         })
//       );
//     },
//     [readonly, setEdges, setNodes]
//   );

//   // --- Keyboard UX
//   useEffect(() => {
//     const onKey = e => {
//       if (readonly) return;
//       if (e.key === "Delete" || e.key === "Backspace") {
//         setDirty(true);
//         setNodes(nds => nds.filter(n => !n.selected));
//         setEdges(eds => eds.filter(ed => !ed.selected));
//       }
//       if (e.key === "Escape") {
//         setNodes(nds => nds.map(n => ({ ...n, selected: false })));
//         setEdges(eds => eds.map(ed => ({ ...ed, selected: false })));
//       }
//     };
//     window.addEventListener("keydown", onKey);
//     return () => window.removeEventListener("keydown", onKey);
//   }, [readonly, setNodes, setEdges]);

//   // --- Auto layout (dagre)
//   const applyLayout = useCallback(
//     (direction = "LR") => {
//       const g = new dagre.graphlib.Graph();
//       g.setGraph({
//         rankdir: direction,
//         nodesep: 50,
//         ranksep: 90,
//         marginx: 20,
//         marginy: 20,
//       });
//       g.setDefaultEdgeLabel(() => ({}));

//       nodes.forEach(n => {
//         const width = n?.measured?.width || NODE_DEFAULT.width;
//         const height = n?.measured?.height || NODE_DEFAULT.height;
//         g.setNode(n.id, { width, height });
//       });
//       edges.forEach(e => g.setEdge(e.source, e.target));

//       dagre.layout(g);

//       const laidOut = nodes.map(n => {
//         const { x, y } = g.node(n.id);
//         const width = n?.measured?.width || NODE_DEFAULT.width;
//         const height = n?.measured?.height || NODE_DEFAULT.height;
//         return { ...n, position: { x: x - width / 2, y: y - height / 2 } };
//       });

//       setDirty(true);
//       setNodes(laidOut);
//       setTimeout(() => fitView({ padding: 0.25 }), 50);
//     },
//     [nodes, edges, setNodes, fitView]
//   );

//   // --- Build payload (draft by default; publish is separate)
//   const buildPayload = () => {
//     const transformedNodes = nodes
//       .filter(n => n?.data?.templateName)
//       .map(node => ({
//         Id: node.id,
//         TemplateName: node.data.templateName || "Untitled",
//         TemplateType: node.data.templateType || "text_template",
//         MessageBody: node.data.messageBody || "",
//         PositionX: node.position?.x || 0,
//         PositionY: node.position?.y || 0,
//         TriggerButtonText: node.data.triggerButtonText || "",
//         TriggerButtonType: node.data.triggerButtonType || "cta",
//         RequiredTag: node.data.requiredTag || "",
//         RequiredSource: node.data.requiredSource || "",
//         UseProfileName: !!node.data.useProfileName,
//         ProfileNameSlot:
//           typeof node.data.profileNameSlot === "number" &&
//           node.data.profileNameSlot > 0
//             ? node.data.profileNameSlot
//             : 1,
//         Buttons: (node.data.buttons || [])
//           .filter(btn => (btn.text || "").trim().length > 0)
//           .map((btn, idx) => ({
//             Text: (btn.text || "").trim(),
//             Type: btn.type || "QUICK_REPLY",
//             SubType: btn.subType || "",
//             Value: btn.value || "",
//             TargetNodeId: btn.targetNodeId || null,
//             Index: typeof btn.index === "number" ? btn.index : idx,
//           })),
//       }));

//     const transformedEdges = edges.map(edge => ({
//       FromNodeId: edge.source,
//       ToNodeId: edge.target,
//       SourceHandle: edge.sourceHandle || "",
//     }));

//     return {
//       FlowName: flowName || "Untitled",
//       IsPublished: false, // always draft; publish is explicit
//       Nodes: transformedNodes,
//       Edges: transformedEdges,
//     };
//   };

//   // --- Save Draft (then go to Drafts tab)
//   const handleSaveDraft = async () => {
//     try {
//       setSaving(true);
//       const payload = buildPayload();

//       if (mode === "edit" && flowId) {
//         const res = await updateVisualFlow(flowId, payload);
//         if (res?.needsRepublish) setRepublishNeeded(true);
//         toast.success("‚úÖ Flow updated (draft)");
//       } else {
//         const res = await saveVisualFlow(payload); // create new draft
//         if (res?.flowId) {
//           // move the user to manager drafts list
//           navigate(`/app/cta-flow/flow-manager?tab=draft`);
//           return; // stop further state updates in this screen
//         }
//         toast.success("‚úÖ Flow saved (draft)");
//       }
//       setDirty(false);
//       navigate(`/app/cta-flow/flow-manager?tab=draft`);
//     } catch (error) {
//       console.error("‚ùå Save draft failed: ", error);
//       if (error?.response?.status === 409) {
//         const camps = error?.response?.data?.campaigns || [];
//         setLockInfo({ locked: true, campaigns: camps });
//         setForkModalOpen(true);
//         setReadonly(true);
//       } else {
//         toast.error("‚ùå Failed to save draft");
//       }
//     } finally {
//       setSaving(false);
//     }
//   };

//   // --- Publish / Republish (on new ‚Üí create then publish) then go to Published tab
//   const handlePublish = async () => {
//     try {
//       setSaving(true);

//       if (mode === "edit" && flowId) {
//         const payload = buildPayload();
//         await updateVisualFlow(flowId, payload);
//         await publishFlow(flowId);
//         setRepublishNeeded(false);
//         setIsPublished(true);
//         setDirty(false);
//         toast.success("‚úÖ Flow published");
//         navigate("/app/cta-flow/flow-manager?tab=published");
//         return;
//       }

//       // NEW flow: create as draft, get id, then publish that id
//       const createPayload = { ...buildPayload(), IsPublished: false };
//       const res = await saveVisualFlow(createPayload);
//       const newId = res?.flowId;

//       if (newId) {
//         await publishFlow(newId);
//         toast.success("‚úÖ Flow created & published");
//         navigate("/app/cta-flow/flow-manager?tab=published");
//         return;
//       }

//       // fallback
//       toast.success("‚úÖ Flow created (but publish step uncertain)");
//       navigate("/app/cta-flow/flow-manager?tab=published");
//     } catch (error) {
//       console.error("‚ùå Publish failed: ", error);
//       if (error?.response?.status === 409) {
//         const camps = error?.response?.data?.campaigns || [];
//         setLockInfo({ locked: true, campaigns: camps });
//         setForkModalOpen(true);
//         setReadonly(true);
//       } else {
//         toast.error("‚ùå Failed to publish");
//       }
//     } finally {
//       setSaving(false);
//     }
//   };

//   const defaultEdgeOptions = useMemo(
//     () => ({
//       type: "smart",
//       animated: true,
//       style: { stroke: "#9333ea" },
//       markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
//     }),
//     []
//   );

//   return (
//     <div className="p-6 relative">
//       {/* Page-level spinner overlay */}
//       {(loading || saving) && (
//         <div className="absolute inset-0 z-[60] bg-white/70 backdrop-blur-[1px] grid place-items-center">
//           <div className="flex items-center gap-3 px-4 py-2 bg-white rounded-xl shadow border">
//             <svg
//               className="animate-spin h-5 w-5 text-purple-600"
//               viewBox="0 0 24 24"
//             >
//               <circle
//                 className="opacity-25"
//                 cx="12"
//                 cy="12"
//                 r="10"
//                 stroke="currentColor"
//                 strokeWidth="4"
//                 fill="none"
//               />
//               <path
//                 className="opacity-75"
//                 fill="currentColor"
//                 d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
//               />
//             </svg>
//             <span className="text-sm text-gray-700">
//               {loading ? "Loading..." : "Working..."}
//             </span>
//           </div>
//         </div>
//       )}

//       {/* Header */}
//       <div className="flex flex-wrap items-center justify-between gap-3 mb-4">
//         <div className="flex items-center gap-2">
//           <button
//             onClick={goBackToManager}
//             className="bg-white border border-gray-300 text-gray-700 px-3 py-2 rounded-md shadow-sm hover:bg-gray-50 text-sm"
//             title={`Back to ${
//               backTab === "published" ? "Published" : "Drafts"
//             }`}
//           >
//             ‚Üê Back to {backTab === "published" ? "Published" : "Drafts"}
//           </button>

//           <h2 className="text-2xl font-bold text-purple-700 ml-1">
//             üß† CTA Flow Visual Builder
//           </h2>
//         </div>

//         <div className="flex items-center gap-2">
//           {readonly ? (
//             <div className="px-3 py-2 rounded-md bg-purple-50 text-purple-700 text-sm font-medium">
//               {flowName || "Untitled Flow"}
//             </div>
//           ) : (
//             <input
//               id="flowName"
//               name="flowName"
//               ref={flowNameRef}
//               value={flowName}
//               onChange={e => {
//                 setFlowName(e.target.value);
//                 setDirty(true);
//               }}
//               placeholder="Add flow name"
//               className="border border-gray-300 px-3 py-2 rounded-md shadow-sm text-sm"
//             />
//           )}

//           {/* Always available */}
//           <button
//             onClick={() => navigate(`/app/cta-flow/visual-builder`)}
//             className="bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700 text-sm"
//             title="Create a new flow"
//             disabled={saving}
//           >
//             ‚ûï Add New Flow
//           </button>

//           {!readonly && (
//             <>
//               <button
//                 onClick={() => setShowPicker(true)}
//                 className="bg-purple-600 text-white px-4 py-2 rounded shadow hover:bg-purple-700 text-sm"
//                 disabled={saving}
//               >
//                 ‚ûï Add Step
//               </button>
//               <button
//                 onClick={goBackToManager}
//                 className="bg-white border border-purple-600 text-purple-700 font-medium text-sm px-4 py-2 rounded-md shadow-sm hover:bg-purple-50"
//                 disabled={saving}
//               >
//                 ‚Ü©Ô∏è Manage All Flows
//               </button>
//             </>
//           )}
//         </div>
//       </div>

//       {/* Republish banner */}
//       {!readonly && mode === "edit" && republishNeeded && (
//         <div className="mb-3 rounded-md border bg-amber-50 text-amber-800 px-3 py-2 text-sm flex items-center justify-between">
//           <div>
//             Changes saved as <span className="font-semibold">draft</span>. Click{" "}
//             <span className="font-semibold">Republish</span> to make them live.
//           </div>
//           <button
//             onClick={handlePublish}
//             className="px-3 py-1 rounded bg-amber-600 text-white hover:bg-amber-700 text-xs"
//             disabled={saving}
//           >
//             Republish
//           </button>
//         </div>
//       )}

//       {/* Canvas */}
//       <div className="h-[70vh] border rounded-xl bg-gray-50 relative">
//         {/* Minimap + tools */}
//         <div className="absolute bottom-5 right-4 z-50 flex gap-2">
//           <button
//             onClick={() => setShowMiniMap(prev => !prev)}
//             className="bg-purple-600 text-white p-2 rounded-full shadow hover:bg-purple-700"
//             title={showMiniMap ? "Hide MiniMap" : "Show MiniMap"}
//           >
//             {showMiniMap ? <Minus size={15} /> : <Eye size={15} />}
//           </button>

//           <div className="flex items-center gap-2 bg-white/90 px-2 py-1 rounded-full border">
//             <button
//               onClick={() => fitView({ padding: 0.25 })}
//               className="text-xs px-2 py-1 rounded hover:bg-gray-100 font-medium"
//               title="Fit to screen"
//             >
//               Fit
//             </button>
//             <button
//               onClick={() => zoomIn()}
//               className="text-xs px-2 py-1 rounded hover:bg-gray-100"
//               title="Zoom In"
//             >
//               +
//             </button>
//             <button
//               onClick={() => zoomOut()}
//               className="text-xs px-2 py-1 rounded hover:bg-gray-100"
//               title="Zoom Out"
//             >
//               ‚àí
//             </button>

//             {!readonly && (
//               <>
//                 <button
//                   onClick={() => applyLayout("LR")}
//                   className="text-xs px-2 py-1 rounded hover:bg-gray-100"
//                   title="Auto-layout (Left‚ÜíRight)"
//                 >
//                   Auto LR
//                 </button>
//                 <button
//                   onClick={() => applyLayout("TB")}
//                   className="text-xs px-2 py-1 rounded hover:bg-gray-100"
//                   title="Auto-layout (Top‚ÜíBottom)"
//                 >
//                   Auto TB
//                 </button>
//               </>
//             )}
//           </div>
//         </div>

//         <ReactFlow
//           nodes={nodes}
//           edges={edges}
//           onNodesChange={onNodesChange}
//           onEdgesChange={onEdgesChange}
//           onConnect={onConnect}
//           onEdgeClick={(e, edge) => {
//             if (!readonly) {
//               setDirty(true);
//               setEdges(eds => eds.filter(ed => ed.id !== edge.id));
//             }
//           }}
//           nodeTypes={nodeTypes}
//           edgeTypes={edgeTypes}
//           fitView
//           fitViewOptions={{ padding: 0.25 }}
//           defaultEdgeOptions={defaultEdgeOptions}
//           connectionMode={ConnectionMode.Strict}
//           isValidConnection={isValidConnection}
//           snapToGrid
//           snapGrid={[GRID, GRID]}
//           panOnScroll
//           zoomOnPinch
//           panOnDrag={[1, 2]}
//           selectionOnDrag
//           nodesDraggable={!readonly}
//           nodesConnectable={!readonly}
//           elementsSelectable={!readonly}
//         >
//           {showMiniMap && (
//             <MiniMap
//               nodeColor="#9333ea"
//               nodeStrokeWidth={2}
//               maskColor="rgba(255,255,255,0.6)"
//             />
//           )}
//           <Controls />
//           <Background variant="dots" gap={GRID} size={1} />
//         </ReactFlow>
//       </div>

//       {/* Footer actions */}
//       {!readonly && (
//         <div className="mt-6 flex flex-wrap gap-3">
//           <button
//             onClick={handleSaveDraft}
//             className="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 text-sm disabled:opacity-50"
//             disabled={saving}
//           >
//             üíæ Save Draft
//           </button>

//           <button
//             onClick={handlePublish}
//             className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm disabled:opacity-50"
//             disabled={saving}
//           >
//             üöÄ {isPublished ? "Republish" : "Publish Flow"}
//           </button>
//         </div>
//       )}

//       {/* Fork modal: when published & attached */}
//       {forkModalOpen && (
//         <div className="fixed inset-0 z-50 flex items-center justify-center">
//           <div
//             className="absolute inset-0 bg-black/40"
//             onClick={() => setForkModalOpen(false)}
//           />
//           <div
//             role="dialog"
//             aria-modal="true"
//             className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
//           >
//             <div className="flex items-start gap-3 mb-4">
//               <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                 ‚ö†Ô∏è
//               </div>
//               <div>
//                 <h3 className="text-lg font-semibold text-gray-900">
//                   Editing is blocked for this flow
//                 </h3>
//                 <p className="text-sm text-gray-600">
//                   This flow is <span className="font-medium">published</span>{" "}
//                   and attached to active campaign(s). To make changes, create a{" "}
//                   <span className="font-medium">new draft version</span>.
//                 </p>
//               </div>
//             </div>

//             <div className="max-h-60 overflow-auto rounded-lg border divide-y mb-4">
//               {lockInfo.campaigns.map(c => (
//                 <div key={c.id} className="p-3 text-sm">
//                   <div className="flex items-center justify-between">
//                     <div className="font-semibold text-gray-900">{c.name}</div>
//                     <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-700">
//                       {c.status || "‚Äî"}
//                     </span>
//                   </div>
//                   <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
//                     <div>
//                       Created:{" "}
//                       <span className="font-medium text-gray-800">
//                         {c.createdAt
//                           ? new Date(c.createdAt).toLocaleString("en-IN")
//                           : "‚Äî"}
//                       </span>
//                     </div>
//                     <div>
//                       Created by:{" "}
//                       <span className="font-medium text-gray-800">
//                         {c.createdBy || "‚Äî"}
//                       </span>
//                     </div>
//                     <div>
//                       Scheduled:{" "}
//                       <span className="font-medium text-gray-800">
//                         {c.scheduledAt
//                           ? new Date(c.scheduledAt).toLocaleString("en-IN")
//                           : "‚Äî"}
//                       </span>
//                     </div>
//                     <div>
//                       First sent:{" "}
//                       <span className="font-medium text-gray-800">
//                         {c.firstSentAt
//                           ? new Date(c.firstSentAt).toLocaleString("en-IN")
//                           : "‚Äî"}
//                       </span>
//                     </div>
//                   </div>
//                 </div>
//               ))}
//               {lockInfo.campaigns.length === 0 && (
//                 <div className="p-3 text-sm text-gray-600">
//                   Could not load campaign details. You can still create a new
//                   draft version.
//                 </div>
//               )}
//             </div>

//             <div className="flex justify-end gap-2">
//               <button
//                 className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                 onClick={() => setForkModalOpen(false)}
//               >
//                 Close
//               </button>
//               <button
//                 onClick={async () => {
//                   try {
//                     if (!flowId) return;
//                     const { flowId: newId } = await forkFlow(flowId);
//                     setForkModalOpen(false);
//                     toast.success("‚úÖ New draft version created");
//                     navigate(
//                       `/app/cta-flow/visual-builder?id=${newId}&mode=edit`
//                     );
//                   } catch (e) {
//                     console.error(e);
//                     toast.error("‚ùå Failed to create draft copy");
//                   }
//                 }}
//                 className="px-3 py-2 text-sm rounded bg-purple-600 text-white hover:bg-purple-700"
//               >
//                 Create new draft version
//               </button>
//             </div>
//           </div>
//         </div>
//       )}

//       <TemplatePickerModal
//         open={showPicker}
//         onClose={() => setShowPicker(false)}
//         onSelect={handleTemplateSelect}
//       />
//     </div>
//   );
// }

// export default function CTAFlowVisualBuilder() {
//   return (
//     <ReactFlowProvider>
//       <CTAFlowVisualBuilderInner />
//     </ReactFlowProvider>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\CTAFlowVisualBuilder_AllFileDump.txt 
====================================================== 
 
Folder and File Content Report
 
========================================== 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\ExtrackAllFiles.bat 
====================================================== 
 
@echo off
REM This script will find all files and output their name and content into one file.
REM The output file will be named [FolderName]_AllFileDump.txt.

REM Get the current folder's name and set it as the output file name with the custom suffix
for %%I in ("%cd%") do set "outputFile=%%~nI_AllFileDump.txt"

REM Clear the output file to start fresh
> "%outputFile%" (echo Folder and File Content Report)
echo. >> "%outputFile%"

REM Loop through all files in the current directory and subdirectories
for /R . %%F in (*.*) do (
    echo ====================================================== >> "%outputFile%"
    echo FILE: %%F >> "%outputFile%"
    echo ====================================================== >> "%outputFile%"
    echo. >> "%outputFile%"
    type "%%F" >> "%outputFile%" 2>nul
    echo. >> "%outputFile%"
    echo. >> "%outputFile%"
)

echo Finished! All content has been extracted to %outputFile% 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\components\FlowNodeBubble.jsx 
====================================================== 
 
import React, { useEffect, useMemo } from "react";
import { Handle, Position } from "@xyflow/react";
import { X, MessageSquare } from "lucide-react";

const countBodyPlaceholders = body => {
  if (!body) return 0;
  const m = String(body).match(/\{\{\s*\d+\s*\}\}/g);
  return m ? m.length : 0;
};

export default function FlowNodeBubble({
  id,
  data = {},
  onDelete = () => {},
  readonly = false,
  onDataChange = () => {},
  visualDebug = false,
}) {
  const {
    templateName = "Untitled Step",
    templateType = "text_template",
    messageBody = "",
    buttons = [],
    requiredTag = "",
    requiredSource = "",
    isUnreachable = false,

    // greeting fields
    useProfileName = false,
    profileNameSlot = 1,
  } = data;

  const isTextTemplate = (templateType || "").toLowerCase() === "text_template";
  const placeholderCount = useMemo(
    () => countBodyPlaceholders(messageBody),
    [messageBody]
  );
  const canUseProfile = isTextTemplate && placeholderCount > 0;

  // keep trigger info sync'd with first button
  useEffect(() => {
    if (buttons.length > 0) {
      const triggerText = buttons[0]?.text || "";
      onDataChange({
        triggerButtonText: triggerText,
        triggerButtonType: "cta",
      });
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [buttons]);

  // clamp/disable when template/body changes
  useEffect(() => {
    if (!canUseProfile) {
      if (useProfileName || profileNameSlot != null) {
        onDataChange({ useProfileName: false, profileNameSlot: undefined });
      }
    } else if (useProfileName) {
      const clamped = Math.max(
        1,
        Math.min(profileNameSlot ?? 1, placeholderCount)
      );
      if (clamped !== (profileNameSlot ?? 1)) {
        onDataChange({ profileNameSlot: clamped });
      }
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [canUseProfile, placeholderCount]);

  return (
    <div className="bg-white shadow-md rounded-xl border border-purple-200 w-72 p-4 relative">
      {!readonly && (
        <button
          onClick={() => onDelete(id)}
          className="absolute top-1.5 right-1.5 text-red-500 hover:text-red-700"
          title="Delete this step"
          aria-label="Delete step"
        >
          <X size={16} />
        </button>
      )}

      {isUnreachable && (
        <div
          className="text-xs text-red-600 bg-red-100 px-2 py-0.5 rounded-full font-semibold mb-2 inline-block"
          title="This step has no incoming trigger. It may never run."
        >
          ‚ö†Ô∏è Unreachable Step
        </div>
      )}

      <div className="mb-2">
        <div className="flex items-center gap-2 pb-2 border-b border-gray-200">
          <MessageSquare size={16} className="text-purple-600 shrink-0" />
          <div
            className="min-w-0 truncate text-sm font-medium text-gray-900"
            title={templateName}
          >
            {templateName}
          </div>
        </div>
      </div>

      <div
        className="text-sm text-gray-700 whitespace-pre-wrap mb-3 overflow-y-auto"
        style={{ maxHeight: 180, overscrollBehavior: "contain" }}
        title={messageBody}
      >
        üí¨ {messageBody || "Message body preview..."}
      </div>

      <div className="flex flex-wrap gap-2 mb-2">
        {!!requiredTag && (
          <span className="bg-yellow-100 text-yellow-800 text-[10px] px-2 py-0.5 rounded-full font-semibold">
            üéØ Tag: {requiredTag}
          </span>
        )}
        {!!requiredSource && (
          <span className="bg-purple-100 text-purple-800 text-[10px] px-2 py-0.5 rounded-full font-semibold">
            üîó Source: {requiredSource}
          </span>
        )}
        {useProfileName && canUseProfile && (
          <span className="bg-green-100 text-green-800 text-[10px] px-2 py-0.5 rounded-full font-semibold">
            {/* render e.g. {{1}} safely as a string */}
            üë§ Profile ‚Üí {`{{${profileNameSlot}}}`}
          </span>
        )}
      </div>

      {canUseProfile && (
        <div className="mt-3 border-t pt-3">
          <div className="flex items-center justify-between">
            <label className="text-xs font-medium">
              Use WhatsApp Profile Name
            </label>
            <input
              type="checkbox"
              disabled={readonly}
              checked={!!useProfileName}
              onChange={e => {
                const checked = e.target.checked;
                if (!checked) {
                  onDataChange({
                    useProfileName: false,
                    profileNameSlot: undefined,
                  });
                } else {
                  const clamped = Math.max(
                    1,
                    Math.min(profileNameSlot ?? 1, placeholderCount)
                  );
                  onDataChange({
                    useProfileName: true,
                    profileNameSlot: clamped,
                  });
                }
              }}
            />
          </div>

          {useProfileName && (
            <div className="mt-2">
              <label className="text-xs block mb-1">Slot ({"{{n}}"})</label>
              <select
                className="w-full border rounded px-2 py-1 text-sm"
                disabled={readonly}
                value={profileNameSlot ?? 1}
                onChange={e => {
                  const n = parseInt(e.target.value, 10) || 1;
                  onDataChange({
                    profileNameSlot: Math.max(1, Math.min(n, placeholderCount)),
                  });
                }}
              >
                {Array.from(
                  { length: Math.max(placeholderCount, 1) },
                  (_, i) => i + 1
                ).map(n => (
                  <option key={n} value={n}>
                    {`{{${n}}}`}
                  </option>
                ))}
              </select>
            </div>
          )}
        </div>
      )}

      <div className="flex flex-col gap-2">
        {buttons.map((btn, index) => {
          const text = (btn.text || "").trim() || `Button ${index + 1}`;
          return (
            <div
              key={`${text}-${index}`}
              className="relative bg-purple-100 text-purple-800 text-xs px-3 py-1 rounded shadow-sm"
              title={text}
            >
              <div className="pr-6 text-center select-none">üîò {text}</div>
              <Handle
                type="source"
                position={Position.Right}
                id={text}
                title={`Drag to connect: ${text}`}
                aria-label={`Connect from ${text}`}
                style={{
                  background: "#9333ea",
                  right: "-10px",
                  top: "50%",
                  transform: "translateY(-50%)",
                  width: 16,
                  height: 16,
                  border: "2px solid #fff",
                  borderRadius: 9999,
                  boxShadow: "0 0 0 2px rgba(147,51,234,0.25)",
                  cursor: "crosshair",
                }}
              />
              <div
                style={{
                  position: "absolute",
                  right: -18,
                  top: "50%",
                  transform: "translateY(-50%)",
                  width: 36,
                  height: 28,
                  background: "transparent",
                  pointerEvents: "none",
                }}
              />
            </div>
          );
        })}
      </div>

      {buttons.length === 0 && (
        <Handle
          type="source"
          position={Position.Bottom}
          id="default"
          title="Drag to connect"
          style={{
            background: "#9333ea",
            width: 16,
            height: 16,
            border: "2px solid #fff",
            borderRadius: 9999,
            boxShadow: "0 0 0 2px rgba(147,51,234,0.25)",
          }}
        />
      )}

      <Handle
        type="target"
        position={Position.Top}
        id="incoming"
        title="Drop a connection here"
        style={{
          background: "#9333ea",
          width: 16,
          height: 16,
          border: "2px solid #fff",
          borderRadius: 9999,
          boxShadow: "0 0 0 2px rgba(147,51,234,0.25)",
        }}
      />
    </div>
  );
}

// import React, { useEffect } from "react";
// import { Handle, Position } from "@xyflow/react";
// import { X, MessageSquare } from "lucide-react";

// export default function FlowNodeBubble({
//   id,
//   data,
//   onDelete,
//   readonly,
//   onDataChange,
//   visualDebug = false, // not rendered
// }) {
//   const {
//     templateName,
//     messageBody,
//     buttons = [],
//     requiredTag,
//     requiredSource,
//     isUnreachable,
//   } = data;

//   // Keep trigger info in sync with first button
//   useEffect(() => {
//     if (buttons.length > 0 && onDataChange) {
//       const triggerText = buttons[0]?.text || "";
//       onDataChange({
//         ...data,
//         triggerButtonText: triggerText,
//         triggerButtonType: "cta",
//       });
//     }
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, [buttons]);

//   return (
//     <div className="bg-white shadow-md rounded-xl border border-purple-200 w-72 p-4 relative">
//       {/* ‚ùå Delete */}
//       {!readonly && (
//         <button
//           onClick={() => onDelete(id)}
//           className="absolute top-1.5 right-1.5 text-red-500 hover:text-red-700"
//           title="Delete this step"
//           aria-label="Delete step"
//         >
//           <X size={16} />
//         </button>
//       )}

//       {/* ‚ö†Ô∏è Warning */}
//       {isUnreachable && (
//         <div
//           className="text-xs text-red-600 bg-red-100 px-2 py-0.5 rounded-full font-semibold mb-2 inline-block"
//           title="This step has no incoming trigger. It may never run."
//         >
//           ‚ö†Ô∏è Unreachable Step
//         </div>
//       )}

//       {/* Header ‚Äî minimal (icon + name) with divider */}
//       <div className="mb-2">
//         <div className="flex items-center gap-2 pb-2 border-b border-gray-200">
//           <MessageSquare
//             size={16}
//             className="text-purple-600 shrink-0"
//             aria-hidden
//           />
//           <div
//             className="min-w-0 truncate text-sm font-medium text-gray-900"
//             title={templateName || "Untitled Step"}
//           >
//             {templateName || "Untitled Step"}
//           </div>
//         </div>
//       </div>

//       {/* üí¨ Body ‚Äî scrollable to avoid crowding */}
//       <div
//         className="text-sm text-gray-700 whitespace-pre-wrap mb-3 overflow-y-auto"
//         style={{
//           maxHeight: 180, // control the vertical footprint
//           overscrollBehavior: "contain",
//           scrollbarWidth: "thin", // Firefox
//           WebkitOverflowScrolling: "touch", // iOS momentum
//         }}
//         title={messageBody}
//       >
//         üí¨ {messageBody || "Message body preview..."}
//       </div>

//       {/* üéØ Badges */}
//       <div className="flex flex-wrap gap-2 mb-2">
//         {!!requiredTag && (
//           <span
//             className="bg-yellow-100 text-yellow-800 text-[10px] px-2 py-0.5 rounded-full font-semibold"
//             title={`Only contacts with tag "${requiredTag}" will receive this step.`}
//           >
//             üéØ Tag: {requiredTag}
//           </span>
//         )}
//         {!!requiredSource && (
//           <span
//             className="bg-purple-100 text-purple-800 text-[10px] px-2 py-0.5 rounded-full font-semibold"
//             title={`This step runs only if Source = "${requiredSource}"`}
//           >
//             üîó Source: {requiredSource}
//           </span>
//         )}
//       </div>

//       {/* üîò Buttons + source handles (no connection status UI) */}
//       <div className="flex flex-col gap-2">
//         {buttons.map((btn, index) => {
//           const text = (btn.text || "").trim() || `Button ${index + 1}`;
//           return (
//             <div
//               key={`${text}-${index}`}
//               className="relative bg-purple-100 text-purple-800 text-xs px-3 py-1 rounded shadow-sm"
//               title={text}
//             >
//               <div className="pr-6 text-center select-none">üîò {text}</div>

//               {/* Right source handle (enlarged hit area) */}
//               <Handle
//                 type="source"
//                 position={Position.Right}
//                 id={text} // keep equal to button text for mapping
//                 title={`Drag to connect: ${text}`}
//                 aria-label={`Connect from ${text}`}
//                 style={{
//                   background: "#9333ea",
//                   right: "-10px",
//                   top: "50%",
//                   transform: "translateY(-50%)",
//                   width: 16,
//                   height: 16,
//                   border: "2px solid #fff",
//                   borderRadius: 9999,
//                   boxShadow: "0 0 0 2px rgba(147,51,234,0.25)",
//                   cursor: "crosshair",
//                 }}
//               />
//               {/* Invisible larger hotspot to make grabbing easier */}
//               <div
//                 style={{
//                   position: "absolute",
//                   right: -18,
//                   top: "50%",
//                   transform: "translateY(-50%)",
//                   width: 36,
//                   height: 28,
//                   background: "transparent",
//                   pointerEvents: "none",
//                 }}
//               />
//             </div>
//           );
//         })}
//       </div>

//       {/* üü£ Fallback source if no buttons */}
//       {buttons.length === 0 && (
//         <Handle
//           type="source"
//           position={Position.Bottom}
//           id="default"
//           title="Drag to connect"
//           style={{
//             background: "#9333ea",
//             width: 16,
//             height: 16,
//             border: "2px solid #fff",
//             borderRadius: 9999,
//             boxShadow: "0 0 0 2px rgba(147,51,234,0.25)",
//           }}
//         />
//       )}

//       {/* üîµ Incoming target */}
//       <Handle
//         type="target"
//         position={Position.Top}
//         id="incoming"
//         title="Drop a connection here"
//         style={{
//           background: "#9333ea",
//           width: 16,
//           height: 16,
//           border: "2px solid #fff",
//           borderRadius: 9999,
//           boxShadow: "0 0 0 2px rgba(147,51,234,0.25)",
//         }}
//       />
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\components\TemplatePickerModal.jsx 
====================================================== 
 
// üìÑ File: TemplatePickerModal.jsx
import React, { useEffect, useState } from "react";
import axiosClient from "../../../api/axiosClient";
import { toast } from "react-toastify";

export default function TemplatePickerModal({ open, onClose, onSelect }) {
  const [templates, setTemplates] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!open) return;

    const fetchTemplates = async () => {
      setLoading(true);
      try {
        const res = await axiosClient.get(
          "/WhatsAppTemplateFetcher/get-template-all"
        );
        if (res.data.success) {
          const validTemplates = (res.data.templates || []).filter(
            t => !!t.name
          );
          setTemplates(validTemplates);
          if (validTemplates.length === 0)
            toast.warn("‚ö†Ô∏è No valid templates found");
        } else {
          toast.error("‚ùå Failed to load templates");
        }
      } catch (err) {
        console.error("‚ùå Error fetching templates:", err);
        toast.error("‚ùå Error fetching templates");
      } finally {
        setLoading(false);
      }
    };

    fetchTemplates();
  }, [open]);

  if (!open) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center">
      <div className="bg-white w-full max-w-xl rounded-xl shadow-lg p-6 overflow-y-auto max-h-[90vh]">
        <h2 className="text-xl font-semibold text-purple-700 mb-4">
          üì¶ Select WhatsApp Template
        </h2>

        {loading ? (
          <p>Loading templates...</p>
        ) : templates.length === 0 ? (
          <p className="text-gray-500">No templates available</p>
        ) : (
          <div className="space-y-4">
            {templates.map((tpl, idx) => {
              const hasImageHeader =
                Array.isArray(tpl.components) &&
                tpl.components.some(
                  c => c.type === "HEADER" && c.format === "IMAGE"
                );

              const templateType = hasImageHeader
                ? "image_template"
                : "text_template";

              return (
                <div
                  key={idx}
                  className="border p-4 rounded cursor-pointer hover:bg-gray-50"
                  onClick={() =>
                    onSelect({
                      name: tpl.name,
                      type: templateType,
                      body: tpl.body,
                      buttons: tpl.buttonParams || [],
                    })
                  }
                >
                  <div className="font-bold text-purple-600">{tpl.name}</div>
                  <div className="text-sm text-gray-700 mt-1 whitespace-pre-wrap">
                    {tpl.body}
                  </div>
                  {tpl.buttonParams?.length > 0 && (
                    <div className="mt-2 flex gap-2 flex-wrap">
                      {tpl.buttonParams.map((btn, i) => (
                        <span
                          key={i}
                          className="bg-purple-100 text-purple-800 text-xs px-3 py-1 rounded-full"
                        >
                          {btn.text}
                        </span>
                      ))}
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        )}

        <div className="mt-6 text-right">
          <button
            onClick={onClose}
            className="text-sm px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\components\edges\SmartLabeledEdge.jsx 
====================================================== 
 
import React from "react";
import {
  BaseEdge,
  EdgeLabelRenderer,
  getSmoothStepPath,
  MarkerType,
} from "@xyflow/react";

/**
 * SmartLabeledEdge
 * - Shows button text as label
 * - If nodes are horizontally close and label is long, it renders the label vertically
 * - Supports selection and your purple style
 *
 * Optional: props.data?.labelVertical = true forces vertical label
 */
export default function SmartLabeledEdge(props) {
  const {
    id,
    sourceX,
    sourceY,
    targetX,
    targetY,
    sourcePosition,
    targetPosition,
    style,
    markerEnd = { type: MarkerType.ArrowClosed, color: "#9333ea" },
    label,
    selected,
    data,
  } = props;

  const [edgePath, labelX, labelY] = getSmoothStepPath({
    sourceX,
    sourceY,
    targetX,
    targetY,
    sourcePosition,
    targetPosition,
  });

  // Heuristic: long label + nodes are close horizontally => use vertical
  const dx = Math.abs(targetX - sourceX);
  const longLabel = String(label || "").length > 12;
  const vertical = data?.labelVertical ?? (longLabel && dx < 220);

  return (
    <>
      <BaseEdge
        id={id}
        path={edgePath}
        markerEnd={markerEnd}
        style={{ stroke: "#9333ea", strokeWidth: selected ? 2 : 1.5, ...style }}
      />

      {label && (
        <EdgeLabelRenderer>
          <div
            style={{
              position: "absolute",
              transform: `translate(-50%, -50%) translate(${labelX}px, ${labelY}px)`,
              pointerEvents: "all",
            }}
          >
            <div
              title={label}
              style={{
                // vertical when needed
                writingMode: vertical ? "vertical-rl" : "horizontal-tb",
                textOrientation: vertical ? "mixed" : "upright",

                background: "#fff",
                padding: "4px 6px",
                borderRadius: 6,
                border: "1px solid #e5e7eb",
                fontSize: 10,
                color: "#374151",
                lineHeight: 1.1,
                maxHeight: vertical ? 140 : "none",
                maxWidth: vertical ? 18 : 180,
                overflow: "hidden",
                textOverflow: "ellipsis",
                whiteSpace: vertical ? "normal" : "nowrap",
                boxShadow: "0 1px 2px rgba(0,0,0,0.06)",
              }}
            >
              {label}
            </div>
          </div>
        </EdgeLabelRenderer>
      )}
    </>
  );
}
 
 
