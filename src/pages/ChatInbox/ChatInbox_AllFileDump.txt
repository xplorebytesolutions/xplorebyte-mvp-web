Folder and File Content Report
Root folder: D:\xbytechat\xbytechat-ui\src\pages\ChatInbox
Generated at: 07-12-2025 19:12:10.80
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\ChatInbox\ChatInbox.jsx 
====================================================== 
 
// ðŸ“„ File: src/pages/ChatInbox.jsx

import React, {
  useState,
  useMemo,
  useCallback,
  useEffect,
  useRef,
} from "react";
import {
  Phone,
  Filter,
  Search,
  Clock,
  CheckCircle2,
  MessageCircle,
  Mail,
  User,
  ChevronDown,
  ChevronRight,
  Check,
  CheckCheck,
  AlertCircle,
  Tag,
  Bell,
  Activity,
  StickyNote,
  ExternalLink,
} from "lucide-react";
import { useNavigate } from "react-router-dom";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";
import axios from "axios";

// ðŸ”¢ Mock WhatsApp numbers (real API wiring can come later)
const MOCK_NUMBERS = [
  { id: "all", label: "All numbers" },
  { id: "wa-1", label: "+91 98765 43210" },
  { id: "wa-2", label: "+91 99887 77665" },
];

// ðŸ§  Tabs for the inbox
const TABS = [
  { id: "live", label: "Live (24h)" },
  { id: "history", label: "Older" },
  { id: "unassigned", label: "Unassigned" },
  { id: "my", label: "My Chats" },
];

// Local helper: format dates nicely
function formatDateTime(value) {
  if (!value) return "-";
  const d = new Date(value);
  if (Number.isNaN(d.getTime())) return String(value);
  return d.toLocaleString();
}

// Local helper: first letter avatar
function getInitial(name, phone) {
  const src = name || phone || "?";
  return src.trim()[0]?.toUpperCase() ?? "?";
}

// ðŸ—“ Day label for separators (Today / Yesterday / 12 Dec 2025)
function formatDayLabel(date) {
  if (!date || Number.isNaN(date.getTime())) return "";
  const today = new Date();
  const todayKey = today.toDateString();

  const yesterday = new Date();
  yesterday.setDate(today.getDate() - 1);
  const yesterdayKey = yesterday.toDateString();

  const key = date.toDateString();

  if (key === todayKey) return "Today";
  if (key === yesterdayKey) return "Yesterday";

  return date.toLocaleDateString(undefined, {
    day: "2-digit",
    month: "short",
    year: "numeric",
  });
}

// âœ… Map message status â†’ icon
function StatusIcon({ status }) {
  if (!status) return null;
  const s = String(status).toLowerCase();

  if (s === "failed" || s === "error") {
    return (
      <span className="inline-flex items-center text-[10px] text-rose-200">
        <AlertCircle className="w-3 h-3 mr-0.5" />
      </span>
    );
  }

  if (s === "read" || s === "seen" || s === "viewed") {
    return (
      <span className="inline-flex items-center text-[10px] text-emerald-200">
        <CheckCheck className="w-3 h-3 mr-0.5" />
      </span>
    );
  }

  if (s === "delivered") {
    return (
      <span className="inline-flex items-center text-[10px] text-slate-200">
        <CheckCheck className="w-3 h-3 mr-0.5" />
      </span>
    );
  }

  if (s === "sent" || s === "sending" || s === "queued") {
    return (
      <span className="inline-flex items-center text-[10px] text-slate-200">
        <Check className="w-3 h-3 mr-0.5" />
      </span>
    );
  }

  return null;
}

// ðŸ”¹ Quick Tag modal for Inbox â€“ adds ONE new tag to the current contact
function InboxAddTagModal({
  isOpen,
  onClose,
  contactId,
  currentTags,
  onTagAdded,
}) {
  const [availableTags, setAvailableTags] = React.useState([]);
  const [selectedTagId, setSelectedTagId] = React.useState("");
  const [loadingTags, setLoadingTags] = React.useState(false);
  const [saving, setSaving] = React.useState(false);

  // Load all tags when modal opens
  React.useEffect(() => {
    if (!isOpen) return;

    const fetchTags = async () => {
      try {
        setLoadingTags(true);
        const response = await axiosClient.get("/tags");
        const allTags = response.data?.data || response.data || [];

        // Remove tags that this contact already has
        const existingIds = new Set(
          (currentTags || []).map(t => t.id || t.tagId)
        );
        const filtered = allTags.filter(t => !existingIds.has(t.id));

        setAvailableTags(filtered);
        setSelectedTagId(filtered.length > 0 ? filtered[0].id : "");
      } catch (error) {
        console.error("Failed to load tags for Inbox:", error);
        toast.error("Failed to load tags");
      } finally {
        setLoadingTags(false);
      }
    };

    fetchTags();
  }, [isOpen, currentTags]);

  const handleSubmit = async e => {
    e.preventDefault();

    if (!selectedTagId) {
      toast.warn("Select a tag to add.");
      return;
    }
    if (!contactId) {
      toast.error("No contact selected.");
      return;
    }

    try {
      setSaving(true);

      // Reuse existing bulk assign endpoint from CRM
      await axiosClient.post("/contacts/bulk-assign-tag", {
        contactIds: [contactId],
        tagId: selectedTagId,
      });

      toast.success("Tag added to this contact");
      onTagAdded && onTagAdded();
      onClose();
    } catch (error) {
      console.error("Failed to assign tag from Inbox:", error);
      const message = error.response?.data?.message || "Failed to assign tag";
      toast.error(message);
    } finally {
      setSaving(false);
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-40 flex items-center justify-center bg-black/40">
      <div className="w-full max-w-sm rounded-2xl bg-white p-5 shadow-xl">
        <h2 className="mb-3 text-sm font-semibold text-slate-900">
          Add tag to this contact
        </h2>

        {loadingTags ? (
          <p className="text-xs text-slate-500">Loading tagsâ€¦</p>
        ) : availableTags.length === 0 ? (
          <p className="text-xs text-slate-500">
            No new tags available. Create tags in the CRM workspace first, or
            this contact already has all tags.
          </p>
        ) : (
          <form onSubmit={handleSubmit} className="space-y-4">
            <div>
              <label className="mb-1 block text-xs font-medium text-slate-600">
                Select tag
              </label>
              <select
                className="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500"
                value={selectedTagId}
                onChange={e => setSelectedTagId(e.target.value)}
                disabled={saving}
              >
                {availableTags.map(tag => (
                  <option key={tag.id} value={tag.id}>
                    {tag.name || tag.tagName || "Tag"}
                  </option>
                ))}
              </select>
            </div>

            <div className="flex justify-end gap-2 pt-1">
              <button
                type="button"
                onClick={onClose}
                disabled={saving}
                className="rounded-lg border border-slate-200 px-3 py-1.5 text-xs font-medium text-slate-700 hover:bg-slate-50"
              >
                Cancel
              </button>
              <button
                type="submit"
                disabled={saving || availableTags.length === 0}
                className="rounded-lg bg-purple-600 px-4 py-1.5 text-xs font-semibold text-white hover:bg-purple-700 disabled:opacity-60"
              >
                {saving ? "Addingâ€¦" : "Add tag"}
              </button>
            </div>
          </form>
        )}
      </div>
    </div>
  );
}

export default function ChatInbox() {
  const navigate = useNavigate();

  // ðŸ”¹ Filters & selection
  const [activeTab, setActiveTab] = useState("live");
  const [selectedNumberId, setSelectedNumberId] = useState("all");
  const [searchTerm, setSearchTerm] = useState("");

  // ðŸ”¹ Data from backend
  const [allConversations, setAllConversations] = useState([]);
  const [isLoading, setIsLoading] = useState(false);

  // ðŸ”¹ Selected conversation & message input
  const [selectedConversationId, setSelectedConversationId] = useState(null);
  const [newMessage, setNewMessage] = useState("");

  // ðŸ”¹ Messages for selected conversation
  const [messages, setMessages] = useState([]);
  const [isMessagesLoading, setIsMessagesLoading] = useState(false);

  // ðŸ”¹ Sending & assignment state
  const [isSending, setIsSending] = useState(false);
  const [isAssigning, setIsAssigning] = useState(false);

  // ðŸ”¹ CRM summary for right panel
  const [contactSummary, setContactSummary] = useState(null);
  const [isSummaryLoading, setIsSummaryLoading] = useState(false);

  // ðŸ”¹ Quick CRM actions (notes + reminders)
  const [noteDraft, setNoteDraft] = useState("");
  const [isSavingNote, setIsSavingNote] = useState(false);

  const [reminderTitle, setReminderTitle] = useState("");
  const [reminderDueAt, setReminderDueAt] = useState("");
  const [reminderDescription, setReminderDescription] = useState("");
  const [isSavingReminder, setIsSavingReminder] = useState(false);

  // ðŸ”¹ Tag modal state
  const [isTagModalOpen, setIsTagModalOpen] = useState(false);

  // Right panel toggles
  const [showRightPanel, setShowRightPanel] = useState(true);
  const [showDetails, setShowDetails] = useState(true);
  const [showCrmPanel, setShowCrmPanel] = useState(true);

  // ðŸ”½ Auto-scroll anchor for chat messages
  const messagesEndRef = useRef(null);

  const scrollToBottom = useCallback(() => {
    if (messagesEndRef.current) {
      messagesEndRef.current.scrollIntoView({
        behavior: "smooth",
        block: "end",
      });
    }
  }, []);

  const currentUserId = useMemo(() => localStorage.getItem("userId"), []);

  // ðŸ§® Selected conversation
  const selectedConversation = useMemo(
    () => allConversations.find(c => c.id === selectedConversationId) || null,
    [allConversations, selectedConversationId]
  );

  // Stable contactId for effects
  const selectedContactId = useMemo(
    () => selectedConversation?.contactId || null,
    [selectedConversation]
  );

  // ðŸ§® 24h window flag
  const isWithin24h = selectedConversation?.within24h ?? false;

  // ðŸ§® Assignment flags for header
  const headerIsAssigned = !!selectedConversation?.assignedToUserId;
  const headerIsAssignedToMe =
    !!selectedConversation?.isAssignedToMe ||
    (!!selectedConversation?.assignedToUserId &&
      currentUserId &&
      selectedConversation.assignedToUserId === currentUserId);
  const headerAssignedName = headerIsAssignedToMe
    ? "You"
    : selectedConversation?.assignedToUserName || "Agent";

  // ðŸ§® Filter + sort conversations
  const filteredConversations = useMemo(() => {
    let list = [...allConversations];

    if (selectedNumberId !== "all") {
      list = list.filter(c => c.numberId === selectedNumberId);
    }

    if (searchTerm.trim()) {
      const q = searchTerm.trim().toLowerCase();
      list = list.filter(
        c =>
          c.contactName?.toLowerCase().includes(q) ||
          c.contactPhone?.toLowerCase().includes(q) ||
          c.lastMessagePreview?.toLowerCase().includes(q)
      );
    }

    if (activeTab === "live") {
      list = list.filter(c => c.within24h);
    } else if (activeTab === "unassigned") {
      list = list.filter(c => !c.assignedToUserId);
    } else if (activeTab === "my") {
      if (currentUserId) {
        list = list.filter(c => c.assignedToUserId === currentUserId);
      }
    }

    // ðŸ”½ Sort: unread first, then most recent lastMessageAt
    list.sort((a, b) => {
      const aUnread = a.unreadCount > 0;
      const bUnread = b.unreadCount > 0;

      if (aUnread && !bUnread) return -1;
      if (!aUnread && bUnread) return 1;

      const aTime = a.lastMessageAt ? new Date(a.lastMessageAt).getTime() : 0;
      const bTime = b.lastMessageAt ? new Date(b.lastMessageAt).getTime() : 0;

      return bTime - aTime; // newest first
    });

    return list;
  }, [
    allConversations,
    activeTab,
    selectedNumberId,
    searchTerm,
    currentUserId,
  ]);

  // ðŸ›° Load conversations (supports "silent" refresh)
  const fetchConversations = useCallback(
    async (options = {}) => {
      const { limit, silent } = options;

      try {
        if (!silent) {
          setIsLoading(true);
        }

        const businessId = localStorage.getItem("businessId");

        if (!businessId) {
          toast.error(
            "âŒ Missing business context. Please login again to load inbox."
          );
          if (!silent) {
            setIsLoading(false);
          }
          return;
        }

        const params = {
          businessId,
          currentUserId,
          tab: activeTab,
          numberId:
            selectedNumberId && selectedNumberId !== "all"
              ? selectedNumberId
              : undefined,
          search: searchTerm || undefined,
          limit: limit ?? 100,
        };

        const res = await axiosClient.get("/chat-inbox/conversations", {
          params,
        });

        const apiItems = Array.isArray(res.data) ? res.data : [];

        const mapped = apiItems.map(item => ({
          id: item.id,
          contactId: item.contactId,
          contactName: item.contactName,
          contactPhone: item.contactPhone,
          lastMessagePreview: item.lastMessagePreview,
          lastMessageAt: item.lastMessageAt,
          unreadCount: item.unreadCount || 0,
          status: item.status || "Open",
          numberId: item.numberId,
          numberLabel: item.numberLabel,
          within24h: !!item.within24h,
          assignedToUserId: item.assignedToUserId || null,
          assignedToUserName: item.assignedToUserName || null,
          isAssignedToMe: !!item.isAssignedToMe,
          sourceType: item.sourceType || "WhatsApp",
          sourceName: item.sourceName || "WhatsApp",
          mode: item.mode || "Live",
          firstSeenAt: item.firstSeenAt,
          lastInboundAt: item.lastInboundAt,
          lastOutboundAt: item.lastOutboundAt,
        }));

        setAllConversations(mapped);

        if (!selectedConversationId && mapped.length > 0) {
          setSelectedConversationId(mapped[0].id);
        }
      } catch (error) {
        console.error("âŒ Failed to load inbox conversations:", error);
        const message =
          error.response?.data?.message ||
          "Failed to load inbox conversations.";
        toast.error(message);
      } finally {
        if (!options.silent) {
          setIsLoading(false);
        }
      }
    },
    [
      activeTab,
      selectedNumberId,
      searchTerm,
      selectedConversationId,
      currentUserId,
    ]
  );

  // Initial + filter-based load
  useEffect(() => {
    fetchConversations();
  }, [activeTab, selectedNumberId, searchTerm, fetchConversations]);

  // ðŸ” Auto-refresh conversations every 25 seconds (silent, no flicker)
  useEffect(() => {
    const intervalId = setInterval(() => {
      fetchConversations({ silent: true, limit: 100 });
    }, 25000);

    return () => clearInterval(intervalId);
  }, [fetchConversations]);

  // ðŸ›° Load messages for selected conversation
  useEffect(() => {
    const loadMessages = async () => {
      if (!selectedConversationId) {
        setMessages([]);
        return;
      }

      const conv = allConversations.find(c => c.id === selectedConversationId);
      if (!conv) {
        setMessages([]);
        return;
      }

      const businessId = localStorage.getItem("businessId");
      if (!businessId) {
        toast.error(
          "âŒ Missing business context. Please login again to load messages."
        );
        return;
      }

      try {
        setIsMessagesLoading(true);

        const res = await axiosClient.get("/chat-inbox/messages", {
          params: {
            businessId,
            contactPhone: conv.contactPhone,
            limit: 100,
          },
        });

        const apiItems = Array.isArray(res.data) ? res.data : [];

        const mapped = apiItems
          .map(m => {
            const directionRaw =
              m.direction ?? m.Direction ?? m.dir ?? m.messageDirection ?? "";
            const statusRaw = m.status ?? "";

            const dir = String(directionRaw).toLowerCase();
            const status = String(statusRaw).toLowerCase();

            let inferredIsInbound =
              typeof m.isInbound === "boolean" ? m.isInbound : false;

            if (typeof m.isInbound !== "boolean") {
              inferredIsInbound =
                dir === "inbound" ||
                dir === "in" ||
                dir === "incoming" ||
                dir === "received" ||
                dir === "customer" ||
                dir === "from" ||
                status === "received" ||
                status === "incoming";
            }

            return {
              id: m.id,
              direction: directionRaw || (inferredIsInbound ? "in" : "out"),
              isInbound: inferredIsInbound,
              text: m.text || "",
              sentAt: m.sentAtUtc || m.sentAt,
              status: m.status,
              errorMessage: m.errorMessage,
            };
          })
          .reverse();

        setMessages(mapped);
      } catch (error) {
        console.error("âŒ Failed to load messages:", error);
        const message =
          error.response?.data?.message || "Failed to load messages.";
        toast.error(message);
        setMessages([]);
      } finally {
        setIsMessagesLoading(false);
      }
    };

    loadMessages();
  }, [selectedConversationId, allConversations]);

  // ðŸ”” Mark as read when opening a conversation
  useEffect(() => {
    if (!selectedConversationId) return;

    const conv = allConversations.find(c => c.id === selectedConversationId);
    if (!conv || !conv.contactId) return;

    const businessId = localStorage.getItem("businessId");
    const userId = localStorage.getItem("userId");

    if (!businessId || !userId) return;

    const payload = {
      businessId,
      contactId: conv.contactId,
      userId,
    };

    // Fire-and-forget; we don't block UI on this.
    axiosClient.post("/chat-inbox/mark-read", payload).catch(err => {
      console.error("Failed to mark conversation as read:", err);
    });

    // Optimistically zero-out unread count in UI
    setAllConversations(prev =>
      prev.map(c => (c.id === conv.id ? { ...c, unreadCount: 0 } : c))
    );
  }, [selectedConversationId, allConversations]);

  // ðŸ” Helper to (re)load CRM contact summary
  const refreshContactSummary = useCallback(async () => {
    if (!selectedContactId) {
      setContactSummary(null);
      return;
    }

    try {
      setIsSummaryLoading(true);
      const res = await axiosClient.get(
        `/crm/contact-summary/${selectedContactId}`
      );
      const payload = res.data?.data ?? res.data;
      setContactSummary(payload || null);
    } catch (error) {
      console.error("âŒ Failed to load contact summary:", error);
      setContactSummary(null);
      // kept quiet to avoid toast noise while switching chats
    } finally {
      setIsSummaryLoading(false);
    }
  }, [selectedContactId]);

  // ðŸ›° Load CRM contact summary for right panel
  useEffect(() => {
    if (!selectedContactId) {
      setContactSummary(null);
      return;
    }
    refreshContactSummary();
  }, [selectedContactId, refreshContactSummary]);

  // Auto-scroll when messages change
  useEffect(() => {
    if (!selectedConversationId) return;
    if (isMessagesLoading) return;
    if (messages.length === 0) return;

    scrollToBottom();
  }, [messages, isMessagesLoading, selectedConversationId, scrollToBottom]);

  // ðŸ§® Messages + date separators
  const messagesWithSeparators = useMemo(() => {
    const result = [];
    let lastDateKey = null;

    messages.forEach(m => {
      const dateObj = m.sentAt ? new Date(m.sentAt) : null;
      const key = dateObj ? dateObj.toDateString() : "unknown";

      if (key !== lastDateKey) {
        if (dateObj) {
          result.push({
            type: "separator",
            id: `sep-${key}`,
            label: formatDayLabel(dateObj),
          });
        }
        lastDateKey = key;
      }

      result.push({ type: "message", ...m });
    });

    return result;
  }, [messages]);

  // ðŸ“¨ Send message
  const handleSendMessage = async () => {
    if (!selectedConversation) {
      toast.warn("Please select a conversation first.");
      return;
    }

    if (!isWithin24h) {
      toast.warn(
        "This chat is outside the 24-hour WhatsApp window. Use a template or campaign to re-engage."
      );
      return;
    }

    const trimmed = newMessage.trim();
    if (!trimmed) {
      toast.warn("Type a message before sending.");
      return;
    }

    const businessId = localStorage.getItem("businessId");
    if (!businessId) {
      toast.error("âŒ Missing business context. Please login again.");
      return;
    }

    if (isSending) return;

    const tempId = `temp-${Date.now()}`;
    const nowIso = new Date().toISOString();

    const optimisticMsg = {
      id: tempId,
      direction: "out",
      isInbound: false,
      text: trimmed,
      sentAt: nowIso,
      status: "Sending...",
      errorMessage: null,
    };

    setMessages(prev => [...prev, optimisticMsg]);

    setNewMessage("");
    setIsSending(true);

    try {
      const payload = {
        businessId,
        conversationId: selectedConversation.id,
        contactId: selectedConversation.contactId,
        to: selectedConversation.contactPhone,
        text: trimmed,
        numberId: selectedConversation.numberId,
      };

      const res = await axiosClient.post("/chat-inbox/send-message", payload);
      const saved = res.data || {};

      const finalSentAt =
        saved.sentAtUtc || saved.sentAt || optimisticMsg.sentAt;
      const finalSentAtIso =
        finalSentAt instanceof Date ? finalSentAt.toISOString() : finalSentAt;

      // âœ… Update message bubble
      setMessages(prev =>
        prev.map(m =>
          m.id === tempId
            ? {
                id: saved.id ?? tempId,
                direction: saved.direction ?? "out",
                isInbound:
                  typeof saved.isInbound === "boolean"
                    ? saved.isInbound
                    : false,
                text: saved.text ?? trimmed,
                sentAt: finalSentAtIso,
                status: saved.status || "Sent",
                errorMessage: saved.errorMessage || null,
              }
            : m
        )
      );

      // âœ… Optimistically update left list preview + timestamps
      setAllConversations(prev =>
        prev.map(c =>
          c.id === selectedConversation.id
            ? {
                ...c,
                lastMessagePreview: trimmed,
                lastMessageAt: finalSentAtIso,
                lastOutboundAt: finalSentAtIso,
                within24h: true,
              }
            : c
        )
      );
    } catch (error) {
      console.error("âŒ Failed to send message:", error);
      toast.error(
        error.response?.data?.message || "Failed to send message. Please retry."
      );

      setMessages(prev =>
        prev.map(m =>
          m.id === tempId
            ? {
                ...m,
                status: "Failed",
                errorMessage: "Not delivered",
              }
            : m
        )
      );
    } finally {
      setIsSending(false);
      scrollToBottom();
    }
  };

  const handleComposerKeyDown = event => {
    if (event.key === "Enter" && !event.shiftKey) {
      event.preventDefault();
      if (!isSending && newMessage.trim()) {
        handleSendMessage();
      }
    }
  };

  // ðŸ‘¤ Assign conversation to me
  const handleAssignToMe = async () => {
    if (!selectedConversation || !selectedConversation.contactId) {
      toast.warn("Select a conversation before assigning.");
      return;
    }

    const businessId = localStorage.getItem("businessId");
    const userId = localStorage.getItem("userId");

    if (!businessId || !userId) {
      toast.error("Missing business or user context. Please login again.");
      return;
    }

    if (isAssigning) return;

    setIsAssigning(true);
    try {
      const payload = {
        businessId,
        contactId: selectedConversation.contactId,
        userId,
      };

      await axiosClient.post("/chat-inbox/assign", payload);

      // Optimistic local update
      setAllConversations(prev =>
        prev.map(c =>
          c.id === selectedConversation.id
            ? {
                ...c,
                assignedToUserId: userId,
                assignedToUserName: "You",
                isAssignedToMe: true,
              }
            : c
        )
      );

      toast.success("Conversation assigned to you.");
    } catch (error) {
      console.error("Failed to assign conversation:", error);
      toast.error(
        error.response?.data?.message || "Failed to assign conversation."
      );
    } finally {
      setIsAssigning(false);
    }
  };

  // ðŸš« Unassign conversation
  const handleUnassign = async () => {
    if (!selectedConversation || !selectedConversation.contactId) {
      toast.warn("Select a conversation before unassigning.");
      return;
    }

    const businessId = localStorage.getItem("businessId");

    if (!businessId) {
      toast.error("Missing business context. Please login again.");
      return;
    }

    if (isAssigning) return;

    setIsAssigning(true);
    try {
      const payload = {
        businessId,
        contactId: selectedConversation.contactId,
      };

      await axiosClient.post("/chat-inbox/unassign", payload);

      // Optimistic local update
      setAllConversations(prev =>
        prev.map(c =>
          c.id === selectedConversation.id
            ? {
                ...c,
                assignedToUserId: null,
                assignedToUserName: null,
                isAssignedToMe: false,
              }
            : c
        )
      );

      toast.info("Conversation unassigned.");
    } catch (error) {
      console.error("Failed to unassign conversation:", error);
      toast.error(
        error.response?.data?.message || "Failed to unassign conversation."
      );
    } finally {
      setIsAssigning(false);
    }
  };

  // ðŸ”— Open full CRM (Contact 360 workspace)
  const handleOpenFullCrm = () => {
    if (!selectedConversation) {
      toast.info("Select a conversation first to open full CRM.");
      return;
    }
    if (!selectedContactId) {
      toast.info("No contact is linked to this conversation yet.");
      return;
    }

    // ðŸ”— Match route: /app/crm/contacts/:contactId
    navigate(`/app/crm/contacts/${selectedContactId}`);
  };

  // ðŸ“ Quick add note from Inbox
  // ðŸ“ Quick add note from Inbox
  const handleAddNote = async () => {
    if (!selectedConversation || !selectedContactId) {
      toast.warn("Select a conversation with a linked contact to add notes.");
      return;
    }

    const content = noteDraft.trim();
    if (!content) {
      toast.warn("Type something for the note before saving.");
      return;
    }

    if (isSavingNote) return;

    const title =
      content.length > 50 ? `${content.substring(0, 50)}â€¦` : content;

    const dto = {
      contactId: selectedContactId,
      title,
      content,
      // CreatedBy / BusinessId / CreatedAt handled server-side
    };

    setIsSavingNote(true);
    try {
      // ðŸ”— Reuse the same API as CRM module
      await axios.post("/api/notes", dto);

      // ðŸ§¾ Auto-log to LeadTimeline (Inbox origin)
      try {
        await axiosClient.post("/leadtimeline", {
          contactId: selectedContactId,
          eventType: "NoteAdded",
          description: `Note added from Inbox: '${title}'`,
          source: "Inbox",
          category: "Manual",
          isSystemGenerated: true,
        });
      } catch (timelineErr) {
        console.warn("Timeline log failed (Inbox note):", timelineErr);
      }

      toast.success("Note added.");
      setNoteDraft("");
      await refreshContactSummary();
    } catch (error) {
      console.error("Failed to add note:", error);
      toast.error(
        error.response?.data?.message || "Failed to add note from inbox."
      );
    } finally {
      setIsSavingNote(false);
    }
  };

  // â° Quick add reminder from Inbox
  // â° Quick add reminder from Inbox
  const handleAddReminder = async () => {
    if (!selectedConversation || !selectedContactId) {
      toast.warn(
        "Select a conversation with a linked contact to add reminders."
      );
      return;
    }

    const title = reminderTitle.trim();
    if (!title) {
      toast.warn("Enter a reminder title.");
      return;
    }
    if (!reminderDueAt) {
      toast.warn("Choose a due date/time for the reminder.");
      return;
    }

    const due = new Date(reminderDueAt);
    if (Number.isNaN(due.getTime())) {
      toast.error("Invalid reminder date/time.");
      return;
    }

    if (isSavingReminder) return;

    const dto = {
      contactId: selectedContactId,
      title,
      description: reminderDescription || null,
      dueAt: due.toISOString(),
      // Status & Priority defaults handled server-side
    };

    setIsSavingReminder(true);
    try {
      // ðŸ”— Same API as CRM Reminders module
      await axios.post("/api/reminders", dto);

      // ðŸ§¾ Auto-log to LeadTimeline (Inbox origin)
      try {
        const formattedDate = due.toLocaleString();

        await axiosClient.post("/leadtimeline", {
          contactId: selectedContactId,
          eventType: "ReminderSet",
          description: `Reminder from Inbox '${title}' scheduled for ${formattedDate}.`,
          source: "Inbox",
          category: "Auto",
          isSystemGenerated: true,
        });
      } catch (timelineErr) {
        console.warn("Timeline log failed (Inbox reminder):", timelineErr);
      }

      toast.success("Reminder added.");
      setReminderTitle("");
      setReminderDueAt("");
      setReminderDescription("");
      await refreshContactSummary();
    } catch (error) {
      console.error("Failed to add reminder:", error);
      toast.error(
        error.response?.data?.message || "Failed to add reminder from inbox."
      );
    } finally {
      setIsSavingReminder(false);
    }
  };

  // Small helpers for CRM panel
  const tagsList =
    (contactSummary?.tags ??
      contactSummary?.contactTags ??
      contactSummary?.contactTagsDto ??
      []) ||
    [];

  const recentNotes = contactSummary?.recentNotes ?? [];
  const nextReminder = contactSummary?.nextReminder ?? null;
  const recentTimeline = contactSummary?.recentTimeline ?? [];

  return (
    <div className="h-[calc(100vh-64px)] flex bg-slate-50">
      {/* ðŸ“¥ Left: Conversations list */}
      <div className="w-[360px] border-r border-slate-200 flex flex-col">
        {/* Top filters */}
        <div className="px-4 py-3 border-b border-slate-200 bg-white flex flex-col gap-3">
          <div className="flex items-center gap-2">
            <Phone className="w-4 h-4 text-emerald-600" />
            <span className="text-sm font-semibold text-slate-800">
              Chat Inbox
            </span>
          </div>

          {/* Number + tab + search row */}
          <div className="flex gap-2 items-center">
            <div className="relative">
              <select
                value={selectedNumberId}
                onChange={e => setSelectedNumberId(e.target.value)}
                className="appearance-none bg-slate-50 border border-slate-200 text-xs rounded-full pl-3 pr-7 py-1.5 text-slate-700 focus:outline-none focus:ring-1 focus:ring-purple-500 focus:border-purple-500"
              >
                {MOCK_NUMBERS.map(n => (
                  <option key={n.id} value={n.id}>
                    {n.label}
                  </option>
                ))}
              </select>
              <ChevronDown className="w-3 h-3 text-slate-400 absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none" />
            </div>

            <div className="flex-1 flex items-center bg-slate-50 border border-slate-200 rounded-full px-2">
              <Search className="w-3.5 h-3.5 text-slate-400 mr-1" />
              <input
                type="text"
                placeholder="Search name, number, message..."
                value={searchTerm}
                onChange={e => setSearchTerm(e.target.value)}
                className="w-full bg-transparent border-none text-xs text-slate-700 focus:outline-none"
              />
            </div>
          </div>

          {/* Tabs */}
          <div className="flex items-center gap-3 text-[11px] font-medium">
            {TABS.map(tab => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={`pb-1 border-b-2 transition-colors ${
                  activeTab === tab.id
                    ? "border-purple-600 text-purple-700"
                    : "border-transparent text-slate-500 hover:text-purple-600"
                }`}
              >
                {tab.label}
              </button>
            ))}

            <button className="ml-auto inline-flex items-center gap-1 text-[11px] text-slate-500 hover:text-slate-700">
              <Filter className="w-3 h-3" />
              More
            </button>
          </div>
        </div>

        {/* Conversations list */}
        <div className="flex-1 overflow-y-auto bg-slate-50">
          {isLoading && (
            <div className="p-4 text-xs text-slate-500">Loading chatsâ€¦</div>
          )}

          {!isLoading && filteredConversations.length === 0 && (
            <div className="p-4 text-xs text-slate-400 italic">
              No conversations found for this filter.
            </div>
          )}

          {filteredConversations.map(conv => (
            <button
              key={conv.id}
              onClick={() => setSelectedConversationId(conv.id)}
              className={`w-full flex items-start gap-3 px-3 py-2.5 text-left border-b border-slate-100 hover:bg-white transition ${
                selectedConversationId === conv.id ? "bg-white" : "bg-slate-50"
              }`}
            >
              {/* Avatar + unread badge */}
              <div className="relative">
                <div className="w-9 h-9 rounded-full bg-emerald-100 flex items-center justify-center text-xs font-semibold text-emerald-700">
                  {getInitial(conv.contactName, conv.contactPhone)}
                </div>
                {conv.unreadCount > 0 && (
                  <span className="absolute -top-1 -right-1 bg-rose-500 text-white text-[9px] font-semibold rounded-full px-1.5 py-[1px]">
                    {conv.unreadCount}
                  </span>
                )}
              </div>

              {/* Main info */}
              <div className="flex-1 min-w-0">
                <div className="flex items-center justify-between mb-0.5">
                  <div className="flex flex-col">
                    <span className="text-xs font-semibold text-slate-800 truncate">
                      {conv.contactName || conv.contactPhone || "Unknown"}
                    </span>
                    <span className="text-[10px] text-slate-400">
                      {conv.contactPhone}
                    </span>
                  </div>
                  <span className="text-[10px] text-slate-400 ml-2">
                    {conv.lastMessageAt
                      ? new Date(conv.lastMessageAt).toLocaleTimeString([], {
                          hour: "2-digit",
                          minute: "2-digit",
                        })
                      : "-"}
                  </span>
                </div>

                <div className="flex items-center justify-between gap-2">
                  <p className="text-[11px] text-slate-600 truncate pr-4">
                    {conv.lastMessagePreview || "No recent message"}
                  </p>

                  <div className="flex flex-col items-end gap-0.5">
                    <span
                      className={`text-[9px] px-1.5 py-[1px] rounded-full border ${
                        conv.within24h
                          ? "bg-emerald-50 text-emerald-700 border-emerald-100"
                          : "bg-slate-50 text-slate-500 border-slate-200"
                      }`}
                    >
                      {conv.within24h ? "24h window" : "Outside 24h"}
                    </span>
                    {conv.assignedToUserName && (
                      <span className="text-[9px] text-slate-400">
                        ðŸ‘¤ {conv.assignedToUserName}
                      </span>
                    )}
                  </div>
                </div>
              </div>
            </button>
          ))}
        </div>
      </div>

      {/* ðŸ’¬ Middle: Chat window */}
      <div className="flex-1 flex flex-col">
        {/* Chat header */}
        <div className="h-[64px] border-b border-slate-200 bg-white flex items-center justify-between px-4">
          {selectedConversation ? (
            <>
              <div className="flex items-center gap-3">
                <div className="w-9 h-9 rounded-full bg-emerald-100 flex items-center justify-center text-xs font-semibold text-emerald-700">
                  {getInitial(
                    selectedConversation.contactName,
                    selectedConversation.contactPhone
                  )}
                </div>
                <div>
                  <div className="flex items-center gap-2">
                    <span className="text-sm font-semibold text-slate-800">
                      {selectedConversation.contactName ||
                        selectedConversation.contactPhone}
                    </span>
                    <span className="text-[11px] text-slate-400">
                      {selectedConversation.contactPhone}
                    </span>
                  </div>
                  <div className="flex items-center gap-3 text-[11px] text-slate-400 mt-0.5">
                    <span className="flex items-center gap-1">
                      <Clock className="w-3 h-3" />
                      {selectedConversation.lastInboundAt
                        ? formatDateTime(selectedConversation.lastInboundAt)
                        : "Last inbound: -"}
                    </span>
                    <span className="flex items-center gap-1">
                      <CheckCircle2 className="w-3 h-3" />
                      {selectedConversation.status || "Open"}
                    </span>
                    <span
                      className={`inline-flex items-center gap-1 px-2 py-[1px] rounded-full text-[10px] border ${
                        isWithin24h
                          ? "bg-emerald-50 text-emerald-700 border-emerald-200"
                          : "bg-slate-50 text-slate-500 border-slate-200"
                      }`}
                    >
                      <Clock className="w-3 h-3" />
                      {isWithin24h ? "Within 24h" : "Outside 24h"}
                    </span>
                    <span className="inline-flex items-center gap-1 text-[11px] text-slate-500">
                      <User className="w-3 h-3" />
                      {headerIsAssigned
                        ? headerIsAssignedToMe
                          ? "Assigned to you"
                          : `Assigned to ${headerAssignedName}`
                        : "Unassigned"}
                    </span>
                  </div>
                </div>
              </div>

              <div className="flex items-center gap-2 text-[11px] text-slate-500">
                <span className="flex items-center gap-1">
                  <MessageCircle className="w-3 h-3" />
                  {selectedConversation.sourceName || "WhatsApp"}
                </span>
                <span className="flex items-center gap-1">
                  <Mail className="w-3 h-3" />
                  {selectedConversation.mode || "Live"}
                </span>

                {/* Assignment actions */}
                {!headerIsAssigned && currentUserId && (
                  <button
                    onClick={handleAssignToMe}
                    disabled={isAssigning}
                    className={`ml-2 px-2 py-[2px] rounded-full border text-[11px] ${
                      isAssigning
                        ? "border-emerald-300 text-emerald-400 cursor-wait"
                        : "border-emerald-500 text-emerald-600 hover:bg-emerald-50"
                    }`}
                  >
                    {isAssigning ? "Assigningâ€¦" : "Assign to me"}
                  </button>
                )}

                {headerIsAssignedToMe && (
                  <button
                    onClick={handleUnassign}
                    disabled={isAssigning}
                    className={`ml-1 px-2 py-[2px] rounded-full border text-[11px] ${
                      isAssigning
                        ? "border-slate-300 text-slate-400 cursor-wait"
                        : "border-slate-300 text-slate-600 hover:bg-slate-50"
                    }`}
                  >
                    {isAssigning ? "Updatingâ€¦" : "Unassign"}
                  </button>
                )}

                <button
                  onClick={() => setShowRightPanel(v => !v)}
                  className="ml-2 text-xs text-purple-600 hover:text-purple-700"
                >
                  {showRightPanel ? "Hide details" : "Show details"}
                </button>
              </div>
            </>
          ) : (
            <div className="text-xs text-slate-400">
              Select a conversation to start chatting.
            </div>
          )}
        </div>

        {/* Chat messages area */}
        <div className="flex-1 overflow-y-auto bg-slate-50 px-4 py-3">
          {!selectedConversation && (
            <div className="h-full flex items-center justify-center text-xs text-slate-400">
              No conversation selected.
            </div>
          )}

          {selectedConversation && (
            <div className="flex flex-col gap-2 text-xs">
              {isMessagesLoading && (
                <div className="text-slate-400">Loading messagesâ€¦</div>
              )}

              {!isMessagesLoading && messages.length === 0 && (
                <div className="text-slate-400 italic">
                  No messages yet for this contact.
                </div>
              )}

              {!isMessagesLoading &&
                messagesWithSeparators.length > 0 &&
                messagesWithSeparators.map(item => {
                  if (item.type === "separator") {
                    return (
                      <div key={item.id} className="flex justify-center my-2">
                        <span className="px-3 py-0.5 rounded-full bg-slate-100 text-[10px] text-slate-500">
                          {item.label}
                        </span>
                      </div>
                    );
                  }

                  const msg = item;
                  const isInbound = !!msg.isInbound;

                  return (
                    <div
                      key={msg.id}
                      className={`flex ${
                        isInbound ? "justify-start" : "justify-end"
                      }`}
                    >
                      <div
                        className={`max-w-[70%] rounded-lg px-3 py-2 shadow-sm ${
                          isInbound
                            ? "bg-white text-slate-800"
                            : "bg-purple-600 text-white"
                        }`}
                      >
                        <div className="whitespace-pre-wrap break-words">
                          {msg.text || "-"}
                        </div>
                        <div className="mt-1 text-[10px] opacity-75 flex items-center justify-end gap-1">
                          {msg.sentAt &&
                            new Date(msg.sentAt).toLocaleTimeString([], {
                              hour: "2-digit",
                              minute: "2-digit",
                            })}
                          <StatusIcon status={msg.status} />
                          {msg.status && <span>{msg.status}</span>}
                        </div>
                        {msg.errorMessage && (
                          <div className="mt-0.5 text-[10px] text-rose-200">
                            {msg.errorMessage}
                          </div>
                        )}
                      </div>
                    </div>
                  );
                })}

              <div ref={messagesEndRef} />
            </div>
          )}
        </div>

        {/* Chat input */}
        <div className="border-t border-slate-200 bg-white px-4 py-3">
          {selectedConversation && !isWithin24h && (
            <div className="text-[11px] text-amber-600 mb-2">
              This conversation is{" "}
              <span className="font-semibold">outside</span> the 24-hour
              WhatsApp window. Free-form replies are disabled here. Use approved
              templates (campaigns / flows) to re-engage.
            </div>
          )}

          <div className="flex items-center gap-2">
            <textarea
              rows={1}
              value={newMessage}
              onChange={e => setNewMessage(e.target.value)}
              onKeyDown={handleComposerKeyDown}
              placeholder={
                selectedConversation
                  ? isWithin24h
                    ? "Type a replyâ€¦"
                    : "24h window expired â€“ send via template campaign."
                  : "Select a conversation first."
              }
              disabled={!selectedConversation || !isWithin24h || isSending}
              className={`flex-1 resize-none border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-purple-500 focus:border-purple-500 ${
                !selectedConversation || !isWithin24h
                  ? "bg-slate-50 text-slate-400 cursor-not-allowed"
                  : "bg-white"
              }`}
            />
            <button
              onClick={handleSendMessage}
              disabled={
                isSending ||
                !newMessage.trim() ||
                !selectedConversation ||
                !isWithin24h
              }
              className={`bg-purple-600 text-white text-sm font-medium px-4 py-2 rounded-lg shadow-sm ${
                isSending ||
                !newMessage.trim() ||
                !selectedConversation ||
                !isWithin24h
                  ? "opacity-60 cursor-not-allowed"
                  : "hover:bg-purple-700"
              }`}
            >
              {isSending ? "Sending..." : "Send"}
            </button>
          </div>
        </div>
      </div>

      {/* ðŸ“‡ Right: CRM + details */}
      {showRightPanel && (
        <div className="w-80 border-l border-slate-200 bg-white flex flex-col">
          {/* Top section: summary */}
          <div className="px-4 py-3 border-b border-slate-200 flex items-center justify-between">
            <div className="flex items-center gap-2">
              <User className="w-4 h-4 text-slate-500" />
              <span className="text-xs font-semibold text-slate-800">
                Contact & CRM
              </span>
            </div>
            <div className="flex items-center gap-2">
              {selectedContactId && (
                <button
                  type="button"
                  onClick={handleOpenFullCrm}
                  className="inline-flex items-center gap-1 rounded-full border border-purple-200 bg-purple-50 px-2 py-[2px] text-[11px] font-medium text-purple-700 hover:bg-purple-100"
                >
                  <ExternalLink className="w-3 h-3" />
                  Open full CRM
                </button>
              )}
              <button
                onClick={() => setShowDetails(v => !v)}
                className="text-[11px] text-slate-500 hover:text-slate-700 flex items-center gap-1"
              >
                {showDetails ? "Hide" : "Show"}
                {showDetails ? (
                  <ChevronDown className="w-3 h-3" />
                ) : (
                  <ChevronRight className="w-3 h-3" />
                )}
              </button>
            </div>
          </div>

          {/* Contact + CRM summary */}
          {showDetails && (
            <div className="p-4 text-xs text-slate-600 space-y-3 overflow-y-auto">
              {selectedConversation ? (
                <>
                  {/* Basic identity */}
                  <div>
                    <div className="font-semibold text-slate-800 mb-0.5">
                      {selectedConversation.contactName ||
                        selectedConversation.contactPhone ||
                        "Unknown contact"}
                    </div>
                    <div className="text-slate-500">
                      {selectedConversation.contactPhone}
                    </div>
                    {contactSummary?.leadSource && (
                      <div className="text-[11px] text-slate-400 mt-0.5">
                        Lead source:{" "}
                        <span className="text-slate-600">
                          {contactSummary.leadSource}
                        </span>
                      </div>
                    )}
                  </div>

                  {/* High-level stats */}
                  <div className="grid grid-cols-2 gap-2 text-[11px]">
                    <div className="bg-slate-50 rounded-md p-2">
                      <div className="text-slate-400">First seen</div>
                      <div className="font-medium">
                        {formatDateTime(selectedConversation.firstSeenAt)}
                      </div>
                    </div>
                    <div className="bg-slate-50 rounded-md p-2">
                      <div className="text-slate-400">Last inbound</div>
                      <div className="font-medium">
                        {formatDateTime(selectedConversation.lastInboundAt)}
                      </div>
                    </div>
                    <div className="bg-slate-50 rounded-md p-2">
                      <div className="text-slate-400">Last outbound</div>
                      <div className="font-medium">
                        {formatDateTime(selectedConversation.lastOutboundAt)}
                      </div>
                    </div>
                    <div className="bg-slate-50 rounded-md p-2">
                      <div className="text-slate-400">Status</div>
                      <div className="font-medium">
                        {selectedConversation.status || "Open"}
                      </div>
                    </div>
                  </div>

                  {/* Divider */}
                  <div className="h-px bg-slate-200 my-2" />

                  {/* CRM summary details */}
                  {isSummaryLoading && (
                    <div className="text-[11px] text-slate-400">
                      Loading CRM dataâ€¦
                    </div>
                  )}

                  {!isSummaryLoading && !contactSummary && (
                    <div className="text-[11px] text-slate-400 italic">
                      No CRM data yet. Add a note or reminder from the CRM
                      workspace to enrich this contact.
                    </div>
                  )}

                  {!isSummaryLoading && contactSummary && (
                    <>
                      {/* Tags */}
                      <div>
                        <div className="flex items-center justify-between mb-1">
                          <div className="flex items-center gap-1">
                            <Tag className="w-3 h-3 text-slate-400" />
                            <span className="font-semibold text-[11px] text-slate-700">
                              Tags
                            </span>
                          </div>

                          {selectedContactId && (
                            <button
                              type="button"
                              onClick={() => setIsTagModalOpen(true)}
                              className="text-[11px] font-medium text-purple-600 hover:text-purple-700"
                            >
                              + Tag
                            </button>
                          )}
                        </div>

                        <div className="flex flex-wrap gap-1">
                          {tagsList.length > 0 ? (
                            tagsList.map((tag, index) => (
                              <span
                                key={index}
                                className="px-2 py-0.5 text-[10px] rounded-full font-medium border border-slate-200"
                                style={{
                                  backgroundColor: tag.colorHex || "#EEF2FF",
                                }}
                              >
                                {tag.tagName || tag.name || "Tag"}
                              </span>
                            ))
                          ) : (
                            <span className="text-[11px] text-slate-400">
                              No tags yet. Use{" "}
                              <span className="font-semibold">+ Tag</span> or
                              full CRM to add tags.
                            </span>
                          )}
                        </div>
                      </div>

                      {/* Next reminder */}
                      <div>
                        <div className="flex items-center justify-between mb-1">
                          <div className="flex items-center gap-1">
                            <Bell className="w-3 h-3 text-slate-400" />
                            <span className="font-semibold text-[11px] text-slate-700">
                              Next reminder
                            </span>
                          </div>
                        </div>
                        {nextReminder ? (
                          <div className="bg-amber-50 border border-amber-100 rounded-md p-2">
                            <div className="flex items-center justify-between">
                              <span className="text-[11px] font-semibold text-amber-800">
                                {nextReminder.title}
                              </span>
                              <span className="text-[10px] text-amber-700">
                                {formatDateTime(nextReminder.dueAt)}
                              </span>
                            </div>
                            {nextReminder.description && (
                              <div className="mt-0.5 text-[11px] text-amber-900">
                                {nextReminder.description}
                              </div>
                            )}
                            {nextReminder.status && (
                              <div className="mt-0.5 text-[10px] text-amber-700">
                                Status: {nextReminder.status}
                              </div>
                            )}
                          </div>
                        ) : (
                          <span className="text-[11px] text-slate-400">
                            No upcoming reminder for this contact.
                          </span>
                        )}

                        {/* Quick reminder form */}
                        {selectedContactId && (
                          <div className="mt-2">
                            <div className="text-[11px] text-slate-500 mb-1">
                              Quick reminder
                            </div>
                            <input
                              type="text"
                              value={reminderTitle}
                              onChange={e => setReminderTitle(e.target.value)}
                              placeholder="Reminder title"
                              className="w-full mb-1 border border-slate-200 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-purple-500 focus:border-purple-500"
                            />
                            <input
                              type="datetime-local"
                              value={reminderDueAt}
                              onChange={e => setReminderDueAt(e.target.value)}
                              className="w-full mb-1 border border-slate-200 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-purple-500 focus:border-purple-500"
                            />
                            <textarea
                              rows={2}
                              value={reminderDescription}
                              onChange={e =>
                                setReminderDescription(e.target.value)
                              }
                              placeholder="Optional descriptionâ€¦"
                              className="w-full border border-slate-200 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-purple-500 focus:border-purple-500"
                            />
                            <div className="mt-1 flex justify-end">
                              <button
                                type="button"
                                onClick={handleAddReminder}
                                disabled={
                                  isSavingReminder ||
                                  !reminderTitle.trim() ||
                                  !reminderDueAt
                                }
                                className={`px-2 py-[3px] rounded-md text-[11px] font-medium ${
                                  isSavingReminder ||
                                  !reminderTitle.trim() ||
                                  !reminderDueAt
                                    ? "bg-slate-200 text-slate-500 cursor-not-allowed"
                                    : "bg-amber-600 text-white hover:bg-amber-700"
                                }`}
                              >
                                {isSavingReminder ? "Savingâ€¦" : "Add reminder"}
                              </button>
                            </div>
                          </div>
                        )}
                      </div>

                      {/* Recent notes */}
                      <div>
                        <div className="flex items-center justify-between mb-1">
                          <div className="flex items-center gap-1">
                            <StickyNote className="w-3 h-3 text-slate-400" />
                            <span className="font-semibold text-[11px] text-slate-700">
                              Recent notes
                            </span>
                          </div>
                        </div>
                        {recentNotes.length > 0 ? (
                          <div className="space-y-1.5">
                            {recentNotes.map(note => (
                              <div
                                key={note.id}
                                className="bg-slate-50 border border-slate-100 rounded-md p-2"
                              >
                                <div className="text-[11px] text-slate-700">
                                  {note.content || note.text || "(no content)"}
                                </div>
                                <div className="mt-0.5 text-[10px] text-slate-400 flex justify-between">
                                  <span>
                                    {note.createdByName ||
                                      note.createdBy ||
                                      "Agent"}
                                  </span>
                                  <span>
                                    {note.createdAt
                                      ? new Date(
                                          note.createdAt
                                        ).toLocaleString()
                                      : ""}
                                  </span>
                                </div>
                              </div>
                            ))}
                          </div>
                        ) : (
                          <span className="text-[11px] text-slate-400">
                            No notes yet.
                          </span>
                        )}

                        {/* Quick note form */}
                        {selectedContactId && (
                          <div className="mt-2">
                            <div className="text-[11px] text-slate-500 mb-1">
                              Add a quick note
                            </div>
                            <textarea
                              rows={2}
                              value={noteDraft}
                              onChange={e => setNoteDraft(e.target.value)}
                              placeholder="Type an internal note about this contactâ€¦"
                              className="w-full border border-slate-200 rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-purple-500 focus:border-purple-500"
                            />
                            <div className="mt-1 flex justify-end">
                              <button
                                type="button"
                                onClick={handleAddNote}
                                disabled={isSavingNote || !noteDraft.trim()}
                                className={`px-2 py-[3px] rounded-md text-[11px] font-medium ${
                                  isSavingNote || !noteDraft.trim()
                                    ? "bg-slate-200 text-slate-500 cursor-not-allowed"
                                    : "bg-purple-600 text-white hover:bg-purple-700"
                                }`}
                              >
                                {isSavingNote ? "Savingâ€¦" : "Add note"}
                              </button>
                            </div>
                          </div>
                        )}
                      </div>

                      {/* Recent timeline */}
                      <div>
                        <div className="flex items-center justify-between mb-1">
                          <div className="flex items-center gap-1">
                            <Activity className="w-3 h-3 text-slate-400" />
                            <span className="font-semibold text-[11px] text-slate-700">
                              Recent activity
                            </span>
                          </div>
                        </div>
                        {recentTimeline.length > 0 ? (
                          <div className="space-y-1.5">
                            {recentTimeline.map(event => (
                              <div
                                key={event.id}
                                className="bg-slate-50 border border-slate-100 rounded-md p-2"
                              >
                                <div className="text-[11px] text-slate-700">
                                  {event.title ||
                                    event.shortDescription ||
                                    event.description ||
                                    "Activity"}
                                </div>
                                <div className="mt-0.5 text-[10px] text-slate-400 flex justify-between">
                                  <span>
                                    {event.source ||
                                      event.category ||
                                      event.eventType ||
                                      ""}
                                  </span>
                                  <span>
                                    {event.createdAt
                                      ? new Date(
                                          event.createdAt
                                        ).toLocaleString()
                                      : ""}
                                  </span>
                                </div>
                              </div>
                            ))}
                          </div>
                        ) : (
                          <span className="text-[11px] text-slate-400">
                            No recent activity logged yet.
                          </span>
                        )}
                      </div>
                    </>
                  )}
                </>
              ) : (
                <div className="text-slate-400 italic">
                  Select a conversation to see CRM info.
                </div>
              )}
            </div>
          )}

          {/* CRM panel placeholder / footer */}
          {showCrmPanel && (
            <div className="border-t border-slate-200 p-3 text-[11px] text-slate-500">
              This mini-CRM view uses your existing Contacts, Tags, Notes,
              Reminders, and Timeline data. Use{" "}
              <span className="font-semibold text-slate-700">
                â€œOpen full CRMâ€
              </span>{" "}
              for a 360Â° view.
            </div>
          )}
        </div>
      )}

      {/* ðŸ“Œ Inbox Tag Modal (overlay) */}
      <InboxAddTagModal
        isOpen={isTagModalOpen}
        onClose={() => setIsTagModalOpen(false)}
        contactId={selectedContactId}
        currentTags={tagsList}
        onTagAdded={refreshContactSummary}
      />
    </div>
  );
}

// // ðŸ“„ File: src/pages/ChatInbox.jsx

// import React, {
//   useState,
//   useMemo,
//   useCallback,
//   useEffect,
//   useRef,
// } from "react";
// import {
//   Phone,
//   Filter,
//   Search,
//   Clock,
//   CheckCircle2,
//   MessageCircle,
//   Mail,
//   User,
//   ChevronDown,
//   ChevronRight,
//   Check,
//   CheckCheck,
//   AlertCircle,
//   Tag,
//   Bell,
//   Activity,
//   StickyNote,
// } from "lucide-react";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";

// // ðŸ”¢ Mock WhatsApp numbers (real API wiring can come later)
// const MOCK_NUMBERS = [
//   { id: "all", label: "All numbers" },
//   { id: "wa-1", label: "+91 98765 43210" },
//   { id: "wa-2", label: "+91 99887 77665" },
// ];

// // ðŸ§  Tabs for the inbox
// const TABS = [
//   { id: "live", label: "Live (24h)" },
//   { id: "history", label: "Older" },
//   { id: "unassigned", label: "Unassigned" },
//   { id: "my", label: "My Chats" },
// ];

// // Local helper: format dates nicely
// function formatDateTime(value) {
//   if (!value) return "-";
//   const d = new Date(value);
//   if (Number.isNaN(d.getTime())) return String(value);
//   return d.toLocaleString();
// }

// // Local helper: first letter avatar
// function getInitial(name, phone) {
//   const src = name || phone || "?";
//   return src.trim()[0]?.toUpperCase() ?? "?";
// }

// // ðŸ—“ Day label for separators (Today / Yesterday / 12 Dec 2025)
// function formatDayLabel(date) {
//   if (!date || Number.isNaN(date.getTime())) return "";
//   const today = new Date();
//   const todayKey = today.toDateString();

//   const yesterday = new Date();
//   yesterday.setDate(today.getDate() - 1);
//   const yesterdayKey = yesterday.toDateString();

//   const key = date.toDateString();

//   if (key === todayKey) return "Today";
//   if (key === yesterdayKey) return "Yesterday";

//   return date.toLocaleDateString(undefined, {
//     day: "2-digit",
//     month: "short",
//     year: "numeric",
//   });
// }

// // âœ… Map message status â†’ icon
// function StatusIcon({ status }) {
//   if (!status) return null;
//   const s = String(status).toLowerCase();

//   if (s === "failed" || s === "error") {
//     return (
//       <span className="inline-flex items-center text-[10px] text-rose-200">
//         <AlertCircle className="w-3 h-3 mr-0.5" />
//       </span>
//     );
//   }

//   if (s === "read" || s === "seen" || s === "viewed") {
//     return (
//       <span className="inline-flex items-center text-[10px] text-emerald-200">
//         <CheckCheck className="w-3 h-3 mr-0.5" />
//       </span>
//     );
//   }

//   if (s === "delivered") {
//     return (
//       <span className="inline-flex items-center text-[10px] text-slate-200">
//         <CheckCheck className="w-3 h-3 mr-0.5" />
//       </span>
//     );
//   }

//   if (s === "sent" || s === "sending" || s === "queued") {
//     return (
//       <span className="inline-flex items-center text-[10px] text-slate-200">
//         <Check className="w-3 h-3 mr-0.5" />
//       </span>
//     );
//   }

//   return null;
// }

// export default function ChatInbox() {
//   // ðŸ”¹ Filters & selection
//   const [activeTab, setActiveTab] = useState("live");
//   const [selectedNumberId, setSelectedNumberId] = useState("all");
//   const [searchTerm, setSearchTerm] = useState("");

//   // ðŸ”¹ Data from backend
//   const [allConversations, setAllConversations] = useState([]);
//   const [isLoading, setIsLoading] = useState(false);

//   // ðŸ”¹ Selected conversation & message input
//   const [selectedConversationId, setSelectedConversationId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");

//   // ðŸ”¹ Messages for selected conversation
//   const [messages, setMessages] = useState([]);
//   const [isMessagesLoading, setIsMessagesLoading] = useState(false);

//   // ðŸ”¹ Sending & assignment state
//   const [isSending, setIsSending] = useState(false);
//   const [isAssigning, setIsAssigning] = useState(false);

//   // ðŸ”¹ CRM summary for right panel
//   const [contactSummary, setContactSummary] = useState(null);
//   const [isSummaryLoading, setIsSummaryLoading] = useState(false);

//   // Right panel toggles
//   const [showRightPanel, setShowRightPanel] = useState(true);
//   const [showDetails, setShowDetails] = useState(true);
//   const [showCrmPanel, setShowCrmPanel] = useState(true);

//   // ðŸ”½ Auto-scroll anchor for chat messages
//   const messagesEndRef = useRef(null);

//   const scrollToBottom = useCallback(() => {
//     if (messagesEndRef.current) {
//       messagesEndRef.current.scrollIntoView({
//         behavior: "smooth",
//         block: "end",
//       });
//     }
//   }, []);

//   const currentUserId = useMemo(() => localStorage.getItem("userId"), []);

//   // ðŸ§® Selected conversation
//   const selectedConversation = useMemo(
//     () => allConversations.find(c => c.id === selectedConversationId) || null,
//     [allConversations, selectedConversationId]
//   );

//   // We also want a stable contactId for effects
//   const selectedContactId = useMemo(
//     () => selectedConversation?.contactId || null,
//     [selectedConversation]
//   );

//   // ðŸ§® 24h window flag
//   const isWithin24h = selectedConversation?.within24h ?? false;

//   // ðŸ§® Assignment flags for header
//   const headerIsAssigned = !!selectedConversation?.assignedToUserId;
//   const headerIsAssignedToMe =
//     !!selectedConversation?.isAssignedToMe ||
//     (!!selectedConversation?.assignedToUserId &&
//       currentUserId &&
//       selectedConversation.assignedToUserId === currentUserId);
//   const headerAssignedName = headerIsAssignedToMe
//     ? "You"
//     : selectedConversation?.assignedToUserName || "Agent";

//   // ðŸ§® Filter + sort conversations
//   const filteredConversations = useMemo(() => {
//     let list = [...allConversations];

//     if (selectedNumberId !== "all") {
//       list = list.filter(c => c.numberId === selectedNumberId);
//     }

//     if (searchTerm.trim()) {
//       const q = searchTerm.trim().toLowerCase();
//       list = list.filter(
//         c =>
//           c.contactName?.toLowerCase().includes(q) ||
//           c.contactPhone?.toLowerCase().includes(q) ||
//           c.lastMessagePreview?.toLowerCase().includes(q)
//       );
//     }

//     if (activeTab === "live") {
//       list = list.filter(c => c.within24h);
//     } else if (activeTab === "unassigned") {
//       list = list.filter(c => !c.assignedToUserId);
//     } else if (activeTab === "my") {
//       if (currentUserId) {
//         list = list.filter(c => c.assignedToUserId === currentUserId);
//       }
//     }

//     // ðŸ”½ Sort: unread first, then most recent lastMessageAt
//     list.sort((a, b) => {
//       const aUnread = a.unreadCount > 0;
//       const bUnread = b.unreadCount > 0;

//       if (aUnread && !bUnread) return -1;
//       if (!aUnread && bUnread) return 1;

//       const aTime = a.lastMessageAt ? new Date(a.lastMessageAt).getTime() : 0;
//       const bTime = b.lastMessageAt ? new Date(b.lastMessageAt).getTime() : 0;

//       return bTime - aTime; // newest first
//     });

//     return list;
//   }, [
//     allConversations,
//     activeTab,
//     selectedNumberId,
//     searchTerm,
//     currentUserId,
//   ]);

//   // ðŸ›° Load conversations (supports "silent" refresh)
//   const fetchConversations = useCallback(
//     async (options = {}) => {
//       const { limit, silent } = options;

//       try {
//         if (!silent) {
//           setIsLoading(true);
//         }

//         const businessId = localStorage.getItem("businessId");

//         if (!businessId) {
//           toast.error(
//             "âŒ Missing business context. Please login again to load inbox."
//           );
//           if (!silent) {
//             setIsLoading(false);
//           }
//           return;
//         }

//         const params = {
//           businessId,
//           currentUserId,
//           tab: activeTab,
//           numberId:
//             selectedNumberId && selectedNumberId !== "all"
//               ? selectedNumberId
//               : undefined,
//           search: searchTerm || undefined,
//           limit: limit ?? 100,
//         };

//         const res = await axiosClient.get("/chat-inbox/conversations", {
//           params,
//         });

//         const apiItems = Array.isArray(res.data) ? res.data : [];

//         const mapped = apiItems.map(item => ({
//           id: item.id,
//           contactId: item.contactId,
//           contactName: item.contactName,
//           contactPhone: item.contactPhone,
//           lastMessagePreview: item.lastMessagePreview,
//           lastMessageAt: item.lastMessageAt,
//           unreadCount: item.unreadCount || 0,
//           status: item.status || "Open",
//           numberId: item.numberId,
//           numberLabel: item.numberLabel,
//           within24h: !!item.within24h,
//           assignedToUserId: item.assignedToUserId || null,
//           assignedToUserName: item.assignedToUserName || null,
//           isAssignedToMe: !!item.isAssignedToMe,
//           sourceType: item.sourceType || "WhatsApp",
//           sourceName: item.sourceName || "WhatsApp",
//           mode: item.mode || "Live",
//           firstSeenAt: item.firstSeenAt,
//           lastInboundAt: item.lastInboundAt,
//           lastOutboundAt: item.lastOutboundAt,
//         }));

//         setAllConversations(mapped);

//         if (!selectedConversationId && mapped.length > 0) {
//           setSelectedConversationId(mapped[0].id);
//         }
//       } catch (error) {
//         console.error("âŒ Failed to load inbox conversations:", error);
//         const message =
//           error.response?.data?.message ||
//           "Failed to load inbox conversations.";
//         toast.error(message);
//       } finally {
//         if (!options.silent) {
//           setIsLoading(false);
//         }
//       }
//     },
//     [
//       activeTab,
//       selectedNumberId,
//       searchTerm,
//       selectedConversationId,
//       currentUserId,
//     ]
//   );

//   // Initial + filter-based load
//   useEffect(() => {
//     fetchConversations();
//   }, [activeTab, selectedNumberId, searchTerm, fetchConversations]);

//   // ðŸ” Auto-refresh conversations every 25 seconds (silent, no flicker)
//   useEffect(() => {
//     const intervalId = setInterval(() => {
//       fetchConversations({ silent: true, limit: 100 });
//     }, 25000);

//     return () => clearInterval(intervalId);
//   }, [fetchConversations]);

//   // ðŸ›° Load messages for selected conversation
//   useEffect(() => {
//     const loadMessages = async () => {
//       if (!selectedConversationId) {
//         setMessages([]);
//         return;
//       }

//       const conv = allConversations.find(c => c.id === selectedConversationId);
//       if (!conv) {
//         setMessages([]);
//         return;
//       }

//       const businessId = localStorage.getItem("businessId");
//       if (!businessId) {
//         toast.error(
//           "âŒ Missing business context. Please login again to load messages."
//         );
//         return;
//       }

//       try {
//         setIsMessagesLoading(true);

//         const res = await axiosClient.get("/chat-inbox/messages", {
//           params: {
//             businessId,
//             contactPhone: conv.contactPhone,
//             limit: 100,
//           },
//         });

//         const apiItems = Array.isArray(res.data) ? res.data : [];

//         const mapped = apiItems
//           .map(m => {
//             const directionRaw =
//               m.direction ?? m.Direction ?? m.dir ?? m.messageDirection ?? "";
//             const statusRaw = m.status ?? "";

//             const dir = String(directionRaw).toLowerCase();
//             const status = String(statusRaw).toLowerCase();

//             let inferredIsInbound =
//               typeof m.isInbound === "boolean" ? m.isInbound : false;

//             if (typeof m.isInbound !== "boolean") {
//               inferredIsInbound =
//                 dir === "inbound" ||
//                 dir === "in" ||
//                 dir === "incoming" ||
//                 dir === "received" ||
//                 dir === "customer" ||
//                 dir === "from" ||
//                 status === "received" ||
//                 status === "incoming";
//             }

//             return {
//               id: m.id,
//               direction: directionRaw || (inferredIsInbound ? "in" : "out"),
//               isInbound: inferredIsInbound,
//               text: m.text || "",
//               sentAt: m.sentAtUtc || m.sentAt,
//               status: m.status,
//               errorMessage: m.errorMessage,
//             };
//           })
//           .reverse();

//         setMessages(mapped);
//       } catch (error) {
//         console.error("âŒ Failed to load messages:", error);
//         const message =
//           error.response?.data?.message || "Failed to load messages.";
//         toast.error(message);
//         setMessages([]);
//       } finally {
//         setIsMessagesLoading(false);
//       }
//     };

//     loadMessages();
//   }, [selectedConversationId, allConversations]);

//   // ðŸ”” Mark as read when opening a conversation
//   useEffect(() => {
//     if (!selectedConversationId) return;

//     const conv = allConversations.find(c => c.id === selectedConversationId);
//     if (!conv || !conv.contactId) return;

//     const businessId = localStorage.getItem("businessId");
//     const userId = localStorage.getItem("userId");

//     if (!businessId || !userId) return;

//     const payload = {
//       businessId,
//       contactId: conv.contactId,
//       userId,
//     };

//     // Fire-and-forget; we don't block UI on this.
//     axiosClient.post("/chat-inbox/mark-read", payload).catch(err => {
//       console.error("Failed to mark conversation as read:", err);
//     });

//     // Optimistically zero-out unread count in UI
//     setAllConversations(prev =>
//       prev.map(c => (c.id === conv.id ? { ...c, unreadCount: 0 } : c))
//     );
//   }, [selectedConversationId, allConversations]);

//   // ðŸ›° Load CRM contact summary for right panel
//   useEffect(() => {
//     if (!selectedContactId) {
//       setContactSummary(null);
//       return;
//     }

//     let isCancelled = false;

//     const loadSummary = async () => {
//       try {
//         setIsSummaryLoading(true);
//         const res = await axiosClient.get(
//           `/crm/contact-summary/${selectedContactId}`
//         );
//         const payload = res.data?.data ?? res.data;
//         if (!isCancelled) {
//           setContactSummary(payload || null);
//         }
//       } catch (error) {
//         console.error("âŒ Failed to load contact summary:", error);
//         if (!isCancelled) {
//           setContactSummary(null);
//         }
//         // We keep this quiet (no toast) to avoid noise when switching chats.
//       } finally {
//         if (!isCancelled) {
//           setIsSummaryLoading(false);
//         }
//       }
//     };

//     loadSummary();

//     return () => {
//       isCancelled = true;
//     };
//   }, [selectedContactId]);

//   // Auto-scroll when messages change
//   useEffect(() => {
//     if (!selectedConversationId) return;
//     if (isMessagesLoading) return;
//     if (messages.length === 0) return;

//     scrollToBottom();
//   }, [messages, isMessagesLoading, selectedConversationId, scrollToBottom]);

//   // ðŸ§® Messages + date separators
//   const messagesWithSeparators = useMemo(() => {
//     const result = [];
//     let lastDateKey = null;

//     messages.forEach(m => {
//       const dateObj = m.sentAt ? new Date(m.sentAt) : null;
//       const key = dateObj ? dateObj.toDateString() : "unknown";

//       if (key !== lastDateKey) {
//         if (dateObj) {
//           result.push({
//             type: "separator",
//             id: `sep-${key}`,
//             label: formatDayLabel(dateObj),
//           });
//         }
//         lastDateKey = key;
//       }

//       result.push({ type: "message", ...m });
//     });

//     return result;
//   }, [messages]);

//   // ðŸ“¨ Send message
//   const handleSendMessage = async () => {
//     if (!selectedConversation) {
//       toast.warn("Please select a conversation first.");
//       return;
//     }

//     if (!isWithin24h) {
//       toast.warn(
//         "This chat is outside the 24-hour WhatsApp window. Use a template or campaign to re-engage."
//       );
//       return;
//     }

//     const trimmed = newMessage.trim();
//     if (!trimmed) {
//       toast.warn("Type a message before sending.");
//       return;
//     }

//     const businessId = localStorage.getItem("businessId");
//     if (!businessId) {
//       toast.error("âŒ Missing business context. Please login again.");
//       return;
//     }

//     if (isSending) return;

//     const tempId = `temp-${Date.now()}`;
//     const nowIso = new Date().toISOString();

//     const optimisticMsg = {
//       id: tempId,
//       direction: "out",
//       isInbound: false,
//       text: trimmed,
//       sentAt: nowIso,
//       status: "Sending...",
//       errorMessage: null,
//     };

//     setMessages(prev => [...prev, optimisticMsg]);

//     setNewMessage("");
//     setIsSending(true);

//     try {
//       const payload = {
//         businessId,
//         conversationId: selectedConversation.id,
//         contactId: selectedConversation.contactId,
//         to: selectedConversation.contactPhone,
//         text: trimmed,
//         numberId: selectedConversation.numberId,
//       };

//       const res = await axiosClient.post("/chat-inbox/send-message", payload);
//       const saved = res.data || {};

//       const finalSentAt =
//         saved.sentAtUtc || saved.sentAt || optimisticMsg.sentAt;
//       const finalSentAtIso =
//         finalSentAt instanceof Date ? finalSentAt.toISOString() : finalSentAt;

//       // âœ… Update message bubble
//       setMessages(prev =>
//         prev.map(m =>
//           m.id === tempId
//             ? {
//                 id: saved.id ?? tempId,
//                 direction: saved.direction ?? "out",
//                 isInbound:
//                   typeof saved.isInbound === "boolean"
//                     ? saved.isInbound
//                     : false,
//                 text: saved.text ?? trimmed,
//                 sentAt: finalSentAtIso,
//                 status: saved.status || "Sent",
//                 errorMessage: saved.errorMessage || null,
//               }
//             : m
//         )
//       );

//       // âœ… Optimistically update left list preview + timestamps
//       setAllConversations(prev =>
//         prev.map(c =>
//           c.id === selectedConversation.id
//             ? {
//                 ...c,
//                 lastMessagePreview: trimmed,
//                 lastMessageAt: finalSentAtIso,
//                 lastOutboundAt: finalSentAtIso,
//                 within24h: true,
//               }
//             : c
//         )
//       );
//     } catch (error) {
//       console.error("âŒ Failed to send message:", error);
//       toast.error(
//         error.response?.data?.message || "Failed to send message. Please retry."
//       );

//       setMessages(prev =>
//         prev.map(m =>
//           m.id === tempId
//             ? {
//                 ...m,
//                 status: "Failed",
//                 errorMessage: "Not delivered",
//               }
//             : m
//         )
//       );
//     } finally {
//       setIsSending(false);
//       scrollToBottom();
//     }
//   };

//   // ðŸ‘¤ Assign conversation to me
//   const handleAssignToMe = async () => {
//     if (!selectedConversation || !selectedConversation.contactId) {
//       toast.warn("Select a conversation before assigning.");
//       return;
//     }

//     const businessId = localStorage.getItem("businessId");
//     const userId = localStorage.getItem("userId");

//     if (!businessId || !userId) {
//       toast.error("Missing business or user context. Please login again.");
//       return;
//     }

//     if (isAssigning) return;

//     setIsAssigning(true);
//     try {
//       const payload = {
//         businessId,
//         contactId: selectedConversation.contactId,
//         userId,
//       };

//       await axiosClient.post("/chat-inbox/assign", payload);

//       // Optimistic local update
//       setAllConversations(prev =>
//         prev.map(c =>
//           c.id === selectedConversation.id
//             ? {
//                 ...c,
//                 assignedToUserId: userId,
//                 assignedToUserName: "You",
//                 isAssignedToMe: true,
//               }
//             : c
//         )
//       );

//       toast.success("Conversation assigned to you.");
//     } catch (error) {
//       console.error("Failed to assign conversation:", error);
//       toast.error(
//         error.response?.data?.message || "Failed to assign conversation."
//       );
//     } finally {
//       setIsAssigning(false);
//     }
//   };

//   // ðŸš« Unassign conversation
//   const handleUnassign = async () => {
//     if (!selectedConversation || !selectedConversation.contactId) {
//       toast.warn("Select a conversation before unassigning.");
//       return;
//     }

//     const businessId = localStorage.getItem("businessId");

//     if (!businessId) {
//       toast.error("Missing business context. Please login again.");
//       return;
//     }

//     if (isAssigning) return;

//     setIsAssigning(true);
//     try {
//       const payload = {
//         businessId,
//         contactId: selectedConversation.contactId,
//       };

//       await axiosClient.post("/chat-inbox/unassign", payload);

//       // Optimistic local update
//       setAllConversations(prev =>
//         prev.map(c =>
//           c.id === selectedConversation.id
//             ? {
//                 ...c,
//                 assignedToUserId: null,
//                 assignedToUserName: null,
//                 isAssignedToMe: false,
//               }
//             : c
//         )
//       );

//       toast.info("Conversation unassigned.");
//     } catch (error) {
//       console.error("Failed to unassign conversation:", error);
//       toast.error(
//         error.response?.data?.message || "Failed to unassign conversation."
//       );
//     } finally {
//       setIsAssigning(false);
//     }
//   };

//   const handleComposerKeyDown = event => {
//     if (event.key === "Enter" && !event.shiftKey) {
//       event.preventDefault();
//       if (!isSending && newMessage.trim()) {
//         handleSendMessage();
//       }
//     }
//   };

//   // Small helpers for CRM panel
//   const tagsList =
//     (contactSummary?.tags ??
//       contactSummary?.contactTags ??
//       contactSummary?.contactTagsDto ??
//       []) ||
//     [];

//   const recentNotes = contactSummary?.recentNotes ?? [];
//   const nextReminder = contactSummary?.nextReminder ?? null;
//   const recentTimeline = contactSummary?.recentTimeline ?? [];

//   return (
//     <div className="h-[calc(100vh-64px)] flex bg-slate-50">
//       {/* ðŸ“¥ Left: Conversations list */}
//       <div className="w-[360px] border-r border-slate-200 flex flex-col">
//         {/* Top filters */}
//         <div className="px-4 py-3 border-b border-slate-200 bg-white flex flex-col gap-3">
//           <div className="flex items-center gap-2">
//             <Phone className="w-4 h-4 text-emerald-600" />
//             <span className="text-sm font-semibold text-slate-800">
//               Chat Inbox
//             </span>
//           </div>

//           {/* Number + tab + search row */}
//           <div className="flex gap-2 items-center">
//             <div className="relative">
//               <select
//                 value={selectedNumberId}
//                 onChange={e => setSelectedNumberId(e.target.value)}
//                 className="appearance-none bg-slate-50 border border-slate-200 text-xs rounded-full pl-3 pr-7 py-1.5 text-slate-700 focus:outline-none focus:ring-1 focus:ring-purple-500 focus:border-purple-500"
//               >
//                 {MOCK_NUMBERS.map(n => (
//                   <option key={n.id} value={n.id}>
//                     {n.label}
//                   </option>
//                 ))}
//               </select>
//               <ChevronDown className="w-3 h-3 text-slate-400 absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none" />
//             </div>

//             <div className="flex-1 flex items-center bg-slate-50 border border-slate-200 rounded-full px-2">
//               <Search className="w-3.5 h-3.5 text-slate-400 mr-1" />
//               <input
//                 type="text"
//                 placeholder="Search name, number, message..."
//                 value={searchTerm}
//                 onChange={e => setSearchTerm(e.target.value)}
//                 className="w-full bg-transparent border-none text-xs text-slate-700 focus:outline-none"
//               />
//             </div>
//           </div>

//           {/* Tabs */}
//           <div className="flex items-center gap-3 text-[11px] font-medium">
//             {TABS.map(tab => (
//               <button
//                 key={tab.id}
//                 onClick={() => setActiveTab(tab.id)}
//                 className={`pb-1 border-b-2 transition-colors ${
//                   activeTab === tab.id
//                     ? "border-purple-600 text-purple-700"
//                     : "border-transparent text-slate-500 hover:text-purple-600"
//                 }`}
//               >
//                 {tab.label}
//               </button>
//             ))}

//             <button className="ml-auto inline-flex items-center gap-1 text-[11px] text-slate-500 hover:text-slate-700">
//               <Filter className="w-3 h-3" />
//               More
//             </button>
//           </div>
//         </div>

//         {/* Conversations list */}
//         <div className="flex-1 overflow-y-auto bg-slate-50">
//           {isLoading && (
//             <div className="p-4 text-xs text-slate-500">Loading chatsâ€¦</div>
//           )}

//           {!isLoading && filteredConversations.length === 0 && (
//             <div className="p-4 text-xs text-slate-400 italic">
//               No conversations found for this filter.
//             </div>
//           )}

//           {filteredConversations.map(conv => (
//             <button
//               key={conv.id}
//               onClick={() => setSelectedConversationId(conv.id)}
//               className={`w-full flex items-start gap-3 px-3 py-2.5 text-left border-b border-slate-100 hover:bg-white transition ${
//                 selectedConversationId === conv.id ? "bg-white" : "bg-slate-50"
//               }`}
//             >
//               {/* Avatar + unread badge */}
//               <div className="relative">
//                 <div className="w-9 h-9 rounded-full bg-emerald-100 flex items-center justify-center text-xs font-semibold text-emerald-700">
//                   {getInitial(conv.contactName, conv.contactPhone)}
//                 </div>
//                 {conv.unreadCount > 0 && (
//                   <span className="absolute -top-1 -right-1 bg-rose-500 text-white text-[9px] font-semibold rounded-full px-1.5 py-[1px]">
//                     {conv.unreadCount}
//                   </span>
//                 )}
//               </div>

//               {/* Main info */}
//               <div className="flex-1 min-w-0">
//                 <div className="flex items-center justify-between mb-0.5">
//                   <div className="flex flex-col">
//                     <span className="text-xs font-semibold text-slate-800 truncate">
//                       {conv.contactName || conv.contactPhone || "Unknown"}
//                     </span>
//                     <span className="text-[10px] text-slate-400">
//                       {conv.contactPhone}
//                     </span>
//                   </div>
//                   <span className="text-[10px] text-slate-400 ml-2">
//                     {conv.lastMessageAt
//                       ? new Date(conv.lastMessageAt).toLocaleTimeString([], {
//                           hour: "2-digit",
//                           minute: "2-digit",
//                         })
//                       : "-"}
//                   </span>
//                 </div>

//                 <div className="flex items-center justify-between gap-2">
//                   <p className="text-[11px] text-slate-600 truncate pr-4">
//                     {conv.lastMessagePreview || "No recent message"}
//                   </p>

//                   <div className="flex flex-col items-end gap-0.5">
//                     <span
//                       className={`text-[9px] px-1.5 py-[1px] rounded-full border ${
//                         conv.within24h
//                           ? "bg-emerald-50 text-emerald-700 border-emerald-100"
//                           : "bg-slate-50 text-slate-500 border-slate-200"
//                       }`}
//                     >
//                       {conv.within24h ? "24h window" : "Outside 24h"}
//                     </span>
//                     {conv.assignedToUserName && (
//                       <span className="text-[9px] text-slate-400">
//                         ðŸ‘¤ {conv.assignedToUserName}
//                       </span>
//                     )}
//                   </div>
//                 </div>
//               </div>
//             </button>
//           ))}
//         </div>
//       </div>

//       {/* ðŸ’¬ Middle: Chat window */}
//       <div className="flex-1 flex flex-col">
//         {/* Chat header */}
//         <div className="h-[64px] border-b border-slate-200 bg-white flex items-center justify-between px-4">
//           {selectedConversation ? (
//             <>
//               <div className="flex items-center gap-3">
//                 <div className="w-9 h-9 rounded-full bg-emerald-100 flex items-center justify-center text-xs font-semibold text-emerald-700">
//                   {getInitial(
//                     selectedConversation.contactName,
//                     selectedConversation.contactPhone
//                   )}
//                 </div>
//                 <div>
//                   <div className="flex items-center gap-2">
//                     <span className="text-sm font-semibold text-slate-800">
//                       {selectedConversation.contactName ||
//                         selectedConversation.contactPhone}
//                     </span>
//                     <span className="text-[11px] text-slate-400">
//                       {selectedConversation.contactPhone}
//                     </span>
//                   </div>
//                   <div className="flex items-center gap-3 text-[11px] text-slate-400 mt-0.5">
//                     <span className="flex items-center gap-1">
//                       <Clock className="w-3 h-3" />
//                       {selectedConversation.lastInboundAt
//                         ? formatDateTime(selectedConversation.lastInboundAt)
//                         : "Last inbound: -"}
//                     </span>
//                     <span className="flex items-center gap-1">
//                       <CheckCircle2 className="w-3 h-3" />
//                       {selectedConversation.status || "Open"}
//                     </span>
//                     <span
//                       className={`inline-flex items-center gap-1 px-2 py-[1px] rounded-full text-[10px] border ${
//                         isWithin24h
//                           ? "bg-emerald-50 text-emerald-700 border-emerald-200"
//                           : "bg-slate-50 text-slate-500 border-slate-200"
//                       }`}
//                     >
//                       <Clock className="w-3 h-3" />
//                       {isWithin24h ? "Within 24h" : "Outside 24h"}
//                     </span>
//                     <span className="inline-flex items-center gap-1 text-[11px] text-slate-500">
//                       <User className="w-3 h-3" />
//                       {headerIsAssigned
//                         ? headerIsAssignedToMe
//                           ? "Assigned to you"
//                           : `Assigned to ${headerAssignedName}`
//                         : "Unassigned"}
//                     </span>
//                   </div>
//                 </div>
//               </div>

//               <div className="flex items-center gap-2 text-[11px] text-slate-500">
//                 <span className="flex items-center gap-1">
//                   <MessageCircle className="w-3 h-3" />
//                   {selectedConversation.sourceName || "WhatsApp"}
//                 </span>
//                 <span className="flex items-center gap-1">
//                   <Mail className="w-3 h-3" />
//                   {selectedConversation.mode || "Live"}
//                 </span>

//                 {/* Assignment actions */}
//                 {!headerIsAssigned && currentUserId && (
//                   <button
//                     onClick={handleAssignToMe}
//                     disabled={isAssigning}
//                     className={`ml-2 px-2 py-[2px] rounded-full border text-[11px] ${
//                       isAssigning
//                         ? "border-emerald-300 text-emerald-400 cursor-wait"
//                         : "border-emerald-500 text-emerald-600 hover:bg-emerald-50"
//                     }`}
//                   >
//                     {isAssigning ? "Assigningâ€¦" : "Assign to me"}
//                   </button>
//                 )}

//                 {headerIsAssignedToMe && (
//                   <button
//                     onClick={handleUnassign}
//                     disabled={isAssigning}
//                     className={`ml-1 px-2 py-[2px] rounded-full border text-[11px] ${
//                       isAssigning
//                         ? "border-slate-300 text-slate-400 cursor-wait"
//                         : "border-slate-300 text-slate-600 hover:bg-slate-50"
//                     }`}
//                   >
//                     {isAssigning ? "Updatingâ€¦" : "Unassign"}
//                   </button>
//                 )}

//                 <button
//                   onClick={() => setShowRightPanel(v => !v)}
//                   className="ml-2 text-xs text-purple-600 hover:text-purple-700"
//                 >
//                   {showRightPanel ? "Hide details" : "Show details"}
//                 </button>
//               </div>
//             </>
//           ) : (
//             <div className="text-xs text-slate-400">
//               Select a conversation to start chatting.
//             </div>
//           )}
//         </div>

//         {/* Chat messages area */}
//         <div className="flex-1 overflow-y-auto bg-slate-50 px-4 py-3">
//           {!selectedConversation && (
//             <div className="h-full flex items-center justify-center text-xs text-slate-400">
//               No conversation selected.
//             </div>
//           )}

//           {selectedConversation && (
//             <div className="flex flex-col gap-2 text-xs">
//               {isMessagesLoading && (
//                 <div className="text-slate-400">Loading messagesâ€¦</div>
//               )}

//               {!isMessagesLoading && messages.length === 0 && (
//                 <div className="text-slate-400 italic">
//                   No messages yet for this contact.
//                 </div>
//               )}

//               {!isMessagesLoading &&
//                 messagesWithSeparators.length > 0 &&
//                 messagesWithSeparators.map(item => {
//                   if (item.type === "separator") {
//                     return (
//                       <div key={item.id} className="flex justify-center my-2">
//                         <span className="px-3 py-0.5 rounded-full bg-slate-100 text-[10px] text-slate-500">
//                           {item.label}
//                         </span>
//                       </div>
//                     );
//                   }

//                   const msg = item;
//                   const isInbound = !!msg.isInbound;

//                   return (
//                     <div
//                       key={msg.id}
//                       className={`flex ${
//                         isInbound ? "justify-start" : "justify-end"
//                       }`}
//                     >
//                       <div
//                         className={`max-w-[70%] rounded-lg px-3 py-2 shadow-sm ${
//                           isInbound
//                             ? "bg-white text-slate-800"
//                             : "bg-purple-600 text-white"
//                         }`}
//                       >
//                         <div className="whitespace-pre-wrap break-words">
//                           {msg.text || "-"}
//                         </div>
//                         <div className="mt-1 text-[10px] opacity-75 flex items-center justify-end gap-1">
//                           {msg.sentAt &&
//                             new Date(msg.sentAt).toLocaleTimeString([], {
//                               hour: "2-digit",
//                               minute: "2-digit",
//                             })}
//                           <StatusIcon status={msg.status} />
//                           {msg.status && <span>{msg.status}</span>}
//                         </div>
//                         {msg.errorMessage && (
//                           <div className="mt-0.5 text-[10px] text-rose-200">
//                             {msg.errorMessage}
//                           </div>
//                         )}
//                       </div>
//                     </div>
//                   );
//                 })}

//               <div ref={messagesEndRef} />
//             </div>
//           )}
//         </div>

//         {/* Chat input */}
//         <div className="border-t border-slate-200 bg-white px-4 py-3">
//           {selectedConversation && !isWithin24h && (
//             <div className="text-[11px] text-amber-600 mb-2">
//               This conversation is{" "}
//               <span className="font-semibold">outside</span> the 24-hour
//               WhatsApp window. Free-form replies are disabled here. Use approved
//               templates (campaigns / flows) to re-engage.
//             </div>
//           )}

//           <div className="flex items-center gap-2">
//             <textarea
//               rows={1}
//               value={newMessage}
//               onChange={e => setNewMessage(e.target.value)}
//               onKeyDown={handleComposerKeyDown}
//               placeholder={
//                 selectedConversation
//                   ? isWithin24h
//                     ? "Type a replyâ€¦"
//                     : "24h window expired â€“ send via template campaign."
//                   : "Select a conversation first."
//               }
//               disabled={!selectedConversation || !isWithin24h || isSending}
//               className={`flex-1 resize-none border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-purple-500 focus:border-purple-500 ${
//                 !selectedConversation || !isWithin24h
//                   ? "bg-slate-50 text-slate-400 cursor-not-allowed"
//                   : "bg-white"
//               }`}
//             />
//             <button
//               onClick={handleSendMessage}
//               disabled={
//                 isSending ||
//                 !newMessage.trim() ||
//                 !selectedConversation ||
//                 !isWithin24h
//               }
//               className={`bg-purple-600 text-white text-sm font-medium px-4 py-2 rounded-lg shadow-sm ${
//                 isSending ||
//                 !newMessage.trim() ||
//                 !selectedConversation ||
//                 !isWithin24h
//                   ? "opacity-60 cursor-not-allowed"
//                   : "hover:bg-purple-700"
//               }`}
//             >
//               {isSending ? "Sending..." : "Send"}
//             </button>
//           </div>
//         </div>
//       </div>

//       {/* ðŸ“‡ Right: CRM + details */}
//       {showRightPanel && (
//         <div className="w-80 border-l border-slate-200 bg-white flex flex-col">
//           {/* Top section: summary */}
//           <div className="px-4 py-3 border-b border-slate-200 flex items-center justify-between">
//             <div className="flex items-center gap-2">
//               <User className="w-4 h-4 text-slate-500" />
//               <span className="text-xs font-semibold text-slate-800">
//                 Contact & CRM
//               </span>
//             </div>
//             <button
//               onClick={() => setShowDetails(v => !v)}
//               className="text-[11px] text-slate-500 hover:text-slate-700 flex items-center gap-1"
//             >
//               {showDetails ? "Hide" : "Show"}
//               {showDetails ? (
//                 <ChevronDown className="w-3 h-3" />
//               ) : (
//                 <ChevronRight className="w-3 h-3" />
//               )}
//             </button>
//           </div>

//           {/* Contact + CRM summary */}
//           {showDetails && (
//             <div className="p-4 text-xs text-slate-600 space-y-3 overflow-y-auto">
//               {selectedConversation ? (
//                 <>
//                   {/* Basic identity */}
//                   <div>
//                     <div className="font-semibold text-slate-800 mb-0.5">
//                       {selectedConversation.contactName ||
//                         selectedConversation.contactPhone ||
//                         "Unknown contact"}
//                     </div>
//                     <div className="text-slate-500">
//                       {selectedConversation.contactPhone}
//                     </div>
//                     {contactSummary?.leadSource && (
//                       <div className="text-[11px] text-slate-400 mt-0.5">
//                         Lead source:{" "}
//                         <span className="text-slate-600">
//                           {contactSummary.leadSource}
//                         </span>
//                       </div>
//                     )}
//                   </div>

//                   {/* High-level stats */}
//                   <div className="grid grid-cols-2 gap-2 text-[11px]">
//                     <div className="bg-slate-50 rounded-md p-2">
//                       <div className="text-slate-400">First seen</div>
//                       <div className="font-medium">
//                         {formatDateTime(selectedConversation.firstSeenAt)}
//                       </div>
//                     </div>
//                     <div className="bg-slate-50 rounded-md p-2">
//                       <div className="text-slate-400">Last inbound</div>
//                       <div className="font-medium">
//                         {formatDateTime(selectedConversation.lastInboundAt)}
//                       </div>
//                     </div>
//                     <div className="bg-slate-50 rounded-md p-2">
//                       <div className="text-slate-400">Last outbound</div>
//                       <div className="font-medium">
//                         {formatDateTime(selectedConversation.lastOutboundAt)}
//                       </div>
//                     </div>
//                     <div className="bg-slate-50 rounded-md p-2">
//                       <div className="text-slate-400">Status</div>
//                       <div className="font-medium">
//                         {selectedConversation.status || "Open"}
//                       </div>
//                     </div>
//                   </div>

//                   {/* Divider */}
//                   <div className="h-px bg-slate-200 my-2" />

//                   {/* CRM summary details */}
//                   {isSummaryLoading && (
//                     <div className="text-[11px] text-slate-400">
//                       Loading CRM dataâ€¦
//                     </div>
//                   )}

//                   {!isSummaryLoading && !contactSummary && (
//                     <div className="text-[11px] text-slate-400 italic">
//                       No CRM data yet. Add a note or reminder from the CRM
//                       workspace to enrich this contact.
//                     </div>
//                   )}

//                   {!isSummaryLoading && contactSummary && (
//                     <>
//                       {/* Tags */}
//                       <div>
//                         <div className="flex items-center justify-between mb-1">
//                           <div className="flex items-center gap-1">
//                             <Tag className="w-3 h-3 text-slate-400" />
//                             <span className="font-semibold text-[11px] text-slate-700">
//                               Tags
//                             </span>
//                           </div>
//                         </div>
//                         <div className="flex flex-wrap gap-1">
//                           {tagsList.length > 0 ? (
//                             tagsList.map((tag, index) => (
//                               <span
//                                 key={index}
//                                 className="px-2 py-0.5 text-[10px] rounded-full font-medium border border-slate-200"
//                                 style={{
//                                   backgroundColor: tag.colorHex || "#EEF2FF",
//                                 }}
//                               >
//                                 {tag.tagName || tag.name || "Tag"}
//                               </span>
//                             ))
//                           ) : (
//                             <span className="text-[11px] text-slate-400">
//                               No tags yet.
//                             </span>
//                           )}
//                         </div>
//                       </div>

//                       {/* Next reminder */}
//                       <div>
//                         <div className="flex items-center justify-between mb-1">
//                           <div className="flex items-center gap-1">
//                             <Bell className="w-3 h-3 text-slate-400" />
//                             <span className="font-semibold text-[11px] text-slate-700">
//                               Next reminder
//                             </span>
//                           </div>
//                         </div>
//                         {nextReminder ? (
//                           <div className="bg-amber-50 border border-amber-100 rounded-md p-2">
//                             <div className="flex items-center justify-between">
//                               <span className="text-[11px] font-semibold text-amber-800">
//                                 {nextReminder.title}
//                               </span>
//                               <span className="text-[10px] text-amber-700">
//                                 {formatDateTime(nextReminder.dueAt)}
//                               </span>
//                             </div>
//                             {nextReminder.description && (
//                               <div className="mt-0.5 text-[11px] text-amber-900">
//                                 {nextReminder.description}
//                               </div>
//                             )}
//                             {nextReminder.status && (
//                               <div className="mt-0.5 text-[10px] text-amber-700">
//                                 Status: {nextReminder.status}
//                               </div>
//                             )}
//                           </div>
//                         ) : (
//                           <span className="text-[11px] text-slate-400">
//                             No upcoming reminder for this contact.
//                           </span>
//                         )}
//                       </div>

//                       {/* Recent notes */}
//                       <div>
//                         <div className="flex items-center justify-between mb-1">
//                           <div className="flex items-center gap-1">
//                             <StickyNote className="w-3 h-3 text-slate-400" />
//                             <span className="font-semibold text-[11px] text-slate-700">
//                               Recent notes
//                             </span>
//                           </div>
//                         </div>
//                         {recentNotes.length > 0 ? (
//                           <div className="space-y-1.5">
//                             {recentNotes.map(note => (
//                               <div
//                                 key={note.id}
//                                 className="bg-slate-50 border border-slate-100 rounded-md p-2"
//                               >
//                                 <div className="text-[11px] text-slate-700">
//                                   {note.content || note.text || "(no content)"}
//                                 </div>
//                                 <div className="mt-0.5 text-[10px] text-slate-400 flex justify-between">
//                                   <span>
//                                     {note.createdByName ||
//                                       note.createdBy ||
//                                       "Agent"}
//                                   </span>
//                                   <span>
//                                     {note.createdAt
//                                       ? new Date(
//                                           note.createdAt
//                                         ).toLocaleString()
//                                       : ""}
//                                   </span>
//                                 </div>
//                               </div>
//                             ))}
//                           </div>
//                         ) : (
//                           <span className="text-[11px] text-slate-400">
//                             No notes yet.
//                           </span>
//                         )}
//                       </div>

//                       {/* Recent timeline */}
//                       <div>
//                         <div className="flex items-center justify-between mb-1">
//                           <div className="flex items-center gap-1">
//                             <Activity className="w-3 h-3 text-slate-400" />
//                             <span className="font-semibold text-[11px] text-slate-700">
//                               Recent activity
//                             </span>
//                           </div>
//                         </div>
//                         {recentTimeline.length > 0 ? (
//                           <div className="space-y-1.5">
//                             {recentTimeline.map(event => (
//                               <div
//                                 key={event.id}
//                                 className="bg-slate-50 border border-slate-100 rounded-md p-2"
//                               >
//                                 <div className="text-[11px] text-slate-700">
//                                   {event.title ||
//                                     event.shortDescription ||
//                                     event.description ||
//                                     "Activity"}
//                                 </div>
//                                 <div className="mt-0.5 text-[10px] text-slate-400 flex justify-between">
//                                   <span>
//                                     {event.source ||
//                                       event.category ||
//                                       event.eventType ||
//                                       ""}
//                                   </span>
//                                   <span>
//                                     {event.createdAt
//                                       ? new Date(
//                                           event.createdAt
//                                         ).toLocaleString()
//                                       : ""}
//                                   </span>
//                                 </div>
//                               </div>
//                             ))}
//                           </div>
//                         ) : (
//                           <span className="text-[11px] text-slate-400">
//                             No recent activity logged yet.
//                           </span>
//                         )}
//                       </div>
//                     </>
//                   )}
//                 </>
//               ) : (
//                 <div className="text-slate-400 italic">
//                   Select a conversation to see CRM info.
//                 </div>
//               )}
//             </div>
//           )}

//           {/* CRM panel placeholder / footer */}
//           {showCrmPanel && (
//             <div className="border-t border-slate-200 p-3 text-[11px] text-slate-500">
//               This mini-CRM view uses your existing Contacts, Tags, Notes,
//               Reminders, and Timeline data. A dedicated full CRM workspace can
//               later reuse the same summary component for deeper editing.
//             </div>
//           )}
//         </div>
//       )}
//     </div>
//   );
// }

// // ðŸ“„ src/pages/chatInbox/ChatInbox.jsx
// import React, { useState, useMemo } from "react";
// import { ConversationList } from "./components/ConversationList";
// import { ChatHeader } from "./components/ChatHeader";
// import { MessageList } from "./components/MessageList";
// import { MessageComposer } from "./components/MessageComposer";
// import { ContactDetailsPanel } from "./components/ContactDetailsPanel";
// import { EmptyState } from "./components/EmptyState";

// // ðŸ’¡ Mock numbers â€“ later from API
// const MOCK_NUMBERS = [
//   { id: "wa-num-1", displayPhoneNumber: "+91 89740 05240", label: "Sales" },
//   { id: "wa-num-2", displayPhoneNumber: "+91 98765 43210", label: "Support" },
// ];

// // ðŸ’¡ Mock conversations shaped close to backend contract
// const INITIAL_CONVERSATIONS = [
//   {
//     id: "conv-1",
//     contactName: "Rahul Sharma",
//     contactPhone: "+91 98765 11111",
//     lastMessagePreview: "Hi, I want to know the price of hair oil.",
//     lastMessageAt: "2025-11-25T10:31:00Z",
//     unreadCount: 2,
//     status: "New",
//     numberId: "wa-num-1",
//     numberLabel: "Sales",
//     within24h: true,
//     assignedToUserId: null,
//     assignedToUserName: null,
//     isAssignedToMe: false,
//     mode: "automation",
//     sourceType: "AutoReply",
//     sourceName: "Hair Oil Pricing",
//     firstSeenAt: "2025-11-25T10:29:00Z",
//     totalMessages: 3,
//     lastAgentReplyAt: null,
//     lastAutomationAt: "2025-11-25T10:32:00Z",
//   },
//   {
//     id: "conv-2",
//     contactName: "Neha Gupta",
//     contactPhone: "+91 98765 22222",
//     lastMessagePreview: "Thanks, I will place the order.",
//     lastMessageAt: "2025-11-25T09:50:00Z",
//     unreadCount: 0,
//     status: "Open",
//     numberId: "wa-num-1",
//     numberLabel: "Sales",
//     within24h: true,
//     assignedToUserId: "me",
//     assignedToUserName: "You",
//     isAssignedToMe: true,
//     mode: "agent",
//     sourceType: "Campaign",
//     sourceName: "Diwali Blast â€“ Hair Oil",
//     firstSeenAt: "2025-11-24T18:00:00Z",
//     totalMessages: 5,
//     lastAgentReplyAt: "2025-11-25T09:50:00Z",
//     lastAutomationAt: "2025-11-24T18:01:00Z",
//   },
//   {
//     id: "conv-3",
//     contactName: "Rohan Verma",
//     contactPhone: "+91 98765 33333",
//     lastMessagePreview: "Is cash on delivery available?",
//     lastMessageAt: "2025-11-25T09:05:00Z",
//     unreadCount: 1,
//     status: "Pending",
//     numberId: "wa-num-2",
//     numberLabel: "Support",
//     within24h: false,
//     assignedToUserId: "u-priya",
//     assignedToUserName: "Priya",
//     isAssignedToMe: false,
//     mode: "automation",
//     sourceType: "Manual",
//     sourceName: null,
//     firstSeenAt: "2025-11-23T12:20:00Z",
//     totalMessages: 9,
//     lastAgentReplyAt: "2025-11-24T11:10:00Z",
//     lastAutomationAt: "2025-11-25T08:55:00Z",
//   },
// ];

// // ðŸ’¡ Mock messages
// const MOCK_MESSAGES_BY_CONV = {
//   "conv-2": [
//     {
//       id: "m1",
//       direction: "in",
//       text: "Hi, is the hair oil still available?",
//       sentAt: "2025-11-24T18:00:00Z",
//     },
//     {
//       id: "m2",
//       direction: "automation",
//       text: "Automation â€¢ Campaign: Diwali Blast â€“ Hair Oil (template sent)",
//       sentAt: "2025-11-24T18:01:00Z",
//     },
//     {
//       id: "m3",
//       direction: "out",
//       senderName: "You",
//       text: "Yes, it is in stock. You can place your order anytime.",
//       sentAt: "2025-11-24T18:05:00Z",
//     },
//     {
//       id: "m4",
//       direction: "in",
//       text: "Thanks, I will place the order.",
//       sentAt: "2025-11-25T09:50:00Z",
//     },
//   ],
//   // other conversations omitted for brevityâ€¦
// };

// function ChatInbox() {
//   const [activeTab, setActiveTab] = useState("live"); // live | history | unassigned | my
//   const [selectedNumberId, setSelectedNumberId] = useState("all");
//   const [searchTerm, setSearchTerm] = useState("");
//   const [selectedConversationId, setSelectedConversationId] = useState(
//     INITIAL_CONVERSATIONS[1]?.id ?? null
//   );
//   const [allConversations, setAllConversations] = useState(
//     INITIAL_CONVERSATIONS
//   );

//   // ðŸ”¢ Tab counters â€“ from ALL conversations
//   const tabCounts = useMemo(
//     () => ({
//       live: allConversations.filter(c => c.within24h).length,
//       history: allConversations.filter(c => !c.within24h).length,
//       unassigned: allConversations.filter(
//         c => !c.assignedToUserId && !c.assignedToUserName
//       ).length,
//       my: allConversations.filter(c => c.isAssignedToMe).length,
//     }),
//     [allConversations]
//   );

//   // Filtered list for left column
//   const conversations = useMemo(() => {
//     let list = [...allConversations];

//     if (selectedNumberId !== "all") {
//       list = list.filter(c => c.numberId === selectedNumberId);
//     }

//     if (activeTab === "live") {
//       list = list.filter(c => c.within24h);
//     } else if (activeTab === "history") {
//       list = list.filter(c => !c.within24h);
//     } else if (activeTab === "unassigned") {
//       list = list.filter(c => !c.assignedToUserId && !c.assignedToUserName);
//     } else if (activeTab === "my") {
//       list = list.filter(c => c.isAssignedToMe);
//     }

//     if (searchTerm.trim()) {
//       const term = searchTerm.toLowerCase();
//       list = list.filter(
//         c =>
//           c.contactName.toLowerCase().includes(term) ||
//           c.contactPhone.toLowerCase().includes(term) ||
//           c.lastMessagePreview.toLowerCase().includes(term)
//       );
//     }

//     return list;
//   }, [activeTab, selectedNumberId, searchTerm, allConversations]);

//   const selectedConversation = useMemo(
//     () => allConversations.find(c => c.id === selectedConversationId) || null,
//     [allConversations, selectedConversationId]
//   );

//   const messages =
//     (selectedConversation && MOCK_MESSAGES_BY_CONV[selectedConversation.id]) ||
//     [];

//   // === Actions (later go to API) ===

//   const handleSendMessage = text => {
//     if (!selectedConversation) return;
//     console.log("Send free-form message", {
//       convId: selectedConversation.id,
//       text,
//     });
//   };

//   const handleSendTemplate = () => {
//     if (!selectedConversation) return;
//     console.log("Open template picker for conv", selectedConversation.id);
//   };

//   const handleAssignToMe = () => {
//     if (!selectedConversation) return;
//     setAllConversations(prev =>
//       prev.map(c =>
//         c.id === selectedConversation.id
//           ? {
//               ...c,
//               assignedToUserId: "me",
//               assignedToUserName: "You",
//               isAssignedToMe: true,
//               status: c.status === "New" ? "Open" : c.status,
//             }
//           : c
//       )
//     );
//   };

//   const handleToggleMode = () => {
//     if (!selectedConversation) return;
//     setAllConversations(prev =>
//       prev.map(c =>
//         c.id === selectedConversation.id
//           ? {
//               ...c,
//               mode: c.mode === "automation" ? "agent" : "automation",
//             }
//           : c
//       )
//     );
//   };

//   return (
//     <div className="h-full flex flex-col p-4 space-y-4">
//       {/* Page title */}
//       <div>
//         <h1 className="text-2xl font-semibold text-gray-900">Inbox</h1>
//         <p className="text-sm text-gray-500">
//           Respond to WhatsApp messages, manage assignments, and track windows.
//         </p>
//       </div>

//       {/* Main 3-column layout */}
//       <div className="flex flex-1 gap-4 min-h-0">
//         {/* Left â€“ Conversation list */}
//         <ConversationList
//           activeTab={activeTab}
//           onTabChange={setActiveTab}
//           tabCounts={tabCounts}
//           numbers={MOCK_NUMBERS}
//           selectedNumberId={selectedNumberId}
//           onNumberChange={setSelectedNumberId}
//           conversations={conversations}
//           selectedConversationId={selectedConversationId}
//           onSelectConversation={setSelectedConversationId}
//           searchTerm={searchTerm}
//           onSearchChange={setSearchTerm}
//         />

//         {/* Middle â€“ Chat panel */}
//         <div className="flex flex-col flex-[2] bg-white rounded-2xl shadow-sm border border-gray-200 min-w-0">
//           {selectedConversation ? (
//             <>
//               <ChatHeader
//                 conversation={selectedConversation}
//                 onAssignToMe={handleAssignToMe}
//                 onToggleMode={handleToggleMode}
//               />
//               <MessageList messages={messages} />
//               <MessageComposer
//                 canSendFreeForm={selectedConversation.within24h}
//                 onSend={handleSendMessage}
//                 onSendTemplate={handleSendTemplate}
//               />
//             </>
//           ) : (
//             <EmptyState />
//           )}
//         </div>

//         {/* Right â€“ Contact / context panel */}
//         <ContactDetailsPanel conversation={selectedConversation} />
//       </div>
//     </div>
//   );
// }

// export default ChatInbox;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\ChatInbox\inboxModels.js 
====================================================== 
 
// ðŸ“„ src/pages/ChatInbox/inboxModels.js

/**
 * Conversation status as used in the Inbox UI.
 *
 * "New"     -> first contact / not yet handled
 * "Open"    -> active conversation, needs attention
 * "Pending" -> waiting on customer
 * "Closed"  -> resolved
 *
 * @typedef {"New" | "Open" | "Pending" | "Closed"} ConversationStatus
 */

/**
 * Conversation mode:
 *
 * "automation" -> bot / AutoReply / flows are allowed to respond
 * "agent"      -> human agent has taken over, bot should stay quiet
 *
 * @typedef {"automation" | "agent"} ConversationMode
 */

/**
 * Where this conversation primarily comes from.
 *
 * "AutoReply" -> triggered via keyword flows
 * "Campaign"  -> initiated by campaign / broadcast
 * "Manual"    -> purely agent-driven
 * "Unknown"   -> fallback when backend doesn't know yet
 *
 * @typedef {"AutoReply" | "Campaign" | "Manual" | "Unknown"} ConversationSourceType
 */

/**
 * Lightweight summary of a conversation used in:
 * - conversation list (left column)
 * - ChatHeader
 * - ContactDetailsPanel
 *
 * This is the *canonical* shape the front-end expects. All mocks and
 * future API responses should conform to this as much as possible.
 *
 * @typedef {Object} ConversationSummary
 * @property {string} id
 *
 * @property {string} contactId       - CRM Contact.Id (GUID as string)
 * @property {string} contactName
 * @property {string} contactPhone
 *
 * @property {string} lastMessagePreview - short text shown in the list
 * @property {string} lastMessageAt      - ISO string
 * @property {number} unreadCount
 *
 * @property {ConversationStatus} status
 * @property {string} numberId           - WhatsApp number id (wa-num-1 etc.)
 * @property {string} numberLabel        - "Sales", "Support", etc.
 * @property {boolean} within24h         - true if inside 24h session window
 *
 * @property {string | null} assignedToUserId
 * @property {string | null} assignedToUserName
 * @property {boolean} isAssignedToMe
 *
 * @property {ConversationMode} mode
 * @property {ConversationSourceType} sourceType
 * @property {string | null} sourceName - campaign name / flow name / note
 *
 * @property {string | null} firstSeenAt       - ISO
 * @property {number}        totalMessages
 * @property {string | null} lastAgentReplyAt  - ISO
 * @property {string | null} lastAutomationAt  - ISO
 */

/**
 * Allowed values for the little pills / dropdowns in UI.
 */
export const CONVERSATION_STATUSES = /** @type {ConversationStatus[]} */ ([
  "New",
  "Open",
  "Pending",
  "Closed",
]);

export const CONVERSATION_MODES = /** @type {ConversationMode[]} */ ([
  "automation",
  "agent",
]);

export const CONVERSATION_SOURCE_TYPES =
  /** @type {ConversationSourceType[]} */ ([
    "AutoReply",
    "Campaign",
    "Manual",
    "Unknown",
  ]);

/**
 * Direction of each chat bubble in the message list.
 *
 * "in"         -> customer message
 * "out"        -> agent message (you / teammate)
 * "automation" -> auto-reply / campaign / CTA flow
 * "system"     -> system notices ("conversation closed", etc.)
 *
 * @typedef {"in" | "out" | "automation" | "system"} MessageDirection
 */

/**
 * Single message item rendered in the middle panel.
 *
 * @typedef {Object} MessageItem
 * @property {string} id
 * @property {MessageDirection} direction
 * @property {string} text
 * @property {string} sentAt
 * @property {string | undefined} [senderName]
 */

/**
 * Factory to create a safe ConversationSummary object from a partial.
 *
 * @param {Partial<ConversationSummary>} partial
 * @returns {ConversationSummary}
 */
export function createConversationSummary(partial) {
  return {
    id: partial.id ?? "",

    contactId: partial.contactId ?? "", // ðŸ‘ˆ new
    contactName: partial.contactName ?? "",
    contactPhone: partial.contactPhone ?? "",

    lastMessagePreview: partial.lastMessagePreview ?? "",
    lastMessageAt: partial.lastMessageAt ?? new Date().toISOString(),
    unreadCount:
      typeof partial.unreadCount === "number" ? partial.unreadCount : 0,

    status: partial.status ?? "New",
    numberId: partial.numberId ?? "",
    numberLabel: partial.numberLabel ?? "",
    within24h: Boolean(partial.within24h),

    assignedToUserId:
      typeof partial.assignedToUserId === "string"
        ? partial.assignedToUserId
        : null,
    assignedToUserName:
      typeof partial.assignedToUserName === "string"
        ? partial.assignedToUserName
        : null,
    isAssignedToMe: Boolean(partial.isAssignedToMe),

    mode: partial.mode ?? "automation",
    sourceType: partial.sourceType ?? "Unknown",
    sourceName: partial.sourceName ?? null,

    firstSeenAt: partial.firstSeenAt ?? null,
    totalMessages:
      typeof partial.totalMessages === "number" ? partial.totalMessages : 0,
    lastAgentReplyAt: partial.lastAgentReplyAt ?? null,
    lastAutomationAt: partial.lastAutomationAt ?? null,
  };
}

/**
 * Helper to map a raw DTO from the backend into ConversationSummary.
 *
 * @param {any} dto - raw backend object
 * @param {string | null} currentUserId
 * @returns {ConversationSummary}
 */
export function mapConversationDtoToSummary(dto, currentUserId) {
  const summary = createConversationSummary({
    id: dto.id,

    contactId: dto.contactId, // ðŸ‘ˆ new
    contactName: dto.contactName,
    contactPhone: dto.contactPhone,

    lastMessagePreview: dto.lastMessagePreview,
    lastMessageAt: dto.lastMessageAt,

    unreadCount: dto.unreadCount,
    status: dto.status,
    numberId: dto.numberId,
    numberLabel: dto.numberLabel,
    within24h: dto.within24h,

    assignedToUserId: dto.assignedToUserId,
    assignedToUserName: dto.assignedToUserName,

    mode: dto.mode,
    sourceType: dto.sourceType,
    sourceName: dto.sourceName,

    firstSeenAt: dto.firstSeenAt,
    totalMessages: dto.totalMessages,
    lastAgentReplyAt: dto.lastAgentReplyAt,
    lastAutomationAt: dto.lastAutomationAt,
  });

  if (currentUserId) {
    summary.isAssignedToMe =
      summary.assignedToUserId != null &&
      summary.assignedToUserId === currentUserId;
  }

  return summary;
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\ChatInbox\MakeDump.bat 
====================================================== 
 
@echo off
REM This script will find relevant source files and output their names and contents into one file.
REM The output file will be named [FolderName]_AllFileDump.txt.

REM Get the current folder's name and set it as the output file name with the custom suffix
for %%I in ("%cd%") do set "outputFile=%%~nI_AllFileDump.txt"

REM Clear the output file to start fresh and write a small header
> "%outputFile%" (
    echo Folder and File Content Report
    echo Root folder: %cd%
    echo Generated at: %date% %time%
)
echo. >> "%outputFile%"

REM NOTE:
REM We now only dump RELEVANT text/code files (no binaries, no images, no node_modules, etc.)
REM This keeps the file smaller and much easier to review.

REM Loop through all relevant files in the current directory and subdirectories
REM Extensions included: C#, JS/TS/React, JSON, config, SQL, Markdown, YAML
for /R . %%F in (*.cs *.csproj *.jsx *.tsx *.js *.ts *.json *.config *.sql *.md *.yml *.yaml *.bat) do (

    REM Skip some noisy folders by path substring (node_modules, bin, obj, .git, dist, .vs)
    echo "%%F" | findstr /I /C:"\node_modules\" /C:"\bin\" /C:"\obj\" /C:"\.git\" /C:"\dist\" /C:"\.vs\" >nul
    if errorlevel 1 (
        echo ====================================================== >> "%outputFile%"
        echo FILE: %%F >> "%outputFile%"
        echo ====================================================== >> "%outputFile%"
        echo. >> "%outputFile%"
        type "%%F" >> "%outputFile%" 2>nul
        echo. >> "%outputFile%"
        echo. >> "%outputFile%"
    )
)

echo Finished! All content has been extracted to %outputFile%
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\ChatInbox\components\ChatHeader.jsx 
====================================================== 
 
// ðŸ“„ src/pages/chatInbox/components/ChatHeader.jsx
import React from "react";
import {
  Phone,
  MoreVertical,
  ShieldCheck,
  UserCheck,
  Bot,
  User,
  Clock,
} from "lucide-react";

export function ChatHeader({ conversation, onAssignToMe, onToggleMode }) {
  if (!conversation) return null;

  const isUnassigned =
    !conversation.assignedToUserId && !conversation.assignedToUserName;
  const isAssignedToMe = conversation.isAssignedToMe;
  const isAutomation = conversation.mode === "automation";
  const within24h = conversation.within24h;

  return (
    <div className="border-b border-gray-100 px-4 py-3 flex flex-col gap-2">
      {/* Top row: contact name + channel badge + phone */}
      <div className="flex items-center justify-between">
        <div className="min-w-0">
          <div className="flex items-center gap-2">
            <h2 className="text-sm font-semibold text-gray-900 truncate">
              {conversation.contactName}
            </h2>
            <span className="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-[10px] text-gray-600">
              WhatsApp
            </span>
          </div>
          <div className="flex items-center gap-3 text-[11px] text-gray-500 mt-0.5">
            <span className="inline-flex items-center gap-1 truncate">
              <Phone size={12} /> {conversation.contactPhone}
            </span>
            <span className="inline-flex items-center gap-1 text-emerald-600">
              <ShieldCheck size={12} />
              Customer
            </span>
          </div>
        </div>

        <button
          type="button"
          className="h-8 w-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-500"
        >
          <MoreVertical size={16} />
        </button>
      </div>

      {/* Second row: grouped chips */}
      <div className="flex flex-wrap items-center justify-between gap-3 text-[11px]">
        {/* Group 1: channel & line */}
        <div className="flex items-center gap-2">
          <span className="inline-flex items-center rounded-full bg-gray-50 px-2 py-0.5 text-[10px] text-gray-700 border border-gray-100">
            <Bot size={12} className="mr-1 text-gray-500" />
            WhatsApp line
          </span>
          <span className="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-[10px] text-gray-700">
            {conversation.numberLabel || "Default line"}
          </span>
        </div>

        {/* Group 2: assignment + mode */}
        <div className="flex items-center gap-3">
          {/* Assignment chip + button */}
          <div className="flex items-center gap-2">
            <span className="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-[10px] text-gray-700">
              <UserCheck size={12} className="mr-1 text-gray-500" />
              {isUnassigned
                ? "Unassigned"
                : isAssignedToMe
                ? "Assigned to you"
                : `Assigned to: ${conversation.assignedToUserName}`}
            </span>

            {isUnassigned && (
              <button
                type="button"
                onClick={onAssignToMe}
                className="inline-flex items-center rounded-full bg-emerald-500 text-white px-3 py-1 text-[11px] font-medium hover:bg-emerald-600"
              >
                <User size={12} className="mr-1" />
                Assign to me
              </button>
            )}
          </div>

          {/* Mode pill + toggle */}
          <div className="flex items-center gap-2">
            <span
              className={
                "inline-flex items-center rounded-full px-2 py-0.5 text-[10px] border " +
                (isAutomation
                  ? "bg-emerald-50 text-emerald-700 border-emerald-100"
                  : "bg-emerald-600 text-white border-emerald-600")
              }
            >
              {isAutomation ? (
                <>
                  <Bot size={12} className="mr-1" /> Automation
                </>
              ) : (
                <>
                  <User size={12} className="mr-1" /> Agent
                </>
              )}
            </span>

            <button
              type="button"
              onClick={onToggleMode}
              className="inline-flex items-center text-[11px] text-purple-600 hover:text-purple-700 underline-offset-2 hover:underline"
            >
              {isAutomation ? (
                <>Take over as agent</>
              ) : (
                <>Return to automation</>
              )}
            </button>
          </div>
        </div>

        {/* Group 3: 24h service window */}
        <div className="flex items-center gap-2">
          <span
            className={
              "inline-flex items-center rounded-full px-2 py-0.5 text-[10px] border " +
              (within24h
                ? "bg-emerald-50 text-emerald-700 border-emerald-100"
                : "bg-amber-50 text-amber-700 border-amber-200")
            }
          >
            <Clock
              size={12}
              className={
                within24h ? "mr-1 text-emerald-500" : "mr-1 text-amber-500"
              }
            />
            {within24h
              ? "Within 24h service window"
              : "24h service window expired"}
          </span>
        </div>
      </div>
    </div>
  );
}

// // ðŸ“„ src/pages/chatInbox/components/ChatHeader.jsx
// import React from "react";
// import {
//   Phone,
//   MoreVertical,
//   ShieldCheck,
//   UserCheck,
//   Bot,
//   User,
// } from "lucide-react";

// export function ChatHeader({ conversation, onAssignToMe, onToggleMode }) {
//   if (!conversation) return null;

//   const isUnassigned =
//     !conversation.assignedToUserId && !conversation.assignedToUserName;
//   const isAssignedToMe = conversation.isAssignedToMe;
//   const isAutomation = conversation.mode === "automation";

//   return (
//     <div className="flex items-center justify-between px-4 py-3 border-b border-gray-100">
//       {/* Left â€“ contact + line */}
//       <div className="flex items-center gap-3">
//         <div className="h-9 w-9 rounded-full bg-gradient-to-tr from-emerald-500 to-teal-500 flex items-center justify-center text-xs font-semibold text-white">
//           {conversation.contactName?.[0] || "?"}
//         </div>
//         <div>
//           <div className="flex items-center gap-2">
//             <h2 className="text-sm font-semibold text-gray-900">
//               {conversation.contactName}
//             </h2>
//             <span className="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-[10px] text-gray-600">
//               WhatsApp
//             </span>
//           </div>
//           <div className="flex items-center gap-3 text-[11px] text-gray-500">
//             <span className="inline-flex items-center gap-1">
//               <Phone size={12} /> {conversation.contactPhone}
//             </span>
//             <span className="inline-flex items-center gap-1">
//               <ShieldCheck size={12} className="text-emerald-500" />
//               {conversation.numberLabel} line
//             </span>
//           </div>
//         </div>
//       </div>

//       {/* Right â€“ grouped chips */}
//       <div className="flex items-center gap-4 text-[11px]">
//         {/* Group 1: assignment */}
//         <div className="flex items-center gap-2">
//           <span className="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-[10px] text-gray-700">
//             <UserCheck size={12} className="mr-1 text-gray-500" />
//             {isUnassigned
//               ? "Unassigned"
//               : isAssignedToMe
//               ? "Assigned to you"
//               : `Assigned to: ${conversation.assignedToUserName}`}
//           </span>

//           {isUnassigned && (
//             <button
//               onClick={onAssignToMe}
//               className="inline-flex items-center rounded-full bg-emerald-500 text-white px-3 py-1 text-[11px] font-medium hover:bg-emerald-600"
//             >
//               <User size={12} className="mr-1" />
//               Assign to me
//             </button>
//           )}
//         </div>

//         {/* Group 2: mode (automation / agent) */}
//         <div className="flex items-center gap-2">
//           <span
//             className={
//               "inline-flex items-center rounded-full px-2 py-0.5 text-[10px] border " +
//               (isAutomation
//                 ? "bg-emerald-50 text-emerald-700 border-emerald-100"
//                 : "bg-emerald-600 text-white border-emerald-600")
//             }
//           >
//             {isAutomation ? (
//               <>
//                 <Bot size={12} className="mr-1" /> Automation
//               </>
//             ) : (
//               <>
//                 <User size={12} className="mr-1" /> Agent
//               </>
//             )}
//           </span>

//           {isAssignedToMe && (
//             <button
//               onClick={onToggleMode}
//               className="inline-flex items-center rounded-full border border-emerald-200 px-2 py-0.5 text-[10px] text-emerald-700 hover:bg-emerald-50"
//             >
//               <Bot size={11} className="mr-1" />
//               {isAutomation ? "Take over (pause bot)" : "Back to automation"}
//             </button>
//           )}
//         </div>

//         {/* Group 3: 24h window */}
//         <span
//           className={
//             "inline-flex items-center rounded-full px-2 py-0.5 text-[10px] border " +
//             (conversation.within24h
//               ? "bg-green-50 text-green-700 border-green-100"
//               : "bg-amber-50 text-amber-700 border-amber-100")
//           }
//         >
//           {conversation.within24h ? "Within 24h window" : "24h window expired"}
//         </span>

//         <button className="rounded-full border border-gray-200 p-1.5 hover:bg-gray-50">
//           <MoreVertical size={16} className="text-gray-500" />
//         </button>
//       </div>
//     </div>
//   );
// }

// // ðŸ“„ src/pages/chatInbox/components/ChatHeader.jsx
// import React from "react";
// import {
//   Phone,
//   MoreVertical,
//   ShieldCheck,
//   UserCheck,
//   Bot,
//   User,
// } from "lucide-react";

// export function ChatHeader({ conversation, onAssignToMe, onToggleMode }) {
//   if (!conversation) return null;

//   const isUnassigned = !conversation.assignedToName;
//   const isAssignedToMe = conversation.assignedToMe;
//   const isAutomation = conversation.mode === "automation";

//   return (
//     <div className="flex items-center justify-between px-4 py-3 border-b border-gray-100">
//       {/* Left side â€“ contact & number */}
//       <div className="flex items-center gap-3">
//         <div className="h-9 w-9 rounded-full bg-gradient-to-tr from-emerald-500 to-indigo-500 flex items-center justify-center text-xs font-semibold text-white">
//           {conversation.contactName?.[0] || "?"}
//         </div>
//         <div>
//           <div className="flex items-center gap-2">
//             <h2 className="text-sm font-semibold text-gray-900">
//               {conversation.contactName}
//             </h2>
//             <span className="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-[10px] text-gray-600">
//               WhatsApp
//             </span>
//           </div>
//           <div className="flex items-center gap-3 text-[11px] text-gray-500">
//             <span className="inline-flex items-center gap-1">
//               <Phone size={12} /> {conversation.contactPhone}
//             </span>
//             <span className="inline-flex items-center gap-1">
//               <ShieldCheck size={12} className="text-purple-500" />
//               {conversation.numberLabel} line
//             </span>
//           </div>
//         </div>
//       </div>

//       {/* Right side â€“ assignment, mode, window, menu */}
//       <div className="flex items-center gap-3 text-[11px]">
//         {/* Assignment pill */}
//         <div className="flex items-center gap-2">
//           <span className="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-[10px] text-gray-700">
//             <UserCheck size={12} className="mr-1 text-gray-500" />
//             {isUnassigned
//               ? "Unassigned"
//               : isAssignedToMe
//               ? "Assigned to you"
//               : `Assigned to: ${conversation.assignedToName}`}
//           </span>

//           {isUnassigned && (
//             <button
//               onClick={onAssignToMe}
//               className="inline-flex items-center rounded-full bg-emerald-500 text-white px-3 py-1 text-[11px] font-medium hover:bg-emerald-600"
//             >
//               <User size={12} className="mr-1" />
//               Assign to me
//             </button>
//           )}
//         </div>

//         {/* Mode pill + toggle */}
//         <div className="flex items-center gap-1">
//           <span
//             className={`inline-flex items-center rounded-full px-2 py-0.5 text-[10px] border ${
//               isAutomation
//                 ? "bg-emerald-50 text-emerald-700 border-emerald-100"
//                 : "bg-emerald-600 text-white border-emerald-600"
//             }`}
//           >
//             {isAutomation ? (
//               <>
//                 <Bot size={12} className="mr-1" /> Automation
//               </>
//             ) : (
//               <>
//                 <User size={12} className="mr-1" /> Agent
//               </>
//             )}
//           </span>

//           {/* Only allow mode toggle when the chat is assigned to current user
//               (later backend will enforce this too) */}
//           {isAssignedToMe && (
//             <button
//               onClick={onToggleMode}
//               className="text-[10px] text-purple-700 font-medium underline decoration-dotted underline-offset-2"
//             >
//               {isAutomation ? "Take over (pause bot)" : "Back to automation"}
//             </button>
//           )}
//         </div>

//         {/* 24-hour window indicator */}
//         <span
//           className={`inline-flex items-center rounded-full px-2 py-0.5 text-[10px] ${
//             conversation.within24h
//               ? "bg-green-50 text-green-700 border border-green-100"
//               : "bg-amber-50 text-amber-700 border border-amber-100"
//           }`}
//         >
//           {conversation.within24h ? "Within 24h window" : "24h window expired"}
//         </span>

//         <button className="rounded-full border border-gray-200 p-1.5 hover:bg-gray-50">
//           <MoreVertical size={16} className="text-gray-500" />
//         </button>
//       </div>
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\ChatInbox\components\ContactDetailsPanel.jsx 
====================================================== 
 
// ðŸ“„ src/pages/ChatInbox/components/ContactDetailsPanel.jsx
import React from "react";
import { User, Tag, Clock, Phone, Bot, MessageSquare } from "lucide-react";
import { RecentActivityTimeline } from "./RecentActivityTimeline";

// Small formatter helpers â€“ later you can centralize these
function formatDateTime(value) {
  if (!value) return "-";
  try {
    const d = new Date(value);
    return d.toLocaleString();
  } catch {
    return value;
  }
}

export function ContactDetailsPanel({ conversation }) {
  if (!conversation) {
    return (
      <div className="w-80 bg-white rounded-2xl shadow-sm border border-gray-200 p-4 min-w-[260px] flex flex-col">
        <div className="flex-1 flex items-center justify-center text-xs text-gray-400 text-center px-3">
          Select a conversation to view contact details and activity.
        </div>
      </div>
    );
  }

  const modeLabel =
    conversation.mode === "automation" ? "Automation" : "Agent handover";

  // Fake tags for now â€“ later youâ€™ll bind real contact tags from backend
  const fakeTags = ["High intent", "Hair care", "WhatsApp lead"];

  // Build â€œsourceâ€ line
  let sourceLine = "Source: -";
  if (conversation.sourceType === "Campaign" && conversation.sourceName) {
    sourceLine = `Source: Campaign â€“ ${conversation.sourceName}`;
  } else if (
    conversation.sourceType === "AutoReply" &&
    conversation.sourceName
  ) {
    sourceLine = `Source: AutoReply â€“ ${conversation.sourceName}`;
  } else if (conversation.sourceType === "Manual") {
    sourceLine = "Source: Manual WhatsApp chat";
  }

  const assignedLabel = conversation.assignedToUserName || "Unassigned";

  return (
    <div className="w-80 bg-white rounded-2xl shadow-sm border border-gray-200 p-4 min-w-[260px] flex flex-col">
      {/* Header: avatar + name + phone */}
      <div className="flex items-center gap-3 pb-3 border-b border-gray-100">
        <div className="h-9 w-9 rounded-full bg-gradient-to-tr from-emerald-500 to-emerald-700 flex items-center justify-center text-xs font-semibold text-white">
          {conversation.contactName?.[0] || "?"}
        </div>
        <div>
          <div className="text-sm font-semibold text-gray-900">
            {conversation.contactName || "Unknown contact"}
          </div>
          <div className="text-[11px] text-gray-500 flex items-center gap-1">
            <Phone size={12} /> {conversation.contactPhone || "-"}
          </div>
        </div>
      </div>

      {/* Body sections */}
      <div className="mt-3 space-y-4 text-[11px] text-gray-600 flex-1 overflow-y-auto pr-1">
        {/* Conversation status / meta */}
        <div>
          <div className="font-semibold text-gray-800 mb-1 flex items-center gap-1">
            <MessageSquare size={12} /> Conversation
          </div>

          <div className="flex items-center justify-between py-0.5">
            <span>Status</span>
            <span className="font-medium">{conversation.status || "-"}</span>
          </div>

          <div className="flex items-center justify-between py-0.5">
            <span>Assigned to</span>
            <span className="font-medium">{assignedLabel}</span>
          </div>

          <div className="flex items-center justify-between py-0.5">
            <span>Mode</span>
            <span className="font-medium flex items-center gap-1">
              <Bot
                size={12}
                className={
                  conversation.mode === "automation"
                    ? "text-emerald-600"
                    : "text-gray-500"
                }
              />
              {modeLabel}
            </span>
          </div>

          <div className="flex items-center justify-between py-0.5">
            <span>24h window</span>
            <span
              className={
                "font-medium " +
                (conversation.within24h ? "text-emerald-600" : "text-amber-600")
              }
            >
              {conversation.within24h ? "Active" : "Expired"}
            </span>
          </div>

          <div className="space-y-1 mt-1">
            <div className="flex items-center justify-between">
              <span>First seen</span>
              <span className="font-medium">
                {formatDateTime(conversation.firstSeenAt)}
              </span>
            </div>
            <div className="flex items-center justify-between">
              <span>Total messages</span>
              <span className="font-medium">
                {conversation.totalMessages ?? "-"}
              </span>
            </div>
            <div className="flex items-center justify-between">
              <span>Last agent reply</span>
              <span className="font-medium">
                {formatDateTime(conversation.lastAgentReplyAt)}
              </span>
            </div>
            <div className="flex items-center justify-between">
              <span>Last automation</span>
              <span className="font-medium">
                {formatDateTime(conversation.lastAutomationAt)}
              </span>
            </div>
          </div>

          {/* Source line */}
          <p className="mt-2 text-[11px] text-gray-500">{sourceLine}</p>
        </div>

        {/* Recent activity (Timeline preview) */}
        <div>
          <RecentActivityTimeline contactId={conversation.contactId} />
        </div>

        {/* Tags / labels */}
        <div>
          <div className="font-semibold text-gray-800 mb-1 flex items-center gap-1">
            <Tag size={12} /> Labels
          </div>
          <div className="flex flex-wrap gap-1">
            {fakeTags.map(tag => (
              <span
                key={tag}
                className="px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100 text-[10px] cursor-pointer hover:bg-emerald-100"
                title="Later: click to filter / view timeline by this tag"
              >
                {tag}
              </span>
            ))}
          </div>
        </div>
      </div>

      {/* Footer placeholder â€“ later quick actions like 'Open contact', 'View full CRM' */}
      <div className="pt-2 border-t border-gray-100 text-[11px] text-gray-400">
        More contact insights (tags, notes, campaigns, full timeline) will
        appear here.
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\ChatInbox\components\ConversationList.jsx 
====================================================== 
 
// ðŸ“„ src/pages/chatInbox/components/ConversationList.jsx
import React from "react";
import { Search, Filter, Clock } from "lucide-react";

export function ConversationList({
  activeTab,
  onTabChange,
  tabCounts,
  numbers,
  selectedNumberId,
  onNumberChange,
  conversations,
  selectedConversationId,
  onSelectConversation,
  searchTerm,
  onSearchChange,
}) {
  const renderTab = (key, label, count) => {
    const isActive = activeTab === key;
    return (
      <button
        key={key}
        onClick={() => onTabChange(key)}
        className={
          "px-3 py-1.5 rounded-full text-xs font-medium mr-2 transition " +
          (isActive
            ? "bg-white shadow text-emerald-700"
            : "bg-emerald-50 text-emerald-700/70 hover:bg-white")
        }
      >
        {label}
        {typeof count === "number" && (
          <span className="ml-1 text-[10px] text-gray-500">({count})</span>
        )}
      </button>
    );
  };

  return (
    <div className="flex flex-col w-72 bg-white rounded-2xl shadow-sm border border-gray-200 min-w-[260px]">
      {/* Tabs */}
      <div className="px-3 pt-3 pb-2 border-b border-gray-50 flex items-center justify-between">
        <div>
          {renderTab("live", "Live", tabCounts.live)}
          {renderTab("history", "History", tabCounts.history)}
          {renderTab("unassigned", "Unassigned", tabCounts.unassigned)}
          {renderTab("my", "My chats", tabCounts.my)}
        </div>
      </div>

      {/* Search + filter */}
      <div className="px-3 pt-2 pb-2 border-b border-gray-50 space-y-2">
        <div className="flex items-center bg-gray-50 rounded-full px-3 py-1.5 text-xs">
          <Search size={14} className="text-gray-400 mr-2" />
          <input
            value={searchTerm}
            onChange={e => onSearchChange(e.target.value)}
            className="bg-transparent flex-1 outline-none text-xs text-gray-700 placeholder:text-gray-400"
            placeholder="Search name or phone"
          />
        </div>
        <div className="flex items-center justify-between text-[11px]">
          <div className="flex items-center text-gray-500">
            <Filter size={13} className="mr-1" />
            Number
          </div>
          <select
            value={selectedNumberId}
            onChange={e => onNumberChange(e.target.value)}
            className="text-[11px] border border-gray-200 rounded-full px-2 py-1 bg-white"
          >
            <option value="all">All numbers</option>
            {numbers.map(n => (
              <option key={n.id} value={n.id}>
                {n.label} ({n.displayPhoneNumber})
              </option>
            ))}
          </select>
        </div>
      </div>

      {/* Conversation list */}
      <div className="flex-1 overflow-y-auto">
        {conversations.length === 0 ? (
          <div className="h-full flex items-center justify-center text-[11px] text-gray-400 px-3 text-center">
            No conversations in this view yet.
          </div>
        ) : (
          conversations.map(conv => {
            const isSelected = conv.id === selectedConversationId;
            const isOutOfWindow = !conv.within24h;
            const isAssigned = !!(
              conv.assignedToUserId || conv.assignedToUserName
            );

            return (
              <button
                key={conv.id}
                onClick={() => onSelectConversation(conv.id)}
                className={
                  "w-full text-left px-3 py-2.5 border-b border-gray-50 flex gap-2 items-start text-xs transition " +
                  (isSelected ? "bg-emerald-50/70" : "hover:bg-gray-50/80") +
                  (isOutOfWindow ? " opacity-80" : "")
                }
              >
                {/* Avatar */}
                <div className="mt-0.5">
                  <div className="h-7 w-7 rounded-full bg-gradient-to-tr from-emerald-500 to-teal-500 flex items-center justify-center text-[11px] font-semibold text-white">
                    {conv.contactName?.[0] || "?"}
                  </div>
                </div>

                {/* Main info */}
                <div className="flex-1 min-w-0">
                  <div className="flex justify-between items-center">
                    <div className="truncate font-semibold text-gray-900 text-xs">
                      {conv.contactName}
                    </div>
                    <div className="text-[10px] text-gray-400 ml-2">
                      {new Date(conv.lastMessageAt).toLocaleTimeString(
                        "en-IN",
                        {
                          hour: "2-digit",
                          minute: "2-digit",
                        }
                      )}
                    </div>
                  </div>
                  <div className="text-[11px] text-gray-500 truncate">
                    {conv.contactPhone}
                  </div>
                  <div className="text-[11px] text-gray-500 truncate mt-0.5">
                    {conv.lastMessagePreview}
                  </div>

                  <div className="flex items-center justify-between mt-1">
                    <div className="flex items-center gap-1">
                      {/* Line badge */}
                      <span className="px-2 py-0.5 rounded-full bg-gray-100 text-[10px] text-gray-600">
                        {conv.numberLabel}
                      </span>
                      {/* Status */}
                      <span className="px-2 py-0.5 rounded-full bg-emerald-50 text-[10px] text-emerald-700">
                        {conv.status}
                      </span>
                      {/* Out-of-window icon */}
                      {isOutOfWindow && (
                        <span
                          title="24h window expired"
                          className="inline-flex items-center text-[10px] text-amber-600"
                        >
                          <Clock size={11} className="mr-1" />
                          24h over
                        </span>
                      )}
                    </div>

                    {/* Unread + agent chip */}
                    <div className="flex items-center gap-1">
                      {conv.unreadCount > 0 && (
                        <span className="h-5 min-w-[18px] px-1 rounded-full bg-emerald-500 text-[10px] text-white flex items-center justify-center">
                          {conv.unreadCount}
                        </span>
                      )}
                      {isAssigned && (
                        <div
                          title={
                            conv.isAssignedToMe
                              ? "Assigned to you"
                              : `Assigned to ${conv.assignedToUserName}`
                          }
                          className="h-5 w-5 rounded-full bg-gray-100 flex items-center justify-center text-[9px] text-gray-600"
                        >
                          {(conv.assignedToUserName || "U")[0]}
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </button>
            );
          })
        )}
      </div>
    </div>
  );
}

// // ðŸ“„ src/pages/chatInbox/components/ConversationList.jsx
// import React from "react";
// import { Search, Filter } from "lucide-react";
// import { ConversationListItem } from "./ConversationListItem";

// export function ConversationList({
//   activeTab,
//   onTabChange,
//   numbers,
//   selectedNumberId,
//   onNumberChange,
//   conversations,
//   selectedConversationId,
//   onSelectConversation,
//   searchTerm,
//   onSearchChange,
// }) {
//   return (
//     <div className="flex flex-col w-72 bg-white rounded-xl shadow-sm border border-gray-200 min-w-[260px]">
//       {/* Tabs like Meta: All / Unread / etc. */}
//       <div className="px-3 pt-3">
//         <div className="flex rounded-full bg-gray-100 p-1 text-xs font-medium text-gray-600">
//           {[
//             { id: "live", label: "Live" },
//             { id: "history", label: "History" },
//             { id: "unassigned", label: "Unassigned" }, // placeholder
//             { id: "my", label: "My chats" }, // placeholder
//           ].map(tab => (
//             <button
//               key={tab.id}
//               onClick={() => onTabChange(tab.id)}
//               className={`flex-1 rounded-full px-2.5 py-1 ${
//                 activeTab === tab.id
//                   ? "bg-white shadow-sm text-purple-600"
//                   : "text-gray-600"
//               }`}
//             >
//               {tab.label}
//             </button>
//           ))}
//         </div>
//       </div>

//       {/* Search + number filter */}
//       <div className="px-3 py-3 border-b border-gray-100 space-y-2">
//         <div className="flex items-center gap-2 rounded-full bg-gray-50 px-3 py-1.5">
//           <Search size={16} className="text-gray-400" />
//           <input
//             className="bg-transparent text-sm flex-1 outline-none placeholder:text-gray-400"
//             placeholder="Search name or phone"
//             value={searchTerm}
//             onChange={e => onSearchChange(e.target.value)}
//           />
//         </div>
//         <div className="flex items-center justify-between text-xs text-gray-500">
//           <div className="flex items-center gap-1">
//             <Filter size={14} />
//             <span>Number</span>
//           </div>
//           <select
//             className="bg-gray-50 border border-gray-200 rounded-full px-2 py-1 text-xs text-gray-700"
//             value={selectedNumberId}
//             onChange={e => onNumberChange(e.target.value)}
//           >
//             <option value="all">All numbers</option>
//             {numbers.map(n => (
//               <option key={n.id} value={n.id}>
//                 {n.label} ({n.displayPhoneNumber})
//               </option>
//             ))}
//           </select>
//         </div>
//       </div>

//       {/* Conversation list */}
//       <div className="flex-1 overflow-y-auto">
//         {conversations.length === 0 ? (
//           <div className="p-4 text-center text-xs text-gray-400">
//             No conversations found.
//           </div>
//         ) : (
//           conversations.map(conv => (
//             <ConversationListItem
//               key={conv.id}
//               conversation={conv}
//               isActive={conv.id === selectedConversationId}
//               onClick={() => onSelectConversation(conv.id)}
//             />
//           ))
//         )}
//       </div>
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\ChatInbox\components\ConversationListItem.jsx 
====================================================== 
 
// ðŸ“„ src/pages/chatInbox/components/ConversationListItem.jsx
import React from "react";
import { Circle } from "lucide-react";

const statusColors = {
  New: "bg-purple-100 text-purple-700",
  Open: "bg-blue-50 text-blue-700",
  Pending: "bg-amber-50 text-amber-700",
  Closed: "bg-gray-100 text-gray-600",
};

export function ConversationListItem({ conversation, isActive, onClick }) {
  const statusClass =
    statusColors[conversation.status] || "bg-gray-100 text-gray-600";

  return (
    <button
      onClick={onClick}
      className={`w-full text-left px-3 py-2.5 flex gap-2 items-start border-b border-gray-50 hover:bg-gray-50 ${
        isActive ? "bg-purple-50/80" : ""
      }`}
    >
      {/* Avatar placeholder */}
      <div className="h-9 w-9 rounded-full bg-gradient-to-tr from-purple-500 to-indigo-500 flex items-center justify-center text-xs font-semibold text-white">
        {conversation.contactName?.[0] || "?"}
      </div>

      <div className="flex-1 min-w-0">
        <div className="flex items-center justify-between gap-2">
          <div className="truncate">
            <div className="text-sm font-medium text-gray-900 truncate">
              {conversation.contactName}
            </div>
            <div className="text-[11px] text-gray-500 truncate">
              {conversation.contactPhone}
            </div>
          </div>
          <div className="text-[11px] text-gray-400">
            {conversation.lastMessageAt}
          </div>
        </div>

        <div className="mt-1 flex items-center justify-between gap-2">
          <div className="text-[11px] text-gray-500 truncate">
            {conversation.lastMessagePreview}
          </div>
          <div className="flex items-center gap-1 ml-1">
            {/* Number badge */}
            <span className="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-[10px] text-gray-600">
              <Circle size={8} className="mr-1 text-purple-500" />
              {conversation.numberLabel}
            </span>
            {/* Unread */}
            {conversation.unreadCount > 0 && (
              <span className="inline-flex items-center justify-center rounded-full bg-purple-600 text-white text-[10px] h-5 w-5">
                {conversation.unreadCount}
              </span>
            )}
          </div>
        </div>

        <div className="mt-1 flex items-center justify-between">
          <span
            className={`inline-flex items-center rounded-full px-2 py-0.5 text-[10px] ${statusClass}`}
          >
            {conversation.status}
          </span>
          {!conversation.within24h && (
            <span className="text-[10px] text-amber-600 font-medium">
              24h window over
            </span>
          )}
        </div>
      </div>
    </button>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\ChatInbox\components\EmptyState.jsx 
====================================================== 
 
// ðŸ“„ src/pages/chatInbox/components/EmptyState.jsx
import React from "react";
import { MessageCircle } from "lucide-react";

export function EmptyState() {
  return (
    <div className="flex-1 flex flex-col items-center justify-center text-center px-8">
      <div className="h-12 w-12 rounded-full bg-purple-50 flex items-center justify-center mb-3">
        <MessageCircle className="text-purple-600" size={24} />
      </div>
      <h2 className="text-sm font-semibold text-gray-800 mb-1">
        Select a conversation to start chatting
      </h2>
      <p className="text-xs text-gray-500 max-w-xs">
        When customers message your WhatsApp numbers, theyâ€™ll appear here.
        Assign chats to agents, manage automations, and reply within the 24-hour
        service window.
      </p>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\ChatInbox\components\MessageComposer.jsx 
====================================================== 
 
// ðŸ“„ src/pages/chatInbox/components/MessageComposer.jsx
import React, { useState } from "react";
import { Paperclip, SmilePlus, Send, FileText } from "lucide-react";

export function MessageComposer({ canSendFreeForm, onSend, onSendTemplate }) {
  const [text, setText] = useState("");

  const handleSend = () => {
    if (!canSendFreeForm) return;
    if (!text.trim()) return;
    onSend?.(text.trim());
    setText("");
  };

  const handleKeyDown = e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };

  const handleTemplateClick = () => {
    // Later: open template picker drawer / modal
    onSendTemplate?.();
  };

  return (
    <div className="border-t border-gray-100 bg-white px-4 py-3 space-y-2">
      {!canSendFreeForm && (
        <div className="text-[11px] text-amber-700 bg-amber-50 border border-amber-100 rounded-lg px-3 py-2">
          The 24-hour service window has expired. You can only reply using
          approved templates. Sending a template may be chargeable as per
          WhatsApp pricing.
        </div>
      )}

      <div className="flex items-end gap-2">
        {/* Left: attachment + emoji */}
        <button
          type="button"
          className="h-9 w-9 flex items-center justify-center rounded-full border border-gray-200 text-gray-500 hover:bg-gray-50"
        >
          <Paperclip size={16} />
        </button>

        <button
          type="button"
          className="h-9 w-9 flex items-center justify-center rounded-full border border-gray-200 text-gray-500 hover:bg-gray-50"
        >
          <SmilePlus size={16} />
        </button>

        {/* Middle: input */}
        <div className="flex-1">
          <textarea
            rows={1}
            className="w-full resize-none rounded-2xl border border-gray-200 px-3 py-2 text-sm text-gray-900 placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
            placeholder={
              canSendFreeForm
                ? "Type a reply..."
                : "Free-form reply disabled, use a template."
            }
            value={text}
            onChange={e => setText(e.target.value)}
            onKeyDown={handleKeyDown}
            disabled={!canSendFreeForm}
          />
        </div>

        {/* Send button */}
        <button
          type="button"
          className="h-9 px-3 inline-flex items-center justify-center rounded-2xl bg-purple-600 text-white text-[13px] font-medium shadow-sm hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed"
          onClick={handleSend}
          disabled={!canSendFreeForm || !text.trim()}
        >
          <Send size={16} className="mr-1" />
          Send
        </button>

        {/* Template button â€“ always enabled */}
        <button
          type="button"
          onClick={handleTemplateClick}
          className="h-9 px-3 inline-flex items-center justify-center rounded-2xl border border-purple-200 text-[13px] font-medium text-purple-700 bg-purple-50 hover:bg-purple-100"
        >
          <FileText size={16} className="mr-1" />
          Template
        </button>
      </div>
    </div>
  );
}

// // ðŸ“„ src/pages/chatInbox/components/MessageComposer.jsx
// import React, { useState } from "react";
// import { Paperclip, SmilePlus, Send, FileText } from "lucide-react";

// export function MessageComposer({ canSendFreeForm, onSend }) {
//   const [text, setText] = useState("");

//   const handleSend = () => {
//     if (!text.trim()) return;
//     onSend(text.trim());
//     setText("");
//   };

//   return (
//     <div className="border-t border-gray-100 bg-white px-4 py-3 space-y-2">
//       {!canSendFreeForm && (
//         <div className="text-[11px] text-amber-700 bg-amber-50 border border-amber-100 rounded-lg px-3 py-2">
//           The 24-hour service window has expired. You can only reply using
//           approved templates. Sending a template may be chargeable.
//         </div>
//       )}

//       <div className="flex items-end gap-2">
//         <button className="h-9 w-9 flex items-center justify-center rounded-full border border-gray-200 text-gray-500 hover:bg-gray-50">
//           <Paperclip size={16} />
//         </button>
//         <button className="h-9 w-9 flex items-center justify-center rounded-full border border-gray-200 text-gray-500 hover:bg-gray-50">
//           <SmilePlus size={16} />
//         </button>

//         <div className="flex-1">
//           <textarea
//             rows={1}
//             className="w-full resize-none rounded-2xl border border-gray-200 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
//             placeholder={
//               canSendFreeForm
//                 ? "Type a reply..."
//                 : "Free-form reply disabled, use template."
//             }
//             value={text}
//             onChange={e => setText(e.target.value)}
//             disabled={!canSendFreeForm}
//           />
//         </div>

//         <button
//           className="h-9 px-3 inline-flex items-center justify-center rounded-full bg-purple-600 text-white text-sm font-medium shadow-sm hover:bg-purple-700 disabled:opacity-50"
//           onClick={handleSend}
//           disabled={!canSendFreeForm || !text.trim()}
//         >
//           <Send size={16} className="mr-1" />
//           Send
//         </button>

//         <button className="h-9 px-3 inline-flex items-center justify-center rounded-full bg-gray-100 text-gray-700 text-xs font-medium border border-gray-200 hover:bg-gray-200">
//           <FileText size={14} className="mr-1" />
//           Template
//         </button>
//       </div>
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\ChatInbox\components\MessageList.jsx 
====================================================== 
 
// ðŸ“„ src/pages/chatInbox/components/MessageList.jsx
import React from "react";

export function MessageList({ messages }) {
  if (!messages || messages.length === 0) {
    return (
      <div className="flex-1 overflow-y-auto px-4 py-3 bg-gray-50">
        <div className="h-full flex items-center justify-center text-xs text-gray-400">
          No messages yet.
        </div>
      </div>
    );
  }

  const formatTime = raw => {
    if (!raw) return "";
    const d = new Date(raw);
    if (Number.isNaN(d.getTime())) {
      // fallback if it's already a simple "10:31" style string
      return raw;
    }
    return d.toLocaleTimeString("en-IN", {
      hour: "2-digit",
      minute: "2-digit",
    });
  };

  const getDayLabel = raw => {
    if (!raw) return null;
    const d = new Date(raw);
    if (Number.isNaN(d.getTime())) return null;

    const today = new Date();
    const todayKey = today.toDateString();

    const yesterday = new Date();
    yesterday.setDate(today.getDate() - 1);
    const yesterdayKey = yesterday.toDateString();

    const msgKey = d.toDateString();

    if (msgKey === todayKey) return "Today";
    if (msgKey === yesterdayKey) return "Yesterday";

    return d.toLocaleDateString("en-IN", {
      day: "2-digit",
      month: "short",
      year: "numeric",
    });
  };

  let lastDayLabel = null;

  return (
    <div className="flex-1 overflow-y-auto px-4 py-3 space-y-2 bg-gray-50">
      {messages.map(msg => {
        const direction = msg.direction || "in"; // fallback
        const sentAtRaw = msg.sentAt || msg.at;
        const timeLabel = formatTime(sentAtRaw);
        const dayLabel = getDayLabel(sentAtRaw);
        const showDayDivider = dayLabel && dayLabel !== lastDayLabel;
        lastDayLabel = dayLabel || lastDayLabel;

        // --- Automation / system bubble (centered) ---
        const isSystemLike =
          direction === "automation" || direction === "system";

        if (isSystemLike) {
          return (
            <React.Fragment key={msg.id}>
              {showDayDivider && (
                <div className="flex justify-center my-2">
                  <span className="px-3 py-0.5 rounded-full bg-gray-100 text-[11px] text-gray-500">
                    {dayLabel}
                  </span>
                </div>
              )}

              <div className="flex justify-center my-1">
                <div className="max-w-[80%] text-center">
                  <div className="inline-flex items-center px-3 py-1 rounded-full bg-gray-100 text-[11px] text-gray-600">
                    {/* Small label to show it's from automation */}
                    <span className="font-medium mr-1">Automation</span>
                    <span className="text-gray-500">â€¢</span>
                    <span className="ml-1 text-gray-600">{msg.text}</span>
                  </div>
                  {timeLabel && (
                    <div className="mt-1 text-[10px] text-gray-400">
                      {timeLabel}
                    </div>
                  )}
                </div>
              </div>
            </React.Fragment>
          );
        }

        // --- Normal in/out bubbles ---
        const isIncoming = direction === "in";
        const wrapperJustify = isIncoming ? "justify-start" : "justify-end";
        const bubbleColors = isIncoming
          ? "bg-white text-gray-900"
          : "bg-purple-600 text-white";
        const metaTextColor = isIncoming ? "text-gray-400" : "text-purple-100";

        return (
          <React.Fragment key={msg.id}>
            {showDayDivider && (
              <div className="flex justify-center my-2">
                <span className="px-3 py-0.5 rounded-full bg-gray-100 text-[11px] text-gray-500">
                  {dayLabel}
                </span>
              </div>
            )}

            <div className={`flex mb-1 ${wrapperJustify}`}>
              <div className="max-w-[70%]">
                {/* Sender label for agent messages */}
                {!isIncoming && msg.senderName && (
                  <div className="text-[10px] text-gray-400 text-right mb-0.5">
                    {msg.senderName}
                  </div>
                )}

                <div
                  className={`rounded-2xl px-3 py-2 text-sm shadow-sm ${bubbleColors}`}
                >
                  <div>{msg.text}</div>
                  {timeLabel && (
                    <div
                      className={`mt-1 text-[10px] ${metaTextColor} text-right`}
                    >
                      {timeLabel}
                    </div>
                  )}
                </div>
              </div>
            </div>
          </React.Fragment>
        );
      })}
    </div>
  );
}

// // ðŸ“„ src/pages/chatInbox/components/MessageList.jsx
// import React from "react";

// export function MessageList({ messages }) {
//   return (
//     <div className="flex-1 overflow-y-auto px-4 py-3 space-y-2 bg-gray-50">
//       {messages.length === 0 ? (
//         <div className="h-full flex items-center justify-center text-xs text-gray-400">
//           No messages yet.
//         </div>
//       ) : (
//         messages.map(msg => {
//           if (msg.direction === "system") {
//             return (
//               <div
//                 key={msg.id}
//                 className="flex justify-center text-[11px] text-gray-500 my-2"
//               >
//                 <span className="px-3 py-1 rounded-full bg-gray-100">
//                   {msg.text}
//                 </span>
//               </div>
//             );
//           }

//           const isIncoming = msg.direction === "in";

//           return (
//             <div
//               key={msg.id}
//               className={`flex mb-1 ${
//                 isIncoming ? "justify-start" : "justify-end"
//               }`}
//             >
//               <div
//                 className={`max-w-[70%] rounded-2xl px-3 py-2 text-sm shadow-sm ${
//                   isIncoming
//                     ? "bg-white text-gray-900"
//                     : "bg-purple-600 text-white"
//                 }`}
//               >
//                 <div>{msg.text}</div>
//                 <div
//                   className={`mt-1 text-[10px] ${
//                     isIncoming ? "text-gray-400" : "text-purple-100"
//                   } text-right`}
//                 >
//                   {msg.at}
//                 </div>
//               </div>
//             </div>
//           );
//         })
//       )}
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\ChatInbox\components\RecentActivityTimeline.jsx 
====================================================== 
 
// ðŸ“„ src/pages/ChatInbox/components/RecentActivityTimeline.jsx

import React from "react";
import { Clock } from "lucide-react";
import { useLeadTimelinePreview } from "../hooks/useLeadTimelinePreview";
import { formatAgo } from "../../CRM/Timeline/timelineUtils";

/**
 * Compact recent-activity view for the Inbox right panel.
 * It is intentionally minimal: last few events only, with relative time.
 */
export function RecentActivityTimeline({ contactId }) {
  const hasContact = Boolean(contactId);

  const { entries, loading, reload } = useLeadTimelinePreview(contactId, {
    limit: 5,
    enabled: hasContact,
  });

  if (!hasContact) {
    return (
      <p className="text-[11px] text-gray-400 italic">
        No CRM contact linked yet. Once this person is saved as a contact, their
        recent activity will appear here.
      </p>
    );
  }

  return (
    <div className="space-y-1">
      <div className="flex items-center justify-between mb-1">
        <div className="flex items-center gap-1 text-[11px] font-semibold text-gray-800">
          <Clock size={12} />
          <span>Recent activity</span>
        </div>
        <button
          type="button"
          onClick={reload}
          className="text-[10px] text-emerald-700 hover:text-emerald-800"
        >
          â†» Refresh
        </button>
      </div>

      {loading && entries.length === 0 ? (
        <p className="text-[11px] text-gray-400">Loading recent activityâ€¦</p>
      ) : !loading && entries.length === 0 ? (
        <p className="text-[11px] text-gray-400 italic">
          No recent activity logged for this contact.
        </p>
      ) : (
        <ul className="space-y-1 max-h-40 overflow-y-auto pr-1">
          {entries.map(entry => (
            <li
              key={entry.id}
              className="border border-gray-100 rounded-md px-2 py-1.5 bg-gray-50"
            >
              <div className="flex items-center justify-between gap-2">
                <span className="text-[11px] font-semibold text-gray-800">
                  {entry.eventType || "Activity"}
                </span>
                <span className="text-[10px] text-gray-400">
                  {entry.createdAt ? formatAgo(entry.createdAt) : "-"}
                </span>
              </div>
              <div className="text-[11px] text-gray-700 mt-0.5 line-clamp-2">
                {entry.description || "(No description provided)"}
              </div>
              {entry.source && (
                <div className="text-[10px] text-gray-400 mt-0.5">
                  Source: {entry.source}
                </div>
              )}
            </li>
          ))}
        </ul>
      )}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\ChatInbox\hooks\useLeadTimelinePreview.js 
====================================================== 
 
// ðŸ“„ src/pages/ChatInbox/hooks/useLeadTimelinePreview.js

import { useState, useEffect, useCallback } from "react";
import axiosClient from "../../../api/axiosClient";
import { toast } from "react-toastify";

/**
 * Small hook to fetch a limited number of recent timeline events
 * for a given contact.
 *
 * This reuses the existing CRM Timeline API:
 *   GET /leadtimeline/contact/{contactId}
 *
 * We keep it Inbox-specific for now (preview only),
 * but we can later promote it to a shared hook if needed.
 *
 * @param {string | null | undefined} contactId
 * @param {{ limit?: number, enabled?: boolean }} options
 */
export function useLeadTimelinePreview(contactId, options = {}) {
  const { limit = 5, enabled = true } = options;

  const [entries, setEntries] = useState([]);
  const [loading, setLoading] = useState(false);

  const fetchTimeline = useCallback(async () => {
    if (!enabled) return;
    if (!contactId) {
      setEntries([]);
      return;
    }

    try {
      setLoading(true);
      const res = await axiosClient.get(`/leadtimeline/contact/${contactId}`);

      const all = Array.isArray(res.data) ? res.data : [];
      // We keep only the latest N entries for the Inbox preview
      setEntries(all.slice(0, limit));
    } catch (error) {
      console.error("Failed to fetch lead timeline preview", error);
      toast.error("âŒ Failed to load recent activity");
    } finally {
      setLoading(false);
    }
  }, [contactId, limit, enabled]);

  useEffect(() => {
    fetchTimeline();
  }, [fetchTimeline]);

  return {
    entries,
    loading,
    reload: fetchTimeline,
  };
}
 
 
