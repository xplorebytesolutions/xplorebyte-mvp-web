Folder and File Content Report
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\.flder.txt 
====================================================== 
 
Folder PATH listing for volume Software
Volume serial number is DED9-552B
D:.
+---admin
¶   +---FeatureAccess
+---auth
¶   +---context
¶   +---hooks
¶   +---services
¶   +---utils
¶   +---__tests__
+---AutoReplyBuilder
¶   +---components
+---Businesses
+---Campaigns
¶   +---Analytics
¶   +---api
¶   +---components
¶   ¶   +---Dashboard
¶   ¶   +---templates
¶   +---steps
¶   +---tabs
+---Contacts
¶   +---components
+---CrmAnalytics
+---CTAFlowVisualBuilder
¶   +---components
¶       +---edges
+---CTAManagement
+---CTATimeline
+---DevTools
+---errors
+---FeatureAccess
+---FlowAnalytics
+---html pages
+---Inbox
¶   +---components
+---MessageStatus
+---Messaging
+---Monitoring
+---Notes
+---Plans
+---Reminders
+---ReportingModule
+---reports
+---SendTemplate
+---SendWhatsAppMessage
+---Tags
+---TemplateBuilder
¶   +---components
+---Tracking
+---UserPermissions
+---WhatsAppMessageEngine
+---WhatsAppSettings
+---Workspaces
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\ExtrackAllFiles.bat 
====================================================== 
 
@echo off
REM This script will find all files and output their name and content into one file.
REM The output file will be named [FolderName]_AllFileDump.txt.

REM Get the current folder's name and set it as the output file name with the custom suffix
for %%I in ("%cd%") do set "outputFile=%%~nI_AllFileDump.txt"

REM Clear the output file to start fresh
> "%outputFile%" (echo Folder and File Content Report)
echo. >> "%outputFile%"

REM Loop through all files in the current directory and subdirectories
for /R . %%F in (*.*) do (
    echo ====================================================== >> "%outputFile%"
    echo FILE: %%F >> "%outputFile%"
    echo ====================================================== >> "%outputFile%"
    echo. >> "%outputFile%"
    type "%%F" >> "%outputFile%" 2>nul
    echo. >> "%outputFile%"
    echo. >> "%outputFile%"
)

echo Finished! All content has been extracted to %outputFile% 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\NoAccess.jsx 
====================================================== 
 
import React from "react";
import { Link } from "react-router-dom";
import { ShieldOff } from "lucide-react";

function NoAccess() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-100 px-4">
      <div className="max-w-md bg-white shadow-lg rounded-lg p-8 text-center border border-red-200">
        <div className="text-red-500 mb-4 flex justify-center">
          <ShieldOff size={48} />
        </div>
        <h2 className="text-2xl font-semibold text-gray-800 mb-2">
          Access Denied
        </h2>
        <p className="text-sm text-gray-600 mb-6">
          üö´ You do not have permission to view this page.
          <br />
          Please contact your admin if you believe this is a mistake.
        </p>
        <Link
          to="/login"
          className="inline-block bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-md text-sm transition"
        >
          Back to Login
        </Link>
      </div>
    </div>
  );
}

export default NoAccess;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\pages_AllFileDump.txt 
====================================================== 
 
Folder and File Content Report
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\.flder.txt 
====================================================== 
 
Folder PATH listing for volume Software
Volume serial number is DED9-552B
D:.
+---admin
¶   +---FeatureAccess
+---auth
¶   +---context
¶   +---hooks
¶   +---services
¶   +---utils
¶   +---__tests__
+---AutoReplyBuilder
¶   +---components
+---Businesses
+---Campaigns
¶   +---Analytics
¶   +---api
¶   +---components
¶   ¶   +---Dashboard
¶   ¶   +---templates
¶   +---steps
¶   +---tabs
+---Contacts
¶   +---components
+---CrmAnalytics
+---CTAFlowVisualBuilder
¶   +---components
¶       +---edges
+---CTAManagement
+---CTATimeline
+---DevTools
+---errors
+---FeatureAccess
+---FlowAnalytics
+---html pages
+---Inbox
¶   +---components
+---MessageStatus
+---Messaging
+---Monitoring
+---Notes
+---Plans
+---Reminders
+---ReportingModule
+---reports
+---SendTemplate
+---SendWhatsAppMessage
+---Tags
+---TemplateBuilder
¶   +---components
+---Tracking
+---UserPermissions
+---WhatsAppMessageEngine
+---WhatsAppSettings
+---Workspaces
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\ExtrackAllFiles.bat 
====================================================== 
 
@echo off
REM This script will find all files and output their name and content into one file.
REM The output file will be named [FolderName]_AllFileDump.txt.

REM Get the current folder's name and set it as the output file name with the custom suffix
for %%I in ("%cd%") do set "outputFile=%%~nI_AllFileDump.txt"

REM Clear the output file to start fresh
> "%outputFile%" (echo Folder and File Content Report)
echo. >> "%outputFile%"

REM Loop through all files in the current directory and subdirectories
for /R . %%F in (*.*) do (
    echo ====================================================== >> "%outputFile%"
    echo FILE: %%F >> "%outputFile%"
    echo ====================================================== >> "%outputFile%"
    echo. >> "%outputFile%"
    type "%%F" >> "%outputFile%" 2>nul
    echo. >> "%outputFile%"
    echo. >> "%outputFile%"
)

echo Finished! All content has been extracted to %outputFile% 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\NoAccess.jsx 
====================================================== 
 
import React from "react";
import { Link } from "react-router-dom";
import { ShieldOff } from "lucide-react";

function NoAccess() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-100 px-4">
      <div className="max-w-md bg-white shadow-lg rounded-lg p-8 text-center border border-red-200">
        <div className="text-red-500 mb-4 flex justify-center">
          <ShieldOff size={48} />
        </div>
        <h2 className="text-2xl font-semibold text-gray-800 mb-2">
          Access Denied
        </h2>
        <p className="text-sm text-gray-600 mb-6">
          üö´ You do not have permission to view this page.
          <br />
          Please contact your admin if you believe this is a mistake.
        </p>
        <Link
          to="/login"
          className="inline-block bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-md text-sm transition"
        >
          Back to Login
        </Link>
      </div>
    </div>
  );
}

export default NoAccess;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\pages_AllFileDump.txt 
====================================================== 
 
Folder and File Content Report
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\.flder.txt 
====================================================== 
 
Folder PATH listing for volume Software
Volume serial number is DED9-552B
D:.
+---admin
¶   +---FeatureAccess
+---auth
¶   +---context 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\PreviewTest.jsx 
====================================================== 
 
import React, { useState } from "react";

function PreviewTest() {
  const [template, setTemplate] = useState(
    "Your order {{1}} is out for delivery!\nIt should arrive by {{2}}."
  );
  const [params, setParams] = useState(["", ""]);

  // ‚úÖ Reliable param replacement
  const generatePreview = (template, paramValues) => {
    if (!template) return "";
    return template.replace(/{{(\d+)}}/g, (_, p1) => {
      const index = parseInt(p1, 10) - 1;
      return paramValues[index] || `{{${p1}}}`;
    });
  };

  const preview = generatePreview(template, params);

  const handleParamChange = (index, value) => {
    const updated = [...params];
    updated[index] = value;
    setParams(updated);
  };

  return (
    <div className="max-w-xl mx-auto p-6 space-y-4">
      <h2 className="text-2xl font-bold text-purple-700">
        üß™ Parameter Preview Test
      </h2>

      <div className="space-y-2">
        <label className="font-medium">Template Body</label>
        <textarea
          className="w-full border rounded p-2"
          rows={4}
          value={template}
          onChange={e => {
            setTemplate(e.target.value);

            // üß† Optional: auto update param array size
            const matchCount = (e.target.value.match(/{{\d+}}/g) || []).length;
            const filled = [...params];
            while (filled.length < matchCount) filled.push("");
            setParams(filled.slice(0, matchCount));
          }}
        />
      </div>

      <div className="space-y-2">
        <label className="font-medium">Parameter Inputs</label>
        {params.map((val, idx) => (
          <input
            key={idx}
            type="text"
            placeholder={`Param ${idx + 1}`}
            value={val}
            onChange={e => handleParamChange(idx, e.target.value)}
            className="w-full border rounded px-3 py-2"
          />
        ))}
      </div>

      <div className="bg-gray-100 p-4 rounded">
        <p className="font-semibold mb-2">Live Preview</p>
        <p className="whitespace-pre-wrap">{preview}</p>
      </div>
    </div>
  );
}

export default PreviewTest;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\TenantLogin.jsx 
====================================================== 
 
import { useState } from "react";
import { useNavigate } from "react-router-dom";

function TenantLogin() {
  const [form, setForm] = useState({ email: "", password: "" });
  const [error, setError] = useState("");
  const [loading, setLoading] = useState(false);
  const navigate = useNavigate();

  const handleChange = e => {
    setForm({ ...form, [e.target.name]: e.target.value });
  };

  const handleSubmit = async e => {
    e.preventDefault();
    setError("");
    setLoading(true);

    try {
      const res = await fetch("https://localhost:7113/api/tenants/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(form),
      });

      if (!res.ok) throw new Error("Login failed. Please try again.");

      const data = await res.json();

      // Store essential auth data in localStorage
      localStorage.setItem("role", data.role || "tenant");
      localStorage.setItem("tenantLogo", data.logoUrl || "");
      localStorage.setItem("userAvatar", data.avatarUrl || "");

      // Redirect to dashboard
      navigate("/dashboard");
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-100 to-white">
      <div className="bg-white p-8 rounded-xl shadow-xl max-w-md w-full">
        <h2 className="text-2xl font-bold mb-4 text-center text-purple-700">Tenant Login</h2>

        {error && <p className="mb-4 text-sm text-red-600">‚ùå {error}</p>}

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm text-gray-600 mb-1">Email</label>
            <input
              type="email"
              name="email"
              value={form.email}
              onChange={handleChange}
              required
              className="w-full border px-4 py-2 rounded-lg focus:ring-2 focus:ring-purple-500"
            />
          </div>

          <div>
            <label className="block text-sm text-gray-600 mb-1">Password</label>
            <input
              type="password"
              name="password"
              value={form.password}
              onChange={handleChange}
              required
              className="w-full border px-4 py-2 rounded-lg focus:ring-2 focus:ring-purple-500"
            />
          </div>

          <button
            type="submit"
            disabled={loading}
            className="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition"
          >
            {loading ? "Logging in..." : "Login"}
          </button>
        </form>
      </div>
    </div>
  );
}

export default TenantLogin;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\AccountInsights\AccountAlerts.jsx 
====================================================== 
 
// // üìÑ src/pages/AccountInsights/AccountAlerts.jsx
// import React, { useEffect, useState } from "react";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import MetricCard from "./components/MetricCard";
// import AlertCard from "./components/AlertCard";
// import InsightsTabs from "./components/InsightsTabs";

// export default function AccountAlerts() {
//   const [loading, setLoading] = useState(true);
//   const [alerts, setAlerts] = useState([]);

//   useEffect(() => {
//     const loadAlerts = async () => {
//       try {
//         setLoading(true);

//         const [trialRes, noUsageRes] = await Promise.all([
//           axiosClient.get("/admin/account-insights/trial-expiring-soon", {
//             params: { days: 3 },
//           }),
//           axiosClient.get("/admin/account-insights/by-stage", {
//             params: {
//               stage: "NoUsagePostApproval",
//               page: 1,
//               pageSize: 200,
//             },
//           }),
//         ]);

//         // Trials expiring soon
//         const trialItems = Array.isArray(trialRes.data)
//           ? trialRes.data.map(x => ({
//               id: `trial-${x.businessId}`,
//               severity: "warning",
//               title: "Trial ending soon",
//               message:
//                 "Trial is ending soon and this account has not upgraded yet.",
//               businessId: x.businessId,
//               businessName: x.businessName,
//               daysToEvent: null, // can compute from trial end date if backend exposes it
//               createdAtUtc: x.createdAt,
//             }))
//           : [];

//         // No usage after approval
//         const noUsageSource = Array.isArray(noUsageRes.data?.items)
//           ? noUsageRes.data.items
//           : Array.isArray(noUsageRes.data)
//           ? noUsageRes.data
//           : [];

//         const noUsageItems = noUsageSource.map(x => ({
//           id: `no-usage-${x.businessId}`,
//           severity: "warning",
//           title: "No usage after approval",
//           message:
//             "Approved but no messages sent post-approval. High churn risk.",
//           businessId: x.businessId,
//           businessName: x.businessName,
//           daysToEvent: null,
//           createdAtUtc: x.createdAt,
//         }));

//         // Merge & de-duplicate (by business + title so we don't show exact clones)
//         const merged = [...trialItems, ...noUsageItems];
//         const dedupMap = merged.reduce((acc, alert) => {
//           const key = `${alert.businessId || "na"}|${alert.title}`;
//           if (!acc[key]) acc[key] = alert;
//           return acc;
//         }, {});
//         const uniqueAlerts = Object.values(dedupMap);

//         setAlerts(uniqueAlerts);
//       } catch (err) {
//         console.error("Failed to load account insight alerts", err);
//         toast.error("Failed to load Account Alerts.");
//       } finally {
//         setLoading(false);
//       }
//     };

//     loadAlerts();
//   }, []);

//   const totalAlerts = alerts.length;
//   const criticalCount = alerts.filter(a => a.severity === "critical").length;
//   const warningCount = alerts.filter(a => a.severity === "warning").length;
//   const infoCount = alerts.filter(a => a.severity === "info").length;

//   return (
//     <div className="px-6 py-4 space-y-6">
//       {/* Header */}
//       <div className="flex flex-col gap-1">
//         <h1 className="text-2xl font-semibold text-slate-900">
//           Account Alerts
//         </h1>
//         <p className="text-sm text-slate-500 max-w-3xl">
//           Concrete cohorts that need attention: trials expiring soon and
//           approved accounts with zero usage.
//         </p>
//       </div>

//       <InsightsTabs />

//       {loading && (
//         <div className="w-full py-10 flex items-center justify-center">
//           <div className="text-sm text-slate-500">
//             Loading alerts &amp; signals...
//           </div>
//         </div>
//       )}

//       {!loading && (
//         <>
//           {/* Summary */}
//           <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
//             <MetricCard
//               label="Total Alerts"
//               value={totalAlerts}
//               subtitle="Accounts needing action."
//               highlight
//             />
//             <MetricCard
//               label="Critical"
//               value={criticalCount}
//               subtitle="Reserved for severe issues."
//             />
//             <MetricCard
//               label="Warnings"
//               value={warningCount}
//               subtitle="Risk & opportunity cohorts."
//             />
//             <MetricCard
//               label="Informational"
//               value={infoCount}
//               subtitle="General signals."
//             />
//           </div>

//           {/* Alerts list */}
//           {alerts.length === 0 ? (
//             <div className="w-full py-10 flex items-center justify-center">
//               <div className="text-xs text-emerald-600 bg-emerald-50 px-3 py-2 rounded-full border border-emerald-100">
//                 No active alerts. Your accounts look stable.
//               </div>
//             </div>
//           ) : (
//             <div className="grid grid-cols-1 gap-3">
//               {alerts.map(a => (
//                 <AlertCard key={a.id} {...a} />
//               ))}
//             </div>
//           )}

//           <div className="mt-2 text-[10px] text-slate-500">
//             Each alert here represents a distinct risk or opportunity cohort.
//             Later, a shared Segment API can let these feed directly into
//             campaigns or workflows.
//           </div>
//         </>
//       )}
//     </div>
//   );
// }
// üìÑ src/pages/AccountInsights/AccountAlerts.jsx
import React, { useEffect, useState } from "react";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";
import MetricCard from "./components/MetricCard";
import AlertCard from "./components/AlertCard";
import InsightsTabs from "./components/InsightsTabs";

export default function AccountAlerts() {
  const [loading, setLoading] = useState(true);
  const [alerts, setAlerts] = useState([]);

  useEffect(() => {
    const loadAlerts = async () => {
      try {
        setLoading(true);

        const [trialRes, noUsageRes] = await Promise.all([
          axiosClient.get("/admin/account-insights/trial-expiring-soon", {
            params: { days: 3 },
          }),
          axiosClient.get("/admin/account-insights/by-stage", {
            params: {
              stage: "NoUsagePostApproval",
              page: 1,
              pageSize: 200,
            },
          }),
        ]);

        // Trials expiring soon
        const trialItems = Array.isArray(trialRes.data)
          ? trialRes.data.map(x => ({
              id: `trial-${x.businessId}`,
              severity: "warning",
              title: "Trial ending soon",
              message:
                "Trial is ending soon and this account has not upgraded yet.",
              businessId: x.businessId,
              businessName: x.businessName,
              daysToEvent: null, // can compute from trial end date if backend exposes it
              createdAtUtc: x.createdAt,
            }))
          : [];

        // No usage after approval
        const noUsageSource = Array.isArray(noUsageRes.data?.items)
          ? noUsageRes.data.items
          : Array.isArray(noUsageRes.data)
          ? noUsageRes.data
          : [];

        const noUsageItems = noUsageSource.map(x => ({
          id: `no-usage-${x.businessId}`,
          severity: "warning",
          title: "No usage after approval",
          message:
            "Approved but no messages sent post-approval. High churn risk.",
          businessId: x.businessId,
          businessName: x.businessName,
          daysToEvent: null,
          createdAtUtc: x.createdAt,
        }));

        // Merge & de-duplicate (by business + title so we don't show exact clones)
        const merged = [...trialItems, ...noUsageItems];
        const dedupMap = merged.reduce((acc, alert) => {
          const key = `${alert.businessId || "na"}|${alert.title}`;
          if (!acc[key]) acc[key] = alert;
          return acc;
        }, {});
        const uniqueAlerts = Object.values(dedupMap);

        setAlerts(uniqueAlerts);
      } catch (err) {
        console.error("Failed to load account insight alerts", err);
        toast.error("Failed to load Account Alerts.");
      } finally {
        setLoading(false);
      }
    };

    loadAlerts();
  }, []);

  const totalAlerts = alerts.length;
  const criticalCount = alerts.filter(a => a.severity === "critical").length;
  const warningCount = alerts.filter(a => a.severity === "warning").length;
  const infoCount = alerts.filter(a => a.severity === "info").length;

  return (
    <div className="px-4 sm:px-6 py-6 space-y-6">
      {/* Header */}
      <div className="flex flex-col gap-1">
        <h1 className="text-2xl font-semibold text-slate-900">
          Account Alerts
        </h1>
        <p className="text-sm text-slate-500 max-w-3xl">
          Concrete cohorts that need attention: trials expiring soon and
          approved accounts with zero usage.
        </p>
      </div>

      <InsightsTabs />

      {loading && (
        <div className="w-full py-10 flex items-center justify-center">
          <div className="text-sm text-slate-500">
            Loading alerts &amp; signals...
          </div>
        </div>
      )}

      {!loading && (
        <>
          {/* Summary */}
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <MetricCard
              label="Total Alerts"
              value={totalAlerts}
              subtitle="Accounts needing action."
              highlight
            />
            <MetricCard
              label="Critical"
              value={criticalCount}
              subtitle="Reserved for severe issues."
            />
            <MetricCard
              label="Warnings"
              value={warningCount}
              subtitle="Risk & opportunity cohorts."
            />
            <MetricCard
              label="Informational"
              value={infoCount}
              subtitle="General signals."
            />
          </div>

          {/* Alerts list */}
          {alerts.length === 0 ? (
            <div className="w-full py-10 flex items-center justify-center">
              <div className="text-xs text-emerald-600 bg-emerald-50 px-3 py-2 rounded-full border border-emerald-100">
                No active alerts. Your accounts look stable.
              </div>
            </div>
          ) : (
            <div className="grid grid-cols-1 gap-3">
              {alerts.map(a => (
                <AlertCard key={a.id} {...a} />
              ))}
            </div>
          )}

          <div className="mt-2 text-[10px] text-slate-500">
            Each alert here represents a distinct risk or opportunity cohort.
            Later, a shared Segment API can let these feed directly into
            campaigns or workflows.
          </div>
        </>
      )}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\AccountInsights\AccountDashboard.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";
import MetricCard from "./components/MetricCard";
import TrendChart from "./components/TrendChart";
import InsightsTabs from "./components/InsightsTabs";

export default function AccountDashboard() {
  const [loading, setLoading] = useState(true);
  const [summary, setSummary] = useState(null);

  useEffect(() => {
    const loadSummary = async () => {
      try {
        setLoading(true);
        const res = await axiosClient.get("/admin/account-insights/summary");

        if (!res.data) {
          throw new Error(
            "Empty response from /admin/account-insights/summary"
          );
        }

        setSummary(res.data);
      } catch (err) {
        console.error("Failed to load account insights summary", err);
        toast.error("Failed to load Account Insights summary.");
      } finally {
        setLoading(false);
      }
    };

    loadSummary();
  }, []);

  const s = summary || {};

  const totalAccounts = s.totalBusinesses ?? s.TotalBusinesses ?? 0;
  const activeAccounts = s.activeBusinesses ?? s.ActiveBusinesses ?? 0;
  const atRisk = s.atRiskBusinesses ?? s.AtRiskBusinesses ?? 0;
  const dormant = s.dormantBusinesses ?? s.DormantBusinesses ?? 0;
  const noUsage = s.noUsagePostApproval ?? s.NoUsagePostApproval ?? 0;

  const trialPlan = s.trialPlan ?? s.TrialPlan ?? 0;
  const paidPlan = s.paidPlan ?? s.PaidPlan ?? 0;
  const unknownPlan = s.unknownPlan ?? s.UnknownPlan ?? 0;

  const trialTotal = s.trialTotal ?? s.TrialTotal ?? trialPlan;
  const trialExpSoon = s.trialExpiringSoon ?? s.TrialExpiringSoon ?? 0;
  const trialExpiredNoUpgrade =
    s.trialExpiredNoUpgrade ?? s.TrialExpiredNoUpgrade ?? 0;

  const activationRate =
    totalAccounts > 0 ? ((activeAccounts + paidPlan) / totalAccounts) * 100 : 0;

  const paidConversionRate =
    totalAccounts > 0 ? (paidPlan / totalAccounts) * 100 : 0;

  // Temporary sample trends (replace with real series later)
  const labels = ["Week 1", "Week 2", "Week 3", "Week 4"];
  const newAccountsTrend = [2, 4, 3, 5];
  const usageTrend = [1, 3, 2, 4];

  return (
    <div className="px-4 sm:px-6 py-6 space-y-6">
      {/* Header */}
      <div className="flex flex-col gap-1">
        <h1 className="text-2xl font-semibold text-slate-900">
          Account Insights Overview
        </h1>
        <p className="text-sm text-slate-500 max-w-3xl">
          High-level intelligence across all accounts: signup quality,
          activation, lifecycle stages, trials, and paid distribution.
        </p>
      </div>

      <InsightsTabs />

      {loading && (
        <div className="w-full py-10 flex items-center justify-center">
          <div className="text-sm text-slate-500">
            Loading Account Insights...
          </div>
        </div>
      )}

      {!loading && (
        <>
          {/* Core counts */}
          <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
            <MetricCard
              label="Total Accounts"
              value={totalAccounts}
              subtitle="All businesses registered on the platform."
              highlight
            />
            <MetricCard
              label="Active"
              value={activeAccounts}
              subtitle="Currently healthy & engaged."
            />
            <MetricCard
              label="At Risk"
              value={atRisk}
              subtitle="Low recent usage; watch closely."
            />
            <MetricCard
              label="Dormant"
              value={dormant}
              subtitle="Idle for a long time."
            />
          </div>

          {/* Lifecycle risk */}
          <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <MetricCard
              label="No Usage Post-Approval"
              value={noUsage}
              subtitle="Approved but never used ‚Äî top churn risk."
            />
            <MetricCard
              label="Activation Rate"
              value={`${activationRate.toFixed(1)}%`}
              subtitle="(Active + Paid) / Total Accounts"
            />
            <MetricCard
              label="Paid Conversion"
              value={`${paidConversionRate.toFixed(1)}%`}
              subtitle="Paid / Total Accounts"
            />
          </div>

          {/* Plan & trial snapshot */}
          <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <MetricCard
              label="On Trial Plan"
              value={trialPlan}
              subtitle="Currently on a trial plan."
            />
            <MetricCard
              label="On Paid Plan"
              value={paidPlan}
              subtitle="Any paid subscription."
              highlight
            />
            <MetricCard
              label="Unknown Plan"
              value={unknownPlan}
              subtitle="Check mapping / billing sync."
            />
          </div>

          <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <MetricCard
              label="Trials (Total)"
              value={trialTotal}
              subtitle="Active trials in the system."
            />
            <MetricCard
              label="Trials Expiring Soon"
              value={trialExpSoon}
              subtitle="Ideal targets for save / upsell."
            />
            <MetricCard
              label="Trials Expired, No Upgrade"
              value={trialExpiredNoUpgrade}
              subtitle="Lost opportunities; review patterns."
            />
          </div>

          {/* Trends */}
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div className="bg-white p-4 sm:p-6 rounded-lg shadow-sm">
              <TrendChart
                title="New Accounts (Sample Trend)"
                labels={labels}
                values={newAccountsTrend}
                type="bar"
              />
            </div>
            <div className="bg-white p-4 sm:p-6 rounded-lg shadow-sm">
              <TrendChart
                title="Active Usage Proxy (Sample)"
                labels={labels}
                values={usageTrend}
                type="line"
              />
            </div>
          </div>

          <div className="mt-2 text-[11px] text-slate-500">
            For deeper cohorts and actions, use the Funnels and Alerts tabs in
            Account Insights.
          </div>
        </>
      )}
    </div>
  );
}
// import React, { useEffect, useState } from "react";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import MetricCard from "./components/MetricCard";
// import TrendChart from "./components/TrendChart";
// import InsightsTabs from "./components/InsightsTabs";

// export default function AccountDashboard() {
//   const [loading, setLoading] = useState(true);
//   const [summary, setSummary] = useState(null);

//   useEffect(() => {
//     const loadSummary = async () => {
//       try {
//         setLoading(true);
//         const res = await axiosClient.get("/admin/account-insights/summary");

//         if (!res.data) {
//           throw new Error(
//             "Empty response from /admin/account-insights/summary"
//           );
//         }

//         setSummary(res.data);
//       } catch (err) {
//         console.error("Failed to load account insights summary", err);
//         toast.error("Failed to load Account Insights summary.");
//       } finally {
//         setLoading(false);
//       }
//     };

//     loadSummary();
//   }, []);

//   const s = summary || {};

//   const totalAccounts = s.totalBusinesses ?? s.TotalBusinesses ?? 0;
//   const activeAccounts = s.activeBusinesses ?? s.ActiveBusinesses ?? 0;
//   const atRisk = s.atRiskBusinesses ?? s.AtRiskBusinesses ?? 0;
//   const dormant = s.dormantBusinesses ?? s.DormantBusinesses ?? 0;
//   const noUsage = s.noUsagePostApproval ?? s.NoUsagePostApproval ?? 0;

//   const trialPlan = s.trialPlan ?? s.TrialPlan ?? 0;
//   const paidPlan = s.paidPlan ?? s.PaidPlan ?? 0;
//   const unknownPlan = s.unknownPlan ?? s.UnknownPlan ?? 0;

//   const trialTotal = s.trialTotal ?? s.TrialTotal ?? trialPlan;
//   const trialExpSoon = s.trialExpiringSoon ?? s.TrialExpiringSoon ?? 0;
//   const trialExpiredNoUpgrade =
//     s.trialExpiredNoUpgrade ?? s.TrialExpiredNoUpgrade ?? 0;

//   const activationRate =
//     totalAccounts > 0 ? ((activeAccounts + paidPlan) / totalAccounts) * 100 : 0;

//   const paidConversionRate =
//     totalAccounts > 0 ? (paidPlan / totalAccounts) * 100 : 0;

//   // Temporary sample trends (replace with real series later)
//   const labels = ["Week 1", "Week 2", "Week 3", "Week 4"];
//   const newAccountsTrend = [2, 4, 3, 5];
//   const usageTrend = [1, 3, 2, 4];

//   return (
//     <div className="px-6 py-4 space-y-6">
//       {/* Header */}
//       <div className="flex flex-col gap-1">
//         <h1 className="text-2xl font-semibold text-slate-900">
//           Account Insights Overview
//         </h1>
//         <p className="text-sm text-slate-500 max-w-3xl">
//           High-level intelligence across all accounts: signup quality,
//           activation, lifecycle stages, trials, and paid distribution.
//         </p>
//       </div>

//       <InsightsTabs />

//       {loading && (
//         <div className="w-full py-10 flex items-center justify-center">
//           <div className="text-sm text-slate-500">
//             Loading Account Insights...
//           </div>
//         </div>
//       )}

//       {!loading && (
//         <>
//           {/* Core counts */}
//           <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
//             <MetricCard
//               label="Total Accounts"
//               value={totalAccounts}
//               subtitle="All businesses registered on the platform."
//               highlight
//             />
//             <MetricCard
//               label="Active"
//               value={activeAccounts}
//               subtitle="Currently healthy & engaged."
//             />
//             <MetricCard
//               label="At Risk"
//               value={atRisk}
//               subtitle="Low recent usage; watch closely."
//             />
//             <MetricCard
//               label="Dormant"
//               value={dormant}
//               subtitle="Idle for a long time."
//             />
//           </div>

//           {/* Lifecycle risk */}
//           <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
//             <MetricCard
//               label="No Usage Post-Approval"
//               value={noUsage}
//               subtitle="Approved but never used ‚Äî top churn risk."
//             />
//             <MetricCard
//               label="Activation Rate"
//               value={`${activationRate.toFixed(1)}%`}
//               subtitle="(Active + Paid) / Total Accounts"
//             />
//             <MetricCard
//               label="Paid Conversion"
//               value={`${paidConversionRate.toFixed(1)}%`}
//               subtitle="Paid / Total Accounts"
//             />
//           </div>

//           {/* Plan & trial snapshot */}
//           <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
//             <MetricCard
//               label="On Trial Plan"
//               value={trialPlan}
//               subtitle="Currently on a trial plan."
//             />
//             <MetricCard
//               label="On Paid Plan"
//               value={paidPlan}
//               subtitle="Any paid subscription."
//               highlight
//             />
//             <MetricCard
//               label="Unknown Plan"
//               value={unknownPlan}
//               subtitle="Check mapping / billing sync."
//             />
//           </div>

//           <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
//             <MetricCard
//               label="Trials (Total)"
//               value={trialTotal}
//               subtitle="Active trials in the system."
//             />
//             <MetricCard
//               label="Trials Expiring Soon"
//               value={trialExpSoon}
//               subtitle="Ideal targets for save / upsell."
//             />
//             <MetricCard
//               label="Trials Expired, No Upgrade"
//               value={trialExpiredNoUpgrade}
//               subtitle="Lost opportunities; review patterns."
//             />
//           </div>

//           {/* Trends */}
//           <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
//             <TrendChart
//               title="New Accounts (Sample Trend)"
//               labels={labels}
//               values={newAccountsTrend}
//               type="bar"
//             />
//             <TrendChart
//               title="Active Usage Proxy (Sample)"
//               labels={labels}
//               values={usageTrend}
//               type="line"
//             />
//           </div>

//           <div className="mt-2 text-[11px] text-slate-500">
//             For deeper cohorts and actions, use the Funnels and Alerts tabs in
//             Account Insights.
//           </div>
//         </>
//       )}
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\AccountInsights\AccountFunnels.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";
import FunnelChart from "./components/FunnelChart";
import MetricCard from "./components/MetricCard";
import InsightsTabs from "./components/InsightsTabs";
import { useNavigate } from "react-router-dom";

export default function AccountFunnels() {
  const [loading, setLoading] = useState(true);
  const [summary, setSummary] = useState(null);
  const navigate = useNavigate();

  useEffect(() => {
    const load = async () => {
      try {
        setLoading(true);
        const res = await axiosClient.get("/admin/account-insights/summary");
        if (!res.data) {
          throw new Error(
            "Empty response from /admin/account-insights/summary"
          );
        }
        setSummary(res.data);
      } catch (err) {
        console.error("Failed to load funnels summary", err);
        toast.error("Failed to load Account Funnels.");
      } finally {
        setLoading(false);
      }
    };
    load();
  }, []);

  const goToSegment = segmentKey => {
    navigate(
      `/app/campaigns/CampaignWizard?segment=${encodeURIComponent(segmentKey)}`
    );
  };

  if (loading) {
    return (
      <div className="px-6 py-4">
        <div className="text-sm text-slate-500">
          Loading funnel analytics...
        </div>
      </div>
    );
  }

  const s = summary || {};
  const byStage = s.byLifecycleStage || s.ByLifecycleStage || {};

  const total = s.totalBusinesses ?? s.TotalBusinesses ?? 0;

  const trial = byStage.Trial ?? byStage["Trial"] ?? 0;
  const active = byStage.Active ?? byStage["Active"] ?? 0;
  const atRisk = byStage.AtRisk ?? byStage["AtRisk"] ?? 0;
  const dormant = byStage.Dormant ?? byStage["Dormant"] ?? 0;
  const noUsage =
    byStage.NoUsagePostApproval ?? byStage["NoUsagePostApproval"] ?? 0;

  const lifecycleSteps = [
    { label: "Total Approved/Live", value: total },
    { label: "Active", value: active },
    { label: "At Risk", value: atRisk },
    { label: "Dormant", value: dormant },
  ];

  const usageSteps = [
    { label: "Approved/Live", value: total },
    { label: "No Usage Post-Approval", value: noUsage },
    { label: "Healthy (Active)", value: active },
  ];

  return (
    <div className="px-6 py-4 space-y-6">
      <div className="flex flex-col gap-1">
        <h1 className="text-2xl font-semibold text-slate-900">
          Account Funnels & Stages
        </h1>
        <p className="text-sm text-slate-500 max-w-3xl">
          View how accounts flow across lifecycle stages and jump directly into
          targeted recovery or upgrade campaigns.
        </p>
      </div>

      <InsightsTabs />

      {/* Stage snapshot */}
      <div className="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-5 gap-4">
        <MetricCard
          label="Total"
          value={total}
          subtitle="All known businesses."
          highlight
        />
        <MetricCard label="Active" value={active} subtitle="Healthy usage." />
        <MetricCard
          label="At Risk"
          value={atRisk}
          subtitle="Low recent usage."
        />
        <MetricCard
          label="Dormant"
          value={dormant}
          subtitle="Long-term idle."
        />
        <MetricCard
          label="No Usage Post-Approval"
          value={noUsage}
          subtitle="Approved but never active."
        />
      </div>

      {/* Lifecycle funnel */}
      <FunnelChart title="Lifecycle Funnel (Health)" steps={lifecycleSteps} />
      <div className="flex flex-wrap gap-2 text-[10px] mt-1">
        <button
          onClick={() => goToSegment("registered-never-active")}
          className="px-2 py-1 rounded-full border border-slate-200 bg-slate-50 text-slate-700 hover:bg-slate-100"
        >
          Target: Registered / Approved, Never Active
        </button>
        <button
          onClick={() => goToSegment("at-risk")}
          className="px-2 py-1 rounded-full border border-amber-200 bg-amber-50 text-amber-700 hover:bg-amber-100"
        >
          Target: At-Risk Accounts
        </button>
        <button
          onClick={() => goToSegment("dormant")}
          className="px-2 py-1 rounded-full border border-red-200 bg-red-50 text-red-700 hover:bg-red-100"
        >
          Target: Dormant Accounts
        </button>
      </div>

      {/* Usage / WA funnel */}
      <FunnelChart title="Usage / WA Engagement Funnel" steps={usageSteps} />
      <div className="flex flex-wrap gap-2 text-[10px] mt-1">
        <button
          onClick={() => goToSegment("no-usage-post-approval")}
          className="px-2 py-1 rounded-full border border-purple-200 bg-purple-50 text-purple-700 hover:bg-purple-100"
        >
          Target: No Usage Post-Approval
        </button>
        <button
          onClick={() => goToSegment("healthy-active")}
          className="px-2 py-1 rounded-full border border-emerald-200 bg-emerald-50 text-emerald-700 hover:bg-emerald-100"
        >
          Target: Healthy Active (for cross-sell)
        </button>
      </div>

      <div className="mt-2 text-[10px] text-slate-500">
        These funnels are built from the same summary data your alerts use.
        Later, a dedicated Segment API can resolve these CTAs into live
        audiences.
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\AccountInsights\AccountInsightsLayout.jsx 
====================================================== 
 
// üìÑ src/pages/AccountInsights/AccountInsightsLayout.jsx
import React from "react";
import InsightsTabs from "./components/InsightsTabs";

export default function AccountInsightsLayout({
  title,
  description,
  meta,
  children,
}) {
  return (
    <div className="min-h-screen bg-slate-50 px-6 py-6">
      <div className="max-w-7xl mx-auto space-y-6">
        {/* Header */}
        <div className="flex items-start justify-between gap-4">
          <div className="space-y-1">
            <h1 className="text-xl font-semibold text-slate-900 tracking-tight">
              {title}
            </h1>
            {description && (
              <p className="text-xs text-slate-600 max-w-2xl">{description}</p>
            )}
          </div>
          {meta && (
            <div className="flex flex-col items-end gap-1 text-[9px] text-slate-500">
              {meta}
            </div>
          )}
        </div>

        <InsightsTabs />

        {/* Page content */}
        <div className="space-y-6">{children}</div>
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\AccountInsights\AccountReports\AccountDetailDrawer.jsx 
====================================================== 
 
// import React, { useEffect, useState } from "react";
// import axiosClient from "../../../api/axiosClient";
// import { useNavigate } from "react-router-dom";
// import { toast } from "react-toastify";
// import { ArrowUpRight, PhoneCall, MessageCircle, Clock4 } from "lucide-react";

// /**
//  * Right-side account detail drawer.
//  *
//  * Props:
//  * - businessId: string | null
//  * - onClose: () => void
//  * - onUpdated?: (updated: any) => void
//  */
// export default function AccountDetailDrawer({
//   businessId,
//   onClose,
//   onUpdated,
// }) {
//   const [data, setData] = useState(null);
//   const [loading, setLoading] = useState(false);

//   const [recentActions, setRecentActions] = useState([]);
//   const [actionsLoading, setActionsLoading] = useState(false);

//   const navigate = useNavigate();

//   // --- Load account snapshot on businessId change ---
//   useEffect(() => {
//     if (!businessId) {
//       setData(null);
//       setRecentActions([]);
//       return;
//     }

//     let cancelled = false;

//     const load = async () => {
//       try {
//         setLoading(true);
//         const res = await axiosClient.get(
//           `/admin/account-insights/${businessId}`
//         );
//         if (!cancelled) {
//           setData(res.data || null);
//         }
//       } catch (err) {
//         console.error("Failed to load account detail", err);
//         if (!cancelled) setData(null);
//       } finally {
//         if (!cancelled) setLoading(false);
//       }
//     };

//     load();
//     return () => {
//       cancelled = true;
//     };
//   }, [businessId]);

//   // --- Load recent actions (timeline) on businessId change ---
//   useEffect(() => {
//     if (!businessId) {
//       setRecentActions([]);
//       return;
//     }

//     let cancelled = false;

//     const loadActions = async () => {
//       try {
//         setActionsLoading(true);
//         const res = await axiosClient.get(
//           `/admin/account-insights/${businessId}/actions`,
//           {
//             params: { limit: 10 },
//           }
//         );

//         if (cancelled) return;

//         const raw = res.data || [];
//         const items = Array.isArray(raw)
//           ? raw
//           : Array.isArray(raw.items)
//           ? raw.items
//           : Array.isArray(raw.data)
//           ? raw.data
//           : [];

//         const normalized = items
//           .map(a => {
//             const type = a.type || a.actionType || "ACTION";
//             let meta = {};
//             if (a.metaJson) {
//               try {
//                 meta = JSON.parse(a.metaJson);
//               } catch {
//                 meta = {};
//               }
//             }

//             const label =
//               a.label || prettyLabelFromType(type, meta) || "Account activity";

//             return {
//               id:
//                 a.id ||
//                 `${type}-${a.createdAt || a.timestamp || Math.random()}`,
//               type,
//               label,
//               actor: a.actor || a.performedBy || null,
//               createdAt: a.createdAt || a.timestamp || null,
//               meta,
//             };
//           })
//           .sort((a, b) => {
//             const ta = a.createdAt ? new Date(a.createdAt).getTime() : 0;
//             const tb = b.createdAt ? new Date(b.createdAt).getTime() : 0;
//             return tb - ta;
//           });

//         setRecentActions(normalized);
//       } catch (err) {
//         // 404 or any failure ‚Üí treat as "no actions" for now
//         if (!cancelled) {
//           console.error("Failed to load recent actions", err);
//           setRecentActions([]);
//         }
//       } finally {
//         if (!cancelled) setActionsLoading(false);
//       }
//     };

//     loadActions();
//     return () => {
//       cancelled = true;
//     };
//   }, [businessId]);

//   // --- Close on Escape ---
//   useEffect(() => {
//     if (!businessId) return;

//     const handleKey = e => {
//       if (e.key === "Escape") {
//         onClose?.();
//       }
//     };

//     window.addEventListener("keydown", handleKey);
//     return () => window.removeEventListener("keydown", handleKey);
//   }, [businessId, onClose]);

//   if (!businessId) return null;

//   // --- Derived flags from snapshot + timeline ---

//   const businessKey = data?.businessId || data?.id || businessId;

//   const stage = (
//     data?.lifecycleStage ||
//     data?.stage ||
//     data?.lifecycle ||
//     ""
//   ).trim();

//   const plan = (data?.planName || data?.planType || data?.plan || "").trim();

//   const daysToTrialEnd =
//     typeof data?.daysToTrialEnd === "number" ? data.daysToTrialEnd : null;

//   const isTrial =
//     stage === "Trial" || plan === "Trial" || data?.isTrial === true;

//   const isNearTrialEnd =
//     isTrial && daysToTrialEnd !== null && daysToTrialEnd <= 5;

//   const hasWhatsApp =
//     data?.hasWhatsAppConfigured === true ||
//     data?.whatsAppConnected === true ||
//     data?.whatsAppStatus === "Connected";

//   // Most recent TAG_CONTACTED from timeline (if any)
//   const lastContactedAction = recentActions.find(
//     a => a.type === "TAG_CONTACTED"
//   );

//   const lastContactedAt =
//     lastContactedAction?.createdAt || data?.lastContactedAt || null;

//   // "Contacted" means we've touched them at least once
//   const isContacted =
//     !!lastContactedAt || data?.isContacted === true || !!data?.lastOutreachOn;

//   // Normalize stage to lowercase for case-insensitive comparison
//   const normalizedStage = (stage || "").toLowerCase();

//   const canShowExtendTrial =
//     !!businessKey &&
//     isTrial &&
//     isNearTrialEnd &&
//     data?.canExtendTrial !== false;

//   // allow multiple contact logs; stage-gated, NOT blocked after first contact
//   const canShowTagAsContacted =
//     !!businessKey &&
//     [
//       "trial",
//       "trialexpiringsoon",
//       "nousagepostapproval",
//       "risk",
//       "churned",
//       "demo",
//     ].includes(normalizedStage);

//   const canShowViewWhatsAppSettings =
//     !!businessKey &&
//     (hasWhatsApp || ["Active", "Trial", "Risk"].includes(stage));

//   // --- Micro-actions ---

//   const handleOpenBusinessProfile = () => {
//     if (!businessKey) {
//       toast.error("Business id missing for this account.");
//       return;
//     }
//     navigate(`/admin/accounts/${businessKey}`);
//     onClose?.();
//   };

//   const handleTagAsContacted = async () => {
//     if (!businessKey) {
//       toast.error("Business id missing.");
//       return;
//     }

//     try {
//       const res = await axiosClient.post(
//         `/admin/account-insights/${businessKey}/mark-contacted`
//       );

//       if (res.data?.ok === false) {
//         toast.error(res.data.message || "Failed to log contact.");
//         return;
//       }

//       const now = new Date().toISOString();

//       // Optimistically prepend timeline entry
//       prependLocalAction("TAG_CONTACTED", {
//         label: "Contacted account",
//       });

//       // Update local snapshot-ish view
//       const updated = {
//         ...(data || {}),
//         isContacted: true,
//         lastContactedAt: now,
//       };
//       setData(updated);
//       onUpdated?.(updated);

//       toast.success(
//         isContacted ? "Additional contact logged." : "Contact logged."
//       );
//     } catch (err) {
//       console.error(err);
//       toast.error("Error while logging contact.");
//     }
//   };

//   const handleViewWhatsAppSettings = () => {
//     if (!businessKey) {
//       toast.error("Business id missing.");
//       return;
//     }
//     navigate(`/admin/accounts/${businessKey}/whatsapp-settings`);
//     onClose?.();
//   };

//   const handleExtendTrial = async () => {
//     if (!businessKey) {
//       toast.error("Business id missing.");
//       return;
//     }

//     const extraDays = 7;

//     try {
//       const res = await axiosClient.post(
//         `/admin/account-insights/${businessKey}/extend-trial`,
//         { extraDays }
//       );

//       if (!res.data || res.data.ok === false) {
//         toast.error(res.data?.message || "Unable to extend trial.");
//         return;
//       }

//       const snapshot = res.data.snapshot;

//       if (snapshot) {
//         // Backend already recomputed AccountInsightsSnapshotDto
//         setData(snapshot);
//         onUpdated?.(snapshot);
//       } else {
//         // Fallback: patch current view in case snapshot is missing
//         const newEnd = res.data.newEnd || data?.trialEndsOn || null;

//         const updated = {
//           ...(data || {}),
//           trialEndsOn: newEnd,
//         };

//         setData(updated);
//         onUpdated?.(updated);
//       }

//       prependLocalAction("EXTEND_TRIAL", {
//         label: `Trial extended by ${extraDays} days`,
//       });

//       toast.success("Trial extended successfully.");
//     } catch (err) {
//       console.error(err);
//       toast.error("Error while extending trial.");
//     }
//   };

//   // --- Local helper: optimistic prepend to timeline ---

//   const prependLocalAction = (type, { label }) => {
//     const now = new Date().toISOString();
//     setRecentActions(prev => [
//       {
//         id: `local-${type}-${now}`,
//         type,
//         label: label || prettyLabelFromType(type) || "Account activity",
//         actor: "You",
//         createdAt: now,
//         meta: {},
//       },
//       ...prev,
//     ]);
//   };

//   // --- UI ---

//   return (
//     <div
//       className="
//         fixed inset-y-0 right-0
//         z-40
//         w-full sm:w-[420px]
//         bg-white
//         border-l border-slate-200
//         shadow-xl
//         flex flex-col
//         animate-account-drawer-in
//       "
//     >
//       {/* Header */}
//       <div className="flex items-center justify-between px-5 py-4 border-b border-slate-200 bg-slate-50">
//         <div>
//           <h2 className="text-base font-semibold text-slate-900">
//             Account details
//           </h2>
//         </div>
//         <button
//           onClick={onClose}
//           className="
//             h-7 w-7 flex items-center justify-center
//             rounded-full border border-slate-300
//             text-slate-500 hover:text-slate-900 hover:border-slate-500
//             text-lg leading-none
//           "
//           aria-label="Close details"
//         >
//           √ó
//         </button>
//       </div>

//       {/* Content */}
//       <div className="flex-1 overflow-y-auto px-5 py-4 space-y-4">
//         {loading && (
//           <div className="text-sm text-slate-500 text-center py-6">
//             Loading details‚Ä¶
//           </div>
//         )}

//         {!loading && !data && (
//           <div className="text-sm text-slate-500 text-center py-6">
//             No additional details available for this account.
//           </div>
//         )}

//         {!loading && data && (
//           <>
//             <Section title="Core">
//               <DetailRow
//                 label="Business name"
//                 value={data.businessName || data.name}
//               />
//               <DetailRow label="Business ID" value={businessKey} />
//               <DetailRow label="Lifecycle stage" value={stage || "‚Äî"} />
//               <DetailRow label="Plan" value={plan || "‚Äî"} />
//               <DetailRow
//                 label="Status"
//                 value={
//                   data.status ||
//                   data.approvalStatus ||
//                   data.accountStatus ||
//                   "‚Äî"
//                 }
//               />
//             </Section>

//             <Section title="Activity & Trial">
//               <DetailRow label="Trial ends" value={data.trialEndsOn || "‚Äî"} />
//               <DetailRow
//                 label="Trial days left"
//                 value={
//                   daysToTrialEnd !== null
//                     ? daysToTrialEnd
//                     : isTrial
//                     ? "‚Äî"
//                     : "N/A"
//                 }
//               />
//               <DetailRow
//                 label="Last active"
//                 value={
//                   data.lastActiveOn ||
//                   data.lastSeenAt ||
//                   data.lastActivityOn ||
//                   "‚Äî"
//                 }
//               />
//               <DetailRow
//                 label="Last contacted"
//                 value={lastContactedAt ? formatWhen(lastContactedAt) : "‚Äî"}
//               />
//               <DetailRow
//                 label="Created at"
//                 value={
//                   data.createdAt || data.createdOn || data.signupDate || "‚Äî"
//                 }
//               />
//             </Section>

//             {(data.ownerEmail || data.ownerName) && (
//               <Section title="Owner">
//                 <DetailRow label="Owner email" value={data.ownerEmail || "‚Äî"} />
//                 {data.ownerName && (
//                   <DetailRow label="Owner name" value={data.ownerName} />
//                 )}
//               </Section>
//             )}

//             {/* Recent Activity Timeline */}
//             <Section title="Recent activity">
//               {actionsLoading && (
//                 <div className="text-[11px] text-slate-500">
//                   Loading activity‚Ä¶
//                 </div>
//               )}

//               {!actionsLoading && recentActions.length === 0 && (
//                 <div className="text-[11px] text-slate-500">
//                   No recent actions recorded for this account.
//                 </div>
//               )}

//               {!actionsLoading && recentActions.length > 0 && (
//                 <div className="space-y-1.5 text-[11px]">
//                   {recentActions.map(a => (
//                     <div key={a.id} className="flex items-start gap-2">
//                       <div className="w-1 h-1 mt-1.5 rounded-full bg-slate-400" />
//                       <div className="flex-1">
//                         <div className="text-slate-800">{a.label}</div>
//                         <div className="text-[10px] text-slate-500">
//                           {formatWhen(a.createdAt)}
//                           {a.actor ? ` ¬∑ ${a.actor}` : ""}
//                         </div>
//                       </div>
//                     </div>
//                   ))}
//                 </div>
//               )}
//             </Section>
//           </>
//         )}
//       </div>

//       {/* Micro-actions */}
//       <div className="px-5 py-3 border-t border-slate-200 bg-slate-50">
//         <div className="text-[10px] font-semibold text-slate-500 uppercase tracking-[0.14em] mb-1.5">
//           Quick actions
//         </div>

//         {data ? (
//           <div className="space-y-1.5 text-xs">
//             {/* Always */}
//             <button
//               onClick={handleOpenBusinessProfile}
//               className="
//                 w-full flex items-center justify-between
//                 px-3 py-2 rounded-md
//                 bg-slate-900 text-slate-50
//                 hover:bg-slate-800
//                 transition
//               "
//             >
//               <span className="flex items-center gap-2">
//                 <ArrowUpRight className="w-3 h-3" />
//                 Open Business Profile
//               </span>
//               <span className="text-[9px] text-slate-300">Full context</span>
//             </button>

//             {canShowTagAsContacted && (
//               <button
//                 onClick={handleTagAsContacted}
//                 className="
//                   w-full flex items-center justify-between
//                   px-3 py-2 rounded-md
//                   bg-emerald-50 text-emerald-900
//                   border border-emerald-200
//                   hover:bg-emerald-100
//                   transition
//                 "
//               >
//                 <span className="flex items-center gap-2">
//                   <PhoneCall className="w-3 h-3" />
//                   {isContacted ? "Log another contact" : "Tag as Contacted"}
//                 </span>
//                 <span className="text-[9px] text-emerald-700">
//                   Touchpoint history
//                 </span>
//               </button>
//             )}

//             {canShowViewWhatsAppSettings && (
//               <button
//                 onClick={handleViewWhatsAppSettings}
//                 className="
//                   w-full flex items-center justify-between
//                   px-3 py-2 rounded-md
//                   bg-sky-50 text-sky-900
//                   border border-sky-200
//                   hover:bg-sky-100
//                   transition
//                 "
//               >
//                 <span className="flex items-center gap-2">
//                   <MessageCircle className="w-3 h-3" />
//                   View WhatsApp Settings
//                 </span>
//                 <span className="text-[9px] text-sky-700">
//                   Channel readiness
//                 </span>
//               </button>
//             )}

//             {canShowExtendTrial && (
//               <button
//                 onClick={handleExtendTrial}
//                 className="
//                   w-full flex items-center justify-between
//                   px-3 py-2 rounded-md
//                   bg-amber-50 text-amber-900
//                   border border-amber-200
//                   hover:bg-amber-100
//                   transition
//                 "
//               >
//                 <span className="flex items-center gap-2">
//                   <Clock4 className="w-3 h-3" />
//                   Extend Trial by 7 days
//                 </span>
//                 <span className="text-[9px] text-amber-700">
//                   Retain high-intent
//                 </span>
//               </button>
//             )}

//             {!canShowTagAsContacted &&
//               !canShowViewWhatsAppSettings &&
//               !canShowExtendTrial && (
//                 <div className="text-[10px] text-slate-500">
//                   No special actions for this account right now.
//                 </div>
//               )}
//           </div>
//         ) : (
//           <div className="text-[10px] text-slate-500">
//             Actions will appear once account details are loaded.
//           </div>
//         )}

//         <div className="mt-2 text-[10px] text-slate-400">
//           Press <span className="font-semibold">Esc</span> or click{" "}
//           <span className="font-semibold">√ó</span> to close. Selecting another
//           row updates this panel automatically.
//         </div>
//       </div>

//       {/* Slide-in animation */}
//       <style>{`
//         @keyframes account-drawer-in {
//           from { transform: translateX(100%); opacity: 0; }
//           to { transform: translateX(0); opacity: 1; }
//         }
//         .animate-account-drawer-in {
//           animation: account-drawer-in 0.22s ease-out;
//         }
//       `}</style>
//     </div>
//   );
// }

// /* ----- Helpers ----- */

// function Section({ title, children }) {
//   return (
//     <div className="space-y-2">
//       <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-[0.14em]">
//         {title}
//       </h3>
//       <div className="space-y-1.5">{children}</div>
//     </div>
//   );
// }

// function DetailRow({ label, value }) {
//   return (
//     <div className="flex justify-between gap-3 border-b border-slate-100 pb-1.5">
//       <div className="text-xs font-medium text-slate-600">{label}</div>
//       <div className="text-sm font-semibold text-slate-900 text-right truncate max-w-[220px]">
//         {value != null && value !== "" ? value : "‚Äî"}
//       </div>
//     </div>
//   );
// }

// function formatWhen(ts) {
//   if (!ts) return "";
//   const d = new Date(ts);
//   if (Number.isNaN(d.getTime())) return "";
//   return d.toLocaleString();
// }

// function prettyLabelFromType(type, meta = {}) {
//   switch (type) {
//     case "TAG_CONTACTED":
//       return "Tagged as contacted";
//     case "EXTEND_TRIAL":
//       if (typeof meta.extraDays === "number") {
//         return `Trial extended by ${meta.extraDays} days`;
//       }
//       return "Trial extended";
//     default:
//       return null;
//   }
// // }
// import React, { useEffect, useState, useRef } from "react";
// import axiosClient from "../../../api/axiosClient";
// import { useNavigate } from "react-router-dom";
// import { toast } from "react-toastify";
// import {
//   ArrowUpRight,
//   PhoneCall,
//   MessageCircle,
//   Clock4,
//   X,
// } from "lucide-react";

// /**
//  * Right-side account detail drawer.
//  *
//  * Props:
//  * - businessId: string | null
//  * - onClose: () => void
//  * - onUpdated?: (updated: any) => void
//  */
// export default function AccountDetailDrawer({
//   businessId,
//   onClose,
//   onUpdated,
// }) {
//   const [data, setData] = useState(null);
//   const [loading, setLoading] = useState(false);

//   const [recentActions, setRecentActions] = useState([]);
//   const [actionsLoading, setActionsLoading] = useState(false);

//   const navigate = useNavigate();
//   const drawerRef = useRef(null);

//   // --- Load account snapshot on businessId change ---
//   useEffect(() => {
//     if (!businessId) {
//       setData(null);
//       setRecentActions([]);
//       return;
//     }

//     let cancelled = false;

//     const load = async () => {
//       try {
//         setLoading(true);
//         const res = await axiosClient.get(
//           `/admin/account-insights/${businessId}`
//         );
//         if (!cancelled) {
//           setData(res.data || null);
//         }
//       } catch (err) {
//         console.error("Failed to load account detail", err);
//         if (!cancelled) setData(null);
//       } finally {
//         if (!cancelled) setLoading(false);
//       }
//     };

//     load();
//     return () => {
//       cancelled = true;
//     };
//   }, [businessId]);

//   // --- Load recent actions (timeline) on businessId change ---
//   useEffect(() => {
//     if (!businessId) {
//       setRecentActions([]);
//       return;
//     }

//     let cancelled = false;

//     const loadActions = async () => {
//       try {
//         setActionsLoading(true);
//         const res = await axiosClient.get(
//           `/admin/account-insights/${businessId}/actions`,
//           {
//             params: { limit: 10 },
//           }
//         );

//         if (cancelled) return;

//         const raw = res.data || [];
//         const items = Array.isArray(raw)
//           ? raw
//           : Array.isArray(raw.items)
//           ? raw.items
//           : Array.isArray(raw.data)
//           ? raw.data
//           : [];

//         const normalized = items
//           .map(a => {
//             const type = a.type || a.actionType || "ACTION";
//             let meta = {};
//             if (a.metaJson) {
//               try {
//                 meta = JSON.parse(a.metaJson);
//               } catch {
//                 meta = {};
//               }
//             }

//             const label =
//               a.label || prettyLabelFromType(type, meta) || "Account activity";

//             return {
//               id:
//                 a.id ||
//                 `${type}-${a.createdAt || a.timestamp || Math.random()}`,
//               type,
//               label,
//               actor: a.actor || a.performedBy || null,
//               createdAt: a.createdAt || a.timestamp || null,
//               meta,
//             };
//           })
//           .sort((a, b) => {
//             const ta = a.createdAt ? new Date(a.createdAt).getTime() : 0;
//             const tb = b.createdAt ? new Date(b.createdAt).getTime() : 0;
//             return tb - ta;
//           });

//         setRecentActions(normalized);
//       } catch (err) {
//         if (!cancelled) {
//           console.error("Failed to load recent actions", err);
//           setRecentActions([]);
//         }
//       } finally {
//         if (!cancelled) setActionsLoading(false);
//       }
//     };

//     loadActions();
//     return () => {
//       cancelled = true;
//     };
//   }, [businessId]);

//   // --- Close on Escape ---
//   useEffect(() => {
//     if (!businessId) return;

//     const handleKey = e => {
//       if (e.key === "Escape") {
//         onClose?.();
//       }
//     };

//     window.addEventListener("keydown", handleKey);
//     return () => window.removeEventListener("keydown", handleKey);
//   }, [businessId, onClose]);

//   // --- Close on click outside (no overlay, no blur) ---
//   useEffect(() => {
//     if (!businessId) return;

//     const handleClickOutside = event => {
//       if (!drawerRef.current) return;
//       if (!drawerRef.current.contains(event.target)) {
//         onClose?.();
//       }
//     };

//     document.addEventListener("mousedown", handleClickOutside);
//     return () => document.removeEventListener("mousedown", handleClickOutside);
//   }, [businessId, onClose]);

//   if (!businessId) return null;

//   // --- Derived flags from snapshot + timeline ---

//   const businessKey = data?.businessId || data?.id || businessId;

//   const stage = (
//     data?.lifecycleStage ||
//     data?.stage ||
//     data?.lifecycle ||
//     ""
//   ).trim();

//   const plan = (data?.planName || data?.planType || data?.plan || "").trim();

//   const daysToTrialEnd =
//     typeof data?.daysToTrialEnd === "number" ? data.daysToTrialEnd : null;

//   const isTrial =
//     stage === "Trial" || plan === "Trial" || data?.isTrial === true;

//   const isNearTrialEnd =
//     isTrial && daysToTrialEnd !== null && daysToTrialEnd <= 5;

//   const hasWhatsApp =
//     data?.hasWhatsAppConfigured === true ||
//     data?.whatsAppConnected === true ||
//     data?.whatsAppStatus === "Connected";

//   const lastContactedAction = recentActions.find(
//     a => a.type === "TAG_CONTACTED"
//   );

//   const lastContactedAt =
//     lastContactedAction?.createdAt || data?.lastContactedAt || null;

//   const isContacted =
//     !!lastContactedAt || data?.isContacted === true || !!data?.lastOutreachOn;

//   const normalizedStage = (stage || "").toLowerCase();

//   const canShowExtendTrial =
//     !!businessKey &&
//     isTrial &&
//     isNearTrialEnd &&
//     data?.canExtendTrial !== false;

//   const canShowTagAsContacted =
//     !!businessKey &&
//     [
//       "trial",
//       "trialexpiringsoon",
//       "nousagepostapproval",
//       "risk",
//       "churned",
//       "demo",
//     ].includes(normalizedStage);

//   const canShowViewWhatsAppSettings =
//     !!businessKey &&
//     (hasWhatsApp || ["Active", "Trial", "Risk"].includes(stage));

//   // --- Micro-actions ---

//   const handleOpenBusinessProfile = () => {
//     if (!businessKey) {
//       toast.error("Business id missing for this account.");
//       return;
//     }
//     navigate(`/admin/accounts/${businessKey}`);
//     onClose?.();
//   };

//   const handleTagAsContacted = async () => {
//     if (!businessKey) {
//       toast.error("Business id missing.");
//       return;
//     }

//     try {
//       const res = await axiosClient.post(
//         `/admin/account-insights/${businessKey}/mark-contacted`
//       );

//       if (res.data?.ok === false) {
//         toast.error(res.data.message || "Failed to log contact.");
//         return;
//       }

//       const now = new Date().toISOString();

//       prependLocalAction("TAG_CONTACTED", {
//         label: "Contacted account",
//       });

//       const updated = {
//         ...(data || {}),
//         isContacted: true,
//         lastContactedAt: now,
//       };
//       setData(updated);
//       onUpdated?.(updated);

//       toast.success(
//         isContacted ? "Additional contact logged." : "Contact logged."
//       );
//     } catch (err) {
//       console.error(err);
//       toast.error("Error while logging contact.");
//     }
//   };

//   const handleViewWhatsAppSettings = () => {
//     if (!businessKey) {
//       toast.error("Business id missing.");
//       return;
//     }
//     navigate(`/admin/accounts/${businessKey}/whatsapp-settings`);
//     onClose?.();
//   };

//   const handleExtendTrial = async () => {
//     if (!businessKey) {
//       toast.error("Business id missing.");
//       return;
//     }

//     const extraDays = 7;

//     try {
//       const res = await axiosClient.post(
//         `/admin/account-insights/${businessKey}/extend-trial`,
//         { extraDays }
//       );

//       if (!res.data || res.data.ok === false) {
//         toast.error(res.data?.message || "Unable to extend trial.");
//         return;
//       }

//       const snapshot = res.data.snapshot;

//       if (snapshot) {
//         setData(snapshot);
//         onUpdated?.(snapshot);
//       } else {
//         const newEnd = res.data.newEnd || data?.trialEndsOn || null;

//         const updated = {
//           ...(data || {}),
//           trialEndsOn: newEnd,
//         };

//         setData(updated);
//         onUpdated?.(updated);
//       }

//       prependLocalAction("EXTEND_TRIAL", {
//         label: `Trial extended by ${extraDays} days`,
//       });

//       toast.success("Trial extended successfully.");
//     } catch (err) {
//       console.error(err);
//       toast.error("Error while extending trial.");
//     }
//   };

//   const prependLocalAction = (type, { label }) => {
//     const now = new Date().toISOString();
//     setRecentActions(prev => [
//       {
//         id: `local-${type}-${now}`,
//         type,
//         label: label || prettyLabelFromType(type) || "Account activity",
//         actor: "You",
//         createdAt: now,
//         meta: {},
//       },
//       ...prev,
//     ]);
//   };

//   // --- UI ---

//   // return (
//   //   <div
//   //     ref={drawerRef}
//   //     className="
//   //       fixed inset-y-0 right-0
//   //       z-40
//   //       w-full sm:w-[420px]
//   //       bg-white
//   //       border-l border-slate-200
//   //       shadow-xl
//   //       flex flex-col
//   //       animate-account-drawer-in
//   //     "
//   //   >
//   //     {/* Header */}
//   //     <div className="flex items-center justify-between px-5 py-4 border-b border-slate-200 bg-slate-50">
//   //       <div>
//   //         <h2 className="text-base font-semibold text-slate-900">
//   //           Account details
//   //         </h2>
//   //       </div>
//   //       <button
//   //         onClick={onClose}
//   //         className="
//   //           h-7 w-7 flex items-center justify-center
//   //           rounded-full
//   //           bg-slate-100
//   //           text-slate-700
//   //           hover:bg-slate-200
//   //           hover:text-slate-900
//   //           border border-slate-300
//   //           transition
//   //         "
//   //         aria-label="Close details"
//   //       >
//   //         <X className="w-4 h-4" />
//   //       </button>
//   //     </div>
//   //   return (
//   //     <div
//   //       ref={drawerRef}
//   //       className="
//   //     fixed inset-y-0 right-0
//   //     z-[9999]
//   //     w-full sm:w-[420px]
//   //     bg-white
//   //     border-l border-slate-200
//   //     shadow-xl
//   //     flex flex-col
//   //     animate-account-drawer-in
//   //     "
//   //     >
//   //       {/* Header */}
//   //       <div className="flex items-center justify-between px-5 py-4 border-b border-slate-200 bg-slate-50">
//   //         <div>
//   //           <h2 className="text-base font-semibold text-slate-900">
//   //             Account details
//   //           </h2>
//   //         </div>
//   //         <button
//   //           onClick={onClose}
//   //           className="
//   //           h-7 w-7 flex items-center justify-center
//   //           rounded-full
//   //           bg-slate-100
//   //           text-slate-700
//   //           hover:bg-slate-200
//   //           hover:text-slate-900
//   //           border border-slate-300
//   //           transition
//   //         "
//   //           aria-label="Close details"
//   //         >
//   //           <X className="w-4 h-4" />
//   //         </button>
//   //       </div>

//   //       {/* Content */}
//   //       {/* <div className="flex-1 overflow-y-auto px-5 py-4 space-y-4"> */}
//   //       {/* Content */}
//   //       <div className="flex-1 px-5 py-4 space-y-4">
//   //         {loading && (
//   //           <div className="text-sm text-slate-500 text-center py-6">
//   //             Loading details‚Ä¶
//   //           </div>
//   //         )}

//   //         {!loading && !data && (
//   //           <div className="text-sm text-slate-500 text-center py-6">
//   //             No additional details available for this account.
//   //           </div>
//   //         )}

//   //         {!loading && data && (
//   //           <>
//   //             <Section title="Core">
//   //               <DetailRow
//   //                 label="Business name"
//   //                 value={data.businessName || data.name}
//   //               />
//   //               <DetailRow label="Business ID" value={businessKey} />
//   //               <DetailRow label="Lifecycle stage" value={stage || "‚Äî"} />
//   //               <DetailRow label="Plan" value={plan || "‚Äî"} />
//   //               <DetailRow
//   //                 label="Status"
//   //                 value={
//   //                   data.status ||
//   //                   data.approvalStatus ||
//   //                   data.accountStatus ||
//   //                   "‚Äî"
//   //                 }
//   //               />
//   //             </Section>

//   //             <Section title="Activity & Trial">
//   //               <DetailRow label="Trial ends" value={data.trialEndsOn || "‚Äî"} />
//   //               <DetailRow
//   //                 label="Trial days left"
//   //                 value={
//   //                   daysToTrialEnd !== null
//   //                     ? daysToTrialEnd
//   //                     : isTrial
//   //                     ? "‚Äî"
//   //                     : "N/A"
//   //                 }
//   //               />
//   //               <DetailRow
//   //                 label="Last active"
//   //                 value={
//   //                   data.lastActiveOn ||
//   //                   data.lastSeenAt ||
//   //                   data.lastActivityOn ||
//   //                   "‚Äî"
//   //                 }
//   //               />
//   //               <DetailRow
//   //                 label="Last contacted"
//   //                 value={lastContactedAt ? formatWhen(lastContactedAt) : "‚Äî"}
//   //               />
//   //               <DetailRow
//   //                 label="Created at"
//   //                 value={
//   //                   data.createdAt || data.createdOn || data.signupDate || "‚Äî"
//   //                 }
//   //               />
//   //             </Section>

//   //             {(data.ownerEmail || data.ownerName) && (
//   //               <Section title="Owner">
//   //                 <DetailRow label="Owner email" value={data.ownerEmail || "‚Äî"} />
//   //                 {data.ownerName && (
//   //                   <DetailRow label="Owner name" value={data.ownerName} />
//   //                 )}
//   //               </Section>
//   //             )}

//   //             {/* Recent Activity Timeline */}
//   //             <Section title="Recent activity">
//   //               {actionsLoading && (
//   //                 <div className="text-[11px] text-slate-500">
//   //                   Loading activity‚Ä¶
//   //                 </div>
//   //               )}

//   //               {!actionsLoading && recentActions.length === 0 && (
//   //                 <div className="text-[11px] text-slate-500">
//   //                   No recent actions recorded for this account.
//   //                 </div>
//   //               )}

//   //               {!actionsLoading && recentActions.length > 0 && (
//   //                 <div className="space-y-1.5 text-[11px] max-h-40 overflow-y-auto pr-1">
//   //                   {recentActions.map(a => (
//   //                     <div key={a.id} className="flex items-start gap-2">
//   //                       <div className="w-1 h-1 mt-1.5 rounded-full bg-slate-400" />
//   //                       <div className="flex-1">
//   //                         <div className="text-slate-800">{a.label}</div>
//   //                         <div className="text-[10px] text-slate-500">
//   //                           {formatWhen(a.createdAt)}
//   //                           {a.actor ? ` ¬∑ ${a.actor}` : ""}
//   //                         </div>
//   //                       </div>
//   //                     </div>
//   //                   ))}
//   //                 </div>
//   //               )}
//   //             </Section>
//   //           </>
//   //         )}
//   //       </div>

//   //       {/* Micro-actions */}
//   //       <div className="px-5 py-3 border-t border-slate-200 bg-slate-50">
//   //         <div className="text-[10px] font-semibold text-slate-500 uppercase tracking-[0.14em] mb-1.5">
//   //           Quick actions
//   //         </div>

//   //         {data ? (
//   //           <div className="space-y-1.5 text-xs">
//   //             {/* Always */}
//   //             <button
//   //               onClick={handleOpenBusinessProfile}
//   //               className="
//   //                 w-full flex items-center justify-between
//   //                 px-3 py-2 rounded-md
//   //                 bg-slate-900 text-slate-50
//   //                 hover:bg-slate-800
//   //                 transition
//   //               "
//   //             >
//   //               <span className="flex items-center gap-2">
//   //                 <ArrowUpRight className="w-3 h-3" />
//   //                 Open Business Profile
//   //               </span>
//   //               <span className="text-[9px] text-slate-300">Full context</span>
//   //             </button>

//   //             {canShowTagAsContacted && (
//   //               <button
//   //                 onClick={handleTagAsContacted}
//   //                 className="
//   //                   w-full flex items-center justify-between
//   //                   px-3 py-2 rounded-md
//   //                   bg-emerald-50 text-emerald-900
//   //                   border border-emerald-200
//   //                   hover:bg-emerald-100
//   //                   transition
//   //                 "
//   //               >
//   //                 <span className="flex items-center gap-2">
//   //                   <PhoneCall className="w-3 h-3" />
//   //                   {isContacted ? "Log another contact" : "Tag as Contacted"}
//   //                 </span>
//   //                 <span className="text-[9px] text-emerald-700">
//   //                   Touchpoint history
//   //                 </span>
//   //               </button>
//   //             )}

//   //             {canShowViewWhatsAppSettings && (
//   //               <button
//   //                 onClick={handleViewWhatsAppSettings}
//   //                 className="
//   //                   w-full flex items-center justify-between
//   //                   px-3 py-2 rounded-md
//   //                   bg-sky-50 text-sky-900
//   //                   border border-sky-200
//   //                   hover:bg-sky-100
//   //                   transition
//   //                 "
//   //               >
//   //                 <span className="flex items-center gap-2">
//   //                   <MessageCircle className="w-3 h-3" />
//   //                   View WhatsApp Settings
//   //                 </span>
//   //                 <span className="text-[9px] text-sky-700">
//   //                   Channel readiness
//   //                 </span>
//   //               </button>
//   //             )}

//   //             {canShowExtendTrial && (
//   //               <button
//   //                 onClick={handleExtendTrial}
//   //                 className="
//   //                   w-full flex items-center justify-between
//   //                   px-3 py-2 rounded-md
//   //                   bg-amber-50 text-amber-900
//   //                   border border-amber-200
//   //                   hover:bg-amber-100
//   //                   transition
//   //                 "
//   //               >
//   //                 <span className="flex items-center gap-2">
//   //                   <Clock4 className="w-3 h-3" />
//   //                   Extend Trial by 7 days
//   //                 </span>
//   //                 <span className="text-[9px] text-amber-700">
//   //                   Retain high-intent
//   //                 </span>
//   //               </button>
//   //             )}

//   //             {!canShowTagAsContacted &&
//   //               !canShowViewWhatsAppSettings &&
//   //               !canShowExtendTrial && (
//   //                 <div className="text-[10px] text-slate-500">
//   //                   No special actions for this account right now.
//   //                 </div>
//   //               )}
//   //           </div>
//   //         ) : (
//   //           <div className="text-[10px] text-slate-500">
//   //             Actions will appear once account details are loaded.
//   //           </div>
//   //         )}

//   //         <div className="mt-2 text-[10px] text-slate-400">
//   //           Press <span className="font-semibold">Esc</span>, click outside the
//   //           panel, or use the <span className="font-semibold">X</span> button to
//   //           close.
//   //         </div>
//   //       </div>

//   //       {/* Slide-in animation */}
//   //       <style>{`
//   //         @keyframes account-drawer-in {
//   //           from { transform: translateX(100%); opacity: 0; }
//   //           to { transform: translateX(0); opacity: 1; }
//   //         }
//   //         .animate-account-drawer-in {
//   //           animation: account-drawer-in 0.22s ease-out;
//   //         }
//   //       `}</style>
//   //     </div>
//   //   );
//   // }
//   // --- UI ---
//   return (
//     <div
//       ref={drawerRef}
//       className="
//         fixed inset-y-0 right-0
//         z-[9999]
//         w-full sm:w-[420px]
//         bg-white
//         border-l border-slate-200
//         shadow-xl
//         flex flex-col
//         animate-account-drawer-in
//       "
//     >
//       {/* Header */}
//       <div className="flex items-center justify-between px-5 py-4 border-b border-slate-200 bg-slate-50">
//         <div>
//           <h2 className="text-base font-semibold text-slate-900">
//             Account details
//           </h2>
//         </div>
//         <button
//           onClick={onClose}
//           className="
//             h-7 w-7 flex items-center justify-center
//             rounded-full
//             bg-slate-100
//             text-slate-700
//             hover:bg-slate-200
//             hover:text-slate-900
//             border border-slate-300
//             transition
//           "
//           aria-label="Close details"
//         >
//           <X className="w-4 h-4" />
//         </button>
//       </div>

//       {/* Main content: top sections + scrollable recent activity */}
//       <div className="flex-1 flex flex-col px-5 py-4 gap-4 overflow-hidden">
//         {loading && (
//           <div className="text-sm text-slate-500 text-center py-6">
//             Loading details‚Ä¶
//           </div>
//         )}

//         {!loading && !data && (
//           <div className="text-sm text-slate-500 text-center py-6">
//             No additional details available for this account.
//           </div>
//         )}

//         {!loading && data && (
//           <>
//             {/* Non-scroll sections */}
//             <div className="space-y-4">
//               <Section title="Core">
//                 <DetailRow
//                   label="Business name"
//                   value={data.businessName || data.name}
//                 />
//                 <DetailRow label="Business ID" value={businessKey} />
//                 <DetailRow label="Lifecycle stage" value={stage || "‚Äî"} />
//                 <DetailRow label="Plan" value={plan || "‚Äî"} />
//                 <DetailRow
//                   label="Status"
//                   value={
//                     data.status ||
//                     data.approvalStatus ||
//                     data.accountStatus ||
//                     "‚Äî"
//                   }
//                 />
//               </Section>

//               <Section title="Activity & Trial">
//                 <DetailRow label="Trial ends" value={data.trialEndsOn || "‚Äî"} />
//                 <DetailRow
//                   label="Trial days left"
//                   value={
//                     daysToTrialEnd !== null
//                       ? daysToTrialEnd
//                       : isTrial
//                       ? "‚Äî"
//                       : "N/A"
//                   }
//                 />
//                 <DetailRow
//                   label="Last active"
//                   value={
//                     data.lastActiveOn ||
//                     data.lastSeenAt ||
//                     data.lastActivityOn ||
//                     "‚Äî"
//                   }
//                 />
//                 <DetailRow
//                   label="Last contacted"
//                   value={lastContactedAt ? formatWhen(lastContactedAt) : "‚Äî"}
//                 />
//                 <DetailRow
//                   label="Created at"
//                   value={
//                     data.createdAt || data.createdOn || data.signupDate || "‚Äî"
//                   }
//                 />
//               </Section>

//               {(data.ownerEmail || data.ownerName) && (
//                 <Section title="Owner">
//                   <DetailRow
//                     label="Owner email"
//                     value={data.ownerEmail || "‚Äî"}
//                   />
//                   {data.ownerName && (
//                     <DetailRow label="Owner name" value={data.ownerName} />
//                   )}
//                 </Section>
//               )}
//             </div>

//             {/* Recent Activity: fills remaining space, scrolls internally */}
//             <div className="flex-1 min-h-0">
//               <Section title="Recent activity">
//                 {actionsLoading && (
//                   <div className="text-[11px] text-slate-500">
//                     Loading activity‚Ä¶
//                   </div>
//                 )}

//                 {!actionsLoading && recentActions.length === 0 && (
//                   <div className="text-[11px] text-slate-500">
//                     No recent actions recorded for this account.
//                   </div>
//                 )}

//                 {!actionsLoading && recentActions.length > 0 && (
//                   <div className="space-y-1.5 text-[11px] h-full overflow-y-auto pr-1">
//                     {recentActions.map(a => (
//                       <div key={a.id} className="flex items-start gap-2">
//                         <div className="w-1 h-1 mt-1.5 rounded-full bg-slate-400" />
//                         <div className="flex-1">
//                           <div className="text-slate-800">{a.label}</div>
//                           <div className="text-[10px] text-slate-500">
//                             {formatWhen(a.createdAt)}
//                             {a.actor ? ` ¬∑ ${a.actor}` : ""}
//                           </div>
//                         </div>
//                       </div>
//                     ))}
//                   </div>
//                 )}
//               </Section>
//             </div>
//           </>
//         )}
//       </div>

//       {/* Quick actions: pinned at bottom */}
//       <div className="px-5 py-3 border-t border-slate-200 bg-slate-50">
//         <div className="text-[10px] font-semibold text-slate-500 uppercase tracking-[0.14em] mb-1.5">
//           Quick actions
//         </div>

//         {data ? (
//           <div className="space-y-1.5 text-xs">
//             {/* Always */}
//             <button
//               onClick={handleOpenBusinessProfile}
//               className="
//                 w-full flex items-center justify-between
//                 px-3 py-2 rounded-md
//                 bg-slate-900 text-slate-50
//                 hover:bg-slate-800
//                 transition
//               "
//             >
//               <span className="flex items-center gap-2">
//                 <ArrowUpRight className="w-3 h-3" />
//                 Open Business Profile
//               </span>
//               <span className="text-[9px] text-slate-300">Full context</span>
//             </button>

//             {canShowTagAsContacted && (
//               <button
//                 onClick={handleTagAsContacted}
//                 className="
//                   w-full flex items-center justify-between
//                   px-3 py-2 rounded-md
//                   bg-emerald-50 text-emerald-900
//                   border border-emerald-200
//                   hover:bg-emerald-100
//                   transition
//                 "
//               >
//                 <span className="flex items-center gap-2">
//                   <PhoneCall className="w-3 h-3" />
//                   {isContacted ? "Log another contact" : "Tag as Contacted"}
//                 </span>
//                 <span className="text-[9px] text-emerald-700">
//                   Touchpoint history
//                 </span>
//               </button>
//             )}

//             {canShowViewWhatsAppSettings && (
//               <button
//                 onClick={handleViewWhatsAppSettings}
//                 className="
//                   w-full flex items-center justify-between
//                   px-3 py-2 rounded-md
//                   bg-sky-50 text-sky-900
//                   border border-sky-200
//                   hover:bg-sky-100
//                   transition
//                 "
//               >
//                 <span className="flex items-center gap-2">
//                   <MessageCircle className="w-3 h-3" />
//                   View WhatsApp Settings
//                 </span>
//                 <span className="text-[9px] text-sky-700">
//                   Channel readiness
//                 </span>
//               </button>
//             )}

//             {canShowExtendTrial && (
//               <button
//                 onClick={handleExtendTrial}
//                 className="
//                   w-full flex items-center justify-between
//                   px-3 py-2 rounded-md
//                   bg-amber-50 text-amber-900
//                   border border-amber-200
//                   hover:bg-amber-100
//                   transition
//                 "
//               >
//                 <span className="flex items-center gap-2">
//                   <Clock4 className="w-3 h-3" />
//                   Extend Trial by 7 days
//                 </span>
//                 <span className="text-[9px] text-amber-700">
//                   Retain high-intent
//                 </span>
//               </button>
//             )}

//             {!canShowTagAsContacted &&
//               !canShowViewWhatsAppSettings &&
//               !canShowExtendTrial && (
//                 <div className="text-[10px] text-slate-500">
//                   No special actions for this account right now.
//                 </div>
//               )}
//           </div>
//         ) : (
//           <div className="text-[10px] text-slate-500">
//             Actions will appear once account details are loaded.
//           </div>
//         )}

//         <div className="mt-2 text-[10px] text-slate-400">
//           Press <span className="font-semibold">Esc</span>, click outside the
//           panel, or use the <span className="font-semibold">X</span> button to
//           close.
//         </div>
//       </div>

//       {/* Slide-in animation */}
//       <style>{`
//         @keyframes account-drawer-in {
//           from { transform: translateX(100%); opacity: 0; }
//           to { transform: translateX(0); opacity: 1; }
//         }
//         .animate-account-drawer-in {
//           animation: account-drawer-in 0.22s ease-out;
//         }
//       `}</style>
//     </div>
//   );
// }

// /* ----- Helpers ----- */

// function Section({ title, children }) {
//   return (
//     <div className="space-y-2">
//       <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-[0.14em]">
//         {title}
//       </h3>
//       <div className="space-y-1.5">{children}</div>
//     </div>
//   );
// }

// function DetailRow({ label, value }) {
//   return (
//     <div className="flex justify-between gap-3 border-b border-slate-100 pb-1.5">
//       <div className="text-xs font-medium text-slate-600">{label}</div>
//       <div className="text-sm font-semibold text-slate-900 text-right truncate max-w-[220px]">
//         {value != null && value !== "" ? value : "‚Äî"}
//       </div>
//     </div>
//   );
// }

// function formatWhen(ts) {
//   if (!ts) return "";
//   const d = new Date(ts);
//   if (Number.isNaN(d.getTime())) return "";
//   return d.toLocaleString();
// }

// function prettyLabelFromType(type, meta = {}) {
//   switch (type) {
//     case "TAG_CONTACTED":
//       return "Tagged as contacted";
//     case "EXTEND_TRIAL":
//       if (typeof meta.extraDays === "number") {
//         return `Trial extended by ${meta.extraDays} days`;
//       }
//       return "Trial extended";
//     default:
//       return null;
//   }
// }
import React, { useEffect, useState, useRef } from "react";
import axiosClient from "../../../api/axiosClient";
import { useNavigate } from "react-router-dom";
import { toast } from "react-toastify";
import {
  ArrowUpRight,
  PhoneCall,
  MessageCircle,
  Clock4,
  X,
} from "lucide-react";

/**
 * Right-side account detail drawer.
 *
 * Props:
 * - businessId: string | null
 * - onClose: () => void
 * - onUpdated?: (updated: any) => void
 */
export default function AccountDetailDrawer({
  businessId,
  onClose,
  onUpdated,
}) {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(false);

  const [recentActions, setRecentActions] = useState([]);
  const [actionsLoading, setActionsLoading] = useState(false);

  const navigate = useNavigate();
  const drawerRef = useRef(null);

  // --- Load account snapshot on businessId change ---
  useEffect(() => {
    if (!businessId) {
      setData(null);
      setRecentActions([]);
      return;
    }

    let cancelled = false;

    const load = async () => {
      try {
        setLoading(true);
        const res = await axiosClient.get(
          `/admin/account-insights/${businessId}`
        );
        if (!cancelled) {
          setData(res.data || null);
        }
      } catch (err) {
        console.error("Failed to load account detail", err);
        if (!cancelled) setData(null);
      } finally {
        if (!cancelled) setLoading(false);
      }
    };

    load();
    return () => {
      cancelled = true;
    };
  }, [businessId]);

  // --- Load recent actions (timeline) on businessId change ---
  useEffect(() => {
    if (!businessId) {
      setRecentActions([]);
      return;
    }

    let cancelled = false;

    const loadActions = async () => {
      try {
        setActionsLoading(true);
        const res = await axiosClient.get(
          `/admin/account-insights/${businessId}/actions`,
          { params: { limit: 50 } } // can tune
        );

        if (cancelled) return;

        const raw = res.data || [];
        const items = Array.isArray(raw)
          ? raw
          : Array.isArray(raw.items)
          ? raw.items
          : Array.isArray(raw.data)
          ? raw.data
          : [];

        const normalized = items
          .map(a => {
            const type = a.type || a.actionType || "ACTION";
            let meta = {};
            if (a.metaJson) {
              try {
                meta = JSON.parse(a.metaJson);
              } catch {
                meta = {};
              }
            }

            const label =
              a.label || prettyLabelFromType(type, meta) || "Account activity";

            return {
              id:
                a.id ||
                `${type}-${a.createdAt || a.timestamp || Math.random()}`,
              type,
              label,
              actor: a.actor || a.performedBy || null,
              createdAt: a.createdAt || a.timestamp || null,
              meta,
            };
          })
          .sort((a, b) => {
            const ta = a.createdAt ? new Date(a.createdAt).getTime() : 0;
            const tb = b.createdAt ? new Date(b.createdAt).getTime() : 0;
            return tb - ta;
          });

        setRecentActions(normalized);
      } catch (err) {
        if (!cancelled) {
          console.error("Failed to load recent actions", err);
          setRecentActions([]);
        }
      } finally {
        if (!cancelled) setActionsLoading(false);
      }
    };

    loadActions();
    return () => {
      cancelled = true;
    };
  }, [businessId]);

  // --- Close on Escape ---
  useEffect(() => {
    if (!businessId) return;

    const handleKey = e => {
      if (e.key === "Escape") onClose?.();
    };

    window.addEventListener("keydown", handleKey);
    return () => window.removeEventListener("keydown", handleKey);
  }, [businessId, onClose]);

  // --- Close on click outside (no overlay) ---
  useEffect(() => {
    if (!businessId) return;

    const handleClickOutside = event => {
      if (!drawerRef.current) return;
      if (!drawerRef.current.contains(event.target)) {
        onClose?.();
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, [businessId, onClose]);

  if (!businessId) return null;

  // --- Derived flags from snapshot + timeline ---
  const businessKey = data?.businessId || data?.id || businessId;

  const stage = (
    data?.lifecycleStage ||
    data?.stage ||
    data?.lifecycle ||
    ""
  ).trim();

  const plan = (data?.planName || data?.planType || data?.plan || "").trim();

  const daysToTrialEnd =
    typeof data?.daysToTrialEnd === "number" ? data.daysToTrialEnd : null;

  const isTrial =
    stage === "Trial" || plan === "Trial" || data?.isTrial === true;

  const isNearTrialEnd =
    isTrial && daysToTrialEnd !== null && daysToTrialEnd <= 5;

  const hasWhatsApp =
    data?.hasWhatsAppConfigured === true ||
    data?.whatsAppConnected === true ||
    data?.whatsAppStatus === "Connected";

  const lastContactedAction = recentActions.find(
    a => a.type === "TAG_CONTACTED"
  );

  const lastContactedAt =
    lastContactedAction?.createdAt || data?.lastContactedAt || null;

  const isContacted =
    !!lastContactedAt || data?.isContacted === true || !!data?.lastOutreachOn;

  const normalizedStage = (stage || "").toLowerCase();

  const canShowExtendTrial =
    !!businessKey &&
    isTrial &&
    isNearTrialEnd &&
    data?.canExtendTrial !== false;

  const canShowTagAsContacted =
    !!businessKey &&
    [
      "trial",
      "trialexpiringsoon",
      "nousagepostapproval",
      "risk",
      "churned",
      "demo",
    ].includes(normalizedStage);

  const canShowViewWhatsAppSettings =
    !!businessKey &&
    (hasWhatsApp || ["Active", "Trial", "Risk"].includes(stage));

  // --- Micro-actions ---

  const handleOpenBusinessProfile = () => {
    if (!businessKey) {
      toast.error("Business id missing for this account.");
      return;
    }
    navigate(`/admin/accounts/${businessKey}`);
    onClose?.();
  };

  const handleTagAsContacted = async () => {
    if (!businessKey) {
      toast.error("Business id missing.");
      return;
    }

    try {
      const res = await axiosClient.post(
        `/admin/account-insights/${businessKey}/mark-contacted`
      );

      if (res.data?.ok === false) {
        toast.error(res.data.message || "Failed to log contact.");
        return;
      }

      const now = new Date().toISOString();

      prependLocalAction("TAG_CONTACTED", {
        label: "Contacted account",
      });

      const updated = {
        ...(data || {}),
        isContacted: true,
        lastContactedAt: now,
      };
      setData(updated);
      onUpdated?.(updated);

      toast.success(
        isContacted ? "Additional contact logged." : "Contact logged."
      );
    } catch (err) {
      console.error(err);
      toast.error("Error while logging contact.");
    }
  };

  const handleViewWhatsAppSettings = () => {
    if (!businessKey) {
      toast.error("Business id missing.");
      return;
    }
    navigate(`/admin/accounts/${businessKey}/whatsapp-settings`);
    onClose?.();
  };

  const handleExtendTrial = async () => {
    if (!businessKey) {
      toast.error("Business id missing.");
      return;
    }

    const extraDays = 7;

    try {
      const res = await axiosClient.post(
        `/admin/account-insights/${businessKey}/extend-trial`,
        { extraDays }
      );

      if (!res.data || res.data.ok === false) {
        toast.error(res.data?.message || "Unable to extend trial.");
        return;
      }

      const snapshot = res.data.snapshot;

      if (snapshot) {
        setData(snapshot);
        onUpdated?.(snapshot);
      } else {
        const newEnd = res.data.newEnd || data?.trialEndsOn || null;
        const updated = { ...(data || {}), trialEndsOn: newEnd };
        setData(updated);
        onUpdated?.(updated);
      }

      prependLocalAction("EXTEND_TRIAL", {
        label: `Trial extended by ${extraDays} days`,
      });

      toast.success("Trial extended successfully.");
    } catch (err) {
      console.error(err);
      toast.error("Error while extending trial.");
    }
  };

  const prependLocalAction = (type, { label }) => {
    const now = new Date().toISOString();
    setRecentActions(prev => [
      {
        id: `local-${type}-${now}`,
        type,
        label: label || prettyLabelFromType(type) || "Account activity",
        actor: "You",
        createdAt: now,
        meta: {},
      },
      ...prev,
    ]);
  };

  // --- UI ---
  return (
    <div
      ref={drawerRef}
      className="
        fixed inset-y-0 right-0
        z-[9999]
        w-full sm:w-[420px]
        bg-white
        border-l border-slate-200
        shadow-xl
        flex flex-col
        animate-account-drawer-in
      "
    >
      {/* Header */}
      <div className="flex items-center justify-between px-5 py-4 border-b border-slate-200 bg-slate-50">
        <div>
          <h2 className="text-base font-semibold text-slate-900">
            Account details
          </h2>
        </div>
        <button
          onClick={onClose}
          className="
            h-7 w-7 flex items-center justify-center
            rounded-full
            bg-slate-100
            text-slate-700
            hover:bg-slate-200
            hover:text-slate-900
            border border-slate-300
            transition
          "
          aria-label="Close details"
        >
          <X className="w-4 h-4" />
        </button>
      </div>

      {/* Main content: fixed top sections + scrollable recent activity */}
      <div className="flex-1 flex flex-col px-5 py-4 gap-4 overflow-hidden">
        {loading && (
          <div className="text-sm text-slate-500 text-center py-6">
            Loading details‚Ä¶
          </div>
        )}

        {!loading && !data && (
          <div className="text-sm text-slate-500 text-center py-6">
            No additional details available for this account.
          </div>
        )}

        {!loading && data && (
          <>
            {/* Non-scroll sections */}
            <div className="space-y-4">
              <Section title="Core">
                <DetailRow
                  label="Business name"
                  value={data.businessName || data.name}
                />
                <DetailRow label="Business ID" value={businessKey} />
                <DetailRow label="Lifecycle stage" value={stage || "‚Äî"} />
                <DetailRow label="Plan" value={plan || "‚Äî"} />
                <DetailRow
                  label="Status"
                  value={
                    data.status ||
                    data.approvalStatus ||
                    data.accountStatus ||
                    "‚Äî"
                  }
                />
              </Section>

              <Section title="Activity & Trial">
                <DetailRow label="Trial ends" value={data.trialEndsOn || "‚Äî"} />
                <DetailRow
                  label="Trial days left"
                  value={
                    daysToTrialEnd !== null
                      ? daysToTrialEnd
                      : isTrial
                      ? "‚Äî"
                      : "N/A"
                  }
                />
                <DetailRow
                  label="Last active"
                  value={
                    data.lastActiveOn ||
                    data.lastSeenAt ||
                    data.lastActivityOn ||
                    "‚Äî"
                  }
                />
                <DetailRow
                  label="Last contacted"
                  value={lastContactedAt ? formatWhen(lastContactedAt) : "‚Äî"}
                />
                <DetailRow
                  label="Created at"
                  value={
                    data.createdAt || data.createdOn || data.signupDate || "‚Äî"
                  }
                />
              </Section>

              {(data.ownerEmail || data.ownerName) && (
                <Section title="Owner">
                  <DetailRow
                    label="Owner email"
                    value={data.ownerEmail || "‚Äî"}
                  />
                  {data.ownerName && (
                    <DetailRow label="Owner name" value={data.ownerName} />
                  )}
                </Section>
              )}
            </div>

            {/* Recent Activity: takes remaining space, scrolls */}
            <div className="flex-1 min-h-0">
              <Section title="Recent activity">
                {actionsLoading && (
                  <div className="text-[11px] text-slate-500">
                    Loading activity‚Ä¶
                  </div>
                )}

                {!actionsLoading && recentActions.length === 0 && (
                  <div className="text-[11px] text-slate-500">
                    No recent actions recorded for this account.
                  </div>
                )}

                {!actionsLoading && recentActions.length > 0 && (
                  <div className="h-full overflow-y-auto pr-1 space-y-1.5 text-[11px]">
                    {recentActions.map(a => (
                      <div key={a.id} className="flex items-start gap-2">
                        <div className="w-1 h-1 mt-1.5 rounded-full bg-slate-400" />
                        <div className="flex-1">
                          <div className="text-slate-800">{a.label}</div>
                          <div className="text-[10px] text-slate-500">
                            {formatWhen(a.createdAt)}
                            {a.actor ? ` ¬∑ ${a.actor}` : ""}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </Section>
            </div>
          </>
        )}
      </div>

      {/* Quick actions: pinned at bottom */}
      <div className="px-5 py-3 border-t border-slate-200 bg-slate-50">
        <div className="text-[10px] font-semibold text-slate-500 uppercase tracking-[0.14em] mb-1.5">
          Quick actions
        </div>

        {data ? (
          <div className="space-y-1.5 text-xs">
            <button
              onClick={handleOpenBusinessProfile}
              className="
                w-full flex items-center justify-between
                px-3 py-2 rounded-md
                bg-slate-900 text-slate-50
                hover:bg-slate-800
                transition
              "
            >
              <span className="flex items-center gap-2">
                <ArrowUpRight className="w-3 h-3" />
                Open Business Profile
              </span>
              <span className="text-[9px] text-slate-300">Full context</span>
            </button>

            {canShowTagAsContacted && (
              <button
                onClick={handleTagAsContacted}
                className="
                  w-full flex items-center justify-between
                  px-3 py-2 rounded-md
                  bg-emerald-50 text-emerald-900
                  border border-emerald-200
                  hover:bg-emerald-100
                  transition
                "
              >
                <span className="flex items-center gap-2">
                  <PhoneCall className="w-3 h-3" />
                  {isContacted ? "Log another contact" : "Tag as Contacted"}
                </span>
                <span className="text-[9px] text-emerald-700">
                  Touchpoint history
                </span>
              </button>
            )}

            {canShowViewWhatsAppSettings && (
              <button
                onClick={handleViewWhatsAppSettings}
                className="
                  w-full flex items-center justify-between
                  px-3 py-2 rounded-md
                  bg-sky-50 text-sky-900
                  border border-sky-200
                  hover:bg-sky-100
                  transition
                "
              >
                <span className="flex items-center gap-2">
                  <MessageCircle className="w-3 h-3" />
                  View WhatsApp Settings
                </span>
                <span className="text-[9px] text-sky-700">
                  Channel readiness
                </span>
              </button>
            )}

            {canShowExtendTrial && (
              <button
                onClick={handleExtendTrial}
                className="
                  w-full flex items-center justify-between
                  px-3 py-2 rounded-md
                  bg-amber-50 text-amber-900
                  border border-amber-200
                  hover:bg-amber-100
                  transition
                "
              >
                <span className="flex items-center gap-2">
                  <Clock4 className="w-3 h-3" />
                  Extend Trial by 7 days
                </span>
                <span className="text-[9px] text-amber-700">
                  Retain high-intent
                </span>
              </button>
            )}

            {!canShowTagAsContacted &&
              !canShowViewWhatsAppSettings &&
              !canShowExtendTrial && (
                <div className="text-[10px] text-slate-500">
                  No special actions for this account right now.
                </div>
              )}
          </div>
        ) : (
          <div className="text-[10px] text-slate-500">
            Actions will appear once account details are loaded.
          </div>
        )}

        <div className="mt-2 text-[10px] text-slate-400">
          Press <span className="font-semibold">Esc</span>, click outside the
          panel, or use the <span className="font-semibold">X</span> button to
          close.
        </div>
      </div>

      {/* Slide-in animation */}
      <style>{`
        @keyframes account-drawer-in {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        .animate-account-drawer-in {
          animation: account-drawer-in 0.22s ease-out;
        }
      `}</style>
    </div>
  );
}

/* ----- Helpers ----- */

function Section({ title, children }) {
  return (
    <div className="space-y-2">
      <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-[0.14em]">
        {title}
      </h3>
      <div className="space-y-1.5">{children}</div>
    </div>
  );
}

function DetailRow({ label, value }) {
  return (
    <div className="flex justify-between gap-3 border-b border-slate-100 pb-1.5">
      <div className="text-xs font-medium text-slate-600">{label}</div>
      <div className="text-sm font-semibold text-slate-900 text-right truncate max-w-[220px]">
        {value != null && value !== "" ? value : "‚Äî"}
      </div>
    </div>
  );
}

function formatWhen(ts) {
  if (!ts) return "";
  const d = new Date(ts);
  if (Number.isNaN(d.getTime())) return "";
  return d.toLocaleString();
}

function prettyLabelFromType(type, meta = {}) {
  switch (type) {
    case "TAG_CONTACTED":
      return "Tagged as contacted";
    case "EXTEND_TRIAL":
      if (typeof meta.extraDays === "number") {
        return `Trial extended by ${meta.extraDays} days`;
      }
      return "Trial extended";
    default:
      return null;
  }
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\AccountInsights\AccountReports\AccountsMasterReport.jsx 
====================================================== 
 
// üìÑ src/pages/AccountInsights/AccountReports/AccountsMasterReport.jsx

import React, { useEffect, useMemo, useState } from "react";
import axiosClient from "../../../api/axiosClient";
import ReportsLayout from "./ReportsLayout";
import AccountDetailDrawer from "./AccountDetailDrawer";
import ReportPeriodFilter, { isWithinPeriod } from "./ReportPeriodFilter";

export default function AccountsMasterReport() {
  const [loading, setLoading] = useState(true);
  const [rows, setRows] = useState([]);
  const [page, setPage] = useState(1);
  const [pageSize] = useState(50);
  const [total, setTotal] = useState(null);

  const [search, setSearch] = useState("");
  const [stageFilter, setStageFilter] = useState("ALL");
  const [planFilter, setPlanFilter] = useState("ALL");
  const [period, setPeriod] = useState("ALL");
  const [sortBy, setSortBy] = useState("createdAt");
  const [sortDir, setSortDir] = useState("desc");

  const [selectedId, setSelectedId] = useState(null);

  // ---- Data load ----
  useEffect(() => {
    const load = async () => {
      try {
        setLoading(true);

        const res = await axiosClient.get("/admin/account-insights", {
          params: {
            page,
            pageSize,
          },
        });

        const data = res.data || {};

        const items = Array.isArray(data.items)
          ? data.items
          : Array.isArray(data.data)
          ? data.data
          : Array.isArray(data)
          ? data
          : [];

        setRows(items);

        const inferredTotal =
          typeof data.total === "number"
            ? data.total
            : typeof data.totalCount === "number"
            ? data.totalCount
            : null;

        setTotal(inferredTotal);
      } catch (err) {
        console.error("Failed to load AccountsMasterReport", err);
        setRows([]);
        setTotal(null);
      } finally {
        setLoading(false);
      }
    };

    load();
  }, [page, pageSize]);

  // ---- Helpers ----
  const norm = v => (v == null ? "" : String(v).toLowerCase());
  const getPlan = r => r.planName || r.planType || "";
  const getStage = r => r.lifecycleStage || r.stage || "";

  // ---- Filters + sort for current page ----
  const processedRows = useMemo(() => {
    let data = [...rows];

    // Search
    if (search.trim()) {
      const q = search.trim().toLowerCase();
      data = data.filter(r => {
        return (
          norm(r.businessName).includes(q) ||
          norm(r.businessId).includes(q) ||
          norm(r.domain).includes(q) ||
          norm(r.ownerEmail).includes(q)
        );
      });
    }

    // Stage filter
    if (stageFilter !== "ALL") {
      data = data.filter(
        r => getStage(r).toLowerCase() === stageFilter.toLowerCase()
      );
    }

    // Plan filter
    if (planFilter !== "ALL") {
      data = data.filter(
        r => getPlan(r).toLowerCase() === planFilter.toLowerCase()
      );
    }

    // Period filter on activity (fallback: createdAt)
    data = data.filter(r => {
      const targetDate = r.lastActiveOn || r.createdAt;
      return isWithinPeriod(targetDate, period);
    });

    // Sort
    data.sort((a, b) => compareRows(a, b, sortBy, sortDir));

    return data;
  }, [rows, search, stageFilter, planFilter, period, sortBy, sortDir]);

  // ---- Filter options (from current dataset page) ----
  const stageOptions = useMemo(() => {
    const set = new Set(
      rows
        .map(getStage)
        .filter(Boolean)
        .map(s => s.trim())
    );
    return ["ALL", ...Array.from(set)];
  }, [rows]);

  const planOptions = useMemo(() => {
    const set = new Set(
      rows
        .map(getPlan)
        .filter(Boolean)
        .map(s => s.trim())
    );
    return ["ALL", ...Array.from(set)];
  }, [rows]);

  // ---- Sorting handler ----
  const handleSort = col => {
    setSortBy(prevCol => {
      if (prevCol === col) {
        setSortDir(prevDir => (prevDir === "asc" ? "desc" : "asc"));
        return prevCol;
      }
      setSortDir("asc");
      return col;
    });
  };

  // ---- CSV export (current page, filtered & sorted) ----
  const handleExport = () => {
    if (!processedRows.length) return;

    const headers = [
      "BusinessId",
      "BusinessName",
      "LifecycleStage",
      "Plan",
      "TrialEndsOn",
      "LastActiveOn",
      "Status",
      "CreatedAt",
    ];

    const lines = processedRows.map(r =>
      [
        r.businessId,
        r.businessName,
        getStage(r),
        getPlan(r),
        r.trialEndsOn,
        r.lastActiveOn,
        r.status,
        r.createdAt,
      ]
        .map(csvEscape)
        .join(",")
    );

    const csv = [headers.join(","), ...lines].join("\n");

    const blob = new Blob([csv], {
      type: "text/csv;charset=utf-8;",
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "accounts-ledger.csv";
    a.click();
    URL.revokeObjectURL(url);
  };

  // ---- Pagination helpers ----
  const hasKnownTotal = typeof total === "number" && total >= 0;
  const lastPage = hasKnownTotal
    ? Math.max(1, Math.ceil(total / pageSize))
    : null;

  const canGoNext = hasKnownTotal ? page < lastPage : rows.length === pageSize; // if unknown total, guess based on page fill

  const from = processedRows.length ? (page - 1) * pageSize + 1 : 0;
  const to = (page - 1) * pageSize + processedRows.length;

  // ---- Render ----
  return (
    <>
      <ReportsLayout
        title="Accounts Ledger"
        description="Comprehensive ledger of all accounts with lifecycle, plan, activity, and status. Use filters to focus on the slice that matters."
      >
        {/* Controls */}
        <div className="flex flex-wrap items-center justify-between gap-4">
          <div className="flex flex-wrap items-center gap-2">
            <input
              value={search}
              onChange={e => setSearch(e.target.value)}
              placeholder="Search by name, ID, domain, or owner email"
              className="w-72 px-3 py-2 rounded border border-slate-300 bg-white text-sm text-slate-800 focus:outline-none focus:ring-1 focus:ring-slate-900"
            />

            <select
              value={stageFilter}
              onChange={e => setStageFilter(e.target.value)}
              className="px-2.5 py-2 rounded border border-slate-300 bg-white text-xs text-slate-800 focus:outline-none focus:ring-1 focus:ring-slate-900"
            >
              {stageOptions.map(s => (
                <option key={s} value={s}>
                  {s === "ALL" ? "All stages" : s}
                </option>
              ))}
            </select>

            <select
              value={planFilter}
              onChange={e => setPlanFilter(e.target.value)}
              className="px-2.5 py-2 rounded border border-slate-300 bg-white text-xs text-slate-800 focus:outline-none focus:ring-1 focus:ring-slate-900"
            >
              {planOptions.map(p => (
                <option key={p} value={p}>
                  {p === "ALL" ? "All plans" : p}
                  {/** else exact plan */}
                </option>
              ))}
            </select>

            <ReportPeriodFilter value={period} onChange={setPeriod} />
          </div>

          <div className="flex items-center gap-3">
            <span className="text-xs text-slate-500">
              Page {page}
              {" ‚Ä¢ "}
              Showing {processedRows.length} row
              {processedRows.length === 1 ? "" : "s"}
              {hasKnownTotal && ` ‚Ä¢ Total ${total}`}
            </span>
            <button
              onClick={handleExport}
              className="px-3 py-2 rounded bg-slate-900 text-white text-xs font-semibold hover:bg-black"
            >
              Export CSV
            </button>
          </div>
        </div>

        {/* Table */}
        <div className="overflow-auto rounded-lg border border-slate-200 bg-white mt-4">
          <table className="min-w-full border-collapse">
            <thead className="bg-slate-50">
              <tr className="text-[11px] text-slate-500 uppercase tracking-[0.12em]">
                <SortableTh
                  label="Business"
                  col="businessName"
                  sortBy={sortBy}
                  sortDir={sortDir}
                  onSort={handleSort}
                />
                <SortableTh
                  label="Lifecycle Stage"
                  col="lifecycleStage"
                  sortBy={sortBy}
                  sortDir={sortDir}
                  onSort={handleSort}
                />
                <SortableTh
                  label="Plan"
                  col="plan"
                  sortBy={sortBy}
                  sortDir={sortDir}
                  onSort={handleSort}
                />
                <SortableTh
                  label="Trial Ends"
                  col="trialEndsOn"
                  sortBy={sortBy}
                  sortDir={sortDir}
                  onSort={handleSort}
                />
                <SortableTh
                  label="Last Active"
                  col="lastActiveOn"
                  sortBy={sortBy}
                  sortDir={sortDir}
                  onSort={handleSort}
                />
                <SortableTh
                  label="Status"
                  col="status"
                  sortBy={sortBy}
                  sortDir={sortDir}
                  onSort={handleSort}
                />
              </tr>
            </thead>
            <tbody className="text-sm text-slate-800">
              {loading && (
                <tr>
                  <td
                    colSpan={6}
                    className="px-4 py-6 text-center text-slate-500"
                  >
                    Loading accounts‚Ä¶
                  </td>
                </tr>
              )}

              {!loading && processedRows.length === 0 && (
                <tr>
                  <td
                    colSpan={6}
                    className="px-4 py-6 text-center text-slate-500"
                  >
                    No accounts found for current filters.
                  </td>
                </tr>
              )}

              {!loading &&
                processedRows.map(r => (
                  <tr
                    key={r.businessId}
                    className="border-t border-slate-100 hover:bg-slate-50 cursor-pointer"
                    onClick={() => setSelectedId(r.businessId)}
                  >
                    <Td primary>{r.businessName || r.businessId || "‚Äî"}</Td>
                    <Td>{getStage(r) || "‚Äî"}</Td>
                    <Td>{getPlan(r) || "‚Äî"}</Td>
                    <Td>{r.trialEndsOn || "‚Äî"}</Td>
                    <Td>{r.lastActiveOn || "‚Äî"}</Td>
                    <Td>{r.status || "‚Äî"}</Td>
                  </tr>
                ))}
            </tbody>
          </table>
        </div>

        {/* Pagination */}
        <div className="flex items-center justify-between text-xs text-slate-600 mt-3">
          <div>
            Showing {from}-{to || 0}
            {hasKnownTotal && ` of ${total}`}
          </div>
          <div className="flex gap-2">
            <button
              disabled={page === 1}
              onClick={() => setPage(p => Math.max(1, p - 1))}
              className="px-2 py-1 border border-slate-300 rounded disabled:opacity-40"
            >
              Prev
            </button>
            <button
              disabled={!canGoNext}
              onClick={() => {
                if (canGoNext) setPage(p => p + 1);
              }}
              className="px-2 py-1 border border-slate-300 rounded disabled:opacity-40"
            >
              Next
            </button>
          </div>
        </div>
      </ReportsLayout>

      {/* Drilldown */}
      <AccountDetailDrawer
        businessId={selectedId}
        onClose={() => setSelectedId(null)}
      />
    </>
  );
}

/* ---- Table helpers ---- */

function SortableTh({ label, col, sortBy, sortDir, onSort }) {
  const active = sortBy === col;
  return (
    <th
      className={
        "px-4 py-2 text-left font-semibold whitespace-nowrap select-none " +
        (active ? "text-slate-900" : "text-slate-600")
      }
    >
      <button
        type="button"
        onClick={() => onSort(col)}
        className="inline-flex items-center gap-1"
      >
        <span>{label}</span>
        {active && (
          <span className="text-[10px]">{sortDir === "asc" ? "‚ñ≤" : "‚ñº"}</span>
        )}
      </button>
    </th>
  );
}

function Td({ children, primary }) {
  return (
    <td
      className={
        "px-4 py-2 whitespace-nowrap " +
        (primary ? "font-semibold text-slate-900" : "text-slate-800")
      }
    >
      {children}
    </td>
  );
}

function csvEscape(v) {
  const s = v == null ? "" : String(v);
  return /[",\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
}

function compareRows(a, b, sortBy, sortDir) {
  const dir = sortDir === "asc" ? 1 : -1;

  const pick = () => {
    switch (sortBy) {
      case "businessName":
        return [a.businessName || "", b.businessName || ""];
      case "lifecycleStage":
        return [
          a.lifecycleStage || a.stage || "",
          b.lifecycleStage || b.stage || "",
        ];
      case "plan":
        return [a.planName || a.planType || "", b.planName || b.planType || ""];
      case "trialEndsOn":
        return [a.trialEndsOn || "", b.trialEndsOn || ""];
      case "lastActiveOn":
        return [a.lastActiveOn || "", b.lastActiveOn || ""];
      case "status":
        return [a.status || "", b.status || ""];
      case "createdAt":
      default:
        return [a.createdAt || "", b.createdAt || ""];
    }
  };

  const [va, vb] = pick();
  if (va < vb) return -1 * dir;
  if (va > vb) return 1 * dir;
  return 0;
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\AccountInsights\AccountReports\LifecycleStageReport.jsx 
====================================================== 
 
// import React, { useEffect, useMemo, useState } from "react";
// import axiosClient from "../../../api/axiosClient";
// import ReportsLayout from "./ReportsLayout";
// import AccountDetailDrawer from "./AccountDetailDrawer";
// import ReportPeriodFilter, { isWithinPeriod } from "./ReportPeriodFilter";

// const STAGES = [
//   { key: "Active", label: "Active" },
//   { key: "AtRisk", label: "At Risk" },
//   { key: "Dormant", label: "Dormant" },
//   { key: "NoUsagePostApproval", label: "No Usage Post-Approval" },
// ];

// export default function LifecycleStageReport() {
//   const [summary, setSummary] = useState(null);

//   const [activeStage, setActiveStage] = useState("Active");
//   const [rows, setRows] = useState([]);
//   const [page, setPage] = useState(1);
//   const [pageSize] = useState(100);
//   const [total, setTotal] = useState(null);
//   const [loading, setLoading] = useState(true);

//   const [search, setSearch] = useState("");
//   const [period, setPeriod] = useState("ALL");
//   const [selectedId, setSelectedId] = useState(null);

//   // Load lifecycle summary once for counts
//   useEffect(() => {
//     const loadSummary = async () => {
//       try {
//         const res = await axiosClient.get("/admin/account-insights/summary");
//         setSummary(res.data || null);
//       } catch (err) {
//         console.error("Failed to load lifecycle summary", err);
//       }
//     };
//     loadSummary();
//   }, []);

//   // Load accounts for current stage / page
//   useEffect(() => {
//     const loadStage = async () => {
//       if (!activeStage) return;
//       try {
//         setLoading(true);

//         const res = await axiosClient.get("/admin/account-insights/by-stage", {
//           params: {
//             stage: activeStage,
//             page,
//             pageSize,
//           },
//         });

//         const data = res.data || {};
//         const items = Array.isArray(data.items)
//           ? data.items
//           : Array.isArray(data.data)
//           ? data.data
//           : Array.isArray(data)
//           ? data
//           : [];

//         setRows(items);

//         const inferredTotal =
//           typeof data.total === "number"
//             ? data.total
//             : typeof data.totalCount === "number"
//             ? data.totalCount
//             : null;

//         setTotal(inferredTotal);
//       } catch (err) {
//         console.error(`Failed to load accounts for stage ${activeStage}`, err);
//         setRows([]);
//         setTotal(null);
//       } finally {
//         setLoading(false);
//       }
//     };

//     loadStage();
//   }, [activeStage, page, pageSize]);

//   // Stage counts from summary (defensive)
//   const stageCounts = useMemo(() => {
//     const src = summary?.byLifecycleStage || summary?.ByLifecycleStage || {};
//     const get = k => src[k] ?? src[k.toLowerCase?.()] ?? 0;

//     return {
//       Active: get("Active"),
//       AtRisk: get("AtRisk"),
//       Dormant: get("Dormant"),
//       NoUsagePostApproval: get("NoUsagePostApproval"),
//     };
//   }, [summary]);

//   // Filtered view for current page data
//   const filteredRows = useMemo(() => {
//     let list = [...rows];

//     if (search.trim()) {
//       const q = search.trim().toLowerCase();
//       list = list.filter(r => {
//         const name = (r.businessName || "").toLowerCase();
//         const id = (r.businessId || "").toLowerCase();
//         const domain = (r.domain || "").toLowerCase();
//         const email = (r.ownerEmail || "").toLowerCase();
//         return (
//           name.includes(q) ||
//           id.includes(q) ||
//           domain.includes(q) ||
//           email.includes(q)
//         );
//       });
//     }

//     // Filter by recent activity (or createdAt as fallback)
//     list = list.filter(r => {
//       const target = r.lastActiveOn || r.createdAt;
//       return isWithinPeriod(target, period);
//     });

//     return list;
//   }, [rows, search, period]);

//   const hasKnownTotal = typeof total === "number" && total >= 0;
//   const from = filteredRows.length ? (page - 1) * pageSize + 1 : 0;
//   const to = (page - 1) * pageSize + filteredRows.length;

//   const handleExport = () => {
//     if (!filteredRows.length) return;

//     const headers = [
//       "BusinessId",
//       "BusinessName",
//       "LifecycleStage",
//       "Plan",
//       "TrialEndsOn",
//       "LastActiveOn",
//       "Status",
//     ];

//     const lines = filteredRows.map(r =>
//       [
//         r.businessId,
//         r.businessName,
//         r.lifecycleStage || activeStage,
//         r.planName || r.planType || "",
//         r.trialEndsOn || "",
//         r.lastActiveOn || "",
//         r.status || "",
//       ]
//         .map(csvEscape)
//         .join(",")
//     );

//     const csv = [headers.join(","), ...lines].join("\n");

//     const blob = new Blob([csv], {
//       type: "text/csv;charset=utf-8;",
//     });
//     const url = URL.createObjectURL(blob);
//     const a = document.createElement("a");
//     a.href = url;
//     a.download = `lifecycle-${activeStage.toLowerCase()}-report.csv`;
//     a.click();
//     URL.revokeObjectURL(url);
//   };

//   return (
//     <>
//       <ReportsLayout
//         title="Lifecycle Stage Report"
//         description="Analyze accounts by lifecycle stage and recent activity to understand health, activation quality, and emerging risk."
//       >
//         {/* Stage selector + filters */}
//         <div className="flex flex-wrap items-center justify-between gap-4 mb-3">
//           {/* Stage pills */}
//           <div className="flex flex-wrap gap-2">
//             {STAGES.map(s => (
//               <button
//                 key={s.key}
//                 onClick={() => {
//                   setActiveStage(s.key);
//                   setPage(1);
//                   setSearch("");
//                 }}
//                 className={
//                   "px-3 py-1.5 rounded-full border text-xs transition-colors " +
//                   (activeStage === s.key
//                     ? "border-slate-900 bg-slate-900 text-white"
//                     : "border-slate-300 text-slate-700 hover:bg-slate-50")
//                 }
//               >
//                 {s.label}
//                 <span className="ml-1 text-[10px] text-slate-400">
//                   {stageCounts[s.key] ?? 0}
//                 </span>
//               </button>
//             ))}
//           </div>

//           {/* Search + period + export */}
//           <div className="flex flex-wrap items-center gap-2">
//             <input
//               value={search}
//               onChange={e => setSearch(e.target.value)}
//               placeholder={`Search within ${activeStage} accounts`}
//               className="w-64 px-3 py-2 rounded border border-slate-300 bg-white text-sm text-slate-800 focus:outline-none focus:ring-1 focus:ring-slate-900"
//             />
//             <ReportPeriodFilter value={period} onChange={setPeriod} />
//             <button
//               onClick={handleExport}
//               className="px-3 py-2 rounded bg-slate-900 text-white text-xs font-semibold hover:bg-black"
//             >
//               Export CSV
//             </button>
//           </div>
//         </div>

//         {/* Table */}
//         <div className="overflow-auto rounded-lg border border-slate-200 bg-white">
//           <table className="min-w-full border-collapse">
//             <thead className="bg-slate-50">
//               <tr className="text-[11px] text-slate-500 uppercase tracking-[0.14em]">
//                 <Th>Business</Th>
//                 <Th>Lifecycle Stage</Th>
//                 <Th>Plan</Th>
//                 <Th>Trial Ends</Th>
//                 <Th>Last Active</Th>
//                 <Th>Status</Th>
//               </tr>
//             </thead>
//             <tbody className="text-sm text-slate-800">
//               {loading && (
//                 <tr>
//                   <td
//                     colSpan={6}
//                     className="px-4 py-6 text-center text-slate-500"
//                   >
//                     Loading {activeStage} accounts‚Ä¶
//                   </td>
//                 </tr>
//               )}

//               {!loading && filteredRows.length === 0 && (
//                 <tr>
//                   <td
//                     colSpan={6}
//                     className="px-4 py-6 text-center text-slate-500"
//                   >
//                     No accounts found in this stage with current filters.
//                   </td>
//                 </tr>
//               )}

//               {!loading &&
//                 filteredRows.map(r => (
//                   <tr
//                     key={r.businessId}
//                     className="border-t border-slate-100 hover:bg-slate-50 cursor-pointer"
//                     onClick={() => setSelectedId(r.businessId)}
//                   >
//                     <Td primary>{r.businessName || r.businessId || "‚Äî"}</Td>
//                     <Td>{r.lifecycleStage || activeStage}</Td>
//                     <Td>{r.planName || r.planType || "‚Äî"}</Td>
//                     <Td>{r.trialEndsOn || "‚Äî"}</Td>
//                     <Td>{r.lastActiveOn || "‚Äî"}</Td>
//                     <Td>{r.status || "‚Äî"}</Td>
//                   </tr>
//                 ))}
//             </tbody>
//           </table>
//         </div>

//         {/* Pagination */}
//         <div className="flex items-center justify-between text-xs text-slate-600 mt-3">
//           <div>
//             Showing {from}-{to || 0}
//             {hasKnownTotal && ` of ${total} in ${activeStage}`}
//           </div>
//           <div className="flex gap-2">
//             <button
//               disabled={page === 1}
//               onClick={() => setPage(p => Math.max(1, p - 1))}
//               className="px-2 py-1 border border-slate-300 rounded disabled:opacity-40"
//             >
//               Prev
//             </button>
//             <button
//               disabled={
//                 hasKnownTotal
//                   ? page * pageSize >= total
//                   : rows.length < pageSize
//               }
//               onClick={() => setPage(p => p + 1)}
//               className="px-2 py-1 border border-slate-300 rounded disabled:opacity-40"
//             >
//               Next
//             </button>
//           </div>
//         </div>
//       </ReportsLayout>

//       {/* Shared drilldown */}
//       <AccountDetailDrawer
//         businessId={selectedId}
//         onClose={() => setSelectedId(null)}
//       />
//     </>
//   );
// }

// /* Table cell helpers */

// function Th({ children }) {
//   return (
//     <th className="px-4 py-2 text-left font-semibold whitespace-nowrap">
//       {children}
//     </th>
//   );
// }

// function Td({ children, primary }) {
//   return (
//     <td
//       className={
//         "px-4 py-2 whitespace-nowrap " +
//         (primary ? "font-semibold text-slate-900" : "text-slate-800")
//       }
//     >
//       {children}
//     </td>
//   );
// }

// function csvEscape(v) {
//   const s = v == null ? "" : String(v);
//   return /[\",\\n]/.test(s) ? `"${s.replace(/\"/g, '""')}"` : s;
// }
import React, { useEffect, useMemo, useState } from "react";
import axiosClient from "../../../api/axiosClient";
import ReportsLayout from "./ReportsLayout";
import AccountDetailDrawer from "./AccountDetailDrawer";
import ReportPeriodFilter, { isWithinPeriod } from "./ReportPeriodFilter";

const STAGES = [
  { key: "Active", label: "Active" },
  { key: "AtRisk", label: "At Risk" },
  { key: "Dormant", label: "Dormant" },
  { key: "NoUsagePostApproval", label: "No Usage Post-Approval" },
];

export default function LifecycleStageReport() {
  const [summary, setSummary] = useState(null);

  const [activeStage, setActiveStage] = useState("Active");
  const [rows, setRows] = useState([]);
  const [page, setPage] = useState(1);
  const [pageSize] = useState(100);
  const [total, setTotal] = useState(null);
  const [loading, setLoading] = useState(true);

  const [search, setSearch] = useState("");
  const [period, setPeriod] = useState("ALL");
  const [selectedId, setSelectedId] = useState(null);

  // Load lifecycle summary once
  useEffect(() => {
    const loadSummary = async () => {
      try {
        const res = await axiosClient.get("/admin/account-insights/summary");
        setSummary(res.data || null);
      } catch (err) {
        console.error("Failed to load lifecycle summary", err);
      }
    };
    loadSummary();
  }, []);

  // Load accounts for current stage / page
  useEffect(() => {
    const loadStage = async () => {
      if (!activeStage) return;
      try {
        setLoading(true);

        const res = await axiosClient.get("/admin/account-insights/by-stage", {
          params: {
            stage: activeStage,
            page,
            pageSize,
          },
        });

        const data = res.data || {};
        const items = Array.isArray(data.items)
          ? data.items
          : Array.isArray(data.data)
          ? data.data
          : Array.isArray(data)
          ? data
          : [];

        setRows(items);

        const inferredTotal =
          typeof data.total === "number"
            ? data.total
            : typeof data.totalCount === "number"
            ? data.totalCount
            : null;

        setTotal(inferredTotal);
      } catch (err) {
        console.error(`Failed to load accounts for stage ${activeStage}`, err);
        setRows([]);
        setTotal(null);
      } finally {
        setLoading(false);
      }
    };

    // whenever we change stage or page, drawer should not stay stuck on old id
    setSelectedId(null);
    loadStage();
  }, [activeStage, page, pageSize]);

  // Stage counts from summary (defensive)
  const stageCounts = useMemo(() => {
    const src = summary?.byLifecycleStage || summary?.ByLifecycleStage || {};
    const get = k => src[k] ?? src[k?.toLowerCase?.()] ?? 0;

    return {
      Active: get("Active"),
      AtRisk: get("AtRisk"),
      Dormant: get("Dormant"),
      NoUsagePostApproval: get("NoUsagePostApproval"),
    };
  }, [summary]);

  // Filtered view for current page data
  const filteredRows = useMemo(() => {
    let list = [...rows];

    if (search.trim()) {
      const q = search.trim().toLowerCase();
      list = list.filter(r => {
        const name = (r.businessName || "").toLowerCase();
        const id = (r.businessId || r.id || "").toLowerCase();
        const domain = (r.domain || "").toLowerCase();
        const email = (r.ownerEmail || "").toLowerCase();
        return (
          name.includes(q) ||
          id.includes(q) ||
          domain.includes(q) ||
          email.includes(q)
        );
      });
    }

    // Filter by recent activity (or createdAt as fallback)
    list = list.filter(r => {
      const target = r.lastActiveOn || r.createdAt;
      return isWithinPeriod(target, period);
    });

    return list;
  }, [rows, search, period]);

  const hasKnownTotal = typeof total === "number" && total >= 0;
  const from = filteredRows.length ? (page - 1) * pageSize + 1 : 0;
  const to = (page - 1) * pageSize + filteredRows.length;

  const handleExport = () => {
    if (!filteredRows.length) return;

    const headers = [
      "BusinessId",
      "BusinessName",
      "LifecycleStage",
      "Plan",
      "TrialEndsOn",
      "LastActiveOn",
      "Status",
    ];

    const lines = filteredRows.map(r =>
      [
        r.businessId || r.id || "",
        r.businessName || "",
        r.lifecycleStage || activeStage,
        r.planName || r.planType || "",
        r.trialEndsOn || "",
        r.lastActiveOn || "",
        r.status || "",
      ]
        .map(csvEscape)
        .join(",")
    );

    const csv = [headers.join(","), ...lines].join("\n");

    const blob = new Blob([csv], {
      type: "text/csv;charset=utf-8;",
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `lifecycle-${activeStage.toLowerCase()}-report.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  // Sync updated data coming from the drawer (e.g., contacted, trial extended)
  const handleUpdatedFromDrawer = updated => {
    if (!updated) return;
    const updatedId = updated.businessId || updated.id;
    if (!updatedId) return;

    setRows(prev =>
      prev.map(x =>
        (x.businessId || x.id) === updatedId ? { ...x, ...updated } : x
      )
    );
  };

  return (
    <>
      <ReportsLayout
        title="Lifecycle Stage Report"
        description="Analyze accounts by lifecycle stage and recent activity to understand health, activation quality, and emerging risk."
      >
        {/* Stage selector + filters */}
        <div className="flex flex-wrap items-center justify-between gap-4 mb-3">
          {/* Stage pills */}
          <div className="flex flex-wrap gap-2">
            {STAGES.map(s => (
              <button
                key={s.key}
                onClick={() => {
                  setActiveStage(s.key);
                  setPage(1);
                  setSearch("");
                  setPeriod("ALL");
                  setSelectedId(null);
                }}
                className={
                  "px-3 py-1.5 rounded-full border text-xs transition-colors " +
                  (activeStage === s.key
                    ? "border-slate-900 bg-slate-900 text-white"
                    : "border-slate-300 text-slate-700 hover:bg-slate-50")
                }
              >
                {s.label}
                <span className="ml-1 text-[10px] text-slate-400">
                  {stageCounts[s.key] ?? 0}
                </span>
              </button>
            ))}
          </div>

          {/* Search + period + export */}
          <div className="flex flex-wrap items-center gap-2">
            <input
              value={search}
              onChange={e => setSearch(e.target.value)}
              placeholder={`Search within ${activeStage} accounts`}
              className="w-64 px-3 py-2 rounded border border-slate-300 bg-white text-sm text-slate-800 focus:outline-none focus:ring-1 focus:ring-slate-900"
            />
            <ReportPeriodFilter value={period} onChange={setPeriod} />
            <button
              onClick={handleExport}
              className="px-3 py-2 rounded bg-slate-900 text-white text-xs font-semibold hover:bg-black"
            >
              Export CSV
            </button>
          </div>
        </div>

        {/* Table */}
        <div className="overflow-auto rounded-lg border border-slate-200 bg-white">
          <table className="min-w-full border-collapse">
            <thead className="bg-slate-50">
              <tr className="text-[11px] text-slate-500 uppercase tracking-[0.14em]">
                <Th>Business</Th>
                <Th>Lifecycle Stage</Th>
                <Th>Plan</Th>
                <Th>Trial Ends</Th>
                <Th>Last Active</Th>
                <Th>Status</Th>
              </tr>
            </thead>
            <tbody className="text-sm text-slate-800">
              {loading && (
                <tr>
                  <td
                    colSpan={6}
                    className="px-4 py-6 text-center text-slate-500"
                  >
                    Loading {activeStage} accounts‚Ä¶
                  </td>
                </tr>
              )}

              {!loading && filteredRows.length === 0 && (
                <tr>
                  <td
                    colSpan={6}
                    className="px-4 py-6 text-center text-slate-500"
                  >
                    No accounts found in this stage with current filters.
                  </td>
                </tr>
              )}

              {!loading &&
                filteredRows.map(r => {
                  const id = r.businessId || r.id;
                  return (
                    <tr
                      key={id}
                      className="border-t border-slate-100 hover:bg-slate-50 cursor-pointer"
                      onClick={() => setSelectedId(id)}
                    >
                      <Td primary>
                        {r.businessName || r.businessId || r.id || "‚Äî"}
                      </Td>
                      <Td>{r.lifecycleStage || activeStage}</Td>
                      <Td>{r.planName || r.planType || "‚Äî"}</Td>
                      <Td>{r.trialEndsOn || "‚Äî"}</Td>
                      <Td>{r.lastActiveOn || "‚Äî"}</Td>
                      <Td>{r.status || "‚Äî"}</Td>
                    </tr>
                  );
                })}
            </tbody>
          </table>
        </div>

        {/* Pagination */}
        <div className="flex items-center justify-between text-xs text-slate-600 mt-3">
          <div>
            Showing {from}-{to || 0}
            {hasKnownTotal && ` of ${total} in ${activeStage}`}
          </div>
          <div className="flex gap-2">
            <button
              disabled={page === 1}
              onClick={() => setPage(p => Math.max(1, p - 1))}
              className="px-2 py-1 border border-slate-300 rounded disabled:opacity-40"
            >
              Prev
            </button>
            <button
              disabled={
                hasKnownTotal
                  ? page * pageSize >= total
                  : rows.length < pageSize
              }
              onClick={() => setPage(p => p + 1)}
              className="px-2 py-1 border border-slate-300 rounded disabled:opacity-40"
            >
              Next
            </button>
          </div>
        </div>
      </ReportsLayout>

      {/* Shared drilldown */}
      <AccountDetailDrawer
        businessId={selectedId}
        onClose={() => setSelectedId(null)}
        onUpdated={handleUpdatedFromDrawer}
      />
    </>
  );
}

/* Table cell helpers */

function Th({ children }) {
  return (
    <th className="px-4 py-2 text-left font-semibold whitespace-nowrap">
      {children}
    </th>
  );
}

function Td({ children, primary }) {
  return (
    <td
      className={
        "px-4 py-2 whitespace-nowrap " +
        (primary ? "font-semibold text-slate-900" : "text-slate-800")
      }
    >
      {children}
    </td>
  );
}

function csvEscape(v) {
  const s = v == null ? "" : String(v);
  return /[",\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\AccountInsights\AccountReports\ReportPeriodFilter.jsx 
====================================================== 
 
import React from "react";

export const PERIODS = [
  { key: "ALL", label: "All time" },
  { key: "7D", label: "Last 7 days" },
  { key: "30D", label: "Last 30 days" },
  { key: "90D", label: "Last 90 days" },
];

export default function ReportPeriodFilter({ value, onChange }) {
  return (
    <div className="inline-flex items-center gap-1 bg-slate-50 rounded-full px-1.5 py-1">
      {PERIODS.map(p => (
        <button
          key={p.key}
          type="button"
          onClick={() => onChange(p.key)}
          className={
            "px-2.5 py-0.5 rounded-full text-xs border transition-colors " +
            (value === p.key
              ? "bg-slate-900 text-white border-slate-900"
              : "bg-white text-slate-700 border-slate-200 hover:bg-slate-100")
          }
        >
          {p.label}
        </button>
      ))}
    </div>
  );
}

/**
 * Given an ISO date string and a period key, returns true if the date is within range.
 * If date is invalid or missing, we treat it as within range for ALL, otherwise excluded.
 */
export function isWithinPeriod(dateStr, periodKey) {
  if (periodKey === "ALL") return true;
  if (!dateStr) return false;

  const d = new Date(dateStr);
  if (isNaN(d.getTime())) return false;

  const now = new Date();
  const diffDays = (now - d) / (1000 * 60 * 60 * 24);

  switch (periodKey) {
    case "7D":
      return diffDays <= 7;
    case "30D":
      return diffDays <= 30;
    case "90D":
      return diffDays <= 90;
    default:
      return true;
  }
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\AccountInsights\AccountReports\ReportsIndex.jsx 
====================================================== 
 
// üìÑ src/pages/AccountInsights/AccountReports/ReportsIndex.jsx

import React, { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import axiosClient from "../../../api/axiosClient";
import ReportsLayout from "./ReportsLayout";

export default function ReportsIndex() {
  const navigate = useNavigate();
  const [summary, setSummary] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const load = async () => {
      try {
        const res = await axiosClient.get("/admin/account-insights/summary");
        setSummary(res.data || null);
      } catch (err) {
        console.error("Failed to load reports overview summary", err);
      } finally {
        setLoading(false);
      }
    };
    load();
  }, []);

  const s = summary || {};

  const total = s.totalBusinesses ?? s.TotalBusinesses ?? 0;
  const active = s.activeBusinesses ?? s.ActiveBusinesses ?? 0;
  const atRisk = s.atRiskBusinesses ?? s.AtRiskBusinesses ?? 0;
  const dormant = s.dormantBusinesses ?? s.DormantBusinesses ?? 0;
  const noUsage = s.noUsagePostApproval ?? s.NoUsagePostApproval ?? 0;
  const trials =
    s.trialTotal ?? s.TrialTotal ?? s.trialPlan ?? s.TrialPlan ?? 0;
  const trialExpSoon = s.trialExpiringSoon ?? s.TrialExpiringSoon ?? 0;
  const trialExpiredNoUpgrade =
    s.trialExpiredNoUpgrade ?? s.TrialExpiredNoUpgrade ?? 0;
  const paid = s.paidPlan ?? s.PaidPlan ?? 0;

  const approxTrialConv =
    trials > 0 ? ((paid / trials) * 100).toFixed(1) : "0.0";

  return (
    <ReportsLayout
      title="Account Reports Overview"
      description="Central hub for detailed account reports: ledger, lifecycle, trial performance, and risk cohorts."
    >
      {/* KPIs */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <Kpi
          label="Total Accounts"
          value={total}
          hint="All tracked businesses."
        />
        <Kpi
          label="Active Accounts"
          value={active}
          hint="Recently engaged or live."
        />
        <Kpi
          label="At Risk + Dormant"
          value={atRisk + dormant}
          hint="Needs intervention."
          highlight
        />
        <Kpi label="On Paid Plan" value={paid} hint="Converted customers." />
      </div>

      {/* Report cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <ReportCard
          title="Accounts Ledger"
          description="Full row-level, exportable ledger of all accounts with lifecycle, plan, and activity."
          primaryMetricLabel="Total accounts"
          primaryMetricValue={total}
          onClick={() =>
            navigate(
              "/app/admin/account-insights/account-reports/accounts-master"
            )
          }
        />

        <ReportCard
          title="Lifecycle Cohorts"
          description="Accounts grouped by lifecycle stage to understand health across Active, At Risk, and Dormant."
          primaryMetricLabel="Active / At Risk / Dormant"
          primaryMetricValue={`${active} / ${atRisk} / ${dormant}`}
          onClick={() =>
            navigate("/app/admin/account-insights/account-reports/lifecycle")
          }
        />

        <ReportCard
          title="Trial Performance"
          description="Track trial volume, upcoming expiries, and approximate trial-to-paid conversion."
          primaryMetricLabel="Trials ‚Ä¢ Expiring ‚Ä¢ Lost"
          primaryMetricValue={`${trials} ‚Ä¢ ${trialExpSoon} ‚Ä¢ ${trialExpiredNoUpgrade}`}
          secondary={`${approxTrialConv}% approx. trial ‚Üí paid`}
          onClick={() =>
            navigate("/app/admin/account-insights/account-reports/trials")
          }
        />

        <ReportCard
          title="Risk & Recovery"
          description="At-risk, no-usage, and dormant accounts as a focused queue for recovery and outreach."
          primaryMetricLabel="No-usage / At Risk / Dormant"
          primaryMetricValue={`${noUsage} / ${atRisk} / ${dormant}`}
          highlight
          onClick={() =>
            navigate("/app/admin/account-insights/account-reports/risk")
          }
        />
      </div>

      {/* Error hint if summary failed */}
      {!loading && !summary && (
        <div className="text-sm text-red-500 mt-3">
          Unable to load summary. Reports are still accessible via the cards.
        </div>
      )}

      <div className="text-xs text-slate-500 mt-4">
        All reports use the existing Account Insights APIs and are designed for
        readable, exportable, operational analysis.
      </div>
    </ReportsLayout>
  );
}

function Kpi({ label, value, hint, highlight }) {
  return (
    <div
      className={
        "p-4 rounded-lg border bg-white space-y-1 " +
        (highlight ? "border-rose-300" : "border-slate-200")
      }
    >
      <div className="text-[10px] uppercase tracking-[0.16em] text-slate-500">
        {label}
      </div>
      <div className="text-lg font-semibold text-slate-900">{value ?? "‚Äî"}</div>
      {hint && (
        <div className="text-xs text-slate-500 leading-snug">{hint}</div>
      )}
    </div>
  );
}

function ReportCard({
  title,
  description,
  primaryMetricLabel,
  primaryMetricValue,
  secondary,
  onClick,
  highlight,
}) {
  return (
    <div
      onClick={onClick}
      className={
        "group cursor-pointer p-4 rounded-lg border bg-white flex flex-col justify-between gap-3 transition hover:-translate-y-0.5 hover:shadow-md " +
        (highlight ? "border-rose-200" : "border-slate-200")
      }
    >
      <div className="space-y-1">
        <div className="text-sm font-semibold text-slate-900">{title}</div>
        <div className="text-xs text-slate-600 leading-snug">{description}</div>
      </div>
      <div className="flex items-baseline justify-between gap-4">
        <div className="space-y-1">
          <div className="text-[10px] text-slate-500 uppercase tracking-[0.16em]">
            {primaryMetricLabel}
          </div>
          <div className="text-base font-semibold text-slate-900">
            {primaryMetricValue ?? "‚Äî"}
          </div>
          {secondary && (
            <div className="text-xs text-slate-500">{secondary}</div>
          )}
        </div>
        <div className="text-xs text-slate-600 group-hover:text-slate-900">
          View report ‚Üí
        </div>
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\AccountInsights\AccountReports\ReportsLayout.jsx 
====================================================== 
 
import React from "react";
import { NavLink } from "react-router-dom";

// const reportTabs = [
//   {
//     key: "accounts",
//     label: "Accounts",
//     to: "/app/admin/account-insights/account-reports",
//     exact: true,
//   },
//   {
//     key: "lifecycle",
//     label: "Lifecycle",
//     to: "/app/admin/account-insights/account-reports/lifecycle",
//   },
//   {
//     key: "trials",
//     label: "Trials",
//     to: "/app/admin/account-insights/account-reports/trials",
//   },
//   {
//     key: "risk",
//     label: "Risk & Recovery",
//     to: "/app/admin/account-insights/account-reports/risk",
//   },
// ];
const reportTabs = [
  {
    key: "overview",
    label: "Overview",
    to: "/app/admin/account-insights/account-reports",
    exact: true,
  },
  {
    key: "lifecycle",
    label: "Lifecycle",
    to: "/app/admin/account-insights/account-reports/lifecycle",
  },
  {
    key: "trials",
    label: "Trials",
    to: "/app/admin/account-insights/account-reports/trials",
  },
  {
    key: "risk",
    label: "Risk & Recovery",
    to: "/app/admin/account-insights/account-reports/risk",
  },
];

export default function ReportsLayout({ title, description, children }) {
  return (
    <div className="min-h-screen bg-slate-50 px-6 py-6">
      <div className="max-w-7xl mx-auto space-y-5">
        <header className="space-y-1">
          <h1 className="text-xl font-semibold text-slate-900 tracking-tight">
            {title}
          </h1>
          {description && (
            <p className="text-xs text-slate-600 max-w-3xl">{description}</p>
          )}
        </header>

        <div className="flex items-center gap-4 border-b border-slate-200">
          {reportTabs.map(tab => (
            <NavLink
              key={tab.key}
              to={tab.to}
              end={tab.exact}
              className={({ isActive }) =>
                `pb-2 text-[10px] font-semibold uppercase tracking-[0.14em] border-b-2 ${
                  isActive
                    ? "border-slate-900 text-slate-900"
                    : "border-transparent text-slate-500 hover:text-slate-900 hover:border-slate-300"
                }`
              }
            >
              {tab.label}
            </NavLink>
          ))}
        </div>

        <section className="space-y-4">{children}</section>
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\AccountInsights\AccountReports\RiskRecoveryReport.jsx 
====================================================== 
 
import React, { useEffect, useMemo, useState } from "react";
import axiosClient from "../../../api/axiosClient";
import ReportsLayout from "./ReportsLayout";
import AccountDetailDrawer from "./AccountDetailDrawer";
import ReportPeriodFilter, { isWithinPeriod } from "./ReportPeriodFilter";

const RISK_TABS = [
  { key: "AtRisk", label: "At Risk" },
  { key: "NoUsagePostApproval", label: "No Usage Post-Approval" },
  { key: "Dormant", label: "Dormant" },
];

const PAGE_SIZE = 100;

export default function RiskRecoveryReport() {
  const [activeTab, setActiveTab] = useState("AtRisk");

  const [rows, setRows] = useState([]);
  const [page, setPage] = useState(1);
  const [total, setTotal] = useState(null);
  const [loading, setLoading] = useState(true);

  const [search, setSearch] = useState("");
  const [period, setPeriod] = useState("ALL");
  const [selectedId, setSelectedId] = useState(null);

  // Load cohort for current tab
  useEffect(() => {
    const load = async () => {
      try {
        setLoading(true);

        const res = await axiosClient.get("/admin/account-insights/by-stage", {
          params: {
            stage: activeTab,
            page,
            pageSize: PAGE_SIZE,
          },
        });

        const data = res.data || {};
        const items = Array.isArray(data.items)
          ? data.items
          : Array.isArray(data.data)
          ? data.data
          : Array.isArray(data)
          ? data
          : [];

        setRows(items);

        const inferredTotal =
          typeof data.total === "number"
            ? data.total
            : typeof data.totalCount === "number"
            ? data.totalCount
            : null;

        setTotal(inferredTotal);
      } catch (err) {
        console.error(`Failed to load risk cohort for ${activeTab}`, err);
        setRows([]);
        setTotal(null);
      } finally {
        setLoading(false);
      }
    };

    load();
  }, [activeTab, page]);

  // Filtered rows for current tab
  const filteredRows = useMemo(() => {
    let list = [...rows];

    if (search.trim()) {
      const q = search.trim().toLowerCase();
      list = list.filter(r => {
        const name = (r.businessName || "").toLowerCase();
        const id = (r.businessId || "").toLowerCase();
        const domain = (r.domain || "").toLowerCase();
        const email = (r.ownerEmail || "").toLowerCase();
        return (
          name.includes(q) ||
          id.includes(q) ||
          domain.includes(q) ||
          email.includes(q)
        );
      });
    }

    // Period filter: use lastActiveOn if present, else createdAt
    list = list.filter(r => {
      const target = r.lastActiveOn || r.createdAt;
      return isWithinPeriod(target, period);
    });

    return list;
  }, [rows, search, period]);

  const hasKnownTotal = typeof total === "number" && total >= 0;
  const from = filteredRows.length ? (page - 1) * PAGE_SIZE + 1 : 0;
  const to = (page - 1) * PAGE_SIZE + filteredRows.length;

  const handleExport = () => {
    if (!filteredRows.length) return;

    const headers = [
      "BusinessId",
      "BusinessName",
      "RiskType",
      "LifecycleStage",
      "Plan",
      "LastActiveOn",
      "Status",
      "NoteOrReason",
    ];

    const lines = filteredRows.map(r =>
      [
        r.businessId,
        r.businessName,
        labelForTab(activeTab),
        r.lifecycleStage || activeTab,
        r.planName || r.planType || "",
        r.lastActiveOn || "",
        r.status || "",
        r.note || r.reason || "",
      ]
        .map(csvEscape)
        .join(",")
    );

    const csv = [headers.join(","), ...lines].join("\n");

    const blob = new Blob([csv], {
      type: "text/csv;charset=utf-8;",
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `risk-${activeTab.toLowerCase()}-report.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  return (
    <>
      <ReportsLayout
        title="Risk & Recovery Report"
        description="Operational view of at-risk, no-usage, and dormant accounts. Use this as a live recovery queue for Customer Success."
      >
        {/* Tabs + controls */}
        <div className="flex flex-wrap items-center justify-between gap-4 mb-3">
          {/* Risk tabs */}
          <div className="flex flex-wrap gap-2">
            {RISK_TABS.map(t => (
              <button
                key={t.key}
                onClick={() => {
                  setActiveTab(t.key);
                  setPage(1);
                  setSearch("");
                }}
                className={
                  "px-3 py-1.5 rounded-full border text-xs transition-colors " +
                  (activeTab === t.key
                    ? "border-rose-600 bg-rose-600 text-white"
                    : "border-slate-300 text-slate-700 hover:bg-slate-50")
                }
              >
                {t.label}
              </button>
            ))}
          </div>

          {/* Search + period + export */}
          <div className="flex flex-wrap items-center gap-2">
            <input
              value={search}
              onChange={e => setSearch(e.target.value)}
              placeholder={`Search within ${labelForTab(activeTab)} accounts`}
              className="w-72 px-3 py-2 rounded border border-slate-300 bg-white text-sm text-slate-800 focus:outline-none focus:ring-1 focus:ring-slate-900"
            />
            <ReportPeriodFilter value={period} onChange={setPeriod} />
            <button
              onClick={handleExport}
              className="px-3 py-2 rounded bg-slate-900 text-white text-xs font-semibold hover:bg-black"
            >
              Export CSV
            </button>
          </div>
        </div>

        {/* Table */}
        <div className="overflow-auto rounded-lg border border-slate-200 bg-white">
          <table className="min-w-full border-collapse">
            <thead className="bg-slate-50">
              <tr className="text-[11px] text-slate-500 uppercase tracking-[0.14em]">
                <Th>Business</Th>
                <Th>Risk Type</Th>
                <Th>Lifecycle Stage</Th>
                <Th>Plan</Th>
                <Th>Last Active</Th>
                <Th>Status</Th>
                <Th>Note / Reason</Th>
              </tr>
            </thead>
            <tbody className="text-sm text-slate-800">
              {loading && (
                <tr>
                  <td
                    colSpan={7}
                    className="px-4 py-6 text-center text-slate-500"
                  >
                    Loading {labelForTab(activeTab)} accounts‚Ä¶
                  </td>
                </tr>
              )}

              {!loading && filteredRows.length === 0 && (
                <tr>
                  <td
                    colSpan={7}
                    className="px-4 py-6 text-center text-slate-500"
                  >
                    No accounts found in this cohort with current filters.
                  </td>
                </tr>
              )}

              {!loading &&
                filteredRows.map(r => (
                  <tr
                    key={r.businessId}
                    className="border-t border-slate-100 hover:bg-slate-50 cursor-pointer"
                    onClick={() => setSelectedId(r.businessId)}
                  >
                    <Td primary>{r.businessName || r.businessId || "‚Äî"}</Td>
                    <Td>{labelForTab(activeTab)}</Td>
                    <Td>{r.lifecycleStage || activeTab}</Td>
                    <Td>{r.planName || r.planType || "‚Äî"}</Td>
                    <Td>{r.lastActiveOn || "‚Äî"}</Td>
                    <Td>{r.status || "‚Äî"}</Td>
                    <Td className="max-w-xs truncate">
                      {r.note || r.reason || "‚Äî"}
                    </Td>
                  </tr>
                ))}
            </tbody>
          </table>
        </div>

        {/* Pagination */}
        <div className="flex items-center justify-between text-xs text-slate-600 mt-3">
          <div>
            Showing {from}-{to || 0}
            {hasKnownTotal && ` of ${total}`} in {labelForTab(activeTab)}
          </div>
          <div className="flex gap-2">
            <button
              disabled={page === 1}
              onClick={() => setPage(p => Math.max(1, p - 1))}
              className="px-2 py-1 border border-slate-300 rounded disabled:opacity-40"
            >
              Prev
            </button>
            <button
              disabled={
                hasKnownTotal
                  ? page * PAGE_SIZE >= total
                  : rows.length < PAGE_SIZE
              }
              onClick={() => setPage(p => p + 1)}
              className="px-2 py-1 border border-slate-300 rounded disabled:opacity-40"
            >
              Next
            </button>
          </div>
        </div>

        <div className="text-[11px] text-slate-500 mt-3">
          Prioritize outreach starting with At Risk, then No Usage
          Post-Approval, then long-term Dormant. Each row is a candidate for
          targeted playbooks.
        </div>
      </ReportsLayout>

      {/* Shared drawer (non-blocking, updates on row change) */}
      <AccountDetailDrawer
        businessId={selectedId}
        onClose={() => setSelectedId(null)}
      />
    </>
  );
}

/* Helpers */

function Th({ children }) {
  return (
    <th className="px-4 py-2 text-left font-semibold whitespace-nowrap">
      {children}
    </th>
  );
}

function Td({ children, primary, className = "" }) {
  return (
    <td
      className={
        "px-4 py-2 whitespace-nowrap " +
        (primary ? "font-semibold text-slate-900" : "text-slate-800") +
        " " +
        className
      }
    >
      {children}
    </td>
  );
}

function labelForTab(key) {
  switch (key) {
    case "AtRisk":
      return "At Risk";
    case "NoUsagePostApproval":
      return "No Usage Post-Approval";
    case "Dormant":
      return "Dormant";
    default:
      return key;
  }
}

function csvEscape(v) {
  const s = v == null ? "" : String(v);
  return /[",\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\AccountInsights\AccountReports\TrialPerformanceReport.jsx 
====================================================== 
 
// import React, { useEffect, useMemo, useState } from "react";
// import axiosClient from "../../../api/axiosClient";
// import ReportsLayout from "./ReportsLayout";
// import AccountDetailDrawer from "./AccountDetailDrawer";
// import ReportPeriodFilter, { isWithinPeriod } from "./ReportPeriodFilter";

// const EXPIRY_WINDOW_DAYS = 14; // Window for "expiring soon" list & KPI

// export default function TrialPerformanceReport() {
//   const [summary, setSummary] = useState(null);
//   const [expiringRows, setExpiringRows] = useState([]);
//   const [loading, setLoading] = useState(true);

//   const [search, setSearch] = useState("");
//   const [period, setPeriod] = useState("ALL");
//   const [selectedId, setSelectedId] = useState(null);

//   useEffect(() => {
//     const load = async () => {
//       try {
//         setLoading(true);

//         const [summaryRes, expiringRes] = await Promise.all([
//           axiosClient.get("/admin/account-insights/summary"),
//           axiosClient.get("/admin/account-insights/trial-expiring-soon", {
//             params: { days: EXPIRY_WINDOW_DAYS },
//           }),
//         ]);

//         setSummary(summaryRes.data || null);

//         const raw = expiringRes.data || {};
//         const list = Array.isArray(raw)
//           ? raw
//           : Array.isArray(raw.items)
//           ? raw.items
//           : Array.isArray(raw.data)
//           ? raw.data
//           : [];
//         setExpiringRows(list);
//       } catch (err) {
//         console.error("Failed to load TrialPerformanceReport", err);
//         setSummary(null);
//         setExpiringRows([]);
//       } finally {
//         setLoading(false);
//       }
//     };

//     load();
//   }, []);

//   // ---- KPI derivation from summary ----
//   const kpi = useMemo(() => {
//     const s = summary || {};

//     const trialsTotal =
//       s.trialTotal ?? s.TrialTotal ?? s.trialPlan ?? s.TrialPlan ?? 0;

//     const paid = s.paidPlan ?? s.PaidPlan ?? 0;

//     const trialExpiredNoUpgrade =
//       s.trialExpiredNoUpgrade ?? s.TrialExpiredNoUpgrade ?? 0;

//     // Prefer backend-provided expiring count; fallback to list length
//     const expSoonFromSummary = s.trialExpiringSoon ?? s.TrialExpiringSoon;
//     const trialsExpSoon =
//       typeof expSoonFromSummary === "number"
//         ? expSoonFromSummary
//         : expiringRows.length;

//     const approxConv =
//       trialsTotal > 0 ? ((paid / trialsTotal) * 100).toFixed(1) : "0.0";

//     return {
//       trialsTotal,
//       trialsExpSoon,
//       trialExpiredNoUpgrade,
//       paid,
//       approxConv,
//     };
//   }, [summary, expiringRows.length]);

//   // ---- Filtered expiring trials table ----
//   const filteredExpiringRows = useMemo(() => {
//     let list = [...expiringRows];

//     if (search.trim()) {
//       const q = search.trim().toLowerCase();
//       list = list.filter(r => {
//         const name = (r.businessName || "").toLowerCase();
//         const id = (r.businessId || "").toLowerCase();
//         const domain = (r.domain || "").toLowerCase();
//         const email = (r.ownerEmail || "").toLowerCase();
//         return (
//           name.includes(q) ||
//           id.includes(q) ||
//           domain.includes(q) ||
//           email.includes(q)
//         );
//       });
//     }

//     // Period filter on trial end date
//     list = list.filter(r => isWithinPeriod(r.trialEndsOn, period));

//     return list;
//   }, [expiringRows, search, period]);

//   // ---- Export ----
//   const handleExport = () => {
//     if (!filteredExpiringRows.length) return;

//     const headers = [
//       "BusinessId",
//       "BusinessName",
//       "TrialEndsOn",
//       "Plan",
//       "LifecycleStage",
//       "Status",
//     ];

//     const lines = filteredExpiringRows.map(r =>
//       [
//         r.businessId,
//         r.businessName,
//         r.trialEndsOn,
//         r.planName || r.planType || "Trial",
//         r.lifecycleStage || "Trial",
//         r.status || "",
//       ]
//         .map(csvEscape)
//         .join(",")
//     );

//     const csv = [headers.join(","), ...lines].join("\n");

//     const blob = new Blob([csv], {
//       type: "text/csv;charset=utf-8;",
//     });
//     const url = URL.createObjectURL(blob);
//     const a = document.createElement("a");
//     a.href = url;
//     a.download = `trial-expiring-${EXPIRY_WINDOW_DAYS}d-report.csv`;
//     a.click();
//     URL.revokeObjectURL(url);
//   };

//   // ---- Render ----
//   return (
//     <>
//       <ReportsLayout
//         title="Trial Performance Report"
//         description={`Analyze trial volume, upcoming expiries, and approximate trial-to-paid conversion. Focus on trials expiring within the next ${EXPIRY_WINDOW_DAYS} days as your save pipeline.`}
//       >
//         {/* KPIs */}
//         <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
//           <Kpi
//             label="Trials (Total)"
//             value={kpi.trialsTotal}
//             hint="Current trial accounts."
//           />
//           <Kpi
//             label={`Expiring ‚â§ ${EXPIRY_WINDOW_DAYS} days`}
//             value={kpi.trialsExpSoon}
//             hint="Immediate conversion opportunities."
//           />
//           <Kpi
//             label="Trials Expired (No Upgrade)"
//             value={kpi.trialExpiredNoUpgrade}
//             hint="Loss bucket for win-back."
//           />
//           <Kpi
//             label="Approx. Trial ‚Üí Paid"
//             value={`${kpi.approxConv}%`}
//             hint="Paid / Trials (coarse signal)."
//           />
//         </div>

//         {/* Minimal bar visualization */}
//         <div className="mt-4 p-4 rounded-lg border border-slate-200 bg-white">
//           <div className="flex items-center justify-between mb-2">
//             <div>
//               <div className="text-xs font-semibold text-slate-900">
//                 Trial Funnel Snapshot
//               </div>
//               <div className="text-[11px] text-slate-500">
//                 Relative comparison of total trials, expiring soon, lost trials,
//                 and paid accounts.
//               </div>
//             </div>
//           </div>

//           <TrialBars
//             trials={kpi.trialsTotal}
//             expiring={kpi.trialsExpSoon}
//             lost={kpi.trialExpiredNoUpgrade}
//             paid={kpi.paid}
//           />
//         </div>

//         {/* Controls for expiring list */}
//         <div className="flex flex-wrap items-center justify-between gap-3 mt-5">
//           <div className="flex flex-col">
//             <div className="text-sm font-semibold text-slate-900">
//               Trials expiring in next {EXPIRY_WINDOW_DAYS} days
//             </div>
//             <div className="text-[11px] text-slate-500">
//               Use this list as your primary save queue.
//             </div>
//           </div>

//           <div className="flex flex-wrap items-center gap-2">
//             <input
//               value={search}
//               onChange={e => setSearch(e.target.value)}
//               placeholder="Search trials by name, ID, domain, owner"
//               className="w-72 px-3 py-2 rounded border border-slate-300 bg-white text-sm text-slate-800 focus:outline-none focus:ring-1 focus:ring-slate-900"
//             />
//             <ReportPeriodFilter value={period} onChange={setPeriod} />
//             <button
//               onClick={handleExport}
//               className="px-3 py-2 rounded bg-slate-900 text-white text-xs font-semibold hover:bg-black"
//             >
//               Export CSV
//             </button>
//           </div>
//         </div>

//         {/* Expiring trials table */}
//         <div className="overflow-auto rounded-lg border border-slate-200 bg-white mt-3">
//           <table className="min-w-full border-collapse">
//             <thead className="bg-slate-50">
//               <tr className="text-[11px] text-slate-500 uppercase tracking-[0.14em]">
//                 <Th>Business</Th>
//                 <Th>Trial Ends</Th>
//                 <Th>Plan</Th>
//                 <Th>Lifecycle Stage</Th>
//                 <Th>Status</Th>
//               </tr>
//             </thead>
//             <tbody className="text-sm text-slate-800">
//               {loading && (
//                 <tr>
//                   <td
//                     colSpan={5}
//                     className="px-4 py-6 text-center text-slate-500"
//                   >
//                     Loading trial data‚Ä¶
//                   </td>
//                 </tr>
//               )}

//               {!loading && filteredExpiringRows.length === 0 && (
//                 <tr>
//                   <td
//                     colSpan={5}
//                     className="px-4 py-6 text-center text-slate-500"
//                   >
//                     No trials expiring in the next {EXPIRY_WINDOW_DAYS} days
//                     matching current filters.
//                   </td>
//                 </tr>
//               )}

//               {!loading &&
//                 filteredExpiringRows.map(r => (
//                   <tr
//                     key={r.businessId}
//                     className="border-t border-slate-100 hover:bg-slate-50 cursor-pointer"
//                     onClick={() => setSelectedId(r.businessId)}
//                   >
//                     <Td primary>{r.businessName || r.businessId || "‚Äî"}</Td>
//                     <Td>{r.trialEndsOn || "‚Äî"}</Td>
//                     <Td>{r.planName || r.planType || "Trial"}</Td>
//                     <Td>{r.lifecycleStage || "Trial"}</Td>
//                     <Td>{r.status || "‚Äî"}</Td>
//                   </tr>
//                 ))}
//             </tbody>
//           </table>
//         </div>

//         <div className="text-[11px] text-slate-500 mt-3">
//           Combine this with campaign tools to automate nudges for trials near
//           expiry instead of chasing them manually.
//         </div>
//       </ReportsLayout>

//       {/* Drilldown drawer (non-blocking, updates on row click) */}
//       <AccountDetailDrawer
//         businessId={selectedId}
//         onClose={() => setSelectedId(null)}
//       />
//     </>
//   );
// }

// /* ---- Components ---- */

// function Kpi({ label, value, hint }) {
//   return (
//     <div className="p-4 rounded-lg border border-slate-200 bg-white space-y-1">
//       <div className="text-[10px] uppercase tracking-[0.16em] text-slate-500">
//         {label}
//       </div>
//       <div className="text-lg font-semibold text-slate-900">{value ?? "‚Äî"}</div>
//       {hint && (
//         <div className="text-xs text-slate-500 leading-snug">{hint}</div>
//       )}
//     </div>
//   );
// }

// function Th({ children }) {
//   return (
//     <th className="px-4 py-2 text-left font-semibold whitespace-nowrap">
//       {children}
//     </th>
//   );
// }

// function Td({ children, primary }) {
//   return (
//     <td
//       className={
//         "px-4 py-2 whitespace-nowrap " +
//         (primary ? "font-semibold text-slate-900" : "text-slate-800")
//       }
//     >
//       {children}
//     </td>
//   );
// }

// /**
//  * Tiny bar "chart" using pure CSS, no external libs.
//  * Shows relative heights based on counts for Trials, Expiring, Lost, Paid.
//  */
// function TrialBars({ trials, expiring, lost, paid }) {
//   const vals = [trials, expiring, lost, paid].map(v =>
//     typeof v === "number" && v > 0 ? v : 0
//   );
//   const max = Math.max(...vals, 1); // avoid /0

//   const mk = (label, value, tone) => {
//     const h = (value / max) * 72; // max 72px height
//     const base = "flex flex-col items-center justify-end gap-1 flex-1";
//     const barCommon = "w-7 rounded-t-md transition-all";
//     let barTone = "";
//     switch (tone) {
//       case "primary":
//         barTone = "bg-slate-900";
//         break;
//       case "warn":
//         barTone = "bg-amber-500";
//         break;
//       case "danger":
//         barTone = "bg-rose-500";
//         break;
//       case "success":
//         barTone = "bg-emerald-500";
//         break;
//       default:
//         barTone = "bg-slate-500";
//     }

//     return (
//       <div key={label} className={base}>
//         <div
//           className={`${barCommon} ${barTone}`}
//           style={{ height: `${h || 4}px` }}
//         />
//         <div className="text-[10px] font-semibold text-slate-900">{value}</div>
//         <div className="text-[9px] text-slate-500 text-center leading-tight">
//           {label}
//         </div>
//       </div>
//     );
//   };

//   return (
//     <div className="flex items-end gap-4 mt-2 h-28">
//       {mk("Trials", trials, "primary")}
//       {mk(`Expiring ‚â§ ${EXPIRY_WINDOW_DAYS}d`, expiring, "warn")}
//       {mk("Expired (No Upgrade)", lost, "danger")}
//       {mk("On Paid Plan", paid, "success")}
//     </div>
//   );
// }

// /* ---- CSV helper ---- */

// function csvEscape(v) {
//   const s = v == null ? "" : String(v);
//   return /[",\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
// }
import React, { useEffect, useMemo, useState } from "react";
import axiosClient from "../../../api/axiosClient";
import ReportsLayout from "./ReportsLayout";
import AccountDetailDrawer from "./AccountDetailDrawer";
import ReportPeriodFilter, { isWithinPeriod } from "./ReportPeriodFilter";

const EXPIRY_WINDOW_DAYS = 14; // Window for "expiring soon" list & KPI

export default function TrialPerformanceReport() {
  const [summary, setSummary] = useState(null);
  const [expiringRows, setExpiringRows] = useState([]);
  const [loading, setLoading] = useState(true);

  const [search, setSearch] = useState("");
  const [period, setPeriod] = useState("ALL");
  const [selectedId, setSelectedId] = useState(null);

  useEffect(() => {
    const load = async () => {
      try {
        setLoading(true);

        const [summaryRes, expiringRes] = await Promise.all([
          axiosClient.get("/admin/account-insights/summary"),
          axiosClient.get("/admin/account-insights/trial-expiring-soon", {
            params: { days: EXPIRY_WINDOW_DAYS },
          }),
        ]);

        setSummary(summaryRes.data || null);

        const raw = expiringRes.data || {};
        const list = Array.isArray(raw)
          ? raw
          : Array.isArray(raw.items)
          ? raw.items
          : Array.isArray(raw.data)
          ? raw.data
          : [];
        setExpiringRows(list);
      } catch (err) {
        console.error("Failed to load TrialPerformanceReport", err);
        setSummary(null);
        setExpiringRows([]);
      } finally {
        setLoading(false);
      }
    };

    load();
  }, []);

  // ---- KPI derivation from summary ----
  const kpi = useMemo(() => {
    const s = summary || {};

    const trialsTotal =
      s.trialTotal ?? s.TrialTotal ?? s.trialPlan ?? s.TrialPlan ?? 0;

    const paid = s.paidPlan ?? s.PaidPlan ?? 0;

    const trialExpiredNoUpgrade =
      s.trialExpiredNoUpgrade ?? s.TrialExpiredNoUpgrade ?? 0;

    // Prefer backend-provided expiring count; fallback to list length
    const expSoonFromSummary = s.trialExpiringSoon ?? s.TrialExpiringSoon;
    const trialsExpSoon =
      typeof expSoonFromSummary === "number"
        ? expSoonFromSummary
        : expiringRows.length;

    const approxConv =
      trialsTotal > 0 ? ((paid / trialsTotal) * 100).toFixed(1) : "0.0";

    return {
      trialsTotal,
      trialsExpSoon,
      trialExpiredNoUpgrade,
      paid,
      approxConv,
    };
  }, [summary, expiringRows.length]);

  // ---- Filtered expiring trials table ----
  const filteredExpiringRows = useMemo(() => {
    let list = [...expiringRows];

    if (search.trim()) {
      const q = search.trim().toLowerCase();
      list = list.filter(r => {
        const name = (r.businessName || "").toLowerCase();
        const id = (r.businessId || r.id || "").toLowerCase();
        const domain = (r.domain || "").toLowerCase();
        const email = (r.ownerEmail || "").toLowerCase();
        return (
          name.includes(q) ||
          id.includes(q) ||
          domain.includes(q) ||
          email.includes(q)
        );
      });
    }

    // Period filter on trial end date
    list = list.filter(r => isWithinPeriod(r.trialEndsOn, period));

    return list;
  }, [expiringRows, search, period]);

  // ---- Export ----
  const handleExport = () => {
    if (!filteredExpiringRows.length) return;

    const headers = [
      "BusinessId",
      "BusinessName",
      "TrialEndsOn",
      "Plan",
      "LifecycleStage",
      "Status",
    ];

    const lines = filteredExpiringRows.map(r =>
      [
        r.businessId || r.id || "",
        r.businessName || "",
        r.trialEndsOn || "",
        r.planName || r.planType || "Trial",
        r.lifecycleStage || "Trial",
        r.status || "",
      ]
        .map(csvEscape)
        .join(",")
    );

    const csv = [headers.join(","), ...lines].join("\n");

    const blob = new Blob([csv], {
      type: "text/csv;charset=utf-8;",
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `trial-expiring-${EXPIRY_WINDOW_DAYS}d-report.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  // ---- Handle updates coming back from the drawer ----
  const handleUpdatedFromDrawer = updated => {
    if (!updated) return;
    const updatedId = updated.businessId || updated.id;
    if (!updatedId) return;

    // Helper: check if this account still belongs in the "expiring soon" window
    const inExpiringWindow = account => {
      const endRaw = account.trialEndsOn || account.trialEndDate;
      if (!endRaw) return false;
      const end = new Date(endRaw);
      if (Number.isNaN(end.getTime())) return false;

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      end.setHours(0, 0, 0, 0);

      const diffDays =
        (end.getTime() - today.getTime()) / (1000 * 60 * 60 * 24);

      return diffDays >= 0 && diffDays <= EXPIRY_WINDOW_DAYS;
    };

    setExpiringRows(prev => {
      let found = false;

      let next = prev.map(r => {
        const id = r.businessId || r.id;
        if (id === updatedId) {
          found = true;
          return { ...r, ...updated };
        }
        return r;
      });

      const stillInWindow = inExpiringWindow(updated);

      // If it was in the list and no longer qualifies, remove it
      if (found && !stillInWindow) {
        next = next.filter(r => (r.businessId || r.id) !== updatedId);
      }

      // If it wasn't in the list but now qualifies (e.g. trial extended into window), add it
      if (!found && stillInWindow) {
        next = [...next, updated];
      }

      return next;
    });

    // Optional: lightweight local tweak to summary metrics (not exact, but keeps UI aligned)
    setSummary(prev => {
      if (!prev) return prev;
      const copy = { ...prev };

      // If trial moved out of expiring window, decrement expiringSoon if present
      // If moved into window, increment.
      // Guard everything; this is just UX-friendly, backend is source of truth.
      if (copy.trialExpiringSoon != null) {
        // naive adjustment; true correctness comes from backend refresh later
        // so we avoid complex diffs here.
        copy.trialExpiringSoon = copy.trialExpiringSoon;
      }
      if (copy.TrialExpiringSoon != null) {
        copy.TrialExpiringSoon = copy.TrialExpiringSoon;
      }

      return copy;
    });
  };

  // ---- Render ----
  return (
    <>
      <ReportsLayout
        title="Trial Performance Report"
        description={`Analyze trial volume, upcoming expiries, and approximate trial-to-paid conversion. Focus on trials expiring within the next ${EXPIRY_WINDOW_DAYS} days as your save pipeline.`}
      >
        {/* KPIs */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <Kpi
            label="Trials (Total)"
            value={kpi.trialsTotal}
            hint="Current trial accounts."
          />
          <Kpi
            label={`Expiring ‚â§ ${EXPIRY_WINDOW_DAYS} days`}
            value={kpi.trialsExpSoon}
            hint="Immediate conversion opportunities."
          />
          <Kpi
            label="Trials Expired (No Upgrade)"
            value={kpi.trialExpiredNoUpgrade}
            hint="Loss bucket for win-back."
          />
          <Kpi
            label="Approx. Trial ‚Üí Paid"
            value={`${kpi.approxConv}%`}
            hint="Paid / Trials (coarse signal)."
          />
        </div>

        {/* Minimal bar visualization */}
        <div className="mt-4 p-4 rounded-lg border border-slate-200 bg-white">
          <div className="flex items-center justify-between mb-2">
            <div>
              <div className="text-xs font-semibold text-slate-900">
                Trial Funnel Snapshot
              </div>
              <div className="text-[11px] text-slate-500">
                Relative comparison of total trials, expiring soon, lost trials,
                and paid accounts.
              </div>
            </div>
          </div>

          <TrialBars
            trials={kpi.trialsTotal}
            expiring={kpi.trialsExpSoon}
            lost={kpi.trialExpiredNoUpgrade}
            paid={kpi.paid}
          />
        </div>

        {/* Controls for expiring list */}
        <div className="flex flex-wrap items-center justify-between gap-3 mt-5">
          <div className="flex flex-col">
            <div className="text-sm font-semibold text-slate-900">
              Trials expiring in next {EXPIRY_WINDOW_DAYS} days
            </div>
            <div className="text-[11px] text-slate-500">
              Use this list as your primary save queue.
            </div>
          </div>

          <div className="flex flex-wrap items-center gap-2">
            <input
              value={search}
              onChange={e => setSearch(e.target.value)}
              placeholder="Search trials by name, ID, domain, owner"
              className="w-72 px-3 py-2 rounded border border-slate-300 bg-white text-sm text-slate-800 focus:outline-none focus:ring-1 focus:ring-slate-900"
            />
            <ReportPeriodFilter value={period} onChange={setPeriod} />
            <button
              onClick={handleExport}
              className="px-3 py-2 rounded bg-slate-900 text-white text-xs font-semibold hover:bg-black"
            >
              Export CSV
            </button>
          </div>
        </div>

        {/* Expiring trials table */}
        <div className="overflow-auto rounded-lg border border-slate-200 bg-white mt-3">
          <table className="min-w-full border-collapse">
            <thead className="bg-slate-50">
              <tr className="text-[11px] text-slate-500 uppercase tracking-[0.14em]">
                <Th>Business</Th>
                <Th>Trial Ends</Th>
                <Th>Plan</Th>
                <Th>Lifecycle Stage</Th>
                <Th>Status</Th>
              </tr>
            </thead>
            <tbody className="text-sm text-slate-800">
              {loading && (
                <tr>
                  <td
                    colSpan={5}
                    className="px-4 py-6 text-center text-slate-500"
                  >
                    Loading trial data‚Ä¶
                  </td>
                </tr>
              )}

              {!loading && filteredExpiringRows.length === 0 && (
                <tr>
                  <td
                    colSpan={5}
                    className="px-4 py-6 text-center text-slate-500"
                  >
                    No trials expiring in the next {EXPIRY_WINDOW_DAYS} days
                    matching current filters.
                  </td>
                </tr>
              )}

              {!loading &&
                filteredExpiringRows.map(r => {
                  const id = r.businessId || r.id;
                  return (
                    <tr
                      key={id}
                      className="border-t border-slate-100 hover:bg-slate-50 cursor-pointer"
                      onClick={() => setSelectedId(id)}
                    >
                      <Td primary>
                        {r.businessName || r.businessId || r.id || "‚Äî"}
                      </Td>
                      <Td>{r.trialEndsOn || "‚Äî"}</Td>
                      <Td>{r.planName || r.planType || "Trial"}</Td>
                      <Td>{r.lifecycleStage || "Trial"}</Td>
                      <Td>{r.status || "‚Äî"}</Td>
                    </tr>
                  );
                })}
            </tbody>
          </table>
        </div>

        <div className="text-[11px] text-slate-500 mt-3">
          Combine this with campaign tools to automate nudges for trials near
          expiry instead of chasing them manually.
        </div>
      </ReportsLayout>

      {/* Drilldown drawer (non-blocking, updates on row click & micro-actions) */}
      <AccountDetailDrawer
        businessId={selectedId}
        onClose={() => setSelectedId(null)}
        onUpdated={handleUpdatedFromDrawer}
      />
    </>
  );
}

/* ---- Components ---- */

function Kpi({ label, value, hint }) {
  return (
    <div className="p-4 rounded-lg border border-slate-200 bg-white space-y-1">
      <div className="text-[10px] uppercase tracking-[0.16em] text-slate-500">
        {label}
      </div>
      <div className="text-lg font-semibold text-slate-900">{value ?? "‚Äî"}</div>
      {hint && (
        <div className="text-xs text-slate-500 leading-snug">{hint}</div>
      )}
    </div>
  );
}

function Th({ children }) {
  return (
    <th className="px-4 py-2 text-left font-semibold whitespace-nowrap">
      {children}
    </th>
  );
}

function Td({ children, primary }) {
  return (
    <td
      className={
        "px-4 py-2 whitespace-nowrap " +
        (primary ? "font-semibold text-slate-900" : "text-slate-800")
      }
    >
      {children}
    </td>
  );
}

/**
 * Tiny bar "chart" using pure CSS, no external libs.
 * Shows relative heights based on counts for Trials, Expiring, Lost, Paid.
 */
function TrialBars({ trials, expiring, lost, paid }) {
  const vals = [trials, expiring, lost, paid].map(v =>
    typeof v === "number" && v > 0 ? v : 0
  );
  const max = Math.max(...vals, 1); // avoid /0

  const mk = (label, value, tone) => {
    const h = (value / max) * 72; // max 72px height
    const base = "flex flex-col items-center justify-end gap-1 flex-1";
    const barCommon = "w-7 rounded-t-md transition-all";
    let barTone = "";
    switch (tone) {
      case "primary":
        barTone = "bg-slate-900";
        break;
      case "warn":
        barTone = "bg-amber-500";
        break;
      case "danger":
        barTone = "bg-rose-500";
        break;
      case "success":
        barTone = "bg-emerald-500";
        break;
      default:
        barTone = "bg-slate-500";
    }

    return (
      <div key={label} className={base}>
        <div
          className={`${barCommon} ${barTone}`}
          style={{ height: `${h || 4}px` }}
        />
        <div className="text-[10px] font-semibold text-slate-900">{value}</div>
        <div className="text-[9px] text-slate-500 text-center leading-tight">
          {label}
        </div>
      </div>
    );
  };

  return (
    <div className="flex items-end gap-4 mt-2 h-28">
      {mk("Trials", trials, "primary")}
      {mk(`Expiring ‚â§ ${EXPIRY_WINDOW_DAYS}d`, expiring, "warn")}
      {mk("Expired (No Upgrade)", lost, "danger")}
      {mk("On Paid Plan", paid, "success")}
    </div>
  );
}

/* ---- CSV helper ---- */

function csvEscape(v) {
  const s = v == null ? "" : String(v);
  return /[",\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\AccountInsights\components\AlertCard.jsx 
====================================================== 
 
// import React from "react";
// import { useNavigate } from "react-router-dom";

// function getSeverityStyles(severity) {
//   switch (severity) {
//     case "critical":
//       return {
//         pill: "bg-red-50 text-red-700 border-red-200",
//         dot: "bg-red-500",
//       };
//     case "warning":
//       return {
//         pill: "bg-amber-50 text-amber-700 border-amber-200",
//         dot: "bg-amber-500",
//       };
//     case "success":
//       return {
//         pill: "bg-emerald-50 text-emerald-700 border-emerald-200",
//         dot: "bg-emerald-500",
//       };
//     default:
//       return {
//         pill: "bg-slate-50 text-slate-700 border-slate-200",
//         dot: "bg-slate-400",
//       };
//   }
// }

// export default function AlertCard({
//   id,
//   title,
//   message,
//   severity = "info",
//   businessName,
//   businessId,
//   daysToEvent,
//   createdAtUtc,
// }) {
//   const navigate = useNavigate();
//   const styles = getSeverityStyles(severity);

//   const handleViewAccount = () => {
//     if (!businessId) return;
//     // Adjust to your actual admin business detail route if needed
//     navigate(
//       `/app/admin/approvals?businessId=${encodeURIComponent(businessId)}`
//     );
//   };

//   const handleNudge = () => {
//     if (!businessId) return;
//     navigate(
//       `/app/campaigns/CampaignWizard?targetBusinessId=${encodeURIComponent(
//         businessId
//       )}`
//     );
//   };

//   return (
//     <div className="w-full p-4 rounded-2xl bg-white/95 border border-slate-200 shadow-sm flex flex-col gap-2">
//       {/* Top row */}
//       <div className="flex items-center justify-between gap-2">
//         <div
//           className={`inline-flex items-center gap-2 px-2 py-1 rounded-full border text-[10px] font-semibold ${styles.pill}`}
//         >
//           <span className={`w-2 h-2 rounded-full ${styles.dot}`} />
//           {severity === "critical"
//             ? "Critical"
//             : severity === "warning"
//             ? "Warning"
//             : severity === "success"
//             ? "Positive"
//             : "Info"}
//         </div>
//         {createdAtUtc && (
//           <div className="text-[9px] text-slate-400">
//             Created: {new Date(createdAtUtc).toLocaleString()}
//           </div>
//         )}
//       </div>

//       {/* Title */}
//       <div className="text-sm font-semibold text-slate-900">
//         {title || "Account Alert"}
//       </div>

//       {/* Message */}
//       {message && (
//         <div className="text-xs text-slate-600 leading-snug">{message}</div>
//       )}

//       {/* Meta */}
//       <div className="flex flex-wrap items-center gap-3 text-[10px] text-slate-500 mt-1">
//         {businessName && (
//           <div>
//             Account:{" "}
//             <span className="font-semibold text-slate-800">{businessName}</span>
//           </div>
//         )}
//         {typeof daysToEvent === "number" && (
//           <div>
//             {daysToEvent === 0
//               ? "Event is today"
//               : daysToEvent > 0
//               ? `In ${daysToEvent} day${daysToEvent !== 1 ? "s" : ""}`
//               : `${Math.abs(daysToEvent)} day${
//                   Math.abs(daysToEvent) !== 1 ? "s" : ""
//                 } ago`}
//           </div>
//         )}
//       </div>

//       {/* CTAs */}
//       {businessId && (
//         <div className="flex items-center justify-end mt-2 gap-2">
//           <button
//             onClick={handleViewAccount}
//             className="px-2 py-1 rounded-xl text-[10px] font-semibold bg-purple-600 text-white hover:bg-purple-700 transition-colors"
//           >
//             View Account
//           </button>
//           <button
//             onClick={handleNudge}
//             className="px-2 py-1 rounded-xl text-[10px] font-semibold bg-white text-purple-700 border border-purple-200 hover:bg-purple-50 transition-colors"
//           >
//             Nudge via Campaign
//           </button>
//         </div>
//       )}
//     </div>
//   );
// }
// üìÑ src/pages/AccountInsights/components/AlertCard.jsx
import React from "react";
import { useNavigate } from "react-router-dom";

const SEVERITY = {
  critical: {
    label: "Critical",
    bar: "bg-red-500",
    pill: "bg-red-50 text-red-700 border-red-200",
  },
  warning: {
    label: "Warning",
    bar: "bg-amber-500",
    pill: "bg-amber-50 text-amber-700 border-amber-200",
  },
  info: {
    label: "Info",
    bar: "bg-slate-500",
    pill: "bg-slate-50 text-slate-700 border-slate-200",
  },
};

export default function AlertCard({
  id,
  title,
  message,
  severity = "info",
  businessName,
  businessId,
  daysToEvent,
  createdAtUtc,
}) {
  const navigate = useNavigate();
  const s = SEVERITY[severity] || SEVERITY.info;

  const goAccount = () => {
    if (!businessId) return;
    navigate(
      `/app/admin/approvals?businessId=${encodeURIComponent(businessId)}`
    );
  };

  const goCampaign = () => {
    if (!businessId) return;
    navigate(
      `/app/campaigns/CampaignWizard?targetBusinessId=${encodeURIComponent(
        businessId
      )}`
    );
  };

  let timing = null;
  if (typeof daysToEvent === "number") {
    if (daysToEvent === 0) timing = "Event is today.";
    else if (daysToEvent > 0)
      timing = `Event in ${daysToEvent} day${daysToEvent === 1 ? "" : "s"}.`;
    else
      timing = `Event was ${Math.abs(daysToEvent)} day${
        Math.abs(daysToEvent) === 1 ? "" : "s"
      } ago.`;
  }

  return (
    <div className="flex gap-3 p-3.5 rounded-lg bg-white border border-slate-200 shadow-[0_1px_2px_rgba(15,23,42,0.04)]">
      <div className={`w-1 rounded-md ${s.bar}`} />

      <div className="flex-1 flex flex-col gap-1">
        <div className="flex items-center justify-between gap-2">
          <div className="flex items-center gap-2">
            <span
              className={`px-2 py-0.5 rounded-full text-[8px] font-semibold border ${s.pill}`}
            >
              {s.label}
            </span>
            {businessName && (
              <span className="text-[9px] text-slate-600">{businessName}</span>
            )}
          </div>
          {createdAtUtc && (
            <span className="text-[8px] text-slate-400">
              {new Date(createdAtUtc).toLocaleDateString()}
            </span>
          )}
        </div>

        <div className="text-[11px] font-semibold text-slate-900 leading-snug">
          {title || "Account Alert"}
        </div>

        {message && (
          <div className="text-[10px] text-slate-600 leading-snug">
            {message}
          </div>
        )}

        {timing && <div className="text-[8px] text-slate-500">{timing}</div>}

        {businessId && (
          <div className="flex justify-end gap-2 pt-1">
            <button
              onClick={goAccount}
              className="px-2.5 py-1 text-[9px] font-semibold rounded border border-slate-300 text-slate-800 hover:bg-slate-50"
            >
              View account
            </button>
            <button
              onClick={goCampaign}
              className="px-2.5 py-1 text-[9px] font-semibold rounded bg-slate-900 text-white hover:bg-black"
            >
              Open in Campaigns
            </button>
          </div>
        )}
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\AccountInsights\components\FunnelChart.jsx 
====================================================== 
 
// import React from "react";

// /**
//  * FunnelChart
//  *
//  * Props:
//  * - title: string
//  * - steps: [{ label: string, value: number }]
//  */
// export default function FunnelChart({ title, steps = [] }) {
//   if (!steps.length) {
//     return (
//       <div className="w-full p-4 rounded-2xl bg-white/90 border border-slate-200 shadow-sm">
//         <div className="text-sm font-semibold text-slate-700 mb-2">{title}</div>
//         <div className="text-xs text-slate-400">
//           No data available for this funnel.
//         </div>
//       </div>
//     );
//   }

//   const max = steps[0]?.value || 0;
//   const safeMax = max === 0 ? 1 : max;

//   return (
//     <div className="w-full p-4 rounded-2xl bg-white/95 border border-slate-200 shadow-sm flex flex-col gap-3">
//       <div className="flex items-baseline justify-between gap-2">
//         <div className="text-sm font-semibold text-slate-800">{title}</div>
//         <div className="text-[10px] text-slate-500">
//           Showing step-wise conversion &amp; drop-offs
//         </div>
//       </div>

//       {/* Horizontal funnel bar */}
//       <div className="flex items-stretch gap-1 w-full">
//         {steps.map((step, idx) => {
//           const widthPct =
//             step.value <= 0 ? 0 : Math.max(5, (step.value / safeMax) * 100);

//           const base =
//             idx === 0
//               ? "bg-purple-500"
//               : idx === 1
//               ? "bg-purple-400"
//               : idx === 2
//               ? "bg-purple-300"
//               : "bg-purple-200";

//           return (
//             <div
//               key={idx}
//               className={`relative rounded-xl flex items-center justify-center ${base}`}
//               style={{ width: `${widthPct}%` }}
//             >
//               <div className="flex flex-col items-center px-1 py-2">
//                 <div className="text-[9px] font-semibold text-white/95 truncate max-w-[90px]">
//                   {step.label}
//                 </div>
//                 <div className="text-[9px] text-white/85">
//                   {step.value ?? 0}
//                 </div>
//               </div>
//             </div>
//           );
//         })}
//       </div>

//       {/* Per-step details */}
//       <div className="grid grid-cols-2 md:grid-cols-3 gap-2 text-[10px] text-slate-600">
//         {steps.map((step, idx) => {
//           const baseVal = steps[0]?.value || 0;
//           const prevVal = idx === 0 ? null : steps[idx - 1].value || 0;
//           const fromStartPct =
//             baseVal > 0 ? ((step.value || 0) / baseVal) * 100 : 0;
//           const fromPrevPct =
//             prevVal > 0 ? ((step.value || 0) / prevVal) * 100 : 0;

//           return (
//             <div
//               key={idx}
//               className="flex flex-col p-2 rounded-xl bg-slate-50 border border-slate-100"
//             >
//               <div className="text-[10px] font-semibold text-slate-700 mb-1">
//                 {step.label}
//               </div>
//               <div>
//                 Count: <span className="font-semibold">{step.value ?? 0}</span>
//               </div>
//               {idx > 0 && (
//                 <>
//                   <div>
//                     From previous:{" "}
//                     <span className="font-semibold">
//                       {fromPrevPct.toFixed(1)}%
//                     </span>
//                   </div>
//                   <div>
//                     From start:{" "}
//                     <span className="font-semibold">
//                       {fromStartPct.toFixed(1)}%
//                     </span>
//                   </div>
//                 </>
//               )}
//               {idx === 0 && (
//                 <div className="text-[9px] text-slate-500">
//                   Funnel entry point
//                 </div>
//               )}
//             </div>
//           );
//         })}
//       </div>
//     </div>
//   );
// }
// üìÑ src/pages/AccountInsights/components/FunnelChart.jsx
import React from "react";

export default function FunnelChart({ title, steps = [] }) {
  if (!steps.length) {
    return (
      <div className="p-4 rounded-lg bg-white border border-slate-200">
        <div className="text-xs font-semibold text-slate-900 mb-1">{title}</div>
        <div className="text-[10px] text-slate-500">
          No data available for this funnel.
        </div>
      </div>
    );
  }

  const max = steps[0]?.value || 0;
  const base = max || 1;

  return (
    <div className="p-4 rounded-lg bg-white border border-slate-200 space-y-3">
      <div className="flex items-baseline justify-between gap-2">
        <div className="text-xs font-semibold text-slate-900">{title}</div>
        <div className="text-[9px] text-slate-500">
          Left ‚Üí right; width shows relative retention.
        </div>
      </div>

      <div className="flex items-stretch gap-1 w-full">
        {steps.map((step, idx) => {
          const pct = Math.max(6, (step.value || 0 / base) * 100);
          return (
            <div
              key={idx}
              className="relative rounded-md bg-slate-900/90 flex items-center justify-center"
              style={{ width: `${pct}%` }}
            >
              <div className="px-2 py-1 flex flex-col items-center">
                <div className="text-[8px] font-medium text-slate-50 truncate max-w-[120px]">
                  {step.label}
                </div>
                <div className="text-[8px] text-slate-100">
                  {step.value ?? 0}
                </div>
              </div>
            </div>
          );
        })}
      </div>

      {/* Detail row */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-2 text-[9px] text-slate-600">
        {steps.map((step, idx) => {
          const fromStart =
            base > 0 ? (((step.value || 0) / base) * 100).toFixed(1) : "0.0";
          const prev = steps[idx - 1]?.value || 0;
          const fromPrev =
            idx === 0 || prev === 0
              ? null
              : (((step.value || 0) / prev) * 100).toFixed(1);

          return (
            <div
              key={idx}
              className="p-2 rounded-md bg-slate-50 border border-slate-200"
            >
              <div className="text-[9px] font-semibold text-slate-800 mb-0.5">
                {step.label}
              </div>
              <div>
                Count:{" "}
                <span className="font-semibold text-slate-900">
                  {step.value ?? 0}
                </span>
              </div>
              {idx === 0 ? (
                <div className="text-[8px] text-slate-500">Entry cohort</div>
              ) : (
                <>
                  <div>
                    From previous:{" "}
                    <span className="font-semibold">{fromPrev ?? "‚Äì"}%</span>
                  </div>
                  <div>
                    From start:{" "}
                    <span className="font-semibold">{fromStart}%</span>
                  </div>
                </>
              )}
            </div>
          );
        })}
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\AccountInsights\components\InsightsTabs.jsx 
====================================================== 
 
import React from "react";
import { NavLink, useLocation } from "react-router-dom";

const tabs = [
  {
    key: "overview",
    label: "Overview",
    to: "/app/admin/account-insights",
  },
  {
    key: "funnels",
    label: "Funnels",
    to: "/app/admin/account-insights/funnels",
  },
  {
    key: "alerts",
    label: "Alerts",
    to: "/app/admin/account-insights/alerts",
  },
];

export default function InsightsTabs() {
  const location = useLocation();

  return (
    <div className="flex items-center gap-3 border-b border-slate-200 mb-4">
      {tabs.map(tab => {
        const active = location.pathname === tab.to;
        return (
          <NavLink
            key={tab.key}
            to={tab.to}
            className={`pb-2 text-base font-medium border-b-2 transition-colors ${
              active
                ? "border-purple-600 text-purple-700"
                : "border-transparent text-slate-500 hover:text-slate-800 hover:border-slate-300"
            }`}
          >
            {tab.label}
          </NavLink>
        );
      })}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\AccountInsights\components\MetricCard.jsx 
====================================================== 
 
// import React from "react";

// export default function MetricCard({
//   label,
//   value,
//   subtitle,
//   highlight = false,
// }) {
//   return (
//     <div
//       className={`flex flex-col gap-1 p-4 rounded-2xl shadow-sm border
//       bg-white/90 backdrop-blur-sm
//       ${highlight ? "border-purple-500/70" : "border-slate-200"}`}
//     >
//       <div className="text-xs font-semibold uppercase tracking-wide text-slate-500">
//         {label}
//       </div>

//       <div className="text-2xl font-semibold text-slate-900">
//         {value ?? "--"}
//       </div>

//       {subtitle && (
//         <div className="text-xs text-slate-500 leading-snug">{subtitle}</div>
//       )}
//     </div>
//   );
// }
// üìÑ src/pages/AccountInsights/components/MetricCard.jsx
import React from "react";

export default function MetricCard({
  label,
  value,
  subtitle,
  tone = "default", // "default" | "positive" | "negative" | "accent"
}) {
  const toneClasses =
    tone === "accent"
      ? "border-slate-900"
      : tone === "positive"
      ? "border-emerald-400"
      : tone === "negative"
      ? "border-red-400"
      : "border-slate-200";

  return (
    <div
      className={`
        flex flex-col gap-1.5 p-3.5 rounded-lg bg-white
        border ${toneClasses}
        shadow-[0_1px_2px_rgba(15,23,42,0.04)]
      `}
    >
      <div className="text-[9px] font-semibold uppercase tracking-[0.14em] text-slate-500">
        {label}
      </div>
      <div className="text-xl font-semibold text-slate-900 leading-tight">
        {value ?? "‚Äî"}
      </div>
      {subtitle && (
        <div className="text-[10px] text-slate-500 leading-snug">
          {subtitle}
        </div>
      )}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\AccountInsights\components\TrendChart.jsx 
====================================================== 
 
import React from "react";
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  BarElement,
  Tooltip,
  Legend,
} from "chart.js";
import { Line, Bar } from "react-chartjs-2";

ChartJS.register(
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  BarElement,
  Tooltip,
  Legend
);

export default function TrendChart({
  title,
  labels = [],
  values = [],
  type = "line", // "line" | "bar"
}) {
  const data = {
    labels,
    datasets: [
      {
        label: title,
        data: values,
        fill: false,
      },
    ],
  };

  const options = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: false },
      tooltip: {
        mode: "index",
        intersect: false,
      },
    },
    scales: {
      x: {
        ticks: { font: { size: 10 } },
        grid: { display: false },
      },
      y: {
        beginAtZero: true,
        ticks: { font: { size: 10 } },
        grid: { color: "rgba(148,163,253,0.08)" },
      },
    },
  };

  const ChartComponent = type === "bar" ? Bar : Line;

  return (
    <div className="w-full h-56 p-4 rounded-2xl bg-white/90 border border-slate-200 shadow-sm">
      <div className="text-sm font-semibold text-slate-700 mb-2">{title}</div>
      <ChartComponent data={data} options={options} />
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\admin\FeatureToggles.jsx 
====================================================== 
 
// src/pages/admin/FeatureToggles.jsx
import React from "react";

export default function FeatureToggles() {
  return (
    <div className="p-6">
      <h2 className="text-2xl font-bold text-purple-800 mb-4">
        üõ†Ô∏è Feature Toggles
      </h2>
      <div className="bg-white rounded-2xl shadow p-6 text-gray-600">
        This page will allow admins to enable or disable platform features
        dynamically. (Coming soon üöÄ)
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\admin\FeatureAccess\FeatureToggles.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../../api/axiosClient";
import FeatureToggleTable from "./FeatureToggleTable";
import { toast } from "react-toastify";

export default function FeatureToggles() {
  const [businessList, setBusinessList] = useState([]);
  const [featureAccessMap, setFeatureAccessMap] = useState({});
  const [isLoading, setIsLoading] = useState(true);

  const availableFeatures = ["CRM", "Campaigns", "Catalog"];

  useEffect(() => {
    loadBusinesses();
  }, []);

  async function loadBusinesses() {
    try {
      setIsLoading(true);

      const response = await axiosClient.get("/businesses/approved");
      const businesses = response.data;
      setBusinessList(businesses);

      const allFeatureAccess = {};

      for (const business of businesses) {
        const res = await axiosClient.get(
          `/feature-access/business/${business.id}`
        );
        allFeatureAccess[business.id] = res.data;
      }

      setFeatureAccessMap(allFeatureAccess);
    } catch (err) {
      toast.error("Failed to load businesses or access rules");
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  }

  async function handleToggle(businessId, featureName, isEnabled) {
    const existing = featureAccessMap[businessId]?.find(
      f => f.featureName === featureName
    );

    try {
      if (existing) {
        await axiosClient.put(`/feature-access/${existing.id}`, {
          ...existing,
          isEnabled,
        });
      } else {
        await axiosClient.post(`/feature-access`, {
          businessId,
          featureName,
          isEnabled,
          notes: "",
        });
      }

      toast.success("Feature access updated");
      loadBusinesses();
    } catch (err) {
      toast.error("Failed to update feature access");
      console.error(err);
    }
  }

  return (
    <div className="p-6">
      <h2 className="text-xl font-bold mb-4">Feature Access Control</h2>
      {isLoading ? (
        <p>Loading...</p>
      ) : (
        <FeatureToggleTable
          businesses={businessList}
          features={availableFeatures}
          featureAccessMap={featureAccessMap}
          onToggle={handleToggle}
        />
      )}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\admin\FeatureAccess\FeatureToggleTable.jsx 
====================================================== 
 
import React from "react";
import ToggleSwitch from "../../../components/common/ToggleSwitch";

export default function FeatureToggleTable({
  businesses,
  features,
  featureAccessMap,
  onToggle,
}) {
  return (
    <div className="overflow-auto border rounded-md">
      <table className="min-w-full text-sm">
        <thead className="bg-gray-100 text-left">
          <tr>
            <th className="px-4 py-2">Business Name</th>
            {features.map(feature => (
              <th key={feature} className="px-4 py-2 text-center">
                {feature}
              </th>
            ))}
          </tr>
        </thead>
        <tbody>
          {businesses.map(biz => (
            <tr key={biz.id} className="border-t">
              <td className="px-4 py-2 font-medium">{biz.companyName}</td>
              {features.map(feature => {
                const access = featureAccessMap[biz.id]?.find(
                  f => f.featureName === feature
                );
                const isEnabled = access ? access.isEnabled : false;

                return (
                  <td key={feature} className="px-4 py-2 text-center">
                    <div className="flex items-center justify-center gap-2">
                      <ToggleSwitch
                        checked={isEnabled}
                        onChange={e =>
                          onToggle(biz.id, feature, e.target.checked)
                        }
                      />
                      <span
                        className={`text-xs font-medium px-2 py-0.5 rounded ${
                          isEnabled
                            ? "bg-green-100 text-green-800"
                            : "bg-red-100 text-red-700"
                        }`}
                      >
                        {isEnabled ? "Enabled" : "Disabled"}
                      </span>
                    </div>
                  </td>
                );
              })}
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\admin\FeatureAccess\PlanManagement.jsx 
====================================================== 
 
"use client";

import React, { useEffect, useState, useCallback } from "react";
import * as TabsPrimitive from "@radix-ui/react-tabs";
import { Button } from "../../../components/ui/button";
import { Switch } from "../../../components/ui/switch";
import { Pencil, Trash2, Layers } from "lucide-react";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
  DialogClose,
} from "../../../components/ui/dialog";
import { Input } from "../../../components/ui/input";
import { Label } from "../../../components/ui/label";

import {
  getPlans,
  createPlan,
  updatePlan,
  deletePlan,
  getPlanPermissions,
  updatePlanPermissions,
  getGroupedPermissions,
} from "../../../api/plans";

function cn(...classes) {
  return classes.filter(Boolean).join(" ");
}

const Tabs = TabsPrimitive.Root;
const TabsList = React.forwardRef(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center rounded-md bg-gray-100 p-1 text-gray-600",
      className
    )}
    {...props}
  />
));
TabsList.displayName = TabsPrimitive.List.displayName;

const TabsTrigger = React.forwardRef(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1.5 text-sm font-medium transition-all",
      "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-purple-500 focus-visible:ring-offset-2",
      "disabled:pointer-events-none disabled:opacity-50",
      "data-[state=active]:bg-white data-[state=active]:text-purple-600 data-[state=active]:shadow",
      className
    )}
    {...props}
  />
));
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName;

const TabsContent = React.forwardRef(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    className={cn("mt-2 focus-visible:outline-none", className)}
    {...props}
  />
));
TabsContent.displayName = TabsPrimitive.Content.displayName;

export default function PlanManagement() {
  const [plans, setPlans] = useState([]);
  const [selectedPlan, setSelectedPlan] = useState(null);
  const [activeTab, setActiveTab] = useState("");
  const [selectedFeatures, setSelectedFeatures] = useState({});
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [formMode, setFormMode] = useState("create");
  const [planForm, setPlanForm] = useState({
    name: "",
    code: "",
    description: "",
  });
  const [loading, setLoading] = useState(true);
  const [featureGroups, setFeatureGroups] = useState([]);

  const fetchPlans = useCallback(async () => {
    try {
      setLoading(true);
      console.log("Fetching plans...");
      const { data } = await getPlans();
      console.log("Plans API response:", data);

      const normalized = Array.isArray(data) ? data : [];
      setPlans(normalized);

      if (normalized.length) {
        const first = normalized[0];
        console.log("Selecting first plan:", first);
        setSelectedPlan(first);
        fetchPermissions(first.id);
      } else {
        console.warn("No plans found from API");
        setSelectedPlan(null);
        setSelectedFeatures({});
      }
    } catch (err) {
      console.error("Error fetching plans:", err);
      setPlans([]);
    } finally {
      setLoading(false);
    }
  }, []);

  const fetchPermissions = async planId => {
    try {
      console.log("Fetching permissions for planId:", planId);
      const { data } = await getPlanPermissions(planId);
      console.log("Plan permissions API response:", data);

      const map = Array.isArray(data)
        ? data.reduce((acc, perm) => ({ ...acc, [perm.code]: true }), {})
        : {};
      setSelectedFeatures(map);
    } catch (err) {
      console.error("Error fetching permissions:", err);
    }
  };

  const fetchFeatures = async () => {
    try {
      console.log("Fetching grouped permissions...");
      const res = await getGroupedPermissions();
      console.log("Grouped permissions raw API response:", res);

      // ‚úÖ Extract actual array
      const permissionsArray = res?.data?.data || [];

      if (Array.isArray(permissionsArray) && permissionsArray.length) {
        setFeatureGroups(permissionsArray);
        setActiveTab(permissionsArray[0].group);
        console.log("Feature groups set:", permissionsArray);
      } else {
        console.warn("No feature groups returned from API");
        setFeatureGroups([]);
      }
    } catch (err) {
      console.error("Error fetching features:", err);
      setFeatureGroups([]);
    }
  };

  const handleSavePermissions = async () => {
    if (!selectedPlan) return;

    try {
      // Get all selected codes
      const selectedCodes = Object.entries(selectedFeatures)
        .filter(([_, isEnabled]) => isEnabled)
        .map(([code]) => code);

      // Map codes to IDs
      const enabledPermissionIds = featureGroups
        .flatMap(group => group.features)
        .filter(feature => selectedCodes.includes(feature.code))
        .map(feature => feature.id); // GUIDs

      console.log(
        "Saving permissions for plan:",
        selectedPlan.id,
        enabledPermissionIds
      );

      await updatePlanPermissions(selectedPlan.id, enabledPermissionIds);

      // Optionally refresh UI
      // await fetchPermissions(selectedPlan.id);

      // toast.success("Permissions updated successfully!");
    } catch (err) {
      console.error("Error saving permissions:", err);
      // toast.error("Failed to save permissions");
    }
  };

  const toggleFeature = featureCode => {
    console.log("Toggling feature:", featureCode);
    setSelectedFeatures(prev => ({
      ...prev,
      [featureCode]: !prev[featureCode],
    }));
  };

  const handleFormSubmit = async () => {
    try {
      if (formMode === "create") {
        console.log("Creating new plan:", planForm);
        await createPlan({
          name: planForm.name,
          code:
            planForm.code || planForm.name.toUpperCase().replace(/\s+/g, "_"),
          description: planForm.description,
          isActive: true,
        });
      } else {
        console.log("Updating plan:", selectedPlan.id, planForm);
        await updatePlan(selectedPlan.id, {
          name: planForm.name,
          code: planForm.code,
          description: planForm.description,
          isActive: true,
        });
      }
      setIsDialogOpen(false);
      setPlanForm({ name: "", code: "", description: "" });
      fetchPlans();
    } catch (err) {
      console.error("Error saving plan:", err);
    }
  };

  const handleDeletePlan = async planId => {
    if (!window.confirm("Are you sure you want to delete this plan?")) return;
    try {
      console.log("Deleting plan:", planId);
      await deletePlan(planId);
      if (selectedPlan?.id === planId) {
        setSelectedPlan(null);
        setSelectedFeatures({});
      }
      fetchPlans();
    } catch (err) {
      console.error("Error deleting plan:", err);
    }
  };

  const openEditModal = plan => {
    console.log("Opening edit modal for plan:", plan);
    setFormMode("edit");
    setPlanForm({
      name: plan.name,
      code: plan.code,
      description: plan.description || "",
    });
    setSelectedPlan(plan);
    setIsDialogOpen(true);
  };

  useEffect(() => {
    console.log("Component mounted: fetching plans and features...");
    fetchPlans();
    fetchFeatures();
  }, [fetchPlans]);

  return (
    <div className="flex h-full p-6 gap-6">
      {/* Left side: Plans */}
      <div className="w-1/3 border rounded-xl p-4 bg-white shadow-sm flex flex-col">
        <div className="flex justify-between items-center mb-5">
          <h2 className="text-lg font-semibold">Plans</h2>
          <Button
            className="bg-purple-600 hover:bg-purple-700 text-white"
            onClick={() => {
              console.log("Opening create plan modal");
              setFormMode("create");
              setPlanForm({ name: "", code: "", description: "" });
              setIsDialogOpen(true);
            }}
          >
            + Add Plan
          </Button>
        </div>

        {loading ? (
          <div className="p-4 text-sm text-gray-500">Loading plans...</div>
        ) : plans.length === 0 ? (
          <div className="p-4 text-sm text-gray-500 bg-gray-50 border rounded-md">
            No plans found.
          </div>
        ) : (
          <div className="space-y-3 flex-1 overflow-y-auto pr-1">
            {plans.map(plan => (
              <div
                key={plan.id}
                onClick={() => {
                  console.log("Selecting plan:", plan);
                  setSelectedPlan(plan);
                  fetchPermissions(plan.id);
                }}
                className={cn(
                  "p-4 rounded-lg border transition-all cursor-pointer flex items-center justify-between group",
                  selectedPlan?.id === plan.id
                    ? "border-purple-500 bg-purple-50 shadow-md"
                    : "border-gray-200 hover:border-purple-300 hover:bg-gray-50"
                )}
              >
                <div className="flex items-center gap-3">
                  <div className="bg-purple-100 text-purple-600 p-2 rounded-full">
                    <Layers size={18} />
                  </div>
                  <div>
                    <span className="text-base font-semibold text-gray-800">
                      {plan.name}
                    </span>
                    {plan.description && (
                      <p className="text-xs text-gray-500">
                        {plan.description}
                      </p>
                    )}
                  </div>
                </div>

                <div className="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                  <button
                    onClick={e => {
                      e.stopPropagation();
                      openEditModal(plan);
                    }}
                    className="p-1.5 rounded-md bg-purple-100 text-purple-600 hover:bg-purple-200"
                  >
                    <Pencil size={16} />
                  </button>
                  <button
                    onClick={e => {
                      e.stopPropagation();
                      handleDeletePlan(plan.id);
                    }}
                    className="p-1.5 rounded-md bg-red-100 text-red-600 hover:bg-red-200"
                  >
                    <Trash2 size={16} />
                  </button>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Right side: Features */}
      <div className="flex-1 border rounded-lg p-4 bg-white shadow-sm">
        <h2 className="text-lg font-semibold mb-4">
          Feature Mapping ‚Äì {selectedPlan?.name || "N/A"}
        </h2>

        <Tabs value={activeTab} onValueChange={setActiveTab}>
          <TabsList className="mb-4">
            {featureGroups.map(group => (
              <TabsTrigger key={group.group} value={group.group}>
                {group.group}
              </TabsTrigger>
            ))}
          </TabsList>
          {featureGroups.map(group => (
            <TabsContent key={group.group} value={group.group}>
              <div className="space-y-3">
                {(Array.isArray(group.features) ? group.features : []).map(
                  feature => {
                    const display = feature.code
                      .replace(/\./g, " ")
                      .replace(/\b\w/g, c => c.toUpperCase());
                    return (
                      <div
                        key={feature.code}
                        className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition"
                      >
                        <span className="text-sm font-medium text-gray-700">
                          {display}
                        </span>
                        <Switch
                          id={feature.code}
                          checked={!!selectedFeatures[feature.code]}
                          onCheckedChange={() => toggleFeature(feature.code)}
                        />
                      </div>
                    );
                  }
                )}
              </div>
            </TabsContent>
          ))}
        </Tabs>
        <div className="mt-6">
          <Button
            onClick={handleSavePermissions}
            disabled={!selectedPlan}
            className="w-full bg-purple-600 hover:bg-purple-700 text-white"
          >
            Save Changes
          </Button>
        </div>
      </div>

      {/* Modal */}
      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>
              {formMode === "create" ? "Create New Plan" : "Edit Plan"}
            </DialogTitle>
          </DialogHeader>
          <div className="space-y-4">
            <div>
              <Label htmlFor="plan-name">Plan Name</Label>
              <Input
                id="plan-name"
                value={planForm.name}
                onChange={e =>
                  setPlanForm({ ...planForm, name: e.target.value })
                }
                placeholder="Enter plan name"
              />
            </div>
            <div>
              <Label htmlFor="plan-code">Code</Label>
              <Input
                id="plan-code"
                value={planForm.code}
                onChange={e =>
                  setPlanForm({ ...planForm, code: e.target.value })
                }
                placeholder="Enter code (optional)"
              />
            </div>
            <div>
              <Label htmlFor="plan-desc">Description</Label>
              <Input
                id="plan-desc"
                value={planForm.description}
                onChange={e =>
                  setPlanForm({ ...planForm, description: e.target.value })
                }
                placeholder="Enter description"
              />
            </div>
          </div>
          <DialogFooter className="flex justify-end gap-2 mt-4">
            <DialogClose asChild>
              <Button variant="outline">Cancel</Button>
            </DialogClose>
            <Button onClick={handleFormSubmit} disabled={!planForm.name.trim()}>
              {formMode === "create" ? "Create" : "Update"}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\admin\FeatureAccess\RolePermissionsPage.jsx 
====================================================== 
 
"use client";

import React, { useEffect, useState, useCallback } from "react";
import * as TabsPrimitive from "@radix-ui/react-tabs";
import { Button } from "../../../components/ui/button";
import { Switch } from "../../../components/ui/switch";
import { Pencil, Trash2, Users2 } from "lucide-react";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
  DialogClose,
} from "../../../components/ui/dialog";
import { Input } from "../../../components/ui/input";
import { Label } from "../../../components/ui/label";

import {
  getRoles,
  createRole,
  updateRole,
  deleteRole,
  getRolePermissions,
  updateRolePermissions,
} from "../../../api/roles";
import { getGroupedPermissions } from "../../../api/plans"; // reuse same endpoint

function cn(...classes) {
  return classes.filter(Boolean).join(" ");
}

const Tabs = TabsPrimitive.Root;
const TabsList = React.forwardRef(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center rounded-md bg-gray-100 p-1 text-gray-600",
      className
    )}
    {...props}
  />
));
TabsList.displayName = TabsPrimitive.List.displayName;

const TabsTrigger = React.forwardRef(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1.5 text-sm font-medium transition-all",
      "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-purple-500 focus-visible:ring-offset-2",
      "disabled:pointer-events-none disabled:opacity-50",
      "data-[state=active]:bg-white data-[state=active]:text-purple-600 data-[state=active]:shadow",
      className
    )}
    {...props}
  />
));
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName;

const TabsContent = React.forwardRef(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    className={cn("mt-2 focus-visible:outline-none", className)}
    {...props}
  />
));
TabsContent.displayName = TabsPrimitive.Content.displayName;

export default function RolePermissionsPage() {
  const [roles, setRoles] = useState([]);
  const [selectedRole, setSelectedRole] = useState(null);
  const [activeTab, setActiveTab] = useState("");
  const [featureGroups, setFeatureGroups] = useState([]);
  const [selected, setSelected] = useState({}); // { 'permission.code': true }
  const [loading, setLoading] = useState(true);

  // modal state for create/edit role (optional)
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [formMode, setFormMode] = useState("create");
  const [roleForm, setRoleForm] = useState({
    name: "",
    code: "",
    description: "",
  });

  // ===== Fetchers =====
  const fetchRoles = useCallback(async () => {
    setLoading(true);
    try {
      const { data } = await getRoles();
      const arr = Array.isArray(data) ? data : [];
      setRoles(arr);
      if (arr.length) {
        setSelectedRole(arr[0]);
        await fetchRolePermissions(arr[0].id);
      }
    } catch (e) {
      console.error("getRoles failed", e);
      setRoles([]);
    } finally {
      setLoading(false);
    }
  }, []);

  const fetchGrouped = async () => {
    try {
      const res = await getGroupedPermissions();
      const groups = res?.data?.data || [];
      setFeatureGroups(groups);
      if (groups.length) setActiveTab(groups[0].group);
    } catch (e) {
      console.error("getGroupedPermissions failed", e);
      setFeatureGroups([]);
    }
  };

  const fetchRolePermissions = async roleId => {
    try {
      const { data } = await getRolePermissions(roleId);
      // API returns array of permission codes or objects {id, code}
      const codes = Array.isArray(data)
        ? data.map(x => (typeof x === "string" ? x : x.code))
        : [];
      const map = Object.fromEntries(codes.map(c => [c, true]));
      setSelected(map);
    } catch (e) {
      console.error("getRolePermissions failed", e);
      setSelected({});
    }
  };

  // ===== Save =====
  const handleSave = async () => {
    if (!selectedRole) return;
    try {
      const pickedCodes = Object.entries(selected)
        .filter(([, v]) => v)
        .map(([code]) => code);

      // map codes ‚Üí ids using featureGroups
      const enabledPermissionIds = featureGroups
        .flatMap(g => g.features || [])
        .filter(f => pickedCodes.includes(f.code))
        .map(f => f.id);

      await updateRolePermissions(selectedRole.id, enabledPermissionIds);
      // optionally refresh from source of truth
      // await fetchRolePermissions(selectedRole.id);
    } catch (e) {
      console.error("updateRolePermissions failed", e);
    }
  };

  const toggle = permCode => {
    setSelected(prev => ({ ...prev, [permCode]: !prev[permCode] }));
  };

  // ===== Role CRUD (optional UI) =====
  const openCreate = () => {
    setFormMode("create");
    setRoleForm({ name: "", code: "", description: "" });
    setIsDialogOpen(true);
  };

  const openEdit = role => {
    setFormMode("edit");
    setRoleForm({
      name: role.name,
      code: role.code,
      description: role.description || "",
    });
    setSelectedRole(role);
    setIsDialogOpen(true);
  };

  const handleRoleFormSubmit = async () => {
    try {
      if (formMode === "create") {
        await createRole({
          name: roleForm.name,
          code:
            roleForm.code || roleForm.name.toUpperCase().replace(/\s+/g, "_"),
          description: roleForm.description,
          isActive: true,
        });
      } else if (selectedRole) {
        await updateRole(selectedRole.id, {
          name: roleForm.name,
          code: roleForm.code,
          description: roleForm.description,
          isActive: true,
        });
      }
      setIsDialogOpen(false);
      setRoleForm({ name: "", code: "", description: "" });
      await fetchRoles();
    } catch (e) {
      console.error("save role failed", e);
    }
  };

  const handleDeleteRole = async roleId => {
    if (!window.confirm("Delete this role?")) return;
    try {
      await deleteRole(roleId);
      if (selectedRole?.id === roleId) {
        setSelectedRole(null);
        setSelected({});
      }
      await fetchRoles();
    } catch (e) {
      console.error("delete role failed", e);
    }
  };

  useEffect(() => {
    fetchRoles();
    fetchGrouped();
  }, [fetchRoles]);

  return (
    <div className="flex h-full p-6 gap-6">
      {/* Left: Roles */}
      <div className="w-1/3 border rounded-xl p-4 bg-white shadow-sm flex flex-col">
        <div className="flex justify-between items-center mb-5">
          <h2 className="text-lg font-semibold">Roles</h2>
          <Button
            className="bg-purple-600 hover:bg-purple-700 text-white"
            onClick={openCreate}
          >
            + Add Role
          </Button>
        </div>

        {loading ? (
          <div className="p-4 text-sm text-gray-500">Loading roles...</div>
        ) : roles.length === 0 ? (
          <div className="p-4 text-sm text-gray-500 bg-gray-50 border rounded-md">
            No roles found.
          </div>
        ) : (
          <div className="space-y-3 flex-1 overflow-y-auto pr-1">
            {roles.map(role => (
              <div
                key={role.id}
                onClick={() => {
                  setSelectedRole(role);
                  fetchRolePermissions(role.id);
                }}
                className={cn(
                  "p-4 rounded-lg border transition-all cursor-pointer flex items-center justify-between group",
                  selectedRole?.id === role.id
                    ? "border-purple-500 bg-purple-50 shadow-md"
                    : "border-gray-200 hover:border-purple-300 hover:bg-gray-50"
                )}
              >
                <div className="flex items-center gap-3">
                  <div className="bg-purple-100 text-purple-600 p-2 rounded-full">
                    <Users2 size={18} />
                  </div>
                  <div>
                    <span className="text-base font-semibold text-gray-800">
                      {role.name}
                    </span>
                    {role.description && (
                      <p className="text-xs text-gray-500">
                        {role.description}
                      </p>
                    )}
                  </div>
                </div>

                <div className="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                  <button
                    onClick={e => {
                      e.stopPropagation();
                      openEdit(role);
                    }}
                    className="p-1.5 rounded-md bg-purple-100 text-purple-600 hover:bg-purple-200"
                    title="Edit"
                  >
                    <Pencil size={16} />
                  </button>
                  <button
                    onClick={e => {
                      e.stopPropagation();
                      handleDeleteRole(role.id);
                    }}
                    className="p-1.5 rounded-md bg-red-100 text-red-600 hover:bg-red-200"
                    title="Delete"
                  >
                    <Trash2 size={16} />
                  </button>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Right: Permissions */}
      <div className="flex-1 border rounded-lg p-4 bg-white shadow-sm">
        <h2 className="text-lg font-semibold mb-4">
          Permission Mapping ‚Äì {selectedRole?.name || "N/A"}
        </h2>

        <Tabs value={activeTab} onValueChange={setActiveTab}>
          <TabsList className="mb-4">
            {featureGroups.map(group => (
              <TabsTrigger key={group.group} value={group.group}>
                {group.group}
              </TabsTrigger>
            ))}
          </TabsList>

          {featureGroups.map(group => (
            <TabsContent key={group.group} value={group.group}>
              <div className="space-y-3">
                {(Array.isArray(group.features) ? group.features : []).map(
                  f => {
                    const display = f.code
                      .replace(/\./g, " ")
                      .replace(/\b\w/g, c => c.toUpperCase());
                    return (
                      <div
                        key={f.code}
                        className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition"
                      >
                        <span className="text-sm font-medium text-gray-700">
                          {display}
                        </span>
                        <Switch
                          id={f.code}
                          checked={!!selected[f.code]}
                          onCheckedChange={() => toggle(f.code)}
                        />
                      </div>
                    );
                  }
                )}
              </div>
            </TabsContent>
          ))}
        </Tabs>

        <div className="mt-6">
          <Button
            onClick={handleSave}
            disabled={!selectedRole}
            className="w-full bg-purple-600 hover:bg-purple-700 text-white"
          >
            Save Changes
          </Button>
        </div>
      </div>

      {/* Modal */}
      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>
              {formMode === "create" ? "Create New Role" : "Edit Role"}
            </DialogTitle>
          </DialogHeader>
          <div className="space-y-4">
            <div>
              <Label htmlFor="role-name">Role Name</Label>
              <Input
                id="role-name"
                value={roleForm.name}
                onChange={e =>
                  setRoleForm({ ...roleForm, name: e.target.value })
                }
                placeholder="Enter role name"
              />
            </div>
            <div>
              <Label htmlFor="role-code">Code</Label>
              <Input
                id="role-code"
                value={roleForm.code}
                onChange={e =>
                  setRoleForm({ ...roleForm, code: e.target.value })
                }
                placeholder="BUSINESS, ADMIN, SUPPORT..."
              />
            </div>
            <div>
              <Label htmlFor="role-desc">Description</Label>
              <Input
                id="role-desc"
                value={roleForm.description}
                onChange={e =>
                  setRoleForm({ ...roleForm, description: e.target.value })
                }
                placeholder="Enter description"
              />
            </div>
          </div>
          <DialogFooter className="flex justify-end gap-2 mt-4">
            <DialogClose asChild>
              <Button variant="outline">Cancel</Button>
            </DialogClose>
            <Button
              onClick={handleRoleFormSubmit}
              disabled={!roleForm.name.trim()}
            >
              {formMode === "create" ? "Create" : "Update"}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\auth\access.ts 
====================================================== 
 
// Shared helpers so tests/guards use identical logic

export function canUseFeature({
  role,
  hasAllAccess = false,
  availableFeatures = {},
  required,
}: {
  role?: string;
  hasAllAccess?: boolean;
  availableFeatures?: Record<string, boolean>;
  required?: { role?: string[]; featureKeys?: string[] };
}): boolean {
  if (!required) return true;
  if (hasAllAccess || role === "superadmin") return true;

  if (required.role && !required.role.includes(role ?? "")) return false;

  if (required.featureKeys?.length) {
    return required.featureKeys.every(k => !!availableFeatures[k]);
  }
  return true;
}

export function hasRequiredPerms({
  can,
  perms,
  requireAll = false,
  hasAllAccess = false,
}: {
  can?: (perm: string) => boolean;
  perms?: string[]; // e.g. ["messaging.inbox.view"]
  requireAll?: boolean;
  hasAllAccess?: boolean;
}): boolean {
  if (!perms?.length) return true;
  if (hasAllAccess) return true;
  if (!can) return false;
  return requireAll ? perms.every(p => can(p)) : perms.some(p => can(p));
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\auth\BusinessSignup.jsx 
====================================================== 
 
import { useState } from "react";
import { Link } from "react-router-dom";
import axiosClient from "../../api/axiosClient"; // ‚úÖ Added axiosClient import

function BusinessSignup() {
  const [form, setForm] = useState({
    companyName: "",
    email: "",
    password: "",
  });

  const [loading, setLoading] = useState(false);
  const [successMsg, setSuccessMsg] = useState("");
  const [error, setError] = useState("");

  const handleChange = e => {
    setForm({ ...form, [e.target.name]: e.target.value });
  };

  const handleSubmit = async e => {
    e.preventDefault();
    setLoading(true);
    setSuccessMsg("");
    setError("");

    try {
      const response = await axiosClient.post(
        "/auth/business-user-signup",
        form
      );

      if (!response.data.success) {
        throw new Error(response.data.message || "Signup failed. Try again.");
      }

      setSuccessMsg(
        "‚úÖ Signup successful! We'll review and approve your account."
      );
      setForm({ companyName: "", email: "", password: "" });
    } catch (err) {
      setError(
        err?.response?.data?.message || err.message || "‚ùå Signup failed."
      );
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-100 to-purple-200 flex items-center justify-center px-6 md:px-20 lg:px-36">
      <div className="flex flex-col md:flex-row w-full max-w-6xl shadow-2xl rounded-3xl overflow-hidden bg-white">
        {/* Left Image Section */}
        <div className="md:w-1/2 hidden md:block">
          <img
            src="/loginpage_.png"
            alt="Marketing Visual"
            className="h-full w-full object-cover"
          />
        </div>

        {/* Right Signup Form */}
        <div className="w-full md:w-1/2 flex flex-col justify-center px-8 sm:px-12 md:px-16 lg:px-20 py-12">
          <div className="flex justify-center mb-4">
            <img src="/logo_5.svg" alt="xByteChat Logo" className="h-10" />
          </div>

          <h2 className="text-2xl font-bold text-center text-purple-800 mb-6">
            Create Your <span className="text-purple-900">xByteChat</span>{" "}
            Profile
          </h2>

          {successMsg && (
            <div className="bg-green-100 text-green-700 p-3 rounded-lg mb-4 text-sm text-center font-medium shadow">
              {successMsg}
            </div>
          )}
          {error && (
            <div className="bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm text-center font-medium shadow">
              {error}
            </div>
          )}

          <form onSubmit={handleSubmit} className="space-y-5">
            <div>
              <label className="text-sm font-semibold text-gray-700">
                Company Name
              </label>
              <input
                type="text"
                name="companyName"
                value={form.companyName}
                onChange={handleChange}
                required
                className="mt-1 w-full p-2 px-4 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 transition"
              />
            </div>

            <div>
              <label className="text-sm font-semibold text-gray-700">
                Email
              </label>
              <input
                type="email"
                name="email"
                value={form.email}
                onChange={handleChange}
                required
                className="mt-1 w-full p-2 px-4 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 transition"
              />
            </div>

            <div>
              <label className="text-sm font-semibold text-gray-700">
                Password
              </label>
              <input
                type="password"
                name="password"
                value={form.password}
                onChange={handleChange}
                required
                minLength={6}
                className="mt-1 w-full p-2 px-4 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 transition"
              />
            </div>

            <button
              type="submit"
              disabled={loading}
              className="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-medium transition disabled:opacity-60"
            >
              {loading ? "Creating profile..." : "Create Profile"}
            </button>
          </form>

          <div className="text-center mt-5 text-sm text-gray-600">
            Already have an account?{" "}
            <Link
              to="/login"
              className="text-purple-600 hover:underline font-medium"
            >
              Login
            </Link>
          </div>
        </div>
      </div>
    </div>
  );
}

export default BusinessSignup;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\auth\ExtrackAllFiles.bat 
====================================================== 
 
@echo off
REM This script will find all files and output their name and content into one file.
REM The output file will be named [FolderName]_AllFileDump.txt.

REM Get the current folder's name and set it as the output file name with the custom suffix
for %%I in ("%cd%") do set "outputFile=%%~nI_AllFileDump.txt"

REM Clear the output file to start fresh
> "%outputFile%" (echo Folder and File Content Report)
echo. >> "%outputFile%"

REM Loop through all files in the current directory and subdirectories
for /R . %%F in (*.*) do (
    echo ====================================================== >> "%outputFile%"
    echo FILE: %%F >> "%outputFile%"
    echo ====================================================== >> "%outputFile%"
    echo. >> "%outputFile%"
    type "%%F" >> "%outputFile%" 2>nul
    echo. >> "%outputFile%"
    echo. >> "%outputFile%"
)

echo Finished! All content has been extracted to %outputFile% 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\auth\guardLogger.ts 
====================================================== 
 
// src/auth/guardLogger.ts
export function logGuard(event: {
  where: string; // "ProtectedRoute:/app/admin/plan-manager"
  role: string;
  plan?: string;
  required?: { role?: string[]; featureKeys?: string[] };
  availableFeatures?: Record<string, boolean>;
  allowed: boolean;
}) {
  if (process.env.NODE_ENV === "production") return;
  // eslint-disable-next-line no-console
  console.info("[guard]", event);
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\auth\Login.css 
====================================================== 
 
.login-page-wrapper {
  position: relative;
  min-height: 100vh;
  background: #f9f9ff;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}

.bg-animation {
  position: absolute;
  width: 200%;
  height: 200%;
  background: linear-gradient(-45deg, #a78bfa, #fcd34d, #ec4899, #6366f1);
  background-size: 400% 400%;
  animation: gradient 15s ease infinite;
  filter: blur(100px);
  z-index: 0;
}

.floating-shape {
  position: absolute;
  width: 80px;
  height: 80px;
  background: rgba(255, 255, 255, 0.15);
  border-radius: 50%;
  animation: float 12s ease-in-out infinite;
  z-index: 0;
}
.floating-shape:nth-child(2) {
  top: 10%;
  left: 15%;
  animation-delay: 1s;
}
.floating-shape:nth-child(3) {
  bottom: 10%;
  right: 20%;
  animation-delay: 2s;
}
@keyframes float {
  0%,
  100% {
    transform: translateY(0) rotate(0deg);
  }
  50% {
    transform: translateY(-20px) rotate(180deg);
  }
}

.login-form-container {
  position: relative;
  z-index: 2;
  background: rgba(255, 255, 255, 0.75);
  backdrop-filter: blur(20px);
  border-radius: 1.5rem;
  padding: 2.5rem;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
  width: 100%;
  max-width: 420px;
  animation: fadeIn 1s ease forwards;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.login-form-container h2 {
  font-size: 1.75rem;
  margin-bottom: 1.5rem;
  color: #4f46e5;
}

.login-form-container input {
  transition: all 0.3s ease;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}
.login-form-container input:focus {
  border-color: #a78bfa;
  box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.3);
}

.login-form-container button {
  background: linear-gradient(to right, #8b5cf6, #6366f1);
  font-weight: 600;
  transition: all 0.3s ease;
}
.login-form-container button:hover {
  background: linear-gradient(to right, #7c3aed, #4f46e5);
  transform: translateY(-1px);
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\auth\Login.jsx 
====================================================== 
 
// üìÑ src/pages/auth/Login.jsx
import React, { useState } from "react";
import { useNavigate, Link } from "react-router-dom";
import { toast } from "react-toastify";
import { login } from "./services/authService";
import { useAuth } from "./context/pld_AuthContext";

const Login = () => {
  const navigate = useNavigate();
  const { refreshAuthContext } = useAuth();

  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");
  const [loading, setLoading] = useState(false);
  const [showPassword, setShowPassword] = useState(false);

  const routeForStatus = (status = "") => {
    const s = String(status).toLowerCase();
    if (s === "profilepending") return "/app/profile-completion";
    if (s === "pending" || s === "underreview") return "/pending-approval";
    if (s === "suspended" || s === "blocked") return "/no-access";

    return "/app/dashboard";
  };

  const handleSubmit = async e => {
    e.preventDefault();
    setError("");
    setLoading(true);

    try {
      // üîê Do login; our authService returns { success, status, role, ... } and sets the JWT
      const res = await login(email, password);

      // üßØ Suppress any 401/403 toasts during the immediate background refetch
      sessionStorage.setItem("xb_suppress_401_toast", "1");
      setTimeout(
        () => sessionStorage.removeItem("xb_suppress_401_toast"),
        4000
      );

      // refresh context (server-authoritative)
      await refreshAuthContext();

      // üîÅ Bust cached auth state across tabs/sessions
      try {
        localStorage.setItem("xb_session_stamp", String(Date.now()));
        localStorage.removeItem("messaging-pinned");
        localStorage.removeItem("messaging-archived");
        localStorage.removeItem("messaging-order");
      } catch {}

      const next = routeForStatus(res?.status);
      if (next === "/app/profile-completion") {
        toast.info("üß© Please complete your profile to continue.");
      } else if (next === "/pending-approval") {
        toast.warn("‚è≥ Your account is pending approval.");
      } else {
        toast.success("‚úÖ Login successful");
      }

      navigate(next, { replace: true });
    } catch (err) {
      const message =
        err?.response?.data?.message || err?.message || "‚ùå Login failed.";
      const isWarning =
        message.toLowerCase().includes("pending") ||
        message.toLowerCase().includes("under review");
      (isWarning ? toast.warn : toast.error)(message);
      setError(message);
    } finally {
      setLoading(false);
    }
  };

  const isWarning =
    error.toLowerCase().includes("pending") ||
    error.toLowerCase().includes("under review");

  return (
    <div
      className="min-h-screen bg-gradient-to-br from-emerald-50 to-cyan-50 flex items-center justify-center px-4 py-4"
      data-test-id="login-page"
    >
      <div className="flex flex-col lg:flex-row w-full max-w-5xl shadow-2xl rounded-2xl overflow-hidden bg-white">
        {/* Left Side - Marketing Panel */}
        <div className="lg:w-1/2 bg-gradient-to-br from-emerald-50 to-cyan-50 p-6 lg:p-8 flex flex-col justify-center">
          {/* Logo */}
          <div className="mb-6">
            <div className="flex items-center space-x-3">
              <img
                src="/logo/logo.svg"
                alt="XploreByte Logo"
                className="w-10 h-10 rounded-lg shadow-sm"
              />
              <span className="text-2xl font-bold text-gray-900">
                XploreByte
              </span>
            </div>
          </div>

          {/* Welcome Message */}
          <div className="mb-6">
            <h1 className="text-3xl lg:text-4xl font-bold text-gray-900 mb-3">
              Welcome Back!
            </h1>
            <p className="text-gray-600 text-lg">
              Sign in to continue your WhatsApp Business journey
            </p>
          </div>

          {/* Features */}
          <div className="space-y-3">
            <div className="flex items-center space-x-3">
              <div className="w-8 h-8 bg-emerald-100 rounded-lg flex items-center justify-center">
                <svg
                  className="w-4 h-4 text-emerald-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M5 13l4 4L19 7"
                  />
                </svg>
              </div>
              <span className="text-sm text-gray-700">
                Access your WhatsApp Business API
              </span>
            </div>
            <div className="flex items-center space-x-3">
              <div className="w-8 h-8 bg-cyan-100 rounded-lg flex items-center justify-center">
                <svg
                  className="w-4 h-4 text-cyan-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M13 10V3L4 14h7v7l9-11h-7z"
                  />
                </svg>
              </div>
              <span className="text-sm text-gray-700">
                Manage campaigns and automation
              </span>
            </div>
            <div className="flex items-center space-x-3">
              <div className="w-8 h-8 bg-sapphire-100 rounded-lg flex items-center justify-center">
                <svg
                  className="w-4 h-4 text-sapphire-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                  />
                </svg>
              </div>
              <span className="text-sm text-gray-700">
                View analytics and insights
              </span>
            </div>
          </div>
        </div>

        {/* Right Side - Login Form */}
        <div className="lg:w-1/2 bg-white p-6 lg:p-8 flex flex-col justify-center">
          {/* Form Header */}
          <div className="mb-6">
            <h2 className="text-2xl font-bold text-gray-900 mb-2">Sign In</h2>
            <p className="text-gray-600 text-sm">
              Enter your credentials to access your account
            </p>
          </div>

          {error && (
            <div
              className={`p-3 rounded-lg mb-4 text-sm font-medium ${
                isWarning
                  ? "bg-yellow-50 text-yellow-800 border border-yellow-200"
                  : "bg-red-50 text-red-700 border border-red-200"
              }`}
              role="alert"
              aria-live="polite"
              data-test-id="auth-error"
            >
              {error}
            </div>
          )}

          <form
            onSubmit={handleSubmit}
            className="space-y-4"
            data-test-id="login-form"
            aria-busy={loading ? "true" : "false"}
          >
            {/* Email Field */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Email Address
              </label>
              <input
                type="email"
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition text-sm"
                placeholder="Enter your email address"
                value={email}
                onChange={e => setEmail(e.target.value)}
                required
                autoComplete="username email"
                name="email"
                data-test-id="login-email"
              />
            </div>

            {/* Password Field */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Password
              </label>
              <div className="relative">
                <input
                  type={showPassword ? "text" : "password"}
                  className="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition text-sm"
                  placeholder="Enter your password"
                  value={password}
                  onChange={e => setPassword(e.target.value)}
                  required
                  autoComplete="current-password"
                  name="password"
                  data-test-id="login-password"
                />
                <button
                  type="button"
                  className="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
                  onClick={() => setShowPassword(prev => !prev)}
                  data-test-id="toggle-password-visibility"
                  aria-label={showPassword ? "Hide password" : "Show password"}
                >
                  {showPassword ? "üôà" : "üëÅÔ∏è"}
                </button>
              </div>
            </div>

            {/* Login Button */}
            <button
              type="submit"
              disabled={loading}
              className={`w-full py-2 px-4 rounded-lg font-medium transition ${
                loading
                  ? "bg-gray-300 text-gray-500 cursor-not-allowed"
                  : "bg-gradient-to-r from-emerald-600 to-sapphire-600 hover:from-emerald-700 hover:to-sapphire-700 text-white shadow-lg hover:shadow-xl"
              }`}
              data-test-id="login-submit"
            >
              {loading ? "Signing in..." : "Sign In"}
            </button>
          </form>

          {/* Signup Link */}
          <div className="text-center mt-6 text-sm text-gray-600">
            Don't have an account?{" "}
            <Link
              to="/signup-for-trial"
              className="text-sapphire-600 hover:underline font-medium"
              data-test-id="signup-link"
            >
              Start your FREE trial
            </Link>
          </div>
        </div>
      </div>
    </div>
  );
};

export default Login;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\auth\PendingApproval.jsx 
====================================================== 
 
// src/pages/auth/PendingApproval.jsx
import React, { useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { Clock } from "lucide-react";
import { toast } from "react-toastify";

export default function PendingApproval() {
  const navigate = useNavigate();

  useEffect(() => {
    const hasSeen = sessionStorage.getItem("seen-pending-toast");
    if (!hasSeen) {
      toast.info(
        "‚è≥ Your business is still under review. Please wait for admin approval."
      );
      sessionStorage.setItem("seen-pending-toast", "true");
    }
  }, []);

  return (
    <div className="min-h-screen flex items-center justify-center bg-purple-50 px-4">
      <div className="bg-white max-w-md w-full p-8 rounded-2xl shadow-xl text-center">
        <div className="bg-purple-100 text-purple-700 inline-block p-4 rounded-full mb-4">
          <Clock size={40} />
        </div>
        <h2 className="text-2xl font-bold text-purple-800 mb-2">
          Business Approval Pending
        </h2>
        <p className="text-sm text-gray-700 mb-4">
          Your account has been created successfully, but your business profile
          is under review. You will be notified once it is approved.
        </p>
        <button
          onClick={() => navigate("/login")}
          className="mt-4 bg-purple-600 text-white px-5 py-2 rounded-lg hover:bg-purple-700 transition"
        >
          üîô Back to Login
        </button>
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\auth\SignupForTrial.jsx 
====================================================== 
 
import React, { useState } from "react";
import { useNavigate, Link } from "react-router-dom";
import { toast } from "react-toastify";
import {
  Eye,
  EyeOff,
  CheckCircle,
  Gift,
  MessageCircle,
  Megaphone,
  Shield,
  ArrowRight,
  Star,
} from "lucide-react";
import TypewriterHeadline from "../../components/TypewriterHeadline";

const SignupForTrial = () => {
  const navigate = useNavigate();

  const [formData, setFormData] = useState({
    fullName: "",
    companyName: "",
    country: "India",
    state: "",
    companySize: "",
    industry: "",
    mobileNumber: "",
    email: "",
    password: "",
    confirmPassword: "",
  });

  const [showPassword, setShowPassword] = useState(false);
  const [showConfirmPassword, setShowConfirmPassword] = useState(false);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [acceptTerms, setAcceptTerms] = useState(false);

  const handleInputChange = e => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: value,
    }));
  };

  const handleSubmit = async e => {
    e.preventDefault();
    setError("");
    setLoading(true);

    // Basic validation
    if (formData.password !== formData.confirmPassword) {
      setError("Passwords do not match");
      setLoading(false);
      return;
    }

    if (formData.password.length < 8) {
      setError("Password must be at least 8 characters long");
      setLoading(false);
      return;
    }

    try {
      // TODO: Implement actual signup API call
      console.log("Signup data:", formData);

      // Simulate API call
      await new Promise(resolve => setTimeout(resolve, 2000));

      toast.success("üéâ Account created successfully! Welcome to XploreByte!");
      navigate("/login");
    } catch (err) {
      const message =
        err?.response?.data?.message ||
        err?.message ||
        "‚ùå Signup failed. Please try again.";
      toast.error(message);
      setError(message);
    } finally {
      setLoading(false);
    }
  };

  const isFormValid =
    formData.fullName &&
    formData.companyName &&
    formData.email &&
    formData.password &&
    formData.confirmPassword &&
    formData.password === formData.confirmPassword &&
    acceptTerms;

  return (
    <div className="min-h-screen bg-gradient-to-br from-emerald-50 to-cyan-50 flex items-center justify-center px-4 py-4">
      <div className="flex flex-col lg:flex-row w-full max-w-6xl shadow-2xl rounded-2xl overflow-hidden bg-white">
        {/* Left Section - Marketing Panel */}
        <div className="lg:w-1/2 bg-gradient-to-br from-emerald-50 to-cyan-50 p-6 lg:p-8 flex flex-col justify-center overflow-hidden">
          {/* Logo */}
          <div className="mb-6">
            <div className="flex items-center space-x-3">
              <img
                src="/logo/logo.svg"
                alt="XploreByte Logo"
                className="w-8 h-8 rounded-lg shadow-sm"
              />
              <span className="text-xl font-bold text-gray-900">
                XploreByte
              </span>
            </div>
          </div>

          {/* Main Headline */}
          <div className="mb-6 overflow-hidden">
            <div className="w-full">
              <TypewriterHeadline
                phrases={[
                  "WhatsApp Marketing",
                  "WhatsApp Automation",
                  "No-code chatbot builder",
                  "Auto Reply",
                ]}
                baseText="Transform your business with "
                className="text-2xl lg:text-3xl font-bold text-gray-900 mb-3"
              />
            </div>
          </div>

          {/* Promotional Offer */}
          <div className="bg-gradient-to-r from-emerald-600 to-sapphire-600 rounded-xl p-4 mb-6 text-white">
            <div className="flex items-center space-x-2 mb-2">
              <Gift className="w-5 h-5" />
              <span className="text-lg font-bold">1 Month FREE Trial</span>
            </div>
            <p className="text-emerald-100 text-sm">
              Start your WhatsApp Business journey with our XploreByte platform
            </p>
          </div>

          {/* Features Section */}
          <div className="mb-6">
            <h3 className="text-lg font-bold text-gray-900 mb-4">
              YOUR FREE TRIAL INCLUDES
            </h3>
            <div className="space-y-3">
              {/* Feature 1 */}
              <div className="bg-white rounded-lg p-3 shadow-sm border border-gray-100">
                <div className="flex items-start space-x-3">
                  <div className="w-8 h-8 bg-emerald-100 rounded-lg flex items-center justify-center flex-shrink-0">
                    <MessageCircle className="w-4 h-4 text-emerald-600" />
                  </div>
                  <div>
                    <h4 className="font-semibold text-gray-900 text-sm">
                      FREE WhatsApp Business API
                    </h4>
                    <p className="text-xs text-gray-600">
                      Instant verification & setup with Meta
                    </p>
                  </div>
                </div>
              </div>

              {/* Feature 2 */}
              <div className="bg-white rounded-lg p-3 shadow-sm border border-gray-100">
                <div className="flex items-start space-x-3">
                  <div className="w-8 h-8 bg-cyan-100 rounded-lg flex items-center justify-center flex-shrink-0">
                    <Megaphone className="w-4 h-4 text-cyan-600" />
                  </div>
                  <div>
                    <h4 className="font-semibold text-gray-900 text-sm">
                      Advanced AI Campaign Manager
                    </h4>
                    <p className="text-xs text-gray-600">
                      AI-powered campaign optimization & targeting
                    </p>
                  </div>
                </div>
              </div>

              {/* Feature 3 */}
              <div className="bg-white rounded-lg p-3 shadow-sm border border-gray-100">
                <div className="flex items-start space-x-3">
                  <div className="w-8 h-8 bg-sapphire-100 rounded-lg flex items-center justify-center flex-shrink-0">
                    <Shield className="w-4 h-4 text-sapphire-600" />
                  </div>
                  <div>
                    <h4 className="font-semibold text-gray-900 text-sm">
                      FREE Verification Application
                    </h4>
                    <p className="text-xs text-gray-600">
                      Apply for verified WhatsApp Business Account
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Social Proof */}
          <div className="mt-auto">
            <p className="text-xs text-gray-600 mb-3">
              Trusted by 10,000+ Brands
            </p>
            <div className="flex items-center space-x-4 opacity-60">
              <div className="text-xs font-semibold text-gray-500">
                PhysicsWallah
              </div>
              <div className="text-xs font-semibold text-gray-500">
                Rentomojo
              </div>
              <div className="text-xs font-semibold text-gray-500">
                Skullcandy
              </div>
              <div className="text-xs font-semibold text-gray-500">Vivo</div>
            </div>
          </div>
        </div>

        {/* Right Section - Signup Form */}
        <div className="lg:w-1/2 bg-white p-6 lg:p-8 flex flex-col justify-center">
          {/* Top Navigation */}
          <div className="flex justify-end mb-6">
            <Link
              to="/login"
              className="text-sm text-gray-600 hover:text-sapphire-600 transition"
            >
              Already a member?{" "}
              <span className="text-sapphire-600 font-medium">Log in</span>
            </Link>
          </div>

          {/* Form Title */}
          <div className="mb-6">
            <h2 className="text-2xl font-bold text-gray-900 mb-1">
              Create Your XploreByte Account
            </h2>
            <p className="text-gray-600 text-sm">
              Start your 1-month free trial today
            </p>
          </div>

          {/* Error Display */}
          {error && (
            <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6 text-sm text-red-700">
              {error}
            </div>
          )}

          {/* Signup Form */}
          <form onSubmit={handleSubmit} className="space-y-3">
            {/* Personal Information Section */}

            {/* Full Name and Company Name Row */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Full Name *
                </label>
                <input
                  type="text"
                  name="fullName"
                  value={formData.fullName}
                  onChange={handleInputChange}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition text-sm"
                  placeholder="Enter your full name"
                  required
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Company Name *
                </label>
                <input
                  type="text"
                  name="companyName"
                  value={formData.companyName}
                  onChange={handleInputChange}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition text-sm"
                  placeholder="Enter your company name"
                  required
                />
              </div>
            </div>

            {/* Country and State Row */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Country *
                </label>
                <select
                  name="country"
                  value={formData.country}
                  onChange={handleInputChange}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition text-sm"
                  required
                >
                  <option value="India">India</option>
                  <option value="United States">United States</option>
                  <option value="United Kingdom">United Kingdom</option>
                  <option value="Canada">Canada</option>
                  <option value="Australia">Australia</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  State
                </label>
                <select
                  name="state"
                  value={formData.state}
                  onChange={handleInputChange}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition text-sm"
                >
                  <option value="">Select State</option>
                  <option value="Maharashtra">Maharashtra</option>
                  <option value="Karnataka">Karnataka</option>
                  <option value="Tamil Nadu">Tamil Nadu</option>
                  <option value="Delhi">Delhi</option>
                  <option value="Gujarat">Gujarat</option>
                </select>
              </div>
            </div>

            {/* Company Size and Industry Row */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Company Size
                </label>
                <select
                  name="companySize"
                  value={formData.companySize}
                  onChange={handleInputChange}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition text-sm"
                >
                  <option value="">Select Size</option>
                  <option value="1-10">1-10 employees</option>
                  <option value="11-50">11-50 employees</option>
                  <option value="51-200">51-200 employees</option>
                  <option value="201-500">201-500 employees</option>
                  <option value="500+">500+ employees</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Industry
                </label>
                <select
                  name="industry"
                  value={formData.industry}
                  onChange={handleInputChange}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition text-sm"
                >
                  <option value="">Select Industry</option>
                  <option value="E-commerce">E-commerce</option>
                  <option value="Healthcare">Healthcare</option>
                  <option value="Education">Education</option>
                  <option value="Finance">Finance</option>
                  <option value="Technology">Technology</option>
                  <option value="Retail">Retail</option>
                  <option value="Other">Other</option>
                </select>
              </div>
            </div>

            {/* Mobile Number */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Mobile Number
              </label>
              <div className="flex space-x-1">
                <select
                  name="countryCode"
                  className="px-2 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition text-sm"
                >
                  <option value="+91">IN +91</option>
                  <option value="+1">US +1</option>
                  <option value="+44">UK +44</option>
                  <option value="+61">AU +61</option>
                </select>
                <input
                  type="tel"
                  name="mobileNumber"
                  value={formData.mobileNumber}
                  onChange={handleInputChange}
                  className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition text-sm"
                  placeholder="Enter mobile number"
                />
              </div>
            </div>

            {/* Email Address */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Email Address *
              </label>
              <input
                type="email"
                name="email"
                value={formData.email}
                onChange={handleInputChange}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition text-sm"
                placeholder="Enter your email address"
                required
              />
            </div>

            {/* Password and Confirm Password Row */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Password *
                </label>
                <div className="relative">
                  <input
                    type={showPassword ? "text" : "password"}
                    name="password"
                    value={formData.password}
                    onChange={handleInputChange}
                    className="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition text-sm"
                    placeholder="Create a strong password"
                    required
                  />
                  <button
                    type="button"
                    onClick={() => setShowPassword(!showPassword)}
                    className="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
                  >
                    {showPassword ? (
                      <EyeOff className="w-4 h-4" />
                    ) : (
                      <Eye className="w-4 h-4" />
                    )}
                  </button>
                </div>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Confirm Password *
                </label>
                <div className="relative">
                  <input
                    type={showConfirmPassword ? "text" : "password"}
                    name="confirmPassword"
                    value={formData.confirmPassword}
                    onChange={handleInputChange}
                    className="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition text-sm"
                    placeholder="Confirm your password"
                    required
                  />
                  <button
                    type="button"
                    onClick={() => setShowConfirmPassword(!showConfirmPassword)}
                    className="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
                  >
                    {showConfirmPassword ? (
                      <EyeOff className="w-4 h-4" />
                    ) : (
                      <Eye className="w-4 h-4" />
                    )}
                  </button>
                </div>
              </div>
            </div>

            {/* Terms and Conditions Checkbox */}
            <div className="flex items-start space-x-3 mt-3">
              <div className="flex items-center h-5">
                <input
                  id="accept-terms"
                  name="acceptTerms"
                  type="checkbox"
                  checked={acceptTerms}
                  onChange={e => setAcceptTerms(e.target.checked)}
                  className="w-4 h-4 text-emerald-600 bg-gray-100 border-gray-300 rounded focus:ring-emerald-500 focus:ring-2"
                  required
                />
              </div>
              <div className="text-sm">
                <label htmlFor="accept-terms" className="text-gray-700">
                  I agree to the{" "}
                  <Link
                    to="/terms"
                    className="text-sapphire-600 hover:underline font-medium"
                  >
                    Terms of Service
                  </Link>{" "}
                  and{" "}
                  <Link
                    to="/privacy"
                    className="text-sapphire-600 hover:underline font-medium"
                  >
                    Privacy Policy
                  </Link>
                </label>
              </div>
            </div>

            {/* Submit Button */}
            <button
              type="submit"
              disabled={!isFormValid || loading}
              className={`w-full py-3 px-6 rounded-lg font-semibold text-base transition-all duration-200 flex items-center justify-center space-x-2 ${
                isFormValid && !loading
                  ? "bg-gradient-to-r from-emerald-600 to-sapphire-600 hover:from-emerald-700 hover:to-sapphire-700 text-white shadow-lg hover:shadow-xl transform hover:scale-105"
                  : "bg-gray-300 text-gray-500 cursor-not-allowed"
              }`}
            >
              {loading ? (
                <>
                  <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                  <span>Creating Account...</span>
                </>
              ) : (
                <>
                  <span>Start Your FREE Trial</span>
                  <ArrowRight className="w-4 h-4" />
                </>
              )}
            </button>
          </form>
        </div>
      </div>
    </div>
  );
};

export default SignupForTrial;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\auth\context\AuthContextReadyForrefactor.jsx 
====================================================== 
 
// src/context/AuthContext.jsx
import React, {
  createContext,
  useContext,
  useEffect,
  useState,
  useCallback,
} from "react";
import { getAuthFromToken } from "../../utils/authUtils";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";

const AuthContext = createContext(null);

export const AuthProvider = ({ children }) => {
  const [auth, setAuth] = useState(() => {
    const initial = getAuthFromToken();
    return {
      ...initial,
      permissions: new Set(initial?.permissions || []), // always Set
    };
  });

  // üîÑ Refresh permissions from backend
  const fetchPermissions = useCallback(async () => {
    try {
      const { data } = await axiosClient.get("/plan/me/permissions");
      if (data?.permissions?.length) {
        setAuth(prev => ({
          ...prev,
          permissions: new Set(data.permissions),
        }));
      }
    } catch (err) {
      console.warn("‚ö†Ô∏è Could not fetch permissions", err);
      toast.error("Failed to load permissions");
    }
  }, []);

  // Load once at mount
  useEffect(() => {
    fetchPermissions();
  }, [fetchPermissions]);

  const hasPermission = useCallback(
    perm => auth.permissions?.has("*") || auth.permissions?.has(perm),
    [auth.permissions]
  );

  const value = {
    auth,
    setAuth,
    hasPermission,
    hasAllAccess: auth.permissions?.has("*"),
    refreshPermissions: fetchPermissions,
  };

  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
};

export const useAuth = () => {
  const ctx = useContext(AuthContext);
  if (!ctx) throw new Error("useAuth must be used within AuthProvider");
  return ctx;
};
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\auth\context\pld_AuthContext.jsx 
====================================================== 
 
// src/app/providers/AuthProvider.jsx
import {
  createContext,
  useContext,
  useState,
  useEffect,
  useMemo,
  useCallback,
} from "react";
import axiosClient from "../../../api/axiosClient";
import { getAuthFromToken } from "../../../utils/jwt";

// === In-memory BusinessId for axiosClient (no localStorage authority) ===
let __activeBusinessId = null;
export function getActiveBusinessId() {
  return __activeBusinessId;
}

const AuthContext = createContext(null);

export function AuthProvider({ children }) {
  const [role, setRole] = useState("");
  const [planId, setPlanId] = useState(null);
  const [businessId, setBusinessId] = useState(null);
  const [userName, setUserName] = useState("User");
  const [isLoading, setIsLoading] = useState(true);

  // Server-authoritative permissions (["*"] means all)
  const [perms, setPerms] = useState([]);

  const hasAllAccess = useMemo(
    () => perms.includes("*") || role?.toLowerCase() === "superadmin",
    [perms, role]
  );
  const isAuthenticated = useMemo(() => !!role, [role]);

  const clearAuthData = () => {
    setRole("");
    setPlanId(null);
    setBusinessId(null);
    setUserName("User");
    setPerms([]);
    __activeBusinessId = null;
  };

  const can = useCallback(
    code => (hasAllAccess ? true : perms.includes(code)),
    [perms, hasAllAccess]
  );

  const loadSession = useCallback(async () => {
    setIsLoading(true);
    try {
      // 1) Validate token locally (expiry etc.)
      const auth = getAuthFromToken();
      if (!auth.isAuth) {
        clearAuthData();
        return;
      }

      // Provisional values from token (useful if /api/me is momentarily slow)
      setRole(auth.role || "");
      setPlanId(auth.planId || null);
      setUserName(auth.name || "User");

      // 2) Server-authoritative hydration
      //    /api/me returns: { ok, user:{id,name}, businessId, permissions }
      const { data } = await axiosClient.get("/me"); // baseURL already has /api
      if (data?.ok !== false) {
        const srvPerms = Array.isArray(data?.permissions)
          ? data.permissions
          : [];
        const srvBizId = data?.businessId || auth.businessId || null;

        setPerms(srvPerms);
        setBusinessId(srvBizId);
        __activeBusinessId = srvBizId; // <- expose to axios interceptor
      } else {
        // If server returns envelope with ok:false, keep minimal client values
        setPerms([]);
        setBusinessId(auth.businessId || null);
        __activeBusinessId = auth.businessId || null;
      }
    } catch (err) {
      // On failure, fall back to token-only (still avoids localStorage)
      console.warn("[Auth] /api/me failed; using token-only:", err?.message);
      const auth = getAuthFromToken();
      if (!auth.isAuth) {
        clearAuthData();
      } else {
        setRole(auth.role || "");
        setPlanId(auth.planId || null);
        setUserName(auth.name || "User");
        setBusinessId(auth.businessId || null);
        __activeBusinessId = auth.businessId || null;
        // No server perms ‚Üí safest default is empty array (blocked pages) or ["*"] for dev
        // Choose based on your stage:
        setPerms(["*"]); // ‚Üê DEV FRIENDLY. Change to [] in production if needed.
      }
    } finally {
      setIsLoading(false);
    }
  }, []);

  useEffect(() => {
    loadSession();
  }, [loadSession]);

  const refreshAuthContext = async () => {
    await loadSession();
  };

  const value = {
    role,
    planId,
    businessId,
    userName,
    isAuthenticated,
    isLoading,
    hasAllAccess,
    can,
    refreshAuthContext,
    clearAuthData,
  };

  return (
    <AuthContext.Provider value={value}>
      {isLoading ? (
        <div className="min-h-screen flex items-center justify-center text-emerald-700 font-semibold text-lg">
          üîê Authenticating‚Ä¶
        </div>
      ) : (
        children
      )}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  const ctx = useContext(AuthContext);
  if (!ctx) throw new Error("useAuth must be used inside an AuthProvider");
  return ctx;
}

// // src/app/providers/AuthProvider.jsx
// import {
//   createContext,
//   useContext,
//   useState,
//   useEffect,
//   useMemo,
//   useCallback,
// } from "react";
// import axiosClient from "../../../api/axiosClient";
// // import { getAuthFromToken } from "../../utils/jwt";
// import { getAuthFromToken } from "../../../utils/jwt";

// const AuthContext = createContext(null);

// export function AuthProvider({ children }) {
//   const [role, setRole] = useState("");
//   const [planId, setPlanId] = useState(null);
//   const [businessId, setBusinessId] = useState(null);
//   const [userName, setUserName] = useState("User");
//   const [isLoading, setIsLoading] = useState(true);

//   // authoritative permissions from server (array of strings) or ["*"]
//   const [perms, setPerms] = useState([]);

//   const hasAllAccess = useMemo(
//     () => perms.includes("*") || role === "superadmin",
//     [perms, role]
//   );
//   const isAuthenticated = useMemo(() => !!role, [role]);

//   const clearAuthData = () => {
//     setRole("");
//     setPlanId(null);
//     setBusinessId(null);
//     setUserName("User");
//     setPerms([]);
//   };

//   const can = useCallback(
//     code => (hasAllAccess ? true : perms.includes(code)),
//     [perms, hasAllAccess]
//   );

//   const loadSession = useCallback(async () => {
//     setIsLoading(true);
//     try {
//       const auth = getAuthFromToken(); // reads JWT; enforces exp
//       if (!auth.isAuth) {
//         clearAuthData();
//         return;
//       }
//       setRole(auth.role);
//       setPlanId(auth.planId || null);
//       setBusinessId(auth.businessId || null);
//       setUserName(auth.name || "User");

//       // pull permissions from server (authoritative)
//       const { data } = await axiosClient.get("/plan/me/permissions"); // returns string[] or ["*"]
//       setPerms(Array.isArray(data) ? data : []);
//     } catch (err) {
//       console.warn("[Auth] loadSession failed:", err?.message);
//       clearAuthData();
//     } finally {
//       setIsLoading(false);
//     }
//   }, []);

//   useEffect(() => {
//     loadSession();
//   }, [loadSession]);

//   const refreshAuthContext = async () => {
//     await loadSession();
//   };

//   const value = {
//     role,
//     planId,
//     businessId,
//     userName,
//     isAuthenticated,
//     isLoading,
//     hasAllAccess,
//     can,
//     refreshAuthContext,
//     clearAuthData,
//   };

//   return (
//     <AuthContext.Provider value={value}>
//       {isLoading ? (
//         <div className="min-h-screen flex items-center justify-center text-purple-700 font-semibold text-lg">
//           üîê Authenticating...
//         </div>
//       ) : (
//         children
//       )}
//     </AuthContext.Provider>
//   );
// }

// export function useAuth() {
//   const ctx = useContext(AuthContext);
//   if (!ctx) throw new Error("useAuth must be used inside an AuthProvider");
//   return ctx;
// }

// // üìÑ src/pages/auth/context/AuthContext.jsx
// import {
//   createContext,
//   useContext,
//   useState,
//   useEffect,
//   useMemo,
//   useCallback,
// } from "react";
// import axiosClient, { TOKEN_KEY } from "../../../api/axiosClient";
// import { getAuthFromToken } from "../../../utils/jwt";

// const AuthContext = createContext(null);

// export function AuthProvider({ children }) {
//   const [role, setRole] = useState("");
//   const [planId, setPlanId] = useState(null);
//   const [businessId, setBusinessId] = useState(null);
//   const [userName, setUserName] = useState("User");
//   const [isLoading, setIsLoading] = useState(true);

//   // permissions map for UX (server is still the source of truth)
//   const [availableFeatures, setAvailableFeatures] = useState({}); // { "messages.send": true }
//   const [hasAllAccess, setHasAllAccess] = useState(false); // wildcard for admins

//   const isAuthenticated = useMemo(() => !!role, [role]);

//   const clearAuthData = () => {
//     // remove token to avoid stuck loops with a bad token
//     try {
//       localStorage.removeItem(TOKEN_KEY);
//     } catch {}
//     setRole("");
//     setPlanId(null);
//     setBusinessId(null);
//     setUserName("User");
//     setAvailableFeatures({});
//     setHasAllAccess(false);
//   };

//   const loadSession = useCallback(async () => {
//     setIsLoading(true);
//     try {
//       // 1) Read from JWT (just enough to know who we are)
//       const auth = getAuthFromToken();
//       if (!auth.isAuth) {
//         clearAuthData();
//         return;
//       }

//       setRole(auth.role);
//       setPlanId(auth.planId ?? null); // <-- expects 'plan_id' in JWT
//       setBusinessId(auth.businessId ?? null);
//       setUserName(auth.name || "User");

//       // 2) Admin bypass (wildcard, no FE enumeration)
//       if (auth.role === "superadmin" || auth.role === "admin") {
//         setHasAllAccess(true);
//         return;
//       }

//       // 3) Fetch authoritative permissions from backend
//       const { data } = await axiosClient.get("/plan/me/permissions");
//       // expected: { planId: "...", permissions: ["messages.send", ...] } or ["*"]
//       const codes = Array.isArray(data?.permissions) ? data.permissions : [];

//       if (codes.includes("*")) {
//         setHasAllAccess(true);
//         return;
//       }

//       const map = {};
//       codes.forEach(code => {
//         map[code] = true;
//       });
//       setAvailableFeatures(map);
//     } catch (err) {
//       console.warn("‚ùå [Auth] loadSession failed:", err?.message);
//       clearAuthData();
//     } finally {
//       setIsLoading(false);
//     }
//   }, []);

//   useEffect(() => {
//     loadSession();
//   }, [loadSession]);

//   const refreshAuthContext = async () => {
//     await loadSession();
//   };

//   // single helper for UI checks; backend still enforces on endpoints
//   const can = useCallback(
//     code => {
//       return hasAllAccess || !!availableFeatures[code];
//     },
//     [hasAllAccess, availableFeatures]
//   );

//   return (
//     <AuthContext.Provider
//       value={{
//         role,
//         planId,
//         businessId,
//         userName,
//         availableFeatures,
//         hasAllAccess,
//         can,
//         isAuthenticated,
//         isLoading,
//         refreshAuthContext,
//         clearAuthData,
//         // setRole kept for dev tools if you want
//         setRole,
//       }}
//     >
//       {isLoading ? (
//         <div className="min-h-screen flex items-center justify-center text-purple-700 font-semibold text-lg">
//           üîê Authenticating...
//         </div>
//       ) : (
//         children
//       )}
//     </AuthContext.Provider>
//   );
// }

// export function useAuth() {
//   const ctx = useContext(AuthContext);
//   if (!ctx) throw new Error("useAuth must be used inside an AuthProvider");
//   return ctx;
// }

// Below code we have comented for harden teh security
// // üìÑ src/pages/auth/context/AuthContext.jsx
// import {
//   createContext,
//   useContext,
//   useState,
//   useEffect,
//   useMemo,
//   useCallback,
// } from "react";
// import axiosClient from "../../../api/axiosClient";

// import { getAuthFromToken } from "../../../utils/jwt";
// import { FEATURE_KEYS as featureKeys } from "../../../components/FeatureAccess/featureKeyConfig";

// const AuthContext = createContext(null);

// export function AuthProvider({ children }) {
//   const [role, setRole] = useState("");
//   const [plan, setPlan] = useState("");
//   const [businessId, setBusinessId] = useState(null);
//   const [userName, setUserName] = useState("User");
//   const [isLoading, setIsLoading] = useState(true);
//   const [availableFeatures, setAvailableFeatures] = useState({});

//   const isAuthenticated = useMemo(() => !!role, [role]);

//   const clearAuthData = () => {
//     setRole("");
//     setPlan("");
//     setBusinessId(null);
//     setAvailableFeatures({});
//   };

//   const loadSession = useCallback(async () => {
//     setIsLoading(true);
//     try {
//       // 1) Read from JWT (source of truth on client)
//       const auth = getAuthFromToken();
//       if (!auth.isAuth) {
//         clearAuthData();
//         return;
//       }
//       setRole(auth.role);
//       setPlan(auth.plan);
//       setBusinessId(auth.businessId);
//       setUserName(auth.name);

//       // 2) Superadmin: grant all
//       if (auth.role === "superadmin") {
//         const all = {};
//         Object.values(featureKeys).forEach(k => (all[k] = true));
//         setAvailableFeatures(all);
//         return;
//       }

//       // 3) Fetch feature map from API (Bearer via axiosClient)
//       const { data } = await axiosClient.get("/feature-access/me");
//       const map = {};
//       (data || []).forEach(f => {
//         const allowed = f.isOverridden ?? f.isAvailableInPlan;
//         map[f.featureCode] = allowed;
//       });
//       setAvailableFeatures(map);
//     } catch (err) {
//       console.warn("‚ùå [Auth] loadSession failed:", err?.message);
//       clearAuthData();
//     } finally {
//       setIsLoading(false);
//     }
//   }, []);

//   useEffect(() => {
//     loadSession();
//   }, [loadSession]);

//   const refreshAuthContext = async () => {
//     await loadSession();
//   };

//   return (
//     <AuthContext.Provider
//       value={{
//         role,
//         plan,
//         businessId,
//         userName,
//         availableFeatures,
//         isAuthenticated,
//         isLoading,
//         refreshAuthContext,
//         clearAuthData,
//         setRole, // dev helpers
//       }}
//     >
//       {isLoading ? (
//         <div className="min-h-screen flex items-center justify-center text-purple-700 font-semibold text-lg">
//           üîê Authenticating...
//         </div>
//       ) : (
//         children
//       )}
//     </AuthContext.Provider>
//   );
// }

// export function useAuth() {
//   const ctx = useContext(AuthContext);
//   if (!ctx) throw new Error("useAuth must be used inside an AuthProvider");
//   return ctx;
// }

// import {
//   createContext,
//   useContext,
//   useState,
//   useEffect,
//   useMemo,
//   useCallback,
// } from "react";
// import axios from "axios";
// import { FEATURE_KEYS as featureKeys } from "../../../components/FeatureAccess/featureKeyConfig";

// const AuthContext = createContext(null);

// export function AuthProvider({ children }) {
//   const [role, setRole] = useState("");
//   const [businessId, setBusinessId] = useState(null);
//   const [isLoading, setIsLoading] = useState(true);
//   const [availableFeatures, setAvailableFeatures] = useState({});

//   const isAuthenticated = useMemo(() => !!role, [role]);

//   const clearAuthData = () => {
//     setRole("");
//     setBusinessId(null);
//     setAvailableFeatures({});
//     console.log("üßπ [Auth] Auth data cleared.");
//   };

//   // ‚úÖ Wrap loadSession in useCallback to avoid linter warning
//   const loadSession = useCallback(async () => {
//     setIsLoading(true);
//     try {
//       const { data: session } = await axios.get("/api/auth/session", {
//         withCredentials: true,
//       });

//       const { role: rawRole, businessId: sessionBusinessId } = session;

//       const safeRole = (rawRole || "").toLowerCase();
//       setRole(safeRole);
//       setBusinessId(sessionBusinessId || null);

//       if (safeRole === "superadmin") {
//         // üü¢ Enable all features for superadmin
//         const all = {};
//         Object.values(featureKeys).forEach(key => {
//           all[key] = true;
//         });
//         setAvailableFeatures(all);
//       } else {
//         // ‚úÖ Business user: Fetch plan + override aware feature list
//         const { data } = await axios.get("/api/feature-access/me", {
//           withCredentials: true,
//         });

//         const map = {};
//         (data || []).forEach(f => {
//           const isAllowed = f.isOverridden ?? f.isAvailableInPlan;
//           map[f.featureCode] = isAllowed;
//         });
//         console.log("‚úÖ [Available Features]", map);
//         setAvailableFeatures(map);
//       }
//     } catch (error) {
//       console.warn("‚ùå [Auth] Session failed:", error?.message);
//       clearAuthData();
//     } finally {
//       setIsLoading(false);
//     }
//   }, []); // üëà NO dependencies needed here

//   useEffect(() => {
//     loadSession();
//   }, [loadSession]); // üëà Dependency fixed

//   const refreshAuthContext = async () => {
//     console.log("üîÅ [Auth] Manual refresh triggered...");
//     await loadSession();
//   };

//   useEffect(() => {
//     console.log("üîî [Auth State]", {
//       role,
//       businessId,
//       isAuthenticated,
//       availableFeatures,
//     });
//   }, [role, businessId, isAuthenticated, availableFeatures]);

//   return (
//     <AuthContext.Provider
//       value={{
//         role,
//         businessId,
//         availableFeatures,
//         isAuthenticated,
//         isLoading,
//         refreshAuthContext,
//         clearAuthData,
//         setRole,
//       }}
//     >
//       {isLoading ? (
//         <div className="min-h-screen flex items-center justify-center text-purple-700 font-semibold text-lg">
//           üîê Authenticating...
//         </div>
//       ) : (
//         children
//       )}
//     </AuthContext.Provider>
//   );
// }

// export function useAuth() {
//   const context = useContext(AuthContext);
//   if (!context) {
//     throw new Error("useAuth must be used inside an AuthProvider");
//   }
//   return context;
// }

// import { createContext, useContext, useState, useEffect, useMemo } from "react";
// import axios from "axios";
// import { FEATURE_KEYS as featureKeys } from "../../../components/FeatureAccess/featureKeyConfig";

// const AuthContext = createContext(null);

// export function AuthProvider({ children }) {
//   const [role, setRole] = useState("");
//   const [businessId, setBusinessId] = useState(null);
//   const [isLoading, setIsLoading] = useState(true);
//   const [availableFeatures, setAvailableFeatures] = useState({});

//   const isAuthenticated = useMemo(() => !!role, [role]);

//   const clearAuthData = () => {
//     setRole("");
//     setBusinessId(null);
//     setAvailableFeatures({});
//     console.log("üßπ [Auth] Auth data cleared.");
//   };

//   const loadSession = async () => {
//     setIsLoading(true);
//     try {
//       const { data: session } = await axios.get("/api/auth/session", {
//         withCredentials: true,
//       });

//       const { role: rawRole, businessId: sessionBusinessId } = session;

//       const safeRole = (rawRole || "").toLowerCase();
//       setRole(safeRole);
//       setBusinessId(sessionBusinessId || null);

//       if (safeRole === "superadmin") {
//         // üü¢ Enable all features for superadmin
//         const all = {};
//         // featureKeys.forEach(key => (all[key] = true));
//         Object.values(featureKeys).forEach(key => {
//           all[key] = true;
//         });

//         setAvailableFeatures(all);
//       } else {
//         // ‚úÖ Business user: Fetch plan + override aware feature list
//         const { data } = await axios.get("/api/feature-access/me", {
//           withCredentials: true,
//         });

//         const map = {};
//         (data || []).forEach(f => {
//           const isAllowed = f.isOverridden ?? f.isAvailableInPlan;
//           map[f.featureCode] = isAllowed;
//         });
//         console.log("‚úÖ [Available Features]", map);
//         setAvailableFeatures(map);
//       }
//     } catch (error) {
//       console.warn("‚ùå [Auth] Session failed:", error?.message);
//       clearAuthData();
//     } finally {
//       setIsLoading(false);
//     }
//   };

//   useEffect(() => {
//     loadSession();
//   }, []);

//   const refreshAuthContext = async () => {
//     console.log("üîÅ [Auth] Manual refresh triggered...");
//     await loadSession();
//   };

//   useEffect(() => {
//     console.log("üîî [Auth State]", {
//       role,
//       businessId,
//       isAuthenticated,
//       availableFeatures,
//     });
//   }, [role, businessId, isAuthenticated, availableFeatures]);

//   return (
//     <AuthContext.Provider
//       value={{
//         role,
//         businessId,
//         availableFeatures,
//         isAuthenticated,
//         isLoading,
//         refreshAuthContext,
//         clearAuthData,
//         setRole,
//       }}
//     >
//       {isLoading ? (
//         <div className="min-h-screen flex items-center justify-center text-purple-700 font-semibold text-lg">
//           üîê Authenticating...
//         </div>
//       ) : (
//         children
//       )}
//     </AuthContext.Provider>
//   );
// }

// export function useAuth() {
//   const context = useContext(AuthContext);
//   if (!context) {
//     throw new Error("useAuth must be used inside an AuthProvider");
//   }
//   return context;
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\auth\hooks\RequireFeature.jsx 
====================================================== 
 
import React from "react";
import { useFeatureAccess } from "./useFeatureAccess";
import { usePlan } from "./usePlan";

// üîê Wrapper to conditionally show children if feature allowed
export default function RequireFeature({ name, children }) {
  const isFeatureAllowed = useFeatureAccess(name);
  const { hasPlan } = usePlan();

  // üß† Runtime logic:
  // 1. If featureAccess table allows ‚Üí ‚úÖ show
  // 2. Else ‚Üí check plan fallback (optional)
  const isAllowed =
    isFeatureAllowed ||
    (name === "CRM" && hasPlan("Basic")) ||
    (name === "Campaigns" && hasPlan("Smart")) ||
    (name === "Catalog" && hasPlan("Advanced"));

  if (!isAllowed) return null;

  return <>{children}</>;
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\auth\hooks\useAllFeatureAccess.js 
====================================================== 
 
import { useEffect, useState } from "react";
import axiosClient from "../../../api/axiosClient";

const featureMapCache = {};

export function useAllFeatureAccess(businessId) {
  const [featureMap, setFeatureMap] = useState({});
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!businessId) return;

    if (featureMapCache[businessId]) {
      setFeatureMap(featureMapCache[businessId]);
      setLoading(false);
      return;
    }

    const fetchAll = async () => {
      try {
        const response = await axiosClient.get(
          `/api/feature-access/business/${businessId}`
        );
        const accessList = response.data || [];

        const map = {};
        for (const item of accessList) {
          map[item.featureName] = item.isEnabled;
        }

        featureMapCache[businessId] = map;
        setFeatureMap(map);
      } catch (err) {
        console.error("Failed to fetch feature access list:", err);
        setFeatureMap({});
      } finally {
        setLoading(false);
      }
    };

    fetchAll();
  }, [businessId]);

  return { featureMap, loading };
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\auth\hooks\useBusinessId.js 
====================================================== 
 
// üìÑ src/auth/hooks/useBusinessId.js
import { useAuth } from "../../pages/auth/context/AuthContext";
export function useBusinessId() {
  const { businessId } = useAuth();
  return businessId || "";
}

// // src/auth/hooks/useBusinessId.js

// import { jwtDecode } from "jwt-decode";

// export function useBusinessId() {
//   const token = localStorage.getItem("xbytechat-token");

//   if (!token) return "";

//   try {
//     const decoded = jwtDecode(token);
//     return decoded.businessId || "";
//   } catch (err) {
//     console.error("‚ùå Failed to decode businessId from token:", err);
//     return "";
//   }
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\auth\hooks\useCompanyName.js 
====================================================== 
 
// src/auth/hooks/useCompanyName.js

import { jwtDecode } from "jwt-decode";

export function useCompanyName() {
  const token = localStorage.getItem("xbytechat-token");

  if (!token) return "";

  try {
    const decoded = jwtDecode(token);
    return decoded.companyName || "";
  } catch (err) {
    console.error("‚ùå Failed to decode companyName from token:", err);
    return "";
  }
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\auth\hooks\useFeatureAccess.js 
====================================================== 
 
import { useEffect, useState } from "react";
import axiosClient from "../../../api/axiosClient"; // ‚úÖ relative path confirmed

const featureAccessCache = {};

export function useFeatureAccess(businessId, featureName) {
  const [isAllowed, setIsAllowed] = useState(false);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!businessId || !featureName) return;

    const cacheKey = `${businessId}-${featureName}`;

    if (featureAccessCache[cacheKey] !== undefined) {
      setIsAllowed(featureAccessCache[cacheKey]);
      setLoading(false);
      return;
    }

    const fetchAccess = async () => {
      try {
        const response = await axiosClient.get(
          `/api/feature-access/business/${businessId}`
        );
        const accessList = response.data || [];

        const feature = accessList.find(f => f.featureName === featureName);
        const allowed = feature ? feature.isEnabled : false;

        featureAccessCache[cacheKey] = allowed;
        setIsAllowed(allowed);
      } catch (err) {
        console.error("‚ùå Feature access check failed:", err);
        setIsAllowed(false);
      } finally {
        setLoading(false);
      }
    };

    fetchAccess();
  }, [businessId, featureName]);

  return { isAllowed, loading };
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\auth\hooks\useFeatureStatus.js 
====================================================== 
 
// üìÑ src/pages/auth/hooks/useFeatureStatus.js
import { useAuth } from "../context/AuthContext";

export default function useFeatureStatus(featureKey) {
  const { featureMatrix } = useAuth();
  const feature = featureMatrix?.[featureKey];

  if (feature === undefined)
    return { status: "unknown", label: "Unknown", color: "gray" };

  if (feature.isOverridden !== null) {
    return {
      status: "overridden",
      label: feature.isOverridden
        ? "Overridden: Enabled"
        : "Overridden: Disabled",
      color: feature.isOverridden ? "yellow" : "gray",
    };
  }

  return feature.isAvailableInPlan
    ? { status: "enabled", label: "Plan: Enabled", color: "green" }
    : { status: "disabled", label: "Plan: Not Available", color: "red" };
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\auth\hooks\usePlan.js 
====================================================== 
 
// src/pages/auth/hooks/usePlan.js
import { useEffect, useState } from "react";
import axiosClient from "../../../api/axiosClient";
import { useAuth } from "../context/pld_AuthContext";

export function usePlan() {
  const { role } = useAuth();
  const [plan, setPlan] = useState(""); // normalized lowercase tier (from DB name)
  const [planObj, setPlanObj] = useState(null); // full DB object { id, name, code, description, ... }
  const [planId, setPlanId] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  useEffect(() => {
    let cancel = false;

    async function load() {
      setLoading(true);
      setError("");
      setPlan("");
      setPlanObj(null);
      setPlanId(null);

      try {
        const res = await axiosClient.get("/plan/me/permissions");
        const data = res?.data || {};
        const p = data.plan || null;

        if (!cancel) {
          setPlanId(data.planId ?? null);

          if (p) {
            const tier = (p.name || "").trim().toLowerCase(); // ‚Üê directly from DB
            setPlan(tier);
            setPlanObj(p); // keep full object from backend
          }
        }
      } catch (e) {
        if (!cancel) {
          const msg =
            e?.response?.data?.message || e?.message || "Failed to load plan";
          setError(msg);
        }
      } finally {
        if (!cancel) setLoading(false);
      }
    }

    load();
    return () => {
      cancel = true;
    };
  }, []);

  return { plan, planObj, planId, loading, error, role };
}

// // src/pages/auth/hooks/usePlan.js
// import { useEffect, useMemo, useState } from "react";
// import axiosClient from "../../../api/axiosClient";
// import { useAuth } from "../context/pld_AuthContext";

// // normalize backend plan name/code to: trial | basic | smart | advanced
// function normalizePlanTier(plan) {
//   if (!plan) return "";
//   const raw = (plan.tier || plan.code || plan.name || "")
//     .toString()
//     .trim()
//     .toLowerCase();

//   if (["trial", "free"].includes(raw)) return "trial";
//   if (["basic", "starter"].includes(raw)) return "basic";
//   if (["smart", "pro", "standard"].includes(raw)) return "smart";
//   if (["advanced", "enterprise"].includes(raw)) return "advanced";

//   if (raw.includes("trial")) return "trial";
//   if (raw.includes("basic") || raw.includes("start")) return "basic";
//   if (raw.includes("smart") || raw.includes("pro")) return "smart";
//   if (raw.includes("advanced") || raw.includes("enter")) return "advanced";
//   return raw; // unknown ‚Üí pass through
// }

// export function usePlan() {
//   const { role } = useAuth(); // useful if you want to special-case admins
//   const [plan, setPlan] = useState(""); // normalized tier
//   const [planObj, setPlanObj] = useState(null); // { id, name, code, description }
//   const [planId, setPlanId] = useState(null); // GUID from response
//   const [loading, setLoading] = useState(false);
//   const [error, setError] = useState("");

//   useEffect(() => {
//     let cancel = false;

//     async function load() {
//       setLoading(true);
//       setError("");
//       setPlan("");
//       setPlanObj(null);
//       setPlanId(null);

//       try {
//         const res = await axiosClient.get("/plan/me/permissions"); // baseURL already has /api
//         const data = res?.data || {};
//         const p = data.plan || null;

//         if (!cancel) {
//           setPlanId(data.planId ?? null);

//           if (p) {
//             const tier = normalizePlanTier(p);
//             setPlan(tier);
//             setPlanObj({
//               id: p.id,
//               name: p.name,
//               code: p.code,
//               description: p.description || "",
//               tier,
//             });
//           } else {
//             // strict: no fallback; surface missing plan
//             setPlan("");
//             setPlanObj(null);
//           }
//         }
//       } catch (e) {
//         if (!cancel) {
//           const msg =
//             e?.response?.data?.message || e?.message || "Failed to load plan";
//           setError(msg);
//           // Keep plan empty to enforce ‚Äúno fallback‚Äù policy
//         }
//       } finally {
//         if (!cancel) setLoading(false);
//       }
//     }

//     load();
//     return () => {
//       cancel = true;
//     };
//   }, []);

//   const hasPlan = useMemo(() => {
//     const order = ["trial", "basic", "smart", "advanced"];
//     return required => {
//       if (!plan) return false;
//       const a = order.indexOf(plan.toLowerCase());
//       const b = order.indexOf((required || "").toLowerCase());
//       if (a === -1 || b === -1) return false;
//       return a >= b;
//     };
//   }, [plan]);

//   return { plan, planObj, planId, loading, error, hasPlan, role };
// }

// // src/pages/auth/hooks/usePlan.js
// import { useEffect, useMemo, useState } from "react";
// import { useAuth } from "../context/pld_AuthContext";
// import { getPlanById } from "../services/planService";

// export function usePlan() {
//   const { planId, role } = useAuth(); // role is handy if you want to bypass admins
//   const [plan, setPlan] = useState(""); // normalized tier: trial|basic|smart|advanced|unknown
//   const [planObj, setPlanObj] = useState(null); // full plan object from API
//   const [loading, setLoading] = useState(false);
//   const [error, setError] = useState("");

//   useEffect(() => {
//     let cancel = false;

//     async function run() {
//       setError("");
//       setPlan("");
//       setPlanObj(null);

//       // If no planId (e.g., superadmin/partner/reseller), nothing to fetch
//       if (!planId) return;

//       setLoading(true);
//       try {
//         const p = await getPlanById(planId);
//         if (!cancel) {
//           setPlan(p?.tier || ""); // normalized tier
//           setPlanObj(p || null); // keep full plan data if you need description/name
//         }
//       } catch (e) {
//         if (!cancel) {
//           setError(e?.message || "Failed to fetch plan");
//         }
//       } finally {
//         if (!cancel) setLoading(false);
//       }
//     }

//     run();
//     return () => {
//       cancel = true;
//     };
//   }, [planId]);

//   const hasPlan = useMemo(() => {
//     const order = ["trial", "basic", "smart", "advanced"];
//     return required => {
//       if (!plan) return false;
//       const a = order.indexOf(plan.toLowerCase());
//       const b = order.indexOf((required || "").toLowerCase());
//       if (a === -1 || b === -1) return false;
//       return a >= b;
//     };
//   }, [plan]);

//   return { plan, planObj, planId, loading, error, hasPlan, role };
// }

// // üìÑ src/pages/auth/hooks/usePlan.js
// import { useAuth } from "../context/AuthContext";

// export function usePlan() {
//   const { plan } = useAuth();

//   const hasPlan = requiredPlan => {
//     if (!plan) return false;

//     const tiers = ["trial", "basic", "smart", "advanced"];
//     const userTier = tiers.indexOf(plan.toLowerCase());
//     const requiredTier = tiers.indexOf(requiredPlan.toLowerCase());

//     return userTier >= requiredTier;
//   };

//   return { plan, hasPlan };
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\auth\hooks\useRole.js 
====================================================== 
 
// üìÑ src/auth/hooks/useRole.js
import { useAuth } from "../../pages/auth/context/AuthContext";
export function useRole() {
  const { role } = useAuth();
  return role || "";
}

// // src/auth/hooks/useRole.js

// import { jwtDecode } from "jwt-decode";

// export function useRole() {
//   const token = localStorage.getItem("xbytechat-token");

//   if (!token) return "";

//   try {
//     const decoded = jwtDecode(token);
//     return decoded.role || "";
//   } catch (err) {
//     console.error("‚ùå Failed to decode role from token:", err);
//     return "";
//   }
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\auth\services\authService.js 
====================================================== 
 
import axiosClient, { TOKEN_KEY } from "../../../api/axiosClient";
import { getAuthFromToken } from "../../../utils/jwt";

function toArray(csv) {
  return String(csv || "")
    .split(",")
    .map(s => s.trim())
    .filter(Boolean);
}

export const login = async (email, password) => {
  try {
    const { data } = await axiosClient.post("/auth/login", { email, password });

    const token = data?.token;
    if (!token) {
      const msg = data?.message || "‚ùå Login failed.";
      const e = new Error(msg);
      e.isCustom = true;
      throw e;
    }

    // Store token
    localStorage.setItem(TOKEN_KEY, token);

    // Decode & normalize auth info from JWT
    const auth = getAuthFromToken(); // { isAuth, role, name, planId, businessId, hasAllAccess, permissionsCsv, featuresCsv, ... }

    // üîß Back-compat keys used in a few places
    if (auth?.role) localStorage.setItem("role", auth.role); // used by some admin pages
    localStorage.setItem(
      "xbytechat-auth-data",
      JSON.stringify({
        role: auth?.role ?? "business",
        name: auth?.name ?? "",
        planId: auth?.planId ?? null,
        businessId: auth?.businessId ?? null,
        hasAllAccess: !!auth?.hasAllAccess,
        // convert CSV in token ‚Üí arrays for hooks like usePermission()
        permissions: toArray(auth?.permissionsCsv),
        features: toArray(auth?.featuresCsv),
        status: auth?.status ?? "active",
      })
    );

    // Hand back detail so the UI can decide where to route
    return {
      success: true,
      role: auth?.role ?? "business",
      status: (auth?.status || "active").toLowerCase(), // e.g. "profilepending"
      hasAllAccess: !!auth?.hasAllAccess,
      planId: auth?.planId ?? null,
      businessId: auth?.businessId ?? null,
    };
  } catch (err) {
    const msg =
      err?.response?.data?.message || err?.message || "‚ùå Login failed.";
    const e = new Error(msg);
    e.code = err?.response?.status;
    e.isCustom = true;
    throw e;
  }
};

export const logout = () => {
  try {
    localStorage.removeItem(TOKEN_KEY);
    localStorage.removeItem("role");
    localStorage.removeItem("xbytechat-auth-data");
  } catch {
    /* no-op */
  }
};
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\auth\services\planService.js 
====================================================== 
 
// // src/pages/auth/services/planService.js
// import axiosClient from "../../../api/axiosClient";

// // simple in-memory cache for plan lookups
// const planCache = new Map();

// /**
//  * Normalize a backend plan name/code to one of: trial | basic | smart | advanced
//  * Tweak this mapping to match your DB values exactly.
//  */
// function normalizePlanTier(plan) {
//   if (!plan) return "";
//   const raw = (plan.tier || plan.code || plan.name || "")
//     .toString()
//     .trim()
//     .toLowerCase();

//   if (["trial", "free"].includes(raw)) return "trial";
//   if (["basic", "starter"].includes(raw)) return "basic";
//   if (["smart", "pro", "standard"].includes(raw)) return "smart";
//   if (["advanced", "enterprise"].includes(raw)) return "advanced";
//   // fallback: try partial matches
//   if (raw.includes("trial")) return "trial";
//   if (raw.includes("basic") || raw.includes("start")) return "basic";
//   if (raw.includes("smart") || raw.includes("pro")) return "smart";
//   if (raw.includes("advanced") || raw.includes("enter")) return "advanced";
//   return raw; // unknown tier, return as-is
// }

// /**
//  * Fetch plan by id (cached). Expects API to return something like:
//  * { id, name, code, tier, description }
//  */
// export async function getPlanById(planId) {
//   if (!planId) return null;
//   if (planCache.has(planId)) return planCache.get(planId);

//   // Adjust endpoint to your backend route if different:
//   const { data } = await axiosClient.get(`/plans/${planId}`);
//   const plan = data?.data || data || null;

//   const normalized = plan
//     ? {
//         id: plan.id || planId,
//         name: plan.name || "",
//         code: plan.code || "",
//         tier: normalizePlanTier(plan),
//         description: plan.description || "",
//       }
//     : null;

//   planCache.set(planId, normalized);
//   return normalized;
// }

// src/pages/auth/services/planService.js
import axiosClient from "../../../api/axiosClient";

const planCache = new Map();

function normalizePlanTier(plan) {
  if (!plan) return "";
  const raw = (plan.tier || plan.code || plan.name || "")
    .toString()
    .trim()
    .toLowerCase();

  if (["trial", "free"].includes(raw)) return "trial";
  if (["basic", "starter"].includes(raw)) return "basic";
  if (["smart", "pro", "standard"].includes(raw)) return "smart";
  if (["advanced", "enterprise"].includes(raw)) return "advanced";
  if (raw.includes("trial")) return "trial";
  if (raw.includes("basic") || raw.includes("start")) return "basic";
  if (raw.includes("smart") || raw.includes("pro")) return "smart";
  if (raw.includes("advanced") || raw.includes("enter")) return "advanced";
  return raw;
}

function pickPayload(data) {
  // handle {data:{...}}, {success, data:{...}}, or raw object
  if (!data) return null;
  if (data.data && typeof data.data === "object") return data.data;
  return data;
}

export async function getPlanById(planId) {
  if (!planId) return null;

  const id = encodeURIComponent(String(planId).trim());
  if (planCache.has(id)) return planCache.get(id);

  let payload = null;
  let lastErr;

  // Try RESTful style: /plans/{id}
  try {
    const res1 = await axiosClient.get(`/plans/${id}`);
    payload = pickPayload(res1.data);
  } catch (e) {
    lastErr = e;
  }

  // Fallback to query style: /plans?id={id}
  if (!payload) {
    try {
      const res2 = await axiosClient.get(`/plans`, { params: { id } });
      payload = pickPayload(res2.data);
    } catch (e) {
      lastErr = e;
    }
  }

  if (!payload) {
    // bubble up a useful message
    const status = lastErr?.response?.status;
    const msg =
      lastErr?.response?.data?.message ||
      lastErr?.message ||
      `Failed to fetch plan (${status || "no response"})`;
    throw new Error(msg);
  }

  const normalized = {
    id: payload.id || planId,
    name: payload.name || "",
    code: payload.code || "",
    tier: normalizePlanTier(payload),
    description: payload.description || "",
  };

  planCache.set(id, normalized);
  return normalized;
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\auth\__tests__\access.test.ts 
====================================================== 
 
// src/auth/__tests__/access.test.ts
import { describe, it, expect } from "@jest/globals";
import { canUseFeature } from "../access";

describe("canUseFeature", () => {
  it("returns true when no requirements provided", () => {
    expect(
      canUseFeature({
        role: "business",
        availableFeatures: { Messaging: true },
        required: undefined,
      })
    ).toBe(true);
  });

  it("superadmin bypasses everything", () => {
    expect(
      canUseFeature({
        role: "superadmin",
        availableFeatures: {},
        required: { role: ["admin"], featureKeys: ["PlanManager"] },
      })
    ).toBe(true);
  });

  it("role-gated allow (role included)", () => {
    expect(
      canUseFeature({
        role: "admin",
        availableFeatures: {},
        required: { role: ["admin", "superadmin"] },
      })
    ).toBe(true);
  });

  it("role-gated deny (role not included)", () => {
    expect(
      canUseFeature({
        role: "business",
        availableFeatures: { PlanManager: true },
        required: { role: ["admin"] },
      })
    ).toBe(false);
  });

  it("feature-gated allow (single feature present)", () => {
    expect(
      canUseFeature({
        role: "admin",
        availableFeatures: { BulkMessaging: true },
        required: { featureKeys: ["BulkMessaging"] },
      })
    ).toBe(true);
  });

  it("feature-gated deny when missing", () => {
    expect(
      canUseFeature({
        role: "admin",
        availableFeatures: {},
        required: { featureKeys: ["BulkMessaging"] },
      })
    ).toBe(false);
  });

  it("multi-feature gating requires all features", () => {
    expect(
      canUseFeature({
        role: "admin",
        availableFeatures: { A: true, B: false },
        required: { featureKeys: ["A", "B"] },
      })
    ).toBe(false);

    expect(
      canUseFeature({
        role: "admin",
        availableFeatures: { A: true, B: true },
        required: { featureKeys: ["A", "B"] },
      })
    ).toBe(true);
  });
});
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\AutoReplyBuilder\AutoReplyBuilder.jsx 
====================================================== 
 
import React, { useRef, useEffect } from "react";
import { useSearchParams } from "react-router-dom";
import AutoReplyCanvas from "./components/AutoReplyCanvas";
import AutoReplySidebar from "./components/AutoReplySidebar";
import { Button } from "../../components/ui/button";
import { toast } from "react-toastify";

export default function AutoReplyBuilder() {
  const canvasRef = useRef();
  const [searchParams] = useSearchParams();
  const flowId = searchParams.get("flowId");

  // ‚úÖ SAVE FLOW handler (connected to <AutoReplyCanvas />)
  const handleSaveFlow = async payload => {
    try {
      const response = await fetch("/api/autoreplyflows/save", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        // Only send the payload fields - do NOT include businessId!
        body: JSON.stringify({
          ...payload,
          // Optionally include flowId if you are updating (if backend expects it)
          // flowId, // UNCOMMENT ONLY IF backend requires this for updates
        }),
      });

      if (!response.ok) throw new Error("Save failed");
      toast.success("‚úÖ Flow saved successfully!");
    } catch (err) {
      toast.error("‚ùå Failed to save flow");
      console.error("Save error:", err);
    }
  };

  const loadFlowById = async flowId => {
    try {
      const res = await fetch(`/AutoReplyFlows/${flowId}`);
      if (!res.ok) throw new Error("Failed to fetch flow");

      const data = await res.json();
      canvasRef.current?.loadFlow(data);
      toast.success("‚úÖ Flow loaded");
    } catch (err) {
      toast.error("‚ùå Error loading flow");
    }
  };

  useEffect(() => {
    if (flowId) {
      loadFlowById(flowId);
    }
  }, [flowId]);

  return (
    <div className="flex h-screen overflow-hidden bg-gray-50">
      {/* Sidebar (left) */}
      <div className="w-72 border-r border-gray-200 bg-white p-4">
        <h2 className="text-lg font-semibold mb-4 text-zinc-800">
          üß† Auto-Reply Blocks
        </h2>
        <AutoReplySidebar />
      </div>

      {/* Main Area (right) */}
      <div className="flex-1 flex flex-col">
        {/* Topbar */}
        <div className="flex justify-between items-center px-6 py-3 border-b bg-white shadow-sm">
          <h2 className="text-md font-medium text-zinc-800">üîÄ Flow Canvas</h2>
          <Button onClick={() => canvasRef.current?.saveFlow?.()}>
            üíæ Save Flow
          </Button>
        </div>

        {/* Canvas */}
        <div className="flex-1 bg-white relative">
          <AutoReplyCanvas
            ref={canvasRef}
            flowName=""
            triggerKeywords=""
            onSave={handleSaveFlow} // ‚úÖ Connected here
          />
        </div>
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\AutoReplyBuilder\components\AutoReplyCanvas.jsx 
====================================================== 
 
import React, {
  useCallback,
  useState,
  useRef,
  forwardRef,
  useImperativeHandle,
} from "react";
import ReactFlow, {
  Background,
  Controls,
  MiniMap,
  addEdge,
  useNodesState,
  useEdgesState,
  ReactFlowProvider,
} from "reactflow";
import "reactflow/dist/style.css";

import { toast } from "react-toastify";
import AutoReplyNodeStart from "./AutoReplyNodeStart";
import AutoReplyNodeBlock from "./AutoReplyNodeBlock";
import AutoReplyNodeEditor from "./AutoReplyNodeEditor";

const nodeTypes = {
  start: AutoReplyNodeStart,
  message: AutoReplyNodeBlock,
  template: AutoReplyNodeBlock,
  wait: AutoReplyNodeBlock,
  tag: AutoReplyNodeBlock,
};

let id = 1;
const getId = () => `node_${id++}`;

const AutoReplyCanvas = forwardRef((props, ref) => {
  const reactFlowWrapper = useRef(null);
  const [reactFlowInstance, setReactFlowInstance] = useState(null);

  const [flowName, setFlowName] = useState("");
  const [triggerKeywords, setTriggerKeywords] = useState("");

  const [nodes, setNodes, onNodesChange] = useNodesState([
    {
      id: "start-1",
      type: "start",
      position: { x: 100, y: 100 },
      data: { label: "start" },
    },
  ]);
  const [edges, setEdges, onEdgesChange] = useEdgesState([]);
  const [selectedNode, setSelectedNode] = useState(null);
  const [pendingDeleteId, setPendingDeleteId] = useState(null);

  const handleDeleteNode = useCallback(
    nodeId => {
      setNodes(nds => nds.filter(n => n.id !== nodeId));
      setEdges(eds =>
        eds.filter(e => e.source !== nodeId && e.target !== nodeId)
      );
      setSelectedNode(null);
    },
    [setNodes, setEdges]
  );

  const confirmDeleteNode = useCallback(
    nodeId => {
      const node = nodes.find(n => n.id === nodeId);
      if (node?.type === "start") {
        setPendingDeleteId(nodeId);
      } else {
        handleDeleteNode(nodeId);
      }
    },
    [nodes, handleDeleteNode]
  );

  const onConnect = useCallback(
    params => {
      const customId = `reactflow__edge-${params.source}${
        params.sourceHandle ? params.sourceHandle : ""
      }-${params.target}`;
      setEdges(eds =>
        addEdge(
          {
            ...params,
            id: customId,
            type: "smoothstep",
          },
          eds
        )
      );
    },
    [setEdges]
  );

  const onEdgeClick = useCallback(
    (event, edge) => {
      event.stopPropagation();
      setEdges(eds => eds.filter(e => e.id !== edge.id));
    },
    [setEdges]
  );

  const onDrop = useCallback(
    event => {
      event.preventDefault();
      const type = event.dataTransfer.getData("application/reactflow");
      if (!type || !reactFlowInstance) return;

      const bounds = reactFlowWrapper.current.getBoundingClientRect();
      const position = reactFlowInstance.project({
        x: event.clientX - bounds.left,
        y: event.clientY - bounds.top,
      });

      const newId = getId();
      const newNode = {
        id: newId,
        type,
        position,
        data: {
          id: newId,
          label: type,
          config: {},
          onDelete: confirmDeleteNode,
        },
      };

      setNodes(nds => nds.concat(newNode));
    },
    [reactFlowInstance, confirmDeleteNode, setNodes]
  );

  const onDragOver = useCallback(event => {
    event.preventDefault();
    event.dataTransfer.dropEffect = "move";
  }, []);

  const onNodeClick = useCallback((_, node) => {
    setSelectedNode(node);
  }, []);

  const handleNodeSave = updatedNode => {
    setNodes(prev =>
      prev.map(n => (n.id === updatedNode.id ? updatedNode : n))
    );
    setSelectedNode(null);
  };

  const handleSaveFlow = async () => {
    if (!reactFlowInstance) return;

    const flow = reactFlowInstance.toObject();
    const nodeMap = {};
    flow.nodes.forEach(node => {
      nodeMap[node.id] = node.data?.id || node.id;
    });

    const processedEdges = flow.edges.map(edge => ({
      id: edge.id,
      source: edge.source,
      target: edge.target,
      sourceNodeId: nodeMap[edge.source],
      targetNodeId: nodeMap[edge.target],
      sourceHandle: edge.sourceHandle ?? "output",
      // fallback if undefined
      targetHandle: "input", // ‚úÖ default required for all edges
    }));

    const processedNodes = flow.nodes.map(node => {
      const id = node.data?.id || node.id;
      const nodeConfig =
        typeof node.data?.config === "object"
          ? JSON.parse(JSON.stringify(node.data.config))
          : {};

      const buttonToNextMap = {};
      if (node.type === "template") {
        processedEdges.forEach(edge => {
          if (
            edge.source === node.id &&
            edge.sourceHandle?.startsWith("button-")
          ) {
            const btnIndex = edge.sourceHandle.split("-")[1];
            buttonToNextMap[btnIndex] = edge.target;
          }
        });
        nodeConfig.buttonToNextMap = buttonToNextMap;
      }

      return {
        id,
        type: node.type,
        position: { x: node.position.x, y: node.position.y },
        data: {
          label: node.data?.label || "",
          config: nodeConfig,
        },
      };
    });

    const payload = {
      name: flowName.trim() || props.flowName || "Untitled Flow",
      triggerKeyword: triggerKeywords.trim() || props.triggerKeywords || "",
      nodes: processedNodes,
      edges: processedEdges,
    };

    try {
      if (typeof props.onSave === "function") {
        await props.onSave(payload);
        toast.success("‚úÖ Flow saved!");
      } else {
        toast.error("‚ùå Save function is not connected.");
      }
    } catch (error) {
      console.error("‚ùå Error during save:", error);
      toast.error("‚ùå Failed to save flow.");
    }
  };

  useImperativeHandle(ref, () => ({
    loadFlow: flowData => {
      const loadedNodes = flowData.nodes.map(node => ({
        id: node.id,
        type: node.nodeType,
        position: { x: node.positionX, y: node.positionY },
        data: {
          id: node.id,
          label: node.label || node.nodeType,
          config:
            typeof node.configJson === "string"
              ? JSON.parse(node.configJson)
              : node.configJson || {},
        },
      }));

      const loadedEdges = flowData.edges.map(edge => ({
        id: edge.id,
        source:
          loadedNodes.find(n => n.id === edge.sourceNodeId)?.id ||
          edge.sourceNodeId,
        target:
          loadedNodes.find(n => n.id === edge.targetNodeId)?.id ||
          edge.targetNodeId,
        sourceNodeId: edge.sourceNodeId,
        targetNodeId: edge.targetNodeId,
        sourceHandle: edge.sourceHandle || null,
        targetHandle: edge.targetHandle || null,
      }));

      setNodes(loadedNodes);
      setEdges(loadedEdges);
    },
    handleSaveFlow,
  }));

  return (
    <ReactFlowProvider>
      <div className="p-4 bg-white border-b border-gray-200">
        <div className="flex flex-col md:flex-row gap-4">
          <div className="flex-1">
            <label className="block text-sm font-medium text-zinc-700 mb-1">
              Flow Name
            </label>
            <input
              type="text"
              value={flowName}
              onChange={e => setFlowName(e.target.value)}
              placeholder="e.g. Welcome Flow"
              className="w-full border rounded px-3 py-2"
            />
          </div>
          <div className="flex-1">
            <label className="block text-sm font-medium text-zinc-700 mb-1">
              Trigger Keywords (comma separated)
            </label>
            <input
              type="text"
              value={triggerKeywords}
              onChange={e => setTriggerKeywords(e.target.value)}
              placeholder="hi, hello, hey"
              className="w-full border rounded px-3 py-2"
            />
          </div>
        </div>
        <div className="mt-4 flex justify-end">
          <button
            onClick={handleSaveFlow}
            className="bg-purple-600 text-white px-4 py-2 rounded shadow hover:bg-purple-700 transition"
          >
            Save Flow
          </button>
        </div>
      </div>

      <div
        ref={reactFlowWrapper}
        className="w-full h-[calc(100vh-10rem)]"
        onDrop={onDrop}
        onDragOver={onDragOver}
      >
        <ReactFlow
          nodes={nodes.map(n => ({
            ...n,
            data: { ...n.data, onDelete: confirmDeleteNode },
          }))}
          edges={edges}
          onNodesChange={onNodesChange}
          onEdgesChange={onEdgesChange}
          onConnect={onConnect}
          onEdgeClick={onEdgeClick}
          onNodeClick={onNodeClick}
          onInit={setReactFlowInstance}
          fitView
          nodeTypes={nodeTypes}
        >
          <Background />
          <MiniMap />
          <Controls />
        </ReactFlow>

        <AutoReplyNodeEditor
          node={selectedNode}
          onClose={() => setSelectedNode(null)}
          onSave={handleNodeSave}
        />

        {pendingDeleteId && (
          <div className="fixed inset-0 bg-black/30 z-50 flex items-center justify-center">
            <div className="bg-white p-6 rounded shadow-xl max-w-sm w-full">
              <h2 className="text-lg font-bold text-red-600 mb-2">
                Delete Start Block?
              </h2>
              <p className="text-sm text-gray-600 mb-4">
                This is the starting point of the flow. Deleting it may break
                connected logic.
              </p>
              <div className="flex justify-end gap-2">
                <button
                  className="text-sm px-3 py-1 rounded bg-gray-200"
                  onClick={() => setPendingDeleteId(null)}
                >
                  Cancel
                </button>
                <button
                  className="text-sm px-3 py-1 rounded bg-red-600 text-white"
                  onClick={() => {
                    handleDeleteNode(pendingDeleteId);
                    setPendingDeleteId(null);
                  }}
                >
                  Delete
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </ReactFlowProvider>
  );
});

export default AutoReplyCanvas;

// import React, {
//   useCallback,
//   useState,
//   useRef,
//   forwardRef,
//   useImperativeHandle,
// } from "react";
// import ReactFlow, {
//   Background,
//   Controls,
//   MiniMap,
//   addEdge,
//   useNodesState,
//   useEdgesState,
//   ReactFlowProvider,
// } from "reactflow";
// import "reactflow/dist/style.css";

// import { toast } from "react-toastify";
// import AutoReplyNodeStart from "./AutoReplyNodeStart";
// import AutoReplyNodeBlock from "./AutoReplyNodeBlock";
// import AutoReplyNodeEditor from "./AutoReplyNodeEditor";

// const nodeTypes = {
//   start: AutoReplyNodeStart,
//   message: AutoReplyNodeBlock,
//   template: AutoReplyNodeBlock,
//   wait: AutoReplyNodeBlock,
//   tag: AutoReplyNodeBlock,
// };

// let id = 1;
// const getId = () => `node_${id++}`;

// const AutoReplyCanvas = forwardRef((props, ref) => {
//   const reactFlowWrapper = useRef(null);
//   const [reactFlowInstance, setReactFlowInstance] = useState(null);

//   const [flowName, setFlowName] = useState("");
//   const [triggerKeywords, setTriggerKeywords] = useState("");

//   const [nodes, setNodes, onNodesChange] = useNodesState([
//     {
//       id: "start-1",
//       type: "start",
//       position: { x: 100, y: 100 },
//       data: { label: "start" },
//     },
//   ]);
//   const [edges, setEdges, onEdgesChange] = useEdgesState([]);
//   const [selectedNode, setSelectedNode] = useState(null);
//   const [pendingDeleteId, setPendingDeleteId] = useState(null);

//   const handleDeleteNode = useCallback(
//     nodeId => {
//       setNodes(nds => nds.filter(n => n.id !== nodeId));
//       setEdges(eds =>
//         eds.filter(e => e.source !== nodeId && e.target !== nodeId)
//       );
//       setSelectedNode(null);
//     },
//     [setNodes, setEdges]
//   );

//   const confirmDeleteNode = useCallback(
//     nodeId => {
//       const node = nodes.find(n => n.id === nodeId);
//       if (node?.type === "start") {
//         setPendingDeleteId(nodeId);
//       } else {
//         handleDeleteNode(nodeId);
//       }
//     },
//     [nodes, handleDeleteNode]
//   );

//   const onConnect = useCallback(
//     params => setEdges(eds => addEdge({ ...params, type: "smoothstep" }, eds)),
//     [setEdges]
//   );

//   const onEdgeClick = useCallback(
//     (event, edge) => {
//       event.stopPropagation();
//       setEdges(eds => eds.filter(e => e.id !== edge.id));
//     },
//     [setEdges]
//   );

//   const onDrop = useCallback(
//     event => {
//       event.preventDefault();
//       const type = event.dataTransfer.getData("application/reactflow");
//       if (!type || !reactFlowInstance) return;

//       const bounds = reactFlowWrapper.current.getBoundingClientRect();
//       const position = reactFlowInstance.project({
//         x: event.clientX - bounds.left,
//         y: event.clientY - bounds.top,
//       });

//       const newId = getId();
//       const newNode = {
//         id: newId,
//         type,
//         position,
//         data: {
//           id: newId,
//           label: type,
//           config: {},
//           onDelete: confirmDeleteNode,
//         },
//       };

//       setNodes(nds => nds.concat(newNode));
//     },
//     [reactFlowInstance, confirmDeleteNode, setNodes]
//   );

//   const onDragOver = useCallback(event => {
//     event.preventDefault();
//     event.dataTransfer.dropEffect = "move";
//   }, []);

//   const onNodeClick = useCallback((_, node) => {
//     setSelectedNode(node);
//   }, []);

//   const handleNodeSave = updatedNode => {
//     setNodes(prev =>
//       prev.map(n => (n.id === updatedNode.id ? updatedNode : n))
//     );
//     setSelectedNode(null);
//   };

//   const handleSaveFlow = async () => {
//     if (!reactFlowInstance) return;

//     const flow = reactFlowInstance.toObject();
//     const nodeMap = {};
//     flow.nodes.forEach(node => {
//       nodeMap[node.id] = node.data?.id || node.id;
//     });

//     // const processedEdges = flow.edges.map(edge => ({
//     //   id: edge.id,
//     //   source: edge.source,
//     //   target: edge.target,
//     //   sourceNodeId: nodeMap[edge.source],
//     //   targetNodeId: nodeMap[edge.target],
//     //   sourceHandle: edge.sourceHandle || null,
//     // }));
// const processedEdges = flow.edges.map(edge => ({
//   id: edge.id,
//   source: edge.source,
//   target: edge.target,
//   sourceNodeId: nodeMap[edge.source],
//   targetNodeId: nodeMap[edge.target],
//   sourceHandle: edge.sourceHandle || null, // ‚úÖ ensure sourceHandle is saved
// }));
//     const processedNodes = flow.nodes.map(node => {
//       const id = node.data?.id || node.id;
//       const nodeConfig =
//         typeof node.data?.config === "object"
//           ? JSON.parse(JSON.stringify(node.data.config))
//           : {};

//       const buttonToNextMap = {};
//       if (node.type === "template") {
//         processedEdges.forEach(edge => {
//           if (
//             edge.source === node.id &&
//             edge.sourceHandle?.startsWith("button-")
//           ) {
//             const btnIndex = edge.sourceHandle.split("-")[1];
//             buttonToNextMap[btnIndex] = edge.target;
//           }
//         });
//         nodeConfig.buttonToNextMap = buttonToNextMap;
//       }

//       return {
//         id,
//         type: node.type,
//         position: { x: node.position.x, y: node.position.y },
//         data: {
//           label: node.data?.label || "",
//           config: nodeConfig,
//         },
//       };
//     });

//     const payload = {
//       name: flowName.trim() || props.flowName || "Untitled Flow",
//       triggerKeyword: triggerKeywords.trim() || props.triggerKeywords || "",
//       nodes: processedNodes,
//       edges: processedEdges,
//     };

//     try {
//       if (typeof props.onSave === "function") {
//         await props.onSave(payload);
//         toast.success("‚úÖ Flow saved!");
//       } else {
//         toast.error("‚ùå Save function is not connected.");
//       }
//     } catch (error) {
//       console.error("‚ùå Error during save:", error);
//       toast.error("‚ùå Failed to save flow.");
//     }
//   };

//   useImperativeHandle(ref, () => ({
//     loadFlow: flowData => {
//       const loadedNodes = flowData.nodes.map(node => ({
//         id: node.id,
//         type: node.nodeType,
//         position: { x: node.positionX, y: node.positionY },
//         data: {
//           id: node.id,
//           label: node.label || node.nodeType,
//           config:
//             typeof node.configJson === "string"
//               ? JSON.parse(node.configJson)
//               : node.configJson || {},
//         },
//       }));

//       const loadedEdges = flowData.edges.map(edge => ({
//         id: edge.id,
//         source:
//           loadedNodes.find(n => n.id === edge.sourceNodeId)?.id ||
//           edge.sourceNodeId,
//         target:
//           loadedNodes.find(n => n.id === edge.targetNodeId)?.id ||
//           edge.targetNodeId,
//         sourceNodeId: edge.sourceNodeId,
//         targetNodeId: edge.targetNodeId,
//         sourceHandle: edge.sourceHandle || null,
//       }));

//       setNodes(loadedNodes);
//       setEdges(loadedEdges);
//     },
//     handleSaveFlow,
//   }));

//   return (
//     <ReactFlowProvider>
//       <div className="p-4 bg-white border-b border-gray-200">
//         <div className="flex flex-col md:flex-row gap-4">
//           <div className="flex-1">
//             <label className="block text-sm font-medium text-zinc-700 mb-1">
//               Flow Name
//             </label>
//             <input
//               type="text"
//               value={flowName}
//               onChange={e => setFlowName(e.target.value)}
//               placeholder="e.g. Welcome Flow"
//               className="w-full border rounded px-3 py-2"
//             />
//           </div>
//           <div className="flex-1">
//             <label className="block text-sm font-medium text-zinc-700 mb-1">
//               Trigger Keywords (comma separated)
//             </label>
//             <input
//               type="text"
//               value={triggerKeywords}
//               onChange={e => setTriggerKeywords(e.target.value)}
//               placeholder="hi, hello, hey"
//               className="w-full border rounded px-3 py-2"
//             />
//           </div>
//         </div>
//         <div className="mt-4 flex justify-end">
//           <button
//             onClick={handleSaveFlow}
//             className="bg-purple-600 text-white px-4 py-2 rounded shadow hover:bg-purple-700 transition"
//           >
//             Save Flow
//           </button>
//         </div>
//       </div>

//       <div
//         ref={reactFlowWrapper}
//         className="w-full h-[calc(100vh-10rem)]"
//         onDrop={onDrop}
//         onDragOver={onDragOver}
//       >
//         <ReactFlow
//           nodes={nodes.map(n => ({
//             ...n,
//             data: { ...n.data, onDelete: confirmDeleteNode },
//           }))}
//           edges={edges}
//           onNodesChange={onNodesChange}
//           onEdgesChange={onEdgesChange}
//           onConnect={onConnect}
//           onEdgeClick={onEdgeClick}
//           onNodeClick={onNodeClick}
//           onInit={setReactFlowInstance}
//           fitView
//           nodeTypes={nodeTypes}
//         >
//           <Background />
//           <MiniMap />
//           <Controls />
//         </ReactFlow>

//         <AutoReplyNodeEditor
//           node={selectedNode}
//           onClose={() => setSelectedNode(null)}
//           onSave={handleNodeSave}
//         />

//         {pendingDeleteId && (
//           <div className="fixed inset-0 bg-black/30 z-50 flex items-center justify-center">
//             <div className="bg-white p-6 rounded shadow-xl max-w-sm w-full">
//               <h2 className="text-lg font-bold text-red-600 mb-2">
//                 Delete Start Block?
//               </h2>
//               <p className="text-sm text-gray-600 mb-4">
//                 This is the starting point of the flow. Deleting it may break
//                 connected logic.
//               </p>
//               <div className="flex justify-end gap-2">
//                 <button
//                   className="text-sm px-3 py-1 rounded bg-gray-200"
//                   onClick={() => setPendingDeleteId(null)}
//                 >
//                   Cancel
//                 </button>
//                 <button
//                   className="text-sm px-3 py-1 rounded bg-red-600 text-white"
//                   onClick={() => {
//                     handleDeleteNode(pendingDeleteId);
//                     setPendingDeleteId(null);
//                   }}
//                 >
//                   Delete
//                 </button>
//               </div>
//             </div>
//           </div>
//         )}
//       </div>
//     </ReactFlowProvider>
//   );
// });

// export default AutoReplyCanvas;

// import React, {
//   useCallback,
//   useState,
//   useRef,
//   forwardRef,
//   useImperativeHandle,
// } from "react";
// import ReactFlow, {
//   Background,
//   Controls,
//   MiniMap,
//   addEdge,
//   useNodesState,
//   useEdgesState,
//   ReactFlowProvider,
// } from "reactflow";
// import "reactflow/dist/style.css";

// import { toast } from "react-toastify";
// import AutoReplyNodeStart from "./AutoReplyNodeStart";
// import AutoReplyNodeBlock from "./AutoReplyNodeBlock";
// import AutoReplyNodeEditor from "./AutoReplyNodeEditor";

// const nodeTypes = {
//   start: AutoReplyNodeStart,
//   message: AutoReplyNodeBlock,
//   template: AutoReplyNodeBlock,
//   wait: AutoReplyNodeBlock,
//   tag: AutoReplyNodeBlock,
// };

// let id = 1;
// const getId = () => `node_${id++}`;

// const AutoReplyCanvas = forwardRef((props, ref) => {
//   const reactFlowWrapper = useRef(null);
//   const [reactFlowInstance, setReactFlowInstance] = useState(null);

//   const [flowName, setFlowName] = useState("");
//   const [triggerKeywords, setTriggerKeywords] = useState("");

//   const [nodes, setNodes, onNodesChange] = useNodesState([
//     {
//       id: "start-1",
//       type: "start",
//       position: { x: 100, y: 100 },
//       data: { label: "start" },
//     },
//   ]);
//   const [edges, setEdges, onEdgesChange] = useEdgesState([]);
//   const [selectedNode, setSelectedNode] = useState(null);
//   const [pendingDeleteId, setPendingDeleteId] = useState(null);

//   const handleDeleteNode = useCallback(
//     nodeId => {
//       setNodes(nds => nds.filter(n => n.id !== nodeId));
//       setEdges(eds =>
//         eds.filter(e => e.source !== nodeId && e.target !== nodeId)
//       );
//       setSelectedNode(null);
//     },
//     [setNodes, setEdges]
//   );

//   const confirmDeleteNode = useCallback(
//     nodeId => {
//       const node = nodes.find(n => n.id === nodeId);
//       if (node?.type === "start") {
//         setPendingDeleteId(nodeId);
//       } else {
//         handleDeleteNode(nodeId);
//       }
//     },
//     [nodes, handleDeleteNode]
//   );

//   const onConnect = useCallback(
//     params => {
//       setEdges(eds => addEdge({ ...params, type: "smoothstep" }, eds));
//     },
//     [setEdges]
//   );

//   const onEdgeClick = useCallback(
//     (event, edge) => {
//       event.stopPropagation();
//       setEdges(eds => eds.filter(e => e.id !== edge.id));
//     },
//     [setEdges]
//   );

//   const onDrop = useCallback(
//     event => {
//       event.preventDefault();
//       const type = event.dataTransfer.getData("application/reactflow");
//       if (!type || !reactFlowInstance) return;

//       const bounds = reactFlowWrapper.current.getBoundingClientRect();
//       const position = reactFlowInstance.project({
//         x: event.clientX - bounds.left,
//         y: event.clientY - bounds.top,
//       });

//       const newId = getId();
//       const newNode = {
//         id: newId,
//         type,
//         position,
//         data: {
//           id: newId,
//           label: type,
//           config: {},
//           onDelete: confirmDeleteNode,
//         },
//       };

//       setNodes(nds => nds.concat(newNode));
//     },
//     [reactFlowInstance, confirmDeleteNode, setNodes]
//   );

//   const onDragOver = useCallback(event => {
//     event.preventDefault();
//     event.dataTransfer.dropEffect = "move";
//   }, []);

//   const onNodeClick = useCallback((_, node) => {
//     setSelectedNode(node);
//   }, []);

//   const handleNodeSave = updatedNode => {
//     setNodes(prev =>
//       prev.map(n => (n.id === updatedNode.id ? updatedNode : n))
//     );
//     setSelectedNode(null);
//   };

//   const handleSaveFlow = async () => {
//     if (!reactFlowInstance) return;

//     const flow = reactFlowInstance.toObject();

//     const nodeMap = {};
//     flow.nodes.forEach(node => {
//       nodeMap[node.id] = node.data?.id || node.id;
//     });

//     const processedEdges = flow.edges.map(edge => ({
//       id: edge.id,
//       source: edge.source,
//       target: edge.target,
//       sourceHandle: edge.sourceHandle || null,
//       sourceNodeId: nodeMap[edge.source],
//       targetNodeId: nodeMap[edge.target],
//     }));

//     const processedNodes = flow.nodes.map(node => ({
//       id: node.data?.id || node.id,
//       type: node.type,
//       position: {
//         x: node.position.x,
//         y: node.position.y,
//       },
//       data: {
//         label: node.data?.label || "",
//         config:
//           typeof node.data?.config === "object"
//             ? JSON.parse(JSON.stringify(node.data.config))
//             : {},
//       },
//     }));

//     const payload = {
//       name: flowName.trim() || props.flowName || "Untitled Flow",
//       triggerKeyword: triggerKeywords.trim() || props.triggerKeywords || "",
//       nodes: processedNodes,
//       edges: processedEdges,
//     };

//     if (typeof props.onSave === "function") {
//       try {
//         await props.onSave(payload);
//         toast.success("‚úÖ Flow saved!");
//       } catch (error) {
//         console.error("‚ùå Error during save:", error);
//         toast.error("‚ùå Failed to save flow.");
//       }
//     } else {
//       toast.error("‚ùå Save function is not connected.");
//     }
//   };

//   useImperativeHandle(ref, () => ({
//     loadFlow: flowData => {
//       const loadedNodes = flowData.nodes.map(node => ({
//         id: node.id,
//         type: node.nodeType,
//         position: { x: node.positionX, y: node.positionY },
//         data: {
//           id: node.id,
//           label: node.label || node.nodeType,
//           config:
//             typeof node.configJson === "string"
//               ? JSON.parse(node.configJson)
//               : node.configJson || {},
//         },
//       }));

//       const loadedEdges = flowData.edges.map(edge => ({
//         id: edge.id,
//         source:
//           loadedNodes.find(n => n.id === edge.sourceNodeId)?.id ||
//           edge.sourceNodeId,
//         target:
//           loadedNodes.find(n => n.id === edge.targetNodeId)?.id ||
//           edge.targetNodeId,
//         sourceHandle: edge.sourceHandle || null,
//         sourceNodeId: edge.sourceNodeId,
//         targetNodeId: edge.targetNodeId,
//       }));

//       setNodes(loadedNodes);
//       setEdges(loadedEdges);
//     },
//     handleSaveFlow,
//   }));

//   return (
//     <ReactFlowProvider>
//       <div className="p-4 bg-white border-b border-gray-200">
//         <div className="flex flex-col md:flex-row gap-4">
//           <div className="flex-1">
//             <label className="block text-sm font-medium text-zinc-700 mb-1">
//               Flow Name
//             </label>
//             <input
//               type="text"
//               value={flowName}
//               onChange={e => setFlowName(e.target.value)}
//               placeholder="e.g. Welcome Flow"
//               className="w-full border rounded px-3 py-2"
//             />
//           </div>
//           <div className="flex-1">
//             <label className="block text-sm font-medium text-zinc-700 mb-1">
//               Trigger Keywords (comma separated)
//             </label>
//             <input
//               type="text"
//               value={triggerKeywords}
//               onChange={e => setTriggerKeywords(e.target.value)}
//               placeholder="hi, hello, hey"
//               className="w-full border rounded px-3 py-2"
//             />
//           </div>
//         </div>
//         <div className="mt-4 flex justify-end">
//           <button
//             onClick={handleSaveFlow}
//             className="bg-purple-600 text-white px-4 py-2 rounded shadow hover:bg-purple-700 transition"
//           >
//             Save Flow
//           </button>
//         </div>
//       </div>

//       <div
//         ref={reactFlowWrapper}
//         className="w-full h-[calc(100vh-10rem)]"
//         onDrop={onDrop}
//         onDragOver={onDragOver}
//       >
//         <ReactFlow
//           nodes={nodes.map(n => ({
//             ...n,
//             data: { ...n.data, onDelete: confirmDeleteNode },
//           }))}
//           edges={edges}
//           onNodesChange={onNodesChange}
//           onEdgesChange={onEdgesChange}
//           onConnect={onConnect}
//           onEdgeClick={onEdgeClick}
//           onNodeClick={onNodeClick}
//           onInit={setReactFlowInstance}
//           fitView
//           nodeTypes={nodeTypes}
//         >
//           <Background />
//           <MiniMap />
//           <Controls />
//         </ReactFlow>

//         <AutoReplyNodeEditor
//           node={selectedNode}
//           onClose={() => setSelectedNode(null)}
//           onSave={handleNodeSave}
//         />

//         {pendingDeleteId && (
//           <div className="fixed inset-0 bg-black/30 z-50 flex items-center justify-center">
//             <div className="bg-white p-6 rounded shadow-xl max-w-sm w-full">
//               <h2 className="text-lg font-bold text-red-600 mb-2">
//                 Delete Start Block?
//               </h2>
//               <p className="text-sm text-gray-600 mb-4">
//                 This is the starting point of the flow. Deleting it may break
//                 connected logic.
//               </p>
//               <div className="flex justify-end gap-2">
//                 <button
//                   className="text-sm px-3 py-1 rounded bg-gray-200"
//                   onClick={() => setPendingDeleteId(null)}
//                 >
//                   Cancel
//                 </button>
//                 <button
//                   className="text-sm px-3 py-1 rounded bg-red-600 text-white"
//                   onClick={() => {
//                     handleDeleteNode(pendingDeleteId);
//                     setPendingDeleteId(null);
//                   }}
//                 >
//                   Delete
//                 </button>
//               </div>
//             </div>
//           </div>
//         )}
//       </div>
//     </ReactFlowProvider>
//   );
// });

// export default AutoReplyCanvas;

// import React, {
//   useCallback,
//   useState,
//   useRef,
//   forwardRef,
//   useImperativeHandle,
// } from "react";
// import ReactFlow, {
//   Background,
//   Controls,
//   MiniMap,
//   addEdge,
//   useNodesState,
//   useEdgesState,
//   ReactFlowProvider,
// } from "reactflow";
// import "reactflow/dist/style.css";

// import { toast } from "react-toastify";
// import AutoReplyNodeStart from "./AutoReplyNodeStart";
// import AutoReplyNodeBlock from "./AutoReplyNodeBlock";
// import AutoReplyNodeEditor from "./AutoReplyNodeEditor";

// const nodeTypes = {
//   start: AutoReplyNodeStart,
//   message: AutoReplyNodeBlock,
//   template: AutoReplyNodeBlock,
//   wait: AutoReplyNodeBlock,
//   tag: AutoReplyNodeBlock,
// };

// let id = 1;
// const getId = () => `node_${id++}`;

// const AutoReplyCanvas = forwardRef((props, ref) => {
//   const reactFlowWrapper = useRef(null);
//   const [reactFlowInstance, setReactFlowInstance] = useState(null);

//   const [flowName, setFlowName] = useState("");
//   const [triggerKeywords, setTriggerKeywords] = useState("");

//   const [nodes, setNodes, onNodesChange] = useNodesState([
//     {
//       id: "start-1",
//       type: "start",
//       position: { x: 100, y: 100 },
//       data: { label: "start" },
//     },
//   ]);
//   const [edges, setEdges, onEdgesChange] = useEdgesState([]);
//   const [selectedNode, setSelectedNode] = useState(null);
//   const [pendingDeleteId, setPendingDeleteId] = useState(null);

//   const handleDeleteNode = useCallback(
//     nodeId => {
//       setNodes(nds => nds.filter(n => n.id !== nodeId));
//       setEdges(eds =>
//         eds.filter(e => e.source !== nodeId && e.target !== nodeId)
//       );
//       setSelectedNode(null);
//     },
//     [setNodes, setEdges]
//   );

//   const confirmDeleteNode = useCallback(
//     nodeId => {
//       const node = nodes.find(n => n.id === nodeId);
//       if (node?.type === "start") {
//         setPendingDeleteId(nodeId);
//       } else {
//         handleDeleteNode(nodeId);
//       }
//     },
//     [nodes, handleDeleteNode]
//   );

//   const onConnect = useCallback(
//     params => setEdges(eds => addEdge({ ...params, type: "smoothstep" }, eds)),
//     [setEdges]
//   );

//   const onEdgeClick = useCallback(
//     (event, edge) => {
//       event.stopPropagation();
//       setEdges(eds => eds.filter(e => e.id !== edge.id));
//     },
//     [setEdges]
//   );

//   const onDrop = useCallback(
//     event => {
//       event.preventDefault();
//       const type = event.dataTransfer.getData("application/reactflow");
//       if (!type || !reactFlowInstance) return;

//       const bounds = reactFlowWrapper.current.getBoundingClientRect();
//       const position = reactFlowInstance.project({
//         x: event.clientX - bounds.left,
//         y: event.clientY - bounds.top,
//       });

//       const newId = getId();
//       const newNode = {
//         id: newId,
//         type,
//         position,
//         data: {
//           id: newId,
//           label: type,
//           config: {},
//           onDelete: confirmDeleteNode,
//         },
//       };

//       setNodes(nds => nds.concat(newNode));
//     },
//     [reactFlowInstance, confirmDeleteNode, setNodes]
//   );

//   const onDragOver = useCallback(event => {
//     event.preventDefault();
//     event.dataTransfer.dropEffect = "move";
//   }, []);

//   const onNodeClick = useCallback((_, node) => {
//     setSelectedNode(node);
//   }, []);

//   const handleNodeSave = updatedNode => {
//     setNodes(prev =>
//       prev.map(n => (n.id === updatedNode.id ? updatedNode : n))
//     );
//     setSelectedNode(null);
//   };

//   const handleSaveFlow = async () => {
//     if (!reactFlowInstance) return;

//     const flow = reactFlowInstance.toObject();

//     const nodeMap = {};
//     flow.nodes.forEach(node => {
//       nodeMap[node.id] = node.data?.id || node.id;
//     });

//     const processedEdges = flow.edges.map(edge => ({
//       id: edge.id,
//       source: edge.source,
//       target: edge.target,
//       sourceNodeId: nodeMap[edge.source],
//       targetNodeId: nodeMap[edge.target],
//     }));

//     const processedNodes = flow.nodes.map(node => ({
//       id: node.data?.id || node.id,
//       type: node.type,
//       position: {
//         x: node.position.x,
//         y: node.position.y,
//       },
//       data: {
//         label: node.data?.label || "",
//         config:
//           typeof node.data?.config === "object"
//             ? JSON.parse(JSON.stringify(node.data.config))
//             : {},
//       },
//     }));

//     const payload = {
//       name: flowName.trim() || props.flowName || "Untitled Flow",
//       triggerKeyword: triggerKeywords.trim() || props.triggerKeywords || "",
//       nodes: processedNodes,
//       edges: processedEdges,
//     };

//     if (typeof props.onSave === "function") {
//       try {
//         await props.onSave(payload);
//         toast.success("‚úÖ Flow saved!");
//       } catch (error) {
//         console.error("‚ùå Error during save:", error);
//         toast.error("‚ùå Failed to save flow.");
//       }
//     } else {
//       toast.error("‚ùå Save function is not connected.");
//     }
//   };

//   useImperativeHandle(ref, () => ({
//     loadFlow: flowData => {
//       const loadedNodes = flowData.nodes.map(node => ({
//         id: node.id,
//         type: node.nodeType,
//         position: { x: node.positionX, y: node.positionY },
//         data: {
//           id: node.id,
//           label: node.label || node.nodeType,
//           config:
//             typeof node.configJson === "string"
//               ? JSON.parse(node.configJson)
//               : node.configJson || {},
//         },
//       }));

//       const loadedEdges = flowData.edges.map(edge => ({
//         id: edge.id,
//         source:
//           loadedNodes.find(n => n.id === edge.sourceNodeId)?.id ||
//           edge.sourceNodeId,
//         target:
//           loadedNodes.find(n => n.id === edge.targetNodeId)?.id ||
//           edge.targetNodeId,
//         sourceNodeId: edge.sourceNodeId,
//         targetNodeId: edge.targetNodeId,
//       }));

//       setNodes(loadedNodes);
//       setEdges(loadedEdges);
//     },
//     handleSaveFlow,
//   }));

//   return (
//     <ReactFlowProvider>
//       <div className="p-4 bg-white border-b border-gray-200">
//         <div className="flex flex-col md:flex-row gap-4">
//           <div className="flex-1">
//             <label className="block text-sm font-medium text-zinc-700 mb-1">
//               Flow Name
//             </label>
//             <input
//               type="text"
//               value={flowName}
//               onChange={e => setFlowName(e.target.value)}
//               placeholder="e.g. Welcome Flow"
//               className="w-full border rounded px-3 py-2"
//             />
//           </div>
//           <div className="flex-1">
//             <label className="block text-sm font-medium text-zinc-700 mb-1">
//               Trigger Keywords (comma separated)
//             </label>
//             <input
//               type="text"
//               value={triggerKeywords}
//               onChange={e => setTriggerKeywords(e.target.value)}
//               placeholder="hi, hello, hey"
//               className="w-full border rounded px-3 py-2"
//             />
//           </div>
//         </div>
//         <div className="mt-4 flex justify-end">
//           <button
//             onClick={handleSaveFlow}
//             className="bg-purple-600 text-white px-4 py-2 rounded shadow hover:bg-purple-700 transition"
//           >
//             Save Flow
//           </button>
//         </div>
//       </div>

//       <div
//         ref={reactFlowWrapper}
//         className="w-full h-[calc(100vh-10rem)]"
//         onDrop={onDrop}
//         onDragOver={onDragOver}
//       >
//         <ReactFlow
//           nodes={nodes.map(n => ({
//             ...n,
//             data: { ...n.data, onDelete: confirmDeleteNode },
//           }))}
//           edges={edges}
//           onNodesChange={onNodesChange}
//           onEdgesChange={onEdgesChange}
//           onConnect={onConnect}
//           onEdgeClick={onEdgeClick}
//           onNodeClick={onNodeClick}
//           onInit={setReactFlowInstance}
//           fitView
//           nodeTypes={nodeTypes}
//         >
//           <Background />
//           <MiniMap />
//           <Controls />
//         </ReactFlow>

//         <AutoReplyNodeEditor
//           node={selectedNode}
//           onClose={() => setSelectedNode(null)}
//           onSave={handleNodeSave}
//         />

//         {pendingDeleteId && (
//           <div className="fixed inset-0 bg-black/30 z-50 flex items-center justify-center">
//             <div className="bg-white p-6 rounded shadow-xl max-w-sm w-full">
//               <h2 className="text-lg font-bold text-red-600 mb-2">
//                 Delete Start Block?
//               </h2>
//               <p className="text-sm text-gray-600 mb-4">
//                 This is the starting point of the flow. Deleting it may break
//                 connected logic.
//               </p>
//               <div className="flex justify-end gap-2">
//                 <button
//                   className="text-sm px-3 py-1 rounded bg-gray-200"
//                   onClick={() => setPendingDeleteId(null)}
//                 >
//                   Cancel
//                 </button>
//                 <button
//                   className="text-sm px-3 py-1 rounded bg-red-600 text-white"
//                   onClick={() => {
//                     handleDeleteNode(pendingDeleteId);
//                     setPendingDeleteId(null);
//                   }}
//                 >
//                   Delete
//                 </button>
//               </div>
//             </div>
//           </div>
//         )}
//       </div>
//     </ReactFlowProvider>
//   );
// });

// export default AutoReplyCanvas;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\AutoReplyBuilder\components\AutoReplyNodeBlock.jsx 
====================================================== 
 
import React from "react";
import { Handle, Position } from "reactflow";

export default function AutoReplyNodeBlock({ data }) {
  const type = data.label;
  const config = data?.config || {};

  const labelMap = {
    message: "üí¨ Send Message",
    template: "ü•∞ Send Template",
    wait: "‚è± Wait",
    tag: "üè∑ Set Tag",
  };

  const bgColorMap = {
    message: "border-blue-300 bg-blue-50",
    template: "border-purple-300 bg-purple-50",
    wait: "border-yellow-300 bg-yellow-50",
    tag: "border-pink-300 bg-pink-50",
  };

  const blockLabel = labelMap[type] || "üß± Block";
  const blockStyle = bgColorMap[type] || "border-gray-300 bg-gray-50";

  const body = config.body || config.text || "";
  const buttons = Array.isArray(config.multiButtons) ? config.multiButtons : [];

  return (
    <div
      className={`relative group rounded-md border px-4 py-2 w-[280px] text-zinc-800 transition-all duration-200 ${blockStyle} hover:shadow-md hover:scale-[1.02]`}
    >
      {/* Connection handles */}
      {type !== "start" && (
        <Handle
          type="target"
          position={Position.Top}
          style={{ background: "#ccc" }}
        />
      )}
      <Handle
        type="source"
        position={Position.Bottom}
        style={{ background: "#ccc" }}
      />

      {/* Delete button */}
      {data?.onDelete && (
        <button
          onClick={e => {
            e.stopPropagation();
            data.onDelete(data.id);
          }}
          className="absolute top-1.5 right-2 text-xs text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100 transition"
          title="Delete this block"
        >
          ‚úï
        </button>
      )}

      {/* Title + ID */}
      <div className="font-semibold text-base mb-1">{blockLabel}</div>
      <div className="text-xs text-purple-600 font-medium mb-1">
        {data.id || "Unnamed"}
      </div>

      {/* Body text - straight font */}
      {body && (
        <div className="text-xs text-zinc-700 mb-2 whitespace-pre-wrap">
          {body}
        </div>
      )}

      {/* Buttons */}
      {type === "template" && buttons.length > 0 && (
        <div className="flex flex-col gap-1">
          {buttons.map((btn, index) => (
            <div
              key={index}
              className="relative rounded bg-purple-100 px-2 py-1 text-xs text-purple-800 font-medium border border-purple-200 flex items-center justify-center text-center"
            >
              {btn.buttonText || btn.text || "(unnamed)"}

              <Handle
                type="source"
                position={Position.Right}
                id={`button-${index}`}
                style={{
                  top: "50%",
                  transform: "translateY(-50%)",
                  right: -6,
                  width: 8,
                  height: 8,
                  background: "#8b5cf6",
                  borderRadius: "50%",
                }}
              />
            </div>
          ))}
        </div>
      )}

      {/* Tags */}
      {type === "tag" && config.tags?.length > 0 && (
        <div className="text-xs text-zinc-600 mt-1">
          Tags: {config.tags.join(", ")}
        </div>
      )}

      {/* Wait Time */}
      {type === "wait" && config.seconds && (
        <div className="text-xs text-zinc-600 mt-1">
          Wait for {config.seconds} seconds
        </div>
      )}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\AutoReplyBuilder\components\AutoReplyNodeEditor.jsx 
====================================================== 
 
import React, { useState, useEffect, useCallback } from "react";
import { Dialog } from "@headlessui/react";
import { Button } from "../../../components/ui/button";
import WhatsAppTemplatePreview from "./WhatsAppTemplatePreview";

export default function AutoReplyNodeEditor({ node, onClose, onSave }) {
  const [form, setForm] = useState({
    text: "",
    templateName: "",
    placeholders: [],
    tags: [],
    seconds: 1,
    body: "",
    multiButtons: [],
  });

  const [templates, setTemplates] = useState([]);
  const [selectedTemplate, setSelectedTemplate] = useState(null);

  const fetchFullTemplate = async templateName => {
    const businessId = localStorage.getItem("businessId");
    try {
      const res = await fetch(
        `/api/WhatsAppTemplateFetcher/get-by-name/${businessId}/${templateName}?includeButtons=true`
      );

      if (!res.ok) throw new Error("Failed to fetch full template");

      const json = await res.json();
      if (json.success) {
        const tpl = json.template;
        setSelectedTemplate(tpl);

        // ‚úÖ Patch: store buttons in form
        setForm(prev => ({
          ...prev,
          templateName: tpl.name,
          body: tpl.body || tpl.bodyText || "",
          multiButtons: tpl.multiButtons || tpl.buttonParams || [],
        }));
      } else {
        setSelectedTemplate(null);
        console.warn("‚ö†Ô∏è No template found");
      }
    } catch (err) {
      console.error("‚ùå Failed to fetch full template", err);
      setSelectedTemplate(null);
    }
  };

  const fetchTemplates = useCallback(async (preselectedName = "") => {
    const businessId = localStorage.getItem("businessId");
    try {
      const res = await fetch(
        `/api/WhatsAppTemplateFetcher/get-template/${businessId}`
      );

      if (!res.ok) throw new Error("Failed to fetch templates");

      const json = await res.json();
      if (json.success) {
        setTemplates(json.templates);
        if (preselectedName) {
          fetchFullTemplate(preselectedName);
        }
      }
    } catch (err) {
      console.error("‚ùå Failed to fetch templates", err);
    }
  }, []);

  useEffect(() => {
    if (!node) return;

    const { config } = node.data || {};
    setForm({
      text: config?.text || "",
      templateName: config?.templateName || "",
      placeholders: config?.placeholders || [],
      tags: config?.tags || [],
      seconds: config?.seconds || 1,
      body: config?.body || "",
      multiButtons: config?.multiButtons || [],
    });

    if (node.type === "template") {
      fetchTemplates(config?.templateName);
    }
  }, [node, fetchTemplates]);

  const handleChange = async e => {
    const { name, value } = e.target;

    setForm(prev => ({
      ...prev,
      [name]: name === "seconds" ? parseInt(value) || 1 : value,
    }));

    if (name === "templateName") {
      setSelectedTemplate(null);
      await fetchFullTemplate(value);
    }
  };

  const handleSave = () => {
    const updated = {
      ...node,
      data: {
        ...node.data,
        config: {
          ...form,
        },
      },
    };
    onSave(updated);
    onClose();
  };

  if (!node) return null;

  const isTemplate = node.type === "template";

  return (
    <Dialog open={!!node} onClose={onClose} className="relative z-50">
      <div className="fixed inset-0 bg-black/30" aria-hidden="true" />
      <div className="fixed inset-0 flex items-center justify-center p-4">
        <Dialog.Panel className="w-full max-w-lg bg-white rounded-xl shadow-xl border border-gray-200 p-6">
          <Dialog.Title className="text-lg font-semibold mb-4 text-zinc-800">
            ‚úèÔ∏è Edit: {node.type}
          </Dialog.Title>

          <div className="space-y-4 text-sm text-gray-700">
            {node.type === "message" && (
              <div>
                <label className="block font-medium mb-1">Text Message</label>
                <textarea
                  name="text"
                  value={form.text}
                  onChange={handleChange}
                  rows={4}
                  className="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
                />
              </div>
            )}

            {isTemplate && (
              <>
                <div>
                  <label className="block font-medium mb-1">
                    Choose Template
                  </label>
                  <select
                    name="templateName"
                    value={form.templateName}
                    onChange={handleChange}
                    className="w-full border rounded px-3 py-2"
                  >
                    <option value="">-- Select Template --</option>
                    {templates.map(tpl => (
                      <option key={tpl.name} value={tpl.name}>
                        {tpl.name} ({tpl.language}) ‚Äî {tpl.placeholderCount}{" "}
                        param
                      </option>
                    ))}
                  </select>
                </div>

                {selectedTemplate && (
                  <WhatsAppTemplatePreview template={selectedTemplate} />
                )}
              </>
            )}

            {node.type === "tag" && (
              <div>
                <label className="block font-medium mb-1">
                  Tags (comma-separated)
                </label>
                <input
                  type="text"
                  value={form.tags.join(", ")}
                  onChange={e => {
                    const updated = e.target.value
                      .split(",")
                      .map(tag => tag.trim())
                      .filter(tag => tag !== "");
                    setForm(prev => ({ ...prev, tags: updated }));
                  }}
                  className="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
                  placeholder="e.g. interested, hot-lead"
                />
              </div>
            )}

            {node.type === "wait" && (
              <div>
                <label className="block font-medium mb-1">
                  Wait Time (in seconds)
                </label>
                <input
                  type="number"
                  name="seconds"
                  min="1"
                  value={form.seconds}
                  onChange={handleChange}
                  className="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
                  placeholder="e.g. 3"
                />
              </div>
            )}
          </div>

          <div className="flex justify-end gap-2 pt-6">
            <Button variant="ghost" onClick={onClose}>
              Cancel
            </Button>
            <Button onClick={handleSave}>Save</Button>
          </div>
        </Dialog.Panel>
      </div>
    </Dialog>
  );
}

// import React, { useState, useEffect, useCallback } from "react";
// import { Dialog } from "@headlessui/react";
// import { Button } from "../../../components/ui/button";
// import WhatsAppTemplatePreview from "./WhatsAppTemplatePreview";

// export default function AutoReplyNodeEditor({ node, onClose, onSave }) {
//   const [form, setForm] = useState({
//     text: "",
//     templateName: "",
//     placeholders: [],
//     tags: [],
//     seconds: 1,
//   });

//   const [templates, setTemplates] = useState([]);
//   const [selectedTemplate, setSelectedTemplate] = useState(null);

//   const fetchFullTemplate = async templateName => {
//     const businessId = localStorage.getItem("businessId");
//     try {
//       const res = await fetch(
//         `/api/WhatsAppTemplateFetcher/get-by-name/${businessId}/${templateName}?includeButtons=true`
//       );

//       if (!res.ok) throw new Error("Failed to fetch full template");

//       const json = await res.json();
//       if (json.success) {
//         setSelectedTemplate(json.template);
//       } else {
//         setSelectedTemplate(null);
//         console.warn("‚ö†Ô∏è No template found");
//       }
//     } catch (err) {
//       console.error("‚ùå Failed to fetch full template", err);
//       setSelectedTemplate(null);
//     }
//   };

//   const fetchTemplates = useCallback(async (preselectedName = "") => {
//     const businessId = localStorage.getItem("businessId");
//     try {
//       const res = await fetch(
//         `/api/WhatsAppTemplateFetcher/get-template/${businessId}`
//       );

//       if (!res.ok) throw new Error("Failed to fetch templates");

//       const json = await res.json();
//       if (json.success) {
//         const list = json.templates;
//         setTemplates(list);

//         if (preselectedName) {
//           fetchFullTemplate(preselectedName);
//         }
//       }
//     } catch (err) {
//       console.error("‚ùå Failed to fetch templates", err);
//     }
//   }, []);

//   useEffect(() => {
//     if (!node) return;

//     const { config } = node.data || {};
//     setForm({
//       text: config?.text || "",
//       templateName: config?.templateName || "",
//       placeholders: config?.placeholders || [],
//       tags: config?.tags || [],
//       seconds: config?.seconds || 1,
//     });

//     if (node.type === "template") {
//       fetchTemplates(config?.templateName);
//     }
//   }, [node, fetchTemplates]);

//   const handleChange = async e => {
//     const { name, value } = e.target;

//     setForm(prev => ({
//       ...prev,
//       [name]: name === "seconds" ? parseInt(value) || 1 : value,
//     }));

//     if (name === "templateName") {
//       setSelectedTemplate(null);
//       await fetchFullTemplate(value);
//     }
//   };

//   const handleSave = () => {
//     const updated = {
//       ...node,
//       data: {
//         ...node.data,
//         config: {
//           ...form,
//         },
//       },
//     };
//     onSave(updated);
//     onClose();
//   };

//   if (!node) return null;

//   const isTemplate = node.type === "template";

//   return (
//     <Dialog open={!!node} onClose={onClose} className="relative z-50">
//       <div className="fixed inset-0 bg-black/30" aria-hidden="true" />
//       <div className="fixed inset-0 flex items-center justify-center p-4">
//         <Dialog.Panel className="w-full max-w-lg bg-white rounded-xl shadow-xl border border-gray-200 p-6">
//           <Dialog.Title className="text-lg font-semibold mb-4 text-zinc-800">
//             ‚úèÔ∏è Edit: {node.type}
//           </Dialog.Title>

//           <div className="space-y-4 text-sm text-gray-700">
//             {node.type === "message" && (
//               <div>
//                 <label className="block font-medium mb-1">Text Message</label>
//                 <textarea
//                   name="text"
//                   value={form.text}
//                   onChange={handleChange}
//                   rows={4}
//                   className="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
//                 />
//               </div>
//             )}

//             {isTemplate && (
//               <>
//                 <div>
//                   <label className="block font-medium mb-1">
//                     Choose Template
//                   </label>
//                   <select
//                     name="templateName"
//                     value={form.templateName}
//                     onChange={handleChange}
//                     className="w-full border rounded px-3 py-2"
//                   >
//                     <option value="">-- Select Template --</option>
//                     {templates.map(tpl => (
//                       <option key={tpl.name} value={tpl.name}>
//                         {tpl.name} ({tpl.language}) ‚Äî {tpl.placeholderCount}{" "}
//                         param
//                       </option>
//                     ))}
//                   </select>
//                 </div>

//                 <WhatsAppTemplatePreview template={selectedTemplate} />
//               </>
//             )}

//             {node.type === "tag" && (
//               <div>
//                 <label className="block font-medium mb-1">
//                   Tags (comma-separated)
//                 </label>
//                 <input
//                   type="text"
//                   value={form.tags.join(", ")}
//                   onChange={e => {
//                     const updated = e.target.value
//                       .split(",")
//                       .map(tag => tag.trim())
//                       .filter(tag => tag !== "");
//                     setForm(prev => ({ ...prev, tags: updated }));
//                   }}
//                   className="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
//                   placeholder="e.g. interested, hot-lead"
//                 />
//               </div>
//             )}

//             {node.type === "wait" && (
//               <div>
//                 <label className="block font-medium mb-1">
//                   Wait Time (in seconds)
//                 </label>
//                 <input
//                   type="number"
//                   name="seconds"
//                   min="1"
//                   value={form.seconds}
//                   onChange={handleChange}
//                   className="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
//                   placeholder="e.g. 3"
//                 />
//               </div>
//             )}
//           </div>

//           <div className="flex justify-end gap-2 pt-6">
//             <Button variant="ghost" onClick={onClose}>
//               Cancel
//             </Button>
//             <Button onClick={handleSave}>Save</Button>
//           </div>
//         </Dialog.Panel>
//       </div>
//     </Dialog>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\AutoReplyBuilder\components\AutoReplyNodeStart.jsx 
====================================================== 
 
import React from "react";
import { Handle, Position } from "reactflow";

export default function AutoReplyNodeStart({ data }) {
  return (
    <div className="rounded-md border border-green-400 bg-green-100 px-4 py-2 w-60 shadow-sm text-zinc-800">
      {/* üîó Only Source Handle (no input for Start) */}
      <Handle
        type="source"
        position={Position.Bottom}
        style={{ background: "#22c55e" }}
      />

      <div className="font-medium text-sm">‚úÖ {data.label || "Start"}</div>
      <div className="text-xs text-zinc-600 mt-1">Flow begins here</div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\AutoReplyBuilder\components\AutoReplySidebar.jsx 
====================================================== 
 
import React from "react";
import { MessageSquareText, FileText, Clock3, Tag } from "lucide-react"; // ‚úÖ Icons

const nodeTypes = [
  { type: "message", label: "Send Message", icon: MessageSquareText },
  { type: "template", label: "Send Template", icon: FileText },
  { type: "wait", label: "Wait", icon: Clock3 },
  { type: "tag", label: "Set Tag", icon: Tag },
];

export default function AutoReplySidebar() {
  const onDragStart = (event, nodeType) => {
    event.dataTransfer.setData("application/reactflow", nodeType);
    event.dataTransfer.effectAllowed = "move";
  };

  return (
    <div className="space-y-3">
      {nodeTypes.map(node => {
        const Icon = node.icon;
        return (
          <div
            key={node.type}
            onDragStart={e => onDragStart(e, node.type)}
            draggable
            className="cursor-move flex items-center gap-3 px-4 py-2 rounded-lg border border-gray-300 bg-white hover:shadow-md hover:border-purple-500 transition-all"
          >
            <Icon size={18} className="text-purple-600" />
            <span className="text-sm font-medium text-gray-800">
              {node.label}
            </span>
          </div>
        );
      })}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\AutoReplyBuilder\components\WhatsAppTemplatePreview.jsx 
====================================================== 
 
import React from "react";

/**
 * üìÑ WhatsAppTemplatePreview
 * @param {Object} props.template - Template metadata from backend
 */
export default function WhatsAppTemplatePreview({ template }) {
  if (!template) return null;

  const {
    name,
    language,
    body,
    bodyText,
    placeholderCount,
    hasImageHeader,
    multiButtons = [],
  } = template;

  const finalBody = body || bodyText || "No content";

  return (
    <div className="mt-4 border rounded-md bg-green-50 px-4 py-3 text-sm text-zinc-800 shadow-sm">
      {/* Header */}
      <div className="mb-2">
        <span className="text-xs font-semibold text-green-700">
          üü¢ WhatsApp Template Preview
        </span>
      </div>

      {/* Template Name + Language */}
      <div className="text-xs mb-2 text-zinc-500">
        <span className="mr-2">
          üìÑ <strong>{name}</strong>
        </span>
        <span className="ml-2">üåê {language}</span>
        <span className="ml-2">üî¢ {placeholderCount} placeholders</span>
      </div>

      {/* Image Header */}
      {hasImageHeader && (
        <div className="mb-2 rounded-md bg-gray-200 text-xs text-center text-gray-600 py-1">
          üñºÔ∏è Image Header Enabled
        </div>
      )}

      {/* Body */}
      <div className="bg-white border border-gray-200 rounded-md px-3 py-2 whitespace-pre-wrap">
        {finalBody}
      </div>

      {/* Buttons */}
      {multiButtons.length > 0 && (
        <div className="mt-3 space-y-1">
          {multiButtons.map((btn, index) => (
            <div
              key={index}
              className="flex items-center justify-between border border-green-200 rounded px-3 py-1 bg-green-100 text-xs"
            >
              <div className="font-medium">{btn.buttonText}</div>
              <div className="text-gray-600">
                {btn.buttonType}{" "}
                {btn.targetUrl && (
                  <span className="text-gray-500 italic">
                    ({btn.targetUrl})
                  </span>
                )}
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Businesses\BusinessApprovals.jsx 
====================================================== 
 
// üìÑ src/pages/Businesses/BusinessApprovals.jsx
import { useEffect, useState } from "react";
import { Check, XCircle, PauseCircle } from "lucide-react";
import { confirmAlert } from "react-confirm-alert";
import { toast } from "react-toastify";
import { Navigate } from "react-router-dom";
import axiosClient from "../../api/axiosClient";
import { useAuth } from "../auth/context/pld_AuthContext"; // ‚úÖ use auth context
import "react-confirm-alert/src/react-confirm-alert.css";

// MVP: only admins may view this page (partners/reviewers later)
const allowedRoles = ["admin", "superadmin"];

export default function BusinessApprovals() {
  const {
    isLoading: authLoading,
    role: ctxRole = "",
    hasAllAccess,
  } = useAuth();
  const [businesses, setBusinesses] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [loadingIds, setLoadingIds] = useState({});
  const [unauthorized, setUnauthorized] = useState(false);

  const role = String(ctxRole || "").toLowerCase();

  useEffect(() => {
    // Wait for auth to initialize
    if (authLoading) return;

    // Superadmin override, else role must be allowed
    if (!hasAllAccess && !allowedRoles.includes(role)) {
      setUnauthorized(true);
      return;
    }

    let isMounted = true;
    setLoading(true);
    setError("");

    axiosClient
      .get("/businesses/pending", { withCredentials: true })
      .then(({ data: res }) => {
        if (!isMounted) return;
        if (res?.success && Array.isArray(res?.data)) {
          setBusinesses(res.data);
        } else {
          setBusinesses([]);
        }
      })
      .catch(err => {
        if (!isMounted) return;
        const status = err?.response?.status;
        if (status === 401 || status === 403) {
          setUnauthorized(true);
        } else {
          setError(
            err?.response?.data?.message ||
              err.message ||
              "Failed to fetch businesses"
          );
        }
      })
      .finally(() => isMounted && setLoading(false));

    return () => {
      isMounted = false;
    };
  }, [authLoading, hasAllAccess, role]);

  if (authLoading) {
    // Stable placeholder while auth initializes
    return (
      <div
        data-test-id="business-approvals-auth-loading"
        aria-busy="true"
        style={{ display: "none" }}
      />
    );
  }

  if (unauthorized) return <Navigate to="/no-access" replace />; // ‚úÖ correct route

  const confirmAction = (action, handler) => {
    confirmAlert({
      title: `Confirm ${action}`,
      message: `Are you sure you want to ${action.toLowerCase()} this business?`,
      buttons: [
        { label: "Yes", onClick: handler },
        { label: "No", onClick: () => {} },
      ],
    });
  };

  const handleStatusChange = (id, status) => {
    setLoadingIds(prev => ({ ...prev, [id]: true }));

    axiosClient
      .post(`/businesses/${status.toLowerCase()}/${id}`, null, {
        withCredentials: true,
      })
      .then(() => {
        toast.success(`‚úÖ Business ${status}d successfully`);
        setBusinesses(prev => prev.filter(b => b.businessId !== id));
      })
      .catch(err => {
        const statusCode = err?.response?.status;
        if (statusCode === 401 || statusCode === 403) setUnauthorized(true);
        const msg =
          err?.response?.data?.message ||
          err.message ||
          `Failed to ${status} business`;
        toast.error(msg);
      })
      .finally(() =>
        setLoadingIds(prev => {
          const copy = { ...prev };
          delete copy[id];
          return copy;
        })
      );
  };

  return (
    <div className="p-6 space-y-6">
      {/* üî∞ Page Header */}
      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4 bg-white p-5 rounded-lg shadow">
        <div>
          <h1 className="text-2xl font-bold text-purple-800 mb-1">
            Pending Businesses
          </h1>
          <p className="text-sm text-gray-500">
            Review, Approve or Reject newly signed up businesses.
          </p>
        </div>
      </div>

      {/* üîÑ Loading/Error */}
      {loading && <p className="text-sm text-gray-500">Loading...</p>}
      {error && <p className="text-sm text-red-600">‚ùå {error}</p>}

      {/* üìã Business Table */}
      {!loading && businesses.length === 0 && (
        <div className="bg-white p-6 rounded-lg text-center shadow text-gray-500">
          No pending businesses found.
        </div>
      )}

      {!loading && businesses.length > 0 && (
        <div className="overflow-x-auto bg-white rounded-lg shadow">
          <table className="w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="p-3 text-left">Company</th>
                <th className="p-3 text-left">Email</th>
                <th className="p-3 text-left">Contact</th>
                <th className="p-3 text-left">Plan</th>
                <th className="p-3 text-left">Created At</th>
                <th className="p-3 text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              {businesses.map(b => (
                <tr key={b.businessId} className="border-t hover:bg-gray-50">
                  <td className="p-3 font-medium">{b.companyName}</td>
                  <td className="p-3">{b.businessEmail}</td>
                  <td className="p-3">
                    {b.representativeName || "‚Äî"}
                    <br />
                    {b.phone || ""}
                  </td>
                  <td className="p-3 capitalize">{b.plan}</td>
                  <td className="p-3">
                    {new Date(b.createdAt).toLocaleDateString()}
                  </td>
                  <td className="p-3 flex flex-wrap gap-2 justify-center">
                    {/* ‚úÖ Soft buttons */}
                    <button
                      disabled={!!loadingIds[b.businessId]}
                      onClick={() =>
                        confirmAction("Approve", () =>
                          handleStatusChange(b.businessId, "approve")
                        )
                      }
                      className="flex items-center gap-1 bg-green-100 text-green-700 border border-green-300 hover:bg-green-200 px-3 py-1 rounded-md text-xs disabled:opacity-50"
                    >
                      <Check size={14} /> Approve
                    </button>

                    <button
                      disabled={!!loadingIds[b.businessId]}
                      onClick={() =>
                        confirmAction("Reject", () =>
                          handleStatusChange(b.businessId, "reject")
                        )
                      }
                      className="flex items-center gap-1 bg-red-100 text-red-700 border border-red-300 hover:bg-red-200 px-3 py-1 rounded-md text-xs disabled:opacity-50"
                    >
                      <XCircle size={14} /> Reject
                    </button>

                    <button
                      disabled={!!loadingIds[b.businessId]}
                      onClick={() =>
                        confirmAction("Hold", () =>
                          handleStatusChange(b.businessId, "hold")
                        )
                      }
                      className="flex items-center gap-1 bg-yellow-100 text-yellow-700 border border-yellow-300 hover:bg-yellow-200 px-3 py-1 rounded-md text-xs disabled:opacity-50"
                    >
                      <PauseCircle size={14} /> Hold
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
}

// import { useEffect, useState } from "react";
// import { Check, XCircle, PauseCircle } from "lucide-react";
// import { confirmAlert } from "react-confirm-alert";
// import { toast } from "react-toastify";
// import { Navigate } from "react-router-dom";
// import "react-confirm-alert/src/react-confirm-alert.css";

// const allowedRoles = ["admin", "superadmin", "partner", "reviewer"];

// export default function BusinessApprovals() {
//   const [businesses, setBusinesses] = useState([]);
//   const [loading, setLoading] = useState(true);
//   const [error, setError] = useState("");
//   const [loadingIds, setLoadingIds] = useState({});
//   const [unauthorized, setUnauthorized] = useState(false);

//   const role = localStorage.getItem("role") || "";

//   useEffect(() => {
//     if (!allowedRoles.includes(role)) {
//       setUnauthorized(true);
//       return;
//     }

//     fetch(`${process.env.REACT_APP_API_BASE_URL}/businesses/pending`, {
//       credentials: "include",
//     })
//       .then(res => {
//         if (!res.ok) throw new Error("Failed to fetch businesses");
//         return res.json();
//       })
//       .then(res => {
//         if (res.success && Array.isArray(res.data)) {
//           setBusinesses(res.data);
//         } else {
//           setBusinesses([]);
//         }
//       })
//       .catch(err => setError(err.message))
//       .finally(() => setLoading(false));
//   }, [role]);

//   if (unauthorized) return <Navigate to="/app/no-access" />;

//   const confirmAction = (action, handler) => {
//     confirmAlert({
//       title: `Confirm ${action}`,
//       message: `Are you sure you want to ${action.toLowerCase()} this business?`,
//       buttons: [
//         { label: "Yes", onClick: handler },
//         { label: "No", onClick: () => {} },
//       ],
//     });
//   };

//   const handleStatusChange = (id, status) => {
//     setLoadingIds(prev => ({ ...prev, [id]: true }));

//     fetch(
//       `${
//         process.env.REACT_APP_API_BASE_URL
//       }/businesses/${status.toLowerCase()}/${id}`,
//       {
//         method: "POST",
//         credentials: "include",
//       }
//     )
//       .then(res => {
//         if (!res.ok) throw new Error(`Failed to ${status} business`);
//         return res.json();
//       })
//       .then(() => {
//         toast.success(`‚úÖ Business ${status}d successfully`);
//         setBusinesses(prev => prev.filter(b => b.businessId !== id));
//       })
//       .catch(err => {
//         console.error(err);
//         toast.error(err.message);
//       })
//       .finally(() =>
//         setLoadingIds(prev => {
//           const copy = { ...prev };
//           delete copy[id];
//           return copy;
//         })
//       );
//   };

//   return (
//     <div className="p-6 space-y-6">
//       {/* üî∞ Page Header */}
//       <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4 bg-white p-5 rounded-lg shadow">
//         <div>
//           <h1 className="text-2xl font-bold text-purple-800 mb-1">
//             Pending Businesses
//           </h1>
//           <p className="text-sm text-gray-500">
//             Review, Approve or Reject newly signed up businesses.
//           </p>
//         </div>
//       </div>

//       {/* üîÑ Loading/Error */}
//       {loading && <p className="text-sm text-gray-500">Loading...</p>}
//       {error && <p className="text-sm text-red-600">‚ùå {error}</p>}

//       {/* üìã Business Table */}
//       {!loading && businesses.length === 0 && (
//         <div className="bg-white p-6 rounded-lg text-center shadow text-gray-500">
//           No pending businesses found.
//         </div>
//       )}

//       {!loading && businesses.length > 0 && (
//         <div className="overflow-x-auto bg-white rounded-lg shadow">
//           <table className="w-full text-sm">
//             <thead className="bg-gray-100">
//               <tr>
//                 <th className="p-3 text-left">Company</th>
//                 <th className="p-3 text-left">Email</th>
//                 <th className="p-3 text-left">Contact</th>
//                 <th className="p-3 text-left">Plan</th>
//                 <th className="p-3 text-left">Created At</th>
//                 <th className="p-3 text-center">Actions</th>
//               </tr>
//             </thead>
//             <tbody>
//               {businesses.map(b => (
//                 <tr key={b.businessId} className="border-t hover:bg-gray-50">
//                   <td className="p-3 font-medium">{b.companyName}</td>
//                   <td className="p-3">{b.businessEmail}</td>
//                   <td className="p-3">
//                     {b.representativeName || "‚Äî"}
//                     <br />
//                     {b.phone || ""}
//                   </td>
//                   <td className="p-3 capitalize">{b.plan}</td>
//                   <td className="p-3">
//                     {new Date(b.createdAt).toLocaleDateString()}
//                   </td>
//                   <td className="p-3 flex flex-wrap gap-2 justify-center">
//                     {/* ‚úÖ Soft buttons */}
//                     <button
//                       disabled={loadingIds[b.businessId]}
//                       onClick={() =>
//                         confirmAction("Approve", () =>
//                           handleStatusChange(b.businessId, "approve")
//                         )
//                       }
//                       className="flex items-center gap-1 bg-green-100 text-green-700 border border-green-300 hover:bg-green-200 px-3 py-1 rounded-md text-xs disabled:opacity-50"
//                     >
//                       <Check size={14} /> Approve
//                     </button>

//                     <button
//                       disabled={loadingIds[b.businessId]}
//                       onClick={() =>
//                         confirmAction("Reject", () =>
//                           handleStatusChange(b.businessId, "reject")
//                         )
//                       }
//                       className="flex items-center gap-1 bg-red-100 text-red-700 border border-red-300 hover:bg-red-200 px-3 py-1 rounded-md text-xs disabled:opacity-50"
//                     >
//                       <XCircle size={14} /> Reject
//                     </button>

//                     <button
//                       disabled={loadingIds[b.businessId]}
//                       onClick={() =>
//                         confirmAction("Hold", () =>
//                           handleStatusChange(b.businessId, "hold")
//                         )
//                       }
//                       className="flex items-center gap-1 bg-yellow-100 text-yellow-700 border border-yellow-300 hover:bg-yellow-200 px-3 py-1 rounded-md text-xs disabled:opacity-50"
//                     >
//                       <PauseCircle size={14} /> Hold
//                     </button>
//                   </td>
//                 </tr>
//               ))}
//             </tbody>
//           </table>
//         </div>
//       )}
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Businesses\Businesses_AllFileDump.txt 
====================================================== 
 
Folder and File Content Report
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Businesses\BusinessApprovals.jsx 
====================================================== 
 
// üìÑ src/pages/Businesses/BusinessApprovals.jsx
import { useEffect, useState } from "react";
import { Check, XCircle, PauseCircle } from "lucide-react";
import { confirmAlert } from "react-confirm-alert";
import { toast } from "react-toastify";
import { Navigate } from "react-router-dom";
import axiosClient from "../../api/axiosClient";
import { useAuth } from "../auth/context/pld_AuthContext"; // ‚úÖ use auth context
import "react-confirm-alert/src/react-confirm-alert.css";

// MVP: only admins may view this page (partners/reviewers later)
const allowedRoles = ["admin", "superadmin"];

export default function BusinessApprovals() {
  const {
    isLoading: authLoading,
    role: ctxRole = "",
    hasAllAccess,
  } = useAuth();
  const [businesses, setBusinesses] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [loadingIds, setLoadingIds] = useState({});
  const [unauthorized, setUnauthorized] = useState(false);

  const role = String(ctxRole || "").toLowerCase();

  useEffect(() => {
    // Wait for auth to initialize
    if (authLoading) return;

    // Superadmin override, else role must be allowed
    if (!hasAllAccess && !allowedRoles.includes(role)) {
      setUnauthorized(true);
      return;
    }

    let isMounted = true;
    setLoading(true);
    setError("");

    axiosClient
      .get("/businesses/pending", { withCredentials: true })
      .then(({ data: res }) => {
        if (!isMounted) return;
        if (res?.success && Array.isArray(res?.data)) {
          setBusinesses(res.data);
        } else {
          setBusinesses([]);
        }
      })
      .catch(err => {
        if (!isMounted) return;
        const status = err?.response?.status;
        if (status === 401 || status === 403) {
          setUnauthorized(true);
        } else {
          setError(
            err?.response?.data?.message ||
              err.message ||
              "Failed to fetch businesses"
          );
        }
      })
      .finally(() => isMounted && setLoading(false));

    return () => {
      isMounted = false;
    };
  }, [authLoading, hasAllAccess, role]);

  if (authLoading) {
    // Stable placeholder while auth initializes
    return (
      <div
        data-test-id="business-approvals-auth-loading"
        aria-busy="true"
        style={{ display: "none" }}
      />
    );
  }

  if (unauthorized) return <Navigate to="/no-access" replace />; // ‚úÖ correct route

  const confirmAction = (action, handler) => {
    confirmAlert({
      title: `Confirm ${action}`,
      message: `Are you sure you want to ${action.toLowerCase()} this business?`,
      buttons: [
        { label: "Yes", onClick: handler },
        { label: "No", onClick: () => {} },
      ],
    });
  };

  const handleStatusChange = (id, status) => {
    setLoadingIds(prev => ({ ...prev, [id]: true }));

    axiosClient
      .post(`/businesses/${status.toLowerCase()}/${id}`, null, {
        withCredentials: true,
      })
      .then(() => {
        toast.success(`‚úÖ Business ${status}d successfully`);
        setBusinesses(prev => prev.filter(b => b.businessId !== id));
      })
      .catch(err => {
        const statusCode = err?.response?.status;
        if (statusCode === 401 || statusCode === 403) setUnauthorized(true);
        const msg =
          err?.response?.data?.message ||
          err.message ||
          `Failed to ${status} business`;
        toast.error(msg);
      })
      .finally(() =>
        setLoadingIds(prev => {
          const copy = { ...prev };
          delete copy[id];
          return copy;
        })
      );
  };

  return (
    <div className="p-6 space-y-6">
      {/* üî∞ Page Header */}
      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4 bg-white p-5 rounded-lg shadow">
        <div>
          <h1 className="text-2xl font-bold text-purple-800 mb-1">
            Pending Businesses
          </h1>
          <p className="text-sm text-gray-500">
            Review, Approve or Reject newly signed up businesses.
          </p>
        </div>
      </div>

      {/* üîÑ Loading/Error */}
      {loading && <p className="text-sm text-gray-500">Loading...</p>}
      {error && <p className="text-sm text-red-600">‚ùå {error}</p>}

      {/* üìã Business Table */}
      {!loading && businesses.length === 0 && (
        <div className="bg-white p-6 rounded-lg text-center shadow text-gray-500">
          No pending businesses found.
        </div>
      )}

      {!loading && businesses.length > 0 && (
        <div className="overflow-x-auto bg-white rounded-lg shadow">
          <table className="w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="p-3 text-left">Company</th>
                <th className="p-3 text-left">Email</th>
                <th className="p-3 text-left">Contact</th>
                <th className="p-3 text-left">Plan</th>
                <th className="p-3 text-left">Created At</th>
                <th className="p-3 text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              {businesses.map(b => (
                <tr key={b.businessId} className="border-t hover:bg-gray-50">
                  <td className="p-3 font-medium">{b.companyName}</td>
                  <td className="p-3">{b.businessEmail}</td>
                  <td className="p-3">
                    {b.representativeName || "‚Äî"}
                    <br />
                    {b.phone || ""}
                  </td>
                  <td className="p-3 capitalize">{b.plan}</td>
                  <td className="p-3">
                    {new Date(b.createdAt).toLocaleDateString()}
                  </td>
                  <td className="p-3 flex flex-wrap gap-2 justify-center">
                    {/* ‚úÖ Soft buttons */}
                    <button
                      disabled={!!loadingIds[b.businessId]}
                      onClick={() =>
                        confirmAction("Approve", () =>
                          handleStatusChange(b.businessId, "approve")
                        )
                      }
                      className="flex items-center gap-1 bg-green-100 text-green-700 border border-green-300 hover:bg-green-200 px-3 py-1 rounded-md text-xs disabled:opacity-50"
                    >
                      <Check size={14} /> Approve
                    </button>

                    <button
                      disabled={!!loadingIds[b.businessId]}
                      onClick={() =>
                        confirmAction("Reject", () =>
                          handleStatusChange(b.businessId, "reject")
                        )
                      }
                      className="flex items-center gap-1 bg-red-100 text-red-700 border border-red-300 hover:bg-red-200 px-3 py-1 rounded-md text-xs disabled:opacity-50"
                    >
                      <XCircle size={14} /> Reject
                    </button>

                    <button
                      disabled={!!loadingIds[b.businessId]}
                      onClick={() =>
                        confirmAction("Hold", () =>
                          handleStatusChange(b.businessId, "hold")
                        )
                      }
                      className="flex items-center gap-1 bg-yellow-100 text-yellow-700 border border-yellow-300 hover:bg-yellow-200 px-3 py-1 rounded-md text-xs disabled:opacity-50"
                    >
                      <PauseCircle size={14} /> Hold
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
}

// import { useEffect, useState } from "react";
// import { Check, XCircle, PauseCircle } from "lucide-react";
// import { confirmAlert } from "react-confirm-alert";
// import { toast } from "react-toastify";
// import { Navigate } from "react-router-dom";
// import "react-confirm-alert/src/react-confirm-alert.css";

// const allowedRoles = ["admin", "superadmin", "partner", "reviewer"];

// export default function BusinessApprovals() {
//   const [businesses, setBusinesses] = useState([]);
//   const [loading, setLoading] = useState(true);
//   const [error, setError] = useState("");
//   const [loadingIds, setLoadingIds] = useState({});
//   const [unauthorized, setUnauthorized] = useState(false);

//   const role = localStorage.getItem("role") || "";

//   useEffect(() => {
//     if (!allowedRoles.includes(role)) {
//       setUnauthorized(true);
//       return;
//     }

//     fetch(`${process.env.REACT_APP_API_BASE_URL}/businesses/pending`, {
//       credentials: "include",
//     })
//       .then(res => {
//         if (!res.ok) throw new Error("Failed to fetch businesses");
//         return res.json();
//       })
//       .then(res => {
//         if (res.success && Array.isArray(res.data)) {
//           setBusinesses(res.data);
//         } else {
//           setBusinesses([]);
//         }
//       })
//       .catch(err => setError(err.message))
//       .finally(() => setLoading(false));
//   }, [role]);

//   if (unauthorized) return <Navigate to="/app/no-access" />;

//   const confirmAction = (action, handler) => {
//     confirmAlert({
//       title: `Confirm ${action}`,
//       message: `Are you sure you want to ${action.toLowerCase()} this business?`,
//       buttons: [
//         { label: "Yes", onClick: handler },
//         { label: "No", onClick: () => {} },
//       ],
//     });
//   };

//   const handleStatusChange = (id, status) => {
//     setLoadingIds(prev => ({ ...prev, [id]: true }));

//     fetch(
//       `${
//         process.env.REACT_APP_API_BASE_URL
//       }/businesses/${status.toLowerCase()}/${id}`,
//       {
//         method: "POST",
//         credentials: "include",
//       }
//     )
//       .then(res => {
//         if (!res.ok) throw new Error(`Failed to ${status} business`);
//         return res.json();
//       })
//       .then(() => {
//         toast.success(`‚úÖ Business ${status}d successfully`);
//         setBusinesses(prev => prev.filter(b => b.businessId !== id));
//       })
//       .catch(err => {
//         console.error(err);
//         toast.error(err.message);
//       })
//       .finally(() =>
//         setLoadingIds(prev => {
//           const copy = { ...prev };
//           delete copy[id];
//           return copy;
//         })
//       );
//   };

//   return (
//     <div className="p-6 space-y-6">
//       {/* üî∞ Page Header */}
//       <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4 bg-white p-5 rounded-lg shadow">
//         <div>
//           <h1 className="text-2xl font-bold text-purple-800 mb-1">
//             Pending Businesses
//           </h1>
//           <p className="text-sm text-gray-500">
//             Review, Approve or Reject newly signed up businesses.
//           </p>
//         </div>
//       </div>

//       {/* üîÑ Loading/Error */}
//       {loading && <p className="text-sm text-gray-500">Loading...</p>}
//       {error && <p className="text-sm text-red-600">‚ùå {error}</p>}

//       {/* üìã Business Table */}
//       {!loading && businesses.length === 0 && (
//         <div className="bg-white p-6 rounded-lg text-center shadow text-gray-500">
//           No pending businesses found.
//         </div>
//       )}

//       {!loading && businesses.length > 0 && (
//         <div className="overflow-x-auto bg-white rounded-lg shadow">
//           <table className="w-full text-sm">
//             <thead className="bg-gray-100">
//               <tr>
//                 <th className="p-3 text-left">Company</th>
//                 <th className="p-3 text-left">Email</th>
//                 <th className="p-3 text-left">Contact</th>
//                 <th className="p-3 text-left">Plan</th>
//                 <th className="p-3 text-left">Created At</th>
//                 <th className="p-3 text-center">Actions</th>
//               </tr>
//             </thead>
//             <tbody>
//               {businesses.map(b => (
//                 <tr key={b.businessId} className="border-t hover:bg-gray-50">
//                   <td className="p-3 font-medium">{b.companyName}</td>
//                   <td className="p-3">{b.businessEmail}</td>
//                   <td className="p-3">
//                     {b.representativeName || "‚Äî"}
//                     <br />
//                     {b.phone || ""}
//                   </td>
//                   <td className="p-3 capitalize">{b.plan}</td>
//                   <td className="p-3">
//                     {new Date(b.createdAt).toLocaleDateString()}
//                   </td>
//                   <td className="p-3 flex flex-wrap gap-2 justify-center">
//                     {/* ‚úÖ Soft buttons */}
//                     <button
//                       disabled={loadingIds[b.businessId]}
//                       onClick={() =>
//                         confirmAction("Approve", () =>
//                           handleStatusChange(b.businessId, "approve")
//                         )
//                       }
//                       className="flex items-center gap-1 bg-green-100 text-green-700 border border-green-300 hover:bg-green-200 px-3 py-1 rounded-md text-xs disabled:opacity-50"
//                     >
//                       <Check size={14} /> Approve
//                     </button>

//                     <button
//                       disabled={loadingIds[b.businessId]}
//                       onClick={() =>
//                         confirmAction("Reject", () =>
//                           handleStatusChange(b.businessId, "reject")
//                         )
//                       }
//                       className="flex items-center gap-1 bg-red-100 text-red-700 border border-red-300 hover:bg-red-200 px-3 py-1 rounded-md text-xs disabled:opacity-50"
//                     >
//                       <XCircle size={14} /> Reject
//                     </button>

//                     <button
//                       disabled={loadingIds[b.businessId]}
//                       onClick={() =>
//                         confirmAction("Hold", () =>
//                           handleStatusChange(b.businessId, "hold")
//                         )
//                       }
//                       className="flex items-center gap-1 bg-yellow-100 text-yellow-700 border border-yellow-300 hover:bg-yellow-200 px-3 py-1 rounded-md text-xs disabled:opacity-50"
//                     >
//                       <PauseCircle size={14} /> Hold
//                     </button>
//                   </td>
//                 </tr>
//               ))}
//             </tbody>
//           </table>
//         </div>
//       )}
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Businesses\Businesses_AllFileDump.txt 
====================================================== 
 
Folder and File Content Report
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Businesses\BusinessApprovals.jsx 
====================================================== 
 
// üìÑ src/pages/Businesses/BusinessApprovals.jsx
import { useEffect, useState } from "react";
import { Check, XCircle, PauseCircle } from "lucide-react";
import { confirmAlert } from "react-confirm-alert";
import { toast } from "react-toastify";
import { Navigate } from "react-router-dom";
import axiosClient from "../../api/axiosClient";
import { useAuth } from "../auth/context/pld_AuthContext"; // ‚úÖ use auth context
import "react-confirm-alert/src/react-confirm-alert.css";

// MVP: only admins may view this page (partners/reviewers later)
const allowedRoles = ["admin", "superadmin"];

export default function BusinessApprovals() {
  const {
    isLoading: authLoading,
    role: ctxRole = "",
    hasAllAccess,
  } = useAuth();
  const [businesses, setBusinesses] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [loadingIds, setLoadingIds] = useState({});
  const [unauthorized, setUnauthorized] = useState(false);

  const role = String(ctxRole || "").toLowerCase();

  useEffect(() => {
    // Wait for auth to initialize
    if (authLoading) return;

    // Superadmin override, else role must be allowed
    if (!hasAllAccess && !allowedRoles.includes(role)) {
      setUnauthorized(true);
      return;
    }

    let isMounted = true;
    setLoading(true);
    setError("");

    axiosClient
      .get("/businesses/pending", { withCredentials: true })
      .then(({ data: res }) => {
        if (!isMounted) return;
        if (res?.success && Array.isArray(res?.data)) {
          setBusinesses(res.data);
        } else {
          setBusinesses([]);
        }
      })
      .catch(err => {
        if (!isMounted) return;
        const status = err?.response?.status;
        if (status === 401 || status === 403) {
          setUnauthorized(true);
        } else {
          setError(
            err?.response?.data?.message ||
              err.message ||
              "Failed to fetch businesses"
          );
        }
      })
      .finally(() => isMounted && setLoading(false));

    return () => {
      isMounted = false;
    };
  }, [authLoading, hasAllAccess, role]);

  if (authLoading) {
    // Stable placeholder while auth initializes
    return (
      <div
        data-test-id="business-approvals-auth-loading"
        aria-busy="true"
        style={{ display: "none" }}
      />
    );
  }

  if (unauthorized) return <Navigate to="/no-access" replace />; // ‚úÖ correct route

  const confirmAction = (action, handler) => {
    confirmAlert({
      title: `Confirm ${action}`,
      message: `Are you sure you want to ${action.toLowerCase()} this business?`,
      buttons: [
        { label: "Yes", onClick: handler },
        { label: "No", onClick: () => {} },
      ],
    });
  };

  const handleStatusChange = (id, status) => {
    setLoadingIds(prev => ({ ...prev, [id]: true }));

    axiosClient
      .post(`/businesses/${status.toLowerCase()}/${id}`, null, {
        withCredentials: true,
      })
      .then(() => {
        toast.success(`‚úÖ Business ${status}d successfully`);
        setBusinesses(prev => prev.filter(b => b.businessId !== id));
      })
      .catch(err => {
        const statusCode = err?.response?.status;
        if (statusCode === 401 || statusCode === 403) setUnauthorized(true);
        const msg =
          err?.response?.data?.message ||
          err.message ||
          `Failed to ${status} business`;
        toast.error(msg);
      })
      .finally(() =>
        setLoadingIds(prev => {
          const copy = { ...prev };
          delete copy[id];
          return copy;
        })
      );
  };

  return (
    <div className="p-6 space-y-6">
      {/* üî∞ Page Header */}
      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4 bg-white p-5 rounded-lg shadow">
        <div>
          <h1 className="text-2xl font-bold text-purple-800 mb-1">
            Pending Businesses
          </h1>
          <p className="text-sm text-gray-500">
            Review, Approve or Reject newly signed up businesses.
          </p>
        </div>
      </div>

      {/* üîÑ Loading/Error */}
      {loading && <p className="text-sm text-gray-500">Loading...</p>}
      {error && <p className="text-sm text-red-600">‚ùå {error}</p>}

      {/* üìã Business Table */}
      {!loading && businesses.length === 0 && (
        <div className="bg-white p-6 rounded-lg text-center shadow text-gray-500">
          No pending businesses found.
        </div>
      )}

      {!loading && businesses.length > 0 && (
        <div className="overflow-x-auto bg-white rounded-lg shadow">
          <table className="w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="p-3 text-left">Company</th>
                <th className="p-3 text-left">Email</th>
                <th className="p-3 text-left">Contact</th>
                <th className="p-3 text-left">Plan</th>
                <th className="p-3 text-left">Created At</th>
                <th className="p-3 text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              {businesses.map(b => (
                <tr key={b.businessId} className="border-t hover:bg-gray-50">
                  <td className="p-3 font-medium">{b.companyName}</td>
                  <td className="p-3">{b.businessEmail}</td>
                  <td className="p-3">
                    {b.representativeName || "‚Äî"}
                    <br />
                    {b.phone || ""}
                  </td>
                  <td className="p-3 capitalize">{b.plan}</td>
                  <td className="p-3">
                    {new Date(b.createdAt).toLocaleDateString()}
                  </td>
                  <td className="p-3 flex flex-wrap gap-2 justify-center">
                    {/* ‚úÖ Soft buttons */}
                    <button
                      disabled={!!loadingIds[b.businessId]}
                      onClick={() =>
                        confirmAction("Approve", () =>
                          handleStatusChange(b.businessId, "approve")
                        )
                      }
                      className="flex items-center gap-1 bg-green-100 text-green-700 border border-green-300 hover:bg-green-200 px-3 py-1 rounded-md text-xs disabled:opacity-50"
                    >
                      <Check size={14} /> Approve
                    </button>

                    <button
                      disabled={!!loadingIds[b.businessId]}
                      onClick={() =>
                        confirmAction("Reject", () =>
                          handleStatusChange(b.businessId, "reject")
                        )
                      }
                      className="flex items-center gap-1 bg-red-100 text-red-700 border border-red-300 hover:bg-red-200 px-3 py-1 rounded-md text-xs disabled:opacity-50"
                    >
                      <XCircle size={14} /> Reject
                    </button>

                    <button
                      disabled={!!loadingIds[b.businessId]}
                      onClick={() =>
                        confirmAction("Hold", () =>
                          handleStatusChange(b.businessId, "hold")
                        )
                      }
                      className="flex items-center gap-1 bg-yellow-100 text-yellow-700 border border-yellow-300 hover:bg-yellow-200 px-3 py-1 rounded-md text-xs disabled:opacity-50"
                    >
                      <PauseCircle size={14} /> Hold
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
}

// import { useEffect, useState } from "react";
// import { Check, XCircle, PauseCircle } from "lucide-react";
// import { confirmAlert } from "react-confirm-alert";
// import { toast } from "react-toastify";
// import { Navigate } from "react-router-dom";
// import "react-confirm-alert/src/react-confirm-alert.css";

// const allowedRoles = ["admin", "superadmin", "partner", "reviewer"];

// export default function BusinessApprovals() {
//   const [businesses, setBusinesses] = useState([]);
//   const [loading, setLoading] = useState(true);
//   const [error, setError] = useState("");
//   const [loadingIds, setLoadingIds] = useState({});
//   const [unauthorized, setUnauthorized] = useState(false);

//   const role = localStorage.getItem("role") || "";

//   useEffect(() => {
//     if (!allowedRoles.includes(role)) {
//       setUnauthorized(true);
//       return;
//     }

//     fetch(`${process.env.REACT_APP_API_BASE_URL}/businesses/pending`, {
//       credentials: "include",
//     })
//       .then(res => {
//         if (!res.ok) throw new Error("Failed to fetch businesses");
//         return res.json();
//       })
//       .then(res => {
//         if (res.success && Array.isArray(res.data)) {
//           setBusinesses(res.data);
//         } else {
//           setBusinesses([]);
//         }
//       })
//       .catch(err => setError(err.message))
//       .finally(() => setLoading(false));
//   }, [role]);

//   if (unauthorized) return <Navigate to="/app/no-access" />;

//   const confirmAction = (action, handler) => {
//     confirmAlert({
//       title: `Confirm ${action}`,
//       message: `Are you sure you want to ${action.toLowerCase()} this business?`,
//       buttons: [
//         { label: "Yes", onClick: handler },
//         { label: "No", onClick: () => {} },
//       ],
//     });
//   };

//   const handleStatusChange = (id, status) => {
//     setLoadingIds(prev => ({ ...prev, [id]: true }));

//     fetch(
//       `${
//         process.env.REACT_APP_API_BASE_URL
//       }/businesses/${status.toLowerCase()}/${id}`,
//       {
//         method: "POST",
//         credentials: "include",
//       }
//     )
//       .then(res => {
//         if (!res.ok) throw new Error(`Failed to ${status} business`);
//         return res.json();
//       })
//       .then(() => {
//         toast.success(`‚úÖ Business ${status}d successfully`);
//         setBusinesses(prev => prev.filter(b => b.businessId !== id));
//       })
//       .catch(err => {
//         console.error(err);
//         toast.error(err.message);
//       })
//       .finally(() =>
//         setLoadingIds(prev => {
//           const copy = { ...prev };
//           delete copy[id];
//           return copy;
//         })
//       );
//   };

//   return (
//     <div className="p-6 space-y-6">
//       {/* üî∞ Page Header */}
//       <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4 bg-white p-5 rounded-lg shadow">
//         <div>
//           <h1 className="text-2xl font-bold text-purple-800 mb-1">
//             Pending Businesses
//           </h1>
//           <p className="text-sm text-gray-500">
//             Review, Approve or Reject newly signed up businesses.
//           </p>
//         </div>
//       </div>

//       {/* üîÑ Loading/Error */}
//       {loading && <p className="text-sm text-gray-500">Loading...</p>}
//       {error && <p className="text-sm text-red-600">‚ùå {error}</p>}

//       {/* üìã Business Table */}
//       {!loading && businesses.length === 0 && (
//         <div className="bg-white p-6 rounded-lg text-center shadow text-gray-500">
//           No pending businesses found.
//         </div>
//       )}

//       {!loading && businesses.length > 0 && (
//         <div className="overflow-x-auto bg-white rounded-lg shadow">
//           <table className="w-full text-sm">
//             <thead className="bg-gray-100">
//               <tr>
//                 <th className="p-3 text-left">Company</th>
//                 <th className="p-3 text-left">Email</th>
//                 <th className="p-3 text-left">Contact</th>
//                 <th className="p-3 text-left">Plan</th>
//                 <th className="p-3 text-left">Created At</th>
//                 <th className="p-3 text-center">Actions</th>
//               </tr>
//             </thead>
//             <tbody>
//               {businesses.map(b => (
//                 <tr key={b.businessId} className="border-t hover:bg-gray-50">
//                   <td className="p-3 font-medium">{b.companyName}</td>
//                   <td className="p-3">{b.businessEmail}</td>
//                   <td className="p-3">
//                     {b.representativeName || "‚Äî"}
//                     <br />
//                     {b.phone || ""}
//                   </td>
//                   <td className="p-3 capitalize">{b.plan}</td>
//                   <td className="p-3">
//                     {new Date(b.createdAt).toLocaleDateString()}
//                   </td>
//                   <td className="p-3 flex flex-wrap gap-2 justify-center">
//                     {/* ‚úÖ Soft buttons */}
//                     <button
//                       disabled={loadingIds[b.businessId]}
//                       onClick={() =>
//                         confirmAction("Approve", () =>
//                           handleStatusChange(b.businessId, "approve")
//                         )
//                       }
//                       className="flex items-center gap-1 bg-green-100 text-green-700 border border-green-300 hover:bg-green-200 px-3 py-1 rounded-md text-xs disabled:opacity-50"
//                     >
//                       <Check size={14} /> Approve
//                     </button>

//                     <button
//                       disabled={loadingIds[b.businessId]}
//                       onClick={() =>
//                         confirmAction("Reject", () =>
//                           handleStatusChange(b.businessId, "reject")
//                         )
//                       }
//                       className="flex items-center gap-1 bg-red-100 text-red-700 border border-red-300 hover:bg-red-200 px-3 py-1 rounded-md text-xs disabled:opacity-50"
//                     >
//                       <XCircle size={14} /> Reject
//                     </button>

//                     <button
//                       disabled={loadingIds[b.businessId]}
//                       onClick={() =>
//                         confirmAction("Hold", () =>
//                           handleStatusChange(b.businessId, "hold")
//                         )
//                       }
//                       className="flex items-center gap-1 bg-yellow-100 text-yellow-700 border border-yellow-300 hover:bg-yellow-200 px-3 py-1 rounded-md text-xs disabled:opacity-50"
//                     >
//                       <PauseCircle size={14} /> Hold
//                     </button>
//                   </td>
//                 </tr>
//               ))}
//             </tbody>
//           </table>
//         </div>
//       )}
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Businesses\Businesses_AllFileDump.txt 
====================================================== 
 
Folder and F 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Businesses\CatalogDashboard.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axios from "axios";
import { useNavigate } from "react-router-dom"; // ‚úÖ For redirect
import { usePlan } from "../auth/hooks/usePlan"; // ‚úÖ Plan protection
import StatCard from "../../components/StatCard";

function CatalogDashboard() {
  const navigate = useNavigate();
  const { plan, hasPlan } = usePlan(); // ‚úÖ Check user plan

  const [summary, setSummary] = useState(null);
  const [topProducts, setTopProducts] = useState([]);
  const [ctaStats, setCtaStats] = useState([]);
  const [productCtaStats, setProductCtaStats] = useState([]);

  const businessId = "11111111-1111-1111-1111-111111111111"; // Temp

  // ‚úÖ Step 1: Redirect if user is on basic plan
  useEffect(() => {
    if (plan === "basic") {
      navigate("/plans/upgrade");
    }
  }, [plan, navigate]);

  useEffect(() => {
    if (!hasPlan("smart")) return; // Stop if plan is not eligible

    const fetchDashboardData = async () => {
      try {
        const summaryRes = await axios.get(
          `https://localhost:7113/api/catalog-dashboard/summary?businessId=${businessId}`
        );
        setSummary(summaryRes.data);

        const topRes = await axios.get(
          `https://localhost:7113/api/catalog-dashboard/top-products?businessId=${businessId}`
        );
        setTopProducts(topRes.data);

        const ctaRes = await axios.get(
          `https://localhost:7113/api/catalog-dashboard/cta-summary?businessId=${businessId}`
        );
        setCtaStats(ctaRes.data);

        const heatmapRes = await axios.get(
          `https://localhost:7113/api/catalog-dashboard/product-cta-breakdown?businessId=${businessId}`
        );
        setProductCtaStats(heatmapRes.data);
      } catch (err) {
        console.error("‚ùå Failed to load dashboard data:", err);
      }
    };

    if (businessId) {
      fetchDashboardData();
    }
  }, [businessId, hasPlan]);

  // ‚úÖ Step 2: Optional fallback while redirecting
  if (plan === "basic") {
    return (
      <div className="p-6 text-center text-red-600 font-semibold">
        üö´ This feature is only available on the Smart or Advanced plan.
      </div>
    );
  }

  return (
    <div className="p-6">
      <h2 className="text-xl font-semibold text-purple-700 mb-4">
        üìä Catalog Dashboard
      </h2>

      {!summary ? (
        <p>Loading insights...</p>
      ) : (
        <>
          {/* Stat Cards */}
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <StatCard
              title="üì§ Messages Sent"
              value={summary.totalMessagesSent}
            />
            <StatCard
              title="üë• Unique Customers"
              value={summary.uniqueCustomersMessaged}
            />
            <StatCard title="üõçÔ∏è Product Clicks" value={summary.productClicks} />
            <StatCard
              title="üì¶ Active Products"
              value={summary.activeProducts}
            />
            <StatCard
              title="üì≤ Products Shared"
              value={summary.productsSharedViaWhatsApp}
            />
            <StatCard
              title="üîÅ Repeat Clickers"
              value={summary.repeatClickers}
            />
            <StatCard
              title="üÜï New Clickers Today"
              value={summary.newClickersToday}
            />
            <StatCard
              title="üïí Last Catalog Click"
              value={
                summary.lastCatalogClickAt
                  ? new Date(summary.lastCatalogClickAt).toLocaleString()
                  : "‚Äî"
              }
            />
            <StatCard
              title="üïí Last Message Sent"
              value={
                summary.lastMessageSentAt
                  ? new Date(summary.lastMessageSentAt).toLocaleString()
                  : "‚Äî"
              }
            />
          </div>

          {/* Top Products */}
          <h3 className="text-lg font-semibold text-purple-700 mt-10 mb-4">
            üîù Top Clicked Products
          </h3>
          {topProducts.length === 0 ? (
            <p className="text-gray-500">No product clicks recorded yet.</p>
          ) : (
            <ul className="space-y-2">
              {topProducts.map((product, index) => (
                <li
                  key={product.productId}
                  className="p-3 bg-white border rounded-xl shadow-sm flex justify-between"
                >
                  <span>
                    #{index + 1} - <strong>{product.productName}</strong>
                  </span>
                  <span className="text-purple-600 font-bold">
                    {product.clickCount} clicks
                  </span>
                </li>
              ))}
            </ul>
          )}

          {/* CTA Journey */}
          <h3 className="text-lg font-semibold text-purple-700 mt-10 mb-4">
            üß≠ CTA Journey Breakdown
          </h3>
          {ctaStats.length === 0 ? (
            <p className="text-gray-500">No CTA interactions recorded yet.</p>
          ) : (
            <ul className="space-y-2">
              {ctaStats.map((cta, index) => (
                <li
                  key={index}
                  className="p-3 bg-white border rounded-xl shadow-sm flex justify-between"
                >
                  <span>
                    <strong>{cta.ctaJourney}</strong>
                  </span>
                  <span className="text-purple-600 font-bold">
                    {cta.clickCount} clicks
                  </span>
                </li>
              ))}
            </ul>
          )}

          {/* Product CTA Heatmap */}
          <h3 className="text-lg font-semibold text-purple-700 mt-10 mb-4">
            üî• Product-wise CTA Click Heatmap
          </h3>
          {productCtaStats.length === 0 ? (
            <p className="text-gray-500">No product-specific CTA data found.</p>
          ) : (
            <table className="w-full text-sm bg-white rounded-xl shadow border">
              <thead className="bg-purple-50 text-purple-800 font-semibold">
                <tr>
                  <th className="px-4 py-2">Product</th>
                  <th className="px-4 py-2">CTA Type</th>
                  <th className="px-4 py-2">Clicks</th>
                </tr>
              </thead>
              <tbody>
                {productCtaStats.map((entry, index) => (
                  <tr key={index} className="border-t">
                    <td className="px-4 py-2">{entry.productName}</td>
                    <td className="px-4 py-2">{entry.ctaJourney}</td>
                    <td className="px-4 py-2 font-bold text-purple-700">
                      {entry.clickCount}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </>
      )}
    </div>
  );
}

export default CatalogDashboard;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Businesses\Dashboard.jsx 
====================================================== 
 
import React from "react";

// We will create and import these widgets in the upcoming steps
// import QuickActionsWidget from '@/components/Dashboard/QuickActionsWidget';
// import CampaignStatsWidget from '@/components/Dashboard/CampaignStatsWidget';
// import CrmGrowthWidget from '@/components/Dashboard/CrmGrowthWidget';
// import TopCampaignsWidget from '@/components/Dashboard/TopCampaignsWidget';

export default function Dashboard() {
  return (
    <div className="space-y-6 p-6">
      <div className="flex justify-between items-center">
        <h1
          className="text-3xl font-bold text-gray-800 flex items-center gap-2"
          style={{ fontFamily: "Plus Jakarta Sans, sans-serif" }}
        >
          <span className="text-blue-600">üìä</span>
          Dashboard
        </h1>
        {/* Placeholder for a future Date Range Picker */}
      </div>

      {/* Placeholder for Quick Actions */}
      <div className="bg-white p-4 rounded-lg shadow">
        <p className="text-center text-gray-500">
          Quick Actions Widget will be here.
        </p>
      </div>

      {/* Main grid for stats */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div className="bg-white p-4 rounded-lg shadow">
          <p className="text-center text-gray-500">
            Campaign Stats Widget will be here.
          </p>
        </div>
        <div className="bg-white p-4 rounded-lg shadow">
          <p className="text-center text-gray-500">
            CRM Growth Widget will be here.
          </p>
        </div>
        <div className="bg-white p-4 rounded-lg shadow col-span-1 lg:col-span-2">
          <p className="text-center text-gray-500">
            Top Campaigns Widget will be here.
          </p>
        </div>
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Businesses\Dashboard_old.jsx 
====================================================== 
 
import { useEffect, useState } from "react";
import {
  PieChart,
  Pie,
  Cell,
  Tooltip,
  ResponsiveContainer,
  LineChart,
  Line,
  XAxis,
  YAxis,
  Legend,
} from "recharts";

const COLORS = ["#10B981", "#EF4444"];

function Dashboard() {
  const [stats, setStats] = useState({
    totalMessages: 0,
    successCount: 0,
    failCount: 0,
  });

  const [logs, setLogs] = useState([]);

  useEffect(() => {
    // Simulated API data fetch
    setTimeout(() => {
      setStats({
        totalMessages: 120,
        successCount: 100,
        failCount: 20,
      });

      setLogs([
        {
          name: "Rahul",
          phone: "+919876543210",
          message: "Hello",
          status: "Success",
          createdAt: "2025-04-03 12:00",
        },
        {
          name: "Anjali",
          phone: "+919812345678",
          message: "Test",
          status: "Failed",
          createdAt: "2025-04-03 12:10",
        },
      ]);
    }, 500);
  }, []);

  const chartData = [
    { name: "Success", value: stats.successCount },
    { name: "Failed", value: stats.failCount },
  ];

  const lineData = logs.map((log, index) => ({
    name: log.createdAt,
    Success: log.status === "Success" ? 1 : 0,
    Failed: log.status === "Failed" ? 1 : 0,
  }));

  return (
    <div className="space-y-10">
      {/* Widgets */}
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <div className="bg-white rounded-xl shadow p-6">
          <h3 className="text-sm text-gray-500 mb-1">Total Messages</h3>
          <p className="text-3xl font-bold text-purple-600">
            {stats.totalMessages}
          </p>
        </div>

        <div className="bg-white rounded-xl shadow p-6">
          <h3 className="text-sm text-gray-500 mb-1">Successful</h3>
          <p className="text-3xl font-bold text-green-500">
            {stats.successCount}
          </p>
        </div>

        <div className="bg-white rounded-xl shadow p-6">
          <h3 className="text-sm text-gray-500 mb-1">Failed</h3>
          <p className="text-3xl font-bold text-red-500">{stats.failCount}</p>
        </div>
      </div>

      {/* Pie Chart */}
      <div className="bg-white rounded-xl shadow p-6">
        <h3 className="text-lg font-semibold mb-4">Message Success Rate</h3>
        <ResponsiveContainer width="100%" height={250}>
          <PieChart>
            <Pie
              data={chartData}
              cx="50%"
              cy="50%"
              outerRadius={80}
              label
              dataKey="value"
            >
              {chartData.map((entry, index) => (
                <Cell
                  key={`cell-${index}`}
                  fill={COLORS[index % COLORS.length]}
                />
              ))}
            </Pie>
            <Tooltip />
          </PieChart>
        </ResponsiveContainer>
      </div>

      {/* Line Chart */}
      <div className="bg-white rounded-xl shadow p-6">
        <h3 className="text-lg font-semibold mb-4">
          Success vs Failed Over Time
        </h3>
        <ResponsiveContainer width="100%" height={250}>
          <LineChart data={lineData}>
            <XAxis dataKey="name" />
            <YAxis allowDecimals={false} />
            <Tooltip />
            <Legend />
            <Line
              type="monotone"
              dataKey="Success"
              stroke="#10B981"
              strokeWidth={2}
            />
            <Line
              type="monotone"
              dataKey="Failed"
              stroke="#EF4444"
              strokeWidth={2}
            />
          </LineChart>
        </ResponsiveContainer>
      </div>

      {/* Message Log Table */}
      <div className="bg-white rounded-xl shadow p-6 overflow-auto">
        <h3 className="text-lg font-semibold mb-4">Recent Message Logs</h3>
        <table className="w-full text-sm text-left">
          <thead>
            <tr className="text-gray-600 border-b">
              <th className="p-2">Name</th>
              <th className="p-2">Phone</th>
              <th className="p-2">Message</th>
              <th className="p-2">Status</th>
              <th className="p-2">Time</th>
            </tr>
          </thead>
          <tbody>
            {logs.map((log, index) => (
              <tr key={index} className="border-t">
                <td className="p-2">{log.name}</td>
                <td className="p-2">{log.phone}</td>
                <td className="p-2">{log.message}</td>
                <td
                  className={`p-2 font-medium ${
                    log.status === "Success" ? "text-green-600" : "text-red-600"
                  }`}
                >
                  {log.status}
                </td>
                <td className="p-2">{log.createdAt}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}

export default Dashboard;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Businesses\ExtrackAllFiles.bat 
====================================================== 
 
@echo off
REM This script will find all files and output their name and content into one file.
REM The output file will be named [FolderName]_AllFileDump.txt.

REM Get the current folder's name and set it as the output file name with the custom suffix
for %%I in ("%cd%") do set "outputFile=%%~nI_AllFileDump.txt"

REM Clear the output file to start fresh
> "%outputFile%" (echo Folder and File Content Report)
echo. >> "%outputFile%"

REM Loop through all files in the current directory and subdirectories
for /R . %%F in (*.*) do (
    echo ====================================================== >> "%outputFile%"
    echo FILE: %%F >> "%outputFile%"
    echo ====================================================== >> "%outputFile%"
    echo. >> "%outputFile%"
    type "%%F" >> "%outputFile%" 2>nul
    echo. >> "%outputFile%"
    echo. >> "%outputFile%"
)

echo Finished! All content has been extracted to %outputFile% 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Businesses\MessageHistory.jsx 
====================================================== 
 
import { useEffect, useState } from "react";
import {
  FileDown,
  FileSpreadsheet,
  FileText,
  ArrowDownAZ,
  ArrowUpZA,
} from "lucide-react";
import * as XLSX from "xlsx";
import jsPDF from "jspdf";
import autoTable from "jspdf-autotable";
import { toast } from "react-toastify";
import "react-toastify/dist/ReactToastify.css";
import { ToastContainer } from "react-toastify";

function MessageHistory() {
  const [logs, setLogs] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [searchTerm, setSearchTerm] = useState("");
  const [currentPage, setCurrentPage] = useState(1);
  const [sortField, setSortField] = useState(null);
  const [sortOrder, setSortOrder] = useState("asc");
  const itemsPerPage = 5;

  useEffect(() => {
    fetch("https://localhost:7113/api/messagelogs")
      .then(res => {
        if (!res.ok) throw new Error("Failed to fetch logs");
        return res.json();
      })
      .then(data => setLogs(data))
      .catch(err => setError(err.message))
      .finally(() => setLoading(false));
  }, []);

  const filteredLogs = logs.filter(log => {
    const lower = searchTerm.toLowerCase();
    return (
      log.name?.toLowerCase().includes(lower) ||
      log.phone?.toLowerCase().includes(lower) ||
      log.message?.toLowerCase().includes(lower) ||
      log.status?.toLowerCase().includes(lower)
    );
  });

  const sortedLogs = [...filteredLogs].sort((a, b) => {
    if (!sortField) return 0;
    const aVal = a[sortField]?.toString().toLowerCase() || "";
    const bVal = b[sortField]?.toString().toLowerCase() || "";
    return sortOrder === "asc"
      ? aVal.localeCompare(bVal)
      : bVal.localeCompare(aVal);
  });

  const paginatedLogs = sortedLogs.slice(
    (currentPage - 1) * itemsPerPage,
    currentPage * itemsPerPage
  );

  const totalPages = Math.ceil(filteredLogs.length / itemsPerPage);

  const handleSort = field => {
    if (sortField === field) {
      setSortOrder(sortOrder === "asc" ? "desc" : "asc");
    } else {
      setSortField(field);
      setSortOrder("asc");
    }
  };

  const exportCSV = () => {
    try {
      const headers = ["Name", "Phone", "Message", "Status", "Date"];
      const rows = filteredLogs.map(log => [
        log.name,
        log.phone,
        log.message,
        log.status,
        log.createdAt,
      ]);

      const csvContent = [
        headers.join(","),
        ...rows.map(row => row.map(cell => `"${cell}"`).join(",")),
      ].join("\n");

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `xbytechat_logs_${Date.now()}.csv`;
      link.click();

      toast.success("CSV exported successfully!");
    } catch (error) {
      toast.error("Failed to export CSV.");
    }
  };

  const exportExcel = () => {
    try {
      const ws = XLSX.utils.json_to_sheet(filteredLogs);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Logs");
      XLSX.writeFile(wb, `xbytechat_logs_${Date.now()}.xlsx`);

      toast.success("Excel exported successfully!");
    } catch (error) {
      toast.error("Failed to export Excel.");
    }
  };

  const exportPDF = () => {
    try {
      const doc = new jsPDF();
      doc.text("xByteChat - Message Logs", 14, 10);
      doc.setFontSize(8);
      doc.setTextColor(180);
      doc.text("Generated by xByteChat", 14, 16);

      autoTable(doc, {
        head: [["Name", "Phone", "Message", "Status", "Date"]],
        body: filteredLogs.map(log => [
          log.name,
          log.phone,
          log.message,
          log.status,
          log.createdAt,
        ]),
        startY: 20,
      });

      doc.save(`xbytechat_logs_${Date.now()}.pdf`);
      toast.success("PDF exported successfully!");
    } catch (error) {
      toast.error("Failed to export PDF.");
    }
  };

  const getSortIcon = field => {
    if (sortField !== field) return null;
    return sortOrder === "asc" ? (
      <ArrowDownAZ size={14} />
    ) : (
      <ArrowUpZA size={14} />
    );
  };

  return (
    <div className="bg-white p-6 rounded-xl shadow">
      <ToastContainer />
      <h2 className="text-xl font-bold mb-4">üìú All Message Logs</h2>

      <input
        type="text"
        placeholder="üîç Search by name, phone, message, status"
        className="mb-4 w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500"
        value={searchTerm}
        onChange={e => setSearchTerm(e.target.value)}
      />

      {loading && (
        <div className="w-full bg-gray-200 rounded-full overflow-hidden h-2 mb-4">
          <div className="bg-purple-600 h-2 animate-pulse w-full"></div>
        </div>
      )}

      {error && <p className="text-red-600">‚ùå {error}</p>}

      {!loading && !error && (
        <>
          <div className="flex gap-3 mb-4">
            <button
              onClick={exportCSV}
              className="flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded-xl hover:bg-purple-700 text-sm"
            >
              <FileDown size={16} /> CSV
            </button>
            <button
              onClick={exportExcel}
              className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-xl hover:bg-green-700 text-sm"
            >
              <FileSpreadsheet size={16} /> Excel
            </button>
            <button
              onClick={exportPDF}
              className="flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded-xl hover:bg-red-700 text-sm"
            >
              <FileText size={16} /> PDF
            </button>
          </div>

          <div className="overflow-auto">
            <table className="w-full text-sm text-left">
              <thead className="bg-gray-100 text-gray-600">
                <tr>
                  <th
                    className="p-2 cursor-pointer"
                    onClick={() => handleSort("name")}
                  >
                    Name {getSortIcon("name")}
                  </th>
                  <th
                    className="p-2 cursor-pointer"
                    onClick={() => handleSort("phone")}
                  >
                    Phone {getSortIcon("phone")}
                  </th>
                  <th
                    className="p-2 cursor-pointer"
                    onClick={() => handleSort("message")}
                  >
                    Message {getSortIcon("message")}
                  </th>
                  <th
                    className="p-2 cursor-pointer"
                    onClick={() => handleSort("status")}
                  >
                    Status {getSortIcon("status")}
                  </th>
                  <th
                    className="p-2 cursor-pointer"
                    onClick={() => handleSort("createdAt")}
                  >
                    Date {getSortIcon("createdAt")}
                  </th>
                </tr>
              </thead>
              <tbody>
                {paginatedLogs.map((log, index) => (
                  <tr key={index} className="border-t">
                    <td className="p-2">{log.name}</td>
                    <td className="p-2">{log.phone}</td>
                    <td className="p-2">{log.message}</td>
                    <td
                      className={`p-2 font-semibold ${
                        log.status === "Success"
                          ? "text-green-600"
                          : "text-red-600"
                      }`}
                    >
                      {log.status}
                    </td>
                    <td className="p-2">{log.createdAt}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {/* Pagination Controls */}
          <div className="mt-6 flex justify-center gap-2">
            {Array.from({ length: totalPages }, (_, i) => i + 1).map(page => (
              <button
                key={page}
                onClick={() => setCurrentPage(page)}
                className={`px-3 py-1 rounded-full text-sm border ${
                  page === currentPage
                    ? "bg-purple-600 text-white border-purple-600"
                    : "bg-white text-gray-700 hover:bg-gray-100"
                }`}
              >
                {page}
              </button>
            ))}
          </div>
        </>
      )}
    </div>
  );
}

export default MessageHistory;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Businesses\ProductCatalog.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../api/axiosClient";
import { useNavigate } from "react-router-dom";
import { toast } from "react-toastify";

function ProductCatalog() {
  const [products, setProducts] = useState([]);
  const navigate = useNavigate();

  const businessId =
    localStorage.getItem("businessId") ||
    "11111111-1111-1111-1111-111111111111";
  const businessNumber =
    localStorage.getItem("whatsappNumber") || "917082156227";

  // üîÑ Fetch products
  useEffect(() => {
    axiosClient
      .get(`/product?businessId=${businessId}`)
      .then(res => setProducts(res.data))
      .catch(() => toast.error("‚ùå Error fetching products"));
  }, [businessId]);

  // üì§ Share on WhatsApp
  const shareOnWhatsApp = async product => {
    const trackingPayload = {
      businessId,
      productId: product.id,
      userId: "customer-001", // dynamic later
      userName: "Amit Sharma",
      userPhone: "9876543210",
      botId: "bot-01",
      categoryBrowsed: "Ads",
      productBrowsed: product.name,
      ctaJourney: "BuyNow",
      refMessageId: "",
    };

    try {
      await axiosClient.post("/catalog-tracking/log-click", trackingPayload);
      console.log("‚úÖ Click tracked successfully.");
    } catch (err) {
      console.error("‚ùå Failed to track click:", err);
    }

    const message = `üõçÔ∏è *${product.name}*\n${product.description}\nüí∞ Price: ‚Çπ${product.price} ${product.currency}`;
    const encoded = encodeURIComponent(message);
    const waLink = `https://wa.me/${businessNumber}?text=${encoded}`;
    window.open(waLink, "_blank");
  };

  // üóëÔ∏è Delete product
  const handleDelete = async productId => {
    if (!window.confirm("Are you sure you want to delete this product?"))
      return;

    try {
      await axiosClient.delete(`/product/${productId}`);
      setProducts(prev => prev.filter(p => p.id !== productId));
      toast.success("üóëÔ∏è Product deleted successfully!");
    } catch (err) {
      toast.error("‚ùå Failed to delete product");
    }
  };

  return (
    <div className="p-6">
      <div className="flex justify-between items-center mb-6">
        <h2 className="text-2xl font-bold text-purple-600">
          üõí Product Catalog
        </h2>
        <button
          onClick={() => navigate("/dashboard/productcatalog/add")}
          className="bg-purple-600 text-white px-4 py-2 rounded-xl hover:bg-purple-700 transition text-sm"
        >
          ‚ûï Add Product
        </button>
      </div>

      {products.length === 0 ? (
        <p className="text-gray-500">üö´ No products found.</p>
      ) : (
        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
          {products.map(product => (
            <div
              key={product.id}
              className="bg-white rounded-xl shadow p-4 border border-gray-100 hover:shadow-md transition"
            >
              <img
                src={product.imageUrl}
                alt={product.name}
                className="h-40 w-full object-cover rounded mb-3"
              />
              <h3 className="text-lg font-semibold text-gray-800">
                {product.name}
              </h3>
              <p className="text-sm text-gray-500">{product.description}</p>
              <p className="text-purple-600 font-bold mt-2">
                ‚Çπ{product.price} {product.currency}
              </p>

              <div className="mt-4 flex flex-col gap-2">
                <button
                  onClick={() => shareOnWhatsApp(product)}
                  className="w-full bg-green-500 text-white py-2 rounded-xl hover:bg-green-600 text-sm"
                >
                  üì§ Share on WhatsApp
                </button>

                <button
                  onClick={() =>
                    navigate(`/dashboard/productcatalog/edit/${product.id}`)
                  }
                  className="w-full bg-yellow-500 text-white py-2 rounded-xl hover:bg-yellow-600 text-sm"
                >
                  ‚úèÔ∏è Edit
                </button>

                <button
                  onClick={() => handleDelete(product.id)}
                  className="w-full bg-red-500 text-white py-2 rounded-xl hover:bg-red-600 text-sm"
                >
                  üóëÔ∏è Delete
                </button>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

export default ProductCatalog;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Businesses\ProductForm.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import { useNavigate, useParams } from "react-router-dom";
import axios from "axios";

function ProductForm() {
  const navigate = useNavigate();
  const { productId } = useParams(); // <-- detect edit mode
  const [loading, setLoading] = useState(false);
  const [formData, setFormData] = useState({
    name: "",
    description: "",
    price: "",
    currency: "INR",
    imageUrl: "",
  });

  const businessId = "11111111-1111-1111-1111-111111111111"; // TODO: dynamic later

  const isEditMode = Boolean(productId);

  // üß† Load product if in edit mode
  useEffect(() => {
    if (isEditMode) {
      axios
        .get(`https://localhost:7113/api/product?businessId=${businessId}`)
        .then(res => {
          const product = res.data.find(p => p.id === productId);
          if (product) {
            setFormData({
              name: product.name,
              description: product.description,
              price: product.price,
              currency: product.currency,
              imageUrl: product.imageUrl,
            });
          } else {
            alert("‚ö†Ô∏è Product not found.");
            navigate("/dashboard/productcatalog");
          }
        })
        .catch(err => {
          console.error("‚ùå Failed to load product:", err);
        });
    }
  }, [productId, businessId, isEditMode, navigate]); // ‚úÖ fixed dependencies

  const handleChange = e => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleSubmit = async e => {
    e.preventDefault();
    setLoading(true);

    const payload = {
      ...formData,
      businessId,
      id: productId, // for PUT
    };

    try {
      if (isEditMode) {
        await axios.put(
          `https://localhost:7113/api/product/${productId}`,
          payload
        );
        alert("‚úÖ Product updated!");
      } else {
        await axios.post(`https://localhost:7113/api/product`, payload);
        alert("‚úÖ Product added!");
      }
      navigate("/dashboard/productcatalog");
    } catch (err) {
      alert("‚ùå Failed to save product.");
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="max-w-xl mx-auto bg-white p-6 rounded-xl shadow mt-10">
      <h2 className="text-2xl font-bold text-purple-600 mb-4">
        {isEditMode ? "‚úèÔ∏è Edit Product" : "‚ûï Add New Product"}
      </h2>

      <form onSubmit={handleSubmit} className="space-y-4">
        {[
          ["Product Name", "name"],
          ["Description", "description"],
          ["Price", "price"],
          ["Currency", "currency"],
          ["Image URL", "imageUrl"],
        ].map(([label, name]) => (
          <div key={name}>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {label}
            </label>
            <input
              type={name === "price" ? "number" : "text"}
              name={name}
              value={formData[name]}
              onChange={handleChange}
              className="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500"
              placeholder={`Enter ${label.toLowerCase()}`}
              required
            />
          </div>
        ))}

        <button
          type="submit"
          disabled={loading}
          className="w-full bg-purple-600 text-white py-2 rounded-xl hover:bg-purple-700 transition disabled:opacity-50"
        >
          {loading
            ? "Saving..."
            : isEditMode
            ? "Update Product"
            : "Add Product"}
        </button>
      </form>
    </div>
  );
}

export default ProductForm;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Businesses\ProfileCompletion.jsx 
====================================================== 
 
import { useState, useEffect } from "react";
import { toast } from "react-toastify";
import { useNavigate } from "react-router-dom";

const API_BASE = process.env.REACT_APP_API_BASE_URL;

export default function ProfileCompletion() {
  const navigate = useNavigate();
  const businessId = localStorage.getItem("businessId");

  const [form, setForm] = useState({
    companyName: "", // ‚úÖ NEW
    representativeName: "",
    phone: "",
    companyPhone: "",
    country: "",
    website: "",
    address: "",
    industry: "",
    logoUrl: "",
  });

  const [errors, setErrors] = useState({});
  const [loading, setLoading] = useState(false);

  // Validation rules (added Company Name)
  const fields = [
    [
      "Company Name",
      "companyName",
      "text",
      { required: true, minLength: 2, maxLength: 150 },
    ], // ‚úÖ NEW
    [
      "Representative Name",
      "representativeName",
      "text",
      { required: true, minLength: 2, maxLength: 100 },
    ],
    [
      "Phone",
      "phone",
      "text",
      {
        required: true,
        pattern: /^\d{1,10}$/,
        title: "Enter a valid phone number (up to 10 digits)",
      },
    ],
    [
      "Company Phone",
      "companyPhone",
      "text",
      {
        required: true,
        pattern: /^\d{1,10}$/,
        title: "Enter a valid company phone number (up to 10 digits)",
      },
    ],
    ["Country", "country", "text", { required: false, maxLength: 100 }],
    [
      "Website",
      "website",
      "text",
      {
        required: false,
        pattern: /^www\..*/,
        title: "Website should start with www.",
      },
    ],
    ["Address", "address", "text", { required: false, maxLength: 250 }],
    ["Industry", "industry", "text", { required: false, maxLength: 100 }],
    [
      "Logo URL",
      "logoUrl",
      "text",
      {
        required: false,
        pattern: /^(https?:\/\/)?([\w-]+\.)+[\w-]+.*$/,
        title: "Enter a valid URL",
      },
    ],
  ];

  useEffect(() => {
    if (!businessId) return;

    fetch(`${API_BASE}/businesses/${businessId}`)
      .then(res =>
        res.ok ? res.json() : Promise.reject("Failed to fetch profile")
      )
      .then(data => {
        // Prefill. Use CompanyName or BusinessName if present.
        setForm({
          companyName: data.companyName ?? data.businessName ?? "", // ‚úÖ NEW
          representativeName: data.representativeName ?? "",
          phone: data.phone ?? "",
          companyPhone: data.companyPhone ?? "",
          country: data.country ?? "",
          website: data.website ?? "",
          address: data.address ?? "",
          industry: data.industry ?? "",
          logoUrl: data.logoUrl ?? "",
        });
      })
      .catch(err => {
        console.error("‚ùå Fetch error:", err);
        toast.error("‚ùå Failed to load profile.");
      });
  }, [API_BASE, businessId]);

  const validateField = (name, value) => {
    const field = fields.find(f => f[1] === name);
    if (!field) return null;
    const validation = field[3];

    if (validation.required && !String(value || "").trim()) {
      return `${field[0]} is required.`;
    }
    if (validation.minLength && value.length < validation.minLength) {
      return `${field[0]} must be at least ${validation.minLength} characters.`;
    }
    if (validation.maxLength && value.length > validation.maxLength) {
      return `${field[0]} cannot exceed ${validation.maxLength} characters.`;
    }
    if (
      validation.pattern &&
      String(value || "").length > 0 &&
      !validation.pattern.test(value)
    ) {
      return validation.title || `${field[0]} is invalid.`;
    }
    return null;
  };

  const validateForm = () => {
    const newErrors = {};
    fields.forEach(([_, name]) => {
      const error = validateField(name, form[name]);
      if (error) newErrors[name] = error;
    });
    return newErrors;
  };

  const handleChange = e => {
    const { name, value } = e.target;

    // Only digits for phone fields
    if (
      (name === "phone" || name === "companyPhone") &&
      value &&
      !/^\d*$/.test(value)
    ) {
      return;
    }

    setForm(prev => ({ ...prev, [name]: value }));
    setErrors(prev => ({ ...prev, [name]: validateField(name, value) }));
  };

  const handleSubmit = e => {
    e.preventDefault();

    const formErrors = validateForm();
    setErrors(formErrors);
    if (Object.keys(formErrors).length > 0) {
      toast.error("Please fix validation errors before submitting.");
      return;
    }

    setLoading(true);

    // Trim strings before sending
    const payload = Object.fromEntries(
      Object.entries(form).map(([k, v]) => [
        k,
        typeof v === "string" ? v.trim() : v,
      ])
    );

    fetch(`${API_BASE}/businesses/profile-completion/${businessId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    })
      .then(res => (res.ok ? res.json() : Promise.reject("Update failed")))
      .then(() => {
        toast.success("‚úÖ Profile updated successfully!");
        setTimeout(() => navigate("/app/crm"), 800);
      })
      .catch(err => {
        console.error("‚ùå Submit error:", err);
        toast.error("‚ùå Failed to update profile.");
      })
      .finally(() => setLoading(false));
  };

  return (
    <div className="min-h-screen flex items-start justify-center bg-gray-50 px-0 pt-2">
      <form
        onSubmit={handleSubmit}
        className="bg-white shadow-sm border rounded-md w-full max-w-4xl p-4 md:p-6 hover:shadow-md transition"
        noValidate
      >
        <h2 className="text-lg font-bold text-purple-700 mb-6">
          üìù Complete Your Business Profile
        </h2>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
          {fields.map(([label, name, type]) => (
            <div key={name}>
              <label
                htmlFor={name}
                className="text-xs font-medium text-gray-600 block mb-1"
              >
                {label}
              </label>
              <input
                id={name}
                type={type}
                name={name}
                value={form[name]}
                onChange={handleChange}
                placeholder={`Enter ${label.toLowerCase()}`}
                className={`w-full px-3 py-1.5 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 ${
                  errors[name] ? "border-red-500" : "border-gray-300"
                }`}
                aria-invalid={errors[name] ? "true" : "false"}
                aria-describedby={`${name}-error`}
              />
              {errors[name] && (
                <p
                  className="text-red-600 text-xs mt-1"
                  id={`${name}-error`}
                  role="alert"
                >
                  {errors[name]}
                </p>
              )}
            </div>
          ))}
        </div>

        <div className="pt-6 border-t mt-6 flex justify-end">
          <button
            type="submit"
            disabled={loading}
            className={`inline-flex items-center px-5 py-2 rounded-md text-white text-sm font-medium transition ${
              loading
                ? "bg-gray-400 cursor-not-allowed"
                : "bg-purple-600 hover:bg-purple-700"
            }`}
          >
            {loading ? "üîÑ Submitting..." : "‚úÖ Submit Profile"}
          </button>
        </div>
      </form>
    </div>
  );
}

// import { useState, useEffect } from "react";
// import { toast } from "react-toastify";
// import { useNavigate } from "react-router-dom";

// const API_BASE = process.env.REACT_APP_API_BASE_URL;

// export default function ProfileCompletion() {
//   const navigate = useNavigate();
//   const businessId = localStorage.getItem("businessId");

//   const [form, setForm] = useState({
//     representativeName: "",
//     phone: "",
//     companyPhone: "",
//     country: "",
//     website: "",
//     address: "",
//     industry: "",
//     logoUrl: "",
//   });

//   const [errors, setErrors] = useState({});
//   const [loading, setLoading] = useState(false);

//   // Validation rules from your fields array
//   const fields = [
//     [
//       "Representative Name",
//       "representativeName",
//       "text",
//       { required: true, minLength: 2, maxLength: 100 },
//     ],
//     [
//       "Phone",
//       "phone",
//       "text",
//       {
//         required: true,
//         pattern: /^\d{1,10}$/,
//         title: "Enter a valid phone number (up to 10 digits)",
//       },
//     ],
//     [
//       "Company Phone",
//       "companyPhone",
//       "text",
//       {
//         required: true,
//         pattern: /^\d{1,10}$/,
//         title: "Enter a valid company phone number (up to 10 digits)",
//       },
//     ],
//     ["Country", "country", "text", { required: false, maxLength: 100 }],
//     [
//       "Website",
//       "website",
//       "text",
//       {
//         required: false,
//         pattern: /^www\..*/,
//         title: "Website should start with www.",
//       },
//     ],
//     ["Address", "address", "text", { required: false, maxLength: 250 }],
//     ["Industry", "industry", "text", { required: false, maxLength: 100 }],
//     [
//       "Logo URL",
//       "logoUrl",
//       "text",
//       {
//         required: false,
//         pattern: /^(https?:\/\/)?([\w-]+\.)+[\w-]+.*$/,
//         title: "Enter a valid URL",
//       },
//     ],
//   ];

//   useEffect(() => {
//     if (!businessId) return;

//     fetch(`${API_BASE}/businesses/${businessId}`)
//       .then(res =>
//         res.ok ? res.json() : Promise.reject("Failed to fetch profile")
//       )
//       .then(data => {
//         console.log("‚úÖ Profile fetched:", data);
//         setForm({
//           representativeName: data.representativeName ?? "",
//           phone: data.phone ?? "",
//           companyPhone: data.companyPhone ?? "",
//           country: data.country ?? "",
//           website: data.website ?? "",
//           address: data.address ?? "",
//           industry: data.industry ?? "",
//           logoUrl: data.logoUrl ?? "",
//         });
//       })
//       .catch(err => {
//         console.error("‚ùå Fetch error:", err);
//         toast.error("‚ùå Failed to load profile.");
//       });
//   }, [businessId]);

//   // Validate single field
//   const validateField = (name, value) => {
//     const field = fields.find(f => f[1] === name);
//     if (!field) return null;

//     const validation = field[3];

//     if (validation.required && !value.trim()) {
//       return `${field[0]} is required.`;
//     }

//     if (validation.minLength && value.length < validation.minLength) {
//       return `${field[0]} must be at least ${validation.minLength} characters.`;
//     }

//     if (validation.maxLength && value.length > validation.maxLength) {
//       return `${field[0]} cannot exceed ${validation.maxLength} characters.`;
//     }

//     if (validation.pattern && !validation.pattern.test(value)) {
//       return validation.title || `${field[0]} is invalid.`;
//     }

//     return null;
//   };

//   // Validate all fields, returns errors object
//   const validateForm = () => {
//     const newErrors = {};
//     fields.forEach(([label, name]) => {
//       const error = validateField(name, form[name]);
//       if (error) newErrors[name] = error;
//     });
//     return newErrors;
//   };

//   const handleChange = e => {
//     const { name, value } = e.target;

//     // For phone inputs, allow only digits:
//     if (name === "phone" || name === "companyPhone") {
//       if (value && !/^\d*$/.test(value)) return; // ignore non-digit input
//     }

//     setForm(prev => ({ ...prev, [name]: value }));

//     // Validate on change
//     const error = validateField(name, value);
//     setErrors(prev => ({ ...prev, [name]: error }));
//   };

//   const handleSubmit = e => {
//     e.preventDefault();

//     const formErrors = validateForm();
//     setErrors(formErrors);

//     if (Object.keys(formErrors).length > 0) {
//       toast.error("Please fix validation errors before submitting.");
//       return;
//     }

//     setLoading(true);

//     fetch(`${API_BASE}/businesses/profile-completion/${businessId}`, {
//       method: "POST",
//       headers: { "Content-Type": "application/json" },
//       body: JSON.stringify(form),
//     })
//       .then(res => (res.ok ? res.json() : Promise.reject("Update failed")))
//       .then(() => {
//         toast.success("‚úÖ Profile updated successfully!");
//         setTimeout(() => navigate("/app/crm"), 1000);
//       })
//       .catch(err => {
//         console.error("‚ùå Submit error:", err);
//         toast.error("‚ùå Failed to update profile.");
//       })
//       .finally(() => setLoading(false));
//   };

//   return (
//     <div className="min-h-screen flex items-start justify-center bg-gray-50 px-0 pt-2">
//       <form
//         onSubmit={handleSubmit}
//         className="bg-white shadow-sm border rounded-md w-full max-w-4xl p-4 md:p-6 hover:shadow-md transition"
//         noValidate
//       >
//         <h2 className="text-lg font-bold text-purple-700 mb-6">
//           üìù Complete Your Business Profile
//         </h2>

//         <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
//           {fields.map(([label, name, type]) => (
//             <div key={name}>
//               <label
//                 htmlFor={name}
//                 className="text-xs font-medium text-gray-600 block mb-1"
//               >
//                 {label}
//               </label>
//               <input
//                 id={name}
//                 type={type}
//                 name={name}
//                 value={form[name]}
//                 onChange={handleChange}
//                 placeholder={`Enter ${label.toLowerCase()}`}
//                 className={`w-full px-3 py-1.5 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 ${
//                   errors[name] ? "border-red-500" : "border-gray-300"
//                 }`}
//                 aria-invalid={errors[name] ? "true" : "false"}
//                 aria-describedby={`${name}-error`}
//               />
//               {errors[name] && (
//                 <p
//                   className="text-red-600 text-xs mt-1"
//                   id={`${name}-error`}
//                   role="alert"
//                 >
//                   {errors[name]}
//                 </p>
//               )}
//             </div>
//           ))}
//         </div>

//         <div className="pt-6 border-t mt-6 flex justify-end">
//           <button
//             type="submit"
//             disabled={loading}
//             className={`inline-flex items-center px-5 py-2 rounded-md text-white text-sm font-medium transition ${
//               loading
//                 ? "bg-gray-400 cursor-not-allowed"
//                 : "bg-purple-600 hover:bg-purple-700"
//             }`}
//           >
//             {loading ? "üîÑ Submitting..." : "‚úÖ Submit Profile"}
//           </button>
//         </div>
//       </form>
//     </div>
//   );
// }
 
 
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Businesses\CatalogDashboard.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axios from "axios";
import { useNavigate } from "react-router-dom"; // ‚úÖ For redirect
import { usePlan } from "../auth/hooks/usePlan"; // ‚úÖ Plan protection
import StatCard from "../../components/StatCard";

function CatalogDashboard() {
  const navigate = useNavigate();
  const { plan, hasPlan } = usePlan(); // ‚úÖ Check user plan

  const [summary, setSummary] = useState(null);
  const [topProducts, setTopProducts] = useState([]);
  const [ctaStats, setCtaStats] = useState([]);
  const [productCtaStats, setProductCtaStats] = useState([]);

  const businessId = "11111111-1111-1111-1111-111111111111"; // Temp

  // ‚úÖ Step 1: Redirect if user is on basic plan
  useEffect(() => {
    if (plan === "basic") {
      navigate("/plans/upgrade");
    }
  }, [plan, navigate]);

  useEffect(() => {
    if (!hasPlan("smart")) return; // Stop if plan is not eligible

    const fetchDashboardData = async () => {
      try {
        const summaryRes = await axios.get(
          `https://localhost:7113/api/catalog-dashboard/summary?businessId=${businessId}`
        );
        setSummary(summaryRes.data);

        const topRes = await axios.get(
          `https://localhost:7113/api/catalog-dashboard/top-products?businessId=${businessId}`
        );
        setTopProducts(topRes.data);

        const ctaRes = await axios.get(
          `https://localhost:7113/api/catalog-dashboard/cta-summary?businessId=${businessId}`
        );
        setCtaStats(ctaRes.data);

        const heatmapRes = await axios.get(
          `https://localhost:7113/api/catalog-dashboard/product-cta-breakdown?businessId=${businessId}`
        );
        setProductCtaStats(heatmapRes.data);
      } catch (err) {
        console.error("‚ùå Failed to load dashboard data:", err);
      }
    };

    if (businessId) {
      fetchDashboardData();
    }
  }, [businessId, hasPlan]);

  // ‚úÖ Step 2: Optional fallback while redirecting
  if (plan === "basic") {
    return (
      <div className="p-6 text-center text-red-600 font-semibold">
        üö´ This feature is only available on the Smart or Advanced plan.
      </div>
    );
  }

  return (
    <div className="p-6">
      <h2 className="text-xl font-semibold text-purple-700 mb-4">
        üìä Catalog Dashboard
      </h2>

      {!summary ? (
        <p>Loading insights...</p>
      ) : (
        <>
          {/* Stat Cards */}
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <StatCard
              title="üì§ Messages Sent"
              value={summary.totalMessagesSent}
            />
            <StatCard
              title="üë• Unique Customers"
              value={summary.uniqueCustomersMessaged}
            />
            <StatCard title="üõçÔ∏è Product Clicks" value={summary.productClicks} />
            <StatCard
              title="üì¶ Active Products"
              value={summary.activeProducts}
            />
            <StatCard
              title="üì≤ Products Shared"
              value={summary.productsSharedViaWhatsApp}
            />
            <StatCard
              title="üîÅ Repeat Clickers"
              value={summary.repeatClickers}
            />
            <StatCard
              title="üÜï New Clickers Today"
              value={summary.newClickersToday}
            />
            <StatCard
              title="üïí Last Catalog Click"
              value={
                summary.lastCatalogClickAt
                  ? new Date(summary.lastCatalogClickAt).toLocaleString()
                  : "‚Äî"
              }
            />
            <StatCard
              title="üïí Last Message Sent"
              value={
                summary.lastMessageSentAt
                  ? new Date(summary.lastMessageSentAt).toLocaleString()
                  : "‚Äî"
              }
            />
          </div>

          {/* Top Products */}
          <h3 className="text-lg font-semibold text-purple-700 mt-10 mb-4">
            üîù Top Clicked Products
          </h3>
          {topProducts.length === 0 ? (
            <p className="text-gray-500">No product clicks recorded yet.</p>
          ) : (
            <ul className="space-y-2">
              {topProducts.map((product, index) => (
                <li
                  key={product.productId}
                  className="p-3 bg-white border rounded-xl shadow-sm flex justify-between"
                >
                  <span>
                    #{index + 1} - <strong>{product.productName}</strong>
                  </span>
                  <span className="text-purple-600 font-bold">
                    {product.clickCount} clicks
                  </span>
                </li>
              ))}
            </ul>
          )}

          {/* CTA Journey */}
          <h3 className="text-lg font-semibold text-purple-700 mt-10 mb-4">
            üß≠ CTA Journey Breakdown
          </h3>
          {ctaStats.length === 0 ? (
            <p className="text-gray-500">No CTA interactions recorded yet.</p>
          ) : (
            <ul className="space-y-2">
              {ctaStats.map((cta, index) => (
                <li
                  key={index}
                  className="p-3 bg-white border rounded-xl shadow-sm flex justify-between"
                >
                  <span>
                    <strong>{cta.ctaJourney}</strong>
                  </span>
                  <span className="text-purple-600 font-bold">
                    {cta.clickCount} clicks
                  </span>
                </li>
              ))}
            </ul>
          )}

          {/* Product CTA Heatmap */}
          <h3 className="text-lg font-semibold text-purple-700 mt-10 mb-4">
            üî• Product-wise CTA Click Heatmap
          </h3>
          {productCtaStats.length === 0 ? (
            <p className="text-gray-500">No product-specific CTA data found.</p>
          ) : (
            <table className="w-full text-sm bg-white rounded-xl shadow border">
              <thead className="bg-purple-50 text-purple-800 font-semibold">
                <tr>
                  <th className="px-4 py-2">Product</th>
                  <th className="px-4 py-2">CTA Type</th>
                  <th className="px-4 py-2">Clicks</th>
                </tr>
              </thead>
              <tbody>
                {productCtaStats.map((entry, index) => (
                  <tr key={index} className="border-t">
                    <td className="px-4 py-2">{entry.productName}</td>
                    <td className="px-4 py-2">{entry.ctaJourney}</td>
                    <td className="px-4 py-2 font-bold text-purple-700">
                      {entry.clickCount}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </>
      )}
    </div>
  );
}

export default CatalogDashboard;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Businesses\Dashboard.jsx 
====================================================== 
 
import React from "react";

// We will create and import these widgets in the upcoming steps
// import QuickActionsWidget from '@/components/Dashboard/QuickActionsWidget';
// import CampaignStatsWidget from '@/components/Dashboard/CampaignStatsWidget';
// import CrmGrowthWidget from '@/components/Dashboard/CrmGrowthWidget';
// import TopCampaignsWidget from '@/components/Dashboard/TopCampaignsWidget';

export default function Dashboard() {
  return (
    <div className="space-y-6 p-6">
      <div className="flex justify-between items-center">
        <h1
          className="text-3xl font-bold text-gray-800 flex items-center gap-2"
          style={{ fontFamily: "Plus Jakarta Sans, sans-serif" }}
        >
          <span className="text-blue-600">üìä</span>
          Dashboard
        </h1>
        {/* Placeholder for a future Date Range Picker */}
      </div>

      {/* Placeholder for Quick Actions */}
      <div className="bg-white p-4 rounded-lg shadow">
        <p className="text-center text-gray-500">
          Quick Actions Widget will be here.
        </p>
      </div>

      {/* Main grid for stats */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div className="bg-white p-4 rounded-lg shadow">
          <p className="text-center text-gray-500">
            Campaign Stats Widget will be here.
          </p>
        </div>
        <div className="bg-white p-4 rounded-lg shadow">
          <p className="text-center text-gray-500">
            CRM Growth Widget will be here.
          </p>
        </div>
        <div className="bg-white p-4 rounded-lg shadow col-span-1 lg:col-span-2">
          <p className="text-center text-gray-500">
            Top Campaigns Widget will be here.
          </p>
        </div>
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Businesses\Dashboard_old.jsx 
====================================================== 
 
import { useEffect, useState } from "react";
import {
  PieChart,
  Pie,
  Cell,
  Tooltip,
  ResponsiveContainer,
  LineChart,
  Line,
  XAxis,
  YAxis,
  Legend,
} from "recharts";

const COLORS = ["#10B981", "#EF4444"];

function Dashboard() {
  const [stats, setStats] = useState({
    totalMessages: 0,
    successCount: 0,
    failCount: 0,
  });

  const [logs, setLogs] = useState([]);

  useEffect(() => {
    // Simulated API data fetch
    setTimeout(() => {
      setStats({
        totalMessages: 120,
        successCount: 100,
        failCount: 20,
      });

      setLogs([
        {
          name: "Rahul",
          phone: "+919876543210",
          message: "Hello",
          status: "Success",
          createdAt: "2025-04-03 12:00",
        },
        {
          name: "Anjali",
          phone: "+919812345678",
          message: "Test",
          status: "Failed",
          createdAt: "2025-04-03 12:10",
        },
      ]);
    }, 500);
  }, []);

  const chartData = [
    { name: "Success", value: stats.successCount },
    { name: "Failed", value: stats.failCount },
  ];

  const lineData = logs.map((log, index) => ({
    name: log.createdAt,
    Success: log.status === "Success" ? 1 : 0,
    Failed: log.status === "Failed" ? 1 : 0,
  }));

  return (
    <div className="space-y-10">
      {/* Widgets */}
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <div className="bg-white rounded-xl shadow p-6">
          <h3 className="text-sm text-gray-500 mb-1">Total Messages</h3>
          <p className="text-3xl font-bold text-purple-600">
            {stats.totalMessages}
          </p>
        </div>

        <div className="bg-white rounded-xl shadow p-6">
          <h3 className="text-sm text-gray-500 mb-1">Successful</h3>
          <p className="text-3xl font-bold text-green-500">
            {stats.successCount}
          </p>
        </div>

        <div className="bg-white rounded-xl shadow p-6">
          <h3 className="text-sm text-gray-500 mb-1">Failed</h3>
          <p className="text-3xl font-bold text-red-500">{stats.failCount}</p>
        </div>
      </div>

      {/* Pie Chart */}
      <div className="bg-white rounded-xl shadow p-6">
        <h3 className="text-lg font-semibold mb-4">Message Success Rate</h3>
        <ResponsiveContainer width="100%" height={250}>
          <PieChart>
            <Pie
              data={chartData}
              cx="50%"
              cy="50%"
              outerRadius={80}
              label
              dataKey="value"
            >
              {chartData.map((entry, index) => (
                <Cell
                  key={`cell-${index}`}
                  fill={COLORS[index % COLORS.length]}
                />
              ))}
            </Pie>
            <Tooltip />
          </PieChart>
        </ResponsiveContainer>
      </div>

      {/* Line Chart */}
      <div className="bg-white rounded-xl shadow p-6">
        <h3 className="text-lg font-semibold mb-4">
          Success vs Failed Over Time
        </h3>
        <ResponsiveContainer width="100%" height={250}>
          <LineChart data={lineData}>
            <XAxis dataKey="name" />
            <YAxis allowDecimals={false} />
            <Tooltip />
            <Legend />
            <Line
              type="monotone"
              dataKey="Success"
              stroke="#10B981"
              strokeWidth={2}
            />
            <Line
              type="monotone"
              dataKey="Failed"
              stroke="#EF4444"
              strokeWidth={2}
            />
          </LineChart>
        </ResponsiveContainer>
      </div>

      {/* Message Log Table */}
      <div className="bg-white rounded-xl shadow p-6 overflow-auto">
        <h3 className="text-lg font-semibold mb-4">Recent Message Logs</h3>
        <table className="w-full text-sm text-left">
          <thead>
            <tr className="text-gray-600 border-b">
              <th className="p-2">Name</th>
              <th className="p-2">Phone</th>
              <th className="p-2">Message</th>
              <th className="p-2">Status</th>
              <th className="p-2">Time</th>
            </tr>
          </thead>
          <tbody>
            {logs.map((log, index) => (
              <tr key={index} className="border-t">
                <td className="p-2">{log.name}</td>
                <td className="p-2">{log.phone}</td>
                <td className="p-2">{log.message}</td>
                <td
                  className={`p-2 font-medium ${
                    log.status === "Success" ? "text-green-600" : "text-red-600"
                  }`}
                >
                  {log.status}
                </td>
                <td className="p-2">{log.createdAt}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}

export default Dashboard;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Businesses\MessageHistory.jsx 
====================================================== 
 
import { useEffect, useState } from "react";
import {
  FileDown,
  FileSpreadsheet,
  FileText,
  ArrowDownAZ,
  ArrowUpZA,
} from "lucide-react";
import * as XLSX from "xlsx";
import jsPDF from "jspdf";
import autoTable from "jspdf-autotable";
import { toast } from "react-toastify";
import "react-toastify/dist/ReactToastify.css";
import { ToastContainer } from "react-toastify";

function MessageHistory() {
  const [logs, setLogs] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [searchTerm, setSearchTerm] = useState("");
  const [currentPage, setCurrentPage] = useState(1);
  const [sortField, setSortField] = useState(null);
  const [sortOrder, setSortOrder] = useState("asc");
  const itemsPerPage = 5;

  useEffect(() => {
    fetch("https://localhost:7113/api/messagelogs")
      .then(res => {
        if (!res.ok) throw new Error("Failed to fetch logs");
        return res.json();
      })
      .then(data => setLogs(data))
      .catch(err => setError(err.message))
      .finally(() => setLoading(false));
  }, []);

  const filteredLogs = logs.filter(log => {
    const lower = searchTerm.toLowerCase();
    return (
      log.name?.toLowerCase().includes(lower) ||
      log.phone?.toLowerCase().includes(lower) ||
      log.message?.toLowerCase().includes(lower) ||
      log.status?.toLowerCase().includes(lower)
    );
  });

  const sortedLogs = [...filteredLogs].sort((a, b) => {
    if (!sortField) return 0;
    const aVal = a[sortField]?.toString().toLowerCase() || "";
    const bVal = b[sortField]?.toString().toLowerCase() || "";
    return sortOrder === "asc"
      ? aVal.localeCompare(bVal)
      : bVal.localeCompare(aVal);
  });

  const paginatedLogs = sortedLogs.slice(
    (currentPage - 1) * itemsPerPage,
    currentPage * itemsPerPage
  );

  const totalPages = Math.ceil(filteredLogs.length / itemsPerPage);

  const handleSort = field => {
    if (sortField === field) {
      setSortOrder(sortOrder === "asc" ? "desc" : "asc");
    } else {
      setSortField(field);
      setSortOrder("asc");
    }
  };

  const exportCSV = () => {
    try {
      const headers = ["Name", "Phone", "Message", "Status", "Date"];
      const rows = filteredLogs.map(log => [
        log.name,
        log.phone,
        log.message,
        log.status,
        log.createdAt,
      ]);

      const csvContent = [
        headers.join(","),
        ...rows.map(row => row.map(cell => `"${cell}"`).join(",")),
      ].join("\n");

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `xbytechat_logs_${Date.now()}.csv`;
      link.click();

      toast.success("CSV exported successfully!");
    } catch (error) {
      toast.error("Failed to export CSV.");
    }
  };

  const exportExcel = () => {
    try {
      const ws = XLSX.utils.json_to_sheet(filteredLogs);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Logs");
      XLSX.writeFile(wb, `xbytechat_logs_${Date.now()}.xlsx`);

      toast.success("Excel exported successfully!");
    } catch (error) {
      toast.error("Failed to export Excel.");
    }
  };

  const exportPDF = () => {
    try {
      const doc = new jsPDF();
      doc.text("xByteChat - Message Logs", 14, 10);
      doc.setFontSize(8);
      doc.setTextColor(180);
      doc.text("Generated by xByteChat", 14, 16);

      autoTable(doc, {
        head: [["Name", "Phone", "Message", "Status", "Date"]],
        body: filteredLogs.map(log => [
          log.name,
          log.phone,
          log.message,
          log.status,
          log.createdAt,
        ]),
        startY: 20,
      });

      doc.save(`xbytechat_logs_${Date.now()}.pdf`);
      toast.success("PDF exported successfully!");
    } catch (error) {
      toast.error("Failed to export PDF.");
    }
  };

  const getSortIcon = field => {
    if (sortField !== field) return null;
    return sortOrder === "asc" ? (
      <ArrowDownAZ size={14} />
    ) : (
      <ArrowUpZA size={14} />
    );
  };

  return (
    <div className="bg-white p-6 rounded-xl shadow">
      <ToastContainer />
      <h2 className="text-xl font-bold mb-4">üìú All Message Logs</h2>

      <input
        type="text"
        placeholder="üîç Search by name, phone, message, status"
        className="mb-4 w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500"
        value={searchTerm}
        onChange={e => setSearchTerm(e.target.value)}
      />

      {loading && (
        <div className="w-full bg-gray-200 rounded-full overflow-hidden h-2 mb-4">
          <div className="bg-purple-600 h-2 animate-pulse w-full"></div>
        </div>
      )}

      {error && <p className="text-red-600">‚ùå {error}</p>}

      {!loading && !error && (
        <>
          <div className="flex gap-3 mb-4">
            <button
              onClick={exportCSV}
              className="flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded-xl hover:bg-purple-700 text-sm"
            >
              <FileDown size={16} /> CSV
            </button>
            <button
              onClick={exportExcel}
              className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-xl hover:bg-green-700 text-sm"
            >
              <FileSpreadsheet size={16} /> Excel
            </button>
            <button
              onClick={exportPDF}
              className="flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded-xl hover:bg-red-700 text-sm"
            >
              <FileText size={16} /> PDF
            </button>
          </div>

          <div className="overflow-auto">
            <table className="w-full text-sm text-left">
              <thead className="bg-gray-100 text-gray-600">
                <tr>
                  <th
                    className="p-2 cursor-pointer"
                    onClick={() => handleSort("name")}
                  >
                    Name {getSortIcon("name")}
                  </th>
                  <th
                    className="p-2 cursor-pointer"
                    onClick={() => handleSort("phone")}
                  >
                    Phone {getSortIcon("phone")}
                  </th>
                  <th
                    className="p-2 cursor-pointer"
                    onClick={() => handleSort("message")}
                  >
                    Message {getSortIcon("message")}
                  </th>
                  <th
                    className="p-2 cursor-pointer"
                    onClick={() => handleSort("status")}
                  >
                    Status {getSortIcon("status")}
                  </th>
                  <th
                    className="p-2 cursor-pointer"
                    onClick={() => handleSort("createdAt")}
                  >
                    Date {getSortIcon("createdAt")}
                  </th>
                </tr>
              </thead>
              <tbody>
                {paginatedLogs.map((log, index) => (
                  <tr key={index} className="border-t">
                    <td className="p-2">{log.name}</td>
                    <td className="p-2">{log.phone}</td>
                    <td className="p-2">{log.message}</td>
                    <td
                      className={`p-2 font-semibold ${
                        log.status === "Success"
                          ? "text-green-600"
                          : "text-red-600"
                      }`}
                    >
                      {log.status}
                    </td>
                    <td className="p-2">{log.createdAt}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {/* Pagination Controls */}
          <div className="mt-6 flex justify-center gap-2">
            {Array.from({ length: totalPages }, (_, i) => i + 1).map(page => (
              <button
                key={page}
                onClick={() => setCurrentPage(page)}
                className={`px-3 py-1 rounded-full text-sm border ${
                  page === currentPage
                    ? "bg-purple-600 text-white border-purple-600"
                    : "bg-white text-gray-700 hover:bg-gray-100"
                }`}
              >
                {page}
              </button>
            ))}
          </div>
        </>
      )}
    </div>
  );
}

export default MessageHistory;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Businesses\ProductCatalog.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../api/axiosClient";
import { useNavigate } from "react-router-dom";
import { toast } from "react-toastify";

function ProductCatalog() {
  const [products, setProducts] = useState([]);
  const navigate = useNavigate();

  const businessId =
    localStorage.getItem("businessId") ||
    "11111111-1111-1111-1111-111111111111";
  const businessNumber =
    localStorage.getItem("whatsappNumber") || "917082156227";

  // üîÑ Fetch products
  useEffect(() => {
    axiosClient
      .get(`/product?businessId=${businessId}`)
      .then(res => setProducts(res.data))
      .catch(() => toast.error("‚ùå Error fetching products"));
  }, [businessId]);

  // üì§ Share on WhatsApp
  const shareOnWhatsApp = async product => {
    const trackingPayload = {
      businessId,
      productId: product.id,
      userId: "customer-001", // dynamic later
      userName: "Amit Sharma",
      userPhone: "9876543210",
      botId: "bot-01",
      categoryBrowsed: "Ads",
      productBrowsed: product.name,
      ctaJourney: "BuyNow",
      refMessageId: "",
    };

    try {
      await axiosClient.post("/catalog-tracking/log-click", trackingPayload);
      console.log("‚úÖ Click tracked successfully.");
    } catch (err) {
      console.error("‚ùå Failed to track click:", err);
    }

    const message = `üõçÔ∏è *${product.name}*\n${product.description}\nüí∞ Price: ‚Çπ${product.price} ${product.currency}`;
    const encoded = encodeURIComponent(message);
    const waLink = `https://wa.me/${businessNumber}?text=${encoded}`;
    window.open(waLink, "_blank");
  };

  // üóëÔ∏è Delete product
  const handleDelete = async productId => {
    if (!window.confirm("Are you sure you want to delete this product?"))
      return;

    try {
      await axiosClient.delete(`/product/${productId}`);
      setProducts(prev => prev.filter(p => p.id !== productId));
      toast.success("üóëÔ∏è Product deleted successfully!");
    } catch (err) {
      toast.error("‚ùå Failed to delete product");
    }
  };

  return (
    <div className="p-6">
      <div className="flex justify-between items-center mb-6">
        <h2 className="text-2xl font-bold text-purple-600">
          üõí Product Catalog
        </h2>
        <button
          onClick={() => navigate("/dashboard/productcatalog/add")}
          className="bg-purple-600 text-white px-4 py-2 rounded-xl hover:bg-purple-700 transition text-sm"
        >
          ‚ûï Add Product
        </button>
      </div>

      {products.length === 0 ? (
        <p className="text-gray-500">üö´ No products found.</p>
      ) : (
        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
          {products.map(product => (
            <div
              key={product.id}
              className="bg-white rounded-xl shadow p-4 border border-gray-100 hover:shadow-md transition"
            >
              <img
                src={product.imageUrl}
                alt={product.name}
                className="h-40 w-full object-cover rounded mb-3"
              />
              <h3 className="text-lg font-semibold text-gray-800">
                {product.name}
              </h3>
              <p className="text-sm text-gray-500">{product.description}</p>
              <p className="text-purple-600 font-bold mt-2">
                ‚Çπ{product.price} {product.currency}
              </p>

              <div className="mt-4 flex flex-col gap-2">
                <button
                  onClick={() => shareOnWhatsApp(product)}
                  className="w-full bg-green-500 text-white py-2 rounded-xl hover:bg-green-600 text-sm"
                >
                  üì§ Share on WhatsApp
                </button>

                <button
                  onClick={() =>
                    navigate(`/dashboard/productcatalog/edit/${product.id}`)
                  }
                  className="w-full bg-yellow-500 text-white py-2 rounded-xl hover:bg-yellow-600 text-sm"
                >
                  ‚úèÔ∏è Edit
                </button>

                <button
                  onClick={() => handleDelete(product.id)}
                  className="w-full bg-red-500 text-white py-2 rounded-xl hover:bg-red-600 text-sm"
                >
                  üóëÔ∏è Delete
                </button>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

export default ProductCatalog;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Businesses\ProductForm.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import { useNavigate, useParams } from "react-router-dom";
import axios from "axios";

function ProductForm() {
  const navigate = useNavigate();
  const { productId } = useParams(); // <-- detect edit mode
  const [loading, setLoading] = useState(false);
  const [formData, setFormData] = useState({
    name: "",
    description: "",
    price: "",
    currency: "INR",
    imageUrl: "",
  });

  const businessId = "11111111-1111-1111-1111-111111111111"; // TODO: dynamic later

  const isEditMode = Boolean(productId);

  // üß† Load product if in edit mode
  useEffect(() => {
    if (isEditMode) {
      axios
        .get(`https://localhost:7113/api/product?businessId=${businessId}`)
        .then(res => {
          const product = res.data.find(p => p.id === productId);
          if (product) {
            setFormData({
              name: product.name,
              description: product.description,
              price: product.price,
              currency: product.currency,
              imageUrl: product.imageUrl,
            });
          } else {
            alert("‚ö†Ô∏è Product not found.");
            navigate("/dashboard/productcatalog");
          }
        })
        .catch(err => {
          console.error("‚ùå Failed to load product:", err);
        });
    }
  }, [productId, businessId, isEditMode, navigate]); // ‚úÖ fixed dependencies

  const handleChange = e => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleSubmit = async e => {
    e.preventDefault();
    setLoading(true);

    const payload = {
      ...formData,
      businessId,
      id: productId, // for PUT
    };

    try {
      if (isEditMode) {
        await axios.put(
          `https://localhost:7113/api/product/${productId}`,
          payload
        );
        alert("‚úÖ Product updated!");
      } else {
        await axios.post(`https://localhost:7113/api/product`, payload);
        alert("‚úÖ Product added!");
      }
      navigate("/dashboard/productcatalog");
    } catch (err) {
      alert("‚ùå Failed to save product.");
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="max-w-xl mx-auto bg-white p-6 rounded-xl shadow mt-10">
      <h2 className="text-2xl font-bold text-purple-600 mb-4">
        {isEditMode ? "‚úèÔ∏è Edit Product" : "‚ûï Add New Product"}
      </h2>

      <form onSubmit={handleSubmit} className="space-y-4">
        {[
          ["Product Name", "name"],
          ["Description", "description"],
          ["Price", "price"],
          ["Currency", "currency"],
          ["Image URL", "imageUrl"],
        ].map(([label, name]) => (
          <div key={name}>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {label}
            </label>
            <input
              type={name === "price" ? "number" : "text"}
              name={name}
              value={formData[name]}
              onChange={handleChange}
              className="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500"
              placeholder={`Enter ${label.toLowerCase()}`}
              required
            />
          </div>
        ))}

        <button
          type="submit"
          disabled={loading}
          className="w-full bg-purple-600 text-white py-2 rounded-xl hover:bg-purple-700 transition disabled:opacity-50"
        >
          {loading
            ? "Saving..."
            : isEditMode
            ? "Update Product"
            : "Add Product"}
        </button>
      </form>
    </div>
  );
}

export default ProductForm;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Businesses\ProfileCompletion.jsx 
====================================================== 
 
import { useState, useEffect } from "react";
import { toast } from "react-toastify";
import { useNavigate } from "react-router-dom";

const API_BASE = process.env.REACT_APP_API_BASE_URL;

export default function ProfileCompletion() {
  const navigate = useNavigate();
  const businessId = localStorage.getItem("businessId");

  const [form, setForm] = useState({
    companyName: "", // ‚úÖ NEW
    representativeName: "",
    phone: "",
    companyPhone: "",
    country: "",
    website: "",
    address: "",
    industry: "",
    logoUrl: "",
  });

  const [errors, setErrors] = useState({});
  const [loading, setLoading] = useState(false);

  // Validation rules (added Company Name)
  const fields = [
    [
      "Company Name",
      "companyName",
      "text",
      { required: true, minLength: 2, maxLength: 150 },
    ], // ‚úÖ NEW
    [
      "Representative Name",
      "representativeName",
      "text",
      { required: true, minLength: 2, maxLength: 100 },
    ],
    [
      "Phone",
      "phone",
      "text",
      {
        required: true,
        pattern: /^\d{1,10}$/,
        title: "Enter a valid phone number (up to 10 digits)",
      },
    ],
    [
      "Company Phone",
      "companyPhone",
      "text",
      {
        required: true,
        pattern: /^\d{1,10}$/,
        title: "Enter a valid company phone number (up to 10 digits)",
      },
    ],
    ["Country", "country", "text", { required: false, maxLength: 100 }],
    [
      "Website",
      "website",
      "text",
      {
        required: false,
        pattern: /^www\..*/,
        title: "Website should start with www.",
      },
    ],
    ["Address", "address", "text", { required: false, maxLength: 250 }],
    ["Industry", "industry", "text", { required: false, maxLength: 100 }],
    [
      "Logo URL",
      "logoUrl",
      "text",
      {
        required: false,
        pattern: /^(https?:\/\/)?([\w-]+\.)+[\w-]+.*$/,
        title: "Enter a valid URL",
      },
    ],
  ];

  useEffect(() => {
    if (!businessId) return;

    fetch(`${API_BASE}/businesses/${businessId}`)
      .then(res =>
        res.ok ? res.json() : Promise.reject("Failed to fetch profile")
      )
      .then(data => {
        // Prefill. Use CompanyName or BusinessName if present.
        setForm({
          companyName: data.companyName ?? data.businessName ?? "", // ‚úÖ NEW
          representativeName: data.representativeName ?? "",
          phone: data.phone ?? "",
          companyPhone: data.companyPhone ?? "",
          country: data.country ?? "",
          website: data.website ?? "",
          address: data.address ?? "",
          industry: data.industry ?? "",
          logoUrl: data.logoUrl ?? "",
        });
      })
      .catch(err => {
        console.error("‚ùå Fetch error:", err);
        toast.error("‚ùå Failed to load profile.");
      });
  }, [API_BASE, businessId]);

  const validateField = (name, value) => {
    const field = fields.find(f => f[1] === name);
    if (!field) return null;
    const validation = field[3];

    if (validation.required && !String(value || "").trim()) {
      return `${field[0]} is required.`;
    }
    if (validation.minLength && value.length < validation.minLength) {
      return `${field[0]} must be at least ${validation.minLength} characters.`;
    }
    if (validation.maxLength && value.length > validation.maxLength) {
      return `${field[0]} cannot exceed ${validation.maxLength} characters.`;
    }
    if (
      validation.pattern &&
      String(value || "").length > 0 &&
      !validation.pattern.test(value)
    ) {
      return validation.title || `${field[0]} is invalid.`;
    }
    return null;
  };

  const validateForm = () => {
    const newErrors = {};
    fields.forEach(([_, name]) => {
      const error = validateField(name, form[name]);
      if (error) newErrors[name] = error;
    });
    return newErrors;
  };

  const handleChange = e => {
    const { name, value } = e.target;

    // Only digits for phone fields
    if (
      (name === "phone" || name === "companyPhone") &&
      value &&
      !/^\d*$/.test(value)
    ) {
      return;
    }

    setForm(prev => ({ ...prev, [name]: value }));
    setErrors(prev => ({ ...prev, [name]: validateField(name, value) }));
  };

  const handleSubmit = e => {
    e.preventDefault();

    const formErrors = validateForm();
    setErrors(formErrors);
    if (Object.keys(formErrors).length > 0) {
      toast.error("Please fix validation errors before submitting.");
      return;
    }

    setLoading(true);

    // Trim strings before sending
    const payload = Object.fromEntries(
      Object.entries(form).map(([k, v]) => [
        k,
        typeof v === "string" ? v.trim() : v,
      ])
    );

    fetch(`${API_BASE}/businesses/profile-completion/${businessId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    })
      .then(res => (res.ok ? res.json() : Promise.reject("Update failed")))
      .then(() => {
        toast.success("‚úÖ Profile updated successfully!");
        setTimeout(() => navigate("/app/crm"), 800);
      })
      .catch(err => {
        console.error("‚ùå Submit error:", err);
        toast.error("‚ùå Failed to update profile.");
      })
      .finally(() => setLoading(false));
  };

  return (
    <div className="min-h-screen flex items-start justify-center bg-gray-50 px-0 pt-2">
      <form
        onSubmit={handleSubmit}
        className="bg-white shadow-sm border rounded-md w-full max-w-4xl p-4 md:p-6 hover:shadow-md transition"
        noValidate
      >
        <h2 className="text-lg font-bold text-purple-700 mb-6">
          üìù Complete Your Business Profile
        </h2>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
          {fields.map(([label, name, type]) => (
            <div key={name}>
              <label
                htmlFor={name}
                className="text-xs font-medium text-gray-600 block mb-1"
              >
                {label}
              </label>
              <input
                id={name}
                type={type}
                name={name}
                value={form[name]}
                onChange={handleChange}
                placeholder={`Enter ${label.toLowerCase()}`}
                className={`w-full px-3 py-1.5 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 ${
                  errors[name] ? "border-red-500" : "border-gray-300"
                }`}
                aria-invalid={errors[name] ? "true" : "false"}
                aria-describedby={`${name}-error`}
              />
              {errors[name] && (
                <p
                  className="text-red-600 text-xs mt-1"
                  id={`${name}-error`}
                  role="alert"
                >
                  {errors[name]}
                </p>
              )}
            </div>
          ))}
        </div>

        <div className="pt-6 border-t mt-6 flex justify-end">
          <button
            type="submit"
            disabled={loading}
            className={`inline-flex items-center px-5 py-2 rounded-md text-white text-sm font-medium transition ${
              loading
                ? "bg-gray-400 cursor-not-allowed"
                : "bg-purple-600 hover:bg-purple-700"
            }`}
          >
            {loading ? "üîÑ Submitting..." : "‚úÖ Submit Profile"}
          </button>
        </div>
      </form>
    </div>
  );
}

// import { useState, useEffect } from "react";
// import { toast } from "react-toastify";
// import { useNavigate } from "react-router-dom";

// const API_BASE = process.env.REACT_APP_API_BASE_URL;

// export default function ProfileCompletion() {
//   const navigate = useNavigate();
//   const businessId = localStorage.getItem("businessId");

//   const [form, setForm] = useState({
//     representativeName: "",
//     phone: "",
//     companyPhone: "",
//     country: "",
//     website: "",
//     address: "",
//     industry: "",
//     logoUrl: "",
//   });

//   const [errors, setErrors] = useState({});
//   const [loading, setLoading] = useState(false);

//   // Validation rules from your fields array
//   const fields = [
//     [
//       "Representative Name",
//       "representativeName",
//       "text",
//       { required: true, minLength: 2, maxLength: 100 },
//     ],
//     [
//       "Phone",
//       "phone",
//       "text",
//       {
//         required: true,
//         pattern: /^\d{1,10}$/,
//         title: "Enter a valid phone number (up to 10 digits)",
//       },
//     ],
//     [
//       "Company Phone",
//       "companyPhone",
//       "text",
//       {
//         required: true,
//         pattern: /^\d{1,10}$/,
//         title: "Enter a valid company phone number (up to 10 digits)",
//       },
//     ],
//     ["Country", "country", "text", { required: false, maxLength: 100 }],
//     [
//       "Website",
//       "website",
//       "text",
//       {
//         required: false,
//         pattern: /^www\..*/,
//         title: "Website should start with www.",
//       },
//     ],
//     ["Address", "address", "text", { required: false, maxLength: 250 }],
//     ["Industry", "industry", "text", { required: false, maxLength: 100 }],
//     [
//       "Logo URL",
//       "logoUrl",
//       "text",
//       {
//         required: false,
//         pattern: /^(https?:\/\/)?([\w-]+\.)+[\w-]+.*$/,
//         title: "Enter a valid URL",
//       },
//     ],
//   ];

//   useEffect(() => {
//     if (!businessId) return;

//     fetch(`${API_BASE}/businesses/${businessId}`)
//       .then(res =>
//         res.ok ? res.json() : Promise.reject("Failed to fetch profile")
//       )
//       .then(data => {
//         console.log("‚úÖ Profile fetched:", data);
//         setForm({
//           representativeName: data.representativeName ?? "",
//           phone: data.phone ?? "",
//           companyPhone: data.companyPhone ?? "",
//           country: data.country ?? "",
//           website: data.website ?? "",
//           address: data.address ?? "",
//           industry: data.industry ?? "",
//           logoUrl: data.logoUrl ?? "",
//         });
//       })
//       .catch(err => {
//         console.error("‚ùå Fetch error:", err);
//         toast.error("‚ùå Failed to load profile.");
//       });
//   }, [businessId]);

//   // Validate single field
//   const validateField = (name, value) => {
//     const field = fields.find(f => f[1] === name);
//     if (!field) return null;

//     const validation = field[3];

//     if (validation.required && !value.trim()) {
//       return `${field[0]} is required.`;
//     }

//     if (validation.minLength && value.length < validation.minLength) {
//       return `${field[0]} must be at least ${validation.minLength} characters.`;
//     }

//     if (validation.maxLength && value.length > validation.maxLength) {
//       return `${field[0]} cannot exceed ${validation.maxLength} characters.`;
//     }

//     if (validation.pattern && !validation.pattern.test(value)) {
//       return validation.title || `${field[0]} is invalid.`;
//     }

//     return null;
//   };

//   // Validate all fields, returns errors object
//   const validateForm = () => {
//     const newErrors = {};
//     fields.forEach(([label, name]) => {
//       const error = validateField(name, form[name]);
//       if (error) newErrors[name] = error;
//     });
//     return newErrors;
//   };

//   const handleChange = e => {
//     const { name, value } = e.target;

//     // For phone inputs, allow only digits:
//     if (name === "phone" || name === "companyPhone") {
//       if (value && !/^\d*$/.test(value)) return; // ignore non-digit input
//     }

//     setForm(prev => ({ ...prev, [name]: value }));

//     // Validate on change
//     const error = validateField(name, value);
//     setErrors(prev => ({ ...prev, [name]: error }));
//   };

//   const handleSubmit = e => {
//     e.preventDefault();

//     const formErrors = validateForm();
//     setErrors(formErrors);

//     if (Object.keys(formErrors).length > 0) {
//       toast.error("Please fix validation errors before submitting.");
//       return;
//     }

//     setLoading(true);

//     fetch(`${API_BASE}/businesses/profile-completion/${businessId}`, {
//       method: "POST",
//       headers: { "Content-Type": "application/json" },
//       body: JSON.stringify(form),
//     })
//       .then(res => (res.ok ? res.json() : Promise.reject("Update failed")))
//       .then(() => {
//         toast.success("‚úÖ Profile updated successfully!");
//         setTimeout(() => navigate("/app/crm"), 1000);
//       })
//       .catch(err => {
//         console.error("‚ùå Submit error:", err);
//         toast.error("‚ùå Failed to update profile.");
//       })
//       .finally(() => setLoading(false));
//   };

//   return (
//     <div className="min-h-screen flex items-start justify-center bg-gray-50 px-0 pt-2">
//       <form
//         onSubmit={handleSubmit}
//         className="bg-white shadow-sm border rounded-md w-full max-w-4xl p-4 md:p-6 hover:shadow-md transition"
//         noValidate
//       >
//         <h2 className="text-lg font-bold text-purple-700 mb-6">
//           üìù Complete Your Business Profile
//         </h2>

//         <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
//           {fields.map(([label, name, type]) => (
//             <div key={name}>
//               <label
//                 htmlFor={name}
//                 className="text-xs font-medium text-gray-600 block mb-1"
//               >
//                 {label}
//               </label>
//               <input
//                 id={name}
//                 type={type}
//                 name={name}
//                 value={form[name]}
//                 onChange={handleChange}
//                 placeholder={`Enter ${label.toLowerCase()}`}
//                 className={`w-full px-3 py-1.5 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 ${
//                   errors[name] ? "border-red-500" : "border-gray-300"
//                 }`}
//                 aria-invalid={errors[name] ? "true" : "false"}
//                 aria-describedby={`${name}-error`}
//               />
//               {errors[name] && (
//                 <p
//                   className="text-red-600 text-xs mt-1"
//                   id={`${name}-error`}
//                   role="alert"
//                 >
//                   {errors[name]}
//                 </p>
//               )}
//             </div>
//           ))}
//         </div>

//         <div className="pt-6 border-t mt-6 flex justify-end">
//           <button
//             type="submit"
//             disabled={loading}
//             className={`inline-flex items-center px-5 py-2 rounded-md text-white text-sm font-medium transition ${
//               loading
//                 ? "bg-gray-400 cursor-not-allowed"
//                 : "bg-purple-600 hover:bg-purple-700"
//             }`}
//           >
//             {loading ? "üîÑ Submitting..." : "‚úÖ Submit Profile"}
//           </button>
//         </div>
//       </form>
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\AssignContactsPage.jsx 
====================================================== 
 
// üìÑ src/pages/campaigns/AssignContactsPage.jsx
import React, { useEffect, useRef, useState } from "react";
import { useParams } from "react-router-dom";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";
import Papa from "papaparse";
import Modal from "react-modal";
import TagFilterDropdown from "./components/TagFilterDropdown";

// CSV campaign flow (schema ‚Üí upload ‚Üí map ‚Üí validate ‚Üí dry-run ‚Üí commit)
import CsvAudienceSection from "./components/CsvAudienceSection";
import { fetchCsvSchema } from "./api/csvApi";
// function shortId(id = "") {
//   return id.length > 14 ? `${id.slice(0, 6)}‚Ä¶${id.slice(-4)}` : id;
// }

// function CampaignHeader({ campaign }) {
//   if (!campaign) {
//     return (
//       <header className="mb-6 rounded-xl border bg-white shadow-sm">
//         <div className="px-4 py-4">
//           <div className="h-3 w-20 animate-pulse rounded bg-gray-200" />
//           <div className="mt-2 h-6 w-48 animate-pulse rounded bg-gray-200" />
//           <div className="mt-2 h-3 w-72 animate-pulse rounded bg-gray-200" />
//         </div>
//       </header>
//     );
//   }

//   const name =
//     campaign.name || campaign.campaignName || campaign.title || "(unnamed)";
//   const id = campaign.id || campaign.campaignId || "";

//   const copyId = async () => {
//     try {
//       if (!id) return;
//       await navigator.clipboard.writeText(id);
//       toast.success("Campaign ID copied");
//     } catch {
//       toast.error("Could not copy Campaign ID");
//     }
//   };

//   return (
//     <header className="mb-6 rounded-xl border bg-white shadow-sm">
//       <div className="px-4 py-4">
//         {/* Eyebrow */}
//         <div className="text-[11px] font-medium uppercase tracking-wide text-gray-500">
//           Campaign
//         </div>

//         {/* Title row */}
//         <div className="mt-0.5 flex items-center justify-between gap-3">
//           <h1 className="truncate text-xl font-semibold text-gray-900">
//             {name}
//           </h1>
//           {id ? (
//             <button
//               onClick={copyId}
//               className="inline-flex items-center gap-1.5 rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50"
//               aria-label="Copy campaign ID"
//               title="Copy Campaign ID"
//             >
//               <svg
//                 viewBox="0 0 24 24"
//                 className="h-4 w-4"
//                 fill="none"
//                 stroke="currentColor"
//                 strokeWidth="1.8"
//                 strokeLinecap="round"
//                 strokeLinejoin="round"
//               >
//                 <rect x="9" y="9" width="13" height="13" rx="2" />
//                 <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
//               </svg>
//               <span className="hidden sm:inline">Copy ID</span>
//               <span className="sm:hidden">Copy</span>
//             </button>
//           ) : null}
//         </div>

//         {/* Subtitle */}
//         <p className="mt-1 text-xs text-gray-500">
//           Assign recipients from CSV or include people from your CRM.
//         </p>

//         {/* Optional tiny ID chip (read-only) */}
//         {id ? (
//           <div className="mt-2 text-[11px] text-gray-500">
//             <span className="rounded-md bg-gray-100 px-2 py-0.5">
//               ID: {shortId(id)}
//             </span>
//           </div>
//         ) : null}
//       </div>
//     </header>
//   );
// }

// Template Perview
if (typeof document !== "undefined" && process.env.NODE_ENV !== "test") {
  Modal.setAppElement("#root");
}

export default function AssignContactsPage() {
  const { id: campaignId } = useParams();

  // ‚îÄ‚îÄ Campaign + schema
  const [campaign, setCampaign] = useState(null);
  const [placeholderCount, setPlaceholderCount] = useState(0);

  // ‚îÄ‚îÄ CRM panel state
  const [includeCRM, setIncludeCRM] = useState(false);

  // ‚îÄ‚îÄ CRM contacts & UI
  const [contacts, setContacts] = useState([]);
  const [filteredContacts, setFilteredContacts] = useState([]);
  const [selectedIds, setSelectedIds] = useState([]);
  const [search, setSearch] = useState("");
  const [tags, setTags] = useState([]);
  const [allTags, setAllTags] = useState([]);

  // ‚îÄ‚îÄ CSV ‚Üí CRM quick-import modal
  const [showFieldMapModal, setShowFieldMapModal] = useState(false);
  const [csvHeaders, setCsvHeaders] = useState([]);
  const [fieldMapping, setFieldMapping] = useState({ name: "", phone: "" });
  const [parsedCSV, setParsedCSV] = useState([]);
  const [importedCount, setImportedCount] = useState(0);
  const [saveToDb, setSaveToDb] = useState(true);
  const [selectedTagId, setSelectedTagId] = useState(null);
  const [isImporting, setIsImporting] = useState(false);

  const importedRef = useRef(null);

  const getPhone = c => c.phoneNumber || c.phone || "";

  // Load campaign + CSV schema
  useEffect(() => {
    (async () => {
      if (!campaignId) {
        toast.error("No campaign ID found in URL.");
        return;
      }
      try {
        const res = await axiosClient.get(`/campaign/${campaignId}`);
        setCampaign(res.data);
      } catch (err) {
        console.error("Failed to load campaign:", err);
        toast.error("Failed to load campaign");
      }

      try {
        const sc = await fetchCsvSchema(campaignId);
        const n = Number(sc?.placeholderCount ?? 0);
        setPlaceholderCount(Number.isNaN(n) ? 0 : n);
      } catch {
        setPlaceholderCount(0);
      }
    })();
  }, [campaignId]);

  // Load tags when CRM panel is enabled
  useEffect(() => {
    if (!includeCRM) return;
    (async () => {
      try {
        const res = await axiosClient.get("/tags/get-tags");
        setAllTags(res.data?.data || res.data || []);
      } catch {
        toast.error("Failed to load tags");
      }
    })();
  }, [includeCRM]);

  // Load CRM contacts (only when panel enabled)
  useEffect(() => {
    if (!includeCRM) {
      setContacts([]);
      setFilteredContacts([]);
      setSelectedIds([]);
      return;
    }
    (async () => {
      try {
        let res;
        if (tags.length > 0) {
          res = await axiosClient.post("/contacts/filter-by-tags", tags);
          setContacts(res.data?.data || []);
        } else {
          res = await axiosClient.get("/contacts", {
            params: { tab: "all", page: 1, pageSize: 1000 },
          });
          setContacts(res.data?.data?.items || []);
        }
      } catch {
        toast.error("Failed to load contacts");
      }
    })();
  }, [includeCRM, tags]);

  // Local search filter for CRM list
  useEffect(() => {
    if (!includeCRM) return;
    const q = search.trim().toLowerCase();
    const result = contacts.filter(
      c =>
        c.name?.toLowerCase().includes(q) || getPhone(c).includes(search.trim())
    );
    setFilteredContacts(result);
  }, [includeCRM, contacts, search]);

  // CSV ‚Üí quick import into CRM list
  const handleFileUpload = e => {
    const file = e.target.files[0];
    if (!file) return;
    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: ({ data }) => {
        const headers = Object.keys(data[0] || {});
        setParsedCSV(data);
        setCsvHeaders(headers);
        setShowFieldMapModal(true);
      },
      error: () => toast.error("CSV Parsing Failed"),
    });
  };

  useEffect(() => {
    if (csvHeaders.length > 0) {
      const suggestions = {
        name: ["name", "full name", "contact name"],
        phone: ["phone", "mobile", "number", "whatsapp"],
      };
      const best = opts =>
        csvHeaders.find(h =>
          opts.some(o => h.toLowerCase().includes(o.toLowerCase()))
        ) || "";
      setFieldMapping({
        name: best(suggestions.name),
        phone: best(suggestions.phone),
      });
    }
  }, [csvHeaders]);

  const applyFieldMapping = async () => {
    const mapped = parsedCSV
      .filter(row => row[fieldMapping.name] && row[fieldMapping.phone])
      .map(row => ({
        id: crypto.randomUUID(),
        name: row[fieldMapping.name],
        phone: row[fieldMapping.phone],
        tags: selectedTagId
          ? [
              {
                tagId: selectedTagId,
                tagName: allTags.find(t => t.id === selectedTagId)?.name || "",
              },
            ]
          : [],
      }));

    setContacts(prev => [...prev, ...mapped]);
    setSelectedIds(prev => [...new Set([...prev, ...mapped.map(c => c.id)])]);
    setImportedCount(mapped.length);
    setShowFieldMapModal(false);
    toast.success(`${mapped.length} contacts imported.`);

    setTimeout(
      () => importedRef.current?.scrollIntoView({ behavior: "smooth" }),
      200
    );

    if (saveToDb) {
      try {
        setIsImporting(true);
        await axiosClient.post("/contacts/bulk-import", mapped);
        toast.success("Contacts also saved to your CRM.");
      } catch {
        toast.error("Saving to CRM failed.");
      } finally {
        setIsImporting(false);
      }
    }
  };

  // Selection helpers
  const toggleContact = id =>
    setSelectedIds(prev =>
      prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]
    );

  const toggleSelectAll = () => {
    const filteredIds = filteredContacts.map(c => c.id);
    const allSelected = filteredIds.every(id => selectedIds.includes(id));
    setSelectedIds(prev =>
      allSelected
        ? prev.filter(id => !filteredIds.includes(id))
        : [...new Set([...prev, ...filteredIds])]
    );
  };

  const allVisibleSelected =
    includeCRM && filteredContacts.every(c => selectedIds.includes(c.id));

  // Assign selected CRM contacts
  const assignContacts = async () => {
    if (!campaign || !campaign.id) {
      toast.error("Campaign not ready. Please try again.");
      return;
    }
    if (!includeCRM) {
      toast.warn("Enable 'Include contacts from CRM' to select contacts here.");
      return;
    }
    if (selectedIds.length === 0) {
      toast.warn("Please select at least one contact");
      return;
    }
    const validIds = selectedIds.filter(id =>
      contacts.find(c => c.id === id && getPhone(c).trim() !== "")
    );
    if (validIds.length === 0) {
      toast.warn("No selected contacts have valid phone numbers.");
      return;
    }
    try {
      const payload = { contactIds: validIds };
      await axiosClient.post(
        `/campaign/${campaign.id}/assign-contacts`,
        payload
      );
      toast.success("Contacts assigned to campaign");
    } catch (err) {
      const msg =
        err?.response?.data?.message ||
        "Something went wrong during assignment.";
      toast.error(msg);
    }
  };

  return (
    <div className="mx-auto max-w-7xl px-4 py-6">
      {/* Title */}
      <h1 className="mb-2 flex items-center gap-2 text-2xl font-bold text-purple-600">
        üìá Assign Contacts
      </h1>

      {/* Campaign meta */}
      {campaign ? (
        <div className="mb-6 flex flex-wrap items-center gap-2 text-sm">
          <span className="inline-flex items-center gap-2 rounded-full border border-purple-200 bg-purple-50 px-3 py-1 text-purple-700">
            <strong className="font-semibold">Campaign:</strong>
            <span>
              {campaign.name ||
                campaign.campaignName ||
                campaign.title ||
                "(unnamed campaign)"}
            </span>
          </span>
          {/* {campaign.templateName || campaign.messageTemplate ? ( */}
          {/* <span className="inline-flex items-center gap-2 rounded-full border border-gray-200 bg-gray-50 px-3 py-1 text-gray-700"> */}
          {/* <strong className="font-semibold">Template:</strong> */}
          {/* <span>{campaign.templateName || campaign.messageTemplate}</span> */}
          {/* </span> */}
          {/* ) : null} */}
          <span className="inline-flex items-center gap-2 rounded-full border border-amber-200 bg-amber-50 px-3 py-1 text-amber-800">
            <strong className="font-semibold">Placeholders:</strong>
            <span>{placeholderCount}</span>
          </span>
        </div>
      ) : (
        <div className="mb-6 text-xs text-gray-500">Loading campaign‚Ä¶</div>
      )}

      {/* 1) CSV Audience (always visible, first) */}
      {campaignId && (
        <section className="rounded-xl border bg-white p-4 shadow-sm">
          <h2 className="mb-2 text-sm font-semibold text-gray-800">
            Bulk Personalization via CSV
            {placeholderCount > 0 && (
              <>
                {" "}
                (Template has {placeholderCount} dynamic field
                {placeholderCount > 1 ? "s" : ""})
              </>
            )}
          </h2>
          <p className="mb-3 text-xs text-gray-600">
            Upload a CSV with at least a <code>phone</code> column
            {placeholderCount > 0 && (
              <>
                {" "}
                and values for <code>{"{{1}}"}</code>
                {placeholderCount > 1 && (
                  <>
                    ‚Ä¶<code>{`{{${placeholderCount}}}`}</code>
                  </>
                )}
              </>
            )}
            . This creates an Audience + Recipients with validation, dry-run,
            and idempotency.
          </p>
          <CsvAudienceSection campaignId={campaignId} />
        </section>
      )}

      <div className="my-6 h-px bg-gray-100" />

      {/* 2) Optional CRM Panel (collapsed by default) */}
      <section className="rounded-xl border bg-white shadow-sm">
        {/* Header / Toggle */}
        <div className="flex items-start justify-between gap-4 p-4">
          <div className="flex items-start gap-3">
            <input
              id="includeCRM"
              type="checkbox"
              className="mt-1"
              checked={includeCRM}
              onChange={e => setIncludeCRM(e.target.checked)}
              aria-controls="crm-panel"
              aria-expanded={includeCRM}
            />
            <div>
              <label
                htmlFor="includeCRM"
                className="block cursor-pointer text-sm font-semibold text-gray-800"
              >
                Include contacts from CRM
              </label>
              <p className="mt-1 text-xs text-gray-500">
                Search, filter by tags, quick-import to CRM, and assign selected
                contacts.
              </p>
            </div>
          </div>
          <div className="text-xs text-gray-500">
            Manual assignment is additive to any CSV audience above.
          </div>
        </div>

        {/* Collapsible body */}
        <div
          id="crm-panel"
          className={`grid grid-rows-[0fr] transition-[grid-template-rows] duration-300 ease-in-out ${
            includeCRM ? "grid-rows-[1fr]" : ""
          }`}
        >
          <div className="overflow-hidden">
            <div className="border-t p-4">
              {/* Controls */}
              <div className="mb-4 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                <input
                  className="w-full rounded-md border p-2 sm:w-1/3"
                  type="text"
                  placeholder="Search by name or phone‚Ä¶"
                  value={search}
                  onChange={e => setSearch(e.target.value)}
                />
                <TagFilterDropdown
                  selectedTags={tags}
                  onChange={setTags}
                  category="All"
                />
                <label className="text-sm text-purple-600 hover:underline sm:ml-auto">
                  + Upload CSV to CRM
                  <input
                    type="file"
                    accept=".csv"
                    onChange={handleFileUpload}
                    className="hidden"
                  />
                </label>
              </div>

              {/* Table */}
              <div
                className="overflow-x-auto rounded-xl border"
                ref={importedRef}
              >
                <table className="min-w-full text-sm">
                  <thead className="bg-gray-50 text-gray-700">
                    <tr>
                      <th className="px-4 py-2 text-center">
                        <input
                          type="checkbox"
                          checked={allVisibleSelected}
                          onChange={toggleSelectAll}
                        />
                      </th>
                      <th className="px-4 py-2 text-left">Name</th>
                      <th className="px-4 py-2 text-left">Phone</th>
                      <th className="px-4 py-2 text-left">Tags</th>
                      <th className="px-4 py-2 text-left">Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {filteredContacts.map(c => (
                      <tr key={c.id} className="border-t hover:bg-gray-50">
                        <td className="px-4 py-2 text-center">
                          <input
                            type="checkbox"
                            checked={selectedIds.includes(c.id)}
                            onChange={() => toggleContact(c.id)}
                          />
                        </td>
                        <td className="px-4 py-2">{c.name || "Unnamed"}</td>
                        <td className="px-4 py-2">{getPhone(c) || "‚Äî"}</td>
                        <td className="px-4 py-2">
                          <div className="flex flex-wrap gap-1">
                            {(c.tags || c.contactTags || []).map(t => (
                              <span
                                key={t.tagId || t.id}
                                className="rounded-full px-2 py-0.5 text-xs"
                                style={{
                                  backgroundColor: t.colorHex || "#E5E7EB",
                                  color: "#000",
                                }}
                              >
                                {t.tagName || t.name}
                              </span>
                            ))}
                          </div>
                        </td>
                        <td className="px-4 py-2">
                          {getPhone(c).trim() !== ""
                            ? "‚úÖ Valid"
                            : "‚ö†Ô∏è No Phone"}
                        </td>
                      </tr>
                    ))}
                    {filteredContacts.length === 0 && (
                      <tr>
                        <td
                          colSpan={5}
                          className="px-4 py-10 text-center text-xs text-gray-500"
                        >
                          {tags.length > 0
                            ? "No contacts match the selected tags."
                            : "No contacts to show."}
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>

              {/* Footer + Assign button (INSIDE the panel) */}
              <div className="mt-4 flex flex-col items-center justify-between text-sm text-gray-600 sm:flex-row">
                <div>
                  Selected: {selectedIds.length} / WhatsApp-ready:{" "}
                  {
                    filteredContacts.filter(
                      c =>
                        selectedIds.includes(c.id) && getPhone(c).trim() !== ""
                    ).length
                  }
                </div>
                {importedCount > 0 && (
                  <div className="text-green-600">
                    ‚úî Imported: {importedCount} contact(s)
                  </div>
                )}
              </div>

              <div className="mt-6 flex justify-end">
                <button
                  onClick={assignContacts}
                  className="rounded-lg bg-purple-600 px-6 py-3 text-white transition hover:bg-purple-700"
                >
                  Assign Selected Contacts to Campaign
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>

      {/* CSV ‚Üí CRM mapping modal */}
      <Modal
        isOpen={showFieldMapModal}
        onRequestClose={() => setShowFieldMapModal(false)}
        className="mx-auto mt-20 max-w-xl rounded-lg bg-white p-6 shadow-lg"
        overlayClassName="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40"
      >
        <h2 className="mb-4 text-lg font-bold">üß© Map CSV Fields</h2>
        <div className="space-y-4">
          {["name", "phone"].map(field => (
            <div key={field}>
              <label className="mb-1 block text-sm font-medium capitalize">
                {field}
              </label>
              <select
                className="w-full rounded border px-3 py-2"
                value={fieldMapping[field]}
                onChange={e =>
                  setFieldMapping(prev => ({
                    ...prev,
                    [field]: e.target.value,
                  }))
                }
              >
                <option value="">-- Select CSV column --</option>
                {csvHeaders.map(h => (
                  <option key={h} value={h}>
                    {h}
                  </option>
                ))}
              </select>
            </div>
          ))}

          <div>
            <label className="mb-1 block text-sm font-medium">
              Apply Tag to All
            </label>
            <select
              className="w-full rounded border px-3 py-2"
              value={selectedTagId || ""}
              onChange={e => setSelectedTagId(e.target.value)}
            >
              <option value="">-- None --</option>
              {Array.isArray(allTags) &&
                allTags.map(t => (
                  <option key={t.id} value={t.id}>
                    {t.name}
                  </option>
                ))}
            </select>
          </div>
        </div>

        <div className="mt-4">
          <label className="inline-flex items-center text-sm">
            <input
              type="checkbox"
              className="mr-2"
              checked={saveToDb}
              onChange={e => setSaveToDb(e.target.checked)}
            />
            Also save these contacts to your CRM
          </label>
        </div>

        <div className="mt-6 flex justify-end gap-3">
          <button
            className="text-gray-600 hover:underline"
            onClick={() => setShowFieldMapModal(false)}
          >
            Cancel
          </button>
          <button
            className="rounded-md bg-purple-600 px-4 py-2 text-white disabled:opacity-60"
            onClick={applyFieldMapping}
            disabled={isImporting}
          >
            {isImporting ? "Importing‚Ä¶" : "Import & Apply"}
          </button>
        </div>
      </Modal>
    </div>
  );
}

// import React, { useEffect, useRef, useState } from "react";
// import { useParams } from "react-router-dom";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import Papa from "papaparse";
// import Modal from "react-modal";
// import TagFilterDropdown from "./components/TagFilterDropdown";

// // CSV campaign flow (schema ‚Üí upload ‚Üí map ‚Üí validate ‚Üí dry-run ‚Üí commit)
// import CsvAudienceSection from "./components/CsvAudienceSection";
// import { fetchCsvSchema } from "./api/csvApi";

// if (typeof document !== "undefined" && process.env.NODE_ENV !== "test") {
//   Modal.setAppElement("#root");
// }

// export default function AssignContactsPage() {
//   const { id: campaignId } = useParams();
//   const [contacts, setContacts] = useState([]);
//   const [filteredContacts, setFilteredContacts] = useState([]);
//   const [selectedIds, setSelectedIds] = useState([]);
//   const [search, setSearch] = useState("");
//   const [tags, setTags] = useState([]);
//   const [campaign, setCampaign] = useState(null);

//   const [showFieldMapModal, setShowFieldMapModal] = useState(false);
//   const [csvHeaders, setCsvHeaders] = useState([]);
//   const [fieldMapping, setFieldMapping] = useState({ name: "", phone: "" });
//   const [parsedCSV, setParsedCSV] = useState([]);
//   const [importedCount, setImportedCount] = useState(0);
//   const [saveToDb, setSaveToDb] = useState(true);
//   const [selectedTagId, setSelectedTagId] = useState(null);
//   const [allTags, setAllTags] = useState([]);

//   // was mistakenly `[setIsImporting] = useState(false)` before
//   const [isImporting, setIsImporting] = useState(false);

//   // we still fetch placeholder count to adapt helper text, but UI shows regardless
//   const [placeholderCount, setPlaceholderCount] = useState(0);

//   const importedRef = useRef(null);

//   // Helper for consistent phone extraction
//   function getPhone(contact) {
//     return contact.phoneNumber || contact.phone || "";
//   }

//   useEffect(() => {
//     loadCampaign();
//     fetchAllTags();
//     // eslint-disable-next-line
//   }, [campaignId]);

//   useEffect(() => {
//     loadContacts();
//     // eslint-disable-next-line
//   }, [tags]);

//   useEffect(() => {
//     applySearchFilter();
//     // eslint-disable-next-line
//   }, [contacts, search]);

//   const loadCampaign = async () => {
//     if (!campaignId) {
//       toast.error("No campaign ID found in URL.");
//       return;
//     }
//     try {
//       const res = await axiosClient.get(`/campaign/${campaignId}`);
//       setCampaign(res.data);

//       // Fetch the CSV schema to know how many template params exist
//       try {
//         const sc = await fetchCsvSchema(campaignId); // { headers, placeholderCount, ... }
//         const n = Number(sc?.placeholderCount ?? 0);
//         setPlaceholderCount(isNaN(n) ? 0 : n);
//       } catch {
//         setPlaceholderCount(0);
//       }
//     } catch (err) {
//       console.error("Failed to load campaign:", err);
//       toast.error("Failed to load campaign");
//     }
//   };

//   const fetchAllTags = async () => {
//     try {
//       const res = await axiosClient.get("/tags/get-tags");
//       const tags = res.data?.data || res.data || [];
//       setAllTags(tags);
//     } catch {
//       toast.error("Failed to load tags");
//     }
//   };

//   const loadContacts = async () => {
//     try {
//       let res;
//       if (tags.length > 0) {
//         res = await axiosClient.post("/contacts/filter-by-tags", tags);
//         setContacts(res.data?.data || []);
//       } else {
//         res = await axiosClient.get("/contacts", {
//           params: { tab: "all", page: 1, pageSize: 1000 },
//         });
//         setContacts(res.data?.data?.items || []);
//       }
//     } catch {
//       toast.error("Failed to load contacts");
//     }
//   };

//   const applySearchFilter = () => {
//     const result = contacts.filter(
//       c =>
//         c.name?.toLowerCase().includes(search.toLowerCase()) ||
//         getPhone(c).includes(search)
//     );
//     setFilteredContacts(result);
//   };

//   const toggleContact = id => {
//     setSelectedIds(prev =>
//       prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]
//     );
//   };

//   const toggleSelectAll = () => {
//     const filteredIds = filteredContacts.map(c => c.id);
//     const allSelected = filteredIds.every(id => selectedIds.includes(id));
//     setSelectedIds(prev =>
//       allSelected
//         ? prev.filter(id => !filteredIds.includes(id))
//         : [...new Set([...prev, ...filteredIds])]
//     );
//   };

//   // ===== Existing local CSV ‚Üí CRM import (kept as-is) =====
//   const handleFileUpload = e => {
//     const file = e.target.files[0];
//     if (!file) return;

//     Papa.parse(file, {
//       header: true,
//       skipEmptyLines: true,
//       complete: function (results) {
//         const headers = Object.keys(results.data[0] || {});
//         setParsedCSV(results.data);
//         setCsvHeaders(headers);
//         setShowFieldMapModal(true);
//       },
//       error: function () {
//         toast.error("CSV Parsing Failed");
//       },
//     });
//   };

//   useEffect(() => {
//     if (csvHeaders.length > 0) {
//       const suggestions = {
//         name: ["name", "full name", "contact name"],
//         phone: ["phone", "mobile", "number", "whatsapp"],
//       };
//       const bestMatch = fieldOptions =>
//         csvHeaders.find(h =>
//           fieldOptions.some(option =>
//             h.toLowerCase().includes(option.toLowerCase())
//           )
//         ) || "";
//       setFieldMapping({
//         name: bestMatch(suggestions.name),
//         phone: bestMatch(suggestions.phone),
//       });
//     }
//   }, [csvHeaders]);

//   const applyFieldMapping = async () => {
//     const mapped = parsedCSV
//       .filter(row => row[fieldMapping.name] && row[fieldMapping.phone])
//       .map(row => ({
//         id: crypto.randomUUID(),
//         name: row[fieldMapping.name],
//         phone: row[fieldMapping.phone],
//         tags: selectedTagId
//           ? [
//               {
//                 tagId: selectedTagId,
//                 tagName: allTags.find(t => t.id === selectedTagId)?.name || "",
//               },
//             ]
//           : [],
//       }));

//     setContacts(prev => [...prev, ...mapped]);
//     setSelectedIds(prev => [...new Set([...prev, ...mapped.map(c => c.id)])]);
//     setImportedCount(mapped.length);
//     setShowFieldMapModal(false);
//     toast.success(`${mapped.length} contacts imported.`);

//     setTimeout(() => {
//       if (importedRef.current) {
//         importedRef.current.scrollIntoView({ behavior: "smooth" });
//       }
//     }, 200);

//     if (saveToDb) {
//       try {
//         setIsImporting(true);
//         await axiosClient.post("/contacts/bulk-import", mapped);
//         toast.success("Contacts also saved to your CRM.");
//       } catch {
//         toast.error("Saving to CRM failed.");
//       } finally {
//         setIsImporting(false);
//       }
//     }
//   };

//   const assignContacts = async () => {
//     if (!campaign || !campaign.id) {
//       toast.error("Campaign not ready. Please try again.");
//       return;
//     }
//     if (selectedIds.length === 0) {
//       toast.warn("Please select at least one contact");
//       return;
//     }

//     const validIds = selectedIds.filter(id =>
//       contacts.find(c => c.id === id && getPhone(c).trim() !== "")
//     );

//     if (validIds.length === 0) {
//       toast.warn("No selected contacts have valid phone numbers.");
//       return;
//     }

//     try {
//       const payload = { contactIds: validIds };
//       await axiosClient.post(
//         `/campaign/${campaign.id}/assign-contacts`,
//         payload
//       );
//       toast.success("Contacts assigned to campaign");
//     } catch (err) {
//       const message =
//         err.response?.data?.message ||
//         "Something went wrong during assignment.";
//       toast.error(message);
//     }
//   };

//   const allVisibleSelected = filteredContacts.every(c =>
//     selectedIds.includes(c.id)
//   );

//   return (
//     <div className="max-w-7xl mx-auto px-4 py-6">
//       {/* <h1 className="text-2xl font-bold text-purple-600 mb-6 flex items-center gap-2">
//         üéØ Assign Contacts to Campaign
//       </h1> */}
//       <h1 className="text-2xl font-bold text-purple-600 mb-2 flex items-center gap-2">
//         üéØ Assign Contacts
//       </h1>

//       {/* campaign meta */}
//       {campaign ? (
//         <div className="mb-6 flex flex-wrap items-center gap-2 text-sm">
//           <span className="inline-flex items-center gap-2 rounded-full bg-purple-50 px-3 py-1 text-purple-700 border border-purple-200">
//             <strong className="font-semibold">Campaign:</strong>
//             <span>
//               {campaign.name ||
//                 campaign.campaignName ||
//                 campaign.title ||
//                 "(unnamed campaign)"}
//             </span>
//           </span>
//           {campaign.templateName || campaign.messageTemplate ? (
//             <span className="inline-flex items-center gap-2 rounded-full bg-gray-50 px-3 py-1 text-gray-700 border border-gray-200">
//               <strong className="font-semibold">Template:</strong>
//               <span>{campaign.templateName || campaign.messageTemplate}</span>
//             </span>
//           ) : null}
//           {typeof placeholderCount === "number" ? (
//             <span className="inline-flex items-center gap-2 rounded-full bg-amber-50 px-3 py-1 text-amber-800 border border-amber-200">
//               <strong className="font-semibold">Placeholders:</strong>
//               <span>{placeholderCount}</span>
//             </span>
//           ) : null}
//         </div>
//       ) : (
//         <div className="mb-6 text-xs text-gray-500">Loading campaign‚Ä¶</div>
//       )}

//       <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
//         <input
//           className="border p-2 rounded-md w-full sm:w-1/3"
//           type="text"
//           placeholder="Search by name or phone..."
//           value={search}
//           onChange={e => setSearch(e.target.value)}
//         />
//         <TagFilterDropdown
//           selectedTags={tags}
//           onChange={setTags}
//           category="All"
//         />
//         <label className="cursor-pointer text-purple-600 hover:underline text-sm sm:ml-auto">
//           + Upload CSV
//           <input
//             type="file"
//             accept=".csv"
//             onChange={handleFileUpload}
//             className="hidden"
//           />
//         </label>
//       </div>

//       <div
//         className="bg-white rounded-xl shadow-sm overflow-x-auto"
//         ref={importedRef}
//       >
//         <table className="min-w-full text-sm">
//           <thead className="bg-gray-100 text-gray-700">
//             <tr>
//               <th className="px-4 py-2 text-center">
//                 <input
//                   type="checkbox"
//                   checked={allVisibleSelected}
//                   onChange={toggleSelectAll}
//                 />
//               </th>
//               <th className="px-4 py-2 text-left">Name</th>
//               <th className="px-4 py-2 text-left">Phone</th>
//               <th className="px-4 py-2 text-left">Tags</th>
//               <th className="px-4 py-2 text-left">Status</th>
//             </tr>
//           </thead>
//           <tbody>
//             {filteredContacts.map(contact => (
//               <tr key={contact.id} className="border-t hover:bg-gray-50">
//                 <td className="px-4 py-2 text-center">
//                   <input
//                     type="checkbox"
//                     checked={selectedIds.includes(contact.id)}
//                     onChange={() => toggleContact(contact.id)}
//                   />
//                 </td>
//                 <td className="px-4 py-2">{contact.name || "Unnamed"}</td>
//                 <td className="px-4 py-2">{getPhone(contact) || "‚Äî"}</td>
//                 <td className="px-4 py-2">
//                   <div className="flex flex-wrap gap-1">
//                     {(contact.tags || contact.contactTags || []).map(tag => (
//                       <span
//                         key={tag.tagId || tag.id}
//                         className="px-2 py-0.5 text-xs rounded-full"
//                         style={{
//                           backgroundColor: tag.colorHex || "#E5E7EB",
//                           color: "#000",
//                         }}
//                       >
//                         {tag.tagName || tag.name}
//                       </span>
//                     ))}
//                   </div>
//                 </td>
//                 <td className="px-4 py-2">
//                   {getPhone(contact).trim() !== "" ? "‚úÖ Valid" : "‚ö†Ô∏è No Phone"}
//                 </td>
//               </tr>
//             ))}
//           </tbody>
//         </table>
//       </div>

//       <div className="flex flex-col sm:flex-row justify-between items-center mt-4 text-sm text-gray-600">
//         <div>
//           Selected: {selectedIds.length} / WhatsApp-ready:{" "}
//           {
//             filteredContacts.filter(
//               c => selectedIds.includes(c.id) && getPhone(c).trim() !== ""
//             ).length
//           }
//         </div>
//         {importedCount > 0 && (
//           <div className="text-green-600">
//             ‚úî Imported: {importedCount} contact(s)
//           </div>
//         )}
//       </div>

//       {/* === Campaign CSV flow (ALWAYS visible; phones-only works when N=0) === */}
//       {campaignId && (
//         <div className="mt-8 rounded-xl border bg-white p-4 shadow-sm">
//           <h2 className="mb-2 text-sm font-semibold text-gray-800">
//             Bulk Personalization via CSV
//             {placeholderCount > 0 && (
//               <>
//                 {" "}
//                 (Template has {placeholderCount} dynamic field
//                 {placeholderCount > 1 ? "s" : ""})
//               </>
//             )}
//           </h2>
//           <p className="mb-3 text-xs text-gray-600">
//             Upload a CSV with at least a <code>phone</code> column
//             {placeholderCount > 0 && (
//               <>
//                 {" "}
//                 and values for <code>{"{{1}}"}</code>
//                 {placeholderCount > 1 && (
//                   <>
//                     ‚Ä¶<code>{`{{${placeholderCount}}}`}</code>
//                   </>
//                 )}
//               </>
//             )}
//             , then validate, dry-run, and persist to create an Audience +
//             Recipients with idempotency. Your manual assignment flow above
//             remains available.
//           </p>
//           <CsvAudienceSection campaignId={campaignId} />
//         </div>
//       )}

//       <div className="mt-6 flex justify-end">
//         <button
//           onClick={assignContacts}
//           disabled={false}
//           className="px-6 py-3 rounded-lg transition bg-purple-600 text-white hover:bg-purple-700"
//         >
//           Assign to Campaign
//         </button>
//       </div>

//       <Modal
//         isOpen={showFieldMapModal}
//         onRequestClose={() => setShowFieldMapModal(false)}
//         className="bg-white rounded-lg shadow-lg max-w-xl mx-auto mt-20 p-6"
//         overlayClassName="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50"
//       >
//         <h2 className="text-lg font-bold mb-4">üß© Map CSV Fields</h2>
//         <div className="space-y-4">
//           {["name", "phone"].map(field => (
//             <div key={field}>
//               <label className="block text-sm font-medium mb-1 capitalize">
//                 {field}
//               </label>
//               <select
//                 className="border px-3 py-2 rounded w-full"
//                 value={fieldMapping[field]}
//                 onChange={e =>
//                   setFieldMapping(prev => ({
//                     ...prev,
//                     [field]: e.target.value,
//                   }))
//                 }
//               >
//                 <option value="">-- Select CSV column --</option>
//                 {csvHeaders.map(header => (
//                   <option key={header} value={header}>
//                     {header}
//                   </option>
//                 ))}
//               </select>
//             </div>
//           ))}
//           <div>
//             <label className="block text-sm font-medium mb-1">
//               Apply Tag to All
//             </label>
//             <select
//               className="border px-3 py-2 rounded w-full"
//               value={selectedTagId || ""}
//               onChange={e => setSelectedTagId(e.target.value)}
//             >
//               <option value="">-- None --</option>
//               {Array.isArray(allTags) &&
//                 allTags.map(tag => (
//                   <option key={tag.id} value={tag.id}>
//                     {tag.name}
//                   </option>
//                 ))}
//             </select>
//           </div>
//         </div>

//         <div className="mt-4">
//           <label className="inline-flex items-center">
//             <input
//               type="checkbox"
//               className="mr-2"
//               checked={saveToDb}
//               onChange={e => setSaveToDb(e.target.checked)}
//             />
//             Also save these contacts to your CRM
//           </label>
//         </div>

//         <div className="mt-6 flex justify-end gap-3">
//           <button
//             className="text-gray-600 hover:underline"
//             onClick={() => setShowFieldMapModal(false)}
//           >
//             Cancel
//           </button>
//           <button
//             className="bg-purple-600 text-white px-4 py-2 rounded-md"
//             onClick={applyFieldMapping}
//             disabled={isImporting}
//           >
//             {isImporting ? "Importing‚Ä¶" : "Import & Apply"}
//           </button>
//         </div>
//       </Modal>
//     </div>
//   );
// }

// import React, { useEffect, useRef, useState } from "react";
// import { useParams } from "react-router-dom";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import Papa from "papaparse";
// import Modal from "react-modal";
// // ‚ùå removed: WhatsAppBubblePreview
// import TagFilterDropdown from "./components/TagFilterDropdown";

// if (typeof document !== "undefined" && process.env.NODE_ENV !== "test") {
//   Modal.setAppElement("#root");
// }

// export default function AssignContactsPage() {
//   const { id: campaignId } = useParams();
//   const [contacts, setContacts] = useState([]);
//   const [filteredContacts, setFilteredContacts] = useState([]);
//   const [selectedIds, setSelectedIds] = useState([]);
//   const [search, setSearch] = useState("");
//   const [tags, setTags] = useState([]);
//   const [campaign, setCampaign] = useState(null);

//   const [showFieldMapModal, setShowFieldMapModal] = useState(false);
//   const [csvHeaders, setCsvHeaders] = useState([]);
//   const [fieldMapping, setFieldMapping] = useState({ name: "", phone: "" });
//   const [parsedCSV, setParsedCSV] = useState([]);
//   const [importedCount, setImportedCount] = useState(0);
//   const [saveToDb, setSaveToDb] = useState(true);
//   const [selectedTagId, setSelectedTagId] = useState(null);
//   const [allTags, setAllTags] = useState([]);
//   const [setIsImporting] = useState(false);

//   const importedRef = useRef(null);

//   // ‚úÖ Helper for consistent phone extraction
//   function getPhone(contact) {
//     return contact.phoneNumber || contact.phone || "";
//   }

//   useEffect(() => {
//     loadCampaign();
//     fetchAllTags();
//     // eslint-disable-next-line
//   }, [campaignId]);

//   useEffect(() => {
//     loadContacts();
//     // eslint-disable-next-line
//   }, [tags]);

//   useEffect(() => {
//     applySearchFilter();
//     // eslint-disable-next-line
//   }, [contacts, search]);

//   const loadCampaign = async () => {
//     if (!campaignId) {
//       toast.error("No campaign ID found in URL.");
//       return;
//     }
//     try {
//       const res = await axiosClient.get(`/campaign/${campaignId}`);
//       setCampaign(res.data);
//       // console.log("Loaded campaign:", res.data);
//     } catch (err) {
//       console.error("Failed to load campaign:", err);
//       toast.error("Failed to load campaign");
//     }
//   };

//   const fetchAllTags = async () => {
//     try {
//       const res = await axiosClient.get("/tags/get-tags");
//       const tags = res.data?.data || res.data || [];
//       setAllTags(tags);
//     } catch {
//       toast.error("Failed to load tags");
//     }
//   };

//   const loadContacts = async () => {
//     try {
//       let res;
//       if (tags.length > 0) {
//         res = await axiosClient.post("/contacts/filter-by-tags", tags);
//         setContacts(res.data?.data || []);
//       } else {
//         res = await axiosClient.get("/contacts", {
//           params: { tab: "all", page: 1, pageSize: 1000 },
//         });
//         setContacts(res.data?.data?.items || []);
//       }
//     } catch {
//       toast.error("Failed to load contacts");
//     }
//   };

//   const applySearchFilter = () => {
//     const result = contacts.filter(
//       c =>
//         c.name?.toLowerCase().includes(search.toLowerCase()) ||
//         getPhone(c).includes(search)
//     );
//     setFilteredContacts(result);
//   };

//   const toggleContact = id => {
//     setSelectedIds(prev =>
//       prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]
//     );
//   };

//   const toggleSelectAll = () => {
//     const filteredIds = filteredContacts.map(c => c.id);
//     const allSelected = filteredIds.every(id => selectedIds.includes(id));
//     setSelectedIds(prev =>
//       allSelected
//         ? prev.filter(id => !filteredIds.includes(id))
//         : [...new Set([...prev, ...filteredIds])]
//     );
//   };

//   const handleFileUpload = e => {
//     const file = e.target.files[0];
//     if (!file) return;

//     Papa.parse(file, {
//       header: true,
//       skipEmptyLines: true,
//       complete: function (results) {
//         const headers = Object.keys(results.data[0] || {});
//         setParsedCSV(results.data);
//         setCsvHeaders(headers);
//         setShowFieldMapModal(true);
//       },
//       error: function () {
//         toast.error("CSV Parsing Failed");
//       },
//     });
//   };

//   useEffect(() => {
//     if (csvHeaders.length > 0) {
//       const suggestions = {
//         name: ["name", "full name", "contact name"],
//         phone: ["phone", "mobile", "number", "whatsapp"],
//       };
//       const bestMatch = fieldOptions =>
//         csvHeaders.find(h =>
//           fieldOptions.some(option =>
//             h.toLowerCase().includes(option.toLowerCase())
//           )
//         ) || "";
//       setFieldMapping({
//         name: bestMatch(suggestions.name),
//         phone: bestMatch(suggestions.phone),
//       });
//     }
//   }, [csvHeaders]);

//   const applyFieldMapping = async () => {
//     const mapped = parsedCSV
//       .filter(row => row[fieldMapping.name] && row[fieldMapping.phone])
//       .map(row => ({
//         id: crypto.randomUUID(),
//         name: row[fieldMapping.name],
//         phone: row[fieldMapping.phone],
//         tags: selectedTagId
//           ? [
//               {
//                 tagId: selectedTagId,
//                 tagName: allTags.find(t => t.id === selectedTagId)?.name || "",
//               },
//             ]
//           : [],
//       }));

//     setContacts(prev => [...prev, ...mapped]);
//     setSelectedIds(prev => [...new Set([...prev, ...mapped.map(c => c.id)])]);
//     setImportedCount(mapped.length);
//     setShowFieldMapModal(false);
//     toast.success(`${mapped.length} contacts imported.`);

//     setTimeout(() => {
//       if (importedRef.current) {
//         importedRef.current.scrollIntoView({ behavior: "smooth" });
//       }
//     }, 200);

//     if (saveToDb) {
//       try {
//         setIsImporting(true);
//         await axiosClient.post("/contacts/bulk-import", mapped);
//         toast.success("Contacts also saved to your CRM.");
//       } catch {
//         toast.error("Saving to CRM failed.");
//       } finally {
//         setIsImporting(false);
//       }
//     }
//   };

//   const assignContacts = async () => {
//     if (!campaign || !campaign.id) {
//       toast.error("Campaign not ready. Please try again.");
//       return;
//     }
//     if (selectedIds.length === 0) {
//       toast.warn("Please select at least one contact");
//       return;
//     }

//     const validIds = selectedIds.filter(id =>
//       contacts.find(c => c.id === id && getPhone(c).trim() !== "")
//     );

//     if (validIds.length === 0) {
//       toast.warn("No selected contacts have valid phone numbers.");
//       return;
//     }

//     try {
//       const payload = { contactIds: validIds };
//       await axiosClient.post(
//         `/campaign/${campaign.id}/assign-contacts`,
//         payload
//       );
//       toast.success("Contacts assigned to campaign");
//     } catch (err) {
//       const message =
//         err.response?.data?.message ||
//         "Something went wrong during assignment.";
//       toast.error(message);
//     }
//   };

//   const allVisibleSelected = filteredContacts.every(c =>
//     selectedIds.includes(c.id)
//   );

//   return (
//     <div className="max-w-7xl mx-auto px-4 py-6">
//       <h1 className="text-2xl font-bold text-purple-600 mb-6 flex items-center gap-2">
//         üéØ Assign Contacts to Campaign
//       </h1>

//       <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
//         <input
//           className="border p-2 rounded-md w-full sm:w-1/3"
//           type="text"
//           placeholder="Search by name or phone..."
//           value={search}
//           onChange={e => setSearch(e.target.value)}
//         />
//         <TagFilterDropdown
//           selectedTags={tags}
//           onChange={setTags}
//           category="All"
//         />
//         <label className="cursor-pointer text-purple-600 hover:underline text-sm sm:ml-auto">
//           + Upload CSV
//           <input
//             type="file"
//             accept=".csv"
//             onChange={handleFileUpload}
//             className="hidden"
//           />
//         </label>
//       </div>

//       <div
//         className="bg-white rounded-xl shadow-sm overflow-x-auto"
//         ref={importedRef}
//       >
//         <table className="min-w-full text-sm">
//           <thead className="bg-gray-100 text-gray-700">
//             <tr>
//               <th className="px-4 py-2 text-center">
//                 <input
//                   type="checkbox"
//                   checked={allVisibleSelected}
//                   onChange={toggleSelectAll}
//                 />
//               </th>
//               <th className="px-4 py-2 text-left">Name</th>
//               <th className="px-4 py-2 text-left">Phone</th>
//               <th className="px-4 py-2 text-left">Tags</th>
//               <th className="px-4 py-2 text-left">Status</th>
//             </tr>
//           </thead>
//           <tbody>
//             {filteredContacts.map(contact => (
//               <tr key={contact.id} className="border-t hover:bg-gray-50">
//                 <td className="px-4 py-2 text-center">
//                   <input
//                     type="checkbox"
//                     checked={selectedIds.includes(contact.id)}
//                     onChange={() => toggleContact(contact.id)}
//                   />
//                 </td>
//                 <td className="px-4 py-2">{contact.name || "Unnamed"}</td>
//                 <td className="px-4 py-2">{getPhone(contact) || "‚Äî"}</td>
//                 <td className="px-4 py-2">
//                   <div className="flex flex-wrap gap-1">
//                     {(contact.tags || contact.contactTags || []).map(tag => (
//                       <span
//                         key={tag.tagId || tag.id}
//                         className="px-2 py-0.5 text-xs rounded-full"
//                         style={{
//                           backgroundColor: tag.colorHex || "#E5E7EB",
//                           color: "#000",
//                         }}
//                       >
//                         {tag.tagName || tag.name}
//                       </span>
//                     ))}
//                   </div>
//                 </td>
//                 <td className="px-4 py-2">
//                   {getPhone(contact).trim() !== "" ? "‚úÖ Valid" : "‚ö†Ô∏è No Phone"}
//                 </td>
//               </tr>
//             ))}
//           </tbody>
//         </table>
//       </div>

//       <div className="flex flex-col sm:flex-row justify-between items-center mt-4 text-sm text-gray-600">
//         <div>
//           Selected: {selectedIds.length} / WhatsApp-ready:{" "}
//           {
//             filteredContacts.filter(
//               c => selectedIds.includes(c.id) && getPhone(c).trim() !== ""
//             ).length
//           }
//         </div>
//         {importedCount > 0 && (
//           <div className="text-green-600">
//             ‚úî Imported: {importedCount} contact(s)
//           </div>
//         )}
//       </div>

//       {/* ‚ùå Preview removed */}

//       <div className="mt-6 flex justify-end">
//         <button
//           onClick={assignContacts}
//           disabled={false}
//           className="px-6 py-3 rounded-lg transition bg-purple-600 text-white hover:bg-purple-700"
//         >
//           Assign to Campaign
//         </button>
//       </div>

//       <Modal
//         isOpen={showFieldMapModal}
//         onRequestClose={() => setShowFieldMapModal(false)}
//         className="bg-white rounded-lg shadow-lg max-w-xl mx-auto mt-20 p-6"
//         overlayClassName="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50"
//       >
//         <h2 className="text-lg font-bold mb-4">üß© Map CSV Fields</h2>
//         <div className="space-y-4">
//           {["name", "phone"].map(field => (
//             <div key={field}>
//               <label className="block text-sm font-medium mb-1 capitalize">
//                 {field}
//               </label>
//               <select
//                 className="border px-3 py-2 rounded w-full"
//                 value={fieldMapping[field]}
//                 onChange={e =>
//                   setFieldMapping(prev => ({
//                     ...prev,
//                     [field]: e.target.value,
//                   }))
//                 }
//               >
//                 <option value="">-- Select CSV column --</option>
//                 {csvHeaders.map(header => (
//                   <option key={header} value={header}>
//                     {header}
//                   </option>
//                 ))}
//               </select>
//             </div>
//           ))}
//           <div>
//             <label className="block text-sm font-medium mb-1">
//               Apply Tag to All
//             </label>
//             <select
//               className="border px-3 py-2 rounded w-full"
//               value={selectedTagId || ""}
//               onChange={e => setSelectedTagId(e.target.value)}
//             >
//               <option value="">-- None --</option>
//               {Array.isArray(allTags) &&
//                 allTags.map(tag => (
//                   <option key={tag.id} value={tag.id}>
//                     {tag.name}
//                   </option>
//                 ))}
//             </select>
//           </div>
//         </div>

//         <div className="mt-4">
//           <label className="inline-flex items-center">
//             <input
//               type="checkbox"
//               className="mr-2"
//               checked={saveToDb}
//               onChange={e => setSaveToDb(e.target.checked)}
//             />
//             Also save these contacts to your CRM
//           </label>
//         </div>

//         <div className="mt-6 flex justify-end gap-3">
//           <button
//             className="text-gray-600 hover:underline"
//             onClick={() => setShowFieldMapModal(false)}
//           >
//             Cancel
//           </button>
//           <button
//             className="bg-purple-600 text-white px-4 py-2 rounded-md"
//             onClick={applyFieldMapping}
//           >
//             Import & Apply
//           </button>
//         </div>
//       </Modal>
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\CampaignBuilderPage.jsx 
====================================================== 
 
// üìÑ src/pages/campaigns/CampaignBuilderPage.jsx
import React, { useEffect, useMemo, useState } from "react";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";
import PhoneWhatsAppPreview from "../../components/PhoneWhatsAppPreview";
import { useNavigate } from "react-router-dom";
import { useAuth } from "../auth/context/pld_AuthContext";

// === Your axios baseURL already ends with /api. Keep all calls RELATIVE (no leading slash).
const SYNC_ENDPOINT = bid => `templates/sync/${bid}`; // POST

const isGuid = v =>
  !!v &&
  /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(
    v
  );

// Header kind helpers (frontend-only)
const HK = Object.freeze({
  None: "none",
  Text: "text",
  Image: "image",
  Video: "video",
  Document: "document",
});
const isMediaHeader = hk =>
  hk === HK.Image || hk === HK.Video || hk === HK.Document;
const mediaLabel = hk =>
  hk === HK.Image
    ? "Image URL"
    : hk === HK.Video
    ? "Video URL"
    : "Document URL";

function CampaignBuilderPage() {
  const { businessId: ctxBusinessId } = useAuth();

  const [templates, setTemplates] = useState([]);
  const [loadingTemplates, setLoadingTemplates] = useState(false);
  const [syncing, setSyncing] = useState(false);

  const [selectedTemplate, setSelectedTemplate] = useState(null);
  const [templateParams, setTemplateParams] = useState([]);
  const [buttonParams, setButtonParams] = useState([]);

  // Unified header media url (for Image/Video/Document)
  const [headerMediaUrl, setHeaderMediaUrl] = useState("");

  const [campaignName, setCampaignName] = useState("");
  const [nameError, setNameError] = useState(""); // inline name check
  const [checkingName, setCheckingName] = useState(false);

  const [scheduledAt, setScheduledAt] = useState("");
  const [submitting, setSubmitting] = useState(false);

  // Optional Flow
  const [useFlow, setUseFlow] = useState(false);
  const [flows, setFlows] = useState([]);
  const [loadingFlows, setLoadingFlows] = useState(false);
  const [selectedFlowId, setSelectedFlowId] = useState("");

  // Sender selection (from WhatsAppPhoneNumbers)
  const [senders, setSenders] = useState([]); // [{id, provider, phoneNumberId, whatsAppNumber}]
  const [selectedSenderId, setSelectedSenderId] = useState("");

  // CSV controls all dynamic personalization (default ON)
  const [useCsvPersonalization, setUseCsvPersonalization] = useState(true);

  const businessId = useMemo(
    () => ctxBusinessId || localStorage.getItem("businessId") || null,
    [ctxBusinessId]
  );
  const hasValidBusiness = isGuid(businessId);

  const createdBy = localStorage.getItem("userId");
  const businessName = localStorage.getItem("businessName") || "Your Business";
  const navigate = useNavigate();

  // ---------- Helpers ----------
  const checkNameAvailability = async name => {
    setNameError("");
    if (!name?.trim() || !hasValidBusiness) return;
    try {
      setCheckingName(true);
      // ‚úÖ relative path (no leading slash)
      const { data } = await axiosClient.get(`campaign/check-name`, {
        params: { name },
      });
      if (data?.available === false) {
        setNameError("Name already exists. Please choose another.");
      } else {
        setNameError("");
      }
    } catch {
      setNameError("");
    } finally {
      setCheckingName(false);
    }
  };

  const normalizeHeaderKind = t => {
    const raw = (t.headerKind || t.HeaderKind || "").toString().toLowerCase();
    if (
      raw === HK.Image ||
      raw === HK.Video ||
      raw === HK.Document ||
      raw === HK.Text ||
      raw === HK.None
    ) {
      return raw;
    }
    return t.hasImageHeader || t.HasImageHeader ? HK.Image : HK.None;
  };

  const toArray = maybe => (Array.isArray(maybe) ? maybe : []);

  // ---------- Effects ----------
  // Load approved templates
  useEffect(() => {
    const load = async () => {
      if (!hasValidBusiness) return;
      setLoadingTemplates(true);
      try {
        // ‚úÖ relative path
        const res = await axiosClient.get(
          `templates/${businessId}?status=APPROVED`
        );
        // this endpoint already returns a flat array usable for the list
        if (res.data?.success) setTemplates(res.data.templates || []);
        else toast.error("‚ùå Failed to load templates.");
      } catch {
        toast.error("‚ùå Error loading templates.");
      } finally {
        setLoadingTemplates(false);
      }
    };
    load();
  }, [businessId, hasValidBusiness]);

  // Load flows when "Attach Flow" is toggled
  useEffect(() => {
    if (!useFlow || !hasValidBusiness) return;

    const loadFlows = async () => {
      setLoadingFlows(true);
      try {
        const r = await axiosClient.get(
          `campaign/list/${businessId}?onlyPublished=true`
        );

        const items = Array.isArray(r.data?.items) ? r.data.items : [];
        const mapped = items
          .map(f => ({
            id: f.id ?? f.Id,
            name: f.flowName ?? f.FlowName,
            isPublished: f.isPublished ?? f.IsPublished ?? true,
          }))
          .filter(x => x.id && x.name);

        setFlows(mapped);
        if (!mapped.length) {
          toast.info(
            "‚ÑπÔ∏è No published flows found. You can still create a campaign without a flow."
          );
        }
      } catch {
        toast.error("‚ùå Error loading flows.");
        setFlows([]);
      } finally {
        setLoadingFlows(false);
      }
    };

    loadFlows();
  }, [useFlow, hasValidBusiness, businessId]);

  // Load available senders (WhatsAppPhoneNumbers)
  useEffect(() => {
    if (!hasValidBusiness) return;
    (async () => {
      try {
        const r = await axiosClient.get(
          `WhatsAppSettings/senders/${businessId}`
        );

        const raw = Array.isArray(r.data) ? r.data : r.data?.items || [];
        const normalized = raw.map(x => {
          const provider = String(x.provider || x.Provider || "").toUpperCase(); // "PINNACLE" | "META_CLOUD"
          const phoneNumberId = x.phoneNumberId ?? x.PhoneNumberId;
          const whatsAppNumber =
            x.whatsAppBusinessNumber ??
            x.whatsappBusinessNumber ??
            x.displayNumber ??
            x.phoneNumber ??
            x.WhatsAppBusinessNumber ??
            x.PhoneNumber ??
            x.phoneNumberId ??
            x.PhoneNumberId;

          const id = x.id ?? x.Id ?? `${provider}|${phoneNumberId}`;
          return { id, provider, phoneNumberId, whatsAppNumber };
        });

        setSenders(normalized);
        if (normalized.length === 1) setSelectedSenderId(normalized[0].id);
      } catch {
        toast.error("‚ùå Failed to load WhatsApp senders.");
        setSenders([]);
        setSelectedSenderId("");
      }
    })();
  }, [hasValidBusiness, businessId]);

  // ---------- Actions ----------
  // Sync Templates
  const handleSyncTemplates = async () => {
    if (!hasValidBusiness) {
      toast.warn("‚ö†Ô∏è Business context missing. Please re-login.");
      return;
    }
    setSyncing(true);
    try {
      const res = await axiosClient.post(SYNC_ENDPOINT(businessId));
      const ok =
        res?.data?.success === true ||
        res?.status === 200 ||
        res?.status === 204;
      if (ok) {
        toast.success("‚úÖ Templates synced. Refreshing list‚Ä¶");
        setLoadingTemplates(true);
        try {
          const r2 = await axiosClient.get(
            `templates/${businessId}?status=APPROVED`
          );
          if (r2.data?.success) setTemplates(r2.data.templates || []);
        } finally {
          setLoadingTemplates(false);
        }
      } else {
        toast.error("‚ùå Sync failed.");
      }
    } catch {
      toast.error("‚ùå Error syncing templates.");
    } finally {
      setSyncing(false);
    }
  };

  const handleTemplateSelect = async name => {
    if (!name) {
      setSelectedTemplate(null);
      setTemplateParams([]);
      setButtonParams([]);
      setHeaderMediaUrl("");
      return;
    }
    try {
      if (!hasValidBusiness) {
        toast.error("Invalid or missing Business ID. Please re-login.");
        return;
      }
      // ‚úÖ relative path
      const res = await axiosClient.get(
        `templates/${businessId}/${encodeURIComponent(name)}`
      );

      // üîß FIX: details API returns { success, template }
      const rawTemplate = res?.data?.template || res?.data || null;
      if (!rawTemplate?.name && !rawTemplate?.Name) {
        toast.error("‚ùå Could not load template details.");
        return;
      }

      // Accept multiple shapes: stringified or already-array
      const rawButtons =
        rawTemplate.buttonsJson ??
        rawTemplate.ButtonsJson ??
        rawTemplate.buttonParams ??
        rawTemplate.ButtonParams ??
        rawTemplate.buttons ??
        rawTemplate.urlButtonsJson ?? // (won‚Äôt contain quick replies, but keep for safety)
        rawTemplate.urlButtons ??
        null;

      let parsedButtons = [];
      if (Array.isArray(rawButtons)) {
        parsedButtons = rawButtons;
      } else if (
        typeof rawButtons === "string" &&
        rawButtons.trim().startsWith("[")
      ) {
        try {
          parsedButtons = JSON.parse(rawButtons);
        } catch {
          parsedButtons = [];
        }
      }

      const hk = normalizeHeaderKind(rawTemplate);
      const requiresHeaderMediaUrl =
        rawTemplate.requiresHeaderMediaUrl === true ||
        rawTemplate.RequiresMediaHeader === true ||
        isMediaHeader(hk);

      const normalized = {
        name: rawTemplate.name ?? rawTemplate.Name,
        language: rawTemplate.language ?? rawTemplate.Language ?? "en_US",
        body: rawTemplate.body ?? rawTemplate.Body ?? "",
        headerKind: hk,
        requiresHeaderMediaUrl,
        hasImageHeader:
          rawTemplate.hasImageHeader ?? rawTemplate.HasImageHeader ?? false,
        parametersCount:
          rawTemplate.parametersCount ??
          rawTemplate.PlaceholderCount ??
          rawTemplate.placeholderCount ??
          0,
        buttonParams: toArray(parsedButtons),
      };

      setSelectedTemplate(normalized);
      setTemplateParams(Array(normalized.parametersCount).fill(""));

      // Build client-side slots for dynamic buttons (preview/input)
      const dynSlots =
        normalized.buttonParams?.map(btn => {
          const originalUrl = btn?.ParameterValue || btn?.parameterValue || "";
          const subtype = (btn?.SubType || btn?.subType || "").toLowerCase();
          const isDynamic =
            ["url", "copy_code", "flow"].includes(subtype) ||
            originalUrl.includes("{{1}}");
          return isDynamic ? "" : null;
        }) || [];
      setButtonParams(dynSlots);
      setHeaderMediaUrl("");
    } catch {
      toast.error("‚ùå Error loading template details.");
    }
  };

  // Create Campaign
  const handleCreateCampaign = async () => {
    if (!hasValidBusiness) {
      toast.error("Invalid or missing Business ID. Please re-login.");
      return;
    }
    if (!campaignName || !selectedTemplate) {
      toast.warn("‚ö†Ô∏è Please fill campaign name and choose a template.");
      return;
    }

    if (checkingName) {
      toast.info("Checking campaign name‚Ä¶");
      return;
    }
    if (nameError) {
      toast.warn("Please fix the campaign name.");
      return;
    }

    // Only require body params when NOT using CSV
    if (!useCsvPersonalization && templateParams.some(p => p === "")) {
      toast.warn("‚ö†Ô∏è Please fill all template parameters or enable CSV.");
      return;
    }
    if (useFlow && !selectedFlowId) {
      toast.warn("‚ö†Ô∏è Please select a flow or uncheck ‚ÄúAttach Flow‚Äù.");
      return;
    }

    // Resolve selected sender (required)
    const selectedSender = senders.find(s => s.id === selectedSenderId);
    if (!selectedSender || !selectedSender.phoneNumberId) {
      toast.warn("‚ö†Ô∏è Please choose a Sender (number).");
      return;
    }

    // Header media rules (campaign-level)
    const hk = selectedTemplate?.headerKind || HK.None;
    if (isMediaHeader(hk) && !headerMediaUrl) {
      toast.warn(`‚ö†Ô∏è Please provide a ${mediaLabel(hk)}.`);
      return;
    }

    setSubmitting(true);

    // Keep static button values; leave dynamic button values empty (CSV will provide later)
    const buttonPayload =
      selectedTemplate.buttonParams?.map((btn, idx) => {
        const originalUrl = btn?.ParameterValue || btn?.parameterValue || "";
        const subtype = (btn?.SubType || btn?.subType || "").toLowerCase();
        const isDynamic =
          ["url", "copy_code", "flow"].includes(subtype) ||
          originalUrl.includes("{{1}}");

        return {
          text: btn?.Text || btn?.text || "Button",
          type: btn?.Type || btn?.type || "",
          value: isDynamic
            ? useCsvPersonalization
              ? ""
              : buttonParams[idx] || ""
            : originalUrl,
          position: idx + 1,
        };
      }) || [];

    // Media mapping
    const campaignType =
      hk === HK.Image ? "image" : hk === HK.Video ? "video" : "text";

    const payload = {
      name: campaignName,
      messageTemplate: (selectedTemplate.body || "").trim(),
      templateId: selectedTemplate.name,
      templateLanguage: selectedTemplate.language || undefined,
      buttonParams: buttonPayload,

      campaignType,
      imageUrl: hk === HK.Image ? headerMediaUrl : null,
      videoUrl: hk === HK.Video ? headerMediaUrl : null,
      documentUrl: hk === HK.Document ? headerMediaUrl : null,

      headerMediaUrl: isMediaHeader(hk) ? headerMediaUrl : null,
      headerKind: hk,

      scheduledAt: scheduledAt ? new Date(scheduledAt).toISOString() : null,
      createdBy,
      businessId,

      templateParameters: useCsvPersonalization ? [] : templateParams,
      useCsvPersonalization,

      ctaFlowConfigId: useFlow ? selectedFlowId : null,

      provider: String(selectedSender.provider || "").toUpperCase(),
      phoneNumberId: selectedSender.phoneNumberId,
    };

    try {
      await checkNameAvailability(campaignName);
      if (nameError) {
        toast.warn("Please choose a different campaign name.");
        setSubmitting(false);
        return;
      }

      const res = await axiosClient.post(
        `campaign/create-text-campaign`,
        payload
      );
      if (res.data?.success && res.data?.campaignId) {
        toast.success("‚úÖ Campaign created successfully.");
        navigate(
          `/app/campaigns/image-campaigns/assign-contacts/${res.data.campaignId}`
        );
      } else {
        toast.error("‚ùå Failed to create campaign.");
      }
    } catch (err) {
      const errorMsg =
        err?.response?.data?.message || "‚ùå Error creating campaign.";
      if (
        typeof errorMsg === "string" &&
        errorMsg.toLowerCase().includes("campaign") &&
        errorMsg.toLowerCase().includes("name") &&
        errorMsg.toLowerCase().includes("exists")
      ) {
        setNameError("Name already exists. Please choose another.");
      }
      toast.error(errorMsg);
    } finally {
      setSubmitting(false);
    }
  };

  const templateOptions = useMemo(
    () =>
      templates.map(tpl => ({
        key: `${tpl.name || tpl.Name}-${
          tpl.language || tpl.Language || "en_US"
        }`,
        label: `${tpl.name || tpl.Name} (${
          tpl.language || tpl.Language || "en_US"
        }) ‚Äî ${
          tpl.placeholderCount ??
          tpl.ParametersCount ??
          tpl.PlaceholderCount ??
          0
        } params`,
        value: tpl.name || tpl.Name,
      })),
    [templates]
  );

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 to-emerald-50">
      <div className="mx-auto max-w-6xl px-4 py-8">
        {/* Header */}
        <div className="mb-8">
          <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div>
              <h1 className="text-3xl font-bold text-gray-900 mb-2">
                Create WhatsApp Campaign
              </h1>
              <p className="text-gray-600 text-lg">
                Build engaging campaigns with approved templates
              </p>
            </div>

            {/* Sync Templates */}
            <div className="flex items-center gap-3">
              <button
                type="button"
                onClick={handleSyncTemplates}
                disabled={!hasValidBusiness || syncing}
                className={`rounded-xl px-6 py-3 text-sm font-semibold text-white shadow-lg transition-all duration-200 ${
                  !hasValidBusiness || syncing
                    ? "bg-gray-400 cursor-not-allowed"
                    : "bg-gradient-to-r from-sapphire-600 to-cyan-600 hover:from-sapphire-700 hover:to-cyan-700 hover:shadow-xl transform hover:scale-105"
                }`}
                title={
                  !hasValidBusiness
                    ? "Login required to sync templates"
                    : undefined
                }
              >
                {syncing ? (
                  <div className="flex items-center gap-2">
                    <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                    <span>Syncing‚Ä¶</span>
                  </div>
                ) : (
                  <div className="flex items-center gap-2">
                    <svg
                      className="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                      />
                    </svg>
                    <span>Sync Templates</span>
                  </div>
                )}
              </button>
            </div>
          </div>
        </div>

        {/* Business guard */}
        {!hasValidBusiness && (
          <div className="mb-6 rounded-2xl border border-amber-200 bg-gradient-to-r from-amber-50 to-orange-50 p-6 shadow-lg">
            <div className="flex items-start gap-4">
              <div className="flex-shrink-0">
                <div className="w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center">
                  <svg
                    className="w-5 h-5 text-amber-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={2}
                      d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"
                    />
                  </svg>
                </div>
              </div>
              <div className="flex-1">
                <h3 className="text-lg font-semibold text-amber-900 mb-2">
                  Loading Business Context
                </h3>
                <p className="text-amber-800 mb-4">
                  We're setting up your business environment. If this doesn't
                  resolve in a moment, please re-login so we can attach your
                  Business ID to requests.
                </p>
                <button
                  onClick={() => navigate("/login")}
                  className="bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 text-white px-6 py-2 rounded-lg font-semibold transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105"
                  type="button"
                >
                  Go to Login
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Content grid */}
        <div className="grid gap-6 lg:grid-cols-[1fr_400px]">
          {/* Left column ‚Äì unified form */}
          <div>
            <div className="bg-white rounded-lg shadow-xl border border-gray-200 hover:border-gray-300 transition-all duration-200 p-6">
              <form className="space-y-6">
                {/* Campaign Details Section */}
                <div className="space-y-4">
                  <div className="flex items-center gap-3 pb-3 border-b border-gray-200">
                    <div className="w-7 h-7 bg-emerald-100 rounded-full flex items-center justify-center">
                      <span className="text-emerald-600 font-bold text-xs">
                        1
                      </span>
                    </div>
                    <h3 className="text-base font-semibold text-gray-900">
                      Campaign Details
                    </h3>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-xs font-semibold text-gray-700 mb-1">
                        Campaign Name *
                      </label>
                      <input
                        type="text"
                        className={`w-full rounded-lg border px-3 py-2 text-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent ${
                          nameError
                            ? "border-red-400 bg-red-50"
                            : "border-gray-300 focus:bg-white"
                        }`}
                        placeholder="e.g. Diwali Blast ‚Äì Returning Customers"
                        value={campaignName}
                        onChange={e => {
                          setCampaignName(e.target.value);
                          setNameError("");
                        }}
                        onBlur={() => checkNameAvailability(campaignName)}
                        disabled={!hasValidBusiness}
                      />
                      <div className="mt-1 flex items-center justify-between">
                        <p className="text-xs text-gray-500">
                          Must be unique within your workspace
                        </p>
                        {checkingName && (
                          <div className="flex items-center gap-1 text-xs text-emerald-600">
                            <div className="animate-spin rounded-full h-3 w-3 border-b-2 border-emerald-600"></div>
                            <span>checking‚Ä¶</span>
                          </div>
                        )}
                      </div>
                      {nameError && (
                        <p className="mt-1 text-xs font-medium text-red-600 bg-red-50 px-2 py-1 rounded">
                          {nameError}
                        </p>
                      )}
                    </div>

                    <div>
                      <label className="block text-xs font-semibold text-gray-700 mb-1">
                        Template *
                        <span className="text-emerald-600 font-medium ml-1">
                          (approved)
                        </span>
                      </label>
                      <select
                        disabled={loadingTemplates || !hasValidBusiness}
                        className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed"
                        onChange={e => handleTemplateSelect(e.target.value)}
                        value={selectedTemplate?.name || ""}
                      >
                        <option value="" disabled>
                          {loadingTemplates
                            ? "Loading templates‚Ä¶"
                            : "-- Select Template --"}
                        </option>
                        {templateOptions.map(o => (
                          <option key={o.key} value={o.value}>
                            {o.label}
                          </option>
                        ))}
                      </select>
                      <p className="mt-1 text-xs text-gray-500">
                        Only{" "}
                        <span className="font-semibold text-emerald-600">
                          APPROVED
                        </span>{" "}
                        templates are listed
                      </p>
                    </div>
                  </div>
                </div>

                {/* Flow Integration Section */}
                <div className="space-y-4">
                  <div className="flex items-center gap-3 pb-3 border-b border-gray-200">
                    <div className="w-7 h-7 bg-cyan-100 rounded-full flex items-center justify-center">
                      <span className="text-cyan-600 font-bold text-xs">2</span>
                    </div>
                    <h3 className="text-base font-semibold text-gray-900">
                      Flow Integration
                    </h3>
                    <span className="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">
                      Optional
                    </span>
                  </div>

                  <div className="space-y-3">
                    <div className="flex items-center gap-3 p-3 bg-gradient-to-r from-cyan-50 to-blue-50 rounded-lg border border-cyan-200">
                      <input
                        id="useFlow"
                        type="checkbox"
                        checked={useFlow}
                        onChange={e => {
                          setUseFlow(e.target.checked);
                          if (!e.target.checked) setSelectedFlowId("");
                        }}
                        disabled={!hasValidBusiness}
                        className="w-4 h-4 text-cyan-600 bg-gray-100 border-gray-300 rounded focus:ring-cyan-500 focus:ring-2"
                      />
                      <label
                        htmlFor="useFlow"
                        className="text-sm font-medium text-gray-700 cursor-pointer"
                      >
                        Attach a Visual Flow to this campaign
                      </label>
                    </div>

                    {useFlow && (
                      <div className="space-y-2">
                        <label className="block text-xs font-semibold text-gray-700">
                          Select Flow
                        </label>
                        <select
                          className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed"
                          disabled={loadingFlows || !hasValidBusiness}
                          value={selectedFlowId}
                          onChange={e => setSelectedFlowId(e.target.value)}
                        >
                          <option value="">
                            {loadingFlows
                              ? "Loading flows‚Ä¶"
                              : "-- Select Flow --"}
                          </option>
                          {flows.map(f => (
                            <option key={f.id} value={f.id}>
                              {f.name}
                            </option>
                          ))}
                        </select>
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-2">
                          <p className="text-xs text-blue-800">
                            <strong>Note:</strong> If attached, the campaign
                            will <strong>start</strong> from the flow's entry
                            step. The backend will align the starting template
                            automatically.
                          </p>
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                {/* Personalization Section */}
                {selectedTemplate && (
                  <div className="space-y-4">
                    <div className="flex items-center gap-3 pb-3 border-b border-gray-200">
                      <div className="w-7 h-7 bg-purple-100 rounded-full flex items-center justify-center">
                        <span className="text-purple-600 font-bold text-xs">
                          3
                        </span>
                      </div>
                      <h3 className="text-base font-semibold text-gray-900">
                        Personalization
                      </h3>
                    </div>

                    {/* CSV toggle */}
                    <div className="flex items-center gap-3 p-3 bg-gradient-to-r from-emerald-50 to-cyan-50 rounded-lg border border-emerald-200">
                      <input
                        id="useCsv"
                        type="checkbox"
                        checked={useCsvPersonalization}
                        onChange={e =>
                          setUseCsvPersonalization(e.target.checked)
                        }
                        className="w-4 h-4 text-emerald-600 bg-gray-100 border-gray-300 rounded focus:ring-emerald-500 focus:ring-2"
                      />
                      <label
                        htmlFor="useCsv"
                        className="text-sm font-medium text-gray-700 cursor-pointer"
                      >
                        I'll upload a CSV later for personalization (recommended
                        for bulk campaigns)
                      </label>
                    </div>

                    {/* Body params ‚Äî show only if NOT using CSV */}
                    {!useCsvPersonalization && templateParams.length > 0 && (
                      <div className="space-y-3">
                        <h4 className="text-xs font-semibold text-gray-700 flex items-center gap-2">
                          <div className="w-2 h-2 bg-emerald-500 rounded-full"></div>
                          Template Parameters
                        </h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                          {templateParams.map((val, idx) => (
                            <div key={`tp-${idx}`} className="space-y-1">
                              <label className="text-xs font-medium text-gray-600">
                                Parameter {idx + 1} {`{{${idx + 1}}}`}
                              </label>
                              <input
                                className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
                                placeholder={`Value for {{${idx + 1}}}`}
                                value={val}
                                onChange={e => {
                                  const next = [...templateParams];
                                  next[idx] = e.target.value;
                                  setTemplateParams(next);
                                }}
                                disabled={!hasValidBusiness}
                              />
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Button params ‚Äî show only if NOT using CSV */}
                    {!useCsvPersonalization &&
                      (selectedTemplate?.buttonParams?.length ?? 0) > 0 && (
                        <div className="space-y-3">
                          <h4 className="text-xs font-semibold text-gray-700 flex items-center gap-2">
                            <div className="w-2 h-2 bg-cyan-500 rounded-full"></div>
                            Button Parameters
                          </h4>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                            {selectedTemplate.buttonParams.map((btn, idx) => {
                              const originalUrl =
                                btn?.ParameterValue ||
                                btn?.parameterValue ||
                                "";
                              const subtype = (
                                btn?.SubType ||
                                btn?.subType ||
                                ""
                              ).toLowerCase();
                              const dynamic =
                                ["url", "copy_code", "flow"].includes(
                                  subtype
                                ) || originalUrl.includes("{{1}}");
                              const placeholders = {
                                url: "Enter Redirect URL",
                                copy_code: "Enter Coupon Code",
                                flow: "Enter Flow ID",
                              };
                              const title =
                                btn?.Text || btn?.text || `Button ${idx + 1}`;
                              return (
                                <div key={`bp-${idx}`} className="space-y-1">
                                  <label className="text-xs font-medium text-gray-600">
                                    {title} ¬∑{" "}
                                    <span className="text-cyan-600 font-semibold">
                                      {subtype
                                        ? subtype.toUpperCase()
                                        : "STATIC"}
                                    </span>
                                  </label>
                                  {dynamic ? (
                                    <input
                                      className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                                      placeholder={
                                        placeholders[subtype] || "Enter value"
                                      }
                                      value={buttonParams[idx] || ""}
                                      onChange={e => {
                                        const next = [...buttonParams];
                                        next[idx] = e.target.value;
                                        setButtonParams(next);
                                      }}
                                      disabled={
                                        !hasValidBusiness ||
                                        useCsvPersonalization
                                      }
                                    />
                                  ) : (
                                    <div className="rounded-lg border border-dashed border-gray-300 bg-gray-50 px-3 py-2">
                                      <p className="text-xs text-gray-600">
                                        {subtype === "quick_reply"
                                          ? "Quick reply (no value required)"
                                          : `Static value: ${
                                              originalUrl || "N/A"
                                            }`}
                                      </p>
                                    </div>
                                  )}
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      )}
                  </div>
                )}

                {/* Delivery Settings Section */}
                <div className="space-y-4">
                  <div className="flex items-center gap-3 pb-3 border-b border-gray-200">
                    <div className="w-7 h-7 bg-orange-100 rounded-full flex items-center justify-center">
                      <span className="text-orange-600 font-bold text-xs">
                        4
                      </span>
                    </div>
                    <h3 className="text-base font-semibold text-gray-900">
                      Delivery Settings
                    </h3>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {/* Sender selection */}
                    <div>
                      <label className="block text-xs font-semibold text-gray-700 mb-1">
                        Sender (WhatsApp Number) *
                      </label>
                      <select
                        className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed"
                        disabled={!hasValidBusiness || !senders.length}
                        value={selectedSenderId}
                        onChange={e => setSelectedSenderId(e.target.value)}
                      >
                        <option value="" disabled>
                          {senders.length
                            ? "-- Select Sender --"
                            : "No active senders found"}
                        </option>
                        {senders.map(s => (
                          <option key={s.id} value={s.id}>
                            {s.whatsAppNumber}
                          </option>
                        ))}
                      </select>
                      <p className="mt-1 text-xs text-gray-500">
                        We'll save the sender's phoneNumberId and provider
                      </p>
                    </div>

                    {/* Schedule */}
                    <div>
                      <label className="block text-xs font-semibold text-gray-700 mb-1">
                        Schedule
                      </label>
                      <input
                        type="datetime-local"
                        className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
                        value={scheduledAt}
                        onChange={e => setScheduledAt(e.target.value)}
                        disabled={!hasValidBusiness}
                      />
                      <p className="mt-1 text-xs text-gray-500">
                        Leave empty to send immediately after assignment
                      </p>
                    </div>
                  </div>

                  {/* Header Media URL */}
                  {selectedTemplate?.requiresHeaderMediaUrl && (
                    <div>
                      <label className="block text-xs font-semibold text-gray-700 mb-1">
                        {mediaLabel(selectedTemplate.headerKind)} *
                      </label>
                      <input
                        type="text"
                        className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
                        placeholder="https://‚Ä¶"
                        value={headerMediaUrl}
                        onChange={e => setHeaderMediaUrl(e.target.value)}
                        disabled={!hasValidBusiness}
                      />
                      <p className="mt-2 text-xs text-gray-500">
                        Must be a public HTTPS link (set once per campaign)
                      </p>
                    </div>
                  )}
                </div>

                {/* Submit Button */}
                <div className="pt-4 border-t border-gray-200">
                  <button
                    type="button"
                    onClick={handleCreateCampaign}
                    disabled={
                      submitting ||
                      !hasValidBusiness ||
                      checkingName ||
                      !!nameError
                    }
                    className={`w-full rounded-xl px-6 py-3 text-base font-bold text-white shadow-lg transition-all duration-200 ${
                      submitting ||
                      !hasValidBusiness ||
                      checkingName ||
                      !!nameError
                        ? "bg-gray-400 cursor-not-allowed"
                        : "bg-gradient-to-r from-emerald-600 to-sapphire-600 hover:from-emerald-700 hover:to-sapphire-700 hover:shadow-xl transform hover:scale-105"
                    }`}
                    title={
                      !hasValidBusiness
                        ? "Login required to create a campaign"
                        : nameError
                        ? "Fix campaign name"
                        : undefined
                    }
                  >
                    {submitting ? (
                      <div className="flex items-center justify-center gap-2">
                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                        <span>Creating Campaign...</span>
                      </div>
                    ) : (
                      <div className="flex items-center justify-center gap-2">
                        <svg
                          className="w-4 h-4"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                          />
                        </svg>
                        <span>Create Campaign</span>
                      </div>
                    )}
                  </button>
                </div>
              </form>
            </div>
          </div>

          {/* Right column ‚Äì sticky preview */}
          <aside className="lg:sticky lg:top-8">
            <div className="bg-white rounded-lg shadow-xl border border-gray-200 hover:border-gray-300 transition-all duration-200 p-6">
              <div className="mb-4 flex items-center justify-between">
                <div>
                  <h3 className="text-lg font-bold text-gray-900">
                    Template Preview
                  </h3>
                  <p className="text-xs text-gray-500">
                    See how your campaign will look
                  </p>
                </div>
              </div>

              {hasValidBusiness ? (
                selectedTemplate ? (
                  <div className="flex justify-center">
                    <div className="relative">
                      <PhoneWhatsAppPreview
                        businessName={businessName}
                        templateBody={selectedTemplate.body}
                        parameters={useCsvPersonalization ? [] : templateParams}
                        // For now, only image preview is supported; others will come later.
                        imageUrl={
                          selectedTemplate.headerKind === HK.Image
                            ? headerMediaUrl
                            : ""
                        }
                        buttonParams={(selectedTemplate.buttonParams || []).map(
                          btn => {
                            const originalUrl =
                              btn?.ParameterValue || btn?.parameterValue || "";
                            const subtype = (
                              btn?.SubType ||
                              btn?.subType ||
                              ""
                            ).toLowerCase();
                            const isDynamic =
                              ["url", "copy_code", "flow"].includes(subtype) ||
                              originalUrl.includes("{{1}}");
                            return {
                              text: btn?.Text || btn?.text || "Button",
                              subType: btn?.SubType || btn?.subType || "",
                              type: btn?.Type || btn?.type || "",
                              value: isDynamic ? "" : originalUrl, // quick_reply will show with empty value just fine
                            };
                          }
                        )}
                        width="clamp(330px, 42vw, 410px)"
                      />
                    </div>
                  </div>
                ) : (
                  <div className="flex h-[460px] items-center justify-center rounded-2xl border-2 border-dashed border-gray-200 bg-gradient-to-br from-gray-50 to-emerald-50">
                    <div className="text-center">
                      <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg
                          className="w-8 h-8 text-gray-400"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                          />
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                          />
                        </svg>
                      </div>
                      <p className="text-sm text-gray-500 font-medium">
                        Select a template to preview
                      </p>
                      <p className="text-xs text-gray-400 mt-1">
                        Your campaign preview will appear here
                      </p>
                    </div>
                  </div>
                )
              ) : (
                <div className="flex h-[460px] items-center justify-center rounded-2xl border-2 border-dashed border-amber-200 bg-gradient-to-br from-amber-50 to-orange-50">
                  <div className="text-center">
                    <div className="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4">
                      <svg
                        className="w-8 h-8 text-amber-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"
                        />
                      </svg>
                    </div>
                    <p className="text-sm text-amber-800 font-medium">
                      Waiting for Business ID
                    </p>
                    <p className="text-xs text-amber-600 mt-1">
                      Please wait while we load your business context
                    </p>
                  </div>
                </div>
              )}
            </div>
          </aside>
        </div>
      </div>
    </div>
  );
}

export default CampaignBuilderPage;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\CampaignCreateSingle.jsx 
====================================================== 
 
// ‚úÖ File: src/pages/campaigns/CampaignCreateSingle.jsx
import React, { useEffect, useState } from "react";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";
import { useNavigate } from "react-router-dom";

function CampaignCreateSingle() {
  const navigate = useNavigate();

  const [templates] = useState([]);
  const [contacts, setContacts] = useState([]);
  const [loadingContacts, setLoadingContacts] = useState(true);
  const [submitting, setSubmitting] = useState(false);

  const [templateMessage, setTemplateMessage] = useState("");
  const [form, setForm] = useState({
    templateName: "",
    message: "",
    contactIds: [],
    name: "",
    scheduledAt: "",
    templateParams: [],
  });

  const isFormValid =
    form.name.trim() &&
    (form.templateName || form.message.trim()) &&
    form.contactIds.length > 0;

  const generatePreview = (template, paramValues) => {
    if (!template) return "";
    return template.replace(/{{(\d+)}}/g, (_, p1) => {
      const index = parseInt(p1, 10) - 1;
      return paramValues[index] || `{{${p1}}}`;
    });
  };

  const previewMessage = generatePreview(
    templateMessage || form.message,
    form.templateParams
  );

  const extractParamCount = message => {
    const matches = message.match(/{{\d+}}/g);
    const unique = [...new Set(matches || [])];
    return unique.length;
  };

  const updateField = (key, value) => {
    setForm(f => ({ ...f, [key]: value }));
  };

  const handleTemplateChange = e => {
    const tplName = e.target.value;
    const tpl = templates.find(t => t.name === tplName);
    const msg = tpl?.body || "";
    const paramCount = extractParamCount(msg);

    setTemplateMessage(msg);
    updateField("templateName", tplName);
    updateField("templateParams", Array(paramCount).fill(""));
    updateField("message", "");
  };

  const updateParam = (index, value) => {
    setForm(f => {
      const updated = [...f.templateParams];
      updated[index] = value;
      return { ...f, templateParams: updated };
    });
  };

  const toggleContact = id => {
    setForm(f => ({
      ...f,
      contactIds: f.contactIds.includes(id)
        ? f.contactIds.filter(cid => cid !== id)
        : [...f.contactIds, id],
    }));
  };

  const handleSubmit = async () => {
    if (!isFormValid) {
      if (!form.name.trim()) toast.warn("‚ö†Ô∏è Campaign name is required");
      else if (form.contactIds.length === 0) toast.warn("‚ö†Ô∏è Select contacts");
      else toast.warn("‚ö†Ô∏è Message cannot be empty");
      return;
    }

    setSubmitting(true);

    const payload = {
      name: form.name.trim(),
      contactIds: form.contactIds,
      scheduledAt: form.scheduledAt || null,
      isTemplate: !!form.templateName,
      ...(form.templateName
        ? {
            templateName: form.templateName,
            templateId: form.templateName,
            templateParams: form.templateParams,
            messageTemplate: previewMessage.trim(),
          }
        : {
            messageTemplate: form.message.trim(),
          }),
    };

    try {
      const res = await axiosClient.post(
        "campaign/create-text-campaign",
        payload
      );
      toast.success("üöÄ Campaign created!");
      localStorage.setItem(
        "lastCampaign",
        JSON.stringify({
          lastCampaignName: form.name.trim(),
          lastCampaignId: res?.data?.campaignId || null,
          launchedAt: new Date().toISOString(),
        })
      );
      navigate("/app/campaigns/list");
    } catch (err) {
      toast.error("‚ùå Failed to create campaign");
      console.error(err);
    } finally {
      setSubmitting(false);
    }
  };

  useEffect(() => {
    axiosClient
      .get("/contacts")
      .then(res => {
        const contactList = Array.isArray(res.data) ? res.data : res.data?.data;

        if (!Array.isArray(contactList)) {
          toast.error("‚ùå Invalid contact format received");
          return setContacts([]);
        }

        setContacts(contactList);
      })
      .catch(() => toast.error("‚ùå Error loading contacts"))
      .finally(() => setLoadingContacts(false));
  }, []);

  return (
    <div className="max-w-3xl mx-auto p-6 space-y-6">
      <h1 className="text-2xl font-bold text-purple-700">‚ú® Build Campaign</h1>

      {/* Template Selection */}
      <div className="bg-white p-4 rounded shadow space-y-2">
        <label className="font-medium">Approved Template (optional)</label>
        <select
          value={form.templateName}
          onChange={handleTemplateChange}
          className="w-full border rounded px-3 py-2"
        >
          <option value="">‚Äì none ‚Äì</option>
          {templates.map(t => (
            <option key={t.name} value={t.name}>
              {t.name} ({t.language})
            </option>
          ))}
        </select>

        <label className="font-medium">Message Body</label>
        <div className="w-full border rounded px-3 py-2 bg-gray-100 whitespace-pre-wrap text-sm text-gray-800">
          {templateMessage || form.message}
        </div>

        {form.templateName &&
          form.templateParams.map((param, idx) => (
            <input
              key={idx}
              type="text"
              value={param}
              onChange={e => updateParam(idx, e.target.value)}
              placeholder={`Param ${idx + 1}`}
              className="w-full border rounded px-3 py-2 mt-2"
            />
          ))}

        <p className="text-xs text-gray-500">
          Placeholders like <code>{`{{1}}`}</code> will be auto-replaced.
        </p>
      </div>

      {/* Contact Selection */}
      <div className="bg-white p-4 rounded shadow space-y-2">
        <label className="font-medium">Select Contacts</label>
        <div className="flex gap-2 mb-2">
          <button
            onClick={() =>
              setForm(f => ({
                ...f,
                contactIds: contacts.map(c => c.id),
              }))
            }
            className="px-2 py-1 bg-blue-100 text-blue-700 rounded text-sm"
          >
            Select All
          </button>
          <button
            onClick={() => updateField("contactIds", [])}
            className="px-2 py-1 bg-gray-100 text-gray-600 rounded text-sm"
          >
            Deselect All
          </button>
          <span className="text-sm text-gray-500">
            {form.contactIds.length} selected
          </span>
        </div>
        {loadingContacts ? (
          <p>Loading contacts‚Ä¶</p>
        ) : (
          <div className="grid md:grid-cols-2 gap-2 max-h-64 overflow-auto">
            {contacts.map(c => (
              <label
                key={c.id}
                className="flex flex-col border rounded p-2 hover:bg-gray-50"
              >
                <div className="flex items-center gap-2 text-sm">
                  <input
                    type="checkbox"
                    checked={form.contactIds.includes(c.id)}
                    onChange={() => toggleContact(c.id)}
                  />
                  {c.name} ({c.phoneNumber})
                </div>
              </label>
            ))}
          </div>
        )}
      </div>

      {/* Campaign Info */}
      <div className="bg-white p-4 rounded shadow space-y-2">
        <label className="font-medium">Campaign Name</label>
        <input
          type="text"
          value={form.name}
          onChange={e => updateField("name", e.target.value)}
          className="w-full border rounded px-3 py-2"
          placeholder="e.g. Summer Promo"
        />
        <label className="font-medium">Schedule (optional)</label>
        <input
          type="datetime-local"
          value={form.scheduledAt}
          onChange={e => updateField("scheduledAt", e.target.value)}
          className="w-full border rounded px-3 py-2"
        />
      </div>

      {/* Preview */}
      <div className="bg-gray-100 p-4 rounded text-sm">
        <p className="font-semibold mb-1">üëÅÔ∏è Live Preview</p>
        <p className="whitespace-pre-wrap">{previewMessage}</p>
      </div>

      {/* Submit */}
      <button
        onClick={handleSubmit}
        disabled={!isFormValid || submitting}
        className={`w-full py-3 font-semibold rounded transition ${
          isFormValid && !submitting
            ? "bg-green-600 text-white hover:bg-green-700"
            : "bg-gray-300 text-gray-500 cursor-not-allowed"
        }`}
      >
        {submitting ? "‚è≥ Launching..." : "üöÄ Launch Campaign"}
      </button>
    </div>
  );
}

export default CampaignCreateSingle;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\CampaignList.jsx 
====================================================== 
 
import React, { useEffect, useState, useCallback } from "react";
import axiosClient from "../../api/axiosClient";
import { useNavigate } from "react-router-dom";
import { toast } from "react-toastify";
import { saveAs } from "file-saver";

function CampaignList() {
  const [campaigns, setCampaigns] = useState([]);
  const [loading, setLoading] = useState(true);
  const [page, setPage] = useState(1);
  const [pageSize, setPageSize] = useState(10);
  const [totalCount, setTotalCount] = useState(0); // fixed useState syntax
  const [search, setSearch] = useState("");
  const [statusFilter, setStatusFilter] = useState("");

  const navigate = useNavigate();

  // Wrap in useCallback!
  const fetchCampaigns = useCallback(async () => {
    try {
      setLoading(true);
      const res = await axiosClient.get(
        `/Campaign/paginated?page=${page}&pageSize=${pageSize}&status=${statusFilter}`
      );
      setCampaigns(res.data.items);
      setTotalCount(res.data.totalCount);
    } catch (err) {
      toast.error("‚ùå Failed to load campaigns");
    } finally {
      setLoading(false);
    }
  }, [page, pageSize, statusFilter]);

  useEffect(() => {
    fetchCampaigns();
  }, [fetchCampaigns]);

  const handleDelete = async id => {
    if (!window.confirm("Are you sure you want to delete this campaign?"))
      return;
    try {
      await axiosClient.delete(`/Campaign/${id}`);
      toast.success("üóëÔ∏è Campaign deleted");
      fetchCampaigns();
    } catch {
      toast.error("‚ùå Delete failed");
    }
  };

  const handleSendCampaign = async id => {
    try {
      await axiosClient.post(`/campaign/send/${id}`);
      toast.success("‚úÖ Campaign sent successfully");
      fetchCampaigns();
    } catch {
      toast.error("‚ùå Sending campaign failed");
    }
  };

  const filteredCampaigns = campaigns.filter(c =>
    (c.name || "").toLowerCase().includes(search.toLowerCase())
  );

  const handleExport = () => {
    const csvRows = [
      ["Name", "Status", "ScheduledAt", "CreatedAt"],
      ...filteredCampaigns.map(c => [
        c.name,
        c.status,
        c.scheduledAt || "-",
        new Date(c.createdAt).toLocaleString(),
      ]),
    ];
    const blob = new Blob([csvRows.map(r => r.join(",")).join("\n")], {
      type: "text/csv",
    });
    saveAs(blob, "campaigns.csv");
  };

  const getStatusBadge = status => {
    const color =
      status === "Draft"
        ? "bg-yellow-100 text-yellow-800"
        : status === "Sent"
        ? "bg-green-100 text-green-800"
        : "bg-gray-200 text-gray-800";
    return (
      <span className={`px-2 py-1 rounded text-xs font-semibold ${color}`}>
        {status}
      </span>
    );
  };

  return (
    <div className="p-6 max-w-7xl mx-auto space-y-6">
      <div className="bg-white rounded-md shadow border">
        {/* Header */}
        <div className="flex justify-between items-center px-5 py-4 border-b">
          <h2 className="text-lg font-semibold text-emerald-800">
            üìã Campaigns List
          </h2>
          <div className="flex gap-2">
            <button
              onClick={() => navigate("/app/campaigns/template-single")}
              className="px-3 py-1.5 text-sm border rounded-md text-gray-700 hover:bg-gray-100"
            >
              ‚ûï New Campaign
            </button>
            <button
              onClick={handleExport}
              className="px-3 py-1.5 text-sm border rounded-md text-gray-700 hover:bg-gray-100"
            >
              ‚¨á Export CSV
            </button>
          </div>
        </div>

        {/* Show total count */}
        <div className="flex justify-between items-center px-5 py-2">
          <span className="text-sm text-gray-600">
            Showing {filteredCampaigns.length} of {totalCount} campaigns
          </span>
        </div>

        {/* Filters */}
        <div className="px-5 py-4 grid grid-cols-1 md:grid-cols-3 gap-4 border-b bg-gray-50">
          <input
            type="text"
            placeholder="Search by name..."
            className="border rounded px-3 py-2 text-sm"
            value={search}
            onChange={e => setSearch(e.target.value)}
          />
          <select
            className="border rounded px-3 py-2 text-sm"
            value={statusFilter}
            onChange={e => setStatusFilter(e.target.value)}
          >
            <option value="">All Statuses</option>
            <option value="Draft">Draft</option>
            <option value="Sent">Sent</option>
          </select>
          <select
            className="border rounded px-3 py-2 text-sm"
            value={pageSize}
            onChange={e => {
              setPageSize(Number(e.target.value));
              setPage(1);
            }}
          >
            {[10, 25, 50].map(size => (
              <option key={size} value={size}>
                Show {size}
              </option>
            ))}
          </select>
        </div>

        {/* Table */}
        <div className="overflow-x-auto rounded-md">
          {loading ? (
            <div className="p-5 text-gray-500 text-sm">
              ‚è≥ Loading campaigns...
            </div>
          ) : filteredCampaigns.length === 0 ? (
            <div className="p-6 text-center text-gray-500">
              <p className="text-md">üòï No campaigns found</p>
              <p className="text-sm">Try adjusting filters or create one.</p>
            </div>
          ) : (
            <table className="w-full text-sm">
              <thead className="bg-gray-100 text-gray-600 font-semibold">
                <tr>
                  <th className="p-3 text-left">Name</th>
                  <th className="p-3 text-left">Status</th>
                  <th className="p-3 text-left">Scheduled</th>
                  <th className="p-3 text-left">Created</th>
                  <th className="p-3 text-left">Actions</th>
                </tr>
              </thead>
              <tbody>
                {filteredCampaigns.map(c => (
                  <tr key={c.id} className="border-t hover:bg-gray-50">
                    <td className="p-3">{c.name}</td>
                    <td className="p-3">{getStatusBadge(c.status)}</td>
                    <td className="p-3">
                      {c.scheduledAt
                        ? new Date(c.scheduledAt).toLocaleString()
                        : "-"}
                    </td>
                    <td className="p-3">
                      {new Date(c.createdAt).toLocaleString()}
                    </td>
                    <td className="p-3 space-x-1">
                      <button
                        onClick={() => navigate(`/app/campaigns/edit/${c.id}`)}
                        className="bg-blue-500 text-white px-2 py-1 text-xs rounded hover:bg-blue-600"
                      >
                        ‚úèÔ∏è Edit
                      </button>
                      <button
                        onClick={() => navigate(`/app/campaigns/logs/${c.id}`)}
                        className="bg-purple-600 text-white px-2 py-1 text-xs rounded hover:bg-purple-700"
                      >
                        üìä Logs
                      </button>
                      <button
                        onClick={() =>
                          navigate(`/app/campaigns/dashboard/${c.id}`)
                        }
                        className="bg-indigo-600 text-white px-2 py-1 text-xs rounded hover:bg-indigo-700"
                      >
                        üìà Stats
                      </button>
                      {c.status?.toLowerCase() === "draft" && (
                        <button
                          onClick={() => handleSendCampaign(c.id)}
                          className="bg-green-600 text-white px-2 py-1 text-xs rounded hover:bg-green-700"
                        >
                          üöÄ Send
                        </button>
                      )}
                      <button
                        onClick={() => handleDelete(c.id)}
                        className="bg-red-500 text-white px-2 py-1 text-xs rounded hover:bg-red-600"
                      >
                        üóëÔ∏è Delete
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </div>
      </div>
    </div>
  );
}

export default CampaignList;

// import React, { useEffect, useState } from "react";
// import axiosClient from "../../api/axiosClient";
// import { useNavigate } from "react-router-dom";
// import { toast } from "react-toastify";
// import { saveAs } from "file-saver";

// function CampaignList() {
//   const [campaigns, setCampaigns] = useState([]);
//   const [loading, setLoading] = useState(true);
//   const [page, setPage] = useState(1);
//   const [pageSize, setPageSize] = useState(10);
//   const [setTotalCount] = useState(0);
//   const [search, setSearch] = useState("");
//   const [statusFilter, setStatusFilter] = useState("");

//   const navigate = useNavigate();

//   const fetchCampaigns = async () => {
//     try {
//       setLoading(true);
//       const res = await axiosClient.get(
//         `/Campaign/paginated?page=${page}&pageSize=${pageSize}&status=${statusFilter}`
//       );
//       setCampaigns(res.data.items);
//       setTotalCount(res.data.totalCount);
//     } catch (err) {
//       toast.error("‚ùå Failed to load campaigns");
//     } finally {
//       setLoading(false);
//     }
//   };

//   useEffect(() => {
//     fetchCampaigns();
//   }, [page, pageSize, statusFilter]);

//   const handleDelete = async id => {
//     if (!window.confirm("Are you sure you want to delete this campaign?"))
//       return;
//     try {
//       await axiosClient.delete(`/Campaign/${id}`);
//       toast.success("üóëÔ∏è Campaign deleted");
//       fetchCampaigns();
//     } catch {
//       toast.error("‚ùå Delete failed");
//     }
//   };

//   const handleSendCampaign = async id => {
//     try {
//       // await axiosClient.post(`/campaign/send-template-simple`);
//       await axiosClient.post(`/campaign/send/${id}`);
//       toast.success("‚úÖ Campaign sent successfully");
//       fetchCampaigns();
//     } catch {
//       toast.error("‚ùå Sending campaign failed");
//     }
//   };

//   const filteredCampaigns = campaigns.filter(c =>
//     (c.name || "").toLowerCase().includes(search.toLowerCase())
//   );

//   const handleExport = () => {
//     const csvRows = [
//       ["Name", "Status", "ScheduledAt", "CreatedAt"],
//       ...filteredCampaigns.map(c => [
//         c.name,
//         c.status,
//         c.scheduledAt || "-",
//         new Date(c.createdAt).toLocaleString(),
//       ]),
//     ];
//     const blob = new Blob([csvRows.map(r => r.join(",")).join("\n")], {
//       type: "text/csv",
//     });
//     saveAs(blob, "campaigns.csv");
//   };

//   const getStatusBadge = status => {
//     const color =
//       status === "Draft"
//         ? "bg-yellow-100 text-yellow-800"
//         : status === "Sent"
//         ? "bg-green-100 text-green-800"
//         : "bg-gray-200 text-gray-800";
//     return (
//       <span className={`px-2 py-1 rounded text-xs font-semibold ${color}`}>
//         {status}
//       </span>
//     );
//   };

//   return (
//     <div className="p-6 max-w-7xl mx-auto space-y-6">
//       <div className="bg-white rounded-md shadow border">
//         {/* Header */}
//         <div className="flex justify-between items-center px-5 py-4 border-b">
//           <h2 className="text-lg font-semibold text-gray-700">
//             üìã Campaigns List
//           </h2>
//           <div className="flex gap-2">
//             <button
//               onClick={() => navigate("/app/campaigns/template-single")}
//               className="px-3 py-1.5 text-sm border rounded-md text-gray-700 hover:bg-gray-100"
//             >
//               ‚ûï New Campaign
//             </button>
//             <button
//               onClick={handleExport}
//               className="px-3 py-1.5 text-sm border rounded-md text-gray-700 hover:bg-gray-100"
//             >
//               ‚¨á Export CSV
//             </button>
//           </div>
//         </div>

//         {/* Filters */}
//         <div className="px-5 py-4 grid grid-cols-1 md:grid-cols-3 gap-4 border-b bg-gray-50">
//           <input
//             type="text"
//             placeholder="Search by name..."
//             className="border rounded px-3 py-2 text-sm"
//             value={search}
//             onChange={e => setSearch(e.target.value)}
//           />
//           <select
//             className="border rounded px-3 py-2 text-sm"
//             value={statusFilter}
//             onChange={e => setStatusFilter(e.target.value)}
//           >
//             <option value="">All Statuses</option>
//             <option value="Draft">Draft</option>
//             <option value="Sent">Sent</option>
//           </select>
//           <select
//             className="border rounded px-3 py-2 text-sm"
//             value={pageSize}
//             onChange={e => {
//               setPageSize(Number(e.target.value));
//               setPage(1);
//             }}
//           >
//             {[10, 25, 50].map(size => (
//               <option key={size} value={size}>
//                 Show {size}
//               </option>
//             ))}
//           </select>
//         </div>

//         {/* Table */}
//         <div className="overflow-x-auto rounded-md">
//           {loading ? (
//             <div className="p-5 text-gray-500 text-sm">
//               ‚è≥ Loading campaigns...
//             </div>
//           ) : filteredCampaigns.length === 0 ? (
//             <div className="p-6 text-center text-gray-500">
//               <p className="text-md">üòï No campaigns found</p>
//               <p className="text-sm">Try adjusting filters or create one.</p>
//             </div>
//           ) : (
//             <table className="w-full text-sm">
//               <thead className="bg-gray-100 text-gray-600 font-semibold">
//                 <tr>
//                   <th className="p-3 text-left">Name</th>
//                   <th className="p-3 text-left">Status</th>
//                   <th className="p-3 text-left">Scheduled</th>
//                   <th className="p-3 text-left">Created</th>
//                   <th className="p-3 text-left">Actions</th>
//                 </tr>
//               </thead>
//               <tbody>
//                 {filteredCampaigns.map(c => (
//                   <tr key={c.id} className="border-t hover:bg-gray-50">
//                     <td className="p-3">{c.name}</td>
//                     <td className="p-3">{getStatusBadge(c.status)}</td>
//                     <td className="p-3">
//                       {c.scheduledAt
//                         ? new Date(c.scheduledAt).toLocaleString()
//                         : "-"}
//                     </td>
//                     <td className="p-3">
//                       {new Date(c.createdAt).toLocaleString()}
//                     </td>
//                     <td className="p-3 space-x-1">
//                       <button
//                         onClick={() => navigate(`/app/campaigns/edit/${c.id}`)}
//                         className="bg-blue-500 text-white px-2 py-1 text-xs rounded hover:bg-blue-600"
//                       >
//                         ‚úèÔ∏è Edit
//                       </button>
//                       <button
//                         onClick={() => navigate(`/app/campaigns/logs/${c.id}`)}
//                         className="bg-purple-600 text-white px-2 py-1 text-xs rounded hover:bg-purple-700"
//                       >
//                         üìä Logs
//                       </button>
//                       <button
//                         onClick={
//                           () => navigate(`/app/campaigns/dashboard/${c.id}`)
//                           //  navigate(`/app/campaigns/analytics/${c.id}/summary`)
//                           //campaigns/analytics/${id}/summary
//                           // /campaigns/analytics/${id}/summary
//                         }
//                         className="bg-indigo-600 text-white px-2 py-1 text-xs rounded hover:bg-indigo-700"
//                       >
//                         üìà Stats
//                       </button>
//                       {c.status?.toLowerCase() === "draft" && (
//                         <button
//                           onClick={() => handleSendCampaign(c.id)}
//                           className="bg-green-600 text-white px-2 py-1 text-xs rounded hover:bg-green-700"
//                         >
//                           üöÄ Send
//                         </button>
//                       )}
//                       <button
//                         onClick={() => handleDelete(c.id)}
//                         className="bg-red-500 text-white px-2 py-1 text-xs rounded hover:bg-red-600"
//                       >
//                         üóëÔ∏è Delete
//                       </button>
//                     </td>
//                   </tr>
//                 ))}
//               </tbody>
//             </table>
//           )}
//         </div>
//       </div>
//     </div>
//   );
// }

// export default CampaignList;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\CampaignRecipientsPage.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import { useParams } from "react-router-dom";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";

function CampaignRecipientsPage() {
  const { id } = useParams(); // campaignId
  const [recipients, setRecipients] = useState([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState("All");

  useEffect(() => {
    const loadRecipients = async () => {
      try {
        const res = await axiosClient.get(`/campaigns/${id}/recipients`);
        setRecipients(res.data || []);
      } catch (err) {
        toast.error("Failed to load recipients");
      } finally {
        setLoading(false);
      }
    };
    loadRecipients();
  }, [id]);

  const filteredRecipients = recipients.filter(r =>
    filter === "All" ? true : r.status === filter
  );

  return (
    <div className="max-w-4xl mx-auto p-6 bg-white shadow-xl rounded-2xl">
      <h2 className="text-2xl font-bold text-purple-600 mb-4">
        üìã Assigned Contacts
      </h2>

      {/* üîç Filter Dropdown */}
      <div className="mb-4">
        <label className="block text-sm font-medium text-gray-700 mb-1">
          Filter by Status
        </label>
        <select
          value={filter}
          onChange={e => setFilter(e.target.value)}
          className="border border-gray-300 rounded px-3 py-2 text-sm w-60"
        >
          <option value="All">All</option>
          <option value="Pending">Pending</option>
          <option value="Sent">Sent</option>
          <option value="Delivered">Delivered</option>
          <option value="Failed">Failed</option>
          <option value="Replied">Replied</option>
        </select>
      </div>

      {loading ? (
        <p className="text-gray-500">Loading...</p>
      ) : filteredRecipients.length === 0 ? (
        <p className="text-yellow-600">No contacts match this filter.</p>
      ) : (
        <table className="w-full text-sm border border-gray-300 rounded-xl overflow-hidden">
          <thead className="bg-purple-100 text-gray-700">
            <tr>
              <th className="p-3 text-left">Contact</th>
              <th className="p-3 text-left">Phone</th>
              <th className="p-3 text-left">Status</th>
              <th className="p-3 text-left">Sent At</th>
            </tr>
          </thead>
          <tbody>
            {filteredRecipients.map(r => (
              <tr key={r.id} className="border-t">
                <td className="p-3">{r.contactName}</td>
                <td className="p-3 text-gray-600">{r.contactPhone}</td>
                <td className="p-3 flex items-center gap-1">
                  {r.status === "Pending" && <span>‚úâÔ∏è</span>}
                  {r.status === "Sent" && <span>‚úÖ</span>}
                  {r.status === "Delivered" && <span>üì¨</span>}
                  {r.status === "Failed" && <span>‚ùå</span>}
                  {r.status === "Replied" && <span>üí¨</span>}
                  <span>{r.status}</span>
                </td>
                <td className="p-3 text-gray-500">
                  {r.sentAt ? new Date(r.sentAt).toLocaleString() : "‚Äî"}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      )}
    </div>
  );
}

export default CampaignRecipientsPage;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\CampaignSendLogs.jsx 
====================================================== 
 
// üìÑ src/pages/campaigns/CampaignSendLogs.jsx
import React, { useEffect, useState, useCallback } from "react";
import { useParams, Link } from "react-router-dom";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";
import { saveAs } from "file-saver";
import { confirmAlert } from "react-confirm-alert";
import "react-confirm-alert/src/react-confirm-alert.css";
import MessagePreviewModal from "./components/MessagePreviewModal";
import CampaignSummaryBar from "./components/CampaignSummaryBar";
import ContactJourneyModal from "./components/ContactJourneyModal";

function CampaignSendLogs() {
  const { campaignId } = useParams();

  // data
  const [logs, setLogs] = useState([]);
  const [summary, setSummary] = useState(null);
  const [loading, setLoading] = useState(true);

  // filters/paging
  const [search, setSearch] = useState("");
  const [statusFilter, setStatusFilter] = useState("");
  const [page, setPage] = useState(1);
  const [pageSize] = useState(10);
  const [totalPages, setTotalPages] = useState(0);
  const [totalLogs, setTotalLogs] = useState(0);

  // modals
  const [previewOpen, setPreviewOpen] = useState(false);
  const [selectedLog, setSelectedLog] = useState(null);
  const [isJourneyOpen, setIsJourneyOpen] = useState(false);
  const [journeyLog, setJourneyLog] = useState(null);

  // --- helpers ---
  // Prefer contactPhone when it's a real value; otherwise fall back to recipientNumber / to.
  const getDisplayPhone = log => {
    const clean = v => (typeof v === "string" ? v.trim() : v);
    const p = clean(log?.contactPhone);
    if (p && p !== "-" && p.toLowerCase() !== "n/a") return p;
    const r = clean(log?.recipientNumber) || clean(log?.to);
    return r || ""; // empty if truly unavailable
  };

  // --- fetching ---
  const fetchLogs = useCallback(async () => {
    setLoading(true);
    try {
      const params = new URLSearchParams({
        page,
        pageSize,
        status: statusFilter,
        search,
      });
      const res = await axiosClient.get(
        `/campaign-logs/campaign/${campaignId}?${params.toString()}`
      );
      setLogs(res.data.items || []);
      setTotalLogs(res.data.totalCount || 0);
      setTotalPages(res.data.totalPages || 0);
    } catch {
      toast.error("‚ùå Failed to load send logs");
    } finally {
      setLoading(false);
    }
  }, [campaignId, page, pageSize, statusFilter, search]);

  const fetchSummary = useCallback(async () => {
    try {
      const res = await axiosClient.get(
        `/campaign-logs/campaign/${campaignId}/summary`
      );
      setSummary(res.data.data || res.data);
    } catch {
      console.error("‚ùå Failed to fetch summary");
    }
  }, [campaignId]);

  useEffect(() => {
    const t = setTimeout(fetchLogs, 500);
    return () => clearTimeout(t);
  }, [fetchLogs]);

  useEffect(() => {
    fetchSummary();
  }, [fetchSummary]);

  // --- handlers ---
  const handleStatusChange = e => {
    setStatusFilter(e.target.value);
    setPage(1);
  };
  const handleSearchChange = e => {
    setSearch(e.target.value);
    setPage(1);
  };

  const handleExport = () => {
    const headers = [
      "Contact Phone",
      "Status",
      "Channel",
      "Sent At",
      "Delivered",
      "Read",
      "Clicked",
      "Click Type",
    ];
    const csvRows = [
      headers,
      ...logs.map(log => [
        getDisplayPhone(log), // ‚úÖ phone only
        log.sendStatus,
        log.sourceChannel,
        log.sentAt ? new Date(log.sentAt).toLocaleString() : "",
        log.deliveredAt ? new Date(log.deliveredAt).toLocaleString() : "",
        log.readAt ? new Date(log.readAt).toLocaleString() : "",
        log.isClicked ? "Yes" : "No",
        log.clickType || "",
      ]),
    ];
    const blob = new Blob([csvRows.map(r => r.join(",")).join("\n")], {
      type: "text/csv",
    });
    saveAs(blob, `CampaignLogs-${campaignId}.csv`);
  };

  const handleRetrySingle = logId => {
    confirmAlert({
      title: "Retry This Message?",
      message: "Are you sure you want to retry this failed message?",
      buttons: [
        {
          label: "Yes",
          onClick: async () => {
            try {
              await axiosClient.post(`/campaign-logs/${logId}/retry`);
              toast.success("‚úÖ Retry triggered");
              fetchLogs();
              fetchSummary();
            } catch {
              toast.error("‚ùå Retry failed");
            }
          },
        },
        { label: "Cancel" },
      ],
    });
  };

  const handleRetryAll = () => {
    confirmAlert({
      title: "Retry All Failed Messages?",
      message:
        "This will retry all failed messages in this campaign. Continue?",
      buttons: [
        {
          label: "Yes",
          onClick: async () => {
            try {
              const res = await axiosClient.post(
                `/campaign-logs/campaign/${campaignId}/retry-all`
              );
              toast.success(`‚úÖ Retried ${res.data.retried} messages`);
              fetchLogs();
              fetchSummary();
            } catch {
              toast.error("‚ùå Retry failed");
            }
          },
        },
        { label: "Cancel" },
      ],
    });
  };

  const openPreview = log => {
    setSelectedLog(log);
    setPreviewOpen(true);
  };
  const closePreview = () => {
    setPreviewOpen(false);
    setSelectedLog(null);
  };

  // --- render ---
  return (
    <div className="p-6 bg-gray-50 min-h-screen">
      <div className="flex justify-between items-center mb-4">
        <h1 className="text-2xl font-bold text-purple-700">
          üì® Send Logs for Campaign
        </h1>
        <Link
          to="/app/campaigns/template-campaigns-list"
          className="inline-flex items-center gap-2 rounded-lg border px-3 py-1.5 text-sm text-gray-700 hover:bg-gray-50 transition"
        >
          <span className="text-lg">‚Üê</span> Back to Campaigns
        </Link>
      </div>

      <CampaignSummaryBar summary={summary} />

      <div className="grid md:grid-cols-4 gap-4 mb-4">
        <input
          className="border px-3 py-2 rounded"
          placeholder="üîç Search by name or phone"
          onChange={handleSearchChange}
        />
        <select
          className="border px-3 py-2 rounded"
          value={statusFilter}
          onChange={handleStatusChange}
        >
          <option value="">All Statuses</option>
          <option value="Sent">Sent</option>
          <option value="Delivered">Delivered</option>
          <option value="Read">Read</option>
          <option value="Queued">Queued</option>
          <option value="Failed">Failed</option>
        </select>
      </div>

      <div className="mb-4 flex justify-between">
        <p className="text-sm text-gray-500">
          Showing {logs.length} of {totalLogs} logs
        </p>
        <div className="space-x-2">
          <button
            onClick={handleExport}
            className="bg-emerald-600 text-white text-sm px-3 py-1 rounded hover:bg-emerald-700"
          >
            ‚¨á Export CSV
          </button>
          <button
            onClick={handleRetryAll}
            className="bg-purple-600 text-white text-sm px-3 py-1 rounded hover:bg-purple-700"
          >
            üîÅ Retry All Failed
          </button>
        </div>
      </div>

      {loading ? (
        <p>Loading logs...</p>
      ) : logs.length === 0 ? (
        <p className="text-gray-500">No logs found with current filters.</p>
      ) : (
        <div className="overflow-x-auto bg-white shadow rounded">
          <table className="w-full text-sm">
            <thead className="bg-gray-100 text-left">
              <tr>
                <th className="p-2">Contact</th>
                <th className="p-2">Status</th>
                <th className="p-2">Channel</th>
                <th className="p-2">Sent</th>
                <th className="p-2">Clicked</th>
                <th className="p-2">Click Type</th>
                <th className="p-2">Actions</th>
              </tr>
            </thead>
            <tbody>
              {logs.map(log => (
                <tr key={log.id} className="border-t hover:bg-gray-50">
                  <td className="p-2">
                    {/* ‚úÖ phone only ‚Äì no N/A, no parentheses */}
                    {getDisplayPhone(log) || "-"}
                  </td>
                  <td className="p-2">{log.sendStatus || "-"}</td>
                  <td className="p-2">{log.sourceChannel || "-"}</td>
                  <td className="p-2">
                    {log.sentAt ? new Date(log.sentAt).toLocaleString() : "-"}
                  </td>
                  <td className="p-2">{log.isClicked ? "‚úÖ Yes" : "‚ùå No"}</td>
                  <td className="p-2">{log.clickType || "-"}</td>
                  <td className="p-2 space-x-2">
                    <button
                      onClick={() => openPreview(log)}
                      className="text-xs text-blue-600 hover:underline"
                    >
                      Preview
                    </button>
                    <button
                      onClick={() => {
                        setJourneyLog(log);
                        setIsJourneyOpen(true);
                      }}
                      className="text-xs text-indigo-600 hover:underline"
                    >
                      üß≠ Journey
                    </button>
                    {log.sendStatus === "Failed" && (
                      <button
                        onClick={() => handleRetrySingle(log.id)}
                        className="text-xs text-white bg-red-500 hover:bg-red-600 px-2 py-1 rounded"
                      >
                        Retry
                      </button>
                    )}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {totalPages > 1 && (
        <div className="flex justify-end items-center mt-4 space-x-2">
          <button
            className="px-2 py-1 text-sm border rounded"
            disabled={page === 1}
            onClick={() => setPage(p => p - 1)}
          >
            ‚¨Ö Prev
          </button>
          <span className="text-sm text-gray-600">
            Page {page} of {totalPages}
          </span>
          <button
            className="px-2 py-1 text-sm border rounded"
            disabled={page === totalPages}
            onClick={() => setPage(p => p + 1)}
          >
            Next ‚û°
          </button>
        </div>
      )}

      <MessagePreviewModal
        isOpen={previewOpen}
        onClose={closePreview}
        messageLog={selectedLog}
      />
      <ContactJourneyModal
        isOpen={isJourneyOpen}
        onClose={() => setIsJourneyOpen(false)}
        log={journeyLog}
      />
    </div>
  );
}

export default CampaignSendLogs;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\CampaignWizard.jsx 
====================================================== 
 
// ‚úÖ CampaignWizard.jsx
import React, { useState } from "react";
import CampaignInfoTab from "./tabs/CampaignInfoTab";
import MessageTypeTab from "./tabs/MessageTypeTab";
import MessageBuilderTab from "./tabs/MessageBuilderTab";
import CTAButtonsTab from "./tabs/CTAButtonsTab";
import RecipientsTab from "./tabs/RecipientsTab";
import PreviewSendTab from "./tabs/PreviewSendTab";

const tabs = [
  { key: "campaign-info", label: "Campaign Info" },
  { key: "message-type", label: "Message Type" },
  { key: "message-builder", label: "Message Builder" },
  { key: "cta-buttons", label: "CTA Buttons" },
  { key: "targeting", label: "Recipients" },
  { key: "preview-send", label: "Preview & Send" },
];

function CampaignWizard() {
  const [activeTabIndex, setActiveTabIndex] = useState(0);
  const [formData, setFormData] = useState({
    name: "",
    description: "",
    messageType: "template",
    templateId: "",
    imageUrl: "",
    messageText: "",
    templateParams: [],
    multiButtons: [],
    recipientIds: [],
  });

  const activeTabKey = tabs[activeTabIndex].key;

  const renderTabContent = () => {
    switch (activeTabKey) {
      case "campaign-info":
        return (
          <CampaignInfoTab formData={formData} setFormData={setFormData} />
        );
      case "message-type":
        return <MessageTypeTab formData={formData} setFormData={setFormData} />;
      case "message-builder":
        return (
          <MessageBuilderTab formData={formData} setFormData={setFormData} />
        );
      case "cta-buttons":
        return <CTAButtonsTab formData={formData} setFormData={setFormData} />;
      case "targeting":
        return <RecipientsTab formData={formData} setFormData={setFormData} />;
      case "preview-send":
        return <PreviewSendTab formData={formData} setFormData={setFormData} />;
      default:
        return null;
    }
  };

  const goNext = () => {
    if (activeTabIndex < tabs.length - 1) setActiveTabIndex(activeTabIndex + 1);
  };

  const goBack = () => {
    if (activeTabIndex > 0) setActiveTabIndex(activeTabIndex - 1);
  };

  return (
    <div className="flex min-h-screen">
      {/* Left vertical tab menu */}
      <div className="w-64 border-r p-4 bg-gray-50">
        <h2 className="text-xl font-bold mb-4">Create Campaign</h2>
        <ul className="space-y-2">
          {tabs.map((tab, index) => (
            <li
              key={tab.key}
              className={`cursor-pointer px-3 py-2 rounded ${
                index === activeTabIndex
                  ? "bg-purple-600 text-white"
                  : "hover:bg-purple-100 text-gray-800"
              }`}
              onClick={() => setActiveTabIndex(index)}
            >
              {tab.label}
            </li>
          ))}
        </ul>
      </div>

      {/* Right content area */}
      <div className="flex-1 p-6">
        {renderTabContent()}
        <div className="mt-6 flex justify-between">
          <button
            onClick={goBack}
            disabled={activeTabIndex === 0}
            className="px-4 py-2 bg-gray-300 text-black rounded disabled:opacity-50"
          >
            Back
          </button>
          <button
            onClick={goNext}
            disabled={activeTabIndex === tabs.length - 1}
            className="px-4 py-2 bg-purple-600 text-white rounded"
          >
            Next
          </button>
        </div>
      </div>
    </div>
  );
}

export default CampaignWizard;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\ImageCampaignDetailPage.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import { useParams, useNavigate } from "react-router-dom"; // ‚úÖ NEW
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";

function ImageCampaignDetailPage() {
  const { id } = useParams();
  const navigate = useNavigate();
  const [campaign, setCampaign] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchCampaign = async () => {
      try {
        const res = await axiosClient.get(`/campaign/${id}`);
        setCampaign(res.data);
      } catch (err) {
        toast.error("Failed to load campaign details");
      } finally {
        setLoading(false);
      }
    };
    fetchCampaign();
  }, [id]);

  if (loading) return <p className="text-center text-gray-500">Loading...</p>;
  if (!campaign)
    return <p className="text-center text-red-500">Campaign not found</p>;

  return (
    <div className="max-w-3xl mx-auto p-6 bg-white shadow-xl rounded-xl space-y-6">
      <h2 className="text-2xl font-bold text-purple-600">
        üìÑ Image Campaign Details
      </h2>

      <div>
        <label className="block text-gray-600 font-semibold">
          Campaign Name
        </label>
        <p className="mt-1 text-gray-800">{campaign.name}</p>
      </div>

      <div>
        <label className="block text-gray-600 font-semibold">
          Message Template
        </label>
        <p className="mt-1 text-gray-800 whitespace-pre-wrap">
          {campaign.messageTemplate}
        </p>
      </div>

      {campaign.imageUrl && (
        <div>
          <label className="block text-gray-600 font-semibold">Image</label>
          <img
            src={campaign.imageUrl}
            alt="Campaign"
            className="mt-2 w-full h-64 object-cover border rounded"
          />
        </div>
      )}

      {campaign.imageCaption && (
        <div>
          <label className="block text-gray-600 font-semibold">
            Image Caption
          </label>
          <p className="mt-1 text-gray-800">{campaign.imageCaption}</p>
        </div>
      )}

      {campaign.cta && (
        <div>
          <label className="block text-gray-600 font-semibold">CTA</label>
          <p className="mt-1 text-gray-800">
            {campaign.cta.title} ‚Äî{" "}
            <span className="text-purple-600 font-semibold">
              {campaign.cta.buttonText}
            </span>
          </p>
        </div>
      )}

      {/* ‚úÖ Assign Contacts Button */}
      <div className="pt-4">
        <button
          onClick={() =>
            navigate(`/app/campaign/image-campaigns/${id}/assign-contacts`)
          }
          className="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl font-medium shadow"
        >
          ‚ûï Assign Contacts
        </button>
      </div>
    </div>
  );
}

export default ImageCampaignDetailPage;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\ImageCampaignEditPage.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import { useParams, useNavigate } from "react-router-dom";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";

function ImageCampaignEditPage() {
  const { id } = useParams();
  const navigate = useNavigate();
  const [campaign, setCampaign] = useState({
    name: "",
    messageTemplate: "",
    imageUrl: "",
    imageCaption: "",
    ctaId: "",
  });
  const [ctaOptions, setCtaOptions] = useState([]);
  const [submitting, setSubmitting] = useState(false);

  // Load campaign + CTA options
  useEffect(() => {
    const fetchData = async () => {
      try {
        const [campaignRes, ctaRes] = await Promise.all([
          axiosClient.get(`/campaigns/${id}`),
          axiosClient.get("/ctas"),
        ]);
        const c = campaignRes.data;
        setCampaign({
          name: c.name,
          messageTemplate: c.messageTemplate,
          imageUrl: c.imageUrl,
          imageCaption: c.imageCaption,
          ctaId: c.ctaId || "",
        });
        setCtaOptions(ctaRes.data);
      } catch (err) {
        toast.error("Failed to load data");
      }
    };
    fetchData();
  }, [id]);

  const handleChange = e => {
    const { name, value } = e.target;
    setCampaign(prev => ({ ...prev, [name]: value }));
  };

  const handleSubmit = async e => {
    e.preventDefault();
    setSubmitting(true);
    try {
      await axiosClient.put(`/campaigns/${id}`, campaign);
      toast.success("Campaign updated");
      navigate("/app/campaigns/image-campaigns");
    } catch {
      toast.error("Failed to update campaign");
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <div className="max-w-2xl mx-auto p-6 bg-white shadow rounded-xl space-y-4">
      <h2 className="text-xl font-bold text-purple-600">
        ‚úèÔ∏è Edit Image Campaign
      </h2>
      <form onSubmit={handleSubmit} className="space-y-4">
        <input
          type="text"
          name="name"
          value={campaign.name}
          onChange={handleChange}
          className="w-full p-2 border rounded"
          placeholder="Campaign Name"
          required
        />
        <textarea
          name="messageTemplate"
          value={campaign.messageTemplate}
          onChange={handleChange}
          rows={3}
          className="w-full p-2 border rounded"
          placeholder="Message Template"
        />
        <input
          type="text"
          name="imageUrl"
          value={campaign.imageUrl}
          onChange={handleChange}
          className="w-full p-2 border rounded"
          placeholder="Image URL"
        />
        {campaign.imageUrl && (
          <img
            src={campaign.imageUrl}
            alt="Preview"
            className="w-full h-56 object-cover border rounded"
          />
        )}
        <input
          type="text"
          name="imageCaption"
          value={campaign.imageCaption}
          onChange={handleChange}
          className="w-full p-2 border rounded"
          placeholder="Image Caption"
        />
        <select
          name="ctaId"
          value={campaign.ctaId}
          onChange={handleChange}
          className="w-full p-2 border rounded"
        >
          <option value="">Select CTA</option>
          {ctaOptions.map(cta => (
            <option key={cta.id} value={cta.id}>
              {cta.title} ‚Äî {cta.buttonText}
            </option>
          ))}
        </select>
        <button
          type="submit"
          disabled={submitting}
          className="bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700"
        >
          {submitting ? "Updating..." : "Update Campaign"}
        </button>
      </form>
    </div>
  );
}

export default ImageCampaignEditPage;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\ImageCampaignListPage_old.jsx 
====================================================== 
 
// ‚úÖ File: src/pages/Campaigns/ImageCampaignListPage.jsx
import React, { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";

function ImageCampaignListPage() {
  const [campaigns, setCampaigns] = useState([]);
  const [loading, setLoading] = useState(true);
  const [sendingId, setSendingId] = useState(null); // ‚úÖ Track sending status
  const navigate = useNavigate();

  // ‚úÖ Load campaigns on mount
  useEffect(() => {
    const fetchCampaigns = async () => {
      try {
        const res = await axiosClient.get(
          "Campaign/get-image-campaign?type=image"
        );
        setCampaigns(res.data || []);
      } catch (err) {
        toast.error("Failed to load campaigns");
      } finally {
        setLoading(false);
      }
    };
    fetchCampaigns();
  }, []);

  const handleEdit = id => navigate(`/app/campaign/image-campaigns/${id}/edit`);

  const handleDelete = async id => {
    if (!window.confirm("Are you sure you want to delete this campaign?"))
      return;
    try {
      await axiosClient.delete(`/campaign/${id}`);
      setCampaigns(prev => prev.filter(c => c.id !== id));
      toast.success("Campaign deleted");
    } catch (err) {
      toast.error("Delete failed");
    }
  };

  // ‚úÖ Use MessageEngine API
  const handleSend = async id => {
    setSendingId(id);
    try {
      await axiosClient.post(`/messageengine/send-image-campaign/${id}`);
      toast.success("üöÄ Campaign sent successfully!");
    } catch (err) {
      console.error("‚ùå Failed to send image campaign:", err);
      toast.error("‚ùå Sending campaign failed");
    } finally {
      setSendingId(null);
    }
  };

  return (
    <div className="max-w-5xl mx-auto px-4 py-6">
      <h2 className="text-2xl font-bold mb-4 text-purple-700">
        üñºÔ∏è Image Campaigns
      </h2>

      {loading ? (
        <p className="text-gray-500">Loading campaigns...</p>
      ) : campaigns.length === 0 ? (
        <div className="bg-yellow-100 text-yellow-700 p-4 rounded-lg shadow-sm">
          No image campaigns found.
        </div>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          {campaigns.map(campaign => (
            <div
              key={campaign.id}
              className="bg-white border rounded-xl shadow hover:shadow-lg transition"
            >
              <img
                src={campaign.imageUrl}
                onError={e => {
                  e.target.onerror = null;
                  e.target.src = "/placeholder.jpg";
                }}
                alt={campaign.name}
                className="w-full h-48 object-contain rounded-t-xl bg-gray-50"
              />

              <div className="p-4 space-y-2">
                <h3 className="text-lg font-semibold">{campaign.name}</h3>
                <p className="text-sm text-gray-600">
                  {campaign.imageCaption || "No caption"}
                </p>
                <p className="text-sm text-gray-500 italic">
                  CTA: {campaign.ctaTitle || "‚Äî"}
                </p>
                <p className="text-sm text-gray-400 whitespace-pre-wrap">
                  üìÑ {campaign.messageTemplate?.slice(0, 200) || "No message"}
                </p>
                <p className="text-sm text-gray-400">
                  üéØ Recipients:{" "}
                  <span
                    className={
                      campaign.recipientCount === 0
                        ? "text-red-600 font-semibold"
                        : ""
                    }
                  >
                    {campaign.recipientCount || 0}
                  </span>
                </p>

                <div className="flex justify-end gap-4 pt-2 flex-wrap">
                  {campaign.recipientCount === 0 && (
                    <button
                      onClick={() =>
                        navigate(
                          `/app/campaigns/image-campaigns/contact-assignto-camapign/${campaign.id}`
                        )
                      }
                      className="text-sm text-purple-600 hover:underline font-semibold"
                    >
                      üéØ Assign Contacts
                    </button>
                  )}

                  <button
                    onClick={() =>
                      navigate(
                        `/app/campaigns/image-campaigns/assigned-contacts/${campaign.id}`
                      )
                    }
                    className="text-sm text-indigo-600 hover:underline"
                  >
                    View Recipients
                  </button>

                  <button
                    onClick={() => handleEdit(campaign.id)}
                    className="text-sm text-blue-600 hover:underline"
                  >
                    Edit
                  </button>

                  <button
                    onClick={() => handleDelete(campaign.id)}
                    className="text-sm text-red-600 hover:underline"
                  >
                    Delete
                  </button>

                  <button
                    disabled={
                      !campaign.recipientCount || sendingId === campaign.id
                    }
                    title={
                      campaign.recipientCount
                        ? "Send this campaign now"
                        : "Assign contacts first"
                    }
                    onClick={() => handleSend(campaign.id)}
                    className={`text-sm font-medium ${
                      campaign.recipientCount
                        ? "text-green-600 hover:underline"
                        : "text-gray-400 cursor-not-allowed"
                    }`}
                  >
                    {sendingId === campaign.id ? "Sending..." : "üöÄ Send"}
                  </button>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

export default ImageCampaignListPage;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\ImageCampaignPage_olds.jsx 
====================================================== 
 
import React, { useState } from "react";
import { useNavigate } from "react-router-dom";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";
import WhatsAppBubblePreview from "./components/WhatsAppBubblePreview";
import CampaignButtonsForm from "./components/CampaignButtonsForm";

function ImageCampaignPage() {
  const navigate = useNavigate();

  const [campaign, setCampaign] = useState({
    name: "",
    messageTemplate: "",
    imageUrl: "",
    imageCaption: "",
    multiButtons: [], // ‚úÖ Only buttons now
  });

  const [submitting, setSubmitting] = useState(false);

  const handleChange = e => {
    const { name, value } = e.target;
    setCampaign(prev => ({ ...prev, [name]: value }));
  };

  const handleButtonsChange = updatedButtons => {
    setCampaign(prev => ({ ...prev, multiButtons: updatedButtons }));
  };

  const handleSubmit = async e => {
    e.preventDefault();
    setSubmitting(true);

    try {
      const res = await axiosClient.post(
        "/campaign/create-image-campaign",
        campaign
      );
      toast.success("‚úÖ Campaign created successfully");

      const newCampaignId = res?.data?.campaignId || res?.data?.id;
      if (newCampaignId) {
        // üîÅ Auto-redirect to Assign Contacts page
        navigate(
          `/app/campaigns/image-campaigns/assign-contacts/${newCampaignId}`
        );
      }

      setCampaign({
        name: "",
        messageTemplate: "",
        imageUrl: "",
        imageCaption: "",
        multiButtons: [],
      });
    } catch (err) {
      toast.error("‚ùå Error creating campaign");
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <div className="max-w-3xl mx-auto p-6 bg-white shadow-xl rounded-2xl">
      <h2 className="text-2xl font-bold mb-6 text-purple-600">
        üì∑ Create Image Campaign
      </h2>

      <form onSubmit={handleSubmit} className="space-y-5">
        <input
          type="text"
          name="name"
          placeholder="Campaign Name"
          value={campaign.name}
          onChange={handleChange}
          className="w-full p-3 border border-gray-300 rounded-xl"
          required
        />

        <textarea
          name="messageTemplate"
          placeholder="Message Template"
          rows={3}
          value={campaign.messageTemplate}
          onChange={handleChange}
          className="w-full p-3 border border-gray-300 rounded-xl"
          required
        />

        <input
          type="text"
          name="imageUrl"
          placeholder="Image URL"
          value={campaign.imageUrl}
          onChange={handleChange}
          className="w-full p-3 border border-gray-300 rounded-xl"
        />

        <input
          type="text"
          name="imageCaption"
          placeholder="Image Caption (optional)"
          value={campaign.imageCaption}
          onChange={handleChange}
          className="w-full p-3 border border-gray-300 rounded-xl"
        />

        {/* üîò Multi-Button Config Only */}
        <CampaignButtonsForm
          buttons={campaign.multiButtons}
          onChange={handleButtonsChange}
        />

        {/* üü¢ Live Preview */}
        {campaign.messageTemplate && (
          <div>
            <label className="text-sm text-gray-600 mb-1 block">Preview:</label>
            <WhatsAppBubblePreview
              messageTemplate={campaign.messageTemplate}
              imageUrl={campaign.imageUrl}
              caption={campaign.imageCaption}
              multiButtons={campaign.multiButtons}
            />
          </div>
        )}

        <button
          type="submit"
          disabled={submitting}
          className="bg-purple-600 text-white py-3 px-6 rounded-xl hover:bg-purple-700 transition"
        >
          {submitting ? "Creating..." : "Create Campaign"}
        </button>
      </form>
    </div>
  );
}

export default ImageCampaignPage;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\TemplateCampaignList.jsx 
====================================================== 
 
// üìÑ src/pages/campaigns/TemplateCampaignList.jsx
import React, { useEffect, useMemo, useState } from "react";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";
import WhatsAppBubblePreview from "../../components/WhatsAppBubblePreview";
import TemplateCard from "./components/templates/TemplateCard";
import normalizeCampaign from "../../utils/normalizeTemplate";
import { useNavigate } from "react-router-dom";
import {
  FaRocket,
  FaSearch,
  FaSyncAlt,
  FaListUl,
  FaTable,
  FaThLarge,
  FaFilter,
  FaEye,
  FaEdit,
  FaTrash,
  FaUsers,
  FaPaperPlane,
  FaChartBar,
  FaList,
} from "react-icons/fa";

function cx(...xs) {
  return xs.filter(Boolean).join(" ");
}

const TYPE_FILTERS = [
  { id: "all", label: "All", icon: FaListUl },
  { id: "image_header", label: "Image Header", icon: FaEye },
  { id: "text_only", label: "Text Only", icon: FaEdit },
  { id: "with_buttons", label: "With Buttons", icon: FaPaperPlane },
  { id: "no_buttons", label: "No Buttons", icon: FaChartBar },
];

/* ---------- Inspector Modal ---------- */
function InspectorModal({ item, onClose }) {
  if (!item) return null;

  // Normalize fields from different shapes (DB list vs. detail vs. legacy)
  const messageTemplate =
    item.body || item.messageBody || item.templateBody || "";

  // Buttons can be `buttons`, `multiButtons`, or a JSON string
  let buttonsRaw = item.buttons ?? item.multiButtons ?? [];
  if (typeof buttonsRaw === "string") {
    try {
      buttonsRaw = JSON.parse(buttonsRaw);
    } catch {
      buttonsRaw = [];
    }
  }

  const imageUrl =
    item.imageUrl || item.mediaUrl || item.headerImageUrl || undefined;

  const caption = item.caption || item.imageCaption || "";

  return (
    <div
      className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 p-4"
      onClick={onClose}
    >
      <div
        className="w-full max-w-2xl overflow-hidden rounded-2xl bg-white shadow-2xl"
        onClick={e => e.stopPropagation()}
      >
        <div className="flex items-center justify-between border-b px-6 py-4 bg-gradient-to-r from-sapphire-50 to-emerald-50">
          <div>
            <div className="text-xl font-bold text-gray-900">{item.name}</div>
            <div className="text-sm text-gray-600">Template Preview</div>
          </div>
          <button
            className="rounded-xl border border-gray-200 px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors"
            onClick={onClose}
          >
            Close
          </button>
        </div>

        <div className="p-6">
          <WhatsAppBubblePreview
            messageTemplate={messageTemplate}
            multiButtons={buttonsRaw}
            imageUrl={imageUrl}
            caption={caption}
            campaignId={item.id}
          />
        </div>

        <div className="flex items-center justify-end gap-3 border-t px-6 py-4 bg-gray-50">
          <button
            className="rounded-xl border border-gray-200 px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors"
            onClick={onClose}
          >
            Close
          </button>
        </div>
      </div>
    </div>
  );
}

/* ---------- Danger Delete Modal ---------- */
function DangerDeleteModal({
  open,
  target, // { id, name }
  usage, // { status, recipients, queuedJobs, sendLogs }
  loading, // loading usage
  deleting, // deleting flag
  onCancel,
  onConfirm,
}) {
  const [confirmed, setConfirmed] = React.useState(false);
  const [typed, setTyped] = React.useState("");

  React.useEffect(() => {
    if (!open) {
      setConfirmed(false);
      setTyped("");
    }
  }, [open]);

  if (!open) return null;

  return (
    <div
      className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/60 p-4"
      onClick={onCancel}
    >
      <div
        className="w-full max-w-lg overflow-hidden rounded-2xl bg-white shadow-2xl"
        onClick={e => e.stopPropagation()}
      >
        <div className="border-b px-6 py-5 bg-red-50">
          <h3 className="text-xl font-bold text-gray-900">
            Delete this campaign permanently?
          </h3>
          <p className="mt-2 text-sm text-gray-600">
            <strong>This action can't be undone.</strong> Deleting will
            permanently remove this campaign and everything linked to it‚Äî its
            audience and recipients, any scheduled or queued sends, and the full
            history for this campaign (messages and activity).
          </p>
        </div>

        <div className="px-6 py-5">
          {/* Usage section */}
          <div className="rounded-xl border border-gray-200 bg-gray-50 px-4 py-4">
            {loading ? (
              <div className="text-sm text-gray-600">
                Loading campaign details‚Ä¶
              </div>
            ) : usage ? (
              <ul className="text-sm text-gray-800 space-y-2">
                <li className="flex justify-between">
                  <span className="text-gray-500">Name:</span>
                  <strong>{target?.name || "Untitled"}</strong>
                </li>
                <li className="flex justify-between">
                  <span className="text-gray-500">Status:</span>
                  <strong>{usage.status}</strong>
                </li>
                <li className="flex justify-between">
                  <span className="text-gray-500">Recipients:</span>
                  <strong>{usage.recipients}</strong>
                </li>
                <li className="flex justify-between">
                  <span className="text-gray-500">Scheduled/queued sends:</span>
                  <strong>{usage.queuedJobs}</strong>
                </li>
                <li className="flex justify-between">
                  <span className="text-gray-500">Messages sent:</span>
                  <strong>{usage.sendLogs}</strong>
                </li>
              </ul>
            ) : (
              <div className="text-sm text-gray-600">No details available.</div>
            )}
          </div>

          {/* Confirmations */}
          <div className="mt-6 space-y-4">
            <label className="flex items-start gap-3 text-sm text-gray-700">
              <input
                type="checkbox"
                className="mt-1 h-4 w-4 rounded border-gray-300 text-red-600 focus:ring-red-400"
                checked={confirmed}
                onChange={e => setConfirmed(e.target.checked)}
              />
              <span>
                I understand this will permanently delete this campaign, its
                audience/recipients, any scheduled sends, and its history.
              </span>
            </label>

            <div>
              <label className="text-sm font-medium text-gray-700">
                Type the campaign name to confirm:
              </label>
              <input
                value={typed}
                onChange={e => setTyped(e.target.value)}
                placeholder={target?.name || "Campaign name"}
                className="mt-2 w-full rounded-xl border border-gray-300 px-4 py-3 text-sm focus:ring-2 focus:ring-red-200 focus:border-red-300 outline-none"
              />
            </div>
          </div>
        </div>

        <div className="flex items-center justify-end gap-3 border-t px-6 py-4 bg-gray-50">
          <button
            className="rounded-xl border border-gray-200 px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors"
            onClick={onCancel}
            disabled={deleting}
          >
            Cancel
          </button>
          <button
            className={cx(
              "rounded-xl px-4 py-2 text-white font-medium transition-colors",
              deleting ? "bg-red-400" : "bg-red-600 hover:bg-red-700"
            )}
            onClick={onConfirm}
            disabled={
              deleting ||
              !confirmed ||
              (typed || "").trim() !== (target?.name || "").trim()
            }
          >
            {deleting ? "Deleting‚Ä¶" : "Permanently delete"}
          </button>
        </div>
      </div>
    </div>
  );
}

/* ---------- Page ---------- */
function TemplateCampaignList() {
  const [raw, setRaw] = useState([]);
  const [loading, setLoading] = useState(true);
  const [sendingId, setSendingId] = useState(null);
  const [deletingId, setDeletingId] = useState(null); // for card/table spinner
  const [q, setQ] = useState("");
  const [onlyWithRecipients, setOnlyWithRecipients] = useState(false);
  const [sort, setSort] = useState("recent"); // recent | recipients | name
  const [activeType, setActiveType] = useState("all");
  const [viewMode, setViewMode] = useState("grid"); // grid | table
  const [inspector, setInspector] = useState(null);

  // Delete modal state
  const [deleteTarget, setDeleteTarget] = useState(null);
  const [usage, setUsage] = useState(null);
  const [usageLoading, setUsageLoading] = useState(false);
  const [deleting, setDeleting] = useState(false);

  const navigate = useNavigate();

  const loadCampaigns = async () => {
    setLoading(true);
    try {
      const res = await axiosClient.get("/campaign/get-image-campaign");
      setRaw(res.data || []);
    } catch (err) {
      console.error(err);
      toast.error("‚ùå Failed to load template campaigns");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadCampaigns();
  }, []);

  const handleSend = async campaignId => {
    setSendingId(campaignId);
    try {
      await axiosClient.post(`/campaign/send-campaign/${campaignId}`);
      toast.success("üöÄ Campaign sent successfully!");
    } catch (err) {
      console.error("‚ùå Sending failed:", err);
      toast.error("‚ùå Failed to send campaign");
    } finally {
      setSendingId(null);
    }
  };

  // Open delete modal: fetch usage
  const openDelete = async item => {
    setDeleteTarget(item);
    setUsage(null);
    setUsageLoading(true);
    try {
      const res = await axiosClient.get(`/campaign/${item.id}/usage`);
      setUsage(res.data);
    } catch (err) {
      console.error("Usage fetch failed", err);
      toast.error("‚ùå Could not load campaign usage");
    } finally {
      setUsageLoading(false);
    }
  };

  // Confirm delete: call DELETE ?force=true
  const confirmDelete = async () => {
    if (!deleteTarget) return;
    setDeleting(true);
    setDeletingId(deleteTarget.id);
    try {
      const res = await axiosClient.delete(`/campaign/${deleteTarget.id}`, {
        params: { force: true },
      });
      toast.success(res?.data?.message || "üóëÔ∏è Campaign deleted permanently.");
      // Close modal + refresh
      setDeleteTarget(null);
      setUsage(null);
      await loadCampaigns();
    } catch (err) {
      console.error("Delete failed", err);
      const msg =
        err?.response?.data?.message || "‚ùå Failed to delete campaign.";
      if (err?.response?.status === 409) {
        toast.error(
          msg || "‚ùå Cannot delete while campaign is sending. Cancel or wait."
        );
      } else if (err?.response?.status === 400) {
        toast.error(
          msg ||
            "‚ùå Delete failed ‚Äî only draft campaigns can be deleted without force."
        );
      } else if (err?.response?.status === 404) {
        toast.error("‚ùå Campaign not found.");
      } else {
        toast.error(msg);
      }
    } finally {
      setDeleting(false);
      setDeletingId(null);
    }
  };

  const cancelDelete = () => {
    setDeleteTarget(null);
    setUsage(null);
    setUsageLoading(false);
    setDeleting(false);
  };

  const data = useMemo(() => raw.map(normalizeCampaign), [raw]);

  const view = useMemo(() => {
    let list = data;

    if (q.trim()) {
      const needle = q.toLowerCase();
      list = list.filter(
        c =>
          c.name.toLowerCase().includes(needle) ||
          c.body.toLowerCase().includes(needle)
      );
    }

    if (onlyWithRecipients) list = list.filter(c => c.recipients > 0);

    if (activeType !== "all") {
      list = list.filter(c => {
        if (activeType === "image_header") return c.kind === "image_header";
        if (activeType === "text_only") return c.kind === "text_only";
        if (activeType === "with_buttons") return c.hasButtons;
        if (activeType === "no_buttons") return !c.hasButtons;
        return true;
      });
    }

    list = [...list].sort((a, b) => {
      if (sort === "name") return a.name.localeCompare(b.name);
      if (sort === "recipients") return b.recipients - a.recipients;
      const ax = new Date(a.updatedAt || 0).getTime();
      const bx = new Date(b.updatedAt || 0).getTime();
      return bx - ax; // recent
    });

    return list;
  }, [data, q, onlyWithRecipients, activeType, sort]);

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 to-emerald-50">
      <div className="mx-auto max-w-7xl px-4 py-8">
        {/* Header */}
        <div className="mb-8">
          <div className="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
            <div className="flex items-center gap-4">
              <div className="flex items-center gap-3">
                <div className="w-12 h-12 bg-gradient-to-r from-sapphire-500 to-emerald-500 rounded-xl flex items-center justify-center">
                  <FaRocket className="text-white text-xl" />
                </div>
                <div>
                  <h1 className="text-3xl font-bold text-gray-900">
                    Template Campaigns
                  </h1>
                  <p className="text-gray-600 mt-1">
                    Manage and send your WhatsApp template campaigns
                  </p>
                </div>
              </div>
              <button
                onClick={loadCampaigns}
                className="inline-flex items-center gap-2 rounded-xl border border-gray-200 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors"
                title="Refresh"
              >
                <FaSyncAlt className={cx(loading && "animate-spin")} />
                Refresh
              </button>
            </div>

            {/* Controls */}
            <div className="flex flex-col gap-4 lg:flex-row lg:items-center">
              <div className="relative">
                <FaSearch className="pointer-events-none absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" />
                <input
                  value={q}
                  onChange={e => setQ(e.target.value)}
                  placeholder="Search by name or message‚Ä¶"
                  className="w-full lg:w-80 rounded-xl border border-gray-200 pl-12 pr-4 py-3 text-sm focus:ring-2 focus:ring-sapphire-300 focus:border-sapphire-300 outline-none"
                />
              </div>

              <div className="flex items-center gap-4">
                <label className="inline-flex items-center gap-2 text-sm font-medium text-gray-700">
                  <input
                    type="checkbox"
                    checked={onlyWithRecipients}
                    onChange={e => setOnlyWithRecipients(e.target.checked)}
                    className="h-4 w-4 rounded border-gray-300 text-sapphire-600 focus:ring-sapphire-400"
                  />
                  Only with recipients
                </label>

                <select
                  value={sort}
                  onChange={e => setSort(e.target.value)}
                  className="rounded-xl border border-gray-200 px-4 py-3 text-sm focus:ring-2 focus:ring-sapphire-300 focus:border-sapphire-300 outline-none"
                >
                  <option value="recent">Sort: Recent</option>
                  <option value="recipients">Sort: Recipients</option>
                  <option value="name">Sort: Name</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        {/* Segmented filters */}
        <div className="mb-8">
          <div className="flex flex-wrap items-center gap-3">
            <span className="text-sm font-semibold text-gray-700 flex items-center gap-2">
              <FaFilter className="text-sapphire-500" />
              Filter by type:
            </span>
            {TYPE_FILTERS.map(f => {
              const Icon = f.icon;
              return (
                <button
                  key={f.id}
                  className={cx(
                    "inline-flex items-center gap-2 rounded-full px-4 py-2 text-sm font-medium transition-colors",
                    activeType === f.id
                      ? "bg-sapphire-600 text-white shadow-lg"
                      : "bg-white text-gray-700 border border-gray-200 hover:bg-gray-50"
                  )}
                  onClick={() => setActiveType(f.id)}
                >
                  <Icon className="w-4 h-4" />
                  {f.label}
                </button>
              );
            })}

            <div className="ml-auto flex items-center gap-2">
              <button
                className={cx(
                  "inline-flex items-center gap-2 rounded-xl border px-4 py-2 text-sm font-medium transition-colors",
                  viewMode === "grid"
                    ? "bg-sapphire-50 border-sapphire-200 text-sapphire-700"
                    : "text-gray-700 border-gray-200 hover:bg-gray-50"
                )}
                onClick={() => setViewMode("grid")}
                title="Grid view"
              >
                <FaThLarge />
                Grid
              </button>
              <button
                className={cx(
                  "inline-flex items-center gap-2 rounded-xl border px-4 py-2 text-sm font-medium transition-colors",
                  viewMode === "table"
                    ? "bg-sapphire-50 border-sapphire-200 text-sapphire-700"
                    : "text-gray-700 border-gray-200 hover:bg-gray-50"
                )}
                onClick={() => setViewMode("table")}
                title="Table view"
              >
                <FaTable />
                Table
              </button>
            </div>
          </div>
        </div>

        {/* Loading skeleton */}
        {loading && (
          <div className="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
            {Array.from({ length: 6 }).map((_, i) => (
              <div
                key={i}
                className="rounded-2xl border border-gray-200 bg-white p-6 shadow-sm animate-pulse"
              >
                <div className="h-40 w-full rounded-xl bg-gray-100" />
                <div className="mt-4 h-6 w-2/3 rounded bg-gray-100" />
                <div className="mt-2 h-4 w-1/3 rounded bg-gray-100" />
                <div className="mt-4 h-20 w-full rounded bg-gray-100" />
                <div className="mt-6 flex gap-2">
                  <div className="h-10 w-24 rounded bg-gray-100" />
                  <div className="h-10 w-24 rounded bg-gray-100" />
                  <div className="h-10 w-24 rounded bg-gray-100" />
                </div>
              </div>
            ))}
          </div>
        )}

        {/* Empty state */}
        {!loading && view.length === 0 && (
          <div className="mt-16 flex flex-col items-center justify-center text-center">
            <div className="rounded-3xl border border-gray-200 p-12 shadow-sm bg-white max-w-lg">
              <div className="mx-auto mb-6 flex h-16 w-16 items-center justify-center rounded-2xl bg-gradient-to-r from-sapphire-100 to-emerald-100">
                <FaListUl className="text-sapphire-600 text-2xl" />
              </div>
              <h3 className="text-2xl font-bold text-gray-900 mb-3">
                No template campaigns yet
              </h3>
              <p className="text-gray-600 mb-8">
                Create an image template campaign and assign recipients to start
                sending.
              </p>
              <div className="flex items-center justify-center gap-3">
                <button
                  onClick={loadCampaigns}
                  className="rounded-xl border border-gray-200 px-6 py-3 font-semibold text-gray-700 hover:bg-gray-50 transition-colors"
                >
                  Refresh
                </button>
              </div>
            </div>
          </div>
        )}

        {/* GRID VIEW */}
        {!loading && view.length > 0 && viewMode === "grid" && (
          <div className="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
            {view.map(t => {
              const sending = sendingId === t.id;
              const deletingThis = deletingId === t.id;
              return (
                <TemplateCard
                  key={t.id}
                  t={t}
                  sending={sending}
                  deleting={deletingThis}
                  onPreview={() => setInspector(t)}
                  onSend={() => handleSend(t.id)}
                  onAssign={() =>
                    navigate(
                      `/app/campaigns/image-campaigns/assign-contacts/${t.id}`
                    )
                  }
                  onViewRecipients={() =>
                    navigate(
                      `/app/campaigns/image-campaigns/assigned-contacts/${t.id}`
                    )
                  }
                  onDelete={() => openDelete(t)}
                />
              );
            })}
          </div>
        )}

        {/* TABLE VIEW (compact) */}
        {!loading && view.length > 0 && viewMode === "table" && (
          <div className="overflow-hidden rounded-2xl border bg-white shadow-sm">
            <div className="max-h-[70vh] overflow-auto">
              <table className="w-full text-[13px]">
                <thead className="sticky top-0 z-10 bg-gray-50 text-left text-gray-700 border-b">
                  <tr>
                    <th className="px-3 py-2 font-semibold">Name</th>
                    <th className="px-3 py-2 font-semibold">Type</th>
                    <th className="px-3 py-2 font-semibold">Buttons</th>
                    <th className="px-3 py-2 font-semibold">Recipients</th>
                    <th className="px-3 py-2 font-semibold">Updated</th>
                    <th className="px-3 py-2 font-semibold text-right">
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {view.map(t => {
                    const deletingThis = deletingId === t.id;
                    return (
                      <tr
                        key={t.id}
                        className="border-t hover:bg-gray-50/70 transition-colors"
                      >
                        <td className="px-3 py-2 font-medium text-gray-900">
                          {t.name}
                        </td>
                        <td className="px-3 py-2">
                          {t.kind === "image_header"
                            ? "Image Header"
                            : "Text Only"}
                        </td>
                        <td className="px-3 py-2">
                          {t.hasButtons ? t.buttons.length : 0}
                        </td>
                        <td className="px-3 py-2">{t.recipients}</td>
                        <td className="px-3 py-2">
                          {t.updatedAt
                            ? new Date(t.updatedAt).toLocaleString()
                            : "‚Äî"}
                        </td>
                        <td className="px-3 py-2">
                          <div className="flex justify-end gap-2">
                            <button
                              className="rounded-md border px-2.5 py-1.5 hover:bg-gray-50"
                              onClick={() => setInspector(t)}
                            >
                              Preview
                            </button>

                            <button
                              className="rounded-md bg-yellow-100 px-2.5 py-1.5 text-yellow-800 hover:bg-yellow-200"
                              onClick={() =>
                                navigate(`/app/campaigns/logs/${t.id}`)
                              }
                            >
                              Log
                            </button>

                            <button
                              className="rounded-md bg-purple-100 px-2.5 py-1.5 text-purple-800 hover:bg-purple-200"
                              onClick={() =>
                                navigate(
                                  `/app/campaigns/image-campaigns/assign-contacts/${t.id}`
                                )
                              }
                            >
                              Assign
                            </button>

                            <button
                              className="rounded-md bg-blue-100 px-2.5 py-1.5 text-blue-700 hover:bg-blue-200"
                              onClick={() =>
                                navigate(
                                  `/app/campaigns/image-campaigns/assigned-contacts/${t.id}`
                                )
                              }
                            >
                              Recipients
                            </button>

                            {/* Delete in table row */}
                            <button
                              className="rounded-md border px-2.5 py-1.5 text-red-700 border-red-300 bg-red-50 hover:bg-red-100 disabled:opacity-50"
                              onClick={() => openDelete(t)}
                              disabled={deletingThis}
                              title="Delete campaign"
                            >
                              {deletingThis ? "Deleting‚Ä¶" : "Delete"}
                            </button>

                            <button
                              className="rounded-md bg-emerald-600 px-2.5 py-1.5 font-semibold text-white hover:bg-emerald-700 disabled:opacity-50"
                              disabled={t.recipients === 0}
                              onClick={() => handleSend(t.id)}
                            >
                              Send
                            </button>
                          </div>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        )}

        <InspectorModal item={inspector} onClose={() => setInspector(null)} />

        <DangerDeleteModal
          open={!!deleteTarget}
          target={deleteTarget}
          usage={usage}
          loading={usageLoading}
          deleting={deleting}
          onCancel={cancelDelete}
          onConfirm={confirmDelete}
        />
      </div>
    </div>
  );
}
export default TemplateCampaignList;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\Analytics\CampaignDashboard_old.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axios from "../../../api/axiosClient";
import { useParams } from "react-router-dom";
import StatCard from "../../../components/StatCard";

function CampaignDashboard() {
  const { campaignId } = useParams();
  const [stats, setStats] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchStats = async () => {
      try {
        const res = await axios.get(
          `/campaigns/analytics/${campaignId}/summary`
        );
        if (res.data.success) setStats(res.data.data);
      } catch (err) {
        console.error("‚ùå Failed to load campaign summary", err);
      } finally {
        setLoading(false);
      }
    };

    fetchStats();
  }, [campaignId]);

  if (loading)
    return <p className="text-gray-500">‚è≥ Loading campaign summary...</p>;
  if (!stats) return <p className="text-red-500">‚ö†Ô∏è No data found.</p>;

  return (
    <div className="p-6">
      <h2 className="text-xl font-semibold mb-4">üìä Campaign Summary</h2>
      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        <StatCard title="Total Messages" value={stats.totalMessages} />
        <StatCard title="Sent" value={stats.sentCount} />
        <StatCard title="Delivered" value={stats.deliveredCount} />
        <StatCard title="Read" value={stats.readCount} />
        <StatCard title="Failed" value={stats.failedCount} />
      </div>
    </div>
  );
}

export default CampaignDashboard;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\api\csvApi.js 
====================================================== 
 
// src/pages/Campaigns/api/csvApi.js
import axiosClient from "../../../api/axiosClient";

/** Helper to unwrap { success, data } or raw payloads */
function un(data) {
  return data?.data ?? data;
}

/** ---------- Schema + Sample ---------- **/

export async function fetchCsvSchema(campaignId) {
  const { data } = await axiosClient.get(
    `/campaigns/${campaignId}/csv-sample/schema`
  );
  const p = un(data) ?? {};

  // Prefer explicit headers; fall back to array payloads; finally to []
  let headers = p.headers ?? p.data?.headers;
  if (!headers && Array.isArray(p?.data)) headers = p.data;
  if (!Array.isArray(headers)) headers = [];

  const placeholderCount =
    Number(p.placeholderCount ?? p.data?.placeholderCount ?? 0) || 0;
  return { headers, placeholderCount };
}

export async function downloadCsvSampleBlob(campaignId) {
  const res = await axiosClient.get(`/campaigns/${campaignId}/csv-sample`, {
    responseType: "blob",
  });
  return res.data; // Blob
}

/** ---------- Upload + Batch Info ---------- **/

/**
 * Uploads a CSV and returns a normalized object:
 * { batchId, headerJson: string[] }
 */
export async function uploadCsvBatch(file, audienceId = null) {
  const form = new FormData();
  form.append("file", file);
  if (audienceId) form.append("audienceId", audienceId);

  const { data } = await axiosClient.post("/csv/batch", form, {
    headers: { "Content-Type": "multipart/form-data" },
  });
  const p = un(data) ?? {};

  // Normalize keys so components can immediately render headers
  const batchId = p.batchId ?? p.BatchId ?? p.id ?? p.Id;
  const headerJson = p.headerJson ?? p.headers ?? p.Headers ?? [];

  return { ...p, batchId, headerJson };
}

/**
 * Returns batch meta in a normalized shape:
 * { batchId, headers, headerJson, rowCount, createdAt, ... }
 */
export async function getBatchInfo(batchId) {
  const { data } = await axiosClient.get(`/csv/batch/${batchId}`);
  const p = un(data) ?? {};
  const headers = p.headers ?? p.headerJson ?? p.Headers ?? [];
  return {
    ...p,
    batchId: p.batchId ?? p.BatchId ?? batchId,
    headers,
    headerJson: headers,
  };
}

/** ---------- Sample (preview rows) ---------- **/

/**
 * Always returns { headers: string[], rows: Array<Record<string,string>> }
 * even if the backend only returns an array of { rowIndex, data | Data }.
 */
export async function getBatchSample(batchId, take = 10) {
  const { data } = await axiosClient.get(`/csv/batch/${batchId}/sample`, {
    params: { take },
  });
  const payload = un(data);

  // Case A: backend already returns { headers, rows }
  if (payload?.headers && payload?.rows) {
    return {
      headers: payload.headers,
      rows: payload.rows,
    };
  }

  // Case B: backend returns only rows as an array
  if (Array.isArray(payload)) {
    const rows = payload.map(x => x.data ?? x.Data ?? x.row ?? x.Row ?? {});
    // Try to infer from the first row; else fall back to batch info; else []
    let headers = rows.length > 0 ? Object.keys(rows[0] ?? {}) : [];
    if (!headers.length) {
      const info = await getBatchInfo(batchId);
      headers =
        Array.isArray(info.headers) && info.headers.length ? info.headers : [];
    }
    return { headers, rows };
  }

  // Case C: unexpected shape ‚Äî fall back to batch info
  const info = await getBatchInfo(batchId);
  return { headers: info.headers ?? [], rows: [] };
}

/** ---------- Validation ---------- **/

/**
 * Validates the batch using the chosen phone header and options.
 * Returns a normalized shape: { problems: string[], ...raw }
 */
export async function validateBatch(batchId, req) {
  // Map UI request -> backend field names (tolerant to either)
  const body = {
    phoneField: req.phoneHeader ?? req.phoneField,
    requiredHeaders: req.requiredHeaders ?? [],
    normalizePhones: !!(req.normalizePhone ?? req.normalizePhones),
    deduplicate: !!(req.checkDuplicates ?? req.deduplicate),
  };

  const { data } = await axiosClient.post(
    `/csv/batch/${batchId}/validate`,
    body
  );
  const p = un(data) ?? {};

  // Normalize a few common shapes
  const problems = p.problems ?? p.errors ?? p.Errors ?? [];

  return { ...p, problems };
}

/** ---------- Optional: mapping helpers (no-ops if backend lacks them) ---------- **/

/**
 * Ask backend for parameter mapping suggestions based on the batch.
 * Gracefully handles 404/501 by returning { items: [] }.
 */
export async function suggestMappings(campaignId, batchId) {
  try {
    const { data } = await axiosClient.get(
      `/campaigns/${campaignId}/mappings/suggest`,
      { params: { batchId } }
    );
    const p = un(data) ?? {};
    return { items: p.items ?? [] };
  } catch {
    return { items: [] };
  }
}

/** Persist current mapping preferences (optional, idempotent). */
export async function saveMappings(campaignId, mappingDto) {
  // many backends use POST /campaigns/{id}/mappings
  const { data } = await axiosClient.post(
    `/campaigns/${campaignId}/mappings`,
    mappingDto
  );
  return un(data) ?? {};
}

/** ---------- Materialize (dry-run / commit) ---------- **/

/**
 * body = {
 *   csvBatchId,
 *   mappings: { "{{1}}": "Name", "button1.url_param": "UrlCol", ... } (column names or "constant:VALUE"),
 *   phoneField: "Phone",
 *   normalizePhones: boolean,
 *   deduplicate: boolean,
 *   persist: boolean,
 *   audienceName?: string
 * }
 */
export async function materialize(campaignId, body) {
  const { data } = await axiosClient.post(
    `/campaigns/${campaignId}/materialize`,
    body
  );
  return un(data) ?? {};
}

// // src/pages/Campaigns/api/csvApi.js
// import axiosClient from "../../../api/axiosClient";

// /** Helper to unwrap { success, data } or raw payloads */
// function un(data) {
//   return data?.data ?? data;
// }

// /** ---------- Schema + Sample ---------- **/

// export async function fetchCsvSchema(campaignId) {
//   const { data } = await axiosClient.get(
//     `/campaigns/${campaignId}/csv-sample/schema`
//   );
//   const p = un(data) ?? {};

//   // Prefer explicit headers; fall back to array payloads; then to ["phone"]
//   let headers = p.headers ?? p.data?.headers;
//   if (!headers && Array.isArray(p?.data)) headers = p.data;
//   if (!Array.isArray(headers) || headers.length === 0) headers = ["phone"];

//   const placeholderCount =
//     Number(p.placeholderCount ?? p.data?.placeholderCount ?? 0) || 0;
//   return { headers, placeholderCount };
// }

// export async function downloadCsvSampleBlob(campaignId) {
//   const res = await axiosClient.get(`/campaigns/${campaignId}/csv-sample`, {
//     responseType: "blob",
//   });
//   return res.data; // Blob
// }

// /** ---------- Upload + Batch Info ---------- **/

// /**
//  * Uploads a CSV and returns a normalized object:
//  * { batchId, headerJson: string[] }
//  */
// export async function uploadCsvBatch(file, audienceId = null) {
//   const form = new FormData();
//   form.append("file", file);
//   if (audienceId) form.append("audienceId", audienceId);

//   const { data } = await axiosClient.post("/csv/batch", form, {
//     headers: { "Content-Type": "multipart/form-data" },
//   });
//   const p = un(data) ?? {};

//   // Normalize keys so components can immediately render headers
//   const batchId = p.batchId ?? p.BatchId ?? p.id ?? p.Id;
//   const headerJson = p.headerJson ?? p.headers ?? p.Headers ?? [];

//   return { ...p, batchId, headerJson };
// }

// /**
//  * Returns batch meta in a normalized shape:
//  * { batchId, headers, headerJson, rowCount, createdAt, ... }
//  */
// export async function getBatchInfo(batchId) {
//   const { data } = await axiosClient.get(`/csv/batch/${batchId}`);
//   const p = un(data) ?? {};
//   const headers = p.headers ?? p.headerJson ?? p.Headers ?? [];
//   return {
//     ...p,
//     batchId: p.batchId ?? p.BatchId ?? batchId,
//     headers,
//     headerJson: headers,
//   };
// }

// /** ---------- Sample (preview rows) ---------- **/

// /**
//  * Always returns { headers: string[], rows: Array<Record<string,string>> }
//  * even if the backend only returns an array of { rowIndex, data | Data }.
//  */
// export async function getBatchSample(batchId, take = 10) {
//   const { data } = await axiosClient.get(`/csv/batch/${batchId}/sample`, {
//     params: { take },
//   });
//   const payload = un(data);

//   // Case A: backend already returns { headers, rows }
//   if (payload?.headers && payload?.rows) {
//     return {
//       headers: payload.headers,
//       rows: payload.rows,
//     };
//   }

//   // Case B: backend returns only rows as an array
//   if (Array.isArray(payload)) {
//     const rows = payload.map(x => x.data ?? x.Data ?? x.row ?? x.Row ?? {});
//     // Try to infer from the first row; else fall back to batch info; else ["phone"]
//     let headers = rows.length > 0 ? Object.keys(rows[0] ?? {}) : [];
//     if (!headers.length) {
//       const info = await getBatchInfo(batchId);
//       headers =
//         Array.isArray(info.headers) && info.headers.length
//           ? info.headers
//           : ["phone"];
//     }
//     return { headers, rows };
//   }

//   // Case C: unexpected shape ‚Äî fall back to batch info
//   const info = await getBatchInfo(batchId);
//   return { headers: info.headers ?? ["phone"], rows: [] };
// }

// /** ---------- Validation ---------- **/

// /**
//  * Validates the batch using the chosen phone header and options.
//  * Returns a normalized shape: { problems: string[], ...raw }
//  */
// export async function validateBatch(batchId, req) {
//   // Map UI request -> backend field names (tolerant to either)
//   const body = {
//     phoneField: req.phoneHeader ?? req.phoneField,
//     requiredHeaders: req.requiredHeaders ?? [],
//     normalizePhones: !!(req.normalizePhone ?? req.normalizePhones),
//     deduplicate: !!(req.checkDuplicates ?? req.deduplicate),
//   };

//   const { data } = await axiosClient.post(
//     `/csv/batch/${batchId}/validate`,
//     body
//   );
//   const p = un(data) ?? {};

//   // Normalize a few common shapes
//   const problems = p.problems ?? p.errors ?? p.Errors ?? [];

//   return { ...p, problems };
// }

// /** ---------- Optional: mapping helpers (no-ops if backend lacks them) ---------- **/

// /**
//  * Ask backend for parameter mapping suggestions based on the batch.
//  * Gracefully handles 404/501 by returning { items: [] }.
//  */
// export async function suggestMappings(campaignId, batchId) {
//   try {
//     const { data } = await axiosClient.get(
//       `/campaigns/${campaignId}/mappings/suggest`,
//       { params: { batchId } }
//     );
//     const p = un(data) ?? {};
//     return { items: p.items ?? [] };
//   } catch {
//     return { items: [] };
//   }
// }

// /** Persist current mapping preferences (optional, idempotent). */
// export async function saveMappings(campaignId, mappingDto) {
//   // many backends use POST /campaigns/{id}/mappings
//   const { data } = await axiosClient.post(
//     `/campaigns/${campaignId}/mappings`,
//     mappingDto
//   );
//   return un(data) ?? {};
// }

// /** ---------- Materialize (dry-run / commit) ---------- **/

// /**
//  * body = {
//  *   // common FE shapes your backend can accept as-is:
//  *   // csvBatchId: string,            // preferred by FE
//  *   // OR batchId: string,            // some backends prefer this
//  *   mappings: Record<string,string>,  // "{{1}}": "colA", "button1.url_param": "colX", ...
//  *   phoneField: string,
//  *   normalizePhones: boolean,
//  *   deduplicate: boolean,
//  *   persist?: boolean,                // true=commit, false=dry-run
//  *   audienceName?: string
//  * }
//  */
// export async function materialize(campaignId, body) {
//   const { data } = await axiosClient.post(
//     `/campaigns/${campaignId}/materialize`,
//     body
//   );
//   return un(data) ?? {};
// }

// // src/pages/Campaigns/api/csvApi.js
// import axiosClient from "../../../api/axiosClient";

// /** Helper to unwrap { success, data } or raw payloads */
// function un(data) {
//   return data?.data ?? data;
// }

// /** ---------- Schema + Sample ---------- **/

// export async function fetchCsvSchema(campaignId) {
//   const { data } = await axiosClient.get(
//     `/campaigns/${campaignId}/csv-sample/schema`
//   );
//   const p = un(data) ?? {};
//   const headers = p.headers ??
//     p.data?.headers ??
//     (Array.isArray(p?.data) ? p.data : []) ?? ["phone"];
//   const placeholderCount = p.placeholderCount ?? p.data?.placeholderCount ?? 0;

//   return { headers, placeholderCount };
// }

// export async function downloadCsvSampleBlob(campaignId) {
//   const res = await axiosClient.get(`/campaigns/${campaignId}/csv-sample`, {
//     responseType: "blob",
//   });
//   return res.data; // Blob
// }

// /** ---------- Upload + Batch Info ---------- **/

// /**
//  * Uploads a CSV and returns a normalized object:
//  * { batchId, headerJson: string[] }
//  */
// export async function uploadCsvBatch(file, audienceId = null) {
//   const form = new FormData();
//   form.append("file", file);
//   if (audienceId) form.append("audienceId", audienceId);

//   const { data } = await axiosClient.post("/csv/batch", form, {
//     headers: { "Content-Type": "multipart/form-data" },
//   });
//   const p = un(data) ?? {};

//   // Normalize keys so components can immediately render headers
//   const batchId = p.batchId ?? p.BatchId ?? p.id ?? p.Id;
//   const headerJson = p.headerJson ?? p.headers ?? p.Headers ?? [];

//   return { ...p, batchId, headerJson };
// }

// /**
//  * Returns batch meta in a normalized shape:
//  * { batchId, headers, headerJson, rowCount, createdAt, ... }
//  */
// export async function getBatchInfo(batchId) {
//   const { data } = await axiosClient.get(`/csv/batch/${batchId}`);
//   const p = un(data) ?? {};
//   const headers = p.headers ?? p.headerJson ?? p.Headers ?? [];
//   return {
//     ...p,
//     batchId: p.batchId ?? p.BatchId ?? batchId,
//     headers,
//     headerJson: headers,
//   };
// }

// /** ---------- Sample (preview rows) ---------- **/

// /**
//  * Always returns { headers: string[], rows: Array<Record<string,string>> }
//  * even if the backend only returns an array of { rowIndex, data | Data }.
//  */
// export async function getBatchSample(batchId, take = 10) {
//   const { data } = await axiosClient.get(`/csv/batch/${batchId}/sample`, {
//     params: { take },
//   });
//   const payload = un(data);

//   // Case A: backend already returns { headers, rows }
//   if (payload?.headers && payload?.rows) {
//     return {
//       headers: payload.headers,
//       rows: payload.rows,
//     };
//   }

//   // Case B: backend returns only rows as an array
//   if (Array.isArray(payload)) {
//     const info = await getBatchInfo(batchId);
//     const headers = info.headers?.length ? info.headers : ["phone"];
//     const rows = payload.map(x => x.data ?? x.Data ?? x.row ?? x.Row ?? {});
//     return { headers, rows };
//   }

//   // Case C: unexpected shape ‚Äî fall back to batch info
//   const info = await getBatchInfo(batchId);
//   return { headers: info.headers ?? ["phone"], rows: [] };
// }

// /** ---------- Validation ---------- **/

// /**
//  * Validates the batch using the chosen phone header and options.
//  * Returns a normalized shape: { problems: string[], ...raw }
//  */
// export async function validateBatch(batchId, req) {
//   // Map UI request -> backend field names (tolerant to either)
//   const body = {
//     phoneField: req.phoneHeader ?? req.phoneField,
//     requiredHeaders: req.requiredHeaders ?? [],
//     normalizePhones: !!(req.normalizePhone ?? req.normalizePhones),
//     deduplicate: !!(req.checkDuplicates ?? req.deduplicate),
//   };

//   const { data } = await axiosClient.post(
//     `/csv/batch/${batchId}/validate`,
//     body
//   );
//   const p = un(data) ?? {};

//   // Normalize a few common shapes
//   const problems = p.problems ?? p.errors ?? p.Errors ?? [];

//   return { ...p, problems };
// }

// /** ---------- Optional: mapping helpers (no-ops if backend lacks them) ---------- **/

// /**
//  * Ask backend for parameter mapping suggestions based on the batch.
//  * Gracefully handles 404/501 by returning { items: [] }.
//  */
// export async function suggestMappings(campaignId, batchId) {
//   try {
//     const { data } = await axiosClient.get(
//       `/campaigns/${campaignId}/mappings/suggest`,
//       { params: { batchId } }
//     );
//     const p = un(data) ?? {};
//     return { items: p.items ?? [] };
//   } catch {
//     return { items: [] };
//   }
// }

// /** Persist current mapping preferences (optional, idempotent). */
// export async function saveMappings(campaignId, mappingDto) {
//   // many backends use POST /campaigns/{id}/mappings
//   const { data } = await axiosClient.post(
//     `/campaigns/${campaignId}/mappings`,
//     mappingDto
//   );
//   return un(data) ?? {};
// }

// /** ---------- Materialize (dry-run / commit) ---------- **/

// /**
//  * body = {
//  *   mode: "dryRun" | "commit",
//  *   batchId,
//  *   normalizePhone: boolean,
//  *   deduplicate: boolean,
//  *   phoneHeader: string,
//  *   mappings: [...]
//  * }
//  */
// export async function materialize(campaignId, body) {
//   const { data } = await axiosClient.post(
//     `/campaigns/${campaignId}/materialize`,
//     body
//   );
//   return un(data) ?? {};
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\components\CampaignButtonsForm.jsx 
====================================================== 
 
import React from "react";
import { FaTrash } from "react-icons/fa";

const defaultButton = {
  buttonText: "",
  buttonType: "url",
  targetUrl: "",
};

const CampaignButtonsForm = ({ buttons, onChange }) => {
  const handleChange = (index, field, value) => {
    const updated = [...buttons];
    updated[index][field] = value;
    onChange(updated);
  };

  const handleAdd = () => {
    if (buttons.length < 3) {
      onChange([...buttons, { ...defaultButton }]);
    }
  };

  const handleRemove = index => {
    const updated = [...buttons];
    updated.splice(index, 1);
    onChange(updated);
  };

  return (
    <div className="bg-white rounded-lg shadow p-4 mt-4">
      <h3 className="text-md font-semibold mb-2">üìé Add up to 3 CTA Buttons</h3>

      {buttons.map((btn, index) => (
        <div
          key={index}
          className="grid grid-cols-12 gap-2 items-center mb-3 border p-3 rounded"
        >
          <div className="col-span-3">
            <input
              type="text"
              className="w-full border rounded px-2 py-1"
              placeholder="Title"
              value={btn.buttonText}
              onChange={e => handleChange(index, "buttonText", e.target.value)}
            />
          </div>
          <div className="col-span-3">
            <select
              className="w-full border rounded px-2 py-1"
              value={btn.buttonType}
              onChange={e => handleChange(index, "buttonType", e.target.value)}
            >
              <option value="url">üåê URL</option>
              <option value="call">üìû Call</option>
              <option value="quick_reply">üí¨ Reply</option>
            </select>
          </div>
          <div className="col-span-5">
            <input
              type="text"
              className="w-full border rounded px-2 py-1"
              placeholder="Value (link or payload)"
              value={btn.targetUrl}
              onChange={e => handleChange(index, "targetUrl", e.target.value)}
            />
          </div>
          <div className="col-span-1 text-right">
            <button
              type="button"
              onClick={() => handleRemove(index)}
              className="text-red-500 hover:text-red-700"
            >
              <FaTrash />
            </button>
          </div>
        </div>
      ))}

      <button
        type="button"
        onClick={handleAdd}
        disabled={buttons.length >= 3}
        className="bg-green-600 text-white px-4 py-2 rounded mt-2 hover:bg-green-700 disabled:opacity-50"
      >
        ‚ûï Add Button
      </button>
    </div>
  );
};

export default CampaignButtonsForm;

// import React from "react";
// import { FaTrash } from "react-icons/fa";

// const defaultButton = { title: "", type: "url", value: "" };

// const CampaignButtonsForm = ({ buttons, onChange }) => {
//   const handleChange = (index, field, value) => {
//     const updated = [...buttons];
//     updated[index][field] = value;
//     onChange(updated); // ‚úÖ Corrected
//   };

//   const handleAdd = () => {
//     if (buttons.length < 3) {
//       onChange([...buttons, { ...defaultButton }]); // ‚úÖ Corrected
//     }
//   };

//   const handleRemove = index => {
//     const updated = [...buttons];
//     updated.splice(index, 1);
//     onChange(updated); // ‚úÖ Corrected
//   };

//   return (
//     <div className="bg-white rounded-lg shadow p-4 mt-4">
//       <h3 className="text-md font-semibold mb-2">üìé Add up to 3 CTA Buttons</h3>

//       {buttons.map((btn, index) => (
//         <div
//           key={index}
//           className="grid grid-cols-12 gap-2 items-center mb-3 border p-3 rounded"
//         >
//           <div className="col-span-3">
//             <input
//               type="text"
//               className="w-full border rounded px-2 py-1"
//               placeholder="Title"
//               value={btn.title}
//               onChange={e => handleChange(index, "title", e.target.value)}
//             />
//           </div>
//           <div className="col-span-3">
//             <select
//               className="w-full border rounded px-2 py-1"
//               value={btn.type}
//               onChange={e => handleChange(index, "type", e.target.value)}
//             >
//               <option value="url">üåê URL</option>
//               <option value="call">üìû Call</option>
//               <option value="quick_reply">üí¨ Reply</option>
//             </select>
//           </div>
//           <div className="col-span-5">
//             <input
//               type="text"
//               className="w-full border rounded px-2 py-1"
//               placeholder="Value (link or payload)"
//               value={btn.value}
//               onChange={e => handleChange(index, "value", e.target.value)}
//             />
//           </div>
//           <div className="col-span-1 text-right">
//             <button
//               type="button"
//               onClick={() => handleRemove(index)}
//               className="text-red-500 hover:text-red-700"
//             >
//               <FaTrash />
//             </button>
//           </div>
//         </div>
//       ))}

//       <button
//         type="button"
//         onClick={handleAdd}
//         disabled={buttons.length >= 3}
//         className="bg-green-600 text-white px-4 py-2 rounded mt-2 hover:bg-green-700 disabled:opacity-50"
//       >
//         ‚ûï Add Button
//       </button>
//     </div>
//   );
// };

// export default CampaignButtonsForm;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\components\CampaignSummaryBar.jsx 
====================================================== 
 
import React from "react";
import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip } from "recharts";
import {
  Send,
  CheckCircle2,
  Eye,
  XCircle,
  MousePointerClick,
} from "lucide-react";

function CampaignSummaryBar({ summary }) {
  if (!summary) {
    return (
      <div className="bg-white border rounded-lg shadow-sm p-4 mb-4">
        <p className="text-gray-500">Loading summary...</p>
      </div>
    );
  }

  // --- Calculations for Rates ---
  const deliveryRate =
    summary.sent > 0 // Use 'sent' as the base for delivery rate
      ? ((summary.delivered / summary.sent) * 100).toFixed(1)
      : 0;
  const readRate =
    summary.delivered > 0
      ? ((summary.read / summary.delivered) * 100).toFixed(1)
      : 0;

  // --- Data for the Chart ---
  const chartData = [
    { name: "Read", value: summary.read || 0 },
    {
      name: "Delivered (Unread)",
      value: (summary.delivered || 0) - (summary.read || 0),
    },
    // Show 'Sent' but not yet delivered
    {
      name: "Sent (Pending Delivery)",
      value:
        (summary.sent || 0) -
        (summary.delivered || 0) -
        (summary.failedCount || 0),
    },
    { name: "Failed", value: summary.failedCount || 0 },
  ];
  const COLORS = ["#10B981", "#3B82F6", "#F59E0B", "#EF4444"]; // Green, Blue, Amber, Red

  return (
    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      <div className="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-5">
        <KpiCard
          title="Total Recipients"
          value={summary.totalSent || 0} // This is the total number of messages attempted
          icon={<Send size={40} />}
          gradient="from-slate-500 to-slate-600"
        />
        {/* NEW "Sent" CARD */}
        <KpiCard
          title="Sent"
          value={summary.sent || 0}
          subText="Successfully sent to provider"
          icon={<Send size={40} />}
          gradient="from-pink-500 to-purple-600"
          decoration="wave"
        />
        <KpiCard
          title="Delivered"
          value={summary.delivered || 0}
          subText={`${deliveryRate}% Delivery Rate`}
          icon={<CheckCircle2 size={40} />}
          gradient="from-purple-500 to-indigo-600"
          decoration="graph"
        />
        <KpiCard
          title="Read"
          value={summary.read || 0}
          subText={`${readRate}% Read Rate`}
          icon={<Eye size={40} />}
          gradient="from-blue-400 to-cyan-500"
          decoration="bars"
        />
        <KpiCard
          title="Failed"
          value={summary.failedCount || 0}
          subText="Could not be sent"
          icon={<XCircle size={40} />}
          gradient="from-orange-400 to-red-500"
        />
        <KpiCard
          title="Clicked"
          value={summary.clickedCount || 0}
          icon={<MousePointerClick size={40} />}
          gradient="from-green-400 to-teal-500"
        />
      </div>

      {/* Chart Section */}
      <div className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex flex-col justify-center items-center">
        <h3 className="font-semibold text-gray-700 mb-2">
          Message Status Funnel
        </h3>
        <div className="w-full h-48 relative">
          <ResponsiveContainer width="100%" height="100%">
            <PieChart>
              <Pie
                data={chartData.filter(d => d.value > 0)}
                dataKey="value"
                nameKey="name"
                cx="50%"
                cy="50%"
                innerRadius={50}
                outerRadius={70}
                fill="#8884d8"
                paddingAngle={5}
              >
                {chartData
                  .filter(d => d.value > 0)
                  .map((entry, index) => (
                    <Cell
                      key={`cell-${index}`}
                      fill={COLORS[chartData.indexOf(entry)]}
                    />
                  ))}
              </Pie>
              <Tooltip formatter={(value, name) => [value, name]} />
            </PieChart>
          </ResponsiveContainer>
        </div>
      </div>
    </div>
  );
}
// A new, redesigned component for the KPI cards to match your example
const KpiCard = ({
  icon,
  title,
  value,
  subText = null,
  gradient,
  decoration = null,
}) => {
  const decorations = {
    wave: (
      <svg
        className="absolute bottom-0 left-0 w-full h-16 text-white opacity-10"
        fill="currentColor"
        viewBox="0 0 100 100"
        preserveAspectRatio="none"
      >
        <path d="M0,50 C25,100 75,0 100,50 L100,100 L0,100 Z" />
      </svg>
    ),
    graph: (
      <svg
        className="absolute bottom-0 right-0 h-20 text-white opacity-10"
        fill="none"
        viewBox="0 0 100 100"
        preserveAspectRatio="none"
      >
        <path
          d="M0 80 C20 40, 40 90, 60 50, 80 10, 100 60"
          stroke="currentColor"
          strokeWidth="4"
        />
      </svg>
    ),
    bars: (
      <svg
        className="absolute bottom-0 right-4 h-16 text-white opacity-10"
        fill="currentColor"
        viewBox="0 0 50 100"
        preserveAspectRatio="none"
      >
        <rect x="0" y="60" width="8" height="40" />
        <rect x="12" y="40" width="8" height="60" />
        <rect x="24" y="20" width="8" height="80" />
        <rect x="36" y="50" width="8" height="50" />
      </svg>
    ),
  };

  return (
    <div
      className={`relative overflow-hidden rounded-xl shadow-lg p-5 text-white bg-gradient-to-r ${gradient}`}
    >
      {decoration && decorations[decoration]}
      <div className="relative flex items-center gap-5">
        <div className="opacity-80">{icon}</div>
        <div className="flex-grow">
          <p className="text-sm font-medium text-white/80">{title}</p>
          <p className="text-3xl font-bold tracking-tight">{value}</p>
          {subText && <p className="text-xs text-white/70">{subText}</p>}
        </div>
      </div>
    </div>
  );
};

export default CampaignSummaryBar;

// import React from "react";
// import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip } from "recharts";
// import {
//   Send,
//   CheckCircle2,
//   Eye,
//   XCircle,
//   MousePointerClick,
// } from "lucide-react"; // Modern icons

// function CampaignSummaryBar({ summary }) {
//   if (!summary) {
//     return (
//       <div className="bg-white border rounded-lg shadow-sm p-4 mb-4">
//         <p className="text-gray-500">Loading summary...</p>
//       </div>
//     );
//   }

//   // --- Calculations for Rates ---
//   const deliveryRate =
//     summary.totalSent > 0
//       ? ((summary.delivered / summary.totalSent) * 100).toFixed(1)
//       : 0;
//   const readRate =
//     summary.delivered > 0
//       ? ((summary.read / summary.delivered) * 100).toFixed(1)
//       : 0;
//   const clickRate =
//     summary.delivered > 0
//       ? ((summary.clickedCount / summary.delivered) * 100).toFixed(1)
//       : 0;

//   // --- Data for the Chart ---
//   const chartData = [
//     { name: "Read", value: summary.read || 0 },
//     {
//       name: "Delivered (Not Read)",
//       value: (summary.delivered || 0) - (summary.read || 0),
//     },
//     { name: "Failed", value: summary.failedCount || 0 },
//   ];
//   const COLORS = ["#10B981", "#3B82F6", "#EF4444"]; // Emerald, Blue, Red

//   return (
//     <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
//       {/* KPI Cards Section */}
//       <div className="lg:col-span-2 grid grid-cols-2 md:grid-cols-3 gap-4">
//         {/* Total Sent Card */}
//         <KpiCard
//           icon={<Send size={24} className="text-gray-400" />}
//           title="Total Sent"
//           value={summary.totalSent || 0}
//         />

//         {/* Delivered Card */}
//         <KpiCard
//           icon={<CheckCircle2 size={24} className="text-blue-500" />}
//           title="Delivered"
//           value={summary.delivered || 0}
//           subText={`${deliveryRate}% Delivery Rate`}
//         />

//         {/* Read Card */}
//         <KpiCard
//           icon={<Eye size={24} className="text-emerald-500" />}
//           title="Read"
//           value={summary.read || 0}
//           subText={`${readRate}% Read Rate`}
//         />

//         {/* Failed Card */}
//         <KpiCard
//           icon={<XCircle size={24} className="text-red-500" />}
//           title="Failed"
//           value={summary.failedCount || 0}
//         />

//         {/* Clicked Card */}
//         <KpiCard
//           icon={<MousePointerClick size={24} className="text-pink-500" />}
//           title="Clicked"
//           value={summary.clickedCount || 0}
//           subText={`${clickRate}% Click Rate`}
//         />
//       </div>

//       {/* Chart Section */}
//       <div className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex flex-col justify-center items-center">
//         <h3 className="font-semibold text-gray-700 mb-2">Delivery Funnel</h3>
//         <div className="w-full h-48 relative">
//           <ResponsiveContainer width="100%" height="100%">
//             <PieChart>
//               <Pie
//                 data={chartData}
//                 dataKey="value"
//                 nameKey="name"
//                 cx="50%"
//                 cy="50%"
//                 innerRadius={50}
//                 outerRadius={70}
//                 fill="#8884d8"
//                 paddingAngle={5}
//               >
//                 {chartData.map((entry, index) => (
//                   <Cell
//                     key={`cell-${index}`}
//                     fill={COLORS[index % COLORS.length]}
//                   />
//                 ))}
//               </Pie>
//               <Tooltip formatter={(value, name) => [value, name]} />
//             </PieChart>
//           </ResponsiveContainer>
//           <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
//             <span className="text-3xl font-bold text-gray-800">
//               {deliveryRate}%
//             </span>
//             <span className="text-sm text-gray-500">Delivered</span>
//           </div>
//         </div>
//       </div>
//     </div>
//   );
// }

// // A reusable component for the KPI cards to keep the main component clean
// const KpiCard = ({ icon, title, value, subText = null }) => (
//   <div className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
//     <div className="flex items-center gap-4">
//       {icon}
//       <div>
//         <p className="text-gray-500 text-sm font-medium">{title}</p>
//         <p className="text-2xl font-bold text-gray-800">{value}</p>
//         {subText && <p className="text-xs text-gray-400">{subText}</p>}
//       </div>
//     </div>
//   </div>
// );

// export default CampaignSummaryBar;

// import React from "react";
// import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip } from "recharts";
// import {
//   Send,
//   CheckCircle2,
//   Eye,
//   XCircle,
//   MousePointerClick,
// } from "lucide-react";

// function CampaignSummaryBar({ summary }) {
//   if (!summary) {
//     return (
//       <div className="bg-slate-800 border border-slate-700 rounded-xl p-6 mb-6 text-center text-slate-400">
//         Loading Summary...
//       </div>
//     );
//   }

//   // --- Calculations for Rates ---
//   const deliveryRate =
//     summary.totalSent > 0 ? (summary.delivered / summary.totalSent) * 100 : 0;
//   const readRate =
//     summary.delivered > 0 ? (summary.read / summary.delivered) * 100 : 0;
//   const failureRate =
//     summary.totalSent > 0 ? (summary.failedCount / summary.totalSent) * 100 : 0;

//   // --- Data for the Chart ---
//   const chartData = [
//     { name: "Read", value: summary.read || 0 },
//     {
//       name: "Delivered",
//       value: (summary.delivered || 0) - (summary.read || 0),
//     },
//     { name: "Failed", value: summary.failedCount || 0 },
//   ];
//   // Vibrant, neon-like colors for the dark theme
//   const COLORS = ["#22d3ee", "#38bdf8", "#fb7185"]; // Cyan, Sky Blue, Rose

//   return (
//     <div className="bg-slate-900 p-6 rounded-2xl border border-slate-800/80 mb-6">
//       <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 items-center">
//         {/* KPI Cards Section */}
//         <div className="lg:col-span-8 grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-5">
//           <KpiCard
//             title="Total Sent"
//             value={summary.totalSent || 0}
//             icon={<Send />}
//             gradient="from-slate-700 to-slate-800"
//           />
//           <KpiCard
//             title="Delivered"
//             value={summary.delivered || 0}
//             subText={`${deliveryRate.toFixed(1)}% Delivery Rate`}
//             icon={<CheckCircle2 />}
//             gradient="from-blue-500 to-cyan-500"
//           />
//           <KpiCard
//             title="Read"
//             value={summary.read || 0}
//             subText={`${readRate.toFixed(1)}% Read Rate`}
//             icon={<Eye />}
//             gradient="from-emerald-500 to-green-500"
//           />
//           <KpiCard
//             title="Failed"
//             value={summary.failedCount || 0}
//             subText={`${failureRate.toFixed(1)}% Failure Rate`}
//             icon={<XCircle />}
//             gradient="from-rose-500 to-red-600"
//           />
//           <KpiCard
//             title="Clicked"
//             value={summary.clickedCount || 0}
//             icon={<MousePointerClick />}
//             gradient="from-violet-500 to-fuchsia-500"
//           />
//         </div>

//         {/* Central Chart Section */}
//         <div className="lg:col-span-4 flex flex-col items-center justify-center p-4 bg-slate-800/50 backdrop-blur-sm border border-slate-700/80 rounded-xl h-full">
//           <h3 className="font-semibold text-slate-300 text-base mb-2">
//             Delivery Status
//           </h3>
//           <div
//             className="w-full h-48"
//             style={{ filter: `drop-shadow(0 0 12px ${COLORS[1]}40)` }}
//           >
//             <ResponsiveContainer width="100%" height="100%">
//               <PieChart>
//                 <Pie
//                   data={chartData}
//                   dataKey="value"
//                   nameKey="name"
//                   cx="50%"
//                   cy="50%"
//                   innerRadius={60}
//                   outerRadius={75}
//                   fill="#8884d8"
//                   paddingAngle={5}
//                 >
//                   {chartData.map((entry, index) => (
//                     <Cell
//                       key={`cell-${index}`}
//                       fill={COLORS[index % COLORS.length]}
//                       stroke={COLORS[index % COLORS.length]}
//                     />
//                   ))}
//                 </Pie>
//                 <Tooltip
//                   cursor={false}
//                   contentStyle={{
//                     background: "rgba(20, 30, 48, 0.8)",
//                     backdropFilter: "blur(4px)",
//                     border: "1px solid rgba(255,255,255,0.1)",
//                     borderRadius: "0.75rem",
//                     color: "#fff",
//                   }}
//                 />
//               </PieChart>
//             </ResponsiveContainer>
//           </div>
//         </div>
//       </div>
//     </div>
//   );
// }

// // A new, redesigned component for the gradient KPI cards
// const KpiCard = ({ title, value, subText, icon, gradient }) => (
//   <div
//     className={`bg-gradient-to-br ${gradient} p-5 rounded-xl shadow-lg text-white relative overflow-hidden`}
//   >
//     <div className="flex justify-between items-start">
//       <div className="flex flex-col">
//         <p className="text-sm font-medium text-white/80">{title}</p>
//         <span className="text-4xl font-bold tracking-tight mt-1">{value}</span>
//       </div>
//       <div className="opacity-70">{React.cloneElement(icon, { size: 24 })}</div>
//     </div>
//     {subText && <p className="text-xs text-white/70 mt-2">{subText}</p>}
//   </div>
// );

// export default CampaignSummaryBar;

// import React from "react";
// import {
//   PieChart,
//   Pie,
//   Cell,
//   ResponsiveContainer,
//   Legend,
//   Tooltip,
// } from "recharts";

// function CampaignSummaryBar({ summary }) {
//   if (!summary) {
//     return (
//       <div className="bg-white border rounded-md shadow p-4 mb-4">
//         <p className="text-gray-500">Loading summary...</p>
//       </div>
//     );
//   }

//   const chartData = [
//     { name: "Read", value: summary.read || 0 },
//     {
//       name: "Delivered (Not Read)",
//       value: (summary.delivered || 0) - (summary.read || 0),
//     },
//     { name: "Failed", value: summary.failedCount || 0 },
//   ];
//   const COLORS = ["#00C49F", "#0088FE", "#FF8042"];

//   const formatDate = datetime =>
//     datetime ? new Date(datetime).toLocaleString() : "-";

//   return (
//     <div className="bg-white border rounded-md shadow p-4 mb-4">
//       <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
//         {/* KPI Section */}
//         <div className="lg:col-span-5 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 text-sm text-gray-800">
//           <div>
//             <p className="font-semibold text-purple-700">üì¨ Total Sent</p>
//             <p className="text-2xl font-bold">{summary.totalSent || 0}</p>
//           </div>
//           <div>
//             <p className="font-semibold text-blue-600">üöö Delivered</p>
//             <p className="text-2xl font-bold">{summary.delivered || 0}</p>
//           </div>
//           <div>
//             <p className="font-semibold text-teal-600">üëÄ Read</p>
//             <p className="text-2xl font-bold">{summary.read || 0}</p>
//           </div>
//           <div>
//             <p className="font-semibold text-red-600">‚ùå Failed</p>
//             <p className="text-2xl font-bold">{summary.failedCount || 0}</p>
//           </div>
//           <div>
//             <p className="font-semibold text-green-700">‚úÖ Clicked</p>
//             <p className="text-2xl font-bold">{summary.clickedCount || 0}</p>
//           </div>
//         </div>
//         {/* Chart Section */}
//         <div className="col-span-2 h-48">
//           <ResponsiveContainer width="100%" height="100%">
//             <PieChart>
//               <Pie
//                 data={chartData}
//                 dataKey="value"
//                 nameKey="name"
//                 cx="50%"
//                 cy="50%"
//                 innerRadius={40}
//                 outerRadius={60}
//                 fill="#8884d8"
//               >
//                 {chartData.map((entry, index) => (
//                   <Cell
//                     key={`cell-${index}`}
//                     fill={COLORS[index % COLORS.length]}
//                   />
//                 ))}
//               </Pie>
//               <Tooltip />
//               <Legend iconSize={10} />
//             </PieChart>
//           </ResponsiveContainer>
//         </div>
//       </div>
//     </div>
//   );
// }

// export default CampaignSummaryBar;
// import React from "react";

// function CampaignSummaryBar({ summary }) {
//   if (!summary) return null;

//   const formatDate = datetime =>
//     datetime ? new Date(datetime).toLocaleString() : "-";

//   return (
//     <div className="bg-white border rounded-md shadow p-4 mb-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-gray-800">
//       <div>
//         <p className="font-semibold text-purple-700">üì¨ Total Sent</p>
//         <p>{summary.totalSent}</p>
//       </div>
//       <div>
//         <p className="font-semibold text-red-600">‚ùå Failed</p>
//         <p>{summary.failedCount}</p>
//       </div>
//       <div>
//         <p className="font-semibold text-green-700">‚úÖ Clicked</p>
//         <p>{summary.clickedCount}</p>
//       </div>
//       <div>
//         <p className="font-semibold text-blue-600">üïí Last Sent</p>
//         <p>{formatDate(summary.lastSentAt)}</p>
//       </div>
//     </div>
//   );
// }

// export default CampaignSummaryBar;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\components\ContactJourneyModal.jsx 
====================================================== 
 
// import React, { useEffect, useState, Fragment } from "react";
// import { Dialog, Transition } from "@headlessui/react";
// import axiosClient from "../../../api/axiosClient";
// import { Send, MousePointerClick, Hourglass } from "lucide-react";

// // Helper function to format dates
// const formatDate = dt => (dt ? new Date(dt).toLocaleString() : "N/A");

// // The main modal component
// function ContactJourneyModal({ isOpen, onClose, log }) {
//   const [journey, setJourney] = useState([]);
//   const [loading, setLoading] = useState(false);

//   useEffect(() => {
//     if (isOpen && log?.id) {
//       const fetchJourney = async () => {
//         setLoading(true);
//         try {
//           const res = await axiosClient.get(`/tracking/journeys/${log.id}`);
//           setJourney(res.data || []);
//         } catch (error) {
//           console.error("Failed to fetch contact journey", error);
//         } finally {
//           setLoading(false);
//         }
//       };
//       fetchJourney();
//     }
//   }, [isOpen, log]);

//   if (!log) return null;

//   return (
//     <Transition appear show={isOpen} as={Fragment}>
//       <Dialog as="div" className="relative z-50" onClose={onClose}>
//         <Transition.Child
//           as={Fragment}
//           enter="ease-out duration-300"
//           enterFrom="opacity-0"
//           enterTo="opacity-100"
//           leave="ease-in duration-200"
//           leaveFrom="opacity-100"
//           leaveTo="opacity-0"
//         >
//           <div className="fixed inset-0 bg-black bg-opacity-40" />
//         </Transition.Child>

//         <div className="fixed inset-0 overflow-y-hidden">
//           <div className="flex items-center justify-center min-h-full p-4">
//             <Transition.Child
//               as={Fragment}
//               enter="ease-out duration-300"
//               enterFrom="opacity-0 scale-95"
//               enterTo="opacity-100 scale-100"
//               leave="ease-in duration-200"
//               leaveFrom="opacity-100 scale-100"
//               leaveTo="opacity-0 scale-95"
//             >
//               {/* FIX: Panel is now a flex column with a max height */}
//               <Dialog.Panel className="w-full max-w-2xl flex flex-col max-h-[85vh] transform overflow-hidden rounded-xl bg-white shadow-xl transition-all">
//                 {/* Header: Now a static flex item */}
//                 <Dialog.Title className="flex-shrink-0 px-6 pt-6 pb-4 text-xl font-bold text-gray-800 flex items-center gap-2 border-b border-gray-200">
//                   <span className="text-purple-600">üß≠</span> Contact Journey
//                   for {log.contactName}
//                 </Dialog.Title>

//                 {/* Content: This area is now scrollable */}
//                 <div className="flex-grow overflow-y-auto px-6">
//                   {loading ? (
//                     <p className="text-center text-gray-500 py-8">
//                       Loading journey...
//                     </p>
//                   ) : journey.length > 0 ? (
//                     <div className="border-l-2 border-slate-200 ml-3 py-8 space-y-8">
//                       {journey.map((event, idx) => (
//                         <JourneyEvent key={idx} event={event} />
//                       ))}
//                     </div>
//                   ) : (
//                     <p className="text-center text-gray-500 py-8">
//                       No journey events found for this message.
//                     </p>
//                   )}
//                 </div>

//                 {/* Footer: Now a static flex item */}
//                 <div className="flex-shrink-0 px-6 pt-4 pb-6 flex justify-end gap-3 border-t border-gray-200">
//                   <button
//                     onClick={onClose}
//                     className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-sm font-semibold"
//                   >
//                     Close
//                   </button>
//                 </div>
//               </Dialog.Panel>
//             </Transition.Child>
//           </div>
//         </div>
//       </Dialog>
//     </Transition>
//   );
// }

// // A sub-component to render each event in the timeline (no changes needed here)
// const JourneyEvent = ({ event }) => {
//   const ICONS = {
//     MessageSent: <Send size={16} className="text-white" />,
//     ButtonClicked: <MousePointerClick size={16} className="text-white" />,
//   };

//   const COLORS = {
//     MessageSent: "bg-blue-500",
//     ButtonClicked: "bg-green-500",
//   };

//   return (
//     <div className="relative pl-10">
//       <div
//         className={`absolute -left-4 top-0.5 w-8 h-8 rounded-full flex items-center justify-center ring-4 ring-white ${
//           COLORS[event.eventType] || "bg-gray-400"
//         }`}
//       >
//         {ICONS[event.eventType] || (
//           <Hourglass size={16} className="text-white" />
//         )}
//       </div>
//       <p className="font-semibold text-gray-800">{event.title}</p>
//       <p className="text-sm text-gray-500 truncate">{event.details}</p>
//       <p className="text-xs text-gray-400 mt-1">
//         {formatDate(event.timestamp)}
//       </p>
//     </div>
//   );
// };

// export default ContactJourneyModal;

// import React, { useEffect, useState, Fragment } from "react";
// import { Dialog, Transition } from "@headlessui/react";
// import axiosClient from "../../../api/axiosClient";
// import {
//   Send,
//   MousePointerClick,
//   Hourglass,
//   CheckCircle2,
//   Eye,
//   Share2,
// } from "lucide-react";

// const formatDate = dt => (dt ? new Date(dt).toLocaleString() : "N/A");

// function ContactJourneyModal({ isOpen, onClose, log }) {
//   const [journey, setJourney] = useState({ events: [] });
//   const [loading, setLoading] = useState(false);

//   useEffect(() => {
//     if (isOpen && log?.id) {
//       (async () => {
//         setLoading(true);
//         try {
//           const res = await axiosClient.get(`/tracking/journeys/${log.id}`);
//           const data = res.data;
//           // Back-compat: if server returns an array, wrap it
//           if (Array.isArray(data)) setJourney({ events: data });
//           else setJourney(data || { events: [] });
//         } catch (e) {
//           console.error("Failed to fetch contact journey", e);
//           setJourney({ events: [] });
//         } finally {
//           setLoading(false);
//         }
//       })();
//     }
//   }, [isOpen, log]);

//   if (!log) return null;

//   const typeBadge =
//     journey.campaignType === "flow" ? (
//       <span className="ml-2 inline-flex items-center px-2 py-0.5 rounded bg-emerald-100 text-emerald-700 text-xs font-semibold">
//         Flow
//       </span>
//     ) : (
//       <span className="ml-2 inline-flex items-center px-2 py-0.5 rounded bg-blue-100 text-blue-700 text-xs font-semibold">
//         Dynamic URL
//       </span>
//     );

//   return (
//     <Transition appear show={isOpen} as={Fragment}>
//       <Dialog as="div" className="relative z-50" onClose={onClose}>
//         <Transition.Child
//           as={Fragment}
//           enter="ease-out duration-300"
//           enterFrom="opacity-0"
//           enterTo="opacity-100"
//           leave="ease-in duration-200"
//           leaveFrom="opacity-100"
//           leaveTo="opacity-0"
//         >
//           <div className="fixed inset-0 bg-black/40" />
//         </Transition.Child>

//         <div className="fixed inset-0 overflow-y-hidden">
//           <div className="flex items-center justify-center min-h-full p-4">
//             <Transition.Child
//               as={Fragment}
//               enter="ease-out duration-300"
//               enterFrom="opacity-0 scale-95"
//               enterTo="opacity-100 scale-100"
//               leave="ease-in duration-200"
//               leaveFrom="opacity-100 scale-100"
//               leaveTo="opacity-0 scale-95"
//             >
//               <Dialog.Panel className="w-full max-w-2xl flex flex-col max-h-[85vh] transform overflow-hidden rounded-xl bg-white shadow-xl transition-all">
//                 <Dialog.Title className="flex-shrink-0 px-6 pt-6 pb-4 text-xl font-bold text-gray-800 flex items-center gap-2 border-b border-gray-200">
//                   <span className="text-purple-600">üß≠</span>
//                   Contact Journey for {log.contactName}
//                   {typeBadge}
//                 </Dialog.Title>

//                 <div className="flex-grow overflow-y-auto px-6">
//                   {loading ? (
//                     <p className="text-center text-gray-500 py-8">
//                       Loading journey...
//                     </p>
//                   ) : (journey?.events?.length || 0) > 0 ? (
//                     <>
//                       {journey?.leftOffAt && (
//                         <div className="mt-4 mb-2 text-xs text-gray-500">
//                           Left off at:{" "}
//                           <span className="font-semibold">
//                             {journey.leftOffAt}
//                           </span>
//                           {journey.flowName ? (
//                             <span>
//                               {" "}
//                               in{" "}
//                               <span className="font-semibold">
//                                 {journey.flowName}
//                               </span>
//                             </span>
//                           ) : null}
//                         </div>
//                       )}
//                       <div className="border-l-2 border-slate-200 ml-3 py-8 space-y-8">
//                         {journey.events.map((event, idx) => (
//                           <JourneyEvent key={idx} event={event} />
//                         ))}
//                       </div>
//                     </>
//                   ) : (
//                     <p className="text-center text-gray-500 py-8">
//                       No journey events found for this message.
//                     </p>
//                   )}
//                 </div>

//                 <div className="flex-shrink-0 px-6 pt-4 pb-6 flex justify-end gap-3 border-t border-gray-200">
//                   <button
//                     onClick={onClose}
//                     className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-sm font-semibold"
//                   >
//                     Close
//                   </button>
//                 </div>
//               </Dialog.Panel>
//             </Transition.Child>
//           </div>
//         </div>
//       </Dialog>
//     </Transition>
//   );
// }

// const ICONS = {
//   MessageSent: <Send size={16} className="text-white" />,
//   Delivered: <CheckCircle2 size={16} className="text-white" />,
//   Read: <Eye size={16} className="text-white" />,
//   ButtonClicked: <MousePointerClick size={16} className="text-white" />,
//   FlowSend: <Send size={16} className="text-white" />,
//   Redirect: <Share2 size={16} className="text-white" />,
// };

// const COLORS = {
//   MessageSent: "bg-blue-500",
//   Delivered: "bg-emerald-500",
//   Read: "bg-cyan-500",
//   ButtonClicked: "bg-green-500",
//   FlowSend: "bg-indigo-500",
//   Redirect: "bg-amber-500",
// };

// const JourneyEvent = ({ event }) => {
//   const icon = ICONS[event.eventType] || (
//     <Hourglass size={16} className="text-white" />
//   );
//   const color = COLORS[event.eventType] || "bg-gray-400";

//   return (
//     <div className="relative pl-10">
//       <div
//         className={`absolute -left-4 top-0.5 w-8 h-8 rounded-full flex items-center justify-center ring-4 ring-white ${color}`}
//       >
//         {icon}
//       </div>
//       <p className="font-semibold text-gray-800">{event.title}</p>
//       <p className="text-sm text-gray-500 break-words">
//         {event.details}
//         {event.url ? (
//           <>
//             <br />
//             <a
//               className="text-blue-600 underline"
//               href={event.url}
//               target="_blank"
//               rel="noreferrer"
//             >
//               {event.url}
//             </a>
//           </>
//         ) : null}
//       </p>
//       <p className="text-xs text-gray-400 mt-1">
//         {formatDate(event.timestamp)}
//       </p>
//     </div>
//   );
// };

// export default ContactJourneyModal;
// üìÑ src/pages/campaigns/components/ContactJourneyModal.jsx
// import React, { useEffect, useMemo, useState, Fragment } from "react";
// import { Dialog, Transition } from "@headlessui/react";
// import axiosClient from "../../../api/axiosClient";
// import {
//   Send,
//   MousePointerClick,
//   Hourglass,
//   CheckCircle2,
//   Eye,
//   Share2,
//   Link2,
//   Copy,
//   Filter,
//   X,
// } from "lucide-react";

// const formatDate = dt => (dt ? new Date(dt).toLocaleString() : "N/A");

// // ---- helpers ----
// const relTime = iso => {
//   if (!iso) return "";
//   const diff = Date.now() - new Date(iso).getTime();
//   const abs = Math.abs(diff);
//   const mins = Math.floor(abs / (60 * 1000));
//   if (mins < 1) return "just now";
//   if (mins < 60) return `${mins}m ${diff < 0 ? "from now" : "ago"}`;
//   const hrs = Math.floor(mins / 60);
//   if (hrs < 24) return `${hrs}h ${diff < 0 ? "from now" : "ago"}`;
//   const days = Math.floor(hrs / 24);
//   return `${days}d ${diff < 0 ? "from now" : "ago"}`;
// };

// const displayUrl = raw => {
//   try {
//     const u = new URL(raw);
//     const tail =
//       u.pathname.length > 1 ? u.pathname.split("/").slice(-1)[0] : "";
//     return `${u.hostname}${tail ? `/${tail}` : ""}`;
//   } catch {
//     return raw?.slice(0, 60) || "";
//   }
// };

// const ICONS = {
//   MessageSent: <Send size={16} className="text-white" />,
//   Delivered: <CheckCircle2 size={16} className="text-white" />,
//   Read: <Eye size={16} className="text-white" />,
//   ButtonClicked: <MousePointerClick size={16} className="text-white" />,
//   FlowSend: <Send size={16} className="text-white" />,
//   Redirect: <Share2 size={16} className="text-white" />,
// };

// const COLORS = {
//   MessageSent: "bg-blue-500",
//   Delivered: "bg-emerald-500",
//   Read: "bg-cyan-500",
//   ButtonClicked: "bg-green-500",
//   FlowSend: "bg-indigo-500",
//   Redirect: "bg-amber-500",
// };

// const isClickEvent = t => t === "ButtonClicked" || t === "Redirect";
// const isMessageEvent = t =>
//   t === "MessageSent" || t === "Delivered" || t === "Read" || t === "FlowSend";

// function ContactJourneyModal({ isOpen, onClose, log }) {
//   const [journey, setJourney] = useState({ events: [] });
//   const [loading, setLoading] = useState(false);
//   const [filter, setFilter] = useState("all"); // all | messages | clicks
//   const [expanded, setExpanded] = useState(false);

//   // ‚úÖ safe fallback to avoid conditional return before hooks
//   const safeLog = log || { contactName: "Unknown" };

//   useEffect(() => {
//     if (isOpen && log?.id) {
//       (async () => {
//         setLoading(true);
//         try {
//           const res = await axiosClient.get(`/tracking/journeys/${log.id}`);
//           const data = res.data;
//           if (Array.isArray(data)) setJourney({ events: data });
//           else setJourney(data || { events: [] });
//         } catch (e) {
//           console.error("Failed to fetch contact journey", e);
//           setJourney({ events: [] });
//         } finally {
//           setLoading(false);
//         }
//       })();
//     }
//   }, [isOpen, log]);

//   useEffect(() => {
//     if (isOpen) setExpanded(false);
//   }, [isOpen]);

//   const typeBadge =
//     journey.campaignType === "flow" ? (
//       <span className="ml-2 inline-flex items-center px-2 py-0.5 rounded bg-emerald-100 text-emerald-700 text-xs font-semibold">
//         Flow
//       </span>
//     ) : (
//       <span className="ml-2 inline-flex items-center px-2 py-0.5 rounded bg-blue-100 text-blue-700 text-xs font-semibold">
//         Dynamic URL
//       </span>
//     );

//   // filter view
//   const eventsFiltered = useMemo(() => {
//     const all = journey?.events || [];
//     if (filter === "messages")
//       return all.filter(e => isMessageEvent(e.eventType));
//     if (filter === "clicks") return all.filter(e => isClickEvent(e.eventType));
//     return all;
//   }, [journey, filter]);

//   // collapse logic
//   const COLLAPSE_AFTER = 6;
//   const eventsVisible =
//     expanded || eventsFiltered.length <= COLLAPSE_AFTER
//       ? eventsFiltered
//       : eventsFiltered.slice(0, COLLAPSE_AFTER);

//   const leftOff = journey?.leftOffAt;

//   return (
//     <Transition appear show={isOpen} as={Fragment}>
//       <Dialog as="div" className="relative z-50" onClose={onClose}>
//         <Transition.Child
//           as={Fragment}
//           enter="ease-out duration-300"
//           enterFrom="opacity-0"
//           enterTo="opacity-100"
//           leave="ease-in duration-200"
//           leaveFrom="opacity-100"
//           leaveTo="opacity-0"
//         >
//           <div className="fixed inset-0 bg-black/40" />
//         </Transition.Child>

//         <div className="fixed inset-0 overflow-y-hidden">
//           <div className="flex items-center justify-center min-h-full p-4">
//             <Transition.Child
//               as={Fragment}
//               enter="ease-out duration-300"
//               enterFrom="opacity-0 scale-95"
//               enterTo="opacity-100 scale-100"
//               leave="ease-in duration-200"
//               leaveFrom="opacity-100 scale-100"
//               leaveTo="opacity-0 scale-95"
//             >
//               <Dialog.Panel className="w-full max-w-2xl flex flex-col max-h-[85vh] transform overflow-hidden rounded-xl bg-white shadow-xl transition-all">
//                 {/* Header */}
//                 <Dialog.Title className="sticky top-0 z-10 bg-white/70 backdrop-blur px-6 pt-6 pb-3 text-xl font-bold text-gray-800 flex items-center gap-2 border-b border-gray-200">
//                   <span className="text-purple-600">üß≠</span>
//                   Contact Journey for {safeLog.contactName}
//                   {typeBadge}
//                   <div className="ml-auto flex items-center gap-2">
//                     <Filter size={16} className="text-gray-400" />
//                     <div className="inline-flex rounded-lg border overflow-hidden">
//                       <button
//                         className={`px-2 py-1 text-xs ${
//                           filter === "all"
//                             ? "bg-gray-900 text-white"
//                             : "bg-white"
//                         }`}
//                         onClick={() => setFilter("all")}
//                       >
//                         All
//                       </button>
//                       <button
//                         className={`px-2 py-1 text-xs border-l ${
//                           filter === "messages"
//                             ? "bg-gray-900 text-white"
//                             : "bg-white"
//                         }`}
//                         onClick={() => setFilter("messages")}
//                       >
//                         Messages
//                       </button>
//                       <button
//                         className={`px-2 py-1 text-xs border-l ${
//                           filter === "clicks"
//                             ? "bg-gray-900 text-white"
//                             : "bg-white"
//                         }`}
//                         onClick={() => setFilter("clicks")}
//                       >
//                         Clicks
//                       </button>
//                     </div>
//                     <button
//                       onClick={onClose}
//                       className="ml-2 inline-flex items-center justify-center rounded-lg p-2 hover:bg-gray-100"
//                       aria-label="Close"
//                     >
//                       <X size={16} />
//                     </button>
//                   </div>
//                 </Dialog.Title>

//                 {/* Body */}
//                 <div className="flex-grow overflow-y-auto px-6">
//                   {loading ? (
//                     <p className="text-center text-gray-500 py-8">
//                       Loading journey...
//                     </p>
//                   ) : (eventsFiltered.length || 0) > 0 ? (
//                     <>
//                       {leftOff && (
//                         <div className="mt-4 mb-2 text-xs text-gray-600">
//                           <span className="inline-flex items-center gap-1 rounded-full bg-amber-50 text-amber-700 px-2 py-1 font-semibold">
//                             Left off at:
//                             <span className="text-amber-900">{leftOff}</span>
//                             {journey.flowName ? (
//                               <span className="text-amber-700">
//                                 &nbsp;in{" "}
//                                 <span className="font-bold">
//                                   {journey.flowName}
//                                 </span>
//                               </span>
//                             ) : null}
//                           </span>
//                         </div>
//                       )}

//                       <div className="relative ml-4 py-6">
//                         {/* vertical line */}
//                         <div className="absolute left-0 top-0 bottom-0 w-px bg-slate-200" />
//                         <div className="space-y-6">
//                           {eventsVisible.map((event, idx) => (
//                             <JourneyEvent
//                               key={idx}
//                               isCurrent={
//                                 leftOff && event?.title?.includes(leftOff)
//                               }
//                               event={event}
//                             />
//                           ))}
//                         </div>
//                       </div>

//                       {eventsFiltered.length > COLLAPSE_AFTER && (
//                         <div className="flex justify-center pt-2 pb-6">
//                           <button
//                             onClick={() => setExpanded(v => !v)}
//                             className="text-sm font-semibold text-purple-700 hover:text-purple-800"
//                           >
//                             {expanded
//                               ? "Show less"
//                               : `Show ${
//                                   eventsFiltered.length - COLLAPSE_AFTER
//                                 } more events`}
//                           </button>
//                         </div>
//                       )}
//                     </>
//                   ) : (
//                     <p className="text-center text-gray-500 py-8">
//                       No journey events found for this message.
//                     </p>
//                   )}
//                 </div>

//                 {/* Footer */}
//                 <div className="flex-shrink-0 px-6 pt-3 pb-5 flex justify-end gap-3 border-t border-gray-200">
//                   <button
//                     onClick={onClose}
//                     className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-sm font-semibold"
//                   >
//                     Close
//                   </button>
//                 </div>
//               </Dialog.Panel>
//             </Transition.Child>
//           </div>
//         </div>
//       </Dialog>
//     </Transition>
//   );
// }

// // const JourneyEvent = ({ event, isCurrent }) => {
// //   const icon = ICONS[event.eventType] || (
// //     <Hourglass size={16} className="text-white" />
// //   );
// //   const color = COLORS[event.eventType] || "bg-gray-400";

// //   const handleCopy = () => {
// //     if (event.url) {
// //       navigator.clipboard?.writeText(event.url);
// //     }
// //   };

// //   const isClickable = Boolean(event.url);

// //   return (
// //     <div className="relative pl-8">
// //       {/* node */}
// //       <div
// //         className={`absolute -left-3 top-1 w-6 h-6 rounded-full flex items-center justify-center ring-4 ring-white ${color} ${
// //           isCurrent ? "scale-110 shadow-lg" : ""
// //         }`}
// //       >
// //         {icon}
// //       </div>

// //       <div
// //         className={`rounded-lg p-3 ${
// //           isCurrent ? "bg-amber-50 border border-amber-200" : "bg-white"
// //         }`}
// //       >
// //         <p className="font-semibold text-gray-800">{event.title}</p>

// //         <p className="text-sm text-gray-600 break-words">
// //           {event.details}
// //           {isClickable && (
// //             <>
// //               <br />
// //               <a
// //                 className="inline-flex items-center gap-1 text-blue-700 underline underline-offset-2"
// //                 href={event.url}
// //                 target="_blank"
// //                 rel="noreferrer"
// //                 title={event.url}
// //               >
// //                 <Link2 size={14} />
// //                 {displayUrl(event.url)}
// //               </a>
// //               <button
// //                 onClick={handleCopy}
// //                 className="ml-2 inline-flex items-center gap-1 text-gray-500 hover:text-gray-700"
// //                 title="Copy URL"
// //               >
// //                 <Copy size={14} />
// //                 <span className="text-xs">Copy</span>
// //               </button>
// //             </>
// //           )}
// //         </p>

// //         <p className="text-xs text-gray-400 mt-2">
// //           {formatDate(event.timestamp)} ‚Ä¢ {relTime(event.timestamp)}
// //         </p>
// //       </div>
// //     </div>
// //   );
// // };
// const JourneyEvent = ({ event, isCurrent }) => {
//   const icon = ICONS[event.eventType] || (
//     <Hourglass size={16} className="text-white" />
//   );
//   const color = COLORS[event.eventType] || "bg-gray-400";

//   const handleCopy = () => {
//     if (event.url) {
//       navigator.clipboard?.writeText(event.url);
//     }
//   };

//   const isClickable = Boolean(event.url);

//   // ‚úÖ hide "details" for click-type events (Quick Reply / URL button)
//   const shouldShowDetails = !(
//     event.eventType === "ButtonClicked" || event.eventType === "Redirect"
//   );

//   return (
//     <div className="relative pl-8">
//       {/* node */}
//       <div
//         className={`absolute -left-3 top-1 w-6 h-6 rounded-full flex items-center justify-center ring-4 ring-white ${color} ${
//           isCurrent ? "scale-110 shadow-lg" : ""
//         }`}
//       >
//         {icon}
//       </div>

//       <div
//         className={`rounded-lg p-3 ${
//           isCurrent ? "bg-amber-50 border border-amber-200" : "bg-white"
//         }`}
//       >
//         <p className="font-semibold text-gray-800">{event.title}</p>

//         {shouldShowDetails && event.details && (
//           <p className="text-sm text-gray-600 break-words">{event.details}</p>
//         )}

//         {isClickable && (
//           <p className="mt-1">
//             <a
//               className="inline-flex items-center gap-1 text-blue-700 underline underline-offset-2"
//               href={event.url}
//               target="_blank"
//               rel="noreferrer"
//               title={event.url}
//             >
//               <Link2 size={14} />
//               {displayUrl(event.url)}
//             </a>
//             <button
//               onClick={handleCopy}
//               className="ml-2 inline-flex items-center gap-1 text-gray-500 hover:text-gray-700"
//               title="Copy URL"
//             >
//               <Copy size={14} />
//               <span className="text-xs">Copy</span>
//             </button>
//           </p>
//         )}

//         <p className="text-xs text-gray-400 mt-2">
//           {formatDate(event.timestamp)} ‚Ä¢ {relTime(event.timestamp)}
//         </p>
//       </div>
//     </div>
//   );
// };

// export default ContactJourneyModal;
// üìÑ src/pages/campaigns/components/ContactJourneyModal.jsx
// import React, { useEffect, useMemo, useState, Fragment } from "react";
// import { Dialog, Transition } from "@headlessui/react";
// import axiosClient from "../../../api/axiosClient";
// import {
//   Send,
//   MousePointerClick,
//   Hourglass,
//   CheckCircle2,
//   Eye,
//   Share2,
//   Link2,
//   Copy,
//   Filter,
//   X,
// } from "lucide-react";

// const formatDate = dt => (dt ? new Date(dt).toLocaleString() : "N/A");

// // ---- helpers ----
// const relTime = iso => {
//   if (!iso) return "";
//   const diff = Date.now() - new Date(iso).getTime();
//   const abs = Math.abs(diff);
//   const mins = Math.floor(abs / (60 * 1000));
//   if (mins < 1) return "just now";
//   if (mins < 60) return `${mins}m ${diff < 0 ? "from now" : "ago"}`;
//   const hrs = Math.floor(mins / 60);
//   if (hrs < 24) return `${hrs}h ${diff < 0 ? "from now" : "ago"}`;
//   const days = Math.floor(hrs / 24);
//   return `${days}d ${diff < 0 ? "from now" : "ago"}`;
// };

// const displayUrl = raw => {
//   try {
//     const u = new URL(raw);
//     const tail =
//       u.pathname.length > 1 ? u.pathname.split("/").slice(-1)[0] : "";
//     return `${u.hostname}${tail ? `/${tail}` : ""}`;
//   } catch {
//     return raw?.slice(0, 60) || "";
//   }
// };

// // üëâ extract a phone number from any string like "WhatsApp User (+91897‚Ä¶)"
// const extractNumber = val => {
//   if (!val) return null;
//   const m = String(val).match(/(\+?\d[\d\s-]{5,}\d)/);
//   return m ? m[1].replace(/[\s-]/g, "") : null;
// };

// const ICONS = {
//   MessageSent: <Send size={16} className="text-white" />,
//   Delivered: <CheckCircle2 size={16} className="text-white" />,
//   Read: <Eye size={16} className="text-white" />,
//   ButtonClicked: <MousePointerClick size={16} className="text-white" />,
//   FlowSend: <Send size={16} className="text-white" />,
//   Redirect: <Share2 size={16} className="text-white" />,
// };

// const COLORS = {
//   MessageSent: "bg-blue-500",
//   Delivered: "bg-emerald-500",
//   Read: "bg-cyan-500",
//   ButtonClicked: "bg-green-500",
//   FlowSend: "bg-indigo-500",
//   Redirect: "bg-amber-500",
// };

// const isClickEvent = t => t === "ButtonClicked" || t === "Redirect";
// const isMessageEvent = t =>
//   t === "MessageSent" || t === "Delivered" || t === "Read" || t === "FlowSend";

// function ContactJourneyModal({ isOpen, onClose, log }) {
//   const [journey, setJourney] = useState({ events: [] });
//   const [loading, setLoading] = useState(false);
//   const [filter, setFilter] = useState("all"); // all | messages | clicks
//   const [expanded, setExpanded] = useState(false);

//   // ‚úÖ safe fallback to avoid conditional return before hooks
//   const safeLog = log || { contactName: "Unknown" };

//   // Prefer explicit phone fields, then try to pull from contactName like "WhatsApp User (+91‚Ä¶)"
//   const displayPhone =
//     log?.recipientNumber ||
//     log?.contactPhone ||
//     log?.to ||
//     extractNumber(log?.contactName) ||
//     "Unknown";

//   useEffect(() => {
//     if (isOpen && log?.id) {
//       (async () => {
//         setLoading(true);
//         try {
//           const res = await axiosClient.get(`/tracking/journeys/${log.id}`);
//           const data = res.data;
//           if (Array.isArray(data)) setJourney({ events: data });
//           else setJourney(data || { events: [] });
//         } catch (e) {
//           console.error("Failed to fetch contact journey", e);
//           setJourney({ events: [] });
//         } finally {
//           setLoading(false);
//         }
//       })();
//     }
//   }, [isOpen, log]);

//   useEffect(() => {
//     if (isOpen) setExpanded(false);
//   }, [isOpen]);

//   const typeBadge =
//     journey.campaignType === "flow" ? (
//       <span className="ml-2 inline-flex items-center px-2 py-0.5 rounded bg-emerald-100 text-emerald-700 text-xs font-semibold">
//         Flow
//       </span>
//     ) : (
//       <span className="ml-2 inline-flex items-center px-2 py-0.5 rounded bg-blue-100 text-blue-700 text-xs font-semibold">
//         Dynamic URL
//       </span>
//     );

//   // filter view
//   const eventsFiltered = useMemo(() => {
//     const all = journey?.events || [];
//     if (filter === "messages")
//       return all.filter(e => isMessageEvent(e.eventType));
//     if (filter === "clicks") return all.filter(e => isClickEvent(e.eventType));
//     return all;
//   }, [journey, filter]);

//   // collapse logic
//   const COLLAPSE_AFTER = 6;
//   const eventsVisible =
//     expanded || eventsFiltered.length <= COLLAPSE_AFTER
//       ? eventsFiltered
//       : eventsFiltered.slice(0, COLLAPSE_AFTER);

//   const leftOff = journey?.leftOffAt;

//   return (
//     <Transition appear show={isOpen} as={Fragment}>
//       <Dialog as="div" className="relative z-50" onClose={onClose}>
//         <Transition.Child
//           as={Fragment}
//           enter="ease-out duration-300"
//           enterFrom="opacity-0"
//           enterTo="opacity-100"
//           leave="ease-in duration-200"
//           leaveFrom="opacity-100"
//           leaveTo="opacity-0"
//         >
//           <div className="fixed inset-0 bg-black/40" />
//         </Transition.Child>

//         <div className="fixed inset-0 overflow-y-hidden">
//           <div className="flex items-center justify-center min-h-full p-4">
//             <Transition.Child
//               as={Fragment}
//               enter="ease-out duration-300"
//               enterFrom="opacity-0 scale-95"
//               enterTo="opacity-100 scale-100"
//               leave="ease-in duration-200"
//               leaveFrom="opacity-100 scale-100"
//               leaveTo="opacity-0 scale-95"
//             >
//               <Dialog.Panel className="w-full max-w-2xl flex flex-col max-h-[85vh] transform overflow-hidden rounded-xl bg-white shadow-xl transition-all">
//                 {/* Header */}
//                 <Dialog.Title className="sticky top-0 z-10 bg-white/70 backdrop-blur px-6 pt-6 pb-3 text-lg font-semibold text-gray-800 flex items-center gap-2 border-b border-gray-200">
//                   <span className="text-purple-600">üß≠</span>
//                   {/* üîÅ Show only the phone number here */}
//                   Contact Journey for {displayPhone}
//                   {typeBadge}
//                   <div className="ml-auto flex items-center gap-2">
//                     <Filter size={16} className="text-gray-400" />
//                     <div className="inline-flex rounded-lg border overflow-hidden">
//                       <button
//                         className={`px-2 py-1 text-xs ${
//                           filter === "all"
//                             ? "bg-gray-900 text-white"
//                             : "bg-white"
//                         }`}
//                         onClick={() => setFilter("all")}
//                       >
//                         All
//                       </button>
//                       <button
//                         className={`px-2 py-1 text-xs border-l ${
//                           filter === "messages"
//                             ? "bg-gray-900 text-white"
//                             : "bg-white"
//                         }`}
//                         onClick={() => setFilter("messages")}
//                       >
//                         Messages
//                       </button>
//                       <button
//                         className={`px-2 py-1 text-xs border-l ${
//                           filter === "clicks"
//                             ? "bg-gray-900 text-white"
//                             : "bg-white"
//                         }`}
//                         onClick={() => setFilter("clicks")}
//                       >
//                         Clicks
//                       </button>
//                     </div>
//                     <button
//                       onClick={onClose}
//                       className="ml-2 inline-flex items-center justify-center rounded-lg p-2 hover:bg-gray-100"
//                       aria-label="Close"
//                     >
//                       <X size={16} />
//                     </button>
//                   </div>
//                 </Dialog.Title>

//                 {/* Body */}
//                 <div className="flex-grow overflow-y-auto px-6">
//                   {loading ? (
//                     <p className="text-center text-gray-500 py-8">
//                       Loading journey...
//                     </p>
//                   ) : (eventsFiltered.length || 0) > 0 ? (
//                     <>
//                       {leftOff && (
//                         <div className="mt-4 mb-2 text-xs text-gray-600">
//                           <span className="inline-flex items-center gap-1 rounded-full bg-amber-50 text-amber-700 px-2 py-1 font-semibold">
//                             Left off at:
//                             <span className="text-amber-900">{leftOff}</span>
//                             {journey.flowName ? (
//                               <span className="text-amber-700">
//                                 &nbsp;in{" "}
//                                 <span className="font-bold">
//                                   {journey.flowName}
//                                 </span>
//                               </span>
//                             ) : null}
//                           </span>
//                         </div>
//                       )}

//                       <div className="relative ml-4 py-6">
//                         <div className="absolute left-0 top-0 bottom-0 w-px bg-slate-200" />
//                         <div className="space-y-6">
//                           {eventsVisible.map((event, idx) => (
//                             <JourneyEvent
//                               key={idx}
//                               isCurrent={
//                                 leftOff && event?.title?.includes(leftOff)
//                               }
//                               event={event}
//                             />
//                           ))}
//                         </div>
//                       </div>

//                       {eventsFiltered.length > COLLAPSE_AFTER && (
//                         <div className="flex justify-center pt-2 pb-6">
//                           <button
//                             onClick={() => setExpanded(v => !v)}
//                             className="text-sm font-semibold text-purple-700 hover:text-purple-800"
//                           >
//                             {expanded
//                               ? "Show less"
//                               : `Show ${
//                                   eventsFiltered.length - COLLAPSE_AFTER
//                                 } more events`}
//                           </button>
//                         </div>
//                       )}
//                     </>
//                   ) : (
//                     <p className="text-center text-gray-500 py-8">
//                       No journey events found for this message.
//                     </p>
//                   )}
//                 </div>

//                 {/* Footer */}
//                 <div className="flex-shrink-0 px-6 pt-3 pb-5 flex justify-end gap-3 border-t border-gray-200">
//                   <button
//                     onClick={onClose}
//                     className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-sm font-semibold"
//                   >
//                     Close
//                   </button>
//                 </div>
//               </Dialog.Panel>
//             </Transition.Child>
//           </div>
//         </div>
//       </Dialog>
//     </Transition>
//   );
// }

// const JourneyEvent = ({ event, isCurrent }) => {
//   const icon = ICONS[event.eventType] || (
//     <Hourglass size={16} className="text-white" />
//   );
//   const color = COLORS[event.eventType] || "bg-gray-400";

//   const handleCopy = () => {
//     if (event.url) {
//       navigator.clipboard?.writeText(event.url);
//     }
//   };

//   const isClickable = Boolean(event.url);

//   // Hide details for click-type events; keep for statuses/errors
//   const shouldShowDetails = !(
//     event.eventType === "ButtonClicked" || event.eventType === "Redirect"
//   );

//   return (
//     <div className="relative pl-8">
//       <div
//         className={`absolute -left-3 top-1 w-6 h-6 rounded-full flex items-center justify-center ring-4 ring-white ${color} ${
//           isCurrent ? "scale-110 shadow-lg" : ""
//         }`}
//       >
//         {icon}
//       </div>

//       <div
//         className={`rounded-lg p-2 ${
//           isCurrent ? "bg-amber-50 border border-amber-200" : "bg-white"
//         }`}
//       >
//         <p className="font-semibold text-gray-800">{event.title}</p>

//         {shouldShowDetails && event.details && (
//           <p className="text-sm text-gray-600 break-words">{event.details}</p>
//         )}

//         {isClickable && (
//           <p className="mt-1">
//             <a
//               className="inline-flex items-center gap-1 text-blue-700 underline underline-offset-2"
//               href={event.url}
//               target="_blank"
//               rel="noreferrer"
//               title={event.url}
//             >
//               <Link2 size={14} />
//               {displayUrl(event.url)}
//             </a>
//             <button
//               onClick={handleCopy}
//               className="ml-2 inline-flex items-center gap-1 text-gray-500 hover:text-gray-700"
//               title="Copy URL"
//             >
//               <Copy size={14} />
//               <span className="text-xs">Copy</span>
//             </button>
//           </p>
//         )}

//         <p className="text-xs text-gray-400 mt-2">
//           {formatDate(event.timestamp)} ‚Ä¢ {relTime(event.timestamp)}
//         </p>
//       </div>
//     </div>
//   );
// };

// export default ContactJourneyModal;

// import React, { useEffect, useMemo, useState, Fragment } from "react";
// import { Dialog, Transition } from "@headlessui/react";
// import axiosClient from "../../../api/axiosClient";
// import {
//   Send,
//   MousePointerClick,
//   Hourglass,
//   CheckCircle2,
//   Eye,
//   Share2,
//   Link2,
//   Copy,
//   Filter,
//   X,
// } from "lucide-react";

// const formatDate = dt => (dt ? new Date(dt).toLocaleString() : "N/A");

// const relTime = iso => {
//   if (!iso) return "";
//   const diff = Date.now() - new Date(iso).getTime();
//   const abs = Math.abs(diff);
//   const mins = Math.floor(abs / (60 * 1000));
//   if (mins < 1) return "just now";
//   if (mins < 60) return `${mins}m ${diff < 0 ? "from now" : "ago"}`;
//   const hrs = Math.floor(mins / 60);
//   if (hrs < 24) return `${hrs}h ${diff < 0 ? "from now" : "ago"}`;
//   const days = Math.floor(hrs / 24);
//   return `${days}d ${diff < 0 ? "from now" : "ago"}`;
// };

// const displayUrl = raw => {
//   try {
//     const u = new URL(raw);
//     const tail =
//       u.pathname.length > 1 ? u.pathname.split("/").slice(-1)[0] : "";
//     return `${u.hostname}${tail ? `/${tail}` : ""}`;
//   } catch {
//     return raw?.slice(0, 60) || "";
//   }
// };

// const extractNumber = val => {
//   if (!val) return null;
//   const m = String(val).match(/(\+?\d[\d\s-]{5,}\d)/);
//   return m ? m[1].replace(/[\s-]/g, "") : null;
// };

// const ICONS = {
//   MessageSent: <Send size={16} className="text-white" />,
//   Delivered: <CheckCircle2 size={16} className="text-white" />,
//   Read: <Eye size={16} className="text-white" />,
//   ButtonClicked: <MousePointerClick size={16} className="text-white" />,
//   FlowSend: <Send size={16} className="text-white" />,
//   Redirect: <Share2 size={16} className="text-white" />,
// };

// const COLORS = {
//   MessageSent: "bg-blue-500",
//   Delivered: "bg-emerald-500",
//   Read: "bg-cyan-500",
//   ButtonClicked: "bg-green-500",
//   FlowSend: "bg-indigo-500",
//   Redirect: "bg-amber-500",
// };

// const isClickEvent = t => t === "ButtonClicked" || t === "Redirect";
// const isMessageEvent = t =>
//   t === "MessageSent" || t === "Delivered" || t === "Read" || t === "FlowSend";

// function ContactJourneyModal({ isOpen, onClose, log }) {
//   const [journey, setJourney] = useState({ events: [] });
//   const [loading, setLoading] = useState(false);
//   const [filter, setFilter] = useState("all");
//   const [expanded, setExpanded] = useState(false);

//   const displayPhone =
//     log?.recipientNumber ||
//     log?.contactPhone ||
//     log?.to ||
//     extractNumber(log?.contactName) ||
//     "Unknown";

//   useEffect(() => {
//     if (isOpen && log?.id) {
//       (async () => {
//         setLoading(true);
//         try {
//           const res = await axiosClient.get(`/tracking/journeys/${log.id}`);
//           const data = res.data;
//           if (Array.isArray(data)) setJourney({ events: data });
//           else setJourney(data || { events: [] });
//         } catch (e) {
//           console.error("Failed to fetch contact journey", e);
//           setJourney({ events: [] });
//         } finally {
//           setLoading(false);
//         }
//       })();
//     }
//   }, [isOpen, log]);

//   useEffect(() => {
//     if (isOpen) setExpanded(false);
//   }, [isOpen]);

//   const typeBadge =
//     journey.campaignType === "flow" ? (
//       <span className="ml-2 inline-flex items-center px-2 py-0.5 rounded bg-emerald-100 text-emerald-700 text-xs font-semibold">
//         Flow
//       </span>
//     ) : (
//       <span className="ml-2 inline-flex items-center px-2 py-0.5 rounded bg-blue-100 text-blue-700 text-xs font-semibold">
//         Dynamic URL
//       </span>
//     );

//   const eventsFiltered = useMemo(() => {
//     const all = journey?.events || [];
//     if (filter === "messages")
//       return all.filter(e => isMessageEvent(e.eventType));
//     if (filter === "clicks") return all.filter(e => isClickEvent(e.eventType));
//     return all;
//   }, [journey, filter]);

//   const COLLAPSE_AFTER = 6;
//   const eventsVisible =
//     expanded || eventsFiltered.length <= COLLAPSE_AFTER
//       ? eventsFiltered
//       : eventsFiltered.slice(0, COLLAPSE_AFTER);

//   const leftOff = journey?.leftOffAt;

//   return (
//     <Transition appear show={isOpen} as={Fragment}>
//       <Dialog as="div" className="relative z-50" onClose={onClose}>
//         <Transition.Child
//           as={Fragment}
//           enter="ease-out duration-300"
//           enterFrom="opacity-0"
//           enterTo="opacity-100"
//           leave="ease-in duration-200"
//           leaveFrom="opacity-100"
//           leaveTo="opacity-0"
//         >
//           <div className="fixed inset-0 bg-black/40" />
//         </Transition.Child>

//         <div className="fixed inset-0 overflow-y-hidden">
//           <div className="flex items-center justify-center min-h-full p-4">
//             <Transition.Child
//               as={Fragment}
//               enter="ease-out duration-300"
//               enterFrom="opacity-0 scale-95"
//               enterTo="opacity-100 scale-100"
//               leave="ease-in duration-200"
//               leaveFrom="opacity-100 scale-100"
//               leaveTo="opacity-0 scale-95"
//             >
//               <Dialog.Panel className="w-full max-w-2xl flex flex-col max-h-[85vh] transform overflow-hidden rounded-xl bg-white shadow-xl transition-all">
//                 {/* Header */}
//                 <Dialog.Title className="sticky top-0 z-10 bg-white/70 backdrop-blur px-6 pt-6 pb-2 text-base font-semibold text-gray-800 flex items-center gap-2 border-b border-gray-200">
//                   <span className="text-purple-600">üß≠</span>
//                   Contact Journey for {displayPhone}
//                   {typeBadge}
//                   <div className="ml-auto flex items-center gap-2">
//                     <Filter size={16} className="text-gray-400" />
//                     <div className="inline-flex rounded-lg border overflow-hidden">
//                       <button
//                         className={`px-2 py-1 text-xs ${
//                           filter === "all"
//                             ? "bg-gray-900 text-white"
//                             : "bg-white"
//                         }`}
//                         onClick={() => setFilter("all")}
//                       >
//                         All
//                       </button>
//                       <button
//                         className={`px-2 py-1 text-xs border-l ${
//                           filter === "messages"
//                             ? "bg-gray-900 text-white"
//                             : "bg-white"
//                         }`}
//                         onClick={() => setFilter("messages")}
//                       >
//                         Messages
//                       </button>
//                       <button
//                         className={`px-2 py-1 text-xs border-l ${
//                           filter === "clicks"
//                             ? "bg-gray-900 text-white"
//                             : "bg-white"
//                         }`}
//                         onClick={() => setFilter("clicks")}
//                       >
//                         Clicks
//                       </button>
//                     </div>
//                     <button
//                       onClick={onClose}
//                       className="ml-2 inline-flex items-center justify-center rounded-lg p-2 hover:bg-gray-100"
//                       aria-label="Close"
//                     >
//                       <X size={16} />
//                     </button>
//                   </div>
//                 </Dialog.Title>

//                 {/* Body */}
//                 <div className="flex-grow overflow-y-auto px-6">
//                   {loading ? (
//                     <p className="text-center text-gray-500 py-8">
//                       Loading journey...
//                     </p>
//                   ) : (eventsFiltered.length || 0) > 0 ? (
//                     <>
//                       {leftOff && (
//                         <div className="mt-3 mb-2 text-xs text-gray-600">
//                           <span className="inline-flex items-center gap-1 rounded-full bg-amber-50 text-amber-700 px-2 py-1 font-semibold">
//                             Left off at:
//                             <span className="text-amber-900">{leftOff}</span>
//                             {journey.flowName ? (
//                               <span className="text-amber-700">
//                                 &nbsp;in{" "}
//                                 <span className="font-bold">
//                                   {journey.flowName}
//                                 </span>
//                               </span>
//                             ) : null}
//                           </span>
//                         </div>
//                       )}

//                       <div className="relative ml-3 py-3">
//                         <div className="absolute left-0 top-0 bottom-0 w-px bg-slate-200" />
//                         <div className="space-y-3">
//                           {eventsVisible.map((event, idx) => (
//                             <JourneyEvent
//                               key={idx}
//                               isCurrent={
//                                 leftOff && event?.title?.includes(leftOff)
//                               }
//                               event={event}
//                             />
//                           ))}
//                         </div>
//                       </div>

//                       {eventsFiltered.length > COLLAPSE_AFTER && (
//                         <div className="flex justify-center pt-2 pb-4">
//                           <button
//                             onClick={() => setExpanded(v => !v)}
//                             className="text-sm font-semibold text-purple-700 hover:text-purple-800"
//                           >
//                             {expanded
//                               ? "Show less"
//                               : `Show ${
//                                   eventsFiltered.length - COLLAPSE_AFTER
//                                 } more events`}
//                           </button>
//                         </div>
//                       )}
//                     </>
//                   ) : (
//                     <p className="text-center text-gray-500 py-8">
//                       No journey events found for this message.
//                     </p>
//                   )}
//                 </div>

//                 {/* Footer */}
//                 <div className="flex-shrink-0 px-6 pt-2 pb-4 flex justify-end gap-3 border-t border-gray-200">
//                   <button
//                     onClick={onClose}
//                     className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-sm font-semibold"
//                   >
//                     Close
//                   </button>
//                 </div>
//               </Dialog.Panel>
//             </Transition.Child>
//           </div>
//         </div>
//       </Dialog>
//     </Transition>
//   );
// }

// const JourneyEvent = ({ event, isCurrent }) => {
//   const icon = ICONS[event.eventType] || (
//     <Hourglass size={16} className="text-white" />
//   );
//   const color = COLORS[event.eventType] || "bg-gray-400";

//   const handleCopy = () => {
//     if (event.url) {
//       navigator.clipboard?.writeText(event.url);
//     }
//   };

//   const isClickable = Boolean(event.url);
//   const shouldShowDetails = !(
//     event.eventType === "ButtonClicked" || event.eventType === "Redirect"
//   );

//   return (
//     <div className="relative pl-6">
//       <div
//         className={`absolute -left-3 top-1 w-6 h-6 rounded-full flex items-center justify-center ring-4 ring-white ${color} ${
//           isCurrent ? "scale-110 shadow-lg" : ""
//         }`}
//       >
//         {icon}
//       </div>

//       <div
//         className={`rounded-lg p-1.5 ${
//           isCurrent ? "bg-amber-50 border border-amber-200" : "bg-white"
//         }`}
//       >
//         <p className="font-semibold text-gray-800">{event.title}</p>

//         {shouldShowDetails && event.details && (
//           <p className="text-sm text-gray-600 break-words">{event.details}</p>
//         )}

//         {isClickable && (
//           <p className="mt-1">
//             <a
//               className="inline-flex items-center gap-1 text-blue-700 underline underline-offset-2"
//               href={event.url}
//               target="_blank"
//               rel="noreferrer"
//               title={event.url}
//             >
//               <Link2 size={14} />
//               {displayUrl(event.url)}
//             </a>
//             <button
//               onClick={handleCopy}
//               className="ml-2 inline-flex items-center gap-1 text-gray-500 hover:text-gray-700"
//               title="Copy URL"
//             >
//               <Copy size={14} />
//               <span className="text-xs">Copy</span>
//             </button>
//           </p>
//         )}

//         <p className="text-xs text-gray-400 mt-1">
//           {formatDate(event.timestamp)} ‚Ä¢ {relTime(event.timestamp)}
//         </p>
//       </div>
//     </div>
//   );
// };

// export default ContactJourneyModal;
// üìÑ src/pages/campaigns/components/ContactJourneyModal.jsx
import React, { useEffect, useMemo, useState, Fragment } from "react";
import { Dialog, Transition } from "@headlessui/react";
import axiosClient from "../../../api/axiosClient";
import { toast } from "react-toastify";
import {
  Send,
  MousePointerClick,
  Hourglass,
  CheckCircle2,
  Eye,
  Share2,
  Link2,
  Copy,
  Filter,
  X,
} from "lucide-react";

const formatDate = dt => (dt ? new Date(dt).toLocaleString() : "N/A");

const relTime = iso => {
  if (!iso) return "";
  const diff = Date.now() - new Date(iso).getTime();
  const abs = Math.abs(diff);
  const mins = Math.floor(abs / (60 * 1000));
  if (mins < 1) return "just now";
  if (mins < 60) return `${mins}m ${diff < 0 ? "from now" : "ago"}`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}h ${diff < 0 ? "from now" : "ago"}`;
  const days = Math.floor(hrs / 24);
  return `${days}d ${diff < 0 ? "from now" : "ago"}`;
};

const displayUrl = raw => {
  try {
    const u = new URL(raw);
    const tail =
      u.pathname.length > 1 ? u.pathname.split("/").slice(-1)[0] : "";
    return `${u.hostname}${tail ? `/${tail}` : ""}`;
  } catch {
    return raw?.slice(0, 60) || "";
  }
};

/** Pull a phone-like token out of free text (e.g. "WhatsApp User (+91 987...)"). */
const extractNumberLoose = val => {
  if (!val) return null;
  const m = String(val).match(/(\+?\d[\d\s\-()]{5,}\d)/);
  return m ? m[1] : null;
};

/** Normalize for display as E.164-like: keep leading "+", strip other non-digits; if no "+", prepend it. */
const normalizeE164 = raw => {
  if (!raw) return "";
  let s = String(raw).trim();
  const hasPlus = s.startsWith("+");
  s = (hasPlus ? "+" : "") + s.replace(/[^\d]/g, "");
  if (!s.startsWith("+")) s = "+" + s;
  return s;
};

const ICONS = {
  MessageSent: <Send size={16} className="text-white" />,
  Delivered: <CheckCircle2 size={16} className="text-white" />,
  Read: <Eye size={16} className="text-white" />,
  ButtonClicked: <MousePointerClick size={16} className="text-white" />,
  FlowSend: <Send size={16} className="text-white" />,
  Redirect: <Share2 size={16} className="text-white" />,
};

const COLORS = {
  MessageSent: "bg-blue-500",
  Delivered: "bg-emerald-500",
  Read: "bg-cyan-500",
  ButtonClicked: "bg-green-500",
  FlowSend: "bg-indigo-500",
  Redirect: "bg-amber-500",
};

const isClickEvent = t => t === "ButtonClicked" || t === "Redirect";
const isMessageEvent = t =>
  t === "MessageSent" || t === "Delivered" || t === "Read" || t === "FlowSend";

function ContactJourneyModal({ isOpen, onClose, log }) {
  const [journey, setJourney] = useState({ events: [] });
  const [loading, setLoading] = useState(false);
  const [filter, setFilter] = useState("all");
  const [expanded, setExpanded] = useState(false);
  const [errorText, setErrorText] = useState("");

  // Prefer backend-resolved phone, then log fields, then loose extraction; finally normalize to +E.164 for display.
  const rawPhoneCandidate =
    journey?.contactPhone ||
    log?.recipientNumber ||
    log?.contactPhone ||
    log?.to ||
    extractNumberLoose(log?.contactName) ||
    "";
  const displayPhone = normalizeE164(rawPhoneCandidate) || "Unknown";

  useEffect(() => {
    if (!isOpen || !log) return;

    // Prefer CampaignSendLogId (audience uploads), fall back to id
    const cslId = log.campaignSendLogId || log.id;
    if (!cslId) return;

    (async () => {
      setLoading(true);
      setErrorText("");
      try {
        const res = await axiosClient.get(`/tracking/journeys/${cslId}`);
        const data = res.data;
        setJourney(
          Array.isArray(data) ? { events: data } : data || { events: [] }
        );
      } catch (err) {
        const raw =
          err?.response?.data?.message ||
          err?.response?.data?.title ||
          err?.message ||
          "";
        const isEmptyProjection =
          typeof raw === "string" &&
          raw.toLowerCase().includes("emptyprojectionmember");

        if (isEmptyProjection) {
          console.warn("[Journey] Backend EF error:", raw);
          setErrorText(
            "Journey data is temporarily unavailable. Please try again after a refresh."
          );
        } else {
          setErrorText(raw || "Failed to fetch contact journey.");
          toast.error(`üö® ${raw || "Failed to fetch contact journey"}`);
        }
        setJourney({ events: [] });
      } finally {
        setLoading(false);
      }
    })();
  }, [isOpen, log]);

  useEffect(() => {
    if (isOpen) setExpanded(false);
  }, [isOpen]);

  const typeBadge =
    journey.campaignType === "flow" ? (
      <span className="ml-2 inline-flex items-center px-2 py-0.5 rounded bg-emerald-100 text-emerald-700 text-xs font-semibold">
        Flow
      </span>
    ) : (
      <span className="ml-2 inline-flex items-center px-2 py-0.5 rounded bg-blue-100 text-blue-700 text-xs font-semibold">
        Dynamic URL
      </span>
    );

  const eventsFiltered = useMemo(() => {
    const all = journey?.events || [];
    if (filter === "messages")
      return all.filter(e => isMessageEvent(e.eventType));
    if (filter === "clicks") return all.filter(e => isClickEvent(e.eventType));
    return all;
  }, [journey, filter]);

  const COLLAPSE_AFTER = 6;
  const eventsVisible =
    expanded || eventsFiltered.length <= COLLAPSE_AFTER
      ? eventsFiltered
      : eventsFiltered.slice(0, COLLAPSE_AFTER);

  const leftOff = journey?.leftOffAt;

  return (
    <Transition appear show={isOpen} as={Fragment}>
      <Dialog as="div" className="relative z-50" onClose={onClose}>
        <Transition.Child
          as={Fragment}
          enter="ease-out duration-300"
          enterFrom="opacity-0"
          enterTo="opacity-100"
          leave="ease-in duration-200"
          leaveFrom="opacity-100"
          leaveTo="opacity-0"
        >
          <div className="fixed inset-0 bg-black/40" />
        </Transition.Child>

        <div className="fixed inset-0 overflow-y-hidden">
          <div className="flex items-center justify-center min-h-full p-4">
            <Transition.Child
              as={Fragment}
              enter="ease-out duration-300"
              enterFrom="opacity-0 scale-95"
              enterTo="opacity-100 scale-100"
              leave="ease-in duration-200"
              leaveFrom="opacity-100 scale-100"
              leaveTo="opacity-0 scale-95"
            >
              <Dialog.Panel className="w-full max-w-2xl flex flex-col max-h-[85vh] transform overflow-hidden rounded-xl bg-white shadow-xl transition-all">
                {/* Header */}
                <Dialog.Title className="sticky top-0 z-10 bg-white/70 backdrop-blur px-6 pt-6 pb-2 text-base font-semibold text-gray-800 flex items-center gap-2 border-b border-gray-200">
                  <span className="text-purple-600">üß≠</span>
                  Contact Journey for {displayPhone}
                  {typeBadge}
                  <div className="ml-auto flex items-center gap-2">
                    <Filter size={16} className="text-gray-400" />
                    <div className="inline-flex rounded-lg border overflow-hidden">
                      <button
                        className={`px-2 py-1 text-xs ${
                          filter === "all"
                            ? "bg-gray-900 text-white"
                            : "bg-white"
                        }`}
                        onClick={() => setFilter("all")}
                      >
                        All
                      </button>
                      <button
                        className={`px-2 py-1 text-xs border-l ${
                          filter === "messages"
                            ? "bg-gray-900 text-white"
                            : "bg-white"
                        }`}
                        onClick={() => setFilter("messages")}
                      >
                        Messages
                      </button>
                      <button
                        className={`px-2 py-1 text-xs border-l ${
                          filter === "clicks"
                            ? "bg-gray-900 text-white"
                            : "bg-white"
                        }`}
                        onClick={() => setFilter("clicks")}
                      >
                        Clicks
                      </button>
                    </div>
                    <button
                      onClick={onClose}
                      className="ml-2 inline-flex items-center justify-center rounded-lg p-2 hover:bg-gray-100"
                      aria-label="Close"
                    >
                      <X size={16} />
                    </button>
                  </div>
                </Dialog.Title>

                {/* Body */}
                <div className="flex-grow overflow-y-auto px-6">
                  {loading ? (
                    <p className="text-center text-gray-500 py-8">
                      Loading journey...
                    </p>
                  ) : errorText ? (
                    <div className="py-8">
                      <p className="text-center text-amber-700 bg-amber-50 border border-amber-200 rounded p-3 text-sm">
                        {errorText}
                      </p>
                    </div>
                  ) : (eventsFiltered.length || 0) > 0 ? (
                    <>
                      {leftOff && (
                        <div className="mt-3 mb-2 text-xs text-gray-600">
                          <span className="inline-flex items-center gap-1 rounded-full bg-amber-50 text-amber-700 px-2 py-1 font-semibold">
                            Left off at:{" "}
                            <span className="text-amber-900">{leftOff}</span>
                            {journey.flowName ? (
                              <span className="text-amber-700">
                                &nbsp;in{" "}
                                <span className="font-bold">
                                  {journey.flowName}
                                </span>
                              </span>
                            ) : null}
                          </span>
                        </div>
                      )}

                      <div className="relative ml-3 py-3">
                        <div className="absolute left-0 top-0 bottom-0 w-px bg-slate-200" />
                        <div className="space-y-3">
                          {eventsVisible.map((event, idx) => (
                            <JourneyEvent
                              key={idx}
                              isCurrent={
                                leftOff && event?.title?.includes(leftOff)
                              }
                              event={event}
                            />
                          ))}
                        </div>
                      </div>

                      {eventsFiltered.length > COLLAPSE_AFTER && (
                        <div className="flex justify-center pt-2 pb-4">
                          <button
                            onClick={() => setExpanded(v => !v)}
                            className="text-sm font-semibold text-purple-700 hover:text-purple-800"
                          >
                            {expanded
                              ? "Show less"
                              : `Show ${
                                  eventsFiltered.length - COLLAPSE_AFTER
                                } more events`}
                          </button>
                        </div>
                      )}
                    </>
                  ) : (
                    <p className="text-center text-gray-500 py-8">
                      No journey events found for this message.
                    </p>
                  )}
                </div>

                {/* Footer */}
                <div className="flex-shrink-0 px-6 pt-2 pb-4 flex justify-end gap-3 border-t border-gray-200">
                  <button
                    onClick={onClose}
                    className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-sm font-semibold"
                  >
                    Close
                  </button>
                </div>
              </Dialog.Panel>
            </Transition.Child>
          </div>
        </div>
      </Dialog>
    </Transition>
  );
}

const JourneyEvent = ({ event, isCurrent }) => {
  const icon = ICONS[event.eventType] || (
    <Hourglass size={16} className="text-white" />
  );
  const color = COLORS[event.eventType] || "bg-gray-400";

  const handleCopy = () => {
    if (event.url) navigator.clipboard?.writeText(event.url);
  };

  const isClickable = Boolean(event.url);
  const shouldShowDetails = !(
    event.eventType === "ButtonClicked" || event.eventType === "Redirect"
  );

  return (
    <div className="relative pl-6">
      <div
        className={`absolute -left-3 top-1 w-6 h-6 rounded-full flex items-center justify-center ring-4 ring-white ${color} ${
          isCurrent ? "scale-110 shadow-lg" : ""
        }`}
      >
        {icon}
      </div>

      <div
        className={`rounded-lg p-1.5 ${
          isCurrent ? "bg-amber-50 border border-amber-200" : "bg-white"
        }`}
      >
        <p className="font-semibold text-gray-800">{event.title}</p>

        {shouldShowDetails && event.details && (
          <p className="text-sm text-gray-600 break-words">{event.details}</p>
        )}

        {isClickable && (
          <p className="mt-1">
            <a
              className="inline-flex items-center gap-1 text-blue-700 underline underline-offset-2"
              href={event.url}
              target="_blank"
              rel="noreferrer"
              title={event.url}
            >
              <Link2 size={14} />
              {displayUrl(event.url)}
            </a>
            <button
              onClick={handleCopy}
              className="ml-2 inline-flex items-center gap-1 text-gray-500 hover:text-gray-700"
              title="Copy URL"
            >
              <Copy size={14} />
              <span className="text-xs">Copy</span>
            </button>
          </p>
        )}

        <p className="text-xs text-gray-400 mt-1">
          {formatDate(event.timestamp)} ‚Ä¢ {relTime(event.timestamp)}
        </p>
      </div>
    </div>
  );
};

export default ContactJourneyModal;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\components\ContactSelector.jsx 
====================================================== 
 
import React, { useEffect, useState, useCallback } from "react";
import axiosClient from "../../../api/axiosClient";
import { toast } from "react-toastify";
import Papa from "papaparse";
import TagFilterDropdown from "./TagFilterDropdown";

function ContactSelector({ selectedIds, onChange }) {
  const [contacts, setContacts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [tagFilter, setTagFilter] = useState([]);
  const [searchTerm, setSearchTerm] = useState("");
  const [importedContacts, setImportedContacts] = useState([]);
  const [showImportModal, setShowImportModal] = useState(false);

  // 1. Wrap loadContacts in useCallback so its reference is stable
  const loadContacts = useCallback(async () => {
    setLoading(true);
    try {
      let res;
      if (tagFilter.length > 0) {
        res = await axiosClient.post("/contacts/filter-by-tags", tagFilter);
        setContacts(res.data?.data || []);
      } else {
        res = await axiosClient.get("/contacts", {
          params: {
            tab: "all",
            page: 1,
            pageSize: 1000,
          },
        });
        setContacts(res.data?.data?.items || []);
      }
    } catch (err) {
      toast.error("Failed to load contacts");
    } finally {
      setLoading(false);
    }
  }, [tagFilter]); // Add tagFilter as dependency (it's used inside)

  // 2. Add loadContacts to dependency array
  useEffect(() => {
    loadContacts();
  }, [loadContacts]);

  const handleToggle = id => {
    const newSelected = selectedIds.includes(id)
      ? selectedIds.filter(cid => cid !== id)
      : [...selectedIds, id];
    onChange(newSelected);
  };

  const handleFileUpload = e => {
    const file = e.target.files[0];
    if (!file) return;

    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: function (results) {
        const parsed = results.data.map(row => ({
          id: crypto.randomUUID(),
          name: row.name || "Unnamed",
          phone: row.phone || "",
        }));
        setImportedContacts(parsed);
        setShowImportModal(true);
      },
      error: function () {
        toast.error("CSV Parsing Failed");
      },
    });
  };

  const confirmImport = () => {
    setContacts(prev => [...prev, ...importedContacts]);
    const allIds = importedContacts.map(c => c.id);
    onChange([...selectedIds, ...allIds]);
    setShowImportModal(false);
    toast.success("Contacts imported successfully");
  };

  const filteredContacts = contacts.filter(
    c =>
      c.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      c.phone?.includes(searchTerm)
  );

  if (loading) return <p>‚è≥ Loading contacts...</p>;

  return (
    <div className="space-y-4">
      {/* üîç Search + Tag Filter + CSV Import */}
      <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <input
          type="text"
          placeholder="Search by name or phone"
          value={searchTerm}
          onChange={e => setSearchTerm(e.target.value)}
          className="w-full sm:w-1/2 px-3 py-2 rounded-md border"
        />

        <TagFilterDropdown
          selectedTags={tagFilter}
          onChange={setTagFilter}
          category="Interest"
        />

        <label className="cursor-pointer text-purple-600 hover:underline text-sm sm:ml-4">
          Import CSV
          <input
            type="file"
            accept=".csv"
            onChange={handleFileUpload}
            className="hidden"
          />
        </label>
      </div>

      {/* üîò Contact List */}
      {filteredContacts.length === 0 ? (
        <p className="text-gray-500">‚ö†Ô∏è No matching contacts found.</p>
      ) : (
        filteredContacts.map(contact => (
          <label
            key={contact.id}
            className="flex flex-col sm:flex-row items-start sm:items-center gap-1 sm:gap-2 text-sm text-gray-700 border-b py-1"
          >
            <div className="flex items-center gap-2">
              <input
                type="checkbox"
                checked={selectedIds.includes(contact.id)}
                onChange={() => handleToggle(contact.id)}
              />
              <span>
                {contact.name} ‚Äî{" "}
                <span className="text-gray-500">
                  {contact.phoneNumber || contact.phone || "‚Äî"}
                </span>
              </span>
            </div>
            {/* üé® Tag Chips */}
            <div className="flex flex-wrap gap-1 ml-6">
              {contact.tags?.map(tag => (
                <span
                  key={tag.tagId}
                  className="text-xs px-2 py-0.5 rounded-full"
                  style={{
                    backgroundColor: tag.colorHex || "#E5E7EB",
                    color: "#000",
                  }}
                >
                  {tag.tagName}
                </span>
              ))}
            </div>
          </label>
        ))
      )}

      {/* üì¶ Preview Import Modal */}
      {showImportModal && (
        <div className="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 className="text-lg font-bold mb-4">
              Preview Imported Contacts
            </h2>
            <div className="max-h-60 overflow-auto space-y-2">
              {importedContacts.map((c, idx) => (
                <div key={idx} className="text-sm border-b py-1">
                  <strong>{c.name}</strong> ‚Äî {c.phone}
                </div>
              ))}
            </div>
            <div className="flex justify-end mt-4 gap-4">
              <button
                className="text-gray-600 hover:underline"
                onClick={() => setShowImportModal(false)}
              >
                Cancel
              </button>
              <button
                className="bg-purple-600 text-white px-4 py-2 rounded-md"
                onClick={confirmImport}
              >
                Import & Select
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

export default ContactSelector;

// import React, { useEffect, useState } from "react";
// import axiosClient from "../../../api/axiosClient";
// import { toast } from "react-toastify";
// import Papa from "papaparse";
// import TagFilterDropdown from "./TagFilterDropdown";

// function ContactSelector({ selectedIds, onChange }) {
//   const [contacts, setContacts] = useState([]);
//   const [loading, setLoading] = useState(true);
//   const [tagFilter, setTagFilter] = useState([]);
//   const [searchTerm, setSearchTerm] = useState("");
//   const [importedContacts, setImportedContacts] = useState([]);
//   const [showImportModal, setShowImportModal] = useState(false);

//   useEffect(() => {
//     loadContacts();
//   }, [tagFilter]);

//   const loadContacts = async () => {
//     setLoading(true);
//     try {
//       let res;
//       if (tagFilter.length > 0) {
//         res = await axiosClient.post("/contacts/filter-by-tags", tagFilter);
//         setContacts(res.data?.data || []);
//       } else {
//         res = await axiosClient.get("/contacts", {
//           params: {
//             tab: "all",
//             page: 1,
//             pageSize: 1000,
//           },
//         });
//         setContacts(res.data?.data?.items || []);
//       }
//     } catch (err) {
//       toast.error("Failed to load contacts");
//     } finally {
//       setLoading(false);
//     }
//   };

//   const handleToggle = id => {
//     const newSelected = selectedIds.includes(id)
//       ? selectedIds.filter(cid => cid !== id)
//       : [...selectedIds, id];
//     onChange(newSelected);
//   };

//   const handleFileUpload = e => {
//     const file = e.target.files[0];
//     if (!file) return;

//     Papa.parse(file, {
//       header: true,
//       skipEmptyLines: true,
//       complete: function (results) {
//         const parsed = results.data.map(row => ({
//           id: crypto.randomUUID(),
//           name: row.name || "Unnamed",
//           phone: row.phone || "",
//         }));
//         setImportedContacts(parsed);
//         setShowImportModal(true);
//       },
//       error: function () {
//         toast.error("CSV Parsing Failed");
//       },
//     });
//   };

//   const confirmImport = () => {
//     setContacts(prev => [...prev, ...importedContacts]);
//     const allIds = importedContacts.map(c => c.id);
//     onChange([...selectedIds, ...allIds]);
//     setShowImportModal(false);
//     toast.success("Contacts imported successfully");
//   };

//   const filteredContacts = contacts.filter(
//     c =>
//       c.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
//       c.phone?.includes(searchTerm)
//   );

//   if (loading) return <p>‚è≥ Loading contacts...</p>;

//   return (
//     <div className="space-y-4">
//       {/* üîç Search + Tag Filter + CSV Import */}
//       <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
//         <input
//           type="text"
//           placeholder="Search by name or phone"
//           value={searchTerm}
//           onChange={e => setSearchTerm(e.target.value)}
//           className="w-full sm:w-1/2 px-3 py-2 rounded-md border"
//         />

//         <TagFilterDropdown
//           selectedTags={tagFilter}
//           onChange={setTagFilter}
//           category="Interest"
//         />

//         <label className="cursor-pointer text-purple-600 hover:underline text-sm sm:ml-4">
//           Import CSV
//           <input
//             type="file"
//             accept=".csv"
//             onChange={handleFileUpload}
//             className="hidden"
//           />
//         </label>
//       </div>

//       {/* üîò Contact List */}
//       {filteredContacts.length === 0 ? (
//         <p className="text-gray-500">‚ö†Ô∏è No matching contacts found.</p>
//       ) : (
//         filteredContacts.map(contact => (
//           <label
//             key={contact.id}
//             className="flex flex-col sm:flex-row items-start sm:items-center gap-1 sm:gap-2 text-sm text-gray-700 border-b py-1"
//           >
//             <div className="flex items-center gap-2">
//               <input
//                 type="checkbox"
//                 checked={selectedIds.includes(contact.id)}
//                 onChange={() => handleToggle(contact.id)}
//               />
//               <span>
//                 {contact.name} ‚Äî{" "}
//                 <span className="text-gray-500">
//                   {contact.phoneNumber || contact.phone || "‚Äî"}
//                 </span>
//               </span>
//             </div>
//             {/* üé® Tag Chips */}
//             <div className="flex flex-wrap gap-1 ml-6">
//               {contact.tags?.map(tag => (
//                 <span
//                   key={tag.tagId}
//                   className="text-xs px-2 py-0.5 rounded-full"
//                   style={{
//                     backgroundColor: tag.colorHex || "#E5E7EB",
//                     color: "#000",
//                   }}
//                 >
//                   {tag.tagName}
//                 </span>
//               ))}
//             </div>
//           </label>
//         ))
//       )}

//       {/* üì¶ Preview Import Modal */}
//       {showImportModal && (
//         <div className="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
//           <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
//             <h2 className="text-lg font-bold mb-4">
//               Preview Imported Contacts
//             </h2>
//             <div className="max-h-60 overflow-auto space-y-2">
//               {importedContacts.map((c, idx) => (
//                 <div key={idx} className="text-sm border-b py-1">
//                   <strong>{c.name}</strong> ‚Äî {c.phone}
//                 </div>
//               ))}
//             </div>
//             <div className="flex justify-end mt-4 gap-4">
//               <button
//                 className="text-gray-600 hover:underline"
//                 onClick={() => setShowImportModal(false)}
//               >
//                 Cancel
//               </button>
//               <button
//                 className="bg-purple-600 text-white px-4 py-2 rounded-md"
//                 onClick={confirmImport}
//               >
//                 Import & Select
//               </button>
//             </div>
//           </div>
//         </div>
//       )}
//     </div>
//   );
// }

// export default ContactSelector;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\components\CsvAudienceSection.jsx 
====================================================== 
 
// src/pages/Campaigns/components/CsvAudienceSection.jsx
import React, { useEffect, useMemo, useRef, useState } from "react";
import { useNavigate } from "react-router-dom";
import { toast } from "react-toastify";
import {
  fetchCsvSchema,
  downloadCsvSampleBlob,
  uploadCsvBatch,
  getBatchSample,
  validateBatch,
  suggestMappings,
  saveMappings,
  materialize,
} from "../api/csvApi";

/* ---------------- Utilities ---------------- */

function saveBlob(blob, filename) {
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  window.URL.revokeObjectURL(url);
}

const norm = s =>
  String(s || "")
    .toLowerCase()
    .replace(/[\s._-]+/g, "")
    .replace(/[^a-z0-9]/g, "");

const PHONE_ALIASES = ["phone", "mobile", "whatsapp", "number", "phonee164"];

// Aliases to help auto-map
const ALIASES = {
  parameter1: ["param1", "body1"],
  parameter2: ["param2", "body2"],
  parameter3: ["param3", "body3"],
  parameter4: ["param4", "body4"],
  parameter5: ["param5", "body5"],
  headerpara1: ["header1", "headerparam1"],
  headerpara2: ["header2", "headerparam2"],
  headerpara3: ["header3", "headerparam3"],
  buttonpara1: ["btn1", "button1", "url1", "buttonparam1"],
  buttonpara2: ["btn2", "button2", "url2", "buttonparam2"],
  buttonpara3: ["btn3", "button3", "url3", "buttonparam3"],
};

// Auto-pick CSV columns for expected keys.
function autoPick(headers, wants) {
  const map = {};
  const used = new Set();
  const H = headers.map(h => ({ raw: h, k: norm(h) }));

  // 1) exact (case-insensitive)
  for (const key of wants) {
    const hit = headers.find(h => norm(h) === norm(key));
    if (hit) {
      map[key] = hit;
      used.add(hit);
    }
  }

  // 2) aliases
  for (const key of wants) {
    if (map[key]) continue;
    const aliases = ALIASES[key] || [];
    const hit = H.find(
      h => aliases.some(a => h.k === norm(a)) && !used.has(h.raw)
    );
    if (hit) {
      map[key] = hit.raw;
      used.add(hit.raw);
    }
  }

  // 3) parameterN convenience
  for (const key of wants) {
    if (map[key]) continue;
    const m = key.match(/^parameter(\d+)$/i);
    if (!m) continue;
    const n = m[1];
    const hit = H.find(
      h => (h.k === `param${n}` || h.k === `body${n}`) && !used.has(h.raw)
    );
    if (hit) {
      map[key] = hit.raw;
      used.add(hit.raw);
    }
  }

  return map;
}

/* ---------------- Component ---------------- */

export default function CsvAudienceSection({
  campaignId,
  audienceName: propAudienceName,
}) {
  const navigate = useNavigate();
  const [loading, setLoading] = useState(true);
  const [schema, setSchema] = useState(null);

  const [batch, setBatch] = useState(null);
  const [sample, setSample] = useState(null);
  const [valReq, setValReq] = useState({
    normalizePhone: true,
    checkDuplicates: true,
  });
  const [valRes, setValRes] = useState(null);

  // {{n}} mapping UI (body placeholders)
  const [paramMappings, setParamMappings] = useState([]);
  // Explicit mapping for headerparaN / buttonparaN
  const [expectedKeys, setExpectedKeys] = useState([]); // exactly as backend returns
  const [keyToColumn, setKeyToColumn] = useState({});

  const [phoneHeader, setPhoneHeader] = useState("");

  const [dryPreview, setDryPreview] = useState(null);
  const [persisting, setPersisting] = useState(false);

  const [showMapping, setShowMapping] = useState(false);
  const [isUploading, setIsUploading] = useState(false); // spinner flag
  const topRef = useRef(null);

  // Memo: deduped expected columns from server (server already includes "phone")
  const expectedColumns = useMemo(
    () => [...new Set(schema?.headers || [])],
    [schema]
  );

  // Effective audience name
  const effectiveAudienceName = useMemo(() => {
    const trimmed = String(propAudienceName || "").trim();
    if (trimmed) return trimmed;
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `Audience ${yyyy}-${mm}-${dd}`;
  }, [propAudienceName]);

  // Load schema
  useEffect(() => {
    let alive = true;
    (async () => {
      try {
        setLoading(true);
        const sc = await fetchCsvSchema(campaignId);
        if (!alive) return;
        setSchema(sc);

        const keys = Array.isArray(sc?.headers) ? sc.headers : [];
        setExpectedKeys(keys);

        const N = Number(sc?.placeholderCount || 0);
        setParamMappings(
          Array.from({ length: N }, (_, i) => ({
            index: i + 1,
            sourceType: "csv",
            sourceName: "",
            constValue: "",
          }))
        );
      } catch {
        toast.error("Failed to load CSV schema.");
      } finally {
        if (alive) setLoading(false);
      }
    })();
    return () => {
      alive = false;
    };
  }, [campaignId]);

  const csvHeaders = useMemo(
    () => sample?.headers ?? batch?.headerJson ?? expectedColumns,
    [expectedColumns, batch, sample]
  );

  const updateMapping = (idx, patch) =>
    setParamMappings(prev => {
      const next = [...prev];
      next[idx] = { ...next[idx], ...patch };
      return next;
    });

  const handleDownloadSample = async () => {
    try {
      const blob = await downloadCsvSampleBlob(campaignId);
      saveBlob(blob, `campaign-${campaignId}-sample.csv`);
    } catch {
      toast.error("Could not download sample CSV.");
    }
  };

  const handleFile = async f => {
    if (!f) return;
    setIsUploading(true);
    try {
      const up = await uploadCsvBatch(f, null);
      setBatch(up);
      toast.success("CSV uploaded.");

      const s = await getBatchSample(up?.batchId, 10);
      setSample(s);

      const hdrs = Array.isArray(s?.headers) ? s.headers : [];

      // Auto-pick phone column
      const lower = hdrs.map(h => String(h).toLowerCase());
      const guessIdx = lower.findIndex(h =>
        PHONE_ALIASES.some(k => h.includes(k))
      );
      setPhoneHeader(guessIdx >= 0 ? hdrs[guessIdx] : "");

      // Auto-map explicit keys
      const km = autoPick(hdrs, expectedKeys);
      setKeyToColumn(km);

      // Seed legacy body placeholders
      setParamMappings(prev =>
        prev.map(p => {
          const key = `parameter${p.index}`;
          return km[key] ? { ...p, sourceName: km[key] } : p;
        })
      );

      // Optional server suggestions
      try {
        const sugg = await suggestMappings(campaignId, up?.batchId);
        if (Array.isArray(sugg?.items)) {
          setParamMappings(prev =>
            prev.map(p => {
              const m = sugg.items.find(x => x.index === p.index);
              return m ? { ...p, ...m } : p;
            })
          );
        }
      } catch {}
      setShowMapping(false);
    } catch (e) {
      toast.error(e?.message || "CSV upload failed.");
    } finally {
      setIsUploading(false);
    }
  };

  const handleValidate = async () => {
    if (!batch?.batchId) return toast.warn("Upload a CSV first.");
    if (!phoneHeader) return toast.warn("Choose the phone column.");

    try {
      const req = {
        phoneHeader,
        requiredHeaders: [],
        normalizePhone: !!valReq.normalizePhone,
        checkDuplicates: !!valReq.checkDuplicates,
      };
      const res = await validateBatch(batch.batchId, req);
      setValRes(res);
      if (Array.isArray(res?.problems) && res.problems.length > 0) {
        toast.warn(`Validation found ${res.problems.length} issue(s).`);
      } else {
        toast.success("Validation passed.");
      }
    } catch {
      toast.error("Validation call failed.");
    }
  };

  // Build mapping dict
  const buildMappingDict = () => {
    const dict = {};
    for (const m of paramMappings) {
      const key = `parameter${m.index}`;
      dict[key] =
        m.sourceType === "csv"
          ? m.sourceName || ""
          : `constant:${m.constValue ?? ""}`;
    }
    for (const [k, v] of Object.entries(keyToColumn || {})) {
      if (!v) continue;
      if (/^parameter\d+$/i.test(k)) continue;
      dict[k] = v;
    }
    return dict;
  };

  const handleDryRun = async () => {
    if (!batch?.batchId) return toast.warn("Upload a CSV first.");
    try {
      await saveMappings(campaignId, buildMappingDict());
      const body = {
        csvBatchId: batch.batchId,
        mappings: buildMappingDict(),
        phoneField: phoneHeader || undefined,
        normalizePhones: !!valReq.normalizePhone,
        deduplicate: !!valReq.checkDuplicates,
        persist: false,
      };
      const preview = await materialize(campaignId, body);
      setDryPreview(preview);
      toast.success("Dry-run ready.");
    } catch {
      toast.error("Dry-run failed.");
    }
  };

  const handlePersist = async () => {
    if (!batch?.batchId) return toast.warn("Upload a CSV first.");
    const nameToUse = effectiveAudienceName;
    setPersisting(true);
    try {
      await saveMappings(campaignId, buildMappingDict());
      const body = {
        csvBatchId: batch.batchId,
        mappings: buildMappingDict(),
        phoneField: phoneHeader || undefined,
        normalizePhones: !!valReq.normalizePhone,
        deduplicate: !!valReq.checkDuplicates,
        persist: true,
        audienceName: nameToUse,
      };
      await materialize(campaignId, body);

      toast.success("Done!! Saved Successfully.");

      const target = "/app/campaigns/template-campaigns-list";
      try {
        navigate(target, { replace: true });
      } catch {
        if (typeof window !== "undefined") window.location.assign(target);
      }
    } catch {
      toast.error("Persist failed.");
    } finally {
      setPersisting(false);
    }
  };

  // Exclude "phone" and parameterN from non-body mapping keys
  const visibleKeys = useMemo(
    () =>
      (expectedKeys || []).filter(
        k => k.toLowerCase() !== "phone" && !/^parameter\d+$/i.test(k)
      ),
    [expectedKeys]
  );

  const mappingStatus = useMemo(() => {
    if (!visibleKeys.length) return { label: "No extra params", ok: true };
    const missing = visibleKeys.filter(k => !keyToColumn[k]);
    return missing.length
      ? { label: `${missing.length} missing`, ok: false }
      : { label: "All mapped", ok: true };
  }, [visibleKeys, keyToColumn]);

  if (loading) {
    return (
      <div className="rounded-lg border bg-white p-4 text-sm text-gray-500">
        Loading CSV schema‚Ä¶
      </div>
    );
  }

  return (
    <section ref={topRef} className="rounded-xl border bg-white p-4 shadow-sm">
      {/* Expected columns + actions */}
      <div className="mb-4 flex items-center gap-3 text-sm">
        <div className="text-purple-700 font-semibold">
          Required columns:&nbsp;
          <code className="nline-flex items-center gap-2 rounded-full border border-amber-200 bg-amber-50 px-3 py-1 text-amber-800">
            {expectedColumns.join(", ")}
          </code>
        </div>

        {/* Right-aligned paired buttons */}
        <div className="ml-auto flex items-center gap-2">
          <button
            type="button"
            onClick={handleDownloadSample}
            disabled={isUploading}
            className={`inline-flex items-center gap-2 rounded-lg border border-indigo-300 bg-white px-3 py-1.5 text-xs font-semibold shadow-sm transition focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 ${
              isUploading
                ? "cursor-not-allowed opacity-50 text-indigo-500"
                : "text-indigo-700 hover:bg-indigo-50"
            }`}
          >
            <svg
              aria-hidden="true"
              viewBox="0 0 24 24"
              className="h-4 w-4"
              fill="none"
              stroke="currentColor"
              strokeWidth="1.8"
              strokeLinecap="round"
              strokeLinejoin="round"
            >
              <path d="M12 3v12" />
              <path d="m8 11 4 4 4-4" />
              <path d="M5 21h14" />
            </svg>
            Download sample CSV
          </button>

          <div>
            <input
              id="csv-file-input"
              type="file"
              accept=".csv"
              onChange={e => {
                const f = e.target.files?.[0];
                handleFile(f);
                e.target.value = ""; // allow re-selecting the same file
              }}
              className="sr-only"
              disabled={isUploading}
            />
            <label
              htmlFor="csv-file-input"
              aria-disabled={isUploading}
              className={`inline-flex items-center gap-2 rounded-lg border border-indigo-300 bg-white px-3 py-1.5 text-xs font-semibold shadow-sm transition focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 ${
                isUploading
                  ? "pointer-events-none opacity-50 text-indigo-500"
                  : "text-indigo-700 hover:bg-indigo-50"
              }`}
            >
              {isUploading ? (
                <svg
                  aria-hidden="true"
                  viewBox="0 0 24 24"
                  className="h-4 w-4 animate-spin"
                  fill="none"
                  stroke="currentColor"
                  strokeWidth="2"
                >
                  <circle cx="12" cy="12" r="9" className="opacity-25" />
                  <path d="M21 12a9 9 0 0 1-9 9" className="opacity-75" />
                </svg>
              ) : (
                <svg
                  aria-hidden="true"
                  viewBox="0 0 24 24"
                  className="h-4 w-4"
                  fill="none"
                  stroke="currentColor"
                  strokeWidth="1.8"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                >
                  <path d="M16 16.5a4 4 0 0 0-1-7.9 5 5 0 0 0-9.8 1.2 3.5 3.5 0 0 0 .7 6.9h2" />
                  <path d="M12 12v8" />
                  <path d="m8.5 15.5 3.5-3.5 3.5 3.5" />
                </svg>
              )}
              {isUploading ? "Uploading‚Ä¶" : "Upload CSV"}
            </label>
          </div>
        </div>
      </div>

      {/* Helper note */}
      <div className="mb-3 rounded-md border border-dashed border-gray-200 bg-gray-50 p-2 text-[11px] text-gray-600">
        We set any media URL once at <strong>campaign creation</strong> (not in
        CSV). Your CSV should contain <code>phone</code>, body values as{" "}
        <code>parameter1‚Ä¶N</code>, plus any <code>headerparaN</code> and{" "}
        <code>buttonparaN</code> columns if the template needs them.
      </div>

      {/* Phone + toggles and mapping */}
      <div className="grid gap-3 md:grid-cols-2">
        <div className="rounded-lg border p-3">
          <h3 className="mb-2 text-xs font-semibold text-gray-700">
            Phone column
          </h3>
          <select
            className="w-full rounded-lg border px-3 py-2 text-sm outline-none focus:border-purple-500"
            value={phoneHeader}
            onChange={e => setPhoneHeader(e.target.value)}
            disabled={!(csvHeaders ?? []).length || isUploading}
          >
            <option value="">
              {(csvHeaders ?? []).length
                ? "-- Select column --"
                : "Upload a CSV first"}
            </option>
            {(csvHeaders ?? []).map(h => (
              <option key={h} value={h}>
                {h}
              </option>
            ))}
          </select>

          <div className="mt-3 flex items-center gap-4 text-xs text-gray-700">
            <label className="inline-flex items-center gap-2">
              <input
                type="checkbox"
                checked={valReq.normalizePhone}
                onChange={e =>
                  setValReq(v => ({ ...v, normalizePhone: e.target.checked }))
                }
                disabled={isUploading}
              />
              Normalize phone (E.164)
            </label>
            <label className="inline-flex items-center gap-2">
              <input
                type="checkbox"
                checked={valReq.checkDuplicates}
                onChange={e =>
                  setValReq(v => ({ ...v, checkDuplicates: e.target.checked }))
                }
                disabled={isUploading}
              />
              Deduplicate by phone
            </label>
          </div>
        </div>

        <div className="rounded-lg border p-3">
          <div className="flex items-center justify-between">
            <h3 className="text-xs font-semibold text-gray-700">
              Mapping & Validation
            </h3>
            <span
              className={`rounded-full px-2 py-0.5 text-[11px] ${
                mappingStatus.ok
                  ? "bg-emerald-100 text-emerald-700"
                  : "bg-amber-100 text-amber-700"
              }`}
            >
              {mappingStatus.label}
            </span>
          </div>

          <button
            type="button"
            className="mt-2 text-xs text-indigo-600 hover:underline disabled:opacity-50"
            onClick={() => setShowMapping(s => !s)}
            disabled={!(csvHeaders ?? []).length || isUploading}
          >
            {showMapping ? "Hide mapping" : "Edit mapping"}
          </button>

          {showMapping && (
            <div className="mt-3 space-y-2">
              {/* Non-body keys */}
              {visibleKeys.length === 0 ? (
                <p className="text-xs text-gray-500">No extra parameters.</p>
              ) : (
                visibleKeys.map(k => (
                  <div
                    key={k}
                    className="grid grid-cols-[160px,1fr] items-center gap-2"
                  >
                    <div className="text-[11px] text-gray-500">{k}</div>
                    <select
                      className="w-full rounded-lg border px-2 py-1.5 text-xs outline-none focus:border-purple-500"
                      value={keyToColumn[k] || ""}
                      onChange={e =>
                        setKeyToColumn(m => ({ ...m, [k]: e.target.value }))
                      }
                      disabled={!(csvHeaders ?? []).length || isUploading}
                    >
                      <option value="">
                        {(csvHeaders ?? []).length
                          ? "-- Select column --"
                          : "Upload CSV"}
                      </option>
                      {(csvHeaders ?? []).map(h => (
                        <option key={h} value={h}>
                          {h}
                        </option>
                      ))}
                    </select>
                  </div>
                ))
              )}

              {/* Body placeholders */}
              {paramMappings.length > 0 && (
                <div className="mt-4 border-t pt-3">
                  <div className="mb-2 text-xs font-semibold text-gray-700">
                    Body values ({"{{n}}"}) ‚Üí CSV
                  </div>
                  <div className="space-y-2">
                    {paramMappings.map((m, i) => (
                      <div
                        key={m.index}
                        className="grid grid-cols-[80px,100px,1fr] items-center gap-2"
                      >
                        <div className="text-xs text-gray-500">{`parameter${m.index}`}</div>
                        <select
                          className="rounded-lg border px-2 py-1.5 text-xs outline-none focus:border-purple-500"
                          value={m.sourceType}
                          onChange={e =>
                            updateMapping(i, { sourceType: e.target.value })
                          }
                          disabled={isUploading}
                        >
                          <option value="csv">CSV column</option>
                          <option value="const">Constant</option>
                        </select>

                        {m.sourceType === "csv" ? (
                          <select
                            className="w-full rounded-lg border px-2 py-1.5 text-xs outline-none focus:border-purple-500"
                            value={m.sourceName || ""}
                            onChange={e =>
                              updateMapping(i, { sourceName: e.target.value })
                            }
                            disabled={!(csvHeaders ?? []).length || isUploading}
                          >
                            <option value="">
                              {(csvHeaders ?? []).length
                                ? "-- Select column --"
                                : "Upload CSV"}
                            </option>
                            {(csvHeaders ?? []).map(h => (
                              <option key={h} value={h}>
                                {h}
                              </option>
                            ))}
                          </select>
                        ) : (
                          <input
                            className="w-full rounded-lg border px-2 py-1.5 text-xs outline-none focus:border-purple-500"
                            placeholder="Constant value"
                            value={m.constValue || ""}
                            onChange={e =>
                              updateMapping(i, { constValue: e.target.value })
                            }
                            disabled={isUploading}
                          />
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
      </div>

      {/* Sample table */}
      <div className="mt-4 overflow-x-auto rounded-lg border">
        <table className="min-w-full text-xs">
          <thead className="bg-gray-100 text-gray-700">
            <tr>
              {(sample?.headers ?? csvHeaders ?? []).map(h => (
                <th key={h} className="px-3 py-2 text-left">
                  {h}
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {Array.isArray(sample?.rows) && sample.rows.length > 0 ? (
              sample.rows.map((row, idx) => (
                <tr key={idx} className="border-t">
                  {(sample?.headers ?? csvHeaders ?? []).map(h => (
                    <td key={h} className="px-3 py-1.5">
                      {row?.[h] ?? ""}
                    </td>
                  ))}
                </tr>
              ))
            ) : (
              <tr>
                <td
                  className="px-3 py-2 text-gray-400"
                  colSpan={(csvHeaders ?? []).length || 1}
                >
                  No rows yet
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>

      {/* Actions */}
      <div className="mt-4 flex flex-wrap items-center gap-2">
        <button
          type="button"
          onClick={handleValidate}
          disabled={!batch?.batchId || isUploading}
          className="rounded-md bg-gray-700 px-3 py-1.5 text-xs font-semibold text-white hover:bg-gray-800 disabled:opacity-50"
        >
          Validate
        </button>
        <button
          type="button"
          onClick={handleDryRun}
          disabled={!batch?.batchId || isUploading}
          className="rounded-md bg-indigo-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-indigo-700 disabled:opacity-50"
        >
          (Preview) Dry-run materialize
        </button>
        <button
          type="button"
          onClick={handlePersist}
          disabled={!batch?.batchId || persisting || isUploading}
          className="rounded-md bg-green-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-green-700 disabled:opacity-50"
        >
          {persisting ? "saving" : "Save Contact"}
        </button>
      </div>

      {/* Validation result */}
      {valRes && (
        <div className="mt-3 rounded-lg border border-amber-200 bg-amber-50 p-3 text-xs text-amber-900">
          <div className="font-semibold">Validation</div>
          {Array.isArray(valRes.problems) && valRes.problems.length > 0 ? (
            <ul className="mt-1 list-disc pl-5">
              {valRes.problems.map((p, i) => (
                <li key={i}>{p}</li>
              ))}
            </ul>
          ) : (
            <div className="mt-1 text-green-700">No problems found.</div>
          )}
        </div>
      )}

      {/* Dry-run preview */}
      {dryPreview && (
        <div className="mt-3 rounded-lg border border-sky-200 bg-sky-50 p-3 text-xs text-sky-900">
          <div className="font-semibold">Dry-run preview</div>
          <pre className="mt-1 overflow-x-auto rounded bg-white p-2 text-[11px] text-gray-800">
            {JSON.stringify(dryPreview, null, 2)}
          </pre>
        </div>
      )}
    </section>
  );
}

// // src/pages/Campaigns/components/CsvAudienceSection.jsx
// import React, { useEffect, useMemo, useRef, useState } from "react";
// import { useNavigate } from "react-router-dom"; // ‚üµ add
// import { toast } from "react-toastify";
// import {
//   fetchCsvSchema,
//   downloadCsvSampleBlob,
//   uploadCsvBatch,
//   getBatchSample,
//   validateBatch,
//   suggestMappings,
//   saveMappings,
//   materialize,
// } from "../api/csvApi";

// /* ---------------- Utilities ---------------- */

// function saveBlob(blob, filename) {
//   const url = window.URL.createObjectURL(blob);
//   const a = document.createElement("a");
//   a.href = url;
//   a.download = filename;
//   a.click();
//   window.URL.revokeObjectURL(url);
// }

// const norm = s =>
//   String(s || "")
//     .toLowerCase()
//     .replace(/[\s._-]+/g, "")
//     .replace(/[^a-z0-9]/g, "");

// const PHONE_ALIASES = ["phone", "mobile", "whatsapp", "number", "phonee164"];

// // Aliases to help auto-map
// const ALIASES = {
//   parameter1: ["param1", "body1"],
//   parameter2: ["param2", "body2"],
//   parameter3: ["param3", "body3"],
//   parameter4: ["param4", "body4"],
//   parameter5: ["param5", "body5"],
//   headerpara1: ["header1", "headerparam1"],
//   headerpara2: ["header2", "headerparam2"],
//   headerpara3: ["header3", "headerparam3"],
//   buttonpara1: ["btn1", "button1", "url1", "buttonparam1"],
//   buttonpara2: ["btn2", "button2", "url2", "buttonparam2"],
//   buttonpara3: ["btn3", "button3", "url3", "buttonparam3"],
// };

// // Auto-pick CSV columns for expected keys.
// function autoPick(headers, wants) {
//   const map = {};
//   const used = new Set();
//   const H = headers.map(h => ({ raw: h, k: norm(h) }));

//   // 1) exact (case-insensitive)
//   for (const key of wants) {
//     const hit = headers.find(h => norm(h) === norm(key));
//     if (hit) {
//       map[key] = hit;
//       used.add(hit);
//     }
//   }

//   // 2) aliases
//   for (const key of wants) {
//     if (map[key]) continue;
//     const aliases = ALIASES[key] || [];
//     const hit = H.find(
//       h => aliases.some(a => h.k === norm(a)) && !used.has(h.raw)
//     );
//     if (hit) {
//       map[key] = hit.raw;
//       used.add(hit.raw);
//     }
//   }

//   // 3) parameterN convenience
//   for (const key of wants) {
//     if (map[key]) continue;
//     const m = key.match(/^parameter(\d+)$/i);
//     if (!m) continue;
//     const n = m[1];
//     const hit = H.find(
//       h => (h.k === `param${n}` || h.k === `body${n}`) && !used.has(h.raw)
//     );
//     if (hit) {
//       map[key] = hit.raw;
//       used.add(hit.raw);
//     }
//   }

//   return map;
// }

// /* ---------------- Component ---------------- */

// export default function CsvAudienceSection({
//   campaignId,
//   audienceName: propAudienceName, // ‚Üê you pass campaign name from parent
// }) {
//   const navigate = useNavigate(); // ‚üµ add
//   const [loading, setLoading] = useState(true);
//   const [schema, setSchema] = useState(null);

//   const [batch, setBatch] = useState(null);
//   const [sample, setSample] = useState(null);
//   const [valReq, setValReq] = useState({
//     normalizePhone: true,
//     checkDuplicates: true,
//   });
//   const [valRes, setValRes] = useState(null);

//   // {{n}} mapping UI (body placeholders)
//   const [paramMappings, setParamMappings] = useState([]);
//   // Explicit mapping for headerparaN / buttonparaN
//   const [expectedKeys, setExpectedKeys] = useState([]); // EXACTLY as backend returns
//   const [keyToColumn, setKeyToColumn] = useState({});

//   const [phoneHeader, setPhoneHeader] = useState("");

//   const [dryPreview, setDryPreview] = useState(null);
//   const [persisting, setPersisting] = useState(false);

//   const [showMapping, setShowMapping] = useState(false);
//   const [isUploading, setIsUploading] = useState(false); // spinner flag
//   const topRef = useRef(null);

//   // Effective audience name (campaign name preferred; fallback to date label)
//   const effectiveAudienceName = useMemo(() => {
//     const trimmed = String(propAudienceName || "").trim();
//     if (trimmed) return trimmed;
//     const d = new Date();
//     const yyyy = d.getFullYear();
//     const mm = String(d.getMonth() + 1).padStart(2, "0");
//     const dd = String(d.getDate()).padStart(2, "0");
//     return `Audience ${yyyy}-${mm}-${dd}`;
//   }, [propAudienceName]);

//   // Load schema
//   useEffect(() => {
//     let alive = true;
//     (async () => {
//       try {
//         setLoading(true);
//         const sc = await fetchCsvSchema(campaignId);
//         if (!alive) return;
//         setSchema(sc);

//         const keys = Array.isArray(sc?.headers) ? sc.headers : [];
//         setExpectedKeys(keys);

//         const N = Number(sc?.placeholderCount || 0);
//         setParamMappings(
//           Array.from({ length: N }, (_, i) => ({
//             index: i + 1,
//             sourceType: "csv",
//             sourceName: "",
//             constValue: "",
//           }))
//         );
//       } catch {
//         toast.error("Failed to load CSV schema.");
//       } finally {
//         if (alive) setLoading(false);
//       }
//     })();
//     return () => {
//       alive = false;
//     };
//   }, [campaignId]);

//   const csvHeaders = useMemo(
//     () => sample?.headers ?? batch?.headerJson ?? schema?.headers ?? [],
//     [schema, batch, sample]
//   );

//   const updateMapping = (idx, patch) =>
//     setParamMappings(prev => {
//       const next = [...prev];
//       next[idx] = { ...next[idx], ...patch };
//       return next;
//     });

//   const handleDownloadSample = async () => {
//     try {
//       const blob = await downloadCsvSampleBlob(campaignId);
//       saveBlob(blob, `campaign-${campaignId}-sample.csv`);
//     } catch {
//       toast.error("Could not download sample CSV.");
//     }
//   };

//   const handleFile = async f => {
//     if (!f) return;
//     setIsUploading(true);
//     try {
//       const up = await uploadCsvBatch(f, null);
//       setBatch(up);
//       toast.success("CSV uploaded.");

//       const s = await getBatchSample(up?.batchId, 10);
//       setSample(s);

//       const hdrs = Array.isArray(s?.headers) ? s.headers : [];

//       // Auto-pick phone column
//       const lower = hdrs.map(h => String(h).toLowerCase());
//       const guessIdx = lower.findIndex(h =>
//         PHONE_ALIASES.some(k => h.includes(k))
//       );
//       setPhoneHeader(guessIdx >= 0 ? hdrs[guessIdx] : "");

//       // Auto-map explicit keys
//       const km = autoPick(hdrs, expectedKeys);
//       setKeyToColumn(km);

//       // Seed legacy body placeholders
//       setParamMappings(prev =>
//         prev.map(p => {
//           const key = `parameter${p.index}`;
//           return km[key] ? { ...p, sourceName: km[key] } : p;
//         })
//       );

//       // Optional server suggestions
//       try {
//         const sugg = await suggestMappings(campaignId, up?.batchId);
//         if (Array.isArray(sugg?.items)) {
//           setParamMappings(prev =>
//             prev.map(p => {
//               const m = sugg.items.find(x => x.index === p.index);
//               return m ? { ...p, ...m } : p;
//             })
//           );
//         }
//       } catch {}
//       setShowMapping(false);
//     } catch (e) {
//       toast.error(e?.message || "CSV upload failed.");
//     } finally {
//       setIsUploading(false);
//     }
//   };

//   const handleValidate = async () => {
//     if (!batch?.batchId) return toast.warn("Upload a CSV first.");
//     if (!phoneHeader) return toast.warn("Choose the phone column.");

//     try {
//       const req = {
//         phoneHeader,
//         requiredHeaders: [],
//         normalizePhone: !!valReq.normalizePhone,
//         checkDuplicates: !!valReq.checkDuplicates,
//       };
//       const res = await validateBatch(batch.batchId, req);
//       setValRes(res);
//       if (Array.isArray(res?.problems) && res.problems.length > 0) {
//         toast.warn(`Validation found ${res.problems.length} issue(s).`);
//       } else {
//         toast.success("Validation passed.");
//       }
//     } catch {
//       toast.error("Validation call failed.");
//     }
//   };

//   // Build mapping dict
//   const buildMappingDict = () => {
//     const dict = {};
//     for (const m of paramMappings) {
//       const key = `parameter${m.index}`;
//       dict[key] =
//         m.sourceType === "csv"
//           ? m.sourceName || ""
//           : `constant:${m.constValue ?? ""}`;
//     }
//     for (const [k, v] of Object.entries(keyToColumn || {})) {
//       if (!v) continue;
//       if (/^parameter\d+$/i.test(k)) continue;
//       dict[k] = v;
//     }
//     return dict;
//   };

//   const handleDryRun = async () => {
//     if (!batch?.batchId) return toast.warn("Upload a CSV first.");
//     try {
//       await saveMappings(campaignId, buildMappingDict());
//       const body = {
//         csvBatchId: batch.batchId,
//         mappings: buildMappingDict(),
//         phoneField: phoneHeader || undefined,
//         normalizePhones: !!valReq.normalizePhone,
//         deduplicate: !!valReq.checkDuplicates,
//         persist: false,
//       };
//       const preview = await materialize(campaignId, body);
//       setDryPreview(preview);
//       toast.success("Dry-run ready.");
//     } catch {
//       toast.error("Dry-run failed.");
//     }
//   };

//   const handlePersist = async () => {
//     if (!batch?.batchId) return toast.warn("Upload a CSV first.");
//     const nameToUse = effectiveAudienceName;
//     setPersisting(true);
//     try {
//       await saveMappings(campaignId, buildMappingDict());
//       const body = {
//         csvBatchId: batch.batchId,
//         mappings: buildMappingDict(),
//         phoneField: phoneHeader || undefined,
//         normalizePhones: !!valReq.normalizePhone,
//         deduplicate: !!valReq.checkDuplicates,
//         persist: true,
//         audienceName: nameToUse,
//       };
//       await materialize(campaignId, body);

//       toast.success("Done!! Saved Successfully.");

//       // ‚üµ Redirect after successful save
//       // Prefer router navigation; fall back to hard redirect if needed.
//       const target = "/app/campaigns/template-campaigns-list";
//       try {
//         navigate(target, { replace: true });
//       } catch {
//         if (typeof window !== "undefined") {
//           window.location.assign(target);
//         }
//       }
//     } catch {
//       toast.error("Persist failed.");
//     } finally {
//       setPersisting(false);
//     }
//   };

//   const visibleKeys = useMemo(
//     () => (expectedKeys || []).filter(k => !/^parameter\d+$/i.test(k)),
//     [expectedKeys]
//   );
//   const mappingStatus = useMemo(() => {
//     if (!visibleKeys.length) return { label: "No extra params", ok: true };
//     const missing = visibleKeys.filter(k => !keyToColumn[k]);
//     return missing.length
//       ? { label: `${missing.length} missing`, ok: false }
//       : { label: "All mapped", ok: true };
//   }, [visibleKeys, keyToColumn]);

//   if (loading) {
//     return (
//       <div className="rounded-lg border bg-white p-4 text-sm text-gray-500">
//         Loading CSV schema‚Ä¶
//       </div>
//     );
//   }

//   return (
//     <section ref={topRef} className="rounded-xl border bg-white p-4 shadow-sm">
//       {/* Expected columns + actions */}
//       <div className="mb-4 flex items-center gap-3 text-sm">
//         <div className="text-gray-600">
//           Expected columns:&nbsp;
//           <code className="rounded bg-gray-100 px-1.5 py-0.5">
//             {["phone", ...(schema?.headers || [])].join(", ")}
//           </code>
//         </div>

//         {/* Right-aligned paired buttons */}
//         <div className="ml-auto flex items-center gap-2">
//           <button
//             type="button"
//             onClick={handleDownloadSample}
//             disabled={isUploading}
//             className={`inline-flex items-center gap-2 rounded-lg border border-indigo-300 bg-white px-3 py-1.5 text-xs font-semibold shadow-sm transition focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 ${
//               isUploading
//                 ? "cursor-not-allowed opacity-50 text-indigo-500"
//                 : "text-indigo-700 hover:bg-indigo-50"
//             }`}
//           >
//             <svg
//               aria-hidden="true"
//               viewBox="0 0 24 24"
//               className="h-4 w-4"
//               fill="none"
//               stroke="currentColor"
//               strokeWidth="1.8"
//               strokeLinecap="round"
//               strokeLinejoin="round"
//             >
//               <path d="M12 3v12" />
//               <path d="m8 11 4 4 4-4" />
//               <path d="M5 21h14" />
//             </svg>
//             Download sample CSV
//           </button>

//           <div>
//             <input
//               id="csv-file-input"
//               type="file"
//               accept=".csv"
//               onChange={e => {
//                 const f = e.target.files?.[0];
//                 handleFile(f);
//                 e.target.value = ""; // allow re-selecting the same file
//               }}
//               className="sr-only"
//               disabled={isUploading}
//             />
//             <label
//               htmlFor="csv-file-input"
//               aria-disabled={isUploading}
//               className={`inline-flex items-center gap-2 rounded-lg border border-indigo-300 bg-white px-3 py-1.5 text-xs font-semibold shadow-sm transition focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 ${
//                 isUploading
//                   ? "pointer-events-none opacity-50 text-indigo-500"
//                   : "text-indigo-700 hover:bg-indigo-50"
//               }`}
//             >
//               {isUploading ? (
//                 <svg
//                   aria-hidden="true"
//                   viewBox="0 0 24 24"
//                   className="h-4 w-4 animate-spin"
//                   fill="none"
//                   stroke="currentColor"
//                   strokeWidth="2"
//                 >
//                   <circle cx="12" cy="12" r="9" className="opacity-25" />
//                   <path d="M21 12a9 9 0 0 1-9 9" className="opacity-75" />
//                 </svg>
//               ) : (
//                 <svg
//                   aria-hidden="true"
//                   viewBox="0 0 24 24"
//                   className="h-4 w-4"
//                   fill="none"
//                   stroke="currentColor"
//                   strokeWidth="1.8"
//                   strokeLinecap="round"
//                   strokeLinejoin="round"
//                 >
//                   <path d="M16 16.5a4 4 0 0 0-1-7.9 5 5 0 0 0-9.8 1.2 3.5 3.5 0 0 0 .7 6.9h2" />
//                   <path d="M12 12v8" />
//                   <path d="m8.5 15.5 3.5-3.5 3.5 3.5" />
//                 </svg>
//               )}
//               {isUploading ? "Uploading‚Ä¶" : "Upload CSV"}
//             </label>
//           </div>
//         </div>
//       </div>

//       {/* Helper note */}
//       <div className="mb-3 rounded-md border border-dashed border-gray-200 bg-gray-50 p-2 text-[11px] text-gray-600">
//         We set any media URL once at <strong>campaign creation</strong> (not in
//         CSV). Your CSV should contain <code>phone</code>, body values as{" "}
//         <code>parameter1‚Ä¶N</code>, plus any <code>headerparaN</code> and{" "}
//         <code>buttonparaN</code> columns if the template needs them.
//       </div>

//       {/* Phone + toggles and mapping */}
//       <div className="grid gap-3 md:grid-cols-2">
//         <div className="rounded-lg border p-3">
//           <h3 className="mb-2 text-xs font-semibold text-gray-700">
//             Phone column
//           </h3>
//           <select
//             className="w-full rounded-lg border px-3 py-2 text-sm outline-none focus:border-purple-500"
//             value={phoneHeader}
//             onChange={e => setPhoneHeader(e.target.value)}
//             disabled={!(csvHeaders ?? []).length || isUploading}
//           >
//             <option value="">
//               {(csvHeaders ?? []).length
//                 ? "-- Select column --"
//                 : "Upload a CSV first"}
//             </option>
//             {(csvHeaders ?? []).map(h => (
//               <option key={h} value={h}>
//                 {h}
//               </option>
//             ))}
//           </select>

//           <div className="mt-3 flex items-center gap-4 text-xs text-gray-700">
//             <label className="inline-flex items-center gap-2">
//               <input
//                 type="checkbox"
//                 checked={valReq.normalizePhone}
//                 onChange={e =>
//                   setValReq(v => ({ ...v, normalizePhone: e.target.checked }))
//                 }
//                 disabled={isUploading}
//               />
//               Normalize phone (E.164)
//             </label>
//             <label className="inline-flex items-center gap-2">
//               <input
//                 type="checkbox"
//                 checked={valReq.checkDuplicates}
//                 onChange={e =>
//                   setValReq(v => ({ ...v, checkDuplicates: e.target.checked }))
//                 }
//                 disabled={isUploading}
//               />
//               Deduplicate by phone
//             </label>
//           </div>
//         </div>

//         <div className="rounded-lg border p-3">
//           <div className="flex items-center justify-between">
//             <h3 className="text-xs font-semibold text-gray-700">
//               Mapping & Validation
//             </h3>
//             <span
//               className={`rounded-full px-2 py-0.5 text-[11px] ${
//                 mappingStatus.ok
//                   ? "bg-emerald-100 text-emerald-700"
//                   : "bg-amber-100 text-amber-700"
//               }`}
//             >
//               {mappingStatus.label}
//             </span>
//           </div>

//           <button
//             type="button"
//             className="mt-2 text-xs text-indigo-600 hover:underline disabled:opacity-50"
//             onClick={() => setShowMapping(s => !s)}
//             disabled={!(csvHeaders ?? []).length || isUploading}
//           >
//             {showMapping ? "Hide mapping" : "Edit mapping"}
//           </button>

//           {showMapping && (
//             <div className="mt-3 space-y-2">
//               {/* Non-body keys */}
//               {visibleKeys.length === 0 ? (
//                 <p className="text-xs text-gray-500">No extra parameters.</p>
//               ) : (
//                 visibleKeys.map(k => (
//                   <div
//                     key={k}
//                     className="grid grid-cols-[160px,1fr] items-center gap-2"
//                   >
//                     <div className="text-[11px] text-gray-500">{k}</div>
//                     <select
//                       className="w-full rounded-lg border px-2 py-1.5 text-xs outline-none focus:border-purple-500"
//                       value={keyToColumn[k] || ""}
//                       onChange={e =>
//                         setKeyToColumn(m => ({ ...m, [k]: e.target.value }))
//                       }
//                       disabled={!(csvHeaders ?? []).length || isUploading}
//                     >
//                       <option value="">
//                         {(csvHeaders ?? []).length
//                           ? "-- Select column --"
//                           : "Upload CSV"}
//                       </option>
//                       {(csvHeaders ?? []).map(h => (
//                         <option key={h} value={h}>
//                           {h}
//                         </option>
//                       ))}
//                     </select>
//                   </div>
//                 ))
//               )}

//               {/* Body placeholders */}
//               {paramMappings.length > 0 && (
//                 <div className="mt-4 border-t pt-3">
//                   <div className="mb-2 text-xs font-semibold text-gray-700">
//                     Body values ({"{{n}}"}) ‚Üí CSV
//                   </div>
//                   <div className="space-y-2">
//                     {paramMappings.map((m, i) => (
//                       <div
//                         key={m.index}
//                         className="grid grid-cols-[80px,100px,1fr] items-center gap-2"
//                       >
//                         <div className="text-xs text-gray-500">{`parameter${m.index}`}</div>
//                         <select
//                           className="rounded-lg border px-2 py-1.5 text-xs outline-none focus:border-purple-500"
//                           value={m.sourceType}
//                           onChange={e =>
//                             updateMapping(i, { sourceType: e.target.value })
//                           }
//                           disabled={isUploading}
//                         >
//                           <option value="csv">CSV column</option>
//                           <option value="const">Constant</option>
//                         </select>

//                         {m.sourceType === "csv" ? (
//                           <select
//                             className="w-full rounded-lg border px-2 py-1.5 text-xs outline-none focus:border-purple-500"
//                             value={m.sourceName || ""}
//                             onChange={e =>
//                               updateMapping(i, { sourceName: e.target.value })
//                             }
//                             disabled={!(csvHeaders ?? []).length || isUploading}
//                           >
//                             <option value="">
//                               {(csvHeaders ?? []).length
//                                 ? "-- Select column --"
//                                 : "Upload CSV"}
//                             </option>
//                             {(csvHeaders ?? []).map(h => (
//                               <option key={h} value={h}>
//                                 {h}
//                               </option>
//                             ))}
//                           </select>
//                         ) : (
//                           <input
//                             className="w-full rounded-lg border px-2 py-1.5 text-xs outline-none focus:border-purple-500"
//                             placeholder="Constant value"
//                             value={m.constValue || ""}
//                             onChange={e =>
//                               updateMapping(i, { constValue: e.target.value })
//                             }
//                             disabled={isUploading}
//                           />
//                         )}
//                       </div>
//                     ))}
//                   </div>
//                 </div>
//               )}
//             </div>
//           )}
//         </div>
//       </div>

//       {/* Sample table */}
//       <div className="mt-4 overflow-x-auto rounded-lg border">
//         <table className="min-w-full text-xs">
//           <thead className="bg-gray-100 text-gray-700">
//             <tr>
//               {(sample?.headers ?? csvHeaders ?? []).map(h => (
//                 <th key={h} className="px-3 py-2 text-left">
//                   {h}
//                 </th>
//               ))}
//             </tr>
//           </thead>
//           <tbody>
//             {Array.isArray(sample?.rows) && sample.rows.length > 0 ? (
//               sample.rows.map((row, idx) => (
//                 <tr key={idx} className="border-t">
//                   {(sample?.headers ?? csvHeaders ?? []).map(h => (
//                     <td key={h} className="px-3 py-1.5">
//                       {row?.[h] ?? ""}
//                     </td>
//                   ))}
//                 </tr>
//               ))
//             ) : (
//               <tr>
//                 <td
//                   className="px-3 py-2 text-gray-400"
//                   colSpan={(csvHeaders ?? []).length || 1}
//                 >
//                   No rows yet
//                 </td>
//               </tr>
//             )}
//           </tbody>
//         </table>
//       </div>

//       {/* Actions */}
//       <div className="mt-4 flex flex-wrap items-center gap-2">
//         <button
//           type="button"
//           onClick={handleValidate}
//           disabled={!batch?.batchId || isUploading}
//           className="rounded-md bg-gray-700 px-3 py-1.5 text-xs font-semibold text-white hover:bg-gray-800 disabled:opacity-50"
//         >
//           Validate
//         </button>
//         <button
//           type="button"
//           onClick={handleDryRun}
//           disabled={!batch?.batchId || isUploading}
//           className="rounded-md bg-indigo-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-indigo-700 disabled:opacity-50"
//         >
//           (Preview) Dry-run materialize
//         </button>
//         <button
//           type="button"
//           onClick={handlePersist}
//           disabled={!batch?.batchId || persisting || isUploading}
//           className="rounded-md bg-green-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-green-700 disabled:opacity-50"
//         >
//           {persisting ? "saving" : "Save Contact"}
//         </button>
//       </div>

//       {/* Validation result */}
//       {valRes && (
//         <div className="mt-3 rounded-lg border border-amber-200 bg-amber-50 p-3 text-xs text-amber-900">
//           <div className="font-semibold">Validation</div>
//           {Array.isArray(valRes.problems) && valRes.problems.length > 0 ? (
//             <ul className="mt-1 list-disc pl-5">
//               {valRes.problems.map((p, i) => (
//                 <li key={i}>{p}</li>
//               ))}
//             </ul>
//           ) : (
//             <div className="mt-1 text-green-700">No problems found.</div>
//           )}
//         </div>
//       )}

//       {/* Dry-run preview */}
//       {dryPreview && (
//         <div className="mt-3 rounded-lg border border-sky-200 bg-sky-50 p-3 text-xs text-sky-900">
//           <div className="font-semibold">Dry-run preview</div>
//           <pre className="mt-1 overflow-x-auto rounded bg-white p-2 text-[11px] text-gray-800">
//             {JSON.stringify(dryPreview, null, 2)}
//           </pre>
//         </div>
//       )}
//     </section>
//   );
// }

// // src/pages/Campaigns/components/CsvAudienceSection.jsx
// import React, { useEffect, useMemo, useRef, useState } from "react";
// import { toast } from "react-toastify";
// import {
//   fetchCsvSchema,
//   downloadCsvSampleBlob,
//   uploadCsvBatch,
//   getBatchSample,
//   validateBatch,
//   suggestMappings,
//   saveMappings,
//   materialize,
// } from "../api/csvApi";

// /* ---------------- Utilities ---------------- */

// function saveBlob(blob, filename) {
//   const url = window.URL.createObjectURL(blob);
//   const a = document.createElement("a");
//   a.href = url;
//   a.download = filename;
//   a.click();
//   window.URL.revokeObjectURL(url);
// }

// const norm = s =>
//   String(s || "")
//     .toLowerCase()
//     .replace(/[\s._-]+/g, "")
//     .replace(/[^a-z0-9]/g, "");

// const PHONE_ALIASES = ["phone", "mobile", "whatsapp", "number", "phonee164"];

// // Aliases to help auto-map
// const ALIASES = {
//   // parameterN
//   parameter1: ["param1", "body1"],
//   parameter2: ["param2", "body2"],
//   parameter3: ["param3", "body3"],
//   parameter4: ["param4", "body4"],
//   parameter5: ["param5", "body5"],
//   // header text
//   headerpara1: ["header1", "headerparam1"],
//   headerpara2: ["header2", "headerparam2"],
//   headerpara3: ["header3", "headerparam3"],
//   // buttons
//   buttonpara1: ["btn1", "button1", "url1", "buttonparam1"],
//   buttonpara2: ["btn2", "button2", "url2", "buttonparam2"],
//   buttonpara3: ["btn3", "button3", "url3", "buttonparam3"],
// };

// // Auto-pick CSV columns for expected keys.
// function autoPick(headers, wants) {
//   const map = {};
//   const used = new Set();
//   const H = headers.map(h => ({ raw: h, k: norm(h) }));

//   // 1) exact (case-insensitive)
//   for (const key of wants) {
//     const hit = headers.find(h => norm(h) === norm(key));
//     if (hit) {
//       map[key] = hit;
//       used.add(hit);
//     }
//   }

//   // 2) aliases
//   for (const key of wants) {
//     if (map[key]) continue;
//     const aliases = ALIASES[key] || [];
//     const hit = H.find(
//       h => aliases.some(a => h.k === norm(a)) && !used.has(h.raw)
//     );
//     if (hit) {
//       map[key] = hit.raw;
//       used.add(hit.raw);
//     }
//   }

//   // 3) parameterN convenience (match "paramN" or "bodyN")
//   for (const key of wants) {
//     if (map[key]) continue;
//     const m = key.match(/^parameter(\d+)$/i);
//     if (!m) continue;
//     const n = m[1];
//     const hit = H.find(
//       h => (h.k === `param${n}` || h.k === `body${n}`) && !used.has(h.raw)
//     );
//     if (hit) {
//       map[key] = hit.raw;
//       used.add(hit.raw);
//     }
//   }

//   return map;
// }

// /* ---------------- Component ---------------- */

// export default function CsvAudienceSection({
//   campaignId,
//   audienceName: propAudienceName, // ‚Üê you pass campaign name from parent
// }) {
//   const [loading, setLoading] = useState(true);
//   const [schema, setSchema] = useState(null);

//   const [batch, setBatch] = useState(null);
//   const [sample, setSample] = useState(null);
//   const [valReq, setValReq] = useState({
//     normalizePhone: true,
//     checkDuplicates: true,
//   });
//   const [valRes, setValRes] = useState(null);

//   // {{n}} mapping UI (body placeholders)
//   const [paramMappings, setParamMappings] = useState([]);
//   // Explicit mapping for headerparaN / buttonparaN
//   const [expectedKeys, setExpectedKeys] = useState([]); // EXACTLY as backend returns
//   const [keyToColumn, setKeyToColumn] = useState({});

//   const [phoneHeader, setPhoneHeader] = useState("");

//   const [dryPreview, setDryPreview] = useState(null);
//   const [persisting, setPersisting] = useState(false);

//   const [showMapping, setShowMapping] = useState(false);
//   const [isUploading, setIsUploading] = useState(false); // ‚üµ spinner flag
//   const topRef = useRef(null);

//   // Effective audience name (campaign name preferred; fallback to date label)
//   const effectiveAudienceName = useMemo(() => {
//     const trimmed = String(propAudienceName || "").trim();
//     if (trimmed) return trimmed;
//     const d = new Date();
//     const yyyy = d.getFullYear();
//     const mm = String(d.getMonth() + 1).padStart(2, "0");
//     const dd = String(d.getDate()).padStart(2, "0");
//     return `Audience ${yyyy}-${mm}-${dd}`;
//   }, [propAudienceName]);

//   // Load schema
//   useEffect(() => {
//     let alive = true;
//     (async () => {
//       try {
//         setLoading(true);
//         const sc = await fetchCsvSchema(campaignId);
//         if (!alive) return;
//         setSchema(sc);

//         const keys = Array.isArray(sc?.headers) ? sc.headers : [];
//         setExpectedKeys(keys);

//         const N = Number(sc?.placeholderCount || 0);
//         setParamMappings(
//           Array.from({ length: N }, (_, i) => ({
//             index: i + 1,
//             sourceType: "csv",
//             sourceName: "",
//             constValue: "",
//           }))
//         );
//       } catch {
//         toast.error("Failed to load CSV schema.");
//       } finally {
//         if (alive) setLoading(false);
//       }
//     })();
//     return () => {
//       alive = false;
//     };
//   }, [campaignId]);

//   const csvHeaders = useMemo(
//     () => sample?.headers ?? batch?.headerJson ?? schema?.headers ?? [],
//     [schema, batch, sample]
//   );

//   const updateMapping = (idx, patch) =>
//     setParamMappings(prev => {
//       const next = [...prev];
//       next[idx] = { ...next[idx], ...patch };
//       return next;
//     });

//   const handleDownloadSample = async () => {
//     try {
//       const blob = await downloadCsvSampleBlob(campaignId);
//       saveBlob(blob, `campaign-${campaignId}-sample.csv`);
//     } catch {
//       toast.error("Could not download sample CSV.");
//     }
//   };

//   const handleFile = async f => {
//     if (!f) return;
//     setIsUploading(true);
//     try {
//       const up = await uploadCsvBatch(f, null);
//       setBatch(up);
//       toast.success("CSV uploaded.");

//       const s = await getBatchSample(up?.batchId, 10);
//       setSample(s);

//       const hdrs = Array.isArray(s?.headers) ? s.headers : [];

//       // Auto-pick phone column
//       const lower = hdrs.map(h => String(h).toLowerCase());
//       const guessIdx = lower.findIndex(h =>
//         PHONE_ALIASES.some(k => h.includes(k))
//       );
//       setPhoneHeader(guessIdx >= 0 ? hdrs[guessIdx] : "");

//       // Auto-map explicit keys
//       const km = autoPick(hdrs, expectedKeys);
//       setKeyToColumn(km);

//       // Seed legacy body placeholders
//       setParamMappings(prev =>
//         prev.map(p => {
//           const key = `parameter${p.index}`;
//           return km[key] ? { ...p, sourceName: km[key] } : p;
//         })
//       );

//       // Optional server suggestions
//       try {
//         const sugg = await suggestMappings(campaignId, up?.batchId);
//         if (Array.isArray(sugg?.items)) {
//           setParamMappings(prev =>
//             prev.map(p => {
//               const m = sugg.items.find(x => x.index === p.index);
//               return m ? { ...p, ...m } : p;
//             })
//           );
//         }
//       } catch {}
//       setShowMapping(false);
//     } catch (e) {
//       toast.error(e?.message || "CSV upload failed.");
//     } finally {
//       setIsUploading(false);
//     }
//   };

//   const handleValidate = async () => {
//     if (!batch?.batchId) return toast.warn("Upload a CSV first.");
//     if (!phoneHeader) return toast.warn("Choose the phone column.");

//     try {
//       const req = {
//         phoneHeader,
//         requiredHeaders: [],
//         normalizePhone: !!valReq.normalizePhone,
//         checkDuplicates: !!valReq.checkDuplicates,
//       };
//       const res = await validateBatch(batch.batchId, req);
//       setValRes(res);
//       if (Array.isArray(res?.problems) && res.problems.length > 0) {
//         toast.warn(`Validation found ${res.problems.length} issue(s).`);
//       } else {
//         toast.success("Validation passed.");
//       }
//     } catch {
//       toast.error("Validation call failed.");
//     }
//   };

//   // Build mapping dict
//   const buildMappingDict = () => {
//     const dict = {};
//     for (const m of paramMappings) {
//       const key = `parameter${m.index}`;
//       dict[key] =
//         m.sourceType === "csv"
//           ? m.sourceName || ""
//           : `constant:${m.constValue ?? ""}`;
//     }
//     for (const [k, v] of Object.entries(keyToColumn || {})) {
//       if (!v) continue;
//       if (/^parameter\d+$/i.test(k)) continue;
//       dict[k] = v;
//     }
//     return dict;
//   };

//   const handleDryRun = async () => {
//     if (!batch?.batchId) return toast.warn("Upload a CSV first.");
//     try {
//       await saveMappings(campaignId, buildMappingDict());
//       const body = {
//         csvBatchId: batch.batchId,
//         mappings: buildMappingDict(),
//         phoneField: phoneHeader || undefined,
//         normalizePhones: !!valReq.normalizePhone,
//         deduplicate: !!valReq.checkDuplicates,
//         persist: false,
//       };
//       const preview = await materialize(campaignId, body);
//       setDryPreview(preview);
//       toast.success("Dry-run ready.");
//     } catch {
//       toast.error("Dry-run failed.");
//     }
//   };

//   const handlePersist = async () => {
//     if (!batch?.batchId) return toast.warn("Upload a CSV first.");
//     const nameToUse = effectiveAudienceName;
//     setPersisting(true);
//     try {
//       await saveMappings(campaignId, buildMappingDict());
//       const body = {
//         csvBatchId: batch.batchId,
//         mappings: buildMappingDict(),
//         phoneField: phoneHeader || undefined,
//         normalizePhones: !!valReq.normalizePhone,
//         deduplicate: !!valReq.checkDuplicates,
//         persist: true,
//         audienceName: nameToUse,
//       };
//       await materialize(campaignId, body);
//       toast.success("Done!! Saved Successfully.");
//     } catch {
//       toast.error("Persist failed.");
//     } finally {
//       setPersisting(false);
//     }
//   };

//   const visibleKeys = useMemo(
//     () => (expectedKeys || []).filter(k => !/^parameter\d+$/i.test(k)),
//     [expectedKeys]
//   );
//   const mappingStatus = useMemo(() => {
//     if (!visibleKeys.length) return { label: "No extra params", ok: true };
//     const missing = visibleKeys.filter(k => !keyToColumn[k]);
//     return missing.length
//       ? { label: `${missing.length} missing`, ok: false }
//       : { label: "All mapped", ok: true };
//   }, [visibleKeys, keyToColumn]);

//   if (loading) {
//     return (
//       <div className="rounded-lg border bg-white p-4 text-sm text-gray-500">
//         Loading CSV schema‚Ä¶
//       </div>
//     );
//   }

//   return (
//     <section ref={topRef} className="rounded-xl border bg-white p-4 shadow-sm">
//       {/* <h2 className="mb-3 text-sm font-semibold text-gray-800">
//         Audience via CSV
//       </h2> */}

//       {/* Expected columns + actions */}
//       <div className="mb-4 flex items-center gap-3 text-sm">
//         <div className="text-gray-600">
//           Expected columns:&nbsp;
//           <code className="rounded bg-gray-100 px-1.5 py-0.5">
//             {["phone", ...(schema?.headers || [])].join(", ")}
//           </code>
//         </div>

//         {/* Right-aligned paired buttons */}
//         <div className="ml-auto flex items-center gap-2">
//           <button
//             type="button"
//             onClick={handleDownloadSample}
//             disabled={isUploading}
//             className={`inline-flex items-center gap-2 rounded-lg border border-indigo-300 bg-white px-3 py-1.5 text-xs font-semibold shadow-sm transition focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 ${
//               isUploading
//                 ? "cursor-not-allowed opacity-50 text-indigo-500"
//                 : "text-indigo-700 hover:bg-indigo-50"
//             }`}
//           >
//             {/* Download icon */}
//             <svg
//               aria-hidden="true"
//               viewBox="0 0 24 24"
//               className="h-4 w-4"
//               fill="none"
//               stroke="currentColor"
//               strokeWidth="1.8"
//               strokeLinecap="round"
//               strokeLinejoin="round"
//             >
//               <path d="M12 3v12" />
//               <path d="m8 11 4 4 4-4" />
//               <path d="M5 21h14" />
//             </svg>
//             Download sample CSV
//           </button>

//           <div>
//             <input
//               id="csv-file-input"
//               type="file"
//               accept=".csv"
//               onChange={e => {
//                 const f = e.target.files?.[0];
//                 handleFile(f);
//                 // allow selecting the same file again
//                 e.target.value = "";
//               }}
//               className="sr-only"
//               disabled={isUploading}
//             />
//             <label
//               htmlFor="csv-file-input"
//               aria-disabled={isUploading}
//               className={`inline-flex items-center gap-2 rounded-lg border border-indigo-300 bg-white px-3 py-1.5 text-xs font-semibold shadow-sm transition focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 ${
//                 isUploading
//                   ? "pointer-events-none opacity-50 text-indigo-500"
//                   : "text-indigo-700 hover:bg-indigo-50"
//               }`}
//             >
//               {/* Upload / Spinner icon */}
//               {isUploading ? (
//                 <svg
//                   aria-hidden="true"
//                   viewBox="0 0 24 24"
//                   className="h-4 w-4 animate-spin"
//                   fill="none"
//                   stroke="currentColor"
//                   strokeWidth="2"
//                 >
//                   <circle cx="12" cy="12" r="9" className="opacity-25" />
//                   <path d="M21 12a9 9 0 0 1-9 9" className="opacity-75" />
//                 </svg>
//               ) : (
//                 <svg
//                   aria-hidden="true"
//                   viewBox="0 0 24 24"
//                   className="h-4 w-4"
//                   fill="none"
//                   stroke="currentColor"
//                   strokeWidth="1.8"
//                   strokeLinecap="round"
//                   strokeLinejoin="round"
//                 >
//                   <path d="M16 16.5a4 4 0 0 0-1-7.9 5 5 0 0 0-9.8 1.2 3.5 3.5 0 0 0 .7 6.9h2" />
//                   <path d="M12 12v8" />
//                   <path d="m8.5 15.5 3.5-3.5 3.5 3.5" />
//                 </svg>
//               )}
//               {isUploading ? "Uploading‚Ä¶" : "Upload CSV"}
//             </label>
//           </div>
//         </div>
//       </div>

//       {/* Helper note */}
//       <div className="mb-3 rounded-md border border-dashed border-gray-200 bg-gray-50 p-2 text-[11px] text-gray-600">
//         We set any media URL once at <strong>campaign creation</strong> (not in
//         CSV). Your CSV should contain <code>phone</code>, body values as{" "}
//         <code>parameter1‚Ä¶N</code>, plus any <code>headerparaN</code> and{" "}
//         <code>buttonparaN</code> columns if the template needs them.
//       </div>

//       {/* Phone + toggles and mapping */}
//       <div className="grid gap-3 md:grid-cols-2">
//         <div className="rounded-lg border p-3">
//           <h3 className="mb-2 text-xs font-semibold text-gray-700">
//             Phone column
//           </h3>
//           <select
//             className="w-full rounded-lg border px-3 py-2 text-sm outline-none focus:border-purple-500"
//             value={phoneHeader}
//             onChange={e => setPhoneHeader(e.target.value)}
//             disabled={!(csvHeaders ?? []).length || isUploading}
//           >
//             <option value="">
//               {(csvHeaders ?? []).length
//                 ? "-- Select column --"
//                 : "Upload a CSV first"}
//             </option>
//             {(csvHeaders ?? []).map(h => (
//               <option key={h} value={h}>
//                 {h}
//               </option>
//             ))}
//           </select>

//           <div className="mt-3 flex items-center gap-4 text-xs text-gray-700">
//             <label className="inline-flex items-center gap-2">
//               <input
//                 type="checkbox"
//                 checked={valReq.normalizePhone}
//                 onChange={e =>
//                   setValReq(v => ({ ...v, normalizePhone: e.target.checked }))
//                 }
//                 disabled={isUploading}
//               />
//               Normalize phone (E.164)
//             </label>
//             <label className="inline-flex items-center gap-2">
//               <input
//                 type="checkbox"
//                 checked={valReq.checkDuplicates}
//                 onChange={e =>
//                   setValReq(v => ({ ...v, checkDuplicates: e.target.checked }))
//                 }
//                 disabled={isUploading}
//               />
//               Deduplicate by phone
//             </label>
//           </div>
//         </div>

//         <div className="rounded-lg border p-3">
//           <div className="flex items-center justify-between">
//             <h3 className="text-xs font-semibold text-gray-700">
//               Mapping & Validation
//             </h3>
//             <span
//               className={`rounded-full px-2 py-0.5 text-[11px] ${
//                 mappingStatus.ok
//                   ? "bg-emerald-100 text-emerald-700"
//                   : "bg-amber-100 text-amber-700"
//               }`}
//             >
//               {mappingStatus.label}
//             </span>
//           </div>

//           <button
//             type="button"
//             className="mt-2 text-xs text-indigo-600 hover:underline disabled:opacity-50"
//             onClick={() => setShowMapping(s => !s)}
//             disabled={!(csvHeaders ?? []).length || isUploading}
//           >
//             {showMapping ? "Hide mapping" : "Edit mapping"}
//           </button>

//           {showMapping && (
//             <div className="mt-3 space-y-2">
//               {/* Non-body keys */}
//               {visibleKeys.length === 0 ? (
//                 <p className="text-xs text-gray-500">No extra parameters.</p>
//               ) : (
//                 visibleKeys.map(k => (
//                   <div
//                     key={k}
//                     className="grid grid-cols-[160px,1fr] items-center gap-2"
//                   >
//                     <div className="text-[11px] text-gray-500">{k}</div>
//                     <select
//                       className="w-full rounded-lg border px-2 py-1.5 text-xs outline-none focus:border-purple-500"
//                       value={keyToColumn[k] || ""}
//                       onChange={e =>
//                         setKeyToColumn(m => ({ ...m, [k]: e.target.value }))
//                       }
//                       disabled={!(csvHeaders ?? []).length || isUploading}
//                     >
//                       <option value="">
//                         {(csvHeaders ?? []).length
//                           ? "-- Select column --"
//                           : "Upload CSV"}
//                       </option>
//                       {(csvHeaders ?? []).map(h => (
//                         <option key={h} value={h}>
//                           {h}
//                         </option>
//                       ))}
//                     </select>
//                   </div>
//                 ))
//               )}

//               {/* Body placeholders */}
//               {paramMappings.length > 0 && (
//                 <div className="mt-4 border-t pt-3">
//                   <div className="mb-2 text-xs font-semibold text-gray-700">
//                     Body values ({"{{n}}"}) ‚Üí CSV
//                   </div>
//                   <div className="space-y-2">
//                     {paramMappings.map((m, i) => (
//                       <div
//                         key={m.index}
//                         className="grid grid-cols-[80px,100px,1fr] items-center gap-2"
//                       >
//                         <div className="text-xs text-gray-500">{`parameter${m.index}`}</div>
//                         <select
//                           className="rounded-lg border px-2 py-1.5 text-xs outline-none focus:border-purple-500"
//                           value={m.sourceType}
//                           onChange={e =>
//                             updateMapping(i, { sourceType: e.target.value })
//                           }
//                           disabled={isUploading}
//                         >
//                           <option value="csv">CSV column</option>
//                           <option value="const">Constant</option>
//                         </select>

//                         {m.sourceType === "csv" ? (
//                           <select
//                             className="w-full rounded-lg border px-2 py-1.5 text-xs outline-none focus:border-purple-500"
//                             value={m.sourceName || ""}
//                             onChange={e =>
//                               updateMapping(i, { sourceName: e.target.value })
//                             }
//                             disabled={!(csvHeaders ?? []).length || isUploading}
//                           >
//                             <option value="">
//                               {(csvHeaders ?? []).length
//                                 ? "-- Select column --"
//                                 : "Upload CSV"}
//                             </option>
//                             {(csvHeaders ?? []).map(h => (
//                               <option key={h} value={h}>
//                                 {h}
//                               </option>
//                             ))}
//                           </select>
//                         ) : (
//                           <input
//                             className="w-full rounded-lg border px-2 py-1.5 text-xs outline-none focus:border-purple-500"
//                             placeholder="Constant value"
//                             value={m.constValue || ""}
//                             onChange={e =>
//                               updateMapping(i, { constValue: e.target.value })
//                             }
//                             disabled={isUploading}
//                           />
//                         )}
//                       </div>
//                     ))}
//                   </div>
//                 </div>
//               )}
//             </div>
//           )}
//         </div>
//       </div>

//       {/* Sample table */}
//       <div className="mt-4 overflow-x-auto rounded-lg border">
//         <table className="min-w-full text-xs">
//           <thead className="bg-gray-100 text-gray-700">
//             <tr>
//               {(sample?.headers ?? csvHeaders ?? []).map(h => (
//                 <th key={h} className="px-3 py-2 text-left">
//                   {h}
//                 </th>
//               ))}
//             </tr>
//           </thead>
//           <tbody>
//             {Array.isArray(sample?.rows) && sample.rows.length > 0 ? (
//               sample.rows.map((row, idx) => (
//                 <tr key={idx} className="border-t">
//                   {(sample?.headers ?? csvHeaders ?? []).map(h => (
//                     <td key={h} className="px-3 py-1.5">
//                       {row?.[h] ?? ""}
//                     </td>
//                   ))}
//                 </tr>
//               ))
//             ) : (
//               <tr>
//                 <td
//                   className="px-3 py-2 text-gray-400"
//                   colSpan={(csvHeaders ?? []).length || 1}
//                 >
//                   No rows yet
//                 </td>
//               </tr>
//             )}
//           </tbody>
//         </table>
//       </div>

//       {/* Actions */}
//       <div className="mt-4 flex flex-wrap items-center gap-2">
//         <button
//           type="button"
//           onClick={handleValidate}
//           disabled={!batch?.batchId || isUploading}
//           className="rounded-md bg-gray-700 px-3 py-1.5 text-xs font-semibold text-white hover:bg-gray-800 disabled:opacity-50"
//         >
//           Validate
//         </button>
//         <button
//           type="button"
//           onClick={handleDryRun}
//           disabled={!batch?.batchId || isUploading}
//           className="rounded-md bg-indigo-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-indigo-700 disabled:opacity-50"
//         >
//           (Preview) Dry-run materialize
//         </button>
//         <button
//           type="button"
//           onClick={handlePersist}
//           disabled={!batch?.batchId || persisting || isUploading}
//           className="rounded-md bg-green-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-green-700 disabled:opacity-50"
//         >
//           {persisting ? "saving" : "Save Contact"}
//         </button>
//       </div>

//       {/* Validation result */}
//       {valRes && (
//         <div className="mt-3 rounded-lg border border-amber-200 bg-amber-50 p-3 text-xs text-amber-900">
//           <div className="font-semibold">Validation</div>
//           {Array.isArray(valRes.problems) && valRes.problems.length > 0 ? (
//             <ul className="mt-1 list-disc pl-5">
//               {valRes.problems.map((p, i) => (
//                 <li key={i}>{p}</li>
//               ))}
//             </ul>
//           ) : (
//             <div className="mt-1 text-green-700">No problems found.</div>
//           )}
//         </div>
//       )}

//       {/* Dry-run preview */}
//       {dryPreview && (
//         <div className="mt-3 rounded-lg border border-sky-200 bg-sky-50 p-3 text-xs text-sky-900">
//           <div className="font-semibold">Dry-run preview</div>
//           <pre className="mt-1 overflow-x-auto rounded bg-white p-2 text-[11px] text-gray-800">
//             {JSON.stringify(dryPreview, null, 2)}
//           </pre>
//         </div>
//       )}
//     </section>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\components\ExistingContactsList.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import { toast } from "react-toastify";
import axiosClient from "../../../api/axiosClient";
import TagFilterDropdown from "./TagFilterDropdown";

export default function ExistingContactsList({
  contacts,
  setContacts,
  selectedIds,
  setSelectedIds,
}) {
  const [filteredContacts, setFilteredContacts] = useState([]);
  const [search, setSearch] = useState("");
  const [filterTags, setFilterTags] = useState([]);

  useEffect(() => {
    const loadContacts = async () => {
      try {
        const res =
          filterTags.length > 0
            ? await axiosClient.post("/contacts/filter-by-tags", {
                tagIds: filterTags,
              })
            : await axiosClient.get("/contacts/all");
        setContacts(res.data?.data || []);
      } catch {
        toast.error("Failed to load contacts");
      }
    };
    loadContacts();
  }, [filterTags, setContacts]);

  useEffect(() => {
    const result = contacts.filter(
      c =>
        c.name?.toLowerCase().includes(search.toLowerCase()) ||
        (c.phoneNumber || c.phone || "").includes(search)
    );
    setFilteredContacts(result);
  }, [contacts, search]);

  const toggleContact = id => {
    setSelectedIds(prev =>
      prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]
    );
  };

  return (
    <div>
      <div className="flex flex-col sm:flex-row gap-4 mb-4">
        <input
          className="border p-2 rounded-md w-full sm:w-1/3"
          type="text"
          placeholder="Search by name or phone..."
          value={search}
          onChange={e => setSearch(e.target.value)}
        />
        <TagFilterDropdown
          selectedTags={filterTags}
          onChange={setFilterTags}
          category="All"
        />
      </div>

      <div className="bg-white rounded-xl shadow-sm overflow-x-auto">
        <table className="min-w-full text-sm">
          {/* ... Your Table Head JSX ... */}
          <tbody>
            {filteredContacts.map(contact => (
              <tr key={contact.id} className="border-t hover:bg-gray-50">
                <td className="px-4 py-2 text-center">
                  <input
                    type="checkbox"
                    checked={selectedIds.includes(contact.id)}
                    onChange={() => toggleContact(contact.id)}
                  />
                </td>
                <td className="px-4 py-2">{contact.name || "Unnamed"}</td>
                <td className="px-4 py-2">
                  {contact.phoneNumber || contact.phone || "‚Äî"}
                </td>
                {/* ... Other table cells ... */}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\components\MessagePreviewModal.jsx 
====================================================== 
 
import React from "react";
import { Dialog } from "@headlessui/react";

const MessagePreviewModal = ({ isOpen, onClose, messageLog }) => {
  if (!messageLog) return null;

  return (
    <Dialog open={isOpen} onClose={onClose} className="relative z-50">
      <div
        className="fixed inset-0 bg-black bg-opacity-30"
        aria-hidden="true"
      />

      <div className="fixed inset-0 flex items-center justify-center p-4">
        <Dialog.Panel className="w-full max-w-lg rounded-lg bg-white p-6 shadow-xl border border-gray-200">
          <Dialog.Title className="text-lg font-semibold text-purple-700 mb-3">
            üì® Sent Message Preview
          </Dialog.Title>

          <div className="text-sm bg-gray-50 p-4 border rounded-md whitespace-pre-wrap text-gray-800 mb-4">
            {messageLog.finalMessage || "No message available"}
          </div>

          <div className="text-xs text-gray-500 space-y-1">
            <p>
              <strong>Channel:</strong> {messageLog.sourceChannel || "-"}
            </p>
            <p>
              <strong>Sent At:</strong>{" "}
              {messageLog.sentAt
                ? new Date(messageLog.sentAt).toLocaleString()
                : "-"}
            </p>
            {messageLog.clickType && (
              <p>
                <strong>Click Type:</strong> {messageLog.clickType}
              </p>
            )}
          </div>

          <div className="mt-5 text-right">
            <button
              onClick={onClose}
              className="px-4 py-2 text-sm bg-purple-600 text-white rounded hover:bg-purple-700"
            >
              Close
            </button>
          </div>
        </Dialog.Panel>
      </div>
    </Dialog>
  );
};

export default MessagePreviewModal;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\components\RecipientsListPage.jsx 
====================================================== 
 
// ‚úÖ File: src/pages/Campaigns/RecipientsListPage.jsx
import React, { useCallback, useEffect, useMemo, useState } from "react";
import { useParams, useNavigate } from "react-router-dom";
import axiosClient from "../../../api/axiosClient";
import { toast } from "react-toastify";

function RecipientsListPage() {
  const { id } = useParams(); // campaignId
  const navigate = useNavigate();

  const [recipients, setRecipients] = useState([]);
  const [loading, setLoading] = useState(true);
  const [removingId, setRemovingId] = useState(null);

  const [q, setQ] = useState("");
  const [sort, setSort] = useState("name");
  const [selected, setSelected] = useState(new Set());

  const [page, setPage] = useState(1);
  const pageSize = 12;

  const fetchRecipients = useCallback(async () => {
    setLoading(true);
    try {
      const res = await axiosClient.get(`/campaign/recipients/${id}`);
      setRecipients(res.data || []);
    } catch (err) {
      console.error("‚ùå Load recipients failed:", err);
      toast.error("Failed to load assigned recipients");
    } finally {
      setLoading(false);
    }
  }, [id]);

  useEffect(() => {
    fetchRecipients();
  }, [fetchRecipients]);

  const filtered = useMemo(() => {
    let list = recipients;
    if (q.trim()) {
      const needle = q.toLowerCase();
      list = list.filter(
        r =>
          r.name?.toLowerCase().includes(needle) ||
          r.phoneNumber?.toLowerCase?.().includes(needle) ||
          r.email?.toLowerCase?.().includes(needle)
      );
    }
    list = [...list].sort((a, b) => {
      if (sort === "name") return (a.name || "").localeCompare(b.name || "");
      if (sort === "phone")
        return (a.phoneNumber || "").localeCompare(b.phoneNumber || "");
      if (sort === "source")
        return (a.leadSource || "").localeCompare(b.leadSource || "");
      return 0;
    });
    return list;
  }, [recipients, q, sort]);

  const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
  const pageData = filtered.slice((page - 1) * pageSize, page * pageSize);

  useEffect(() => {
    setPage(1);
  }, [q, sort]);

  const allChecked =
    pageData.length > 0 && pageData.every(r => selected.has(r.id));
  const indeterminate = !allChecked && pageData.some(r => selected.has(r.id));

  const toggleAll = checked => {
    setSelected(prev => {
      const copy = new Set(prev);
      pageData.forEach(r => (checked ? copy.add(r.id) : copy.delete(r.id)));
      return copy;
    });
  };
  const toggleOne = (checked, id) => {
    setSelected(prev => {
      const copy = new Set(prev);
      if (checked) copy.add(id);
      else copy.delete(id);
      return copy;
    });
  };

  const handleRemove = async contactId => {
    if (!window.confirm("Remove this contact from the campaign?")) return;
    setRemovingId(contactId);
    try {
      await axiosClient.delete(`/campaigns/${id}/recipients/${contactId}`);
      setRecipients(prev => prev.filter(r => r.id !== contactId));
      setSelected(prev => {
        const copy = new Set(prev);
        copy.delete(contactId);
        return copy;
      });
      toast.success("Contact removed");
    } catch {
      toast.error("Failed to remove contact");
    } finally {
      setRemovingId(null);
    }
  };

  const handleBulkRemove = async () => {
    if (selected.size === 0) return;
    if (!window.confirm(`Remove ${selected.size} selected contact(s)?`)) return;
    try {
      await Promise.all(
        [...selected].map(cid =>
          axiosClient.delete(`/campaigns/${id}/recipients/${cid}`)
        )
      );
      setRecipients(prev => prev.filter(r => !selected.has(r.id)));
      setSelected(new Set());
      toast.success("Selected contacts removed");
    } catch {
      toast.error("Failed to remove some contacts");
    }
  };

  const handleExport = () => {
    const rows = [
      ["Name", "Phone", "Email", "Lead Source"],
      ...filtered.map(r => [
        r.name || "",
        r.phoneNumber || "",
        r.email || "",
        r.leadSource || "",
      ]),
    ];
    const csv = rows.map(r => r.join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `Campaign-${id}-Recipients.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  return (
    <div className="mx-auto max-w-7xl px-4 py-6">
      {/* Page Header */}
      <div className="mb-6">
        <button
          onClick={() => navigate("/app/campaigns/template-campaigns-list")}
          className="inline-flex items-center gap-2 text-sm text-gray-600 hover:text-gray-900"
        >
          <svg
            width="18"
            height="18"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              d="M15 19l-7-7 7-7"
            />
          </svg>
          Back
        </button>
        <h1 className="mt-2 text-2xl font-bold text-gray-900">
          Assigned Recipients
          <span className="ml-2 rounded-full bg-gray-100 px-2 py-0.5 text-xs text-gray-600">
            {recipients.length}
          </span>
        </h1>
      </div>

      {/* Toolbar */}
      <div className="mb-4 flex flex-wrap items-center gap-2 justify-between">
        <div className="flex flex-wrap items-center gap-2">
          <input
            value={q}
            onChange={e => setQ(e.target.value)}
            placeholder="Search name, phone, email‚Ä¶"
            className="w-64 rounded-lg border px-3 py-1.5 text-sm focus:ring-2 focus:ring-purple-200 outline-none"
          />
          <select
            value={sort}
            onChange={e => setSort(e.target.value)}
            className="rounded-lg border px-3 py-1.5 text-sm focus:ring-2 focus:ring-purple-200 outline-none"
          >
            <option value="name">Sort: Name</option>
            <option value="phone">Sort: Phone</option>
            <option value="source">Sort: Lead Source</option>
          </select>
        </div>
        <div className="flex items-center gap-2">
          <button
            onClick={handleExport}
            className="rounded-lg border px-3 py-1.5 text-sm text-gray-700 hover:bg-gray-50"
          >
            Export CSV
          </button>
          <button
            onClick={() =>
              navigate(`/app/campaigns/image-campaigns/assign-contacts/${id}`)
            }
            className="rounded-lg bg-purple-600 px-3 py-1.5 text-sm font-semibold text-white hover:bg-purple-700"
          >
            Assign Contacts
          </button>
          <button
            disabled={selected.size === 0}
            onClick={handleBulkRemove}
            className={`rounded-lg px-3 py-1.5 text-sm font-semibold ${
              selected.size === 0
                ? "bg-gray-200 text-gray-400 cursor-not-allowed"
                : "bg-red-600 text-white hover:bg-red-700"
            }`}
          >
            Remove Selected
          </button>
        </div>
      </div>

      {/* Table */}
      <div className="overflow-hidden rounded-xl border bg-white shadow-sm">
        {loading ? (
          <div className="p-6 grid gap-3 animate-pulse">
            {[...Array(6)].map((_, i) => (
              <div key={i} className="h-10 rounded bg-gray-100" />
            ))}
          </div>
        ) : filtered.length === 0 ? (
          <div className="p-10 text-center text-gray-500">
            <div className="text-lg font-medium">No recipients</div>
            <p className="mt-1">Assign contacts to start sending campaigns.</p>
          </div>
        ) : (
          <div className="max-h-[70vh] overflow-auto">
            <table className="w-full text-sm table-fixed">
              {/* Fix column widths so header & rows align perfectly */}
              <colgroup>
                <col style={{ width: 44 }} /> {/* checkbox */}
                <col style={{ width: 64 }} /> {/* # */}
                <col /> {/* Name (flex) */}
                <col style={{ width: 160 }} /> {/* Phone */}
                <col style={{ width: 220 }} /> {/* Email */}
                <col style={{ width: 160 }} /> {/* Lead Source */}
                <col style={{ width: 160 }} /> {/* Actions */}
              </colgroup>

              <thead className="sticky top-0 border-b bg-gray-50 text-gray-700">
                <tr className="text-left">
                  <th className="px-3 py-2 align-middle">
                    <input
                      type="checkbox"
                      checked={allChecked}
                      ref={el => el && (el.indeterminate = indeterminate)}
                      onChange={e => toggleAll(e.target.checked)}
                    />
                  </th>
                  <th className="px-3 py-2 align-middle">#</th>
                  <th className="px-3 py-2 align-middle">Name</th>
                  <th className="px-3 py-2 align-middle">Phone</th>
                  <th className="px-3 py-2 align-middle">Email</th>
                  <th className="px-3 py-2 align-middle">Lead Source</th>
                  <th className="px-3 py-2 align-middle text-right">Actions</th>
                </tr>
              </thead>

              <tbody>
                {pageData.map((c, idx) => (
                  <tr key={c.id} className="border-t hover:bg-gray-50">
                    <td className="px-3 py-2 align-middle">
                      <input
                        type="checkbox"
                        checked={selected.has(c.id)}
                        onChange={e => toggleOne(e.target.checked, c.id)}
                      />
                    </td>

                    <td className="px-3 py-2 align-middle whitespace-nowrap">
                      {(page - 1) * pageSize + idx + 1}
                    </td>

                    {/* Truncate long text so it doesn't push columns */}
                    <td className="px-3 py-2 align-middle">
                      <div className="truncate">{c.name || "‚Äî"}</div>
                    </td>
                    <td className="px-3 py-2 align-middle whitespace-nowrap">
                      {c.phoneNumber || "‚Äî"}
                    </td>
                    <td className="px-3 py-2 align-middle">
                      <div className="truncate">{c.email || "‚Äî"}</div>
                    </td>
                    <td className="px-3 py-2 align-middle">
                      <div className="truncate">{c.leadSource || "‚Äî"}</div>
                    </td>

                    <td className="px-3 py-2 align-middle text-right">
                      <button
                        onClick={() => handleRemove(c.id)}
                        disabled={removingId === c.id}
                        className={`rounded px-2 py-1 text-xs ${
                          removingId === c.id
                            ? "bg-red-200 text-red-700 cursor-not-allowed"
                            : "bg-red-50 text-red-700 hover:bg-red-100"
                        }`}
                      >
                        {removingId === c.id ? "Removing‚Ä¶" : "Remove"}
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>

      {/* Pagination */}
      {filtered.length > pageSize && (
        <div className="mt-4 flex justify-between items-center text-sm text-gray-600">
          <span>
            Showing {(page - 1) * pageSize + 1}‚Äì
            {Math.min(page * pageSize, filtered.length)} of {filtered.length}
          </span>
          <div className="flex items-center gap-2">
            <button
              disabled={page === 1}
              onClick={() => setPage(p => Math.max(1, p - 1))}
              className="px-2 py-1 border rounded disabled:opacity-40"
            >
              ‚Üê Prev
            </button>
            <span>
              Page {page} of {totalPages}
            </span>
            <button
              disabled={page === totalPages}
              onClick={() => setPage(p => Math.min(totalPages, p + 1))}
              className="px-2 py-1 border rounded disabled:opacity-40"
            >
              Next ‚Üí
            </button>
          </div>
        </div>
      )}
    </div>
  );
}

export default RecipientsListPage;

// // ‚úÖ File: src/pages/Campaigns/RecipientsListPage.jsx
// import React, { useEffect, useState } from "react";
// import { useParams, useNavigate } from "react-router-dom";
// import axiosClient from "../../../api/axiosClient";
// import { toast } from "react-toastify";

// function RecipientsListPage() {
//   const { id } = useParams(); // campaignId
//   const navigate = useNavigate();

//   const [recipients, setRecipients] = useState([]);
//   const [loading, setLoading] = useState(true);
//   const [removingId, setRemovingId] = useState(null);

//   // üîÅ Load recipients on mount
//   useEffect(() => {
//     const fetchRecipients = async () => {
//       try {
//         const res = await axiosClient.get(`/campaign/recipients/${id}`);
//         setRecipients(res.data || []);
//       } catch (err) {
//         console.error("‚ùå Failed to load recipients:", err);
//         toast.error("Failed to load assigned recipients");
//       } finally {
//         setLoading(false);
//       }
//     };
//     fetchRecipients();
//   }, [id]);

//   // ‚ùå Handle contact removal
//   const handleRemove = async contactId => {
//     const confirm = window.confirm(
//       "Are you sure you want to remove this contact?"
//     );
//     if (!confirm) return;

//     setRemovingId(contactId);
//     try {
//       await axiosClient.delete(`/campaigns/${id}/recipients/${contactId}`);
//       setRecipients(prev => prev.filter(r => r.id !== contactId));
//       toast.success("Contact removed successfully");
//     } catch (err) {
//       console.error("‚ùå Remove contact failed:", err);
//       toast.error("Failed to remove contact");
//     } finally {
//       setRemovingId(null);
//     }
//   };

//   return (
//     <div className="max-w-5xl mx-auto p-6 bg-white rounded-xl shadow-xl">
//       {/* üîô Back button */}
//       <button
//         onClick={() => navigate("/app/campaigns/template-campaigns-list")}
//         className="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-white border border-purple-100 text-purple-700 font-medium shadow-sm hover:bg-purple-50 hover:text-purple-900 transition-all group"
//       >
//         {/* Left Arrow Icon (Lucide or Heroicons, inline SVG for copy-paste) */}
//         <svg
//           className="w-5 h-5 text-purple-500 group-hover:text-purple-700 transition"
//           fill="none"
//           stroke="currentColor"
//           strokeWidth={2.5}
//           viewBox="0 0 24 24"
//           aria-hidden="true"
//         >
//           <path
//             strokeLinecap="round"
//             strokeLinejoin="round"
//             d="M15.25 19l-7-7 7-7"
//           />
//         </svg>
//         <span>Back</span>
//       </button>

//       <h2 className="text-2xl font-bold text-purple-700 mb-4">
//         üìã Assigned Recipients
//       </h2>

//       {loading ? (
//         <p>Loading...</p>
//       ) : recipients.length === 0 ? (
//         <div className="text-gray-500">
//           <p>No contacts have been assigned to this campaign.</p>
//           <button
//             onClick={() =>
//               navigate(`/app/campaigns/image-campaigns/assign-contacts/${id}`)
//             }
//             className="mt-4 px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition"
//           >
//             ‚ûï Assign Contacts
//           </button>
//         </div>
//       ) : (
//         <div className="overflow-x-auto">
//           <table className="min-w-full border border-gray-200 text-sm">
//             <thead>
//               <tr className="bg-gray-100 text-left">
//                 <th className="p-2">#</th>
//                 <th className="p-2">Name</th>
//                 <th className="p-2">Phone</th>
//                 <th className="p-2">Email</th>
//                 <th className="p-2">Lead Source</th>
//                 <th className="p-2 text-right">Actions</th>
//               </tr>
//             </thead>
//             <tbody>
//               {recipients.map((contact, idx) => (
//                 <tr
//                   key={contact.id}
//                   className={`border-t ${
//                     idx % 2 === 0 ? "bg-white" : "bg-gray-50"
//                   }`}
//                 >
//                   <td className="p-2">{idx + 1}</td>
//                   <td className="p-2">{contact.name}</td>
//                   <td className="p-2">{contact.phoneNumber}</td>
//                   <td className="p-2">{contact.email || "-"}</td>
//                   <td className="p-2">{contact.leadSource || "-"}</td>
//                   <td className="p-2 text-right">
//                     <button
//                       onClick={() => handleRemove(contact.id)}
//                       disabled={removingId === contact.id}
//                       className={`text-red-600 hover:underline ${
//                         removingId === contact.id
//                           ? "opacity-50 cursor-not-allowed"
//                           : ""
//                       }`}
//                     >
//                       {removingId === contact.id ? "Removing..." : "‚ùå Remove"}
//                     </button>
//                   </td>
//                 </tr>
//               ))}
//             </tbody>
//           </table>
//         </div>
//       )}
//     </div>
//   );
// }

// export default RecipientsListPage;

// // ‚úÖ File: src/pages/Campaigns/RecipientsListPage.jsx
// import React, { useEffect, useState } from "react";
// import { useParams, useNavigate } from "react-router-dom";
// import axiosClient from "../../../api/axiosClient";
// import { toast } from "react-toastify";

// function RecipientsListPage() {
//   const { id } = useParams(); // campaignId
//   const navigate = useNavigate();

//   const [recipients, setRecipients] = useState([]);
//   const [loading, setLoading] = useState(true);
//   const [removingId, setRemovingId] = useState(null);

//   // üîÅ Load recipients on mount
//   useEffect(() => {
//     const fetchRecipients = async () => {
//       try {
//         const res = await axiosClient.get(`/campaign/recipients/${id}`);
//         setRecipients(res.data || []);
//       } catch (err) {
//         console.error("‚ùå Failed to load recipients:", err);
//         toast.error("Failed to load assigned recipients");
//       } finally {
//         setLoading(false);
//       }
//     };
//     fetchRecipients();
//   }, [id]);

//   // ‚ùå Handle contact removal
//   const handleRemove = async contactId => {
//     const confirm = window.confirm(
//       "Are you sure you want to remove this contact?"
//     );
//     if (!confirm) return;

//     setRemovingId(contactId);
//     try {
//       await axiosClient.delete(`/campaigns/${id}/recipients/${contactId}`);
//       setRecipients(prev => prev.filter(r => r.id !== contactId));
//       toast.success("Contact removed successfully");
//     } catch (err) {
//       console.error("‚ùå Remove contact failed:", err);
//       toast.error("Failed to remove contact");
//     } finally {
//       setRemovingId(null);
//     }
//   };

//   return (
//     <div className="max-w-5xl mx-auto p-6 bg-white rounded-xl shadow-xl">
//       {/* üîô Back button */}
//       <button
//         onClick={() => navigate("/app/campaigns/image-campaign-list")}
//         className="text-sm text-purple-600 hover:underline mb-4"
//       >
//         ‚Üê Back to Campaigns
//       </button>

//       <h2 className="text-2xl font-bold text-purple-700 mb-4">
//         üìã Assigned Recipients
//       </h2>

//       {loading ? (
//         <p>Loading...</p>
//       ) : recipients.length === 0 ? (
//         <div className="text-gray-500">
//           <p>No contacts have been assigned to this campaign.</p>
//           <button
//             onClick={() =>
//               navigate(`/app/campaigns/image-campaigns/assign-contacts/${id}`)
//             }
//             className="mt-4 px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition"
//           >
//             ‚ûï Assign Contacts
//           </button>
//         </div>
//       ) : (
//         <div className="overflow-x-auto">
//           <table className="min-w-full border border-gray-200 text-sm">
//             <thead>
//               <tr className="bg-gray-100 text-left">
//                 <th className="p-2">#</th>
//                 <th className="p-2">Name</th>
//                 <th className="p-2">Phone</th>
//                 <th className="p-2">Email</th>
//                 <th className="p-2">Lead Source</th>
//                 <th className="p-2 text-right">Actions</th>
//               </tr>
//             </thead>
//             <tbody>
//               {recipients.map((contact, idx) => (
//                 <tr
//                   key={contact.id}
//                   className={`border-t ${
//                     idx % 2 === 0 ? "bg-white" : "bg-gray-50"
//                   }`}
//                 >
//                   <td className="p-2">{idx + 1}</td>
//                   <td className="p-2">{contact.name}</td>
//                   <td className="p-2">{contact.phoneNumber}</td>
//                   <td className="p-2">{contact.email || "-"}</td>
//                   <td className="p-2">{contact.leadSource || "-"}</td>
//                   <td className="p-2 text-right">
//                     <button
//                       onClick={() => handleRemove(contact.id)}
//                       disabled={removingId === contact.id}
//                       className={`text-red-600 hover:underline ${
//                         removingId === contact.id
//                           ? "opacity-50 cursor-not-allowed"
//                           : ""
//                       }`}
//                     >
//                       {removingId === contact.id ? "Removing..." : "‚ùå Remove"}
//                     </button>
//                   </td>
//                 </tr>
//               ))}
//             </tbody>
//           </table>
//         </div>
//       )}
//     </div>
//   );
// }

// export default RecipientsListPage;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\components\TagFilterDropdown.jsx 
====================================================== 
 
// üìÑ TagFilterDropdown.jsx
import React, { useEffect, useState } from "react";
import Select from "react-select";
import axiosClient from "../../../api/axiosClient";
import { toast } from "react-toastify";

export default function TagFilterDropdown({ selectedTags, onChange }) {
  const [tagOptions, setTagOptions] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchTags = async () => {
      try {
        const res = await axiosClient.get("/tags/get-tags");
        const allTags = Array.isArray(res.data)
          ? res.data
          : res.data?.data || [];

        const options = allTags.map(tag => ({
          label: tag.name,
          value: tag.id,
        }));

        setTagOptions(options);
      } catch (err) {
        console.error("‚ùå Failed to fetch tags:", err);
        toast.error("Failed to load tags");
      } finally {
        setLoading(false);
      }
    };

    fetchTags();
  }, []);

  const handleChange = selected => {
    const tagIds = selected ? selected.map(tag => tag.value) : [];
    onChange(tagIds);
  };

  const selectedOptions = tagOptions.filter(opt =>
    selectedTags.includes(opt.value)
  );

  return (
    <div className="w-full max-w-md">
      <label className="block mb-1 text-sm font-medium text-gray-700">
        üè∑Ô∏è Filter by Tags (All)
      </label>
      <Select
        isMulti
        options={tagOptions}
        value={selectedOptions}
        onChange={handleChange}
        isLoading={loading}
        placeholder="Select tags..."
        className="react-select-container"
        classNamePrefix="react-select"
        noOptionsMessage={() => (loading ? "Loading..." : "No tags available")}
      />
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\components\WhatsAppBubblePreview.jsx 
====================================================== 
 
import React, { useState } from "react";
import { FaGlobe, FaPhone, FaReply } from "react-icons/fa6";
import { buildTrackingUrl } from "../../../utils/buildTrackingUrl";

// ‚úÖ Icon Renderer
const getIconForType = type => {
  const normalized = type?.toLowerCase();
  switch (normalized) {
    case "url":
    case "web":
      return <FaGlobe />;
    case "voice_call":
    case "phone_number":
    case "call":
      return <FaPhone />;
    case "quick_reply":
    case "reply":
      return <FaReply />;
    default:
      return <FaGlobe />;
  }
};

function WhatsAppBubblePreview({
  messageTemplate,
  cta,
  multiButtons = [],
  campaignId,
  messageId,
  contact,
  imageUrl,
  caption,
}) {
  const [imgError, setImgError] = useState(false);

  const getTrackingUrl = button => {
    return buildTrackingUrl({
      businessId: localStorage.getItem("businessId"),
      sourceType: "campaign",
      sourceId: campaignId,
      buttonText: button?.title || button?.buttonText || "Click",
      redirectUrl: button?.value || button?.targetUrl || "",
      messageId,
      contactId: contact?.id,
      contactPhone: contact?.phone,
    });
  };

  return (
    <div className="flex justify-center">
      {/* Mobile Frame */}
      <div
        className="bg-gray-900 rounded-3xl shadow-2xl p-2"
        style={{ width: "320px", height: "600px" }}
      >
        {/* Mobile Status Bar */}
        <div className="bg-black rounded-t-2xl px-4 py-2 flex items-center justify-between text-white text-xs">
          <span className="font-semibold">9:41</span>
          <div className="flex items-center space-x-1">
            <div className="w-4 h-2 bg-white rounded-sm"></div>
            <div className="w-1 h-1 bg-white rounded-full"></div>
          </div>
        </div>

        {/* Mobile Screen */}
        <div className="bg-gray-100 h-full rounded-b-2xl overflow-hidden">
          {/* WhatsApp Header */}
          <div className="bg-green-500 px-4 py-3 flex items-center space-x-3">
            <div className="w-8 h-8 bg-white rounded-full flex items-center justify-center">
              <span className="text-green-500 font-bold text-sm">W</span>
            </div>
            <div>
              <h3 className="text-white font-semibold text-sm">WhatsApp</h3>
              <p className="text-green-100 text-xs">Online</p>
            </div>
          </div>

          {/* Chat Area */}
          <div className="bg-gray-50 h-full p-4 overflow-y-auto">
            {/* WhatsApp Message Bubble */}
            <div className="flex justify-end mb-4">
              <div className="relative bg-green-100 text-gray-800 rounded-2xl rounded-tr-sm p-3 max-w-xs shadow-sm">
                {/* Tail Arrow */}
                <div className="absolute -right-2 top-0 w-0 h-0 border-t-[8px] border-t-transparent border-l-[12px] border-l-green-100 border-b-[8px] border-b-transparent"></div>

                {/* Image Preview */}
                {imageUrl && !imgError ? (
                  <img
                    src={imageUrl}
                    alt="Campaign"
                    onError={() => setImgError(true)}
                    className="rounded-lg mb-2 w-full max-h-32 object-cover"
                  />
                ) : imageUrl ? (
                  <div className="bg-gray-200 text-gray-500 text-xs h-24 flex items-center justify-center mb-2 rounded-lg">
                    Image not available
                  </div>
                ) : null}

                {/* Message Text */}
                {caption && <p className="mb-1 text-sm">{caption}</p>}
                <p className="whitespace-pre-line text-sm">{messageTemplate}</p>

                {/* Multi-CTA Buttons */}
                {multiButtons?.length > 0 && (
                  <div className="mt-3 space-y-1">
                    {multiButtons.slice(0, 3).map((btn, idx) => (
                      <a
                        key={idx}
                        href={getTrackingUrl(btn)}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="flex items-center gap-2 bg-green-500 text-white px-3 py-1.5 rounded-lg shadow-sm hover:bg-green-600 text-xs w-full"
                      >
                        {getIconForType(btn.type || btn.buttonType)}
                        <span className="truncate">
                          {btn.title || btn.buttonText || "Untitled"}
                        </span>
                      </a>
                    ))}
                  </div>
                )}

                {/* Single CTA fallback */}
                {!multiButtons?.length && cta && (
                  <a
                    href={getTrackingUrl({
                      title: cta.buttonText,
                      value: cta.targetUrl,
                      type: cta.ctaType,
                    })}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="mt-2 inline-flex items-center gap-2 bg-green-500 text-white px-3 py-1.5 rounded-lg shadow-sm hover:bg-green-600 text-xs"
                  >
                    {getIconForType(cta.ctaType)}
                    {cta.buttonText}
                  </a>
                )}

                {/* Message Time */}
                <div className="text-right mt-1">
                  <span className="text-xs text-gray-500">9:41 AM</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

export default WhatsAppBubblePreview;

// import React, { useState } from "react";
// import { buildTrackingUrl } from "../../../utils/buildTrackingUrl";
// import { FaGlobe, FaPhone, FaReply } from "react-icons/fa6";

// // ‚úÖ Icon helper
// const getIconForType = type => {
//   const normalized = type?.toLowerCase();
//   switch (normalized) {
//     case "web":
//     case "url":
//       return <FaGlobe />;
//     case "call":
//       return <FaPhone />;
//     case "reply":
//     case "quick_reply":
//       return <FaReply />;
//     default:
//       return <FaGlobe />;
//   }
// };

// function WhatsAppBubblePreview({
//   messageTemplate,
//   cta,
//   multiButtons = [],
//   campaignId,
//   messageId,
//   contact,
//   imageUrl,
//   caption,
// }) {
//   const [imgError, setImgError] = useState(false);

//   // üß† Build tracking URL
//   const getTrackingUrl = button => {
//     return buildTrackingUrl({
//       businessId: localStorage.getItem("businessId"),
//       sourceType: "campaign",
//       sourceId: campaignId,
//       buttonText: button.title || button.buttonText,
//       redirectUrl: button.value || button.targetUrl,
//       messageId,
//       contactId: contact?.id,
//       contactPhone: contact?.phone,
//     });
//   };

//   return (
//     <div className="max-w-md mx-auto bg-white rounded-xl shadow-md p-4">
//       <div className="relative bg-green-50 text-gray-800 rounded-lg p-4 shadow-md w-fit max-w-full">
//         {/* üü¢ Tail */}
//         <div className="absolute -left-3 top-4 w-0 h-0 border-t-[12px] border-t-transparent border-r-[16px] border-r-green-50 border-b-[12px] border-b-transparent"></div>

//         {/* üì∑ Image */}
//         {imageUrl && !imgError ? (
//           <img
//             src={imageUrl}
//             alt="Campaign"
//             onError={() => setImgError(true)}
//             className="rounded-md mb-2 max-h-48 object-cover border"
//           />
//         ) : imageUrl ? (
//           <div className="bg-gray-200 text-gray-500 text-xs h-32 flex items-center justify-center mb-2 rounded-md">
//             Image not available
//           </div>
//         ) : null}

//         {/* üìù Text */}
//         {caption && <p className="mb-1">{caption}</p>}
//         <p className="whitespace-pre-line">{messageTemplate}</p>

//         {/* üîò Multiple CTA Buttons */}
//         {multiButtons?.length > 0 && (
//           <div className="mt-4 space-y-2">
//             {multiButtons.slice(0, 3).map((btn, idx) => (
//               <a
//                 key={idx}
//                 href={getTrackingUrl(btn)}
//                 target="_blank"
//                 rel="noopener noreferrer"
//                 className="flex items-center gap-2 bg-green-500 text-white px-4 py-2 rounded shadow hover:bg-green-600 text-sm"
//               >
//                 {getIconForType(btn.type || btn.buttonType)}
//                 {btn.title || btn.buttonText || "Untitled"}
//               </a>
//             ))}
//           </div>
//         )}

//         {/* üîò Fallback Single CTA */}
//         {!multiButtons?.length && cta && (
//           <a
//             href={getTrackingUrl({
//               title: cta.buttonText,
//               value: cta.targetUrl,
//               type: cta.ctaType,
//             })}
//             target="_blank"
//             rel="noopener noreferrer"
//             className="mt-3 inline-flex items-center gap-2 bg-green-500 text-white px-4 py-2 rounded shadow hover:bg-green-600 text-sm"
//           >
//             {getIconForType(cta.ctaType)}
//             {cta.buttonText}
//           </a>
//         )}
//       </div>
//     </div>
//   );
// }

// export default WhatsAppBubblePreview;

// import React, { useState } from "react";
// import { buildTrackingUrl } from "../../../utils/buildTrackingUrl";
// import { FaGlobe, FaPhone, FaReply } from "react-icons/fa6";

// // ‚úÖ Icon helper
// const getIconForType = type => {
//   switch (type?.toLowerCase()) {
//     case "web":
//     case "url":
//       return <FaGlobe />;
//     case "call":
//       return <FaPhone />;
//     case "reply":
//     case "quick_reply":
//       return <FaReply />;
//     default:
//       return <FaGlobe />;
//   }
// };

// function WhatsAppBubblePreview({
//   messageTemplate,
//   cta,
//   multiButtons = [], // ‚úÖ Accepts multiple buttons
//   campaignId,
//   messageId,
//   contact,
//   imageUrl,
//   caption,
// }) {
//   const [imgError, setImgError] = useState(false);

//   // üß† Build tracking URL for each button
//   const getTrackingUrl = button => {
//     return buildTrackingUrl({
//       businessId: localStorage.getItem("businessId"),
//       sourceType: "campaign",
//       sourceId: campaignId,
//       buttonText: button.title,
//       redirectUrl: button.value,
//       messageId,
//       contactId: contact?.id,
//       contactPhone: contact?.phone,
//     });
//   };

//   return (
//     <div className="max-w-md mx-auto bg-white rounded-xl shadow-md p-4">
//       {/* üßæ WhatsApp-like bubble */}
//       <div className="relative bg-green-50 text-gray-800 rounded-lg p-4 shadow-md w-fit max-w-full">
//         {/* üü¢ Tail */}
//         <div className="absolute -left-3 top-4 w-0 h-0 border-t-[12px] border-t-transparent border-r-[16px] border-r-green-50 border-b-[12px] border-b-transparent"></div>

//         {/* üì∑ Image Preview */}
//         {imageUrl && !imgError ? (
//           <img
//             src={imageUrl}
//             alt="Campaign"
//             onError={() => setImgError(true)}
//             className="rounded-md mb-2 max-h-48 object-cover border"
//           />
//         ) : imageUrl ? (
//           <div className="bg-gray-200 text-gray-500 text-xs h-32 flex items-center justify-center mb-2 rounded-md">
//             Image not available
//           </div>
//         ) : null}

//         {/* üìù Message */}
//         {caption && <p className="mb-1">{caption}</p>}
//         <p className="whitespace-pre-line">{messageTemplate}</p>

//         {/* üîò Multiple CTA Buttons */}
//         {multiButtons?.length > 0 && (
//           <div className="mt-4 space-y-2">
//             {multiButtons.slice(0, 3).map((btn, idx) => (
//               <a
//                 key={idx}
//                 href={getTrackingUrl(btn)}
//                 target="_blank"
//                 rel="noopener noreferrer"
//                 className="flex items-center gap-2 bg-green-500 text-white px-4 py-2 rounded shadow hover:bg-green-600 text-sm"
//               >
//                 {getIconForType(btn.type)}
//                 {btn.title}
//               </a>
//             ))}
//           </div>
//         )}

//         {/* üîò Fallback single CTA (optional) */}
//         {!multiButtons?.length && cta && (
//           <a
//             href={getTrackingUrl({
//               title: cta.buttonText,
//               value: cta.targetUrl,
//               type: cta.ctaType,
//             })}
//             target="_blank"
//             rel="noopener noreferrer"
//             className="mt-3 inline-flex items-center gap-2 bg-green-500 text-white px-4 py-2 rounded shadow hover:bg-green-600 text-sm"
//           >
//             {getIconForType(cta.ctaType)}
//             {cta.buttonText}
//           </a>
//         )}
//       </div>
//     </div>
//   );
// }

// export default WhatsAppBubblePreview;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\components\Dashboard\CampaignStatsWidget.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
  CardDescription,
} from "@/components/ui/card";
import { getCampaignStatusDashboard } from "@/api/dashboardService";
import {
  PieChart,
  Pie,
  Cell,
  ResponsiveContainer,
  Tooltip,
  Legend,
} from "recharts";
import StatCard from "@/components/StatCard";
import Spinner from "@/components/Spinner";

// A small utility to prevent labels from cluttering the chart on small slices
const RADIAN = Math.PI / 180;
const renderCustomizedLabel = ({
  cx,
  cy,
  midAngle,
  innerRadius,
  outerRadius,
  percent,
}) => {
  const radius = innerRadius + (outerRadius - innerRadius) * 0.6;
  const x = cx + radius * Math.cos(-midAngle * RADIAN);
  const y = cy + radius * Math.sin(-midAngle * RADIAN);

  // Don't render a label if the slice is less than 5%
  if (percent < 0.05) {
    return null;
  }

  return (
    <text
      x={x}
      y={y}
      fill="white"
      textAnchor={x > cx ? "start" : "end"}
      dominantBaseline="central"
      className="text-xs font-bold"
    >
      {`${(percent * 100).toFixed(0)}%`}
    </text>
  );
};

export default function CampaignStatsWidget() {
  const [stats, setStats] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchStats = async () => {
      try {
        setLoading(true);
        const response = await getCampaignStatusDashboard();
        setStats(response.data);
      } catch (err) {
        setError("Failed to load campaign stats.");
        console.error(err);
      } finally {
        setLoading(false);
      }
    };

    fetchStats();
  }, []);

  const renderContent = () => {
    if (loading) {
      return (
        <div className="flex justify-center items-center h-60">
          <Spinner />
        </div>
      );
    }

    if (error) {
      return (
        <div className="flex justify-center items-center h-60">
          <p className="text-red-500">{error}</p>
        </div>
      );
    }

    if (!stats || stats.totalSent === 0) {
      return (
        <div className="flex justify-center items-center h-60">
          <p className="text-gray-500">
            Send your first campaign to see stats here.
          </p>
        </div>
      );
    }

    const chartData = [
      { name: "Read", value: stats.totalRead },
      {
        name: "Delivered (Not Read)",
        value: stats.totalDelivered - stats.totalRead,
      },
    ];

    const COLORS = ["#0088FE", "#FFBB28"];

    return (
      <div>
        <div className="grid grid-cols-2 gap-4 mb-6">
          <StatCard title="Total Sent" value={stats.totalSent} />
          <StatCard
            title="Failed"
            value={stats.totalFailed}
            valueClassName="text-red-500"
          />
        </div>
        <div style={{ width: "100%", height: 200 }}>
          <ResponsiveContainer>
            <PieChart>
              <Pie
                data={chartData}
                cx="50%"
                cy="50%"
                labelLine={false}
                label={renderCustomizedLabel}
                outerRadius={90}
                fill="#8884d8"
                dataKey="value"
                stroke="none"
              >
                {chartData.map((entry, index) => (
                  <Cell
                    key={`cell-${index}`}
                    fill={COLORS[index % COLORS.length]}
                  />
                ))}
              </Pie>
              <Tooltip formatter={(value, name) => [value, name]} />
              <Legend />
            </PieChart>
          </ResponsiveContainer>
        </div>
      </div>
    );
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>Campaign Performance</CardTitle>
        <CardDescription>Stats from all campaigns sent.</CardDescription>
      </CardHeader>
      <CardContent>{renderContent()}</CardContent>
    </Card>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\components\Dashboard\CrmGrowthWidget.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
  CardDescription,
} from "@/components/ui/card";
import { getCrmSummary, getCrmContactTrends } from "@/api/dashboardService";
import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  Legend,
} from "recharts";
import StatCard from "@/components/StatCard";
import Spinner from "@/components/Spinner";

export default function CrmGrowthWidget() {
  const [summary, setSummary] = useState(null);
  const [trends, setTrends] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchAllData = async () => {
      try {
        setLoading(true);
        // Fetch summary and trends data concurrently for better performance
        const [summaryResponse, trendsResponse] = await Promise.all([
          getCrmSummary(),
          getCrmContactTrends(),
        ]);

        setSummary(summaryResponse.data);

        // Format the date for the chart to be more readable
        const formattedTrends = trendsResponse.data.map(item => ({
          ...item,
          date: new Date(item.date).toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
          }),
        }));
        setTrends(formattedTrends);
      } catch (err) {
        setError("Failed to load CRM stats.");
        console.error(err);
      } finally {
        setLoading(false);
      }
    };

    fetchAllData();
  }, []);

  const renderContent = () => {
    if (loading) {
      return (
        <div className="flex justify-center items-center h-60">
          <Spinner />
        </div>
      );
    }

    if (error) {
      return (
        <div className="flex justify-center items-center h-60">
          <p className="text-red-500">{error}</p>
        </div>
      );
    }

    if (!summary || summary.totalContacts === 0) {
      return (
        <div className="flex justify-center items-center h-60">
          <p className="text-gray-500">
            Add your first contact to see stats here.
          </p>
        </div>
      );
    }

    return (
      <div>
        <div className="grid grid-cols-2 gap-4 mb-6">
          <StatCard title="Total Contacts" value={summary.totalContacts} />
          <StatCard
            title="New (Last 30d)"
            value={summary.newContactsLast30Days}
            valueClassName="text-green-600"
          />
        </div>
        <div style={{ width: "100%", height: 200 }}>
          <ResponsiveContainer>
            <LineChart
              data={trends}
              margin={{ top: 5, right: 20, left: -10, bottom: 5 }}
            >
              <CartesianGrid strokeDasharray="3 3" stroke="#e0e0e0" />
              <XAxis dataKey="date" tick={{ fontSize: 12 }} stroke="#666" />
              <YAxis allowDecimals={false} stroke="#666" />
              <Tooltip
                contentStyle={{
                  borderRadius: "0.5rem",
                  boxShadow:
                    "0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1)",
                  border: "1px solid #e2e8f0",
                }}
              />
              <Legend />
              <Line
                type="monotone"
                dataKey="newContacts"
                name="New Contacts"
                stroke="#10b981"
                strokeWidth={2}
                dot={{ r: 3 }}
                activeDot={{ r: 5 }}
              />
            </LineChart>
          </ResponsiveContainer>
        </div>
      </div>
    );
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>Contact Growth</CardTitle>
        <CardDescription>
          Audience growth over the last 30 days.
        </CardDescription>
      </CardHeader>
      <CardContent>{renderContent()}</CardContent>
    </Card>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\components\Dashboard\QuickActionsWidget.jsx 
====================================================== 
 
import React from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { PlusCircle, UserPlus, MessageSquare } from "lucide-react";
import { Link } from "react-router-dom";

export default function QuickActionsWidget() {
  const actions = [
    {
      label: "New Campaign",
      icon: <PlusCircle className="h-5 w-5 mr-2" />,
      path: "/campaigns/new",
      className: "bg-blue-500 hover:bg-blue-600 text-white",
    },
    {
      label: "Add Contact",
      icon: <UserPlus className="h-5 w-5 mr-2" />,
      path: "/contacts",
      className: "bg-green-500 hover:bg-green-600 text-white",
    },
    {
      label: "Go to Inbox",
      icon: <MessageSquare className="h-5 w-5 mr-2" />,
      path: "/inbox",
      className: "bg-purple-500 hover:bg-purple-600 text-white",
    },
  ];

  return (
    <Card className="col-span-1 lg:col-span-2">
      <CardContent className="p-6">
        <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
          {actions.map(action => (
            <Link to={action.path} key={action.label} className="no-underline">
              <Button
                size="lg"
                className={`w-full h-16 text-md font-semibold ${action.className}`}
              >
                {action.icon}
                {action.label}
              </Button>
            </Link>
          ))}
        </div>
      </CardContent>
    </Card>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\components\Dashboard\TopCampaignsWidget.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
  CardDescription,
} from "@/components/ui/card";
import { getTopCampaigns } from "@/api/dashboardService";
import Spinner from "@/components/Spinner";
import { Link } from "react-router-dom";
import { Badge } from "@/components/ui/badge"; // A standard ShadCN UI component

export default function TopCampaignsWidget() {
  const [campaigns, setCampaigns] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchTopCampaigns = async () => {
      try {
        setLoading(true);
        // We already created this service function in a previous step
        const response = await getTopCampaigns(5); // Fetch top 5
        setCampaigns(response.data);
      } catch (err) {
        setError("Failed to load top campaigns.");
        console.error(err);
      } finally {
        setLoading(false);
      }
    };

    fetchTopCampaigns();
  }, []);

  const renderContent = () => {
    if (loading) {
      return (
        <div className="flex justify-center items-center h-48">
          <Spinner />
        </div>
      );
    }

    if (error) {
      return (
        <div className="flex justify-center items-center h-48">
          <p className="text-red-500">{error}</p>
        </div>
      );
    }

    if (campaigns.length === 0) {
      return (
        <div className="flex justify-center items-center h-48">
          <p className="text-gray-500">
            Send a few campaigns to see your top performers here.
          </p>
        </div>
      );
    }

    return (
      <ul className="space-y-3">
        {campaigns.map((campaign, index) => (
          <li key={campaign.campaignId}>
            <Link
              to={`/campaigns/${campaign.campaignId}`}
              className="block p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
            >
              <div className="flex items-center justify-between">
                <div className="flex items-center">
                  <span className="flex items-center justify-center w-7 h-7 mr-4 bg-gray-200 rounded-full font-bold text-gray-600 text-sm">
                    {index + 1}
                  </span>
                  <p className="font-semibold text-gray-800">
                    {campaign.campaignName}
                  </p>
                </div>
                <div className="flex items-center space-x-4">
                  <Badge variant="outline">
                    Read: {campaign.readRate.toFixed(1)}%
                  </Badge>
                  <Badge>CTR: {campaign.clickThroughRate.toFixed(1)}%</Badge>
                </div>
              </div>
            </Link>
          </li>
        ))}
      </ul>
    );
  };

  return (
    <Card className="col-span-1 lg:col-span-2">
      <CardHeader>
        <CardTitle>Top Performing Campaigns</CardTitle>
        <CardDescription>
          Ranked by Click-Through Rate (CTR) from all sent campaigns.
        </CardDescription>
      </CardHeader>
      <CardContent>{renderContent()}</CardContent>
    </Card>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\components\templates\TemplateCard.jsx 
====================================================== 
 
// üìÑ src/pages/campaigns/components/templates/TemplateCard.jsx
import React from "react";
import {
  FaPaperPlane,
  FaRegImage,
  FaRegFileAlt,
  FaEye,
  FaTrash,
  FaCalendarAlt,
  FaClock,
  FaCheckCircle,
  FaExclamationCircle,
  FaPlay,
  FaUserPlus,
  FaList,
} from "react-icons/fa";

/* -------------------------------- helpers -------------------------------- */
function cx(...xs) {
  return xs.filter(Boolean).join(" ");
}

/**
 * Props:
 *  - t: { id, name, kind, recipients, createdAt?, sentAt?, scheduledAt?, status? }
 *  - sending?: boolean
 *  - deleting?: boolean
 *  - onAssign, onViewRecipients, onSend
 *  - onPreview?, onDelete?
 */
export default function TemplateCard({
  t,
  sending = false,
  deleting = false,
  onAssign,
  onViewRecipients,
  onSend,
  onPreview,
  onDelete,
}) {
  const recipients = Number(t?.recipients || 0);
  const canSend = recipients > 0 && !sending;

  // --- Type (Text vs Image)
  const kind = (t?.kind || t?.templateType || t?.type || "")
    .toString()
    .toLowerCase();
  const isImage = kind === "image_header" || kind.includes("image");
  const typeLabel = isImage ? "Image Header" : "Text Only";

  // --- Dates
  const createdAt =
    t?.createdAt || t?.created_on || t?.createdOn || t?.created || null;
  const sentAt =
    t?.sentAt || t?.lastSentAt || t?.dispatchedAt || t?.deliveredAt || null;
  const scheduledAt = t?.scheduledAt || t?.queuedFor || null;

  // --- Status mapping
  const status = (() => {
    const s = (t?.status || "").toString().toLowerCase();
    if (sentAt || s === "sent") return "Sent";
    if (scheduledAt || ["scheduled", "queued", "queue", "pending"].includes(s))
      return "Scheduled";
    return "Not Sent";
  })();

  const statusConfig = {
    Sent: {
      icon: FaCheckCircle,
      color: "text-emerald-700",
      bg: "bg-emerald-50",
      border: "border-emerald-200",
    },
    Scheduled: {
      icon: FaClock,
      color: "text-amber-700",
      bg: "bg-amber-50",
      border: "border-amber-200",
    },
    "Not Sent": {
      icon: FaExclamationCircle,
      color: "text-gray-600",
      bg: "bg-gray-50",
      border: "border-gray-200",
    },
  };

  const currentStatus = statusConfig[status] || statusConfig["Not Sent"];
  const StatusIcon = currentStatus.icon;

  return (
    <article className="group relative flex h-full flex-col overflow-hidden rounded-xl bg-white shadow-sm border border-gray-200 transition-all duration-200 hover:shadow-md hover:border-gray-300">
      {/* Header */}
      <div className="px-6 py-5 border-b border-gray-100">
        <div className="flex items-start justify-between gap-3 mb-3">
          <div className="flex-1 min-w-0">
            <h3 className="text-lg font-semibold text-gray-900 leading-tight line-clamp-2">
              {t?.name || "Untitled Campaign"}
            </h3>
            <div className="mt-2 flex items-center gap-2">
              <span className="inline-flex items-center gap-1.5 rounded-md px-2.5 py-1 text-xs font-medium bg-gray-100 text-gray-700">
                {isImage ? (
                  <FaRegImage className="text-xs" />
                ) : (
                  <FaRegFileAlt className="text-xs" />
                )}
                {typeLabel}
              </span>
            </div>
          </div>

          {/* Small action buttons in header */}
          <div className="flex items-center gap-1">
            {/* Preview button */}
            {onPreview && (
              <button
                onClick={onPreview}
                type="button"
                title="Preview"
                aria-label="Preview"
                className="w-8 h-8 rounded-lg border border-gray-200 bg-white text-gray-600 hover:bg-gray-50 hover:border-gray-300 transition-colors flex items-center justify-center"
              >
                <FaEye className="text-sm" />
              </button>
            )}

            {/* Delete button */}
            {onDelete && (
              <button
                onClick={onDelete}
                type="button"
                title="Delete campaign"
                disabled={deleting}
                className="w-8 h-8 rounded-lg border border-red-200 bg-red-50 text-red-600 hover:bg-red-100 hover:border-red-300 transition-colors flex items-center justify-center disabled:opacity-50"
              >
                <FaTrash className="text-sm" />
              </button>
            )}
          </div>
        </div>

        {/* Status and recipients */}
        <div className="flex items-center justify-between">
          <div
            className={cx(
              "inline-flex items-center gap-2 rounded-md px-3 py-1.5 text-xs font-medium",
              currentStatus.bg,
              currentStatus.color,
              currentStatus.border,
              "border"
            )}
          >
            <StatusIcon className="text-xs" />
            {status}
          </div>

          <div className="text-right">
            <div className="text-2xl font-bold text-gray-900">{recipients}</div>
            <div className="text-xs text-gray-500 font-medium">Recipients</div>
          </div>
        </div>
      </div>

      {/* Content area */}
      <div className="flex-1 px-6 py-5">
        {/* Stats */}
        <div className="space-y-3">
          <div className="flex items-center justify-between py-2 border-b border-gray-100">
            <div className="flex items-center gap-2 text-gray-600">
              <FaCalendarAlt className="text-xs" />
              <span className="text-xs font-medium">Created</span>
            </div>
            <div className="text-sm font-medium text-gray-900">
              {createdAt ? new Date(createdAt).toLocaleDateString() : "‚Äî"}
            </div>
          </div>

          <div className="flex items-center justify-between py-2">
            <div className="flex items-center gap-2 text-gray-600">
              <FaPaperPlane className="text-xs" />
              <span className="text-xs font-medium">Last Sent</span>
            </div>
            <div className="text-sm font-medium text-gray-900">
              {sentAt ? new Date(sentAt).toLocaleDateString() : "‚Äî"}
            </div>
          </div>
        </div>
      </div>

      {/* Secondary actions - just above footer */}
      <div className="px-6 py-3 border-t border-gray-100 bg-gray-50">
        <div className="grid grid-cols-2 gap-2">
          <button
            className="flex items-center justify-center gap-2 rounded-lg border border-gray-200 bg-white px-3 py-2 text-xs font-medium text-gray-700 hover:bg-gray-50 hover:border-gray-300 transition-colors"
            onClick={onAssign}
            type="button"
            title="Assign recipients"
          >
            <FaUserPlus className="text-xs" />
            Assign Recipients
          </button>

          <button
            className="flex items-center justify-center gap-2 rounded-lg border border-gray-200 bg-white px-3 py-2 text-xs font-medium text-gray-700 hover:bg-gray-50 hover:border-gray-300 transition-colors"
            onClick={onViewRecipients}
            type="button"
            title="View recipients"
          >
            <FaList className="text-xs" />
            View Recipients
          </button>
        </div>
      </div>

      {/* Footer with Send Campaign button */}
      <div className="px-6 py-4 border-t border-gray-200 bg-gray-100">
        <button
          className={cx(
            "w-full flex items-center justify-center gap-2 rounded-lg px-4 py-3 text-sm font-semibold transition-colors",
            canSend
              ? "bg-gradient-to-r from-emerald-500 to-emerald-600 text-white hover:from-emerald-600 hover:to-emerald-700 shadow-lg hover:shadow-emerald-200"
              : "bg-gray-100 text-gray-400 cursor-not-allowed"
          )}
          disabled={!canSend || sending}
          onClick={onSend}
          type="button"
          title={canSend ? "Send campaign" : "Add recipients first"}
          aria-label="Send campaign"
        >
          {sending ? (
            <>
              <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
              Sending...
            </>
          ) : (
            <>
              <FaPlay className="text-sm" />
              Send Campaign
            </>
          )}
        </button>
      </div>
    </article>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\steps\StepCampaignDetails.jsx 
====================================================== 
 
import React, { useState } from "react";
import axiosClient from "../../../api/axiosClient";
import { toast } from "react-toastify";

function StepCampaignDetails({
  templateId,
  message,
  contactIds,
  campaignName,
  scheduledAt,
  onChange,
  onBack,
  onSubmitSuccess,
}) {
  const [submitting, setSubmitting] = useState(false);

  const handleLaunch = async () => {
    if (!campaignName || !templateId || !message || contactIds.length === 0) {
      toast.warn("‚ö†Ô∏è All fields are required (template, contacts, name).");
      return;
    }

    const payload = {
      name: campaignName,
      messageTemplate: message,
      templateId,
      contactIds,
      scheduledAt: scheduledAt || null,
    };

    try {
      setSubmitting(true);
      await axiosClient.post("/campaign", payload); // <-- Removed unused `res`
      toast.success("üöÄ Campaign launched successfully!");
      onSubmitSuccess(); // Redirect or reset parent
    } catch (err) {
      toast.error("‚ùå Failed to launch campaign");
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <div className="bg-white p-6 rounded shadow space-y-4">
      <h2 className="text-xl font-semibold text-purple-700">
        üöÄ Step 3: Campaign Details
      </h2>

      {/* Campaign Name */}
      <label className="block text-sm font-medium text-gray-700">
        Campaign Name
      </label>
      <input
        type="text"
        value={campaignName}
        onChange={e => onChange({ campaignName: e.target.value })}
        className="border rounded px-3 py-2 w-full"
        placeholder="Diwali Promotion Blast"
      />

      {/* Schedule Date */}
      <label className="block text-sm font-medium text-gray-700">
        Schedule (Optional)
      </label>
      <input
        type="datetime-local"
        value={scheduledAt}
        onChange={e => onChange({ scheduledAt: e.target.value })}
        className="border rounded px-3 py-2 w-full"
      />
      <div className="text-xs text-gray-500">
        If not set, the campaign will be sent immediately.
      </div>

      {/* Action Buttons */}
      <div className="flex justify-between mt-4">
        <button
          onClick={onBack}
          className="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200"
        >
          ‚Üê Back
        </button>
        <button
          disabled={submitting}
          onClick={handleLaunch}
          className={`px-4 py-2 text-sm text-white rounded ${
            submitting
              ? "bg-gray-400 cursor-not-allowed"
              : "bg-purple-600 hover:bg-purple-700"
          }`}
        >
          üöÄ Launch Campaign
        </button>
      </div>
    </div>
  );
}

export default StepCampaignDetails;

// import React, { useState } from "react";
// import axiosClient from "../../../api/axiosClient";
// import { toast } from "react-toastify";

// function StepCampaignDetails({
//   templateId,
//   message,
//   contactIds,
//   campaignName,
//   scheduledAt,
//   onChange,
//   onBack,
//   onSubmitSuccess,
// }) {
//   const [submitting, setSubmitting] = useState(false);

//   const handleLaunch = async () => {
//     if (!campaignName || !templateId || !message || contactIds.length === 0) {
//       toast.warn("‚ö†Ô∏è All fields are required (template, contacts, name).");
//       return;
//     }

//     const payload = {
//       name: campaignName,
//       messageTemplate: message,
//       templateId,
//       contactIds,
//       scheduledAt: scheduledAt || null,
//     };

//     try {
//       setSubmitting(true);
//       const res = await axiosClient.post("/campaign", payload);
//       toast.success("üöÄ Campaign launched successfully!");
//       onSubmitSuccess(); // Redirect or reset parent
//     } catch (err) {
//       toast.error("‚ùå Failed to launch campaign");
//     } finally {
//       setSubmitting(false);
//     }
//   };

//   return (
//     <div className="bg-white p-6 rounded shadow space-y-4">
//       <h2 className="text-xl font-semibold text-purple-700">
//         üöÄ Step 3: Campaign Details
//       </h2>

//       {/* Campaign Name */}
//       <label className="block text-sm font-medium text-gray-700">
//         Campaign Name
//       </label>
//       <input
//         type="text"
//         value={campaignName}
//         onChange={e => onChange({ campaignName: e.target.value })}
//         className="border rounded px-3 py-2 w-full"
//         placeholder="Diwali Promotion Blast"
//       />

//       {/* Schedule Date */}
//       <label className="block text-sm font-medium text-gray-700">
//         Schedule (Optional)
//       </label>
//       <input
//         type="datetime-local"
//         value={scheduledAt}
//         onChange={e => onChange({ scheduledAt: e.target.value })}
//         className="border rounded px-3 py-2 w-full"
//       />
//       <div className="text-xs text-gray-500">
//         If not set, the campaign will be sent immediately.
//       </div>

//       {/* Action Buttons */}
//       <div className="flex justify-between mt-4">
//         <button
//           onClick={onBack}
//           className="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200"
//         >
//           ‚Üê Back
//         </button>
//         <button
//           disabled={submitting}
//           onClick={handleLaunch}
//           className={`px-4 py-2 text-sm text-white rounded ${
//             submitting
//               ? "bg-gray-400 cursor-not-allowed"
//               : "bg-purple-600 hover:bg-purple-700"
//           }`}
//         >
//           üöÄ Launch Campaign
//         </button>
//       </div>
//     </div>
//   );
// }

// export default StepCampaignDetails;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\steps\StepContactSelect.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../../api/axiosClient";
import { toast } from "react-toastify";

function StepContactSelect({ selectedContactIds = [], onChange }) {
  const [contacts, setContacts] = useState([]);
  const [loading, setLoading] = useState(true);

  // üß† Fetch all contacts with tags
  const fetchContacts = async () => {
    try {
      const res = await axiosClient.get("/contacts");
      setContacts(res.data || []);
    } catch (err) {
      toast.error("‚ùå Failed to load contacts");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchContacts();
  }, []);

  const isSelected = id => selectedContactIds.includes(id);

  const toggleContact = id => {
    if (isSelected(id)) {
      onChange(selectedContactIds.filter(cid => cid !== id));
    } else {
      onChange([...selectedContactIds, id]);
    }
  };

  const handleSelectAll = () => {
    const allIds = contacts.map(c => c.id);
    onChange(allIds);
  };

  const handleDeselectAll = () => {
    onChange([]);
  };

  return (
    <div className="bg-white p-6 rounded shadow space-y-4">
      <h2 className="text-xl font-semibold text-purple-700">
        üë• Step 2: Select Contacts
      </h2>

      {loading ? (
        <p>‚è≥ Loading contacts...</p>
      ) : contacts.length === 0 ? (
        <p className="text-gray-500">üö´ No contacts available.</p>
      ) : (
        <>
          <div className="flex gap-4 mb-2">
            <button
              onClick={handleSelectAll}
              className="px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm"
            >
              ‚úÖ Select All
            </button>
            <button
              onClick={handleDeselectAll}
              className="px-3 py-1 bg-gray-100 text-gray-600 rounded text-sm"
            >
              ‚ùå Deselect All
            </button>
            <span className="text-sm text-gray-500">
              Selected: {selectedContactIds.length}
            </span>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-[350px] overflow-y-auto border rounded p-2">
            {contacts.map(contact => (
              <div
                key={contact.id}
                className="p-2 rounded border hover:bg-gray-50 transition"
              >
                <label className="flex items-center gap-2 text-sm text-gray-700 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={isSelected(contact.id)}
                    onChange={() => toggleContact(contact.id)}
                  />
                  {contact.name} ({contact.phoneNumber})
                </label>

                {/* üè∑Ô∏è Tag chips display */}
                {contact.tags && contact.tags.length > 0 && (
                  <div className="mt-1 flex flex-wrap gap-1 pl-6">
                    {contact.tags.map(tag => (
                      <span
                        key={tag.id}
                        className="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full"
                      >
                        {tag.name}
                      </span>
                    ))}
                  </div>
                )}
              </div>
            ))}
          </div>
        </>
      )}
    </div>
  );
}

export default StepContactSelect;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\steps\StepTemplateSelect.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../../api/axiosClient";
import { toast } from "react-toastify";

function StepTemplateSelect({ selectedTemplateId, message, onChange }) {
  const [templates, setTemplates] = useState([]);
  const [loading, setLoading] = useState(true);

  // ‚úÖ Fetch templates safely
  useEffect(() => {
    const fetchTemplates = async () => {
      try {
        const res = await axiosClient.get("/whatsapp/templates");

        const data = res.data;
        if (data.success && Array.isArray(data.templates)) {
          setTemplates(data.templates);
        } else {
          toast.error("‚ö†Ô∏è Failed to load templates (invalid format)");
          setTemplates([]);
        }
      } catch (err) {
        toast.error("‚ùå Error loading templates");
        setTemplates([]);
      } finally {
        setLoading(false);
      }
    };

    fetchTemplates();
  }, []);

  // ‚úÖ Handle dropdown change
  const handleTemplateChange = e => {
    const selectedId = e.target.value;
    const selected = templates.find(t => t.name === selectedId); // Match by name
    onChange({
      templateId: selectedId,
      message: selected ? selected.body : "",
    });
  };

  return (
    <div className="bg-white p-6 rounded shadow space-y-4">
      <h2 className="text-xl font-semibold text-purple-700">
        üßæ Step 1: Choose Approved Template
      </h2>

      {/* Dropdown */}
      {loading ? (
        <p>Loading templates...</p>
      ) : (
        <select
          value={selectedTemplateId || ""}
          onChange={handleTemplateChange}
          className="border rounded px-3 py-2 w-full"
        >
          <option value="">-- Select Template --</option>
          {templates.map(t => (
            <option key={t.name} value={t.name}>
              {t.name}
            </option>
          ))}
        </select>
      )}

      {/* Message Preview / Editor */}
      <label className="block text-sm font-medium text-gray-700">
        ‚úçÔ∏è Message Body (Editable)
      </label>
      <textarea
        rows={5}
        value={message}
        onChange={e => onChange({ message: e.target.value })}
        className="border rounded w-full px-3 py-2"
        placeholder="Hello {name}, your status is {status}."
      />

      <div className="text-xs text-gray-500 mt-1">
        You can use placeholders like <code>{`{name}`}</code> and{" "}
        <code>{`{status}`}</code>.
      </div>
    </div>
  );
}

export default StepTemplateSelect;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\tabs\CampaignInfoTab.jsx 
====================================================== 
 
// ‚úÖ CampaignInfoTab.jsx
import React from "react";

function CampaignInfoTab({ formData, setFormData }) {
  const handleChange = e => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  return (
    <div>
      <h3 className="text-2xl font-semibold mb-4">Campaign Info</h3>

      {/* Campaign Name */}
      <div className="mb-4">
        <label className="block text-sm font-medium mb-1">Campaign Name</label>
        <input
          type="text"
          name="name"
          value={formData.name}
          onChange={handleChange}
          className="w-full border rounded px-4 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
          placeholder="Enter a campaign name"
        />
      </div>

      {/* Campaign Description */}
      <div className="mb-4">
        <label className="block text-sm font-medium mb-1">
          Description (optional)
        </label>
        <textarea
          name="description"
          value={formData.description}
          onChange={handleChange}
          className="w-full border rounded px-4 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
          rows={3}
          placeholder="Add some notes about this campaign"
        />
      </div>
    </div>
  );
}

export default CampaignInfoTab;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\tabs\CTAButtonsTab.jsx 
====================================================== 
 
// ‚úÖ CTAButtonsTab.jsx ‚Äì For text templates
import React from "react";

const maxButtons = 3;

function CTAButtonsTab({ formData, setFormData }) {
  const buttons = formData.multiButtons || [];

  const handleChange = (index, field, value) => {
    const updated = [...buttons];
    updated[index] = { ...updated[index], [field]: value };
    setFormData(prev => ({ ...prev, multiButtons: updated }));
  };

  const addButton = () => {
    if (buttons.length < maxButtons) {
      setFormData(prev => ({
        ...prev,
        multiButtons: [
          ...buttons,
          { buttonText: "", buttonType: "URL", targetUrl: "" },
        ],
      }));
    }
  };

  const removeButton = index => {
    const updated = [...buttons];
    updated.splice(index, 1);
    setFormData(prev => ({ ...prev, multiButtons: updated }));
  };

  return (
    <div>
      <h3 className="text-2xl font-semibold mb-4">CTA Buttons (optional)</h3>

      {buttons.map((btn, i) => (
        <div key={i} className="mb-4 border p-4 rounded shadow-sm">
          <div className="mb-2">
            <label className="block text-sm font-medium mb-1">
              Button Text
            </label>
            <input
              type="text"
              value={btn.buttonText}
              onChange={e => handleChange(i, "buttonText", e.target.value)}
              className="w-full border rounded px-4 py-2"
              placeholder="e.g. Buy Now"
            />
          </div>

          <div className="mb-2">
            <label className="block text-sm font-medium mb-1">
              Button Type
            </label>
            <select
              value={btn.buttonType}
              onChange={e => handleChange(i, "buttonType", e.target.value)}
              className="w-full border rounded px-4 py-2"
            >
              <option value="URL">URL</option>
              <option value="PHONE">Phone</option>
              <option value="QUICK_REPLY">Quick Reply</option>
            </select>
          </div>

          {btn.buttonType !== "QUICK_REPLY" && (
            <div className="mb-2">
              <label className="block text-sm font-medium mb-1">Target</label>
              <input
                type="text"
                value={btn.targetUrl}
                onChange={e => handleChange(i, "targetUrl", e.target.value)}
                className="w-full border rounded px-4 py-2"
                placeholder={
                  btn.buttonType === "URL"
                    ? "https://example.com"
                    : "+919000000000"
                }
              />
            </div>
          )}

          <button
            onClick={() => removeButton(i)}
            className="mt-2 text-red-600 hover:underline text-sm"
          >
            Remove
          </button>
        </div>
      ))}

      {buttons.length < maxButtons && (
        <button
          onClick={addButton}
          className="px-4 py-2 bg-purple-600 text-white rounded shadow"
        >
          + Add Button
        </button>
      )}
    </div>
  );
}

export default CTAButtonsTab;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\tabs\MessageBuilderTab.jsx 
====================================================== 
 
// ‚úÖ MessageBuilderTab.jsx ‚Äî Param fields for Text Template
import React from "react";

function MessageBuilderTab({ formData, setFormData }) {
  const handleParamChange = (index, value) => {
    const updatedParams = [...(formData.templateParams || [])];
    updatedParams[index] = value;
    setFormData(prev => ({
      ...prev,
      templateParams: updatedParams,
    }));
  };

  return (
    <div>
      <h3 className="text-2xl font-semibold mb-4">Template Parameters</h3>

      {/* Only for text templates */}
      {formData.messageType === "text" && (
        <div className="space-y-3">
          {Array.from({ length: 5 }).map((_, i) => (
            <div key={i}>
              <label className="block text-sm font-medium mb-1">
                Param {`{{${i + 1}}}`}
              </label>
              <input
                type="text"
                className="w-full border rounded px-4 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                placeholder={`Enter value for {{${i + 1}}}`}
                value={formData.templateParams?.[i] || ""}
                onChange={e => handleParamChange(i, e.target.value)}
              />
            </div>
          ))}
        </div>
      )}

      {/* Future cases for image, doc can be handled here */}
      {formData.messageType !== "text" && (
        <p className="text-gray-500 italic">
          Builder not implemented for this message type.
        </p>
      )}
    </div>
  );
}

export default MessageBuilderTab;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\tabs\MessageTypeTab.jsx 
====================================================== 
 
import React, { useMemo } from "react";

function MessageBuilderTab({ formData, setFormData }) {
  const { messageType, messageBody = "", templateParams = [] } = formData;

  // ‚úÖ Extract placeholders from message body like {{1}}, {{2}}, ...
  const placeholderIndexes = useMemo(() => {
    const matches = messageBody.match(/{{(\d+)}}/g);
    if (!matches) return [];
    const uniqueIndexes = [
      ...new Set(matches.map(m => Number(m.match(/\d+/)[0]))),
    ];
    return uniqueIndexes.sort((a, b) => a - b);
  }, [messageBody]);

  const handleParamChange = (index, value) => {
    const updated = [...templateParams];
    updated[index - 1] = value; // 1-based placeholders
    setFormData(prev => ({ ...prev, templateParams: updated }));
  };

  return (
    <div className="max-w-xl">
      <h3 className="text-2xl font-semibold mb-4">Fill Template Parameters</h3>

      {messageType !== "text" && (
        <div className="text-gray-500 italic">
          This section is only enabled for text templates right now.
        </div>
      )}

      {messageType === "text" && placeholderIndexes.length === 0 && (
        <div className="text-gray-500 italic">
          No parameters found in the selected template.
        </div>
      )}

      {messageType === "text" && placeholderIndexes.length > 0 && (
        <div className="space-y-4">
          {placeholderIndexes.map(paramNum => (
            <div key={paramNum}>
              <label className="block text-sm font-medium mb-1">
                Value for <span className="font-mono">{`{{${paramNum}}}`}</span>
              </label>

              <input
                type="text"
                value={templateParams[paramNum - 1] || ""}
                onChange={e => handleParamChange(paramNum, e.target.value)}
                placeholder={`Enter value for {{${paramNum}}}`}
                className="w-full border rounded px-4 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
              />
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

export default MessageBuilderTab;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\tabs\PreviewSendTab.jsx 
====================================================== 
 
import React, { useState } from "react";
import axiosClient from "../../../api/axiosClient"; // ‚úÖ Adjust path if needed
import { toast } from "react-toastify";

function PreviewSendTab({ formData }) {
  const [loading, setLoading] = useState(false);

  const {
    templateId,
    templateParams = [],
    multiButtons = [],
    recipientIds = [],
  } = formData;

  // ‚úÖ Check if form is valid
  const isValid =
    templateId &&
    templateParams.some(p => p && p.trim() !== "") &&
    recipientIds.length > 0;

  // üîÅ Sample template message for preview (can be dynamic in future)
  const sampleBody = "Hi {{1}}, your order {{2}} has been confirmed.";
  const previewBody = sampleBody.replace(/{{(\d+)}}/g, (_, i) => {
    return templateParams[i - 1] || `{{${i}}}`;
  });

  const handleSend = async () => {
    try {
      setLoading(true);
      const payload = {
        templateId,
        templateParams,
        multiButtons,
        contactIds: recipientIds,
      };

      // FIX: Remove 'res' if unused
      await axiosClient.post("/api/messageengine/send-text-template", payload);
      toast.success("‚úÖ Campaign sent successfully!");
    } catch (err) {
      console.error(err);
      toast.error("‚ùå Failed to send campaign.");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div>
      <h3 className="text-2xl font-semibold mb-4">Preview & Send</h3>

      <div className="bg-gray-100 border p-4 rounded shadow-md max-w-lg space-y-4">
        <div className="bg-white p-3 rounded-md shadow-sm border">
          <p className="text-sm whitespace-pre-line">{previewBody}</p>
        </div>

        {multiButtons.length > 0 && (
          <div className="flex flex-col gap-2">
            {multiButtons.map((btn, i) => (
              <button
                key={i}
                className="bg-green-500 text-white px-4 py-2 rounded text-sm text-left"
              >
                {btn.buttonText}
              </button>
            ))}
          </div>
        )}
      </div>

      {!isValid && (
        <div className="text-red-500 mt-4">
          ‚ùå Please select a template, fill parameters, and choose at least one
          recipient.
        </div>
      )}

      <div className="mt-6">
        <button
          disabled={!isValid || loading}
          onClick={handleSend}
          className={`px-6 py-2 rounded text-white ${
            isValid
              ? "bg-purple-600 hover:bg-purple-700"
              : "bg-gray-400 cursor-not-allowed"
          }`}
        >
          {loading ? "Sending..." : "Send Campaign"}
        </button>
      </div>
    </div>
  );
}

export default PreviewSendTab;

// import React, { useState } from "react";
// import axiosClient from "../../../api/axiosClient"; // ‚úÖ Adjust path if needed
// import { toast } from "react-toastify";

// function PreviewSendTab({ formData }) {
//   const [loading, setLoading] = useState(false);

//   const {
//     templateId,
//     templateParams = [],
//     multiButtons = [],
//     recipientIds = [],
//   } = formData;

//   // ‚úÖ Check if form is valid
//   const isValid =
//     templateId &&
//     templateParams.some(p => p && p.trim() !== "") &&
//     recipientIds.length > 0;

//   // üîÅ Sample template message for preview (can be dynamic in future)
//   const sampleBody = "Hi {{1}}, your order {{2}} has been confirmed.";
//   const previewBody = sampleBody.replace(/{{(\d+)}}/g, (_, i) => {
//     return templateParams[i - 1] || `{{${i}}}`;
//   });

//   const handleSend = async () => {
//     try {
//       setLoading(true);
//       const payload = {
//         templateId,
//         templateParams,
//         multiButtons,
//         contactIds: recipientIds,
//       };

//       const res = await axiosClient.post(
//         "/api/messageengine/send-text-template",
//         payload
//       );
//       toast.success("‚úÖ Campaign sent successfully!");
//     } catch (err) {
//       console.error(err);
//       toast.error("‚ùå Failed to send campaign.");
//     } finally {
//       setLoading(false);
//     }
//   };

//   return (
//     <div>
//       <h3 className="text-2xl font-semibold mb-4">Preview & Send</h3>

//       <div className="bg-gray-100 border p-4 rounded shadow-md max-w-lg space-y-4">
//         <div className="bg-white p-3 rounded-md shadow-sm border">
//           <p className="text-sm whitespace-pre-line">{previewBody}</p>
//         </div>

//         {multiButtons.length > 0 && (
//           <div className="flex flex-col gap-2">
//             {multiButtons.map((btn, i) => (
//               <button
//                 key={i}
//                 className="bg-green-500 text-white px-4 py-2 rounded text-sm text-left"
//               >
//                 {btn.buttonText}
//               </button>
//             ))}
//           </div>
//         )}
//       </div>

//       {!isValid && (
//         <div className="text-red-500 mt-4">
//           ‚ùå Please select a template, fill parameters, and choose at least one
//           recipient.
//         </div>
//       )}

//       <div className="mt-6">
//         <button
//           disabled={!isValid || loading}
//           onClick={handleSend}
//           className={`px-6 py-2 rounded text-white ${
//             isValid
//               ? "bg-purple-600 hover:bg-purple-700"
//               : "bg-gray-400 cursor-not-allowed"
//           }`}
//         >
//           {loading ? "Sending..." : "Send Campaign"}
//         </button>
//       </div>
//     </div>
//   );
// }

// export default PreviewSendTab;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Campaigns\tabs\RecipientsTab.jsx 
====================================================== 
 
// üìÅ src/pages/Campaigns/tabs/RecipientsTab.jsx
import React from "react";

function RecipientsTab({ formData, setFormData }) {
  return (
    <div>
      <h3 className="text-xl font-semibold mb-4">Recipients</h3>
      <p className="text-gray-600">Recipient selection feature coming soon.</p>
    </div>
  );
}

export default RecipientsTab;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Contacts\ContactForm.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../api/axiosClient"; // Corrected import
import { toast } from "react-toastify";

function ContactForm({ contact, onSaveComplete }) {
  const [formData, setFormData] = useState({
    name: "",
    phoneNumber: "",
    email: "",
    leadSource: "",
    notes: "",
    tags: [], // Array of tag IDs
    // Date fields are handled separately to avoid timezone issues
  });
  const [allTags, setAllTags] = useState([]);
  const [saving, setSaving] = useState(false);

  // Fetch all available tags when the component mounts
  useEffect(() => {
    const fetchTags = async () => {
      try {
        const response = await axiosClient.get("/tags");
        setAllTags(response.data.data || response.data); // Handle wrapper if it exists
      } catch (error) {
        console.error("Failed to load tags:", error);
        toast.error("‚ùå Failed to load tags");
      }
    };
    fetchTags();
  }, []);

  // Populate the form when an existing contact is passed in
  useEffect(() => {
    if (contact) {
      setFormData({
        name: contact.name || "",
        phoneNumber: contact.phoneNumber || "",
        email: contact.email || "",
        leadSource: contact.leadSource || "",
        notes: contact.notes || "",
        tags: contact.tags?.map(t => t.tagId) || [],
      });
    }
  }, [contact]);

  const handleChange = e => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleTagChange = e => {
    const selected = Array.from(e.target.selectedOptions, opt => opt.value);
    setFormData(prev => ({ ...prev, tags: selected }));
  };

  const handleSubmit = async e => {
    e.preventDefault();
    setSaving(true);

    // Backend expects an array of Guids/strings for the tag IDs
    const payload = {
      ...formData,
      tagIds: formData.tags, // Send just the array of IDs
    };

    try {
      if (contact?.id) {
        // Update existing contact
        await axiosClient.put(`/contacts/${contact.id}`, payload);
        toast.success("‚úÖ Contact updated successfully!");
      } else {
        // Create new contact
        await axiosClient.post("/contacts", payload);
        toast.success("‚úÖ Contact created successfully!");
      }
      onSaveComplete?.(); // Notify parent component to refresh/close
    } catch (err) {
      // Display the specific error message from the backend
      const errorMessage =
        err.response?.data?.message || "‚ùå Failed to save contact.";
      toast.error(errorMessage);
      console.error("Save contact failed:", err);
    } finally {
      setSaving(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <input
        name="name"
        value={formData.name}
        onChange={handleChange}
        required
        placeholder="Name"
        className="w-full border px-3 py-2 rounded-md"
      />
      <input
        name="phoneNumber"
        value={formData.phoneNumber}
        onChange={handleChange}
        placeholder="Phone Number"
        className="w-full border px-3 py-2 rounded-md"
      />
      <input
        type="email"
        name="email"
        value={formData.email}
        onChange={handleChange}
        placeholder="Email"
        className="w-full border px-3 py-2 rounded-md"
      />

      <div>
        <label className="text-sm text-gray-600">Tags</label>
        <select
          multiple
          value={formData.tags}
          onChange={handleTagChange}
          className="w-full border px-3 py-2 rounded-md h-24"
        >
          {allTags.map(tag => (
            <option key={tag.id} value={tag.id}>
              {tag.name}
            </option>
          ))}
        </select>
      </div>

      <textarea
        name="notes"
        value={formData.notes}
        onChange={handleChange}
        placeholder="Notes..."
        className="w-full border px-3 py-2 rounded-md"
        rows={3}
      />

      <button
        type="submit"
        disabled={saving}
        className="w-full bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 disabled:bg-purple-300"
      >
        {saving ? "Saving..." : contact?.id ? "Update Contact" : "Add Contact"}
      </button>
    </form>
  );
}

export default ContactForm;

// import React, { useEffect, useState } from "react";
// import axios from "axios";
// import { toast } from "react-toastify";

// function ContactForm({ contact, onSaveComplete }) {
//   const [formData, setFormData] = useState({
//     name: "",
//     phoneNumber: "",
//     email: "",
//     leadSource: "",
//     notes: "",
//     lastContactedAt: "",
//     nextFollowUpAt: "",
//     tags: [], // Now array of tag IDs
//   });

//   const [allTags, setAllTags] = useState([]);

//   useEffect(() => {
//     // Load all tags from DB
//     axios
//       .get("/api/tags")
//       .then(res => setAllTags(res.data))
//       .catch(() => toast.error("‚ùå Failed to load tags"));
//   }, []);

//   useEffect(() => {
//     if (contact) {
//       setFormData({
//         name: contact.name || "",
//         phoneNumber: contact.phoneNumber || "",
//         email: contact.email || "",
//         leadSource: contact.leadSource || "",
//         notes: contact.notes || "",
//         lastContactedAt: contact.lastContactedAt || "",
//         nextFollowUpAt: contact.nextFollowUpAt || "",
//         tags: contact.tags?.map(t => t.tagId) || [],
//       });
//     }
//   }, [contact]);

//   const handleChange = e => {
//     const { name, value } = e.target;
//     setFormData(prev => ({ ...prev, [name]: value }));
//   };

//   const handleTagChange = e => {
//     const selected = Array.from(e.target.selectedOptions, opt => opt.value);
//     setFormData(prev => ({ ...prev, tags: selected }));
//   };

//   const handleSubmit = async e => {
//     e.preventDefault();

//     const mappedTags = formData.tags.map(id => {
//       const tag = allTags.find(t => t.id === id);
//       return { tagId: tag.id, tagName: tag.name };
//     });

//     const payload = {
//       ...formData,
//       tags: mappedTags,
//     };

//     try {
//       if (contact?.id) {
//         await axios.put(`/contacts/${contact.id}`, payload);
//         toast.success("‚úÖ Contact updated");
//       } else {
//         await axios.post("/contacts", payload);
//         toast.success("‚úÖ Contact added");
//       }

//       onSaveComplete?.();
//     } catch (err) {
//       console.error(err);
//       toast.error("‚ùå Failed to save contact");
//     }
//   };

//   return (
//     <form onSubmit={handleSubmit} className="space-y-3">
//       <input
//         name="name"
//         value={formData.name}
//         onChange={handleChange}
//         required
//         placeholder="Name"
//         className="w-full border px-3 py-2 rounded"
//       />
//       <input
//         name="phoneNumber"
//         value={formData.phoneNumber}
//         onChange={handleChange}
//         required
//         placeholder="Phone"
//         className="w-full border px-3 py-2 rounded"
//       />
//       <input
//         name="email"
//         value={formData.email}
//         onChange={handleChange}
//         placeholder="Email"
//         className="w-full border px-3 py-2 rounded"
//       />
//       <input
//         name="leadSource"
//         value={formData.leadSource}
//         onChange={handleChange}
//         placeholder="Lead Source"
//         className="w-full border px-3 py-2 rounded"
//       />

//       {/* ‚úÖ Tag Select */}
//       <select
//         multiple
//         value={formData.tags}
//         onChange={handleTagChange}
//         className="w-full border px-3 py-2 rounded"
//       >
//         {allTags.map(tag => (
//           <option key={tag.id} value={tag.id}>
//             {tag.name}
//           </option>
//         ))}
//       </select>

//       <input
//         type="datetime-local"
//         name="lastContactedAt"
//         value={formData.lastContactedAt}
//         onChange={handleChange}
//         className="w-full border px-3 py-2 rounded"
//       />
//       <input
//         type="datetime-local"
//         name="nextFollowUpAt"
//         value={formData.nextFollowUpAt}
//         onChange={handleChange}
//         className="w-full border px-3 py-2 rounded"
//       />
//       <textarea
//         name="notes"
//         value={formData.notes}
//         onChange={handleChange}
//         placeholder="Notes"
//         className="w-full border px-3 py-2 rounded"
//       />

//       <button
//         type="submit"
//         className="bg-purple-600 text-white px-4 py-2 rounded"
//       >
//         {contact?.id ? "Update Contact" : "Add Contact"}
//       </button>
//     </form>
//   );
// }

// export default ContactForm;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Contacts\ContactList.jsx 
====================================================== 
 
import React from "react";
import { FaEllipsisV } from "react-icons/fa";

function getInitials(name) {
  if (!name) return "";
  const parts = name.trim().split(" ");
  return parts
    .slice(0, 2)
    .map(word => word[0])
    .join("")
    .toUpperCase();
}

export default function ContactList({
  contacts,
  onEdit,
  onDelete,
  onNotes,
  onTimeline,
}) {
  return (
    <div className="overflow-x-auto mt-4 rounded-xl border shadow-sm">
      <table className="min-w-full bg-white">
        <thead className="text-left bg-gray-100 text-sm font-medium">
          <tr>
            <th className="px-4 py-3">Name</th>
            <th className="px-4 py-3">Phone</th>
            <th className="px-4 py-3">Tags</th>
            <th className="px-4 py-3 text-right">Actions</th>
          </tr>
        </thead>
        <tbody className="text-sm">
          {contacts.map(contact => (
            <tr key={contact.id} className="border-t hover:bg-gray-50">
              <td className="px-4 py-3 flex items-center gap-3">
                <div className="w-9 h-9 rounded-full bg-purple-100 text-purple-700 flex items-center justify-center font-bold text-sm shadow-sm">
                  {getInitials(contact.name)}
                </div>
                <span className="font-semibold">{contact.name}</span>
              </td>

              <td className="px-4 py-3 text-gray-700">
                {contact.phoneNumber || (
                  <span className="text-gray-400 italic">No number</span>
                )}
              </td>

              <td className="px-4 py-3">
                <div className="flex flex-wrap gap-1">
                  {(contact.tags ?? contact.contactTags ?? []).length > 0 ? (
                    (contact.tags ?? contact.contactTags).map((tag, index) => (
                      <span
                        key={index}
                        className="px-2 py-0.5 text-xs rounded-full font-medium"
                        style={{
                          backgroundColor: tag.colorHex || "#EEE",
                          color: "#1F2937",
                        }}
                      >
                        {tag.tagName || tag.name}
                      </span>
                    ))
                  ) : (
                    <span className="text-gray-400 text-xs italic">
                      No tags
                    </span>
                  )}
                </div>
              </td>

              <td className="px-4 py-3 text-right relative">
                <DropdownMenu
                  onEdit={() => onEdit(contact)}
                  onDelete={() => onDelete(contact)}
                  onNotes={() => onNotes(contact)}
                  onTimeline={() => onTimeline(contact)}
                />
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}

function DropdownMenu({ onEdit, onDelete, onNotes, onTimeline }) {
  const [open, setOpen] = React.useState(false);

  return (
    <div className="relative inline-block text-left">
      <button
        onClick={() => setOpen(prev => !prev)}
        className="p-2 rounded-full hover:bg-gray-100"
      >
        <FaEllipsisV size={14} />
      </button>

      {open && (
        <div className="absolute right-0 z-10 mt-2 w-40 origin-top-right rounded-md bg-white shadow-lg border">
          <div className="py-1 text-sm text-gray-700">
            <button
              onClick={onEdit}
              className="block w-full px-4 py-2 hover:bg-gray-100 text-left"
            >
              ‚úèÔ∏è Edit
            </button>
            <button
              onClick={onNotes}
              className="block w-full px-4 py-2 hover:bg-gray-100 text-left"
            >
              üìù Notes
            </button>
            <button
              onClick={onTimeline}
              className="block w-full px-4 py-2 hover:bg-gray-100 text-left"
            >
              üïí Timeline
            </button>
            <button
              onClick={onDelete}
              className="block w-full px-4 py-2 text-red-600 hover:bg-red-50 text-left"
            >
              üóë Delete
            </button>
          </div>
        </div>
      )}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Contacts\Contacts.jsx 
====================================================== 
 
import React, { useState } from "react";
import TopBar from "./components/ContactsTopBar";
import ContactsTable from "./components/ContactsTable";
import ContactFormModal from "./components/ContactFormModal";
import BulkActionsBar from "./components/BulkActionsBar";

function Contacts() {
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [selectedContact, setSelectedContact] = useState(null);
  const [refreshTrigger, setRefreshTrigger] = useState(0);
  const [currentPage, setCurrentPage] = useState(1); // ‚úÖ Added here
  const [activeTab, setActiveTab] = useState("all");
  const [searchTerm, setSearchTerm] = useState("");
  const [selectedIds, setSelectedIds] = useState([]);

  const handleAddNew = () => {
    setSelectedContact(null);
    setIsModalOpen(true);
  };

  const handleEdit = contact => {
    setSelectedContact(contact);
    setIsModalOpen(true);
  };

  const handleSaveComplete = () => {
    setIsModalOpen(false);
    setSelectedContact(null);
    setCurrentPage(1); // ‚úÖ Reset to page 1 on save
    setRefreshTrigger(prev => prev + 1);
  };

  const handleSelectionChange = ids => {
    setSelectedIds(ids);
  };

  const clearSelection = () => {
    setSelectedIds([]);
  };

  return (
    <div className="p-4 space-y-4">
      <TopBar
        onAddClick={handleAddNew}
        activeTab={activeTab}
        onTabChange={setActiveTab}
        onSearchChange={setSearchTerm}
      />

      {selectedIds.length > 0 && (
        <BulkActionsBar
          selectedIds={selectedIds}
          onClearSelection={clearSelection}
          onRefresh={() => setRefreshTrigger(prev => prev + 1)}
        />
      )}

      <ContactsTable
        onEdit={handleEdit}
        activeTab={activeTab}
        refreshTrigger={refreshTrigger}
        searchTerm={searchTerm}
        onSelectionChange={handleSelectionChange}
        selectedIds={selectedIds}
        currentPage={currentPage}
        setCurrentPage={setCurrentPage} // ‚úÖ Pass down
      />

      <ContactFormModal
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        contact={selectedContact}
        onSaveComplete={handleSaveComplete}
      />
    </div>
  );
}

export default Contacts;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Contacts\ContactsTopBar.jsx 
====================================================== 
 
// üìÑ File: src/pages/Contacts/ContactsTopBar.jsx

import { useState } from "react";
import { Search, Filter, Plus } from "lucide-react";

const tabs = [
  { id: "all", label: "All Contacts", count: 266 },
  { id: "favourites", label: "Favourites", count: 86 },
  { id: "groups", label: "Groups", count: 23 },
  { id: "archived", label: "Archived", count: 8 },
];

export default function ContactsTopBar({ onAdd }) {
  const [activeTab, setActiveTab] = useState("all");
  const [search, setSearch] = useState("");

  return (
    <div className="flex flex-col gap-4 mb-6">
      {/* üîç Search + Actions */}
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
        <div className="flex items-center w-full md:max-w-sm bg-white border border-gray-300 rounded-lg px-3 py-2 shadow-sm">
          <Search size={18} className="text-gray-400 mr-2" />
          <input
            type="text"
            placeholder="Search contact, group or project"
            value={search}
            onChange={e => setSearch(e.target.value)}
            className="w-full outline-none text-sm text-gray-700"
          />
        </div>

        <div className="flex items-center gap-2 mt-2 md:mt-0">
          <button className="text-sm text-gray-600 hover:text-purple-700 flex items-center gap-1 border px-3 py-2 rounded-md border-gray-300">
            <Filter size={16} />
            <span className="hidden sm:inline">Filter</span>
          </button>
          <button
            onClick={onAdd}
            className="bg-purple-600 hover:bg-purple-700 text-white text-sm px-4 py-2 rounded-md flex items-center gap-2 shadow"
          >
            <Plus size={16} />
            Add Contact
          </button>
        </div>
      </div>

      {/* üìÅ Tabs */}
      <div className="flex items-center gap-6 border-b border-gray-200 text-sm font-medium">
        {tabs.map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            className={`pb-2 border-b-2 ${
              activeTab === tab.id
                ? "border-purple-600 text-purple-700"
                : "border-transparent text-gray-500 hover:text-purple-600"
            }`}
          >
            {tab.label}{" "}
            <span className="text-xs text-gray-400 ml-1">({tab.count})</span>
          </button>
        ))}
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Contacts\CsvUploadModal.jsx 
====================================================== 
 
import React, { useState } from "react";
import { toast } from "react-toastify";
import axios from "axios";

// Props: isOpen (bool), onClose (fn), onUploadComplete (contacts, skipSaving)
export default function CsvUploadModal({ isOpen, onClose, onUploadComplete }) {
  const [file, setFile] = useState(null);
  const [skipSaving, setSkipSaving] = useState(false);
  const [uploading, setUploading] = useState(false);

  const handleFileChange = e => {
    setFile(e.target.files[0]);
  };

  const handleUpload = async () => {
    if (!file) {
      toast.warn("‚ö†Ô∏è Please select a CSV file.");
      return;
    }

    const formData = new FormData();
    formData.append("file", file);

    setUploading(true);
    try {
      const res = await axios.post("/api/contacts/parse-csv", formData, {
        headers: {
          "Content-Type": "multipart/form-data",
        },
      });

      const contacts = res.data;
      if (!Array.isArray(contacts) || contacts.length === 0) {
        toast.error("‚ùå No valid contacts parsed from file.");
        return;
      }

      toast.success("‚úÖ CSV parsed successfully!");
      onUploadComplete(contacts, skipSaving);
      setFile(null); // üîÅ Reset file after success
      onClose();
    } catch (err) {
      console.error("‚ùå Upload error:", err);
      toast.error("‚ùå Failed to parse CSV. Please check format.");
    } finally {
      setUploading(false);
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
      <div className="bg-white p-6 rounded-xl shadow-md w-full max-w-md space-y-4">
        <h2 className="text-xl font-bold text-purple-700">
          üì• Upload CSV File
        </h2>

        <input type="file" accept=".csv" onChange={handleFileChange} />

        <div className="flex items-center space-x-2">
          <input
            type="checkbox"
            checked={skipSaving}
            onChange={e => setSkipSaving(e.target.checked)}
          />
          <label className="text-sm">
            Don't save contacts to CRM (temporary)
          </label>
        </div>

        <div className="flex justify-end gap-3 mt-4">
          <button
            onClick={onClose}
            className="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm"
          >
            Cancel
          </button>
          <button
            onClick={handleUpload}
            disabled={uploading}
            className="px-4 py-2 rounded bg-purple-600 text-white hover:bg-purple-700 text-sm"
          >
            {uploading ? "‚è≥ Uploading..." : "üöÄ Upload"}
          </button>
        </div>
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Contacts\ExtrackAllFiles.bat 
====================================================== 
 
@echo off
REM This script will find all files and output their name and content into one file.
REM The output file will be named [FolderName]_AllFileDump.txt.

REM Get the current folder's name and set it as the output file name with the custom suffix
for %%I in ("%cd%") do set "outputFile=%%~nI_AllFileDump.txt"

REM Clear the output file to start fresh
> "%outputFile%" (echo Folder and File Content Report)
echo. >> "%outputFile%"

REM Loop through all files in the current directory and subdirectories
for /R . %%F in (*.*) do (
    echo ====================================================== >> "%outputFile%"
    echo FILE: %%F >> "%outputFile%"
    echo ====================================================== >> "%outputFile%"
    echo. >> "%outputFile%"
    type "%%F" >> "%outputFile%" 2>nul
    echo. >> "%outputFile%"
    echo. >> "%outputFile%"
)

echo Finished! All content has been extracted to %outputFile% 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Contacts\components\BulkActionsBar.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../../api/axiosClient";
import { toast } from "react-toastify";

function BulkActionsBar({ selectedIds = [], onClearSelection, onRefresh }) {
  const [availableTags, setAvailableTags] = useState([]);
  const [selectedTagId, setSelectedTagId] = useState("");

  useEffect(() => {
    if (selectedIds.length > 0) {
      fetchTags();
    }
  }, [selectedIds.length]);

  const fetchTags = async () => {
    try {
      const res = await axiosClient.get("/tags/get-tags");
      setAvailableTags(res.data.data || []);
    } catch (error) {
      toast.error("‚ùå Failed to load tags");
    }
  };

  const handleApplyTag = async () => {
    if (!selectedTagId) {
      toast.warn("Please select a tag first");
      return;
    }

    try {
      await axiosClient.post("/contacts/bulk-assign-tag", {
        contactIds: selectedIds,
        tagId: selectedTagId,
      });

      toast.success("‚úÖ Tag assigned to selected contacts");
      onClearSelection?.();
      onRefresh?.();
    } catch (error) {
      const message =
        error.response?.data?.message || "‚ùå Failed to assign tag";
      toast.error(message);
    }
  };

  if (selectedIds.length === 0) return null;

  return (
    <div className="flex flex-col sm:flex-row justify-between items-center bg-blue-50 border border-blue-200 rounded-md p-3 mb-4 space-y-2 sm:space-y-0">
      <p className="text-sm text-gray-700 font-medium">
        {selectedIds.length} contact(s) selected
      </p>

      <div className="flex items-center gap-3 w-full sm:w-auto">
        <select
          value={selectedTagId}
          onChange={e => setSelectedTagId(e.target.value)}
          className="border border-gray-300 rounded-md px-3 py-2 text-sm w-full sm:w-56"
        >
          <option value="">-- Select Tag --</option>
          {availableTags.map(tag => (
            <option key={tag.id} value={tag.id}>
              {tag.name}
            </option>
          ))}
        </select>

        <button
          onClick={handleApplyTag}
          className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded text-sm shadow-sm"
        >
          Apply Tag
        </button>

        <button
          onClick={onClearSelection}
          className="text-sm text-gray-600 hover:underline"
        >
          Clear
        </button>
      </div>
    </div>
  );
}

export default BulkActionsBar;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Contacts\components\checkbox.jsx 
====================================================== 
 
// üìÑ File: src/pages/Contacts/components/checkbox.jsx

import React from "react";

export const Checkbox = React.forwardRef(
  ({ className = "", checked, onCheckedChange, ...props }, ref) => {
    return (
      <input
        type="checkbox"
        ref={ref}
        checked={checked}
        className={`w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500 ${className}`}
        {...props}
        onChange={e => onCheckedChange?.(e.target.checked)}
      />
    );
  }
);

Checkbox.displayName = "Checkbox";
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Contacts\components\ContactFormModal.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../../api/axiosClient";
import { toast } from "react-toastify";

const leadSources = [
  "Manual",
  "Website Form",
  "Google Search",
  "Facebook Ad",
  "LinkedIn",
  "Referral",
  "Trade Show",
  "Cold Call",
  "Other",
];

function ContactFormModal({ isOpen, onClose, contact, onSaveComplete }) {
  const [formData, setFormData] = useState({
    name: "",
    phoneNumber: "",
    email: "",
    leadSource: "Manual",
    notes: "",
    tagId: "",
  });
  const [allTags, setAllTags] = useState([]);
  const [isSaving, setIsSaving] = useState(false);

  useEffect(() => {
    const fetchTags = async () => {
      try {
        const res = await axiosClient.get("/tags/get-tags");
        setAllTags(res.data.data || []);
      } catch (error) {
        console.error("Failed to load tags:", error);
        toast.error("‚ùå Failed to load tags");
      }
    };

    if (isOpen) {
      fetchTags();
    }
  }, [isOpen]);

  useEffect(() => {
    if (contact) {
      setFormData({
        name: contact.name || "",
        phoneNumber: contact.phoneNumber || "",
        email: contact.email || "",
        leadSource: contact.leadSource || "Manual",
        notes: contact.notes || "",
        tagId: contact.tags?.[0]?.tagId || "",
      });
    } else {
      setFormData({
        name: "",
        phoneNumber: "",
        email: "",
        leadSource: "Manual",
        notes: "",
        tagId: "",
      });
    }
  }, [contact, isOpen]);

  const handleChange = e => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleSubmit = async e => {
    e.preventDefault();
    setIsSaving(true);

    const payload = {
      ...formData,
      tagIds: formData.tagId ? [formData.tagId] : [],
    };
    delete payload.tagId;

    try {
      if (contact?.id) {
        await axiosClient.put(`/contacts/${contact.id}`, payload); // Assuming PUT doesn't need "add"
        toast.success("‚úÖ Contact updated successfully!");
      } else {
        // üëá FIX #1: Using the correct endpoint for creating a contact.
        await axiosClient.post("/contacts/create", payload);
        toast.success("‚úÖ Contact created successfully!");
      }
      onSaveComplete?.();
      onClose();
    } catch (err) {
      // üëá FIX #2: Specific error handling for duplicate contacts.
      if (err.response && err.response.status === 409) {
        // 409 Conflict status means the contact already exists.
        toast.warn(
          err.response.data.message ||
            "Contact with this phone number already exists."
        );
      } else {
        // Handle all other errors (like 404 Not Found, 500 Server Error, etc.)
        const errorMessage =
          err.response?.data?.message || "‚ùå Failed to save contact.";
        toast.error(errorMessage);
      }
    } finally {
      setIsSaving(false);
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center p-4">
      <div className="bg-white p-6 rounded-xl shadow-lg w-full max-w-2xl relative">
        <button
          onClick={onClose}
          className="absolute top-3 right-4 text-gray-500 hover:text-gray-800 text-2xl"
        >
          &times;
        </button>

        <h2 className="text-xl font-bold mb-4">
          {contact?.id ? "Edit Contact" : "Add New Contact"}
        </h2>

        <form
          onSubmit={handleSubmit}
          className="grid grid-cols-1 md:grid-cols-2 gap-4"
        >
          <input
            name="name"
            value={formData.name}
            onChange={handleChange}
            placeholder="Full Name *"
            required
            className="border px-3 py-2 rounded w-full"
          />
          <input
            name="phoneNumber"
            value={formData.phoneNumber}
            onChange={handleChange}
            placeholder="Phone Number *"
            required
            className="border px-3 py-2 rounded w-full"
          />
          <input
            type="email"
            name="email"
            value={formData.email}
            onChange={handleChange}
            placeholder="Email"
            className="border px-3 py-2 rounded w-full"
          />
          <select
            name="leadSource"
            value={formData.leadSource}
            onChange={handleChange}
            className="border px-3 py-2 rounded w-full"
          >
            {leadSources.map(source => (
              <option key={source} value={source}>
                {source}
              </option>
            ))}
          </select>
          <select
            name="tagId"
            value={formData.tagId}
            onChange={handleChange}
            className="md:col-span-2 border px-3 py-2 rounded w-full"
          >
            <option value="">-- No Tag --</option>
            {allTags.map(tag => (
              <option key={tag.id} value={tag.id}>
                {tag.name}
              </option>
            ))}
          </select>
          <textarea
            name="notes"
            value={formData.notes}
            onChange={handleChange}
            placeholder="Notes..."
            className="md:col-span-2 border px-3 py-2 rounded w-full min-h-[80px]"
          ></textarea>
          <div className="md:col-span-2 flex justify-end gap-3">
            <button
              type="button"
              onClick={onClose}
              className="bg-gray-200 text-gray-800 px-6 py-2 rounded hover:bg-gray-300"
            >
              Cancel
            </button>
            <button
              type="submit"
              disabled={isSaving}
              className="bg-purple-600 text-white px-6 py-2 rounded hover:bg-purple-700 disabled:bg-purple-300"
            >
              {isSaving
                ? "Saving..."
                : contact?.id
                ? "Update Contact"
                : "Add Contact"}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}

export default ContactFormModal;

// import React, { useEffect, useState } from "react";
// import axiosClient from "../../../api/axiosClient";
// import { toast } from "react-toastify";

// // üëá FIX #1: Define the list of lead sources.
// const leadSources = [
//   "Manual",
//   "Website Form",
//   "Google Search",
//   "Facebook Ad",
//   "LinkedIn",
//   "Referral",
//   "Trade Show",
//   "Cold Call",
//   "Other",
// ];

// function ContactFormModal({ isOpen, onClose, contact, onSaveComplete }) {
//   const [formData, setFormData] = useState({
//     name: "",
//     phoneNumber: "",
//     email: "",
//     // üëá FIX #2: Set the default leadSource to "Manual".
//     leadSource: "Manual",
//     notes: "",
//     tagId: "",
//   });
//   const [allTags, setAllTags] = useState([]);
//   const [isSaving, setIsSaving] = useState(false);

//   useEffect(() => {
//     const fetchTags = async () => {
//       try {
//         const res = await axiosClient.get("/tags/get-tags");
//         setAllTags(res.data.data || []);
//       } catch (error) {
//         console.error("Failed to load tags:", error);
//         toast.error("‚ùå Failed to load tags");
//       }
//     };

//     if (isOpen) {
//       fetchTags();
//     }
//   }, [isOpen]);

//   useEffect(() => {
//     if (contact) {
//       setFormData({
//         name: contact.name || "",
//         phoneNumber: contact.phoneNumber || "",
//         email: contact.email || "",
//         leadSource: contact.leadSource || "Manual",
//         notes: contact.notes || "",
//         tagId: contact.tags?.[0]?.tagId || "",
//       });
//     } else {
//       // Reset form for a new contact
//       setFormData({
//         name: "",
//         phoneNumber: "",
//         email: "",
//         leadSource: "Manual",
//         notes: "",
//         tagId: "",
//       });
//     }
//   }, [contact, isOpen]);

//   const handleChange = e => {
//     const { name, value } = e.target;
//     setFormData(prev => ({ ...prev, [name]: value }));
//   };

//   const handleSubmit = async e => {
//     e.preventDefault();
//     setIsSaving(true);

//     const payload = {
//       ...formData,
//       tagIds: formData.tagId ? [formData.tagId] : [],
//     };
//     delete payload.tagId;

//     try {
//       if (contact?.id) {
//         await axiosClient.put(`/contacts/add/${contact.id}`, payload);
//         toast.success("‚úÖ Contact updated successfully!");
//       } else {
//         await axiosClient.post("/contacts", payload);
//         toast.success("‚úÖ Contact created successfully!");
//       }
//       onSaveComplete?.();
//       onClose();
//     } catch (err) {
//       const errorMessage =
//         err.response?.data?.message || "‚ùå Failed to save contact.";
//       toast.error(errorMessage);
//     } finally {
//       setIsSaving(false);
//     }
//   };

//   if (!isOpen) return null;

//   return (
//     <div className="fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center p-4">
//       <div className="bg-white p-6 rounded-xl shadow-lg w-full max-w-2xl relative">
//         <button
//           onClick={onClose}
//           className="absolute top-3 right-4 text-gray-500 hover:text-gray-800 text-2xl"
//         >
//           &times;
//         </button>

//         <h2 className="text-xl font-bold mb-4">
//           {contact?.id ? "Edit Contact" : "Add New Contact"}
//         </h2>

//         <form
//           onSubmit={handleSubmit}
//           className="grid grid-cols-1 md:grid-cols-2 gap-4"
//         >
//           <input
//             name="name"
//             value={formData.name}
//             onChange={handleChange}
//             placeholder="Full Name *"
//             required
//             className="border px-3 py-2 rounded w-full"
//           />
//           <input
//             name="phoneNumber"
//             value={formData.phoneNumber}
//             onChange={handleChange}
//             placeholder="Phone Number *"
//             required
//             className="border px-3 py-2 rounded w-full"
//           />
//           <input
//             type="email"
//             name="email"
//             value={formData.email}
//             onChange={handleChange}
//             placeholder="Email"
//             className="border px-3 py-2 rounded w-full"
//           />

//           {/* üëá FIX #3: Replaced the text input with a select dropdown. */}
//           <select
//             name="leadSource"
//             value={formData.leadSource}
//             onChange={handleChange}
//             className="border px-3 py-2 rounded w-full"
//           >
//             {leadSources.map(source => (
//               <option key={source} value={source}>
//                 {source}
//               </option>
//             ))}
//           </select>

//           <select
//             name="tagId"
//             value={formData.tagId}
//             onChange={handleChange}
//             className="md:col-span-2 border px-3 py-2 rounded w-full"
//           >
//             <option value="">-- No Tag --</option>
//             {allTags.map(tag => (
//               <option key={tag.id} value={tag.id}>
//                 {tag.name}
//               </option>
//             ))}
//           </select>

//           <textarea
//             name="notes"
//             value={formData.notes}
//             onChange={handleChange}
//             placeholder="Notes..."
//             className="md:col-span-2 border px-3 py-2 rounded w-full min-h-[80px]"
//           ></textarea>

//           <div className="md:col-span-2 flex justify-end gap-3">
//             <button
//               type="button"
//               onClick={onClose}
//               className="bg-gray-200 text-gray-800 px-6 py-2 rounded hover:bg-gray-300"
//             >
//               Cancel
//             </button>
//             <button
//               type="submit"
//               disabled={isSaving}
//               className="bg-purple-600 text-white px-6 py-2 rounded hover:bg-purple-700 disabled:bg-purple-300"
//             >
//               {isSaving
//                 ? "Saving..."
//                 : contact?.id
//                 ? "Update Contact"
//                 : "Add Contact"}
//             </button>
//           </div>
//         </form>
//       </div>
//     </div>
//   );
// }

// export default ContactFormModal;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Contacts\components\ContactsTable.jsx 
====================================================== 
 
// üìÑ File: src/pages/Contacts/components/ContactsTable.jsx
import React, { useEffect, useState, useCallback } from "react";
import axiosClient from "../../../api/axiosClient";
import { useNavigate } from "react-router-dom";
import { toast } from "react-toastify";
import { Checkbox } from "./checkbox";
import { MoreVertical } from "lucide-react";
import {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
} from "./dropdown-menu";

function getInitials(name) {
  if (!name) return "";
  return name
    .split(" ")
    .slice(0, 2)
    .map(w => w[0])
    .join(" ")
    .toUpperCase();
}

export default function ContactsTable({
  onEdit,
  refreshTrigger,
  activeTab,
  onSelectionChange,
  searchTerm,
  currentPage,
  setCurrentPage,
}) {
  const [contacts, setContacts] = useState([]);
  const [totalPages, setTotalPages] = useState(1);
  const [selectedIds, setSelectedIds] = useState([]);
  const pageSize = 20;
  const navigate = useNavigate();

  const fetchContacts = useCallback(async () => {
    try {
      const res = await axiosClient.get("/contacts/", {
        params: {
          tab: activeTab,
          search: searchTerm,
          page: currentPage,
          pageSize,
        },
      });

      const result = res.data.data;

      // üëá THE FIX IS HERE üëá
      // The contacts are in `result.items`, not `result.records`.
      setContacts(Array.isArray(result?.items) ? result.items : []);

      // Also, handle the potentially incorrect totalPages from the backend.
      const total = result?.totalPages > 0 ? result.totalPages : 1;
      setTotalPages(total);
    } catch (err) {
      const message =
        err.response?.data?.message || "‚ùå Failed to load contacts";
      toast.error(message);
    }
  }, [activeTab, searchTerm, currentPage, pageSize]);

  useEffect(() => {
    fetchContacts();
  }, [refreshTrigger, activeTab, searchTerm, currentPage, fetchContacts]);

  const handleSelectAll = checked => {
    const ids = checked ? contacts.map(c => c.id) : [];
    setSelectedIds(ids);
    onSelectionChange?.(ids);
  };

  const handleRowCheckbox = (checked, id) => {
    const updated = checked
      ? [...selectedIds, id]
      : selectedIds.filter(i => i !== id);
    setSelectedIds(updated);
    onSelectionChange?.(updated);
  };

  const handleDelete = async id => {
    if (!window.confirm("Are you sure you want to delete this contact?"))
      return;
    try {
      await axiosClient.delete(`/contacts/${id}`);
      toast.success("‚úÖ Contact deleted");
      fetchContacts();
    } catch (err) {
      const message =
        err.response?.data?.message || "‚ùå Failed to delete contact";
      toast.error(message);
    }
  };

  return (
    <div className="overflow-x-auto rounded-lg border shadow-sm">
      <table className="w-full text-sm text-gray-700">
        <thead className="bg-gray-100">
          <tr>
            <th className="px-4 py-2 text-center w-6 border-b border-gray-200">
              <Checkbox
                checked={
                  contacts.length > 0 && selectedIds.length === contacts.length
                }
                onCheckedChange={handleSelectAll}
                className="w-4 h-4"
              />
            </th>
            <th className="px-4 py-2 text-left border-b border-gray-200 font-medium">
              Name
            </th>
            <th className="px-4 py-2 text-left border-b border-gray-200 font-medium">
              Phone
            </th>
            <th className="px-4 py-2 text-left border-b border-gray-200 font-medium hidden md:table-cell">
              Email
            </th>

            <th className="px-4 py-2 text-left border-b border-gray-200 font-medium hidden lg:table-cell">
              Created
            </th>
            <th className="px-4 py-2 text-center w-8 border-b border-gray-200 font-medium">
              Actions
            </th>
          </tr>
        </thead>
        <tbody className="bg-white divide-y divide-gray-200">
          {contacts.map(contact => (
            <tr key={contact.id} className="hover:bg-gray-50">
              <td className="px-4 py-2 text-center">
                <Checkbox
                  checked={selectedIds.includes(contact.id)}
                  onCheckedChange={checked =>
                    handleRowCheckbox(checked, contact.id)
                  }
                  className="w-4 h-4"
                />
              </td>
              <td className="px-4 py-2 flex items-center gap-4">
                <div className="h-6 w-6 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-xs">
                  {getInitials(contact.name)}
                </div>
                <span className="font-medium truncate">{contact.name}</span>
              </td>

              <td className="px-4 py-2 truncate">{contact.phoneNumber}</td>
              <td className="px-4 py-2 hidden md:table-cell truncate">
                {contact.email || "‚Äî"}
              </td>
              <td className="px-4 py-2 hidden lg:table-cell truncate">
                {new Date(contact.createdAt).toLocaleDateString()}
              </td>
              <td className="px-4 py-2 text-center">
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <button className="p-1 rounded hover:bg-gray-200 focus:outline-none">
                      <MoreVertical size={16} />
                    </button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent className="w-36 rounded shadow-lg border bg-white">
                    <DropdownMenuItem
                      onClick={() => onEdit(contact)}
                      className="px-3 py-2 hover:bg-gray-100 text-xs"
                    >
                      ‚úèÔ∏è Edit
                    </DropdownMenuItem>
                    <DropdownMenuItem
                      onClick={() => handleDelete(contact.id)}
                      className="px-3 py-2 hover:bg-red-50 text-red-600 text-xs"
                    >
                      üóëÔ∏è Delete
                    </DropdownMenuItem>
                    <DropdownMenuItem
                      onClick={() =>
                        navigate(`/dashboard/contacts/${contact.id}/notes`)
                      }
                      className="px-3 py-2 hover:bg-gray-100 text-xs"
                    >
                      üìù Notes
                    </DropdownMenuItem>
                  </DropdownMenuContent>
                </DropdownMenu>
              </td>
            </tr>
          ))}
        </tbody>
      </table>

      {/* Pagination Controls */}
      <div className="flex justify-end items-center gap-3 px-4 py-3 text-sm text-gray-700">
        <button
          onClick={() => setCurrentPage(p => Math.max(p - 1, 1))}
          disabled={currentPage === 1}
          className="px-3 py-1 border border-gray-300 rounded disabled:opacity-50"
        >
          Prev
        </button>
        <span>
          Page {currentPage} of {totalPages}
        </span>
        <button
          onClick={() => setCurrentPage(p => Math.min(p + 1, totalPages))}
          disabled={currentPage === totalPages}
          className="px-3 py-1 border border-gray-300 rounded disabled:opacity-50"
        >
          Next
        </button>
      </div>
    </div>
  );
}

// import React, { useEffect, useState, useCallback } from "react";
// import axiosClient from "../../../api/axiosClient";
// import { useNavigate } from "react-router-dom";
// import { toast } from "react-toastify";
// import { Checkbox } from "./checkbox";
// import { MoreVertical } from "lucide-react";
// import {
//   DropdownMenu,
//   DropdownMenuTrigger,
//   DropdownMenuContent,
//   DropdownMenuItem,
// } from "./dropdown-menu";

// function getInitials(name) {
//   if (!name) return "";
//   return name
//     .split(" ")
//     .slice(0, 2)
//     .map(w => w[0])
//     .join(" ")
//     .toUpperCase();
// }

// export default function ContactsTable({
//   onEdit,
//   refreshTrigger,
//   activeTab,
//   onSelectionChange,
//   searchTerm,
//   currentPage,
//   setCurrentPage,
// }) {
//   const [contacts, setContacts] = useState([]);
//   const [selectedIds, setSelectedIds] = useState([]);
//   const pageSize = 20;
//   const navigate = useNavigate();

//   // üü¢ useCallback so it's safe to add as dependency
//   const fetchContacts = useCallback(async () => {
//     try {
//       const res = await axiosClient.get("/contacts", {
//         params: { tab: activeTab, search: searchTerm },
//       });
//       const result = res.data;
//       const records = Array.isArray(result?.records) ? result.records : [];
//       setContacts(records);
//     } catch {
//       toast.error("‚ùå Failed to load contacts");
//     }
//   }, [activeTab, searchTerm]);

//   useEffect(() => {
//     fetchContacts();
//   }, [refreshTrigger, activeTab, searchTerm, fetchContacts]);

//   const handleSelectAll = checked => {
//     const ids = checked ? pagedContacts.map(c => c.id) : [];
//     setSelectedIds(ids);
//     onSelectionChange?.(ids);
//   };

//   const handleRowCheckbox = (checked, id) => {
//     const updated = checked
//       ? [...selectedIds, id]
//       : selectedIds.filter(i => i !== id);
//     setSelectedIds(updated);
//     onSelectionChange?.(updated);
//   };

//   const handleDelete = async id => {
//     if (!window.confirm("Are you sure you want to delete this contact?"))
//       return;
//     try {
//       await axiosClient.delete(`/contacts/${id}`);
//       toast.success("‚úÖ Contact deleted");
//       fetchContacts();
//     } catch {
//       toast.error("‚ùå Failed to delete contact");
//     }
//   };

//   const filtered = contacts.filter(c =>
//     c.name.toLowerCase().includes(searchTerm.toLowerCase())
//   );
//   const sorted = [...filtered].sort(
//     (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
//   );
//   const totalPages = Math.max(1, Math.ceil(sorted.length / pageSize));
//   const pagedContacts = sorted.slice(
//     (currentPage - 1) * pageSize,
//     currentPage * pageSize
//   );

//   return (
//     <div className="overflow-x-auto rounded-lg border shadow-sm">
//       <table className="w-full text-sm text-gray-700">
//         <thead className="bg-gray-100">
//           <tr>
//             <th className="px-4 py-2 text-center w-6 border-b border-gray-200">
//               <Checkbox
//                 checked={
//                   pagedContacts.length > 0 &&
//                   selectedIds.length === pagedContacts.length
//                 }
//                 onCheckedChange={handleSelectAll}
//                 className="w-4 h-4"
//               />
//             </th>
//             <th className="px-4 py-2 text-left border-b border-gray-200 font-medium">
//               Name
//             </th>
//             <th className="px-4 py-2 text-left border-b border-gray-200 font-medium hidden md:table-cell">
//               Email
//             </th>
//             <th className="px-4 py-2 text-left border-b border-gray-200 font-medium">
//               Phone
//             </th>
//             <th className="px-4 py-2 text-left border-b border-gray-200 font-medium hidden lg:table-cell">
//               Created
//             </th>
//             <th className="px-4 py-2 text-center w-8 border-b border-gray-200 font-medium">
//               Actions
//             </th>
//           </tr>
//         </thead>
//         <tbody className="bg-white divide-y divide-gray-200">
//           {pagedContacts.map(contact => (
//             <tr key={contact.id} className="hover:bg-gray-50">
//               <td className="px-4 py-2 text-center">
//                 <Checkbox
//                   checked={selectedIds.includes(contact.id)}
//                   onCheckedChange={checked =>
//                     handleRowCheckbox(checked, contact.id)
//                   }
//                   className="w-4 h-4"
//                 />
//               </td>
//               <td className="px-4 py-2 flex items-center gap-4">
//                 <div className="h-6 w-6 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-xs">
//                   {getInitials(contact.name)}
//                 </div>
//                 <span className="font-medium truncate">{contact.name}</span>
//               </td>
//               <td className="px-4 py-2 hidden md:table-cell truncate">
//                 {contact.email || "‚Äî"}
//               </td>
//               <td className="px-4 py-2 truncate">{contact.phoneNumber}</td>
//               <td className="px-4 py-2 hidden lg:table-cell truncate">
//                 {new Date(contact.createdAt).toLocaleDateString()}
//               </td>
//               <td className="px-4 py-2 text-center">
//                 <DropdownMenu>
//                   <DropdownMenuTrigger asChild>
//                     <button className="p-1 rounded hover:bg-gray-200 focus:outline-none">
//                       <MoreVertical size={16} />
//                     </button>
//                   </DropdownMenuTrigger>
//                   <DropdownMenuContent className="w-36 rounded shadow-lg border bg-white">
//                     <DropdownMenuItem
//                       onClick={() => onEdit(contact)}
//                       className="px-3 py-2 hover:bg-gray-100 text-xs"
//                     >
//                       ‚úèÔ∏è Edit
//                     </DropdownMenuItem>
//                     <DropdownMenuItem
//                       onClick={() => handleDelete(contact.id)}
//                       className="px-3 py-2 hover:bg-red-50 text-red-600 text-xs"
//                     >
//                       üóëÔ∏è Delete
//                     </DropdownMenuItem>
//                     <DropdownMenuItem
//                       onClick={() =>
//                         navigate(`/dashboard/contacts/${contact.id}/notes`)
//                       }
//                       className="px-3 py-2 hover:bg-gray-100 text-xs"
//                     >
//                       üìù Notes
//                     </DropdownMenuItem>
//                   </DropdownMenuContent>
//                 </DropdownMenu>
//               </td>
//             </tr>
//           ))}
//         </tbody>
//       </table>

//       {/* Pagination Controls */}
//       <div className="flex justify-end items-center gap-3 px-4 py-3 text-sm text-gray-700">
//         <button
//           onClick={() => setCurrentPage(p => Math.max(p - 1, 1))}
//           disabled={currentPage === 1}
//           className="px-3 py-1 border border-gray-300 rounded disabled:opacity-50"
//         >
//           Prev
//         </button>
//         <span>
//           Page {currentPage} of {totalPages}
//         </span>
//         <button
//           onClick={() => setCurrentPage(p => Math.min(p + 1, totalPages))}
//           disabled={currentPage === totalPages}
//           className="px-3 py-1 border border-gray-300 rounded disabled:opacity-50"
//         >
//           Next
//         </button>
//       </div>
//     </div>
//   );
// }

// import React, { useEffect, useState } from "react";
// import axiosClient from "../../../api/axiosClient";
// import { useNavigate } from "react-router-dom";
// import { toast } from "react-toastify";
// import { Checkbox } from "./checkbox";
// import { MoreVertical } from "lucide-react";
// import {
//   DropdownMenu,
//   DropdownMenuTrigger,
//   DropdownMenuContent,
//   DropdownMenuItem,
// } from "./dropdown-menu";

// function getInitials(name) {
//   if (!name) return "";
//   return name
//     .split(" ")
//     .slice(0, 2)
//     .map(w => w[0])
//     .join(" ")
//     .toUpperCase();
// }

// export default function ContactsTable({
//   onEdit,
//   refreshTrigger,
//   activeTab,
//   onSelectionChange,
//   searchTerm,
//   currentPage,
//   setCurrentPage,
// }) {
//   const [contacts, setContacts] = useState([]);
//   const [selectedIds, setSelectedIds] = useState([]);
//   const pageSize = 20;
//   const navigate = useNavigate();

//   useEffect(() => {
//     fetchContacts();
//   }, [refreshTrigger, activeTab, searchTerm]);

//   const fetchContacts = async () => {
//     try {
//       const res = await axiosClient.get("/contacts", {
//         params: { tab: activeTab, search: searchTerm },
//       });
//       const result = res.data;
//       const records = Array.isArray(result?.records) ? result.records : [];
//       setContacts(records);
//     } catch {
//       toast.error("‚ùå Failed to load contacts");
//     }
//   };

//   const handleSelectAll = checked => {
//     const ids = checked ? pagedContacts.map(c => c.id) : [];
//     setSelectedIds(ids);
//     onSelectionChange?.(ids);
//   };

//   const handleRowCheckbox = (checked, id) => {
//     const updated = checked
//       ? [...selectedIds, id]
//       : selectedIds.filter(i => i !== id);
//     setSelectedIds(updated);
//     onSelectionChange?.(updated);
//   };

//   const handleDelete = async id => {
//     if (!window.confirm("Are you sure you want to delete this contact?"))
//       return;
//     try {
//       await axiosClient.delete(`/contacts/${id}`);
//       toast.success("‚úÖ Contact deleted");
//       fetchContacts();
//     } catch {
//       toast.error("‚ùå Failed to delete contact");
//     }
//   };

//   const filtered = contacts.filter(c =>
//     c.name.toLowerCase().includes(searchTerm.toLowerCase())
//   );
//   const sorted = [...filtered].sort(
//     (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
//   );
//   const totalPages = Math.max(1, Math.ceil(sorted.length / pageSize));
//   const pagedContacts = sorted.slice(
//     (currentPage - 1) * pageSize,
//     currentPage * pageSize
//   );

//   return (
//     <div className="overflow-x-auto rounded-lg border shadow-sm">
//       <table className="w-full text-sm text-gray-700">
//         <thead className="bg-gray-100">
//           <tr>
//             <th className="px-4 py-2 text-center w-6 border-b border-gray-200">
//               <Checkbox
//                 checked={
//                   pagedContacts.length > 0 &&
//                   selectedIds.length === pagedContacts.length
//                 }
//                 onCheckedChange={handleSelectAll}
//                 className="w-4 h-4"
//               />
//             </th>
//             <th className="px-4 py-2 text-left border-b border-gray-200 font-medium">
//               Name
//             </th>
//             <th className="px-4 py-2 text-left border-b border-gray-200 font-medium hidden md:table-cell">
//               Email
//             </th>
//             <th className="px-4 py-2 text-left border-b border-gray-200 font-medium">
//               Phone
//             </th>
//             <th className="px-4 py-2 text-left border-b border-gray-200 font-medium hidden lg:table-cell">
//               Created
//             </th>
//             <th className="px-4 py-2 text-center w-8 border-b border-gray-200 font-medium">
//               Actions
//             </th>
//           </tr>
//         </thead>
//         <tbody className="bg-white divide-y divide-gray-200">
//           {pagedContacts.map(contact => (
//             <tr key={contact.id} className="hover:bg-gray-50">
//               <td className="px-4 py-2 text-center">
//                 <Checkbox
//                   checked={selectedIds.includes(contact.id)}
//                   onCheckedChange={checked =>
//                     handleRowCheckbox(checked, contact.id)
//                   }
//                   className="w-4 h-4"
//                 />
//               </td>
//               <td className="px-4 py-2 flex items-center gap-4">
//                 <div className="h-6 w-6 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-xs">
//                   {getInitials(contact.name)}
//                 </div>
//                 <span className="font-medium truncate">{contact.name}</span>
//               </td>
//               <td className="px-4 py-2 hidden md:table-cell truncate">
//                 {contact.email || "‚Äî"}
//               </td>
//               <td className="px-4 py-2 truncate">{contact.phoneNumber}</td>
//               <td className="px-4 py-2 hidden lg:table-cell truncate">
//                 {new Date(contact.createdAt).toLocaleDateString()}
//               </td>
//               <td className="px-4 py-2 text-center">
//                 <DropdownMenu>
//                   <DropdownMenuTrigger asChild>
//                     <button className="p-1 rounded hover:bg-gray-200 focus:outline-none">
//                       <MoreVertical size={16} />
//                     </button>
//                   </DropdownMenuTrigger>
//                   <DropdownMenuContent className="w-36 rounded shadow-lg border bg-white">
//                     <DropdownMenuItem
//                       onClick={() => onEdit(contact)}
//                       className="px-3 py-2 hover:bg-gray-100 text-xs"
//                     >
//                       ‚úèÔ∏è Edit
//                     </DropdownMenuItem>
//                     <DropdownMenuItem
//                       onClick={() => handleDelete(contact.id)}
//                       className="px-3 py-2 hover:bg-red-50 text-red-600 text-xs"
//                     >
//                       üóëÔ∏è Delete
//                     </DropdownMenuItem>
//                     <DropdownMenuItem
//                       onClick={() =>
//                         navigate(`/dashboard/contacts/${contact.id}/notes`)
//                       }
//                       className="px-3 py-2 hover:bg-gray-100 text-xs"
//                     >
//                       üìù Notes
//                     </DropdownMenuItem>
//                   </DropdownMenuContent>
//                 </DropdownMenu>
//               </td>
//             </tr>
//           ))}
//         </tbody>
//       </table>

//       {/* Pagination Controls */}
//       <div className="flex justify-end items-center gap-3 px-4 py-3 text-sm text-gray-700">
//         <button
//           onClick={() => setCurrentPage(p => Math.max(p - 1, 1))}
//           disabled={currentPage === 1}
//           className="px-3 py-1 border border-gray-300 rounded disabled:opacity-50"
//         >
//           Prev
//         </button>
//         <span>
//           Page {currentPage} of {totalPages}
//         </span>
//         <button
//           onClick={() => setCurrentPage(p => Math.min(p + 1, totalPages))}
//           disabled={currentPage === totalPages}
//           className="px-3 py-1 border border-gray-300 rounded disabled:opacity-50"
//         >
//           Next
//         </button>
//       </div>
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Contacts\components\ContactsTopBar.jsx 
====================================================== 
 
// üìÑ File: src/pages/Contacts/components/ContactsTopBar.jsx
import { Search, Plus, SlidersHorizontal } from "lucide-react";

export default function ContactsTopBar({
  onAddClick,
  onSearchChange,
  activeTab,
  onTabChange,
  searchTerm,
  onFilterClick,
}) {
  const tabs = [
    { key: "all", label: "All" },
    { key: "favourites", label: "Favourites" },
    { key: "archived", label: "Archived" },
    { key: "groups", label: "Groups" },
  ];

  return (
    <div className="space-y-3">
      {/* üîç Search + Buttons */}
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-3 border-b pb-4">
        <div className="flex items-center gap-2 flex-1">
          <Search size={18} className="text-gray-500" />
          <input
            type="text"
            placeholder="Search contacts..."
            value={searchTerm}
            onChange={e => onSearchChange?.(e.target.value)}
            className="w-full md:max-w-xs border border-gray-300 rounded-md px-3 py-2 text-sm"
          />
        </div>
        <div className="flex items-center gap-3">
          <button
            onClick={onFilterClick}
            className="flex items-center gap-2 px-3 py-2 rounded-md text-sm border text-gray-600 border-gray-300 hover:bg-gray-100"
          >
            <SlidersHorizontal size={16} /> Filter
          </button>
          <button
            onClick={onAddClick}
            className="flex items-center gap-2 px-4 py-2 rounded-md text-sm bg-purple-600 hover:bg-purple-700 text-white shadow-sm"
          >
            <Plus size={16} /> Add Contact
          </button>
        </div>
      </div>

      {/* üß≠ Tab Navigation */}
      <div className="flex gap-3 border-b text-sm font-medium">
        {tabs.map(tab => (
          <button
            key={tab.key}
            onClick={() => onTabChange?.(tab.key)}
            className={`px-3 py-2 border-b-2 transition-all duration-150 ${
              activeTab === tab.key
                ? "border-purple-600 text-purple-600"
                : "border-transparent text-gray-500 hover:text-black"
            }`}
          >
            {tab.label}
          </button>
        ))}
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Contacts\components\dropdown-menu.jsx 
====================================================== 
 
// üìÑ File: src/pages/Contacts/components/dropdown-menu.jsx
import {
  Menu,
  MenuButton,
  MenuItems,
  MenuItem,
  Transition,
} from "@headlessui/react";
import { Fragment } from "react";

export function DropdownMenu({ children }) {
  return (
    <Menu as="div" className="relative inline-block text-left">
      {children}
    </Menu>
  );
}

export const DropdownMenuTrigger = ({ asChild, children }) => (
  <MenuButton as={Fragment}>{children}</MenuButton>
);

export const DropdownMenuContent = ({ children, className = "" }) => (
  <Transition
    as={Fragment}
    enter="transition ease-out duration-100"
    enterFrom="transform opacity-0 scale-95"
    enterTo="transform opacity-100 scale-100"
    leave="transition ease-in duration-75"
    leaveFrom="transform opacity-100 scale-100"
    leaveTo="transform opacity-0 scale-95"
  >
    <MenuItems
      className={`absolute right-0 z-10 mt-2 w-48 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none ${className}`}
    >
      {children}
    </MenuItems>
  </Transition>
);

export const DropdownMenuItem = ({ children, onClick, className = "" }) => (
  <MenuItem>
    {({ active }) => (
      <button
        onClick={onClick}
        className={`${
          active ? "bg-gray-100" : ""
        } w-full px-4 py-2 text-sm text-left ${className}`}
      >
        {children}
      </button>
    )}
  </MenuItem>
);

// // üìÑ File: src/pages/Contacts/components/dropdown-menu.jsx
// import {
//   Menu,
//   MenuButton,
//   MenuItems,
//   MenuItem,
//   Transition,
// } from "@headlessui/react";
// import { Fragment } from "react";

// export function DropdownMenu({ children }) {
//   return (
//     <Menu as="div" className="relative inline-block text-left">
//       {children}
//     </Menu>
//   );
// }

// export const DropdownMenuTrigger = ({ asChild, children }) => (
//   <MenuButton as={Fragment}>{children}</MenuButton>
// );

// export const DropdownMenuContent = ({ children, className = "" }) => (
//   <Transition
//     as={Fragment}
//     enter="transition ease-out duration-100"
//     enterFrom="transform opacity-0 scale-95"
//     enterTo="transform opacity-100 scale-100"
//     leave="transition ease-in duration-75"
//     leaveFrom="transform opacity-100 scale-100"
//     leaveTo="transform opacity-0 scale-95"
//   >
//     <MenuItems
//       className={`absolute right-0 z-10 mt-2 w-48 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none ${className}`}
//     >
//       {children}
//     </MenuItems>
//   </Transition>
// );

// export const DropdownMenuItem = ({ children, onClick, className = "" }) => (
//   <MenuItem>
//     {({ active }) => (
//       <button
//         onClick={onClick}
//         className={`${
//           active ? "bg-gray-100" : ""
//         } w-full px-4 py-2 text-sm text-left ${className}`}
//       >
//         {children}
//       </button>
//     )}
//   </MenuItem>
// );
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CrmAnalytics\ContactTrendsChart.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../api/axiosClient";
import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  CartesianGrid,
} from "recharts";
import { toast } from "react-toastify";
import Spinner from "../../components/Spinner";

const FILTERS = [
  { label: "Today", value: 1 },
  { label: "7 Days", value: 7 },
  { label: "30 Days", value: 30 },
];

function ContactTrendsChart() {
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [range, setRange] = useState(7); // Default: last 7 days

  useEffect(() => {
    const fetchTrends = async () => {
      setLoading(true);
      try {
        const response = await axiosClient.get(
          `/api/crm/trends/contacts?range=${range}`
        );
        setData(response.data.result || []);
      } catch (err) {
        console.error(err);
        toast.error("Failed to load contact trends.");
      } finally {
        setLoading(false);
      }
    };

    fetchTrends();
  }, [range]);

  return (
    <div className="bg-white rounded-xl shadow p-4">
      <div className="flex justify-between items-center mb-4">
        <h2 className="text-xl font-semibold">üìà Contacts Added Over Time</h2>
        <div className="flex space-x-2">
          {FILTERS.map(f => (
            <button
              key={f.value}
              onClick={() => setRange(f.value)}
              className={`px-3 py-1 text-sm rounded-full border 
                ${
                  range === f.value
                    ? "bg-purple-600 text-white"
                    : "bg-gray-100 text-gray-600 hover:bg-purple-100"
                }`}
            >
              {f.label}
            </button>
          ))}
        </div>
      </div>

      {loading ? (
        <Spinner message="Loading contact trends..." />
      ) : (
        <ResponsiveContainer width="100%" height={300}>
          <LineChart data={data}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis dataKey="date" />
            <YAxis allowDecimals={false} />
            <Tooltip />
            <Line
              type="monotone"
              dataKey="count"
              stroke="#8a2be2"
              strokeWidth={3}
            />
          </LineChart>
        </ResponsiveContainer>
      )}
    </div>
  );
}

export default ContactTrendsChart;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CrmAnalytics\CrmAnalyticsDashboard.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../api/axiosClient";
import StatCard from "../../components/StatCard";
import ContactTrendsChart from "./ContactTrendsChart";
import Spinner from "../../components/Spinner"; // ‚úÖ Added spinner

import { toast } from "react-toastify";

function CrmAnalyticsDashboard() {
  const [summary, setSummary] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchSummary = async () => {
      try {
        const response = await axiosClient.get("/api/crm/summary");
        setSummary(response.data.result);
        toast.success(response.data.message || "CRM data loaded");
      } catch (error) {
        toast.error("Failed to load CRM summary.");
        console.error(error);
      } finally {
        setLoading(false);
      }
    };

    fetchSummary();
  }, []);

  if (loading) {
    return <Spinner message="Loading CRM dashboard..." />;
  }

  if (!summary) {
    return <p className="text-center text-red-500 mt-6">No data available</p>;
  }

  return (
    <div className="p-6 space-y-8">
      {/* üìä Summary Cards */}
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <StatCard title="Total Contacts" value={summary.totalContacts} />
        <StatCard title="Tagged Contacts" value={summary.taggedContacts} />
        <StatCard title="Active Reminders" value={summary.activeReminders} />
        <StatCard
          title="Completed Reminders"
          value={summary.completedReminders}
        />
        <StatCard title="Total Notes" value={summary.totalNotes} />
        <StatCard
          title="Leads with Timeline"
          value={summary.leadsWithTimeline}
        />
        <StatCard title="New Contacts Today" value={summary.newContactsToday} />
        <StatCard title="Notes Added Today" value={summary.notesAddedToday} />
        <StatCard
          title="Last Contact Added"
          value={
            summary.lastContactAddedAt
              ? new Date(summary.lastContactAddedAt).toLocaleString()
              : "N/A"
          }
        />
        <StatCard
          title="Last Reminder Completed"
          value={
            summary.lastReminderCompletedAt
              ? new Date(summary.lastReminderCompletedAt).toLocaleString()
              : "N/A"
          }
        />
      </div>

      {/* üìà Contact Trends Chart */}
      <ContactTrendsChart />
    </div>
  );
}

export default CrmAnalyticsDashboard;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\CTAFlowLogs.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../api/axiosClient";
import { Card } from "../../components/ui/card";
import { Table, Thead, Tbody, Tr, Th, Td } from "../../components/ui/table";
import { format } from "date-fns";

const CTAFlowLogs = () => {
  const [logs, setLogs] = useState([]);

  useEffect(() => {
    axiosClient.get("/tracking/flow-clicks").then(res => {
      setLogs(res.data);
    });
  }, []);

  return (
    <div className="p-6">
      <h2 className="text-2xl font-bold mb-4">CTA Flow Click Logs</h2>
      <Card className="overflow-x-auto">
        <Table>
          <Thead>
            <Tr>
              <Th>Date</Th>
              <Th>Recipient</Th>
              <Th>Button</Th>
              <Th>Template</Th>
              <Th>Step ID</Th>
              <Th>Follow-Up</Th>
            </Tr>
          </Thead>
          <Tbody>
            {logs.map(log => (
              <Tr key={log.id}>
                <Td>
                  {format(new Date(log.clickedAt), "dd MMM yyyy hh:mm a")}
                </Td>
                <Td>{log.contactPhone}</Td>
                <Td>{log.buttonText}</Td>
                <Td>{log.templateId}</Td>
                <Td className="text-xs">{log.stepId}</Td>
                <Td>
                  {log.followUpSent ? (
                    <span className="text-green-600 font-semibold">‚úÖ Yes</span>
                  ) : (
                    <span className="text-gray-500">‚Äî</span>
                  )}
                </Td>
              </Tr>
            ))}
          </Tbody>
        </Table>
      </Card>
    </div>
  );
};

export default CTAFlowLogs;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\CTAFlowManager.jsx 
====================================================== 
 
// üìÑ File: src/pages/CTAFlowVisualBuilder/CTAFlowManager.jsx
import React, { useEffect, useMemo, useRef, useState } from "react";
import { useNavigate, useSearchParams } from "react-router-dom";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";

export default function CTAFlowManager() {
  const [flows, setFlows] = useState([]);
  const [loading, setLoading] = useState(true);

  const [modalOpen, setModalOpen] = useState(false);
  const [modalMode, setModalMode] = useState("confirm"); // confirm | attached
  const [modalCampaigns, setModalCampaigns] = useState([]);
  const [targetFlow, setTargetFlow] = useState(null);

  const [query, setQuery] = useState("");
  const [sortKey, setSortKey] = useState("updated");
  const closeBtnRef = useRef(null);
  const navigate = useNavigate();

  // NEW: read ?tab= from URL (published | draft). Default to 'published'
  const [searchParams, setSearchParams] = useSearchParams();
  const tabFromUrl =
    searchParams.get("tab") === "draft" ? "draft" : "published";
  const [activeTab, setActiveTab] = useState(tabFromUrl);

  const formatDate = date =>
    date
      ? new Date(date).toLocaleString("en-IN", {
          day: "2-digit",
          month: "short",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        })
      : "‚Äî";

  const statusPill = isPublished =>
    isPublished ? (
      <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">
        <span>‚óè</span> Published
      </span>
    ) : (
      <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">
        <span>‚óè</span> Draft
      </span>
    );

  const fetchFlows = async (tab = "published") => {
    setLoading(true);
    try {
      const endpoint =
        tab === "published" ? "/cta-flow/all-published" : "/cta-flow/all-draft";
      const res = await axiosClient.get(endpoint);
      setFlows(Array.isArray(res.data) ? res.data : [res.data]);
    } catch (err) {
      setFlows([]);
      toast.error("‚ùå Failed to load flows.");
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  // NEW: whenever ?tab changes (or on first render), sync state and fetch
  useEffect(() => {
    const tab = searchParams.get("tab") === "draft" ? "draft" : "published";
    setActiveTab(tab);
    fetchFlows(tab);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [searchParams]);

  const filtered = useMemo(() => {
    const q = query.trim().toLowerCase();
    let out = flows;
    if (q) {
      out = out.filter(f =>
        [f.flowName, f.createdBy]
          .filter(Boolean)
          .some(v => String(v).toLowerCase().includes(q))
      );
    }
    switch (sortKey) {
      case "name":
        return [...out].sort((a, b) => a.flowName.localeCompare(b.flowName));
      case "created":
        return [...out].sort(
          (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
        );
      default:
        return [...out].sort(
          (a, b) =>
            new Date(b.updatedAt || b.createdAt) -
            new Date(a.updatedAt || a.createdAt)
        );
    }
  }, [flows, query, sortKey]);

  // ---- delete UX (checks usage) ----
  const openDeleteModal = async flow => {
    if (loading) return; // guard
    setTargetFlow(flow);
    setLoading(true);
    try {
      const { data } = await axiosClient.get(`/cta-flow/${flow.id}/usage`);
      if (data?.canDelete) {
        setModalMode("confirm");
        setModalCampaigns([]);
      } else {
        setModalMode("attached");
        setModalCampaigns(Array.isArray(data?.campaigns) ? data.campaigns : []);
      }
      setModalOpen(true);
      setTimeout(() => closeBtnRef.current?.focus(), 0);
    } catch (err) {
      toast.error("‚ùå Could not check usage for this flow.");
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  const confirmDelete = async () => {
    if (!targetFlow) return;
    setLoading(true);
    try {
      const res = await axiosClient.delete(`/cta-flow/${targetFlow.id}`);
      if (res.status === 204 || res.status === 200) {
        toast.success("‚úÖ Flow deleted permanently.");
        setModalOpen(false);
        setTargetFlow(null);
        await fetchFlows(activeTab);
      } else {
        toast.info("‚ÑπÔ∏è Unexpected response while deleting the flow.");
      }
    } catch (err) {
      const status = err?.response?.status;
      if (status === 409) {
        const campaigns = err.response?.data?.campaigns ?? [];
        setModalMode("attached");
        setModalCampaigns(campaigns);
      } else if (status === 404) {
        toast.error("‚ùå Flow not found.");
        setModalOpen(false);
      } else {
        toast.error("‚ùå Failed to delete flow.");
        setModalOpen(false);
      }
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  // ---- publish from draft tab ----
  const publishFlow = async flow => {
    if (loading) return;
    try {
      setLoading(true);
      await axiosClient.post(`/cta-flow/${flow.id}/publish`);
      toast.success("‚úÖ Flow published.");
      // NEW: when publishing, move to Published tab (and reflect in URL)
      setSearchParams({ tab: "published" });
    } catch (err) {
      const status = err?.response?.status;
      if (status === 409) {
        toast.error(
          err?.response?.data?.message || "‚ùå Cannot publish right now."
        );
      } else if (status === 404) {
        toast.error("‚ùå Flow not found.");
      } else {
        toast.error("‚ùå Failed to publish flow.");
      }
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  const goView = flow => {
    if (loading) return;
    navigate(`/app/cta-flow/visual-builder?id=${flow.id}&mode=view`);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 to-emerald-50 relative">
      <div className="mx-auto max-w-7xl px-4 py-8">
        {/* Loading overlay */}
        {loading && (
          <>
            <div className="absolute inset-0 z-40 bg-white/60 backdrop-blur-[1px] flex items-center justify-center">
              <div className="flex items-center gap-3 text-gray-700">
                <svg
                  className="xafb-spin h-6 w-6 text-purple-600"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                >
                  <circle
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    strokeWidth="4"
                    opacity="0.25"
                  />
                  <path
                    d="M4 12a8 8 0 018-8"
                    stroke="currentColor"
                    strokeWidth="4"
                    strokeLinecap="round"
                    opacity="0.85"
                  />
                </svg>
                <span className="text-sm">Loading‚Ä¶</span>
              </div>
            </div>
            <style>{`@keyframes xafb-spin{to{transform:rotate(360deg)}}.xafb-spin{animation:xafb-spin 1s linear infinite}`}</style>
          </>
        )}

        {/* Header */}
        <div className="mb-8">
          <div className="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
            <div className="flex items-center gap-4">
              <div className="flex items-center gap-3">
                <div className="w-12 h-12 border border-gray-300 bg-gray-50 rounded-lg flex items-center justify-center">
                  <span className="text-gray-600 text-xl">üß©</span>
                </div>
                <div>
                  <h1
                    className="text-2xl font-bold text-gray-900 flex items-center gap-2"
                    style={{ fontFamily: "Plus Jakarta Sans, sans-serif" }}
                  >
                    <span className="text-blue-600">üß©</span>
                    CTA Flow Manager
                  </h1>
                  <p className="text-sm text-gray-600">
                    Create, publish, and manage your visual flows.
                  </p>
                </div>
              </div>
            </div>
            <div className="flex items-center gap-3">
              <button
                onClick={() => navigate("/app/cta-flow/visual-builder")}
                className="border-2 border-emerald-600 text-emerald-600 hover:bg-emerald-600 hover:text-white px-4 py-2 rounded-lg shadow-sm hover:shadow-lg transition-all duration-200 disabled:opacity-50 flex items-center gap-1.5 text-sm"
                disabled={loading}
              >
                <span className="text-sm text-gray-600">‚ûï</span>
                New Flow
              </button>
            </div>
          </div>
        </div>

        {/* Sticky controls */}
        <div className="sticky top-0 z-10 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70 rounded-lg border border-gray-200 p-4 mb-6 shadow-sm">
          <div className="flex flex-col lg:flex-row lg:items-center gap-4">
            {/* Tabs */}
            <div className="flex gap-2">
              {[
                { key: "published", label: "Published Flows", icon: "‚úÖ" },
                { key: "draft", label: "Draft Flows", icon: "üìù" },
              ].map(t => (
                <button
                  key={t.key}
                  className={`px-4 py-2.5 rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-2 ${
                    activeTab === t.key
                      ? "bg-emerald-600 text-white shadow-lg"
                      : "border border-gray-300 text-gray-600 hover:border-emerald-600 hover:text-emerald-600 hover:bg-emerald-50"
                  }`}
                  onClick={() => {
                    if (loading) return;
                    setSearchParams({ tab: t.key });
                  }}
                  disabled={loading}
                >
                  <span>{t.icon}</span>
                  {t.label}
                </button>
              ))}
            </div>

            <div className="flex-1" />

            {/* Search + sort */}
            <div className="flex items-center gap-3">
              <div className="relative">
                <input
                  type="text"
                  className="w-64 max-w-full rounded-lg border-gray-300 focus:ring-blue-500 focus:border-blue-500 text-sm pl-10 pr-4 py-2.5"
                  placeholder="Search by name or creator‚Ä¶"
                  value={query}
                  onChange={e => setQuery(e.target.value)}
                />
                <div className="absolute inset-y-0 left-3 grid place-items-center pointer-events-none text-gray-400">
                  üîé
                </div>
              </div>
              <select
                className="rounded-lg border-gray-300 text-sm focus:ring-blue-500 focus:border-blue-500 px-4 py-2.5"
                value={sortKey}
                onChange={e => setSortKey(e.target.value)}
              >
                <option value="updated">Sort: Last updated</option>
                <option value="name">Sort: Name (A‚ÄìZ)</option>
                <option value="created">Sort: Created (newest)</option>
              </select>
            </div>
          </div>
        </div>

        {/* Content */}
        {filtered.length === 0 ? (
          <div className="text-center py-16">
            <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <span className="text-2xl text-gray-400">üß©</span>
            </div>
            <h3 className="text-lg font-medium text-gray-900 mb-2">
              {query
                ? "No flows match your search"
                : activeTab === "published"
                ? "No published flows yet"
                : "No draft flows yet"}
            </h3>
            <p className="text-gray-500 mb-6">
              {query
                ? "Try adjusting your search terms"
                : activeTab === "published"
                ? "Publish a draft to see it here"
                : "Create a new flow to get started"}
            </p>
            {!query && (
              <button
                onClick={() => navigate("/app/cta-flow/visual-builder")}
                className="border-2 border-emerald-600 text-emerald-600 hover:bg-emerald-600 hover:text-white px-6 py-3 rounded-lg shadow-sm hover:shadow-lg transition-all duration-200 flex items-center gap-2 mx-auto"
              >
                <span className="text-lg">‚ûï</span>
                Create Your First Flow
              </button>
            )}
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {filtered.map(flow => (
              <div
                key={flow.id}
                className="bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-lg transition-all duration-200 overflow-hidden"
              >
                <div className="p-6">
                  <div className="flex items-start justify-between mb-4">
                    <div className="flex-1">
                      <h3 className="text-lg font-semibold text-gray-900 mb-1">
                        {flow.flowName}
                      </h3>
                      <p className="text-sm text-gray-500">
                        Created {formatDate(flow.createdAt)}
                      </p>
                    </div>
                    <div className="ml-3">{statusPill(flow.isPublished)}</div>
                  </div>

                  <div className="text-sm text-gray-600 mb-4">
                    <div className="flex items-center gap-2">
                      <span className="text-gray-400">üìÖ</span>
                      <span>
                        Last modified:{" "}
                        {formatDate(flow.updatedAt || flow.createdAt)}
                      </span>
                    </div>
                  </div>

                  <div className="flex items-center gap-2">
                    <button
                      onClick={() => goView(flow)}
                      className="flex-1 border-2 border-gray-300 bg-white hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 disabled:opacity-50"
                      disabled={loading}
                    >
                      üëÅÔ∏è View
                    </button>

                    {/* PUBLISH (only for drafts) */}
                    {!flow.isPublished && (
                      <button
                        onClick={() => publishFlow(flow)}
                        className="flex-1 border-2 border-transparent bg-gradient-to-r from-emerald-200 to-emerald-300 hover:from-emerald-300 hover:to-emerald-400 text-emerald-700 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 disabled:opacity-50"
                        disabled={loading}
                        title="Publish this draft"
                      >
                        üöÄ Publish
                      </button>
                    )}

                    <button
                      onClick={() => openDeleteModal(flow)}
                      className="border-2 border-transparent bg-gradient-to-r from-gray-200 to-gray-300 hover:from-gray-300 hover:to-gray-400 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 disabled:opacity-50"
                      disabled={loading}
                    >
                      üóëÔ∏è
                    </button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Modal */}
      {modalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
          <div
            className="absolute inset-0 bg-black/50 backdrop-blur-sm"
            onClick={() => setModalOpen(false)}
          />
          <div
            role="dialog"
            aria-modal="true"
            className="relative bg-white rounded-lg shadow-2xl w-full max-w-xl p-8"
          >
            {modalMode === "attached" ? (
              <>
                <div className="flex items-start gap-4 mb-6">
                  <div className="shrink-0 mt-1 h-10 w-10 rounded-full bg-rose-100 text-rose-600 grid place-items-center">
                    ‚ö†Ô∏è
                  </div>
                  <div>
                    <h3 className="text-xl font-bold text-gray-900 mb-2">
                      Cannot delete this flow
                    </h3>
                    <p className="text-gray-600">
                      <span className="font-semibold text-gray-900">
                        {targetFlow?.flowName}
                      </span>{" "}
                      is attached to the following campaign
                      {modalCampaigns.length > 1 ? "s" : ""}. Delete those
                      first.
                    </p>
                  </div>
                </div>
                <div className="max-h-72 overflow-auto rounded-lg border divide-y">
                  {modalCampaigns.map(c => (
                    <div key={c.id} className="p-3 text-sm">
                      <div className="flex items-center justify-between">
                        <div className="font-semibold text-gray-900">
                          {c.name}
                        </div>
                        <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-700">
                          {c.status || "‚Äî"}
                        </span>
                      </div>
                      <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
                        <div>
                          Created:{" "}
                          <span className="font-medium text-gray-800">
                            {formatDate(c.createdAt)}
                          </span>
                        </div>
                        <div>
                          Created by:{" "}
                          <span className="font-medium text-gray-800">
                            {c.createdBy || "‚Äî"}
                          </span>
                        </div>
                        <div>
                          Scheduled:{" "}
                          <span className="font-medium text-gray-800">
                            {formatDate(c.scheduledAt)}
                          </span>
                        </div>
                        <div>
                          First sent:{" "}
                          <span className="font-medium text-gray-800">
                            {formatDate(c.firstSentAt)}
                          </span>
                        </div>
                      </div>
                    </div>
                  ))}
                  {modalCampaigns.length === 0 && (
                    <div className="p-3 text-sm text-gray-600">
                      Could not load campaigns.
                    </div>
                  )}
                </div>
                <div className="mt-6 flex justify-end">
                  <button
                    ref={closeBtnRef}
                    className="px-6 py-3 text-sm font-medium rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors"
                    onClick={() => setModalOpen(false)}
                  >
                    Close
                  </button>
                </div>
              </>
            ) : (
              <>
                <div className="flex items-start gap-4 mb-6">
                  <div className="shrink-0 mt-1 h-10 w-10 rounded-full bg-rose-100 text-rose-600 grid place-items-center">
                    üóëÔ∏è
                  </div>
                  <div>
                    <h3 className="text-xl font-bold text-gray-900 mb-2">
                      Delete this flow permanently?
                    </h3>
                    <p className="text-gray-600">
                      This will remove{" "}
                      <span className="font-semibold text-gray-900">
                        {targetFlow?.flowName}
                      </span>{" "}
                      and all of its steps and button links. This action cannot
                      be undone.
                    </p>
                  </div>
                </div>
                <div className="rounded-lg border border-rose-200 p-4 bg-rose-50 text-rose-700 text-sm mb-6">
                  <span className="font-semibold">Warning:</span> Permanent
                  deletion cannot be recovered.
                </div>
                <div className="flex justify-end gap-3">
                  <button
                    className="px-6 py-3 text-sm font-medium rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors"
                    onClick={() => setModalOpen(false)}
                  >
                    Cancel
                  </button>
                  <button
                    onClick={confirmDelete}
                    className="px-6 py-3 text-sm font-medium rounded-lg bg-rose-600 text-white hover:bg-rose-700 transition-colors"
                  >
                    Permanently delete
                  </button>
                </div>
              </>
            )}
          </div>
        </div>
      )}
    </div>
  );
}

// // üìÑ File: xbytechat-ui/src/pages/CTAFlowVisualBuilder/CTAFlowManager.jsx
// import React, { useEffect, useMemo, useRef, useState } from "react";
// import { useNavigate } from "react-router-dom";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";

// export default function CTAFlowManager() {
//   const [flows, setFlows] = useState([]);
//   const [activeTab, setActiveTab] = useState("published"); // default Published
//   const [loading, setLoading] = useState(true);

//   const [modalOpen, setModalOpen] = useState(false);
//   const [modalMode, setModalMode] = useState("confirm"); // confirm | attached
//   const [modalCampaigns, setModalCampaigns] = useState([]);
//   const [targetFlow, setTargetFlow] = useState(null);

//   const [query, setQuery] = useState("");
//   const [sortKey, setSortKey] = useState("updated");
//   const closeBtnRef = useRef(null);
//   const navigate = useNavigate();

//   const formatDate = date =>
//     date
//       ? new Date(date).toLocaleString("en-IN", {
//           day: "2-digit",
//           month: "short",
//           year: "numeric",
//           hour: "2-digit",
//           minute: "2-digit",
//         })
//       : "‚Äî";

//   const statusPill = isPublished =>
//     isPublished ? (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">
//         <span>‚óè</span> Published
//       </span>
//     ) : (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">
//         <span>‚óè</span> Draft
//       </span>
//     );

//   const fetchFlows = async (tab = "published") => {
//     setLoading(true);
//     try {
//       const endpoint =
//         tab === "published" ? "/cta-flow/all-published" : "/cta-flow/all-draft";
//       const res = await axiosClient.get(endpoint);
//       setFlows(Array.isArray(res.data) ? res.data : [res.data]);
//     } catch (err) {
//       setFlows([]);
//       toast.error("‚ùå Failed to load flows.");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   useEffect(() => {
//     fetchFlows("published");
//   }, []);

//   const filtered = useMemo(() => {
//     const q = query.trim().toLowerCase();
//     let out = flows;
//     if (q) {
//       out = out.filter(f =>
//         [f.flowName, f.createdBy]
//           .filter(Boolean)
//           .some(v => String(v).toLowerCase().includes(q))
//       );
//     }
//     switch (sortKey) {
//       case "name":
//         return [...out].sort((a, b) => a.flowName.localeCompare(b.flowName));
//       case "created":
//         return [...out].sort(
//           (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
//         );
//       default:
//         return [...out].sort(
//           (a, b) =>
//             new Date(b.updatedAt || b.createdAt) -
//             new Date(a.updatedAt || a.createdAt)
//         );
//     }
//   }, [flows, query, sortKey]);

//   // ---- delete UX (checks usage) ----
//   const openDeleteModal = async flow => {
//     if (loading) return; // guard
//     setTargetFlow(flow);
//     setLoading(true);
//     try {
//       const { data } = await axiosClient.get(`/cta-flow/${flow.id}/usage`);
//       if (data?.canDelete) {
//         setModalMode("confirm");
//         setModalCampaigns([]);
//       } else {
//         setModalMode("attached");
//         setModalCampaigns(Array.isArray(data?.campaigns) ? data.campaigns : []);
//       }
//       setModalOpen(true);
//       setTimeout(() => closeBtnRef.current?.focus(), 0);
//     } catch (err) {
//       toast.error("‚ùå Could not check usage for this flow.");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   const confirmDelete = async () => {
//     if (!targetFlow) return;
//     setLoading(true);
//     try {
//       const res = await axiosClient.delete(`/cta-flow/${targetFlow.id}`);
//       if (res.status === 204 || res.status === 200) {
//         toast.success("‚úÖ Flow deleted permanently.");
//         setModalOpen(false);
//         setTargetFlow(null);
//         await fetchFlows(activeTab);
//       } else {
//         toast.info("‚ÑπÔ∏è Unexpected response while deleting the flow.");
//       }
//     } catch (err) {
//       const status = err?.response?.status;
//       if (status === 409) {
//         const campaigns = err.response?.data?.campaigns ?? [];
//         setModalMode("attached");
//         setModalCampaigns(campaigns);
//       } else if (status === 404) {
//         toast.error("‚ùå Flow not found.");
//         setModalOpen(false);
//       } else {
//         toast.error("‚ùå Failed to delete flow.");
//         setModalOpen(false);
//       }
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   // ---- publish from draft tab ----
//   const publishFlow = async flow => {
//     if (loading) return; // guard against spam clicks
//     try {
//       setLoading(true);
//       await axiosClient.post(`/cta-flow/${flow.id}/publish`);
//       toast.success("‚úÖ Flow published.");
//       // After publish, jump user to Published tab
//       setActiveTab("published");
//       await fetchFlows("published");
//     } catch (err) {
//       const status = err?.response?.status;
//       if (status === 409) {
//         // If backend blocks due to attachments (unlikely for drafts), surface message
//         toast.error(
//           err?.response?.data?.message || "‚ùå Cannot publish right now."
//         );
//       } else if (status === 404) {
//         toast.error("‚ùå Flow not found.");
//       } else {
//         toast.error("‚ùå Failed to publish flow.");
//       }
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   // ---- edit navigation (fix: ignore click while loading) ----
//   const goEdit = flow => {
//     if (loading) return;
//     // Always open builder in edit mode; builder enforces policies (fork/republish etc.)
//     navigate(`/app/cta-flow/visual-builder?id=${flow.id}&mode=edit`);
//   };

//   const goView = flow => {
//     if (loading) return;
//     navigate(`/app/cta-flow/visual-builder?id=${flow.id}&mode=view`);
//   };

//   return (
//     <div className="p-6 relative">
//       {/* Loading overlay */}
//       {loading && (
//         <>
//           <div className="absolute inset-0 z-40 bg-white/60 backdrop-blur-[1px] flex items-center justify-center">
//             <div className="flex items-center gap-3 text-gray-700">
//               <svg
//                 className="xafb-spin h-6 w-6 text-purple-600"
//                 xmlns="http://www.w3.org/2000/svg"
//                 viewBox="0 0 24 24"
//                 fill="none"
//               >
//                 <circle
//                   cx="12"
//                   cy="12"
//                   r="10"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   opacity="0.25"
//                 />
//                 <path
//                   d="M4 12a8 8 0 018-8"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   strokeLinecap="round"
//                   opacity="0.85"
//                 />
//               </svg>
//               <span className="text-sm">Loading‚Ä¶</span>
//             </div>
//           </div>
//           <style>{`@keyframes xafb-spin{to{transform:rotate(360deg)}}.xafb-spin{animation:xafb-spin 1s linear infinite}`}</style>
//         </>
//       )}

//       {/* Header */}
//       <div className="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between mb-6">
//         <div>
//           <h1 className="text-2xl font-bold text-gray-900">
//             üß© CTA Flow Manager
//           </h1>
//           <p className="text-sm text-gray-500">
//             Create, publish, and manage your visual flows.
//           </p>
//         </div>
//         <div className="flex items-center gap-2">
//           <button
//             onClick={() => navigate("/app/cta-flow/visual-builder")}
//             className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md shadow disabled:opacity-50"
//             disabled={loading}
//           >
//             ‚ûï New Flow
//           </button>
//         </div>
//       </div>

//       {/* Sticky controls */}
//       <div className="sticky top-0 z-10 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70 rounded-xl border p-3 mb-4">
//         <div className="flex flex-col sm:flex-row sm:items-center gap-3">
//           <div className="flex gap-3">
//             {[
//               { key: "published", label: "‚úÖ Published Flows" },
//               { key: "draft", label: "üìù Draft Flows" },
//             ].map(t => (
//               <button
//                 key={t.key}
//                 className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${
//                   activeTab === t.key
//                     ? "bg-purple-600 text-white shadow"
//                     : "text-gray-600 hover:text-purple-700 hover:bg-purple-50"
//                 }`}
//                 onClick={() => {
//                   if (loading) return;
//                   setActiveTab(t.key);
//                   fetchFlows(t.key);
//                 }}
//                 disabled={loading}
//               >
//                 {t.label}
//               </button>
//             ))}
//           </div>

//           <div className="flex-1" />

//           {/* Search + sort */}
//           <div className="flex items-center gap-2">
//             <div className="relative">
//               <input
//                 type="text"
//                 className="w-64 max-w-full rounded-md border-gray-300 focus:ring-purple-500 focus:border-purple-500 text-sm"
//                 placeholder="Search by name or creator‚Ä¶"
//                 value={query}
//                 onChange={e => setQuery(e.target.value)}
//               />
//               <div className="absolute inset-y-0 right-2 grid place-items-center pointer-events-none text-gray-400">
//                 üîé
//               </div>
//             </div>
//             <select
//               className="rounded-md border-gray-300 text-sm focus:ring-purple-500 focus:border-purple-500"
//               value={sortKey}
//               onChange={e => setSortKey(e.target.value)}
//             >
//               <option value="updated">Sort: Last updated</option>
//               <option value="name">Sort: Name (A‚ÄìZ)</option>
//               <option value="created">Sort: Created (newest)</option>
//             </select>
//           </div>
//         </div>
//       </div>

//       {/* Table */}
//       {filtered.length === 0 ? (
//         <div className="text-gray-500 text-center py-16">
//           {query
//             ? "No flows match your search."
//             : activeTab === "published"
//             ? "No published flows yet. Publish a draft to see it here."
//             : "No draft flows yet. Create a new flow to get started."}
//         </div>
//       ) : (
//         <div className="bg-white rounded-xl shadow overflow-hidden">
//           <table className="w-full text-sm">
//             <thead className="bg-gray-50 border-b text-gray-500 uppercase text-xs tracking-wide">
//               <tr>
//                 <th className="px-4 py-3 text-left">Flow Name</th>
//                 <th className="px-4 py-3 text-left">Status</th>
//                 <th className="px-4 py-3 text-left">Last Modified</th>
//                 <th className="px-4 py-3 text-right">Actions</th>
//               </tr>
//             </thead>
//             <tbody className="divide-y divide-gray-100">
//               {filtered.map(flow => (
//                 <tr key={flow.id} className="hover:bg-gray-50">
//                   <td className="px-4 py-3">
//                     <div className="font-medium text-gray-900">
//                       {flow.flowName}
//                     </div>
//                     <div className="text-xs text-gray-500">
//                       Created {formatDate(flow.createdAt)}
//                     </div>
//                   </td>
//                   <td className="px-4 py-3">{statusPill(flow.isPublished)}</td>
//                   <td className="px-4 py-3 text-gray-700">
//                     {formatDate(flow.updatedAt || flow.createdAt)}
//                   </td>
//                   <td className="px-4 py-3">
//                     <div className="flex justify-end gap-3">
//                       <button
//                         onClick={() => goView(flow)}
//                         className="text-blue-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üëÅÔ∏è View
//                       </button>

//                       {/* EDIT */}
//                       {/* <button
//                         onClick={() => goEdit(flow)}
//                         className="text-amber-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         ‚úèÔ∏è {flow.isPublished ? "Edit" : "Edit Draft"}
//                       </button> */}

//                       {/* PUBLISH (only show for drafts) */}
//                       {!flow.isPublished && (
//                         <button
//                           onClick={() => publishFlow(flow)}
//                           className="text-emerald-600 hover:underline text-xs disabled:opacity-50"
//                           disabled={loading}
//                           title="Publish this draft"
//                         >
//                           üöÄ Publish
//                         </button>
//                       )}

//                       {/* DELETE */}
//                       <button
//                         onClick={() => openDeleteModal(flow)}
//                         className="text-rose-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üóëÔ∏è Delete
//                       </button>
//                     </div>
//                   </td>
//                 </tr>
//               ))}
//             </tbody>
//           </table>
//         </div>
//       )}

//       {/* Modal */}
//       {modalOpen && (
//         <div className="fixed inset-0 z-50 flex items-center justify-center">
//           <div
//             className="absolute inset-0 bg-black/40"
//             onClick={() => setModalOpen(false)}
//           />
//           <div
//             role="dialog"
//             aria-modal="true"
//             className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
//           >
//             {modalMode === "attached" ? (
//               <>
//                 <div className="flex items-start gap-3 mb-4">
//                   <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                     ‚ö†Ô∏è
//                   </div>
//                   <div>
//                     <h3 className="text-lg font-semibold text-gray-900">
//                       Cannot delete this flow
//                     </h3>
//                     <p className="text-sm text-gray-600">
//                       <span className="font-medium">
//                         {targetFlow?.flowName}
//                       </span>{" "}
//                       is attached to the following campaign
//                       {modalCampaigns.length > 1 ? "s" : ""}. Delete those
//                       first.
//                     </p>
//                   </div>
//                 </div>
//                 <div className="max-h-72 overflow-auto rounded-lg border divide-y">
//                   {modalCampaigns.map(c => (
//                     <div key={c.id} className="p-3 text-sm">
//                       <div className="flex items-center justify-between">
//                         <div className="font-semibold text-gray-900">
//                           {c.name}
//                         </div>
//                         <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-700">
//                           {c.status || "‚Äî"}
//                         </span>
//                       </div>
//                       <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
//                         <div>
//                           Created:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.createdAt)}
//                           </span>
//                         </div>
//                         <div>
//                           Created by:{" "}
//                           <span className="font-medium text-gray-800">
//                             {c.createdBy || "‚Äî"}
//                           </span>
//                         </div>
//                         <div>
//                           Scheduled:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.scheduledAt)}
//                           </span>
//                         </div>
//                         <div>
//                           First sent:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.firstSentAt)}
//                           </span>
//                         </div>
//                       </div>
//                     </div>
//                   ))}
//                   {modalCampaigns.length === 0 && (
//                     <div className="p-3 text-sm text-gray-600">
//                       Could not load campaigns.
//                     </div>
//                   )}
//                 </div>
//                 <div className="mt-5 flex justify-end">
//                   <button
//                     ref={closeBtnRef}
//                     className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                     onClick={() => setModalOpen(false)}
//                   >
//                     Close
//                   </button>
//                 </div>
//               </>
//             ) : (
//               <>
//                 <div className="flex items-start gap-3 mb-4">
//                   <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                     üóëÔ∏è
//                   </div>
//                   <div>
//                     <h3 className="text-lg font-semibold text-gray-900">
//                       Delete this flow permanently?
//                     </h3>
//                     <p className="text-sm text-gray-600">
//                       This will remove{" "}
//                       <span className="font-medium">
//                         {targetFlow?.flowName}
//                       </span>{" "}
//                       and all of its steps and button links. This action cannot
//                       be undone.
//                     </p>
//                   </div>
//                 </div>
//                 <div className="rounded-lg border p-3 bg-rose-50 text-rose-700 text-sm">
//                   <span className="font-semibold">Warning:</span> Permanent
//                   deletion cannot be recovered.
//                 </div>
//                 <div className="mt-5 flex justify-end gap-2">
//                   <button
//                     className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                     onClick={() => setModalOpen(false)}
//                   >
//                     Cancel
//                   </button>
//                   <button
//                     onClick={confirmDelete}
//                     className="px-3 py-2 text-sm rounded bg-rose-600 text-white hover:bg-rose-700"
//                   >
//                     Permanently delete
//                   </button>
//                 </div>
//               </>
//             )}
//           </div>
//         </div>
//       )}
//     </div>
//   );
// }

// // üìÑ File: xbytechat-ui/src/pages/CTAFlowVisualBuilder/CTAFlowManager.jsx
// import React, { useEffect, useMemo, useRef, useState } from "react";
// import { useNavigate } from "react-router-dom";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";

// export default function CTAFlowManager() {
//   const [flows, setFlows] = useState([]);
//   const [activeTab, setActiveTab] = useState("published"); // default Published
//   const [loading, setLoading] = useState(true);

//   const [modalOpen, setModalOpen] = useState(false);
//   const [modalMode, setModalMode] = useState("confirm"); // confirm | attached
//   const [modalCampaigns, setModalCampaigns] = useState([]);
//   const [targetFlow, setTargetFlow] = useState(null);

//   const [query, setQuery] = useState("");
//   const [sortKey, setSortKey] = useState("updated");
//   const closeBtnRef = useRef(null);
//   const navigate = useNavigate();

//   const formatDate = date =>
//     date
//       ? new Date(date).toLocaleString("en-IN", {
//           day: "2-digit",
//           month: "short",
//           year: "numeric",
//           hour: "2-digit",
//           minute: "2-digit",
//         })
//       : "‚Äî";

//   const statusPill = isPublished =>
//     isPublished ? (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">
//         <span>‚óè</span> Published
//       </span>
//     ) : (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">
//         <span>‚óè</span> Draft
//       </span>
//     );

//   const fetchFlows = async (tab = "published") => {
//     setLoading(true);
//     try {
//       const endpoint =
//         tab === "published" ? "/cta-flow/all-published" : "/cta-flow/all-draft";
//       const res = await axiosClient.get(endpoint);
//       setFlows(Array.isArray(res.data) ? res.data : [res.data]);
//     } catch (err) {
//       setFlows([]);
//       toast.error("‚ùå Failed to load flows");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   useEffect(() => {
//     fetchFlows("published");
//   }, []);

//   const filtered = useMemo(() => {
//     const q = query.trim().toLowerCase();
//     let out = flows;
//     if (q) {
//       out = out.filter(f =>
//         [f.flowName, f.createdBy]
//           .filter(Boolean)
//           .some(v => String(v).toLowerCase().includes(q))
//       );
//     }
//     switch (sortKey) {
//       case "name":
//         return [...out].sort((a, b) => a.flowName.localeCompare(b.flowName));
//       case "created":
//         return [...out].sort(
//           (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
//         );
//       default:
//         return [...out].sort(
//           (a, b) =>
//             new Date(b.updatedAt || b.createdAt) -
//             new Date(a.updatedAt || a.createdAt)
//         );
//     }
//   }, [flows, query, sortKey]);

//   // ---- delete UX (checks usage) ----
//   const openDeleteModal = async flow => {
//     setTargetFlow(flow);
//     setLoading(true);
//     try {
//       const { data } = await axiosClient.get(`/cta-flow/${flow.id}/usage`);
//       if (data?.canDelete) {
//         setModalMode("confirm");
//         setModalCampaigns([]);
//       } else {
//         setModalMode("attached");
//         setModalCampaigns(Array.isArray(data?.campaigns) ? data.campaigns : []);
//       }
//       setModalOpen(true);
//       setTimeout(() => closeBtnRef.current?.focus(), 0);
//     } catch (err) {
//       toast.error("‚ùå Could not check usage for this flow.");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   const confirmDelete = async () => {
//     if (!targetFlow) return;
//     setLoading(true);
//     try {
//       const res = await axiosClient.delete(`/cta-flow/${targetFlow.id}`);
//       if (res.status === 204 || res.status === 200) {
//         toast.success("‚úÖ Flow deleted permanently.");
//         setModalOpen(false);
//         setTargetFlow(null);
//         await fetchFlows(activeTab);
//       } else {
//         toast.info("Unexpected response while deleting the flow.");
//       }
//     } catch (err) {
//       const status = err?.response?.status;
//       if (status === 409) {
//         const campaigns = err.response?.data?.campaigns ?? [];
//         setModalMode("attached");
//         setModalCampaigns(campaigns);
//       } else if (status === 404) {
//         toast.error("‚ùå Flow not found.");
//         setModalOpen(false);
//       } else {
//         toast.error("‚ùå Failed to delete flow.");
//         setModalOpen(false);
//       }
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   return (
//     <div className="p-6 relative">
//       {/* Loading overlay */}
//       {loading && (
//         <>
//           <div className="absolute inset-0 z-40 bg-white/60 backdrop-blur-[1px] flex items-center justify-center">
//             <div className="flex items-center gap-3 text-gray-700">
//               <svg
//                 className="xafb-spin h-6 w-6 text-purple-600"
//                 xmlns="http://www.w3.org/2000/svg"
//                 viewBox="0 0 24 24"
//                 fill="none"
//               >
//                 <circle
//                   cx="12"
//                   cy="12"
//                   r="10"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   opacity="0.25"
//                 />
//                 <path
//                   d="M4 12a8 8 0 018-8"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   strokeLinecap="round"
//                   opacity="0.85"
//                 />
//               </svg>
//               <span className="text-sm">Loading‚Ä¶</span>
//             </div>
//           </div>
//           <style>{`@keyframes xafb-spin{to{transform:rotate(360deg)}}.xafb-spin{animation:xafb-spin 1s linear infinite}`}</style>
//         </>
//       )}

//       {/* Header */}
//       <div className="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between mb-6">
//         <div>
//           <h1 className="text-2xl font-bold text-gray-900">
//             üß© CTA Flow Manager
//           </h1>
//           <p className="text-sm text-gray-500">
//             Create, publish, and manage your visual flows.
//           </p>
//         </div>
//         <div className="flex items-center gap-2">
//           <button
//             onClick={() => navigate("/app/cta-flow/visual-builder")}
//             className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md shadow disabled:opacity-50"
//             disabled={loading}
//           >
//             ‚ûï New Flow
//           </button>
//         </div>
//       </div>

//       {/* Sticky controls */}
//       <div className="sticky top-0 z-10 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70 rounded-xl border p-3 mb-4">
//         <div className="flex flex-col sm:flex-row sm:items-center gap-3">
//           <div className="flex gap-3">
//             {[
//               { key: "published", label: "‚úÖ Published Flows" },
//               { key: "draft", label: "üìù Draft Flows" },
//             ].map(t => (
//               <button
//                 key={t.key}
//                 className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${
//                   activeTab === t.key
//                     ? "bg-purple-600 text-white shadow"
//                     : "text-gray-600 hover:text-purple-700 hover:bg-purple-50"
//                 }`}
//                 onClick={() => {
//                   setActiveTab(t.key);
//                   fetchFlows(t.key);
//                 }}
//                 disabled={loading}
//               >
//                 {t.label}
//               </button>
//             ))}
//           </div>

//           <div className="flex-1" />

//           {/* Search + sort */}
//           <div className="flex items-center gap-2">
//             <div className="relative">
//               <input
//                 type="text"
//                 className="w-64 max-w-full rounded-md border-gray-300 focus:ring-purple-500 focus:border-purple-500 text-sm"
//                 placeholder="Search by name or creator‚Ä¶"
//                 value={query}
//                 onChange={e => setQuery(e.target.value)}
//               />
//               <div className="absolute inset-y-0 right-2 grid place-items-center pointer-events-none text-gray-400">
//                 üîé
//               </div>
//             </div>
//             <select
//               className="rounded-md border-gray-300 text-sm focus:ring-purple-500 focus:border-purple-500"
//               value={sortKey}
//               onChange={e => setSortKey(e.target.value)}
//             >
//               <option value="updated">Sort: Last updated</option>
//               <option value="name">Sort: Name (A‚ÄìZ)</option>
//               <option value="created">Sort: Created (newest)</option>
//             </select>
//           </div>
//         </div>
//       </div>

//       {/* Table */}
//       {filtered.length === 0 ? (
//         <div className="text-gray-500 text-center py-16">
//           {query
//             ? "No flows match your search."
//             : activeTab === "published"
//             ? "No published flows yet. Publish a draft to see it here."
//             : "No draft flows yet. Create a new flow to get started."}
//         </div>
//       ) : (
//         <div className="bg-white rounded-xl shadow overflow-hidden">
//           <table className="w-full text-sm">
//             <thead className="bg-gray-50 border-b text-gray-500 uppercase text-xs tracking-wide">
//               <tr>
//                 <th className="px-4 py-3 text-left">Flow Name</th>
//                 <th className="px-4 py-3 text-left">Status</th>
//                 <th className="px-4 py-3 text-left">Last Modified</th>
//                 <th className="px-4 py-3 text-right">Actions</th>
//               </tr>
//             </thead>
//             <tbody className="divide-y divide-gray-100">
//               {filtered.map(flow => (
//                 <tr key={flow.id} className="hover:bg-gray-50">
//                   <td className="px-4 py-3">
//                     <div className="font-medium text-gray-900">
//                       {flow.flowName}
//                     </div>
//                     <div className="text-xs text-gray-500">
//                       Created {formatDate(flow.createdAt)}
//                     </div>
//                   </td>
//                   <td className="px-4 py-3">{statusPill(flow.isPublished)}</td>
//                   <td className="px-4 py-3 text-gray-700">
//                     {formatDate(flow.updatedAt || flow.createdAt)}
//                   </td>
//                   <td className="px-4 py-3">
//                     <div className="flex justify-end gap-3">
//                       <button
//                         onClick={() =>
//                           navigate(
//                             `/app/cta-flow/visual-builder?id=${flow.id}&mode=view`
//                           )
//                         }
//                         className="text-blue-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üëÅÔ∏è View
//                       </button>

//                       {/* EDIT gate: if published, we'll decide in the builder whether republish is needed or fork */}
//                       <button
//                         onClick={() =>
//                           navigate(
//                             `/app/cta-flow/visual-builder?id=${flow.id}&mode=edit`
//                           )
//                         }
//                         className="text-amber-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         ‚úèÔ∏è Edit
//                       </button>

//                       <button
//                         onClick={() => openDeleteModal(flow)}
//                         className="text-rose-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üóëÔ∏è Delete
//                       </button>
//                     </div>
//                   </td>
//                 </tr>
//               ))}
//             </tbody>
//           </table>
//         </div>
//       )}

//       {/* Modal */}
//       {modalOpen && (
//         <div className="fixed inset-0 z-50 flex items-center justify-center">
//           <div
//             className="absolute inset-0 bg-black/40"
//             onClick={() => setModalOpen(false)}
//           />
//           <div
//             role="dialog"
//             aria-modal="true"
//             className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
//           >
//             {modalMode === "attached" ? (
//               <>
//                 <div className="flex items-start gap-3 mb-4">
//                   <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                     ‚ö†Ô∏è
//                   </div>
//                   <div>
//                     <h3 className="text-lg font-semibold text-gray-900">
//                       Cannot delete this flow
//                     </h3>
//                     <p className="text-sm text-gray-600">
//                       <span className="font-medium">
//                         {targetFlow?.flowName}
//                       </span>{" "}
//                       is attached to the following campaign
//                       {modalCampaigns.length > 1 ? "s" : ""}. Delete those
//                       first.
//                     </p>
//                   </div>
//                 </div>
//                 <div className="max-h-72 overflow-auto rounded-lg border divide-y">
//                   {modalCampaigns.map(c => (
//                     <div key={c.id} className="p-3 text-sm">
//                       <div className="flex items-center justify-between">
//                         <div className="font-semibold text-gray-900">
//                           {c.name}
//                         </div>
//                         <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-700">
//                           {c.status || "‚Äî"}
//                         </span>
//                       </div>
//                       <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
//                         <div>
//                           Created:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.createdAt)}
//                           </span>
//                         </div>
//                         <div>
//                           Created by:{" "}
//                           <span className="font-medium text-gray-800">
//                             {c.createdBy || "‚Äî"}
//                           </span>
//                         </div>
//                         <div>
//                           Scheduled:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.scheduledAt)}
//                           </span>
//                         </div>
//                         <div>
//                           First sent:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.firstSentAt)}
//                           </span>
//                         </div>
//                       </div>
//                     </div>
//                   ))}
//                 </div>
//                 <div className="mt-5 flex justify-end">
//                   <button
//                     ref={closeBtnRef}
//                     className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                     onClick={() => setModalOpen(false)}
//                   >
//                     Close
//                   </button>
//                 </div>
//               </>
//             ) : (
//               <>
//                 <div className="flex items-start gap-3 mb-4">
//                   <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                     üóëÔ∏è
//                   </div>
//                   <div>
//                     <h3 className="text-lg font-semibold text-gray-900">
//                       Delete this flow permanently?
//                     </h3>
//                     <p className="text-sm text-gray-600">
//                       This will remove{" "}
//                       <span className="font-medium">
//                         {targetFlow?.flowName}
//                       </span>{" "}
//                       and all of its steps and button links. This action cannot
//                       be undone.
//                     </p>
//                   </div>
//                 </div>
//                 <div className="rounded-lg border p-3 bg-rose-50 text-rose-700 text-sm">
//                   <span className="font-semibold">Warning:</span> Permanent
//                   deletion cannot be recovered.
//                 </div>
//                 <div className="mt-5 flex justify-end gap-2">
//                   <button
//                     className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                     onClick={() => setModalOpen(false)}
//                   >
//                     Cancel
//                   </button>
//                   <button
//                     onClick={confirmDelete}
//                     className="px-3 py-2 text-sm rounded bg-rose-600 text-white hover:bg-rose-700"
//                   >
//                     Permanently delete
//                   </button>
//                 </div>
//               </>
//             )}
//           </div>
//         </div>
//       )}
//     </div>
//   );
// }

// import React, { useEffect, useMemo, useRef, useState } from "react";
// import { useNavigate } from "react-router-dom";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";

// export default function CTAFlowManager() {
//   // ---------- state ----------
//   const [flows, setFlows] = useState([]);
//   const [activeTab, setActiveTab] = useState("published"); // ‚úÖ default to published
//   const [loading, setLoading] = useState(true);

//   // Search + sort (client-side)
//   const [query, setQuery] = useState("");
//   const [sortKey, setSortKey] = useState("updated"); // updated | name | created

//   // Modal
//   const [modalOpen, setModalOpen] = useState(false);
//   const [modalMode, setModalMode] = useState("confirm"); // confirm | attached
//   const [modalCampaigns, setModalCampaigns] = useState([]);
//   const [targetFlow, setTargetFlow] = useState(null);

//   const navigate = useNavigate();
//   const closeBtnRef = useRef(null);

//   // ---------- helpers ----------
//   const formatDate = date => {
//     if (!date) return "‚Äî";
//     const d = new Date(date);
//     return d.toLocaleString("en-IN", {
//       day: "2-digit",
//       month: "short",
//       year: "numeric",
//       hour: "2-digit",
//       minute: "2-digit",
//     });
//   };

//   const statusPill = isPublished =>
//     isPublished ? (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">
//         <span>‚óè</span> Published
//       </span>
//     ) : (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">
//         <span>‚óè</span> Draft
//       </span>
//     );

//   const renderStatusBadge = status => {
//     const s = (status || "").toLowerCase();
//     const map = {
//       draft: "bg-amber-100 text-amber-700",
//       scheduled: "bg-sky-100 text-sky-700",
//       running: "bg-blue-100 text-blue-700",
//       sent: "bg-emerald-100 text-emerald-700",
//       completed: "bg-emerald-100 text-emerald-700",
//       failed: "bg-rose-100 text-rose-700",
//     };
//     const cls = map[s] || "bg-gray-100 text-gray-700";
//     return (
//       <span
//         className={`inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium ${cls}`}
//       >
//         {status || "‚Äî"}
//       </span>
//     );
//   };

//   // ---------- data ----------
//   const fetchFlows = async (tab = "published") => {
//     setLoading(true);
//     try {
//       const endpoint =
//         tab === "published" ? "/cta-flow/all-published" : "/cta-flow/all-draft";
//       const res = await axiosClient.get(endpoint);
//       const list = Array.isArray(res.data) ? res.data : [res.data];
//       setFlows(list);
//     } catch (err) {
//       setFlows([]);
//       toast.error("‚ùå Failed to load flows");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   useEffect(() => {
//     fetchFlows("published"); // ‚úÖ first load = published
//   }, []);

//   // ---------- search + sort (client-side) ----------
//   const filtered = useMemo(() => {
//     const q = query.trim().toLowerCase();
//     let out = flows;
//     if (q) {
//       out = out.filter(f =>
//         [f.flowName, f.createdBy]
//           .filter(Boolean)
//           .some(v => String(v).toLowerCase().includes(q))
//       );
//     }
//     switch (sortKey) {
//       case "name":
//         out = [...out].sort((a, b) => a.flowName.localeCompare(b.flowName));
//         break;
//       case "created":
//         out = [...out].sort(
//           (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
//         );
//         break;
//       default:
//         out = [...out].sort(
//           (a, b) =>
//             new Date(b.updatedAt || b.createdAt) -
//             new Date(a.updatedAt || a.createdAt)
//         );
//     }
//     return out;
//   }, [flows, query, sortKey]);

//   // ---------- delete flow UX ----------
//   const openDeleteModal = async flow => {
//     setTargetFlow(flow);
//     setLoading(true);
//     try {
//       const { data } = await axiosClient.get(`/cta-flow/${flow.id}/usage`);
//       if (data?.canDelete) {
//         setModalMode("confirm");
//         setModalCampaigns([]);
//       } else {
//         setModalMode("attached");
//         setModalCampaigns(Array.isArray(data?.campaigns) ? data.campaigns : []);
//       }
//       setModalOpen(true);
//       setTimeout(() => closeBtnRef.current?.focus(), 0);
//     } catch (err) {
//       toast.error("‚ùå Could not check usage for this flow.");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   const confirmDelete = async () => {
//     if (!targetFlow) return;
//     setLoading(true);
//     try {
//       const res = await axiosClient.delete(`/cta-flow/${targetFlow.id}`);
//       if (res.status === 204 || res.status === 200) {
//         toast.success("‚úÖ Flow deleted permanently.");
//         setModalOpen(false);
//         setTargetFlow(null);
//         await fetchFlows(activeTab);
//       } else {
//         toast.info("Unexpected response while deleting the flow.");
//       }
//     } catch (err) {
//       const status = err?.response?.status;
//       if (status === 409) {
//         const campaigns = err.response?.data?.campaigns ?? [];
//         setModalMode("attached");
//         setModalCampaigns(campaigns);
//       } else if (status === 404) {
//         toast.error("‚ùå Flow not found.");
//         setModalOpen(false);
//       } else {
//         toast.error("‚ùå Failed to delete flow.");
//         setModalOpen(false);
//       }
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   // ---------- UI ----------
//   return (
//     <div className="p-6 relative">
//       {/* Loading overlay */}
//       {loading && (
//         <>
//           <div className="absolute inset-0 z-40 bg-white/60 backdrop-blur-[1px] flex items-center justify-center">
//             <div className="flex items-center gap-3 text-gray-700">
//               <svg
//                 className="xafb-spin h-6 w-6 text-purple-600"
//                 xmlns="http://www.w3.org/2000/svg"
//                 viewBox="0 0 24 24"
//                 fill="none"
//               >
//                 <circle
//                   cx="12"
//                   cy="12"
//                   r="10"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   opacity="0.25"
//                 />
//                 <path
//                   d="M4 12a8 8 0 018-8"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   strokeLinecap="round"
//                   opacity="0.85"
//                 />
//               </svg>
//               <span className="text-sm">Loading‚Ä¶</span>
//             </div>
//           </div>
//           <style>{`@keyframes xafb-spin{to{transform:rotate(360deg)}}.xafb-spin{animation:xafb-spin 1s linear infinite}`}</style>
//         </>
//       )}

//       {/* Page header */}
//       <div className="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between mb-6">
//         <div>
//           <h1 className="text-2xl font-bold text-gray-900">
//             üß© CTA Flow Manager
//           </h1>
//           <p className="text-sm text-gray-500">
//             Create, publish, and manage your visual flows.
//           </p>
//         </div>
//         <div className="flex items-center gap-2">
//           <button
//             onClick={() => navigate("/app/cta-flow/visual-builder")}
//             className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md shadow disabled:opacity-50"
//             disabled={loading}
//           >
//             ‚ûï New Flow
//           </button>
//         </div>
//       </div>

//       {/* Sticky controls */}
//       <div className="sticky top-0 z-10 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70 rounded-xl border p-3 mb-4">
//         <div className="flex flex-col sm:flex-row sm:items-center gap-3">
//           {/* Tabs */}
//           <div className="flex gap-3">
//             {[
//               { key: "published", label: "‚úÖ Published Flows" },
//               { key: "draft", label: "üìù Draft Flows" },
//             ].map(t => (
//               <button
//                 key={t.key}
//                 className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${
//                   activeTab === t.key
//                     ? "bg-purple-600 text-white shadow"
//                     : "text-gray-600 hover:text-purple-700 hover:bg-purple-50"
//                 }`}
//                 onClick={() => {
//                   setActiveTab(t.key);
//                   fetchFlows(t.key);
//                 }}
//                 disabled={loading}
//               >
//                 {t.label}
//               </button>
//             ))}
//           </div>

//           {/* Spacer */}
//           <div className="flex-1" />

//           {/* Search */}
//           <div className="flex items-center gap-2">
//             <div className="relative">
//               <input
//                 type="text"
//                 className="w-64 max-w-full rounded-md border-gray-300 focus:ring-purple-500 focus:border-purple-500 text-sm"
//                 placeholder="Search by name or creator‚Ä¶"
//                 value={query}
//                 onChange={e => setQuery(e.target.value)}
//               />
//               <div className="absolute inset-y-0 right-2 grid place-items-center pointer-events-none text-gray-400">
//                 üîé
//               </div>
//             </div>

//             {/* Sort */}
//             <select
//               className="rounded-md border-gray-300 text-sm focus:ring-purple-500 focus:border-purple-500"
//               value={sortKey}
//               onChange={e => setSortKey(e.target.value)}
//             >
//               <option value="updated">Sort: Last updated</option>
//               <option value="name">Sort: Name (A‚ÄìZ)</option>
//               <option value="created">Sort: Created (newest)</option>
//             </select>
//           </div>
//         </div>
//       </div>

//       {/* Content */}
//       {filtered.length === 0 ? (
//         <div className="text-gray-500 text-center py-16">
//           {query
//             ? "No flows match your search."
//             : activeTab === "published"
//             ? "No published flows yet. Publish a draft to see it here."
//             : "No draft flows yet. Create a new flow to get started."}
//         </div>
//       ) : (
//         <div className="bg-white rounded-xl shadow overflow-hidden">
//           <table className="w-full text-sm">
//             <thead className="bg-gray-50 border-b text-gray-500 uppercase text-xs tracking-wide">
//               <tr>
//                 <th className="px-4 py-3 text-left">Flow Name</th>
//                 <th className="px-4 py-3 text-left">Status</th>
//                 <th className="px-4 py-3 text-left">Last Modified</th>
//                 <th className="px-4 py-3 text-right">Actions</th>
//               </tr>
//             </thead>
//             <tbody className="divide-y divide-gray-100">
//               {filtered.map(flow => (
//                 <tr key={flow.id} className="hover:bg-gray-50">
//                   <td className="px-4 py-3">
//                     <div className="font-medium text-gray-900">
//                       {flow.flowName}
//                     </div>
//                     <div className="text-xs text-gray-500">
//                       Created {formatDate(flow.createdAt)}
//                     </div>
//                   </td>
//                   <td className="px-4 py-3">{statusPill(flow.isPublished)}</td>
//                   <td className="px-4 py-3 text-gray-700">
//                     {formatDate(flow.updatedAt || flow.createdAt)}
//                   </td>
//                   <td className="px-4 py-3">
//                     <div className="flex justify-end gap-3">
//                       <button
//                         onClick={() =>
//                           navigate(
//                             `/app/cta-flow/visual-builder?id=${flow.id}&mode=view`
//                           )
//                         }
//                         className="text-blue-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üëÅÔ∏è View
//                       </button>
//                       {!flow.isPublished && (
//                         <button
//                           onClick={() =>
//                             navigate(
//                               `/app/cta-flow/visual-builder?id=${flow.id}&mode=edit`
//                             )
//                           }
//                           className="text-amber-600 hover:underline text-xs disabled:opacity-50"
//                           disabled={loading}
//                         >
//                           ‚úèÔ∏è Edit
//                         </button>
//                       )}
//                       <button
//                         onClick={() => openDeleteModal(flow)}
//                         className="text-rose-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üóëÔ∏è Delete
//                       </button>
//                     </div>
//                   </td>
//                 </tr>
//               ))}
//             </tbody>
//           </table>
//         </div>
//       )}

//       {/* Modal */}
//       {modalOpen && (
//         <div className="fixed inset-0 z-50 flex items-center justify-center">
//           <div
//             className="absolute inset-0 bg-black/40"
//             onClick={() => setModalOpen(false)}
//           />
//           <div
//             role="dialog"
//             aria-modal="true"
//             className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
//           >
//             {/* Header */}
//             {modalMode === "attached" ? (
//               <div className="flex items-start gap-3 mb-4">
//                 <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                   ‚ö†Ô∏è
//                 </div>
//                 <div>
//                   <h3 className="text-lg font-semibold text-gray-900">
//                     Cannot delete this flow
//                   </h3>
//                   <p className="text-sm text-gray-600">
//                     <span className="font-medium">{targetFlow?.flowName}</span>{" "}
//                     is attached to the campaign
//                     {modalCampaigns.length > 1 ? "s" : ""} below. Delete those
//                     campaign
//                     {modalCampaigns.length > 1 ? "s" : ""} first.
//                   </p>
//                 </div>
//               </div>
//             ) : (
//               <div className="flex items-start gap-3 mb-4">
//                 <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                   üóëÔ∏è
//                 </div>
//                 <div>
//                   <h3 className="text-lg font-semibold text-gray-900">
//                     Delete this flow permanently?
//                   </h3>
//                   <p className="text-sm text-gray-600">
//                     This will remove{" "}
//                     <span className="font-medium">{targetFlow?.flowName}</span>{" "}
//                     and all of its steps and button links. This action cannot be
//                     undone.
//                   </p>
//                 </div>
//               </div>
//             )}

//             {/* Body */}
//             {modalMode === "attached" ? (
//               <div className="max-h-72 overflow-auto rounded-lg border divide-y">
//                 {modalCampaigns.map(c => (
//                   <div key={c.id} className="p-3 text-sm">
//                     <div className="flex items-center justify-between">
//                       <div className="font-semibold text-gray-900">
//                         {c.name}
//                       </div>
//                       {renderStatusBadge(c.status)}
//                     </div>
//                     <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
//                       <div>
//                         Created:{" "}
//                         <span className="font-medium text-gray-800">
//                           {formatDate(c.createdAt)}
//                         </span>
//                       </div>
//                       <div>
//                         Created by:{" "}
//                         <span className="font-medium text-gray-800">
//                           {c.createdBy || "‚Äî"}
//                         </span>
//                       </div>
//                       <div>
//                         Scheduled:{" "}
//                         <span className="font-medium text-gray-800">
//                           {formatDate(c.scheduledAt)}
//                         </span>
//                       </div>
//                       <div>
//                         First sent:{" "}
//                         <span className="font-medium text-gray-800">
//                           {formatDate(c.firstSentAt)}
//                         </span>
//                       </div>
//                     </div>
//                   </div>
//                 ))}
//               </div>
//             ) : (
//               <div className="rounded-lg border p-3 bg-rose-50 text-rose-700 text-sm">
//                 <span className="font-semibold">Warning:</span> This will
//                 permanently delete the flow and its data.
//               </div>
//             )}

//             {/* Footer */}
//             <div className="mt-5 flex justify-end gap-2">
//               <button
//                 ref={closeBtnRef}
//                 className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                 onClick={() => setModalOpen(false)}
//               >
//                 Close
//               </button>
//               {modalMode === "confirm" && (
//                 <button
//                   onClick={confirmDelete}
//                   className="px-3 py-2 text-sm rounded bg-rose-600 text-white hover:bg-rose-700"
//                 >
//                   Permanently delete
//                 </button>
//               )}
//             </div>
//           </div>
//         </div>
//       )}
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\ctaFlowVisualApi.js 
====================================================== 
 
// üìÑ File: xbytechat-ui/src/pages/CTAFlowVisualBuilder/ctaFlowVisualApi.js
import axiosClient from "../../api/axiosClient";

const toBool = v => v === true || v === "true" || v === 1;
const toPosInt = (v, def = 1) => {
  const n = parseInt(v, 10);
  return Number.isFinite(n) && n > 0 ? n : def;
};

// ---- shared payload normalizer ----
function normalizePayload(payload) {
  const safeNodes = (payload.Nodes || []).map(node => ({
    Id: node.Id || "",
    TemplateName: node.TemplateName || "",
    TemplateType: node.TemplateType || "text_template",
    MessageBody: node.MessageBody || "",
    PositionX: node.PositionX ?? 0,
    PositionY: node.PositionY ?? 0,
    TriggerButtonText: node.TriggerButtonText || "",
    TriggerButtonType: node.TriggerButtonType || "cta",
    UseProfileName: toBool(node.UseProfileName),
    ProfileNameSlot: toPosInt(node.ProfileNameSlot ?? 1, 1),
    Buttons: (node.Buttons || []).map((btn, idx) => ({
      Text: btn.Text || "",
      Type: btn.Type || "",
      SubType: btn.SubType || "",
      Value: btn.Value || "",
      Index: Number.isFinite(btn.Index) ? btn.Index : idx,
      TargetNodeId: btn.TargetNodeId || null,
    })),
  }));

  const safeEdges = (payload.Edges || []).map(e => ({
    FromNodeId: e.FromNodeId || "",
    ToNodeId: e.ToNodeId || "",
    SourceHandle: e.SourceHandle || "",
  }));

  return {
    FlowName: payload.FlowName || "Untitled",
    IsPublished: !!payload.IsPublished,
    Nodes: safeNodes,
    Edges: safeEdges,
  };
}

// ---- CREATE (by name) ----
export async function saveVisualFlow(payload) {
  const res = await axiosClient.post(
    "/cta-flow/save-visual",
    normalizePayload(payload)
  );
  return res.data;
}

// ---- LOAD BY ID ----
export async function getVisualFlowById(flowId) {
  if (!flowId) throw new Error("flowId is required");
  const res = await axiosClient.get(`/cta-flow/by-id/${flowId}`);
  return res.data;
}

// ---- USAGE (edit/delete gates) ----
export async function getFlowUsage(flowId) {
  if (!flowId) throw new Error("flowId is required");
  const { data } = await axiosClient.get(`/cta-flow/${flowId}/usage`);
  return data; // { canDelete, count, campaigns }
}

// ---- UPDATE BY ID ----
export async function updateVisualFlow(flowId, payload) {
  if (!flowId) throw new Error("flowId is required");
  const res = await axiosClient.put(
    `/cta-flow/${flowId}`,
    normalizePayload(payload)
  );
  return res.data; // { message, needsRepublish? }
}

// ---- PUBLISH ----
export async function publishFlow(flowId) {
  if (!flowId) throw new Error("flowId is required");
  const res = await axiosClient.post(`/cta-flow/${flowId}/publish`);
  return res.data;
}

// ---- FORK (create draft version) ----
export async function forkFlow(flowId) {
  if (!flowId) throw new Error("flowId is required");
  const res = await axiosClient.post(`/cta-flow/${flowId}/fork`);
  return res.data; // { flowId }
}

// ---- (Optional) DELETE helper for manager page ----
export async function deleteFlow(flowId) {
  if (!flowId) throw new Error("flowId is required");
  const res = await axiosClient.delete(`/cta-flow/${flowId}`);
  return res.data;
}

// // üìÑ File: xbytechat-ui/src/pages/CTAFlowVisualBuilder/ctaFlowVisualApi.js
// import axiosClient from "../../api/axiosClient";

// const toBool = v => v === true || v === "true" || v === 1;
// const toPosInt = (v, def = 1) => {
//   const n = parseInt(v, 10);
//   return Number.isFinite(n) && n > 0 ? n : def;
// };

// // ---- CREATE / UPSERT BY NAME (existing) ----
// export async function saveVisualFlow(payload) {
//   const safeNodes = (payload.Nodes || []).map(node => ({
//     Id: node.Id || "",
//     TemplateName: node.TemplateName || "",
//     TemplateType: node.TemplateType || "text_template",
//     MessageBody: node.MessageBody || "",
//     PositionX: node.PositionX ?? 0,
//     PositionY: node.PositionY ?? 0,
//     TriggerButtonText: node.TriggerButtonText || "",
//     TriggerButtonType: node.TriggerButtonType || "cta",
//     UseProfileName: toBool(node.UseProfileName),
//     ProfileNameSlot: toPosInt(node.ProfileNameSlot ?? 1, 1),
//     Buttons: (node.Buttons || []).map((btn, idx) => ({
//       Text: btn.Text || "",
//       Type: btn.Type || "",
//       SubType: btn.SubType || "",
//       Value: btn.Value || "",
//       Index: Number.isFinite(btn.Index) ? btn.Index : idx,
//       TargetNodeId: btn.TargetNodeId || null,
//     })),
//   }));

//   const safeEdges = (payload.Edges || []).map(e => ({
//     FromNodeId: e.FromNodeId || "",
//     ToNodeId: e.ToNodeId || "",
//     SourceHandle: e.SourceHandle || "",
//   }));

//   const fixedPayload = {
//     FlowName: payload.FlowName || "Untitled",
//     IsPublished: !!payload.IsPublished,
//     Nodes: safeNodes,
//     Edges: safeEdges,
//   };

//   const res = await axiosClient.post("/cta-flow/save-visual", fixedPayload);
//   return res.data;
// }

// // ---- LOAD BY ID (existing consumer in builder) ----
// export async function getVisualFlowById(flowId) {
//   const res = await axiosClient.get(`/cta-flow/by-id/${flowId}`);
//   return res.data;
// }

// // ---- NEW: usage for delete/edit gates ----
// export async function getFlowUsage(flowId) {
//   const { data } = await axiosClient.get(`/cta-flow/${flowId}/usage`);
//   return data; // { canDelete: boolean, campaigns: [] }
// }

// // ---- NEW: update by id (two-state policy on backend) ----
// export async function updateVisualFlow(flowId, payload) {
//   const res = await axiosClient.put(`/cta-flow/${flowId}`, payload);
//   return res.data; // { message, needsRepublish? }
// }

// // ---- NEW: publish ----
// export async function publishFlow(flowId) {
//   const res = await axiosClient.post(`/cta-flow/${flowId}/publish`);
//   return res.data;
// }

// // ---- NEW: fork ----
// export async function forkFlow(flowId) {
//   const res = await axiosClient.post(`/cta-flow/${flowId}/fork`);
//   return res.data; // { flowId }
// }

// import axiosClient from "../../api/axiosClient";
// /**
//  * Coerce values coming from the UI into clean types for the API.
//  */
// const toBool = v => v === true || v === "true" || v === 1;
// const toPosInt = (v, def = 1) => {
//   const n = parseInt(v, 10);
//   return Number.isFinite(n) && n > 0 ? n : def;
// };

// /**
//  * Save a visual flow (nodes + edges).
//  * Includes UseProfileName/ProfileNameSlot so the runtime knows where to inject the WA profile name.
//  */
// export async function saveVisualFlow(payload) {
//   const safeNodes = (payload.Nodes || []).map(node => ({
//     Id: node.Id || "",
//     TemplateName: node.TemplateName || "",
//     TemplateType: node.TemplateType || "text_template",
//     MessageBody: node.MessageBody || "",
//     PositionX: node.PositionX ?? 0,
//     PositionY: node.PositionY ?? 0,
//     TriggerButtonText: node.TriggerButtonText || "",
//     TriggerButtonType: node.TriggerButtonType || "cta",

//     // üëá NEW: persist the greeting controls per-step
//     UseProfileName: toBool(node.UseProfileName),
//     ProfileNameSlot: toPosInt(node.ProfileNameSlot ?? 1, 1),

//     // buttons with stable Index (used later to map clicks)
//     Buttons: (node.Buttons || []).map((btn, idx) => ({
//       Text: btn.Text || "",
//       Type: btn.Type || "",
//       SubType: btn.SubType || "",
//       Value: btn.Value || "",
//       TargetNodeId: btn.TargetNodeId || null,
//       Index: Number.isFinite(btn.Index) ? btn.Index : idx,
//     })),
//   }));

//   const safeEdges = (payload.Edges || []).map(e => ({
//     FromNodeId: e.FromNodeId || "",
//     ToNodeId: e.ToNodeId || "",
//     SourceHandle: e.SourceHandle || "", // button text
//   }));

//   const fixedPayload = {
//     FlowName: payload.FlowName || "Untitled",
//     IsPublished: !!payload.IsPublished,
//     Nodes: safeNodes,
//     Edges: safeEdges,
//   };

//   const res = await axiosClient.post("/cta-flow/save-visual", fixedPayload);
//   return res.data;
// }

// /**
//  * Load a visual flow by ID.
//  * The builder expects the response shape to include: { flowName, nodes: [...], edges: [...] }.
//  */
// export async function getVisualFlowById(flowId) {
//   const res = await axiosClient.get(`/cta-flow/by-id/${flowId}`);
//   return res.data;
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\CTAFlowVisualBuilder.jsx 
====================================================== 
 
// src/pages/CTAFlowVisualBuilder/CTAFlowVisualBuilder.jsx
import React, {
  useCallback,
  useState,
  useEffect,
  useMemo,
  useRef,
} from "react";
import {
  ReactFlow,
  ReactFlowProvider,
  Background,
  Controls,
  MiniMap,
  useNodesState,
  useEdgesState,
  addEdge,
  MarkerType,
  ConnectionMode,
  useReactFlow,
} from "@xyflow/react";
import "@xyflow/react/dist/style.css";
import { Eye, Minus } from "lucide-react";
import { useSearchParams, useNavigate } from "react-router-dom";
import TemplatePickerModal from "./components/TemplatePickerModal";
import FlowNodeBubble from "./components/FlowNodeBubble";
import {
  saveVisualFlow,
  getVisualFlowById,
  updateVisualFlow,
  publishFlow,
  forkFlow,
  getFlowUsage,
} from "./ctaFlowVisualApi";
import { v4 as uuidv4 } from "uuid";
import { toast } from "react-toastify";
import dagre from "dagre";
import SmartLabeledEdge from "./components/edges/SmartLabeledEdge";

const GRID = 16;
const NODE_DEFAULT = { width: 260, height: 140 };

function CTAFlowVisualBuilderInner() {
  const [nodes, setNodes, onNodesChange] = useNodesState([]);
  const [edges, setEdges, onEdgesChange] = useEdgesState([]);
  const nodesRef = useRef([]);
  const [showPicker, setShowPicker] = useState(false);
  const [flowName, setFlowName] = useState("");
  const flowNameRef = useRef(null);
  const [showMiniMap, setShowMiniMap] = useState(false);
  const [readonly, setReadonly] = useState(false);

  // policy state
  const [isPublished, setIsPublished] = useState(false);
  const [republishNeeded, setRepublishNeeded] = useState(false);
  const [lockInfo, setLockInfo] = useState({ locked: false, campaigns: [] });
  const [forkModalOpen, setForkModalOpen] = useState(false);

  // async state
  const [saving, setSaving] = useState(false);
  const [loading, setLoading] = useState(false);

  const [dirty, setDirty] = useState(false);

  const [searchParams] = useSearchParams();
  const navigate = useNavigate();
  const { fitView, zoomIn, zoomOut } = useReactFlow();

  const mode = searchParams.get("mode"); // 'edit' | 'view' | null
  const flowId = searchParams.get("id");
  const visualDebug = true;

  // figure out source tab for Back button
  const fromTab = (searchParams.get("from") || "draft").toLowerCase();
  const backTab = fromTab === "published" ? "published" : "draft";

  const goBackToManager = useCallback(() => {
    if (!readonly && dirty) {
      const ok = window.confirm("You have unsaved changes. Leave this page?");
      if (!ok) return;
    }
    navigate(`/app/cta-flow/flow-manager?tab=${backTab}`);
  }, [readonly, dirty, backTab, navigate]);

  useEffect(() => {
    nodesRef.current = [...nodes];
  }, [nodes]);

  // warn on unload if dirty
  useEffect(() => {
    const onBeforeUnload = e => {
      if (!dirty) return;
      e.preventDefault();
      e.returnValue = "";
    };
    window.addEventListener("beforeunload", onBeforeUnload);
    return () => window.removeEventListener("beforeunload", onBeforeUnload);
  }, [dirty]);

  // --- Node helpers
  const handleDeleteNode = useCallback(
    nodeId => {
      if (readonly) return;
      setDirty(true);
      setNodes(nds => nds.filter(n => n.id !== nodeId));
      setEdges(eds =>
        eds.filter(e => e.source !== nodeId && e.target !== nodeId)
      );
    },
    [readonly, setNodes, setEdges]
  );

  const handleNodeDataChange = useCallback(
    (nodeId, newData) => {
      setDirty(true);
      setNodes(nds =>
        nds.map(n =>
          n.id === nodeId ? { ...n, data: { ...n.data, ...newData } } : n
        )
      );
    },
    [setNodes]
  );

  const nodeTypes = useMemo(
    () => ({
      customBubble: props => (
        <FlowNodeBubble
          {...props}
          onDelete={handleDeleteNode}
          onDataChange={newData => handleNodeDataChange(props.id, newData)}
          readonly={readonly}
          visualDebug={visualDebug}
        />
      ),
    }),
    [handleDeleteNode, readonly, visualDebug, handleNodeDataChange]
  );

  const edgeTypes = useMemo(() => ({ smart: SmartLabeledEdge }), []);

  // --- Load / Bootstrap + policy checks
  useEffect(() => {
    const load = async () => {
      setLoading(true);
      if (mode === "edit" || mode === "view") {
        try {
          const data = await getVisualFlowById(flowId);

          const builtNodes = (data.nodes || []).map((node, index) => ({
            id: node.id,
            type: "customBubble",
            position: {
              x: node.positionX ?? 120 + index * 120,
              y: node.positionY ?? 150 + (index % 5) * 60,
            },
            data: {
              templateName: node.templateName,
              templateType: node.templateType,
              messageBody: node.messageBody,
              triggerButtonText: node.triggerButtonText || "",
              triggerButtonType: node.triggerButtonType || "cta",
              requiredTag: node.requiredTag || "",
              requiredSource: node.requiredSource || "",
              useProfileName: !!node.useProfileName,
              profileNameSlot:
                typeof node.profileNameSlot === "number" &&
                node.profileNameSlot > 0
                  ? node.profileNameSlot
                  : 1,
              buttons: (node.buttons || []).map((btn, i) => ({
                text: btn.text,
                type: btn.type,
                subType: btn.subType,
                value: btn.value,
                targetNodeId: btn.targetNodeId || null,
                index: typeof btn.index === "number" ? btn.index : i,
              })),
            },
          }));

          const builtEdges = (data.edges || []).map(edge => ({
            id: `e-${edge.fromNodeId}-${edge.toNodeId}-${
              edge.sourceHandle || "h"
            }`,
            source: edge.fromNodeId,
            target: edge.toNodeId,
            sourceHandle: edge.sourceHandle || null,
            type: "smart",
            animated: true,
            style: { stroke: "#9333ea" },
            markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
            label: edge.sourceHandle || "",
          }));

          const nodesWithIncoming = new Set(builtEdges.map(e => e.target));
          const nodesWithWarnings = builtNodes.map(node => ({
            ...node,
            data: {
              ...node.data,
              isUnreachable: false,
              hasNoIncoming: !nodesWithIncoming.has(node.id),
            },
          }));

          setNodes(nodesWithWarnings);
          setEdges(builtEdges);
          setFlowName(data.flowName || "Untitled Flow");
          setIsPublished(!!data.isPublished);
          setDirty(false);

          // policy: if editing a published flow, check attachment
          if (mode === "edit" && data.isPublished) {
            try {
              const usage = await getFlowUsage(flowId);
              if (usage?.campaigns?.length > 0) {
                setLockInfo({ locked: true, campaigns: usage.campaigns });
                setForkModalOpen(true);
                setReadonly(true);
              } else {
                setReadonly(false);
              }
            } catch {
              setLockInfo({ locked: true, campaigns: [] });
              setForkModalOpen(true);
              setReadonly(true);
            }
          } else {
            setReadonly(mode === "view");
          }

          // initial fit
          setTimeout(() => fitView({ padding: 0.25 }), 80);
        } catch {
          toast.error("‚ùå Failed to load flow");
        } finally {
          setLoading(false);
        }
      } else {
        // creating new flow
        setNodes([]);
        setEdges([]);
        setFlowName("Untitled Flow");
        setIsPublished(false);
        setReadonly(false);
        setDirty(false);
        setLoading(false);
        setTimeout(() => fitView({ padding: 0.25 }), 80);
      }
    };

    load();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [flowId, mode]);

  // Auto-fit when viewing, and refit on window resize
  useEffect(() => {
    if (mode !== "view") return;
    const t = setTimeout(() => fitView({ padding: 0.25 }), 80);
    const onResize = () => fitView({ padding: 0.25 });
    window.addEventListener("resize", onResize);
    return () => {
      clearTimeout(t);
      window.removeEventListener("resize", onResize);
    };
  }, [mode, nodes.length, edges.length, fitView]);

  // --- Add template
  const handleTemplateSelect = ({ name, type, body, buttons = [] }) => {
    if (readonly) return;
    const id = uuidv4();
    const newNode = {
      id,
      position: { x: Math.random() * 400 + 100, y: Math.random() * 300 + 100 },
      type: "customBubble",
      data: {
        templateName: name || "Untitled",
        templateType: type || "text_template",
        messageBody: body || "Message body preview...",
        triggerButtonText: buttons[0]?.text || "",
        triggerButtonType: "cta",
        useProfileName: false,
        profileNameSlot: 1,
        buttons: buttons.map((btn, idx) => ({
          text: btn.text || "",
          type: btn.type || "QUICK_REPLY",
          subType: btn.subType || "",
          value: btn.parameterValue || "",
          targetNodeId: null,
          index: idx,
        })),
      },
    };
    setDirty(true);
    setNodes(nds => [...nds, newNode]);
    setShowPicker(false);
    toast.success(
      `‚úÖ Step added with ${type?.replace("_", " ") || "template"}`
    );
    setTimeout(() => fitView({ padding: 0.25 }), 50);
  };

  // --- Connection rules
  const isValidConnection = useCallback(
    params => {
      if (!params?.source || !params?.sourceHandle) return false;
      const duplicate = edges.some(
        e =>
          e.source === params.source && e.sourceHandle === params.sourceHandle
      );
      return !duplicate;
    },
    [edges]
  );

  const onConnect = useCallback(
    params => {
      if (readonly) return;
      setDirty(true);
      const label = params.sourceHandle || "";

      setEdges(eds =>
        addEdge(
          {
            ...params,
            id: uuidv4(),
            type: "smart",
            animated: true,
            style: { stroke: "#9333ea" },
            markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
            label,
          },
          eds
        )
      );

      setNodes(nds =>
        nds.map(node => {
          if (node.id !== params.source) return node;
          const sourceHandle = params.sourceHandle || "";
          const updatedButtons = [...(node.data.buttons || [])];

          const idx = updatedButtons.findIndex(
            b =>
              (b.text || "").toLowerCase().trim() ===
              sourceHandle.toLowerCase().trim()
          );

          if (idx >= 0) {
            updatedButtons[idx] = {
              ...updatedButtons[idx],
              targetNodeId: params.target,
            };
          } else {
            const free = updatedButtons.findIndex(b => !b.targetNodeId);
            if (free >= 0)
              updatedButtons[free] = {
                ...updatedButtons[free],
                targetNodeId: params.target,
              };
          }

          return { ...node, data: { ...node.data, buttons: updatedButtons } };
        })
      );
    },
    [readonly, setEdges, setNodes]
  );

  // --- Keyboard UX
  useEffect(() => {
    const onKey = e => {
      if (readonly) return;
      if (e.key === "Delete" || e.key === "Backspace") {
        setDirty(true);
        setNodes(nds => nds.filter(n => !n.selected));
        setEdges(eds => eds.filter(ed => !ed.selected));
      }
      if (e.key === "Escape") {
        setNodes(nds => nds.map(n => ({ ...n, selected: false })));
        setEdges(eds => eds.map(ed => ({ ...ed, selected: false })));
      }
    };
    window.addEventListener("keydown", onKey);
    return () => window.removeEventListener("keydown", onKey);
  }, [readonly, setNodes, setEdges]);

  // --- Auto layout (dagre)
  const applyLayout = useCallback(
    (direction = "LR") => {
      const g = new dagre.graphlib.Graph();
      g.setGraph({
        rankdir: direction,
        nodesep: 50,
        ranksep: 90,
        marginx: 20,
        marginy: 20,
      });
      g.setDefaultEdgeLabel(() => ({}));

      nodes.forEach(n => {
        const width = n?.measured?.width || NODE_DEFAULT.width;
        const height = n?.measured?.height || NODE_DEFAULT.height;
        g.setNode(n.id, { width, height });
      });
      edges.forEach(e => g.setEdge(e.source, e.target));

      dagre.layout(g);

      const laidOut = nodes.map(n => {
        const { x, y } = g.node(n.id);
        const width = n?.measured?.width || NODE_DEFAULT.width;
        const height = n?.measured?.height || NODE_DEFAULT.height;
        return { ...n, position: { x: x - width / 2, y: y - height / 2 } };
      });

      setDirty(true);
      setNodes(laidOut);
      setTimeout(() => fitView({ padding: 0.25 }), 50);
    },
    [nodes, edges, setNodes, fitView]
  );

  // --- Build payload (draft by default; publish is separate)
  const buildPayload = () => {
    const transformedNodes = nodes
      .filter(n => n?.data?.templateName)
      .map(node => ({
        Id: node.id,
        TemplateName: node.data.templateName || "Untitled",
        TemplateType: node.data.templateType || "text_template",
        MessageBody: node.data.messageBody || "",
        PositionX: node.position?.x || 0,
        PositionY: node.position?.y || 0,
        TriggerButtonText: node.data.triggerButtonText || "",
        TriggerButtonType: node.data.triggerButtonType || "cta",
        RequiredTag: node.data.requiredTag || "",
        RequiredSource: node.data.requiredSource || "",
        UseProfileName: !!node.data.useProfileName,
        ProfileNameSlot:
          typeof node.data.profileNameSlot === "number" &&
          node.data.profileNameSlot > 0
            ? node.data.profileNameSlot
            : 1,
        Buttons: (node.data.buttons || [])
          .filter(btn => (btn.text || "").trim().length > 0)
          .map((btn, idx) => ({
            Text: (btn.text || "").trim(),
            Type: btn.type || "QUICK_REPLY",
            SubType: btn.subType || "",
            Value: btn.value || "",
            TargetNodeId: btn.targetNodeId || null,
            Index: typeof btn.index === "number" ? btn.index : idx,
          })),
      }));

    const transformedEdges = edges.map(edge => ({
      FromNodeId: edge.source,
      ToNodeId: edge.target,
      SourceHandle: edge.sourceHandle || "",
    }));

    return {
      FlowName: flowName || "Untitled",
      IsPublished: false, // always draft; publish is explicit
      Nodes: transformedNodes,
      Edges: transformedEdges,
    };
  };

  // --- Save Draft
  const handleSaveDraft = async () => {
    try {
      setSaving(true);
      const payload = buildPayload();

      if (mode === "edit" && flowId) {
        const res = await updateVisualFlow(flowId, payload);
        if (res?.needsRepublish) setRepublishNeeded(true);
        toast.success("‚úÖ Flow updated (draft)");
      } else {
        const res = await saveVisualFlow(payload); // create new draft
        if (res?.flowId) {
          navigate(`/app/cta-flow/flow-manager?tab=draft`);
          return;
        }
        toast.success("‚úÖ Flow saved (draft)");
      }
      setDirty(false);
      navigate(`/app/cta-flow/flow-manager?tab=draft`);
    } catch (error) {
      console.error("‚ùå Save draft failed: ", error);
      if (error?.response?.status === 409) {
        const camps = error?.response?.data?.campaigns || [];
        setLockInfo({ locked: true, campaigns: camps });
        setForkModalOpen(true);
        setReadonly(true);
      } else {
        toast.error("‚ùå Failed to save draft");
      }
    } finally {
      setSaving(false);
    }
  };

  // --- Publish / Republish
  const handlePublish = async () => {
    try {
      setSaving(true);

      if (mode === "edit" && flowId) {
        const payload = buildPayload();
        await updateVisualFlow(flowId, payload);
        await publishFlow(flowId);
        setRepublishNeeded(false);
        setIsPublished(true);
        setDirty(false);
        toast.success("‚úÖ Flow published");
        navigate("/app/cta-flow/flow-manager?tab=published");
        return;
      }

      // NEW flow: create as draft, get id, then publish that id
      const createPayload = { ...buildPayload(), IsPublished: false };
      const res = await saveVisualFlow(createPayload);
      const newId = res?.flowId;

      if (newId) {
        await publishFlow(newId);
        toast.success("‚úÖ Flow created & published");
        navigate("/app/cta-flow/flow-manager?tab=published");
        return;
      }

      toast.success("‚úÖ Flow created (but publish step uncertain)");
      navigate("/app/cta-flow/flow-manager?tab=published");
    } catch (error) {
      console.error("‚ùå Publish failed: ", error);
      if (error?.response?.status === 409) {
        const camps = error?.response?.data?.campaigns || [];
        setLockInfo({ locked: true, campaigns: camps });
        setForkModalOpen(true);
        setReadonly(true);
      } else {
        toast.error("‚ùå Failed to publish");
      }
    } finally {
      setSaving(false);
    }
  };

  const defaultEdgeOptions = useMemo(
    () => ({
      type: "smart",
      animated: true,
      style: { stroke: "#9333ea" },
      markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
    }),
    []
  );

  return (
    <div className="p-6 relative">
      {/* Page-level spinner overlay */}
      {(loading || saving) && (
        <div className="absolute inset-0 z-[60] bg-white/70 backdrop-blur-[1px] grid place-items-center">
          <div className="flex items-center gap-3 px-4 py-2 bg-white rounded-xl shadow border">
            <svg
              className="animate-spin h-5 w-5 text-purple-600"
              viewBox="0 0 24 24"
            >
              <circle
                className="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                strokeWidth="4"
                fill="none"
              />
              <path
                className="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
              />
            </svg>
            <span className="text-sm text-gray-700">
              {loading ? "Loading..." : "Working..."}
            </span>
          </div>
        </div>
      )}

      {/* ===== Header: title on left, ALL actions to top-right ===== */}
      <div className="flex flex-wrap items-center justify-between gap-3 mb-4">
        {/* Left: Title + Name */}
        <div className="flex items-center gap-3 min-w-0">
          <h2 className="text-xl sm:text-2xl font-bold text-gray-900 tracking-tight">
            üß† CTA Flow Visual Builder
          </h2>

          {/* Flow name input / badge inline with title */}
          {readonly ? (
            <span className="truncate max-w-[40ch] px-2 py-1 rounded-md bg-purple-50 text-purple-700 text-sm font-medium">
              {flowName || "Untitled Flow"}
            </span>
          ) : (
            <input
              id="flowName"
              name="flowName"
              ref={flowNameRef}
              value={flowName}
              onChange={e => {
                setFlowName(e.target.value);
                setDirty(true);
              }}
              placeholder="Add flow name"
              className="truncate max-w-[40ch] border border-gray-300 px-3 py-1.5 rounded-md shadow-sm text-sm focus:outline-none focus:ring-2 focus:ring-purple-500/50"
            />
          )}
        </div>

        {/* Right: Toolbar */}
        <div className="flex flex-wrap items-center gap-2">
          {/* Back / Manage ‚Äî keep both as small, neutral actions */}
          <button
            onClick={goBackToManager}
            className="px-3 py-2 rounded-md text-sm border border-gray-300 text-gray-700 bg-white hover:bg-gray-50"
            title={`Back to ${
              backTab === "published" ? "Published" : "Drafts"
            }`}
            disabled={saving}
          >
            ‚Üê Back to {backTab === "published" ? "Published" : "Drafts"}
          </button>

          <button
            onClick={() =>
              navigate(`/app/cta-flow/flow-manager?tab=${backTab}`)
            }
            className="px-3 py-2 rounded-md text-sm border border-gray-300 text-gray-700 bg-white hover:bg-gray-50"
            title="Manage all flows"
            disabled={saving}
          >
            ‚ñ§ Manage Flows
          </button>

          {/* Primary actions (hidden in readonly) */}
          {!readonly && (
            <>
              <button
                onClick={() => setShowPicker(true)}
                className="px-3 py-2 rounded-md text-sm bg-purple-600 text-white shadow hover:bg-purple-700"
                disabled={saving}
              >
                ‚ûï Add Step
              </button>

              <button
                onClick={handleSaveDraft}
                className="px-3 py-2 rounded-md text-sm bg-gray-800 text-white hover:bg-gray-900 disabled:opacity-50"
                disabled={saving}
              >
                üíæ Save Draft
              </button>

              <button
                onClick={handlePublish}
                className="px-3 py-2 rounded-md text-sm bg-green-600 text-white hover:bg-green-700 disabled:opacity-50"
                disabled={saving}
              >
                üöÄ {isPublished ? "Republish" : "Publish"}
              </button>
            </>
          )}
        </div>
      </div>
      {/* üîß CHANGED: removed ‚Äú‚ûï Add New Flow‚Äù from header; all buttons are now on the right */}

      {/* Republish banner (kept for clarity) */}
      {!readonly && mode === "edit" && republishNeeded && (
        <div className="mb-3 rounded-md border bg-amber-50 text-amber-800 px-3 py-2 text-sm flex items-center justify-between">
          <div>
            Changes saved as <span className="font-semibold">draft</span>. Click{" "}
            <span className="font-semibold">Republish</span> to make them live.
          </div>
          <button
            onClick={handlePublish}
            className="px-3 py-1 rounded bg-amber-600 text-white hover:bg-amber-700 text-xs"
            disabled={saving}
          >
            Republish
          </button>
        </div>
      )}

      {/* Canvas */}
      <div className="h-[70vh] border rounded-xl bg-gray-50 relative">
        {/* Minimap + tools */}
        <div className="absolute bottom-5 right-4 z-50 flex gap-2">
          <button
            onClick={() => setShowMiniMap(prev => !prev)}
            className="bg-purple-600 text-white p-2 rounded-full shadow hover:bg-purple-700"
            title={showMiniMap ? "Hide MiniMap" : "Show MiniMap"}
          >
            {showMiniMap ? <Minus size={15} /> : <Eye size={15} />}
          </button>

          <div className="flex items-center gap-2 bg-white/90 px-2 py-1 rounded-full border">
            <button
              onClick={() => fitView({ padding: 0.25 })}
              className="text-xs px-2 py-1 rounded hover:bg-gray-100 font-medium"
              title="Fit to screen"
            >
              Fit
            </button>
            <button
              onClick={() => zoomIn()}
              className="text-xs px-2 py-1 rounded hover:bg-gray-100"
              title="Zoom In"
            >
              +
            </button>
            <button
              onClick={() => zoomOut()}
              className="text-xs px-2 py-1 rounded hover:bg-gray-100"
              title="Zoom Out"
            >
              ‚àí
            </button>

            {!readonly && (
              <>
                <button
                  onClick={() => applyLayout("LR")}
                  className="text-xs px-2 py-1 rounded hover:bg-gray-100"
                  title="Auto-layout (Left‚ÜíRight)"
                >
                  Auto TB
                </button>
                <button
                  onClick={() => applyLayout("TB")}
                  className="text-xs px-2 py-1 rounded hover:bg-gray-100"
                  title="Auto-layout (Top‚ÜíBottom)"
                >
                  Auto LR
                </button>
              </>
            )}
          </div>
        </div>

        <ReactFlow
          nodes={nodes}
          edges={edges}
          onNodesChange={onNodesChange}
          onEdgesChange={onEdgesChange}
          onConnect={onConnect}
          onEdgeClick={(e, edge) => {
            if (!readonly) {
              setDirty(true);
              setEdges(eds => eds.filter(ed => ed.id !== edge.id));
            }
          }}
          nodeTypes={nodeTypes}
          edgeTypes={edgeTypes}
          fitView
          fitViewOptions={{ padding: 0.25 }}
          defaultEdgeOptions={defaultEdgeOptions}
          connectionMode={ConnectionMode.Strict}
          isValidConnection={isValidConnection}
          snapToGrid
          snapGrid={[GRID, GRID]}
          panOnScroll
          zoomOnPinch
          panOnDrag={[1, 2]}
          selectionOnDrag
          nodesDraggable={!readonly}
          nodesConnectable={!readonly}
          elementsSelectable={!readonly}
        >
          {showMiniMap && (
            <MiniMap
              nodeColor="#9333ea"
              nodeStrokeWidth={2}
              maskColor="rgba(255,255,255,0.6)"
            />
          )}
          <Controls />
          <Background variant="dots" gap={GRID} size={1} />
        </ReactFlow>
      </div>

      {/* üîß CHANGED: Footer actions removed (buttons now live in header) */}

      {/* Fork modal: when published & attached */}
      {forkModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          <div
            className="absolute inset-0 bg-black/40"
            onClick={() => setForkModalOpen(false)}
          />
          <div
            role="dialog"
            aria-modal="true"
            className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
          >
            <div className="flex items-start gap-3 mb-4">
              <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
                ‚ö†Ô∏è
              </div>
              <div>
                <h3 className="text-lg font-semibold text-gray-900">
                  Editing is blocked for this flow
                </h3>
                <p className="text-sm text-gray-600">
                  This flow is <span className="font-medium">published</span>{" "}
                  and attached to active campaign(s). To make changes, create a{" "}
                  <span className="font-medium">new draft version</span>.
                </p>
              </div>
            </div>

            <div className="max-h-60 overflow-auto rounded-lg border divide-y mb-4">
              {lockInfo.campaigns.map(c => (
                <div key={c.id} className="p-3 text-sm">
                  <div className="flex items-center justify-between">
                    <div className="font-semibold text-gray-900">{c.name}</div>
                    <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-700">
                      {c.status || "‚Äî"}
                    </span>
                  </div>
                  <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
                    <div>
                      Created:{" "}
                      <span className="font-medium text-gray-800">
                        {c.createdAt
                          ? new Date(c.createdAt).toLocaleString("en-IN")
                          : "‚Äî"}
                      </span>
                    </div>
                    <div>
                      Created by:{" "}
                      <span className="font-medium text-gray-800">
                        {c.createdBy || "‚Äî"}
                      </span>
                    </div>
                    <div>
                      Scheduled:{" "}
                      <span className="font-medium text-gray-800">
                        {c.scheduledAt
                          ? new Date(c.scheduledAt).toLocaleString("en-IN")
                          : "‚Äî"}
                      </span>
                    </div>
                    <div>
                      First sent:{" "}
                      <span className="font-medium text-gray-800">
                        {c.firstSentAt
                          ? new Date(c.firstSentAt).toLocaleString("en-IN")
                          : "‚Äî"}
                      </span>
                    </div>
                  </div>
                </div>
              ))}
              {lockInfo.campaigns.length === 0 && (
                <div className="p-3 text-sm text-gray-600">
                  Could not load campaign details. You can still create a new
                  draft version.
                </div>
              )}
            </div>

            <div className="flex justify-end gap-2">
              <button
                className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
                onClick={() => setForkModalOpen(false)}
              >
                Close
              </button>
              <button
                onClick={async () => {
                  try {
                    if (!flowId) return;
                    const { flowId: newId } = await forkFlow(flowId);
                    setForkModalOpen(false);
                    toast.success("‚úÖ New draft version created");
                    navigate(
                      `/app/cta-flow/visual-builder?id=${newId}&mode=edit`
                    );
                  } catch (e) {
                    console.error(e);
                    toast.error("‚ùå Failed to create draft copy");
                  }
                }}
                className="px-3 py-2 text-sm rounded bg-purple-600 text-white hover:bg-purple-700"
              >
                Create new draft version
              </button>
            </div>
          </div>
        </div>
      )}

      <TemplatePickerModal
        open={showPicker}
        onClose={() => setShowPicker(false)}
        onSelect={handleTemplateSelect}
      />
    </div>
  );
}

export default function CTAFlowVisualBuilder() {
  return (
    <ReactFlowProvider>
      <CTAFlowVisualBuilderInner />
    </ReactFlowProvider>
  );
}

// // src/pages/CTAFlowVisualBuilder/CTAFlowVisualBuilder.jsx
// import React, {
//   useCallback,
//   useState,
//   useEffect,
//   useMemo,
//   useRef,
// } from "react";
// import {
//   ReactFlow,
//   ReactFlowProvider,
//   Background,
//   Controls,
//   MiniMap,
//   useNodesState,
//   useEdgesState,
//   addEdge,
//   MarkerType,
//   ConnectionMode,
//   useReactFlow,
// } from "@xyflow/react";
// import "@xyflow/react/dist/style.css";
// import { Eye, Minus } from "lucide-react";
// import { useSearchParams, useNavigate } from "react-router-dom";
// import TemplatePickerModal from "./components/TemplatePickerModal";
// import FlowNodeBubble from "./components/FlowNodeBubble";
// import {
//   saveVisualFlow,
//   getVisualFlowById,
//   updateVisualFlow,
//   publishFlow,
//   forkFlow,
//   getFlowUsage,
// } from "./ctaFlowVisualApi";
// import { v4 as uuidv4 } from "uuid";
// import { toast } from "react-toastify";
// import dagre from "dagre";
// import SmartLabeledEdge from "./components/edges/SmartLabeledEdge";

// const GRID = 16;
// const NODE_DEFAULT = { width: 260, height: 140 };

// function CTAFlowVisualBuilderInner() {
//   const [nodes, setNodes, onNodesChange] = useNodesState([]);
//   const [edges, setEdges, onEdgesChange] = useEdgesState([]);
//   const nodesRef = useRef([]);
//   const [showPicker, setShowPicker] = useState(false);
//   const [flowName, setFlowName] = useState("");
//   const flowNameRef = useRef(null);
//   const [showMiniMap, setShowMiniMap] = useState(false);
//   const [readonly, setReadonly] = useState(false);

//   // policy state
//   const [isPublished, setIsPublished] = useState(false);
//   const [republishNeeded, setRepublishNeeded] = useState(false);
//   const [lockInfo, setLockInfo] = useState({ locked: false, campaigns: [] });
//   const [forkModalOpen, setForkModalOpen] = useState(false);

//   // async state
//   const [saving, setSaving] = useState(false);
//   const [loading, setLoading] = useState(false);

//   const [dirty, setDirty] = useState(false);

//   const [searchParams] = useSearchParams();
//   const navigate = useNavigate();
//   const { fitView, zoomIn, zoomOut } = useReactFlow();

//   const mode = searchParams.get("mode"); // 'edit' | 'view' | null
//   const flowId = searchParams.get("id");
//   const visualDebug = true;

//   // figure out source tab for Back button
//   const fromTab = (searchParams.get("from") || "draft").toLowerCase();
//   const backTab = fromTab === "published" ? "published" : "draft";

//   const goBackToManager = useCallback(() => {
//     if (!readonly && dirty) {
//       const ok = window.confirm("You have unsaved changes. Leave this page?");
//       if (!ok) return;
//     }
//     navigate(`/app/cta-flow/flow-manager?tab=${backTab}`);
//   }, [readonly, dirty, backTab, navigate]);

//   useEffect(() => {
//     nodesRef.current = [...nodes];
//   }, [nodes]);

//   // warn on unload if dirty
//   useEffect(() => {
//     const onBeforeUnload = e => {
//       if (!dirty) return;
//       e.preventDefault();
//       e.returnValue = "";
//     };
//     window.addEventListener("beforeunload", onBeforeUnload);
//     return () => window.removeEventListener("beforeunload", onBeforeUnload);
//   }, [dirty]);

//   // --- Node helpers
//   const handleDeleteNode = useCallback(
//     nodeId => {
//       if (readonly) return;
//       setDirty(true);
//       setNodes(nds => nds.filter(n => n.id !== nodeId));
//       setEdges(eds =>
//         eds.filter(e => e.source !== nodeId && e.target !== nodeId)
//       );
//     },
//     [readonly, setNodes, setEdges]
//   );

//   const handleNodeDataChange = useCallback(
//     (nodeId, newData) => {
//       setDirty(true);
//       setNodes(nds =>
//         nds.map(n =>
//           n.id === nodeId ? { ...n, data: { ...n.data, ...newData } } : n
//         )
//       );
//     },
//     [setNodes]
//   );

//   const nodeTypes = useMemo(
//     () => ({
//       customBubble: props => (
//         <FlowNodeBubble
//           {...props}
//           onDelete={handleDeleteNode}
//           onDataChange={newData => handleNodeDataChange(props.id, newData)}
//           readonly={readonly}
//           visualDebug={visualDebug}
//         />
//       ),
//     }),
//     [handleDeleteNode, readonly, visualDebug, handleNodeDataChange]
//   );

//   const edgeTypes = useMemo(() => ({ smart: SmartLabeledEdge }), []);

//   // --- Load / Bootstrap + policy checks
//   useEffect(() => {
//     const load = async () => {
//       setLoading(true);
//       if (mode === "edit" || mode === "view") {
//         try {
//           const data = await getVisualFlowById(flowId);

//           const builtNodes = (data.nodes || []).map((node, index) => ({
//             id: node.id,
//             type: "customBubble",
//             position: {
//               x: node.positionX ?? 120 + index * 120,
//               y: node.positionY ?? 150 + (index % 5) * 60,
//             },
//             data: {
//               templateName: node.templateName,
//               templateType: node.templateType,
//               messageBody: node.messageBody,
//               triggerButtonText: node.triggerButtonText || "",
//               triggerButtonType: node.triggerButtonType || "cta",
//               requiredTag: node.requiredTag || "",
//               requiredSource: node.requiredSource || "",
//               useProfileName: !!node.useProfileName,
//               profileNameSlot:
//                 typeof node.profileNameSlot === "number" &&
//                 node.profileNameSlot > 0
//                   ? node.profileNameSlot
//                   : 1,
//               buttons: (node.buttons || []).map((btn, i) => ({
//                 text: btn.text,
//                 type: btn.type,
//                 subType: btn.subType,
//                 value: btn.value,
//                 targetNodeId: btn.targetNodeId || null,
//                 index: typeof btn.index === "number" ? btn.index : i,
//               })),
//             },
//           }));

//           const builtEdges = (data.edges || []).map(edge => ({
//             id: `e-${edge.fromNodeId}-${edge.toNodeId}-${
//               edge.sourceHandle || "h"
//             }`,
//             source: edge.fromNodeId,
//             target: edge.toNodeId,
//             sourceHandle: edge.sourceHandle || null,
//             type: "smart",
//             animated: true,
//             style: { stroke: "#9333ea" },
//             markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
//             label: edge.sourceHandle || "",
//           }));

//           const nodesWithIncoming = new Set(builtEdges.map(e => e.target));
//           const nodesWithWarnings = builtNodes.map(node => ({
//             ...node,
//             data: {
//               ...node.data,
//               isUnreachable: false,
//               hasNoIncoming: !nodesWithIncoming.has(node.id),
//             },
//           }));

//           setNodes(nodesWithWarnings);
//           setEdges(builtEdges);
//           setFlowName(data.flowName || "Untitled Flow");
//           setIsPublished(!!data.isPublished);
//           setDirty(false);

//           // policy: if editing a published flow, check attachment
//           if (mode === "edit" && data.isPublished) {
//             try {
//               const usage = await getFlowUsage(flowId);
//               if (usage?.campaigns?.length > 0) {
//                 setLockInfo({ locked: true, campaigns: usage.campaigns });
//                 setForkModalOpen(true);
//                 setReadonly(true);
//               } else {
//                 setReadonly(false);
//               }
//             } catch {
//               setLockInfo({ locked: true, campaigns: [] });
//               setForkModalOpen(true);
//               setReadonly(true);
//             }
//           } else {
//             setReadonly(mode === "view");
//           }

//           // initial fit
//           setTimeout(() => fitView({ padding: 0.25 }), 80);
//         } catch {
//           toast.error("‚ùå Failed to load flow");
//         } finally {
//           setLoading(false);
//         }
//       } else {
//         // creating new flow
//         setNodes([]);
//         setEdges([]);
//         setFlowName("Untitled Flow");
//         setIsPublished(false);
//         setReadonly(false);
//         setDirty(false);
//         setLoading(false);
//         setTimeout(() => fitView({ padding: 0.25 }), 80);
//       }
//     };

//     load();
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, [flowId, mode]);

//   // Auto-fit when viewing, and refit on window resize
//   useEffect(() => {
//     if (mode !== "view") return;
//     const t = setTimeout(() => fitView({ padding: 0.25 }), 80);
//     const onResize = () => fitView({ padding: 0.25 });
//     window.addEventListener("resize", onResize);
//     return () => {
//       clearTimeout(t);
//       window.removeEventListener("resize", onResize);
//     };
//   }, [mode, nodes.length, edges.length, fitView]);

//   // --- Add template
//   const handleTemplateSelect = ({ name, type, body, buttons = [] }) => {
//     if (readonly) return;
//     const id = uuidv4();
//     const newNode = {
//       id,
//       position: { x: Math.random() * 400 + 100, y: Math.random() * 300 + 100 },
//       type: "customBubble",
//       data: {
//         templateName: name || "Untitled",
//         templateType: type || "text_template",
//         messageBody: body || "Message body preview...",
//         triggerButtonText: buttons[0]?.text || "",
//         triggerButtonType: "cta",
//         useProfileName: false,
//         profileNameSlot: 1,
//         buttons: buttons.map((btn, idx) => ({
//           text: btn.text || "",
//           type: btn.type || "QUICK_REPLY",
//           subType: btn.subType || "",
//           value: btn.parameterValue || "",
//           targetNodeId: null,
//           index: idx,
//         })),
//       },
//     };
//     setDirty(true);
//     setNodes(nds => [...nds, newNode]);
//     setShowPicker(false);
//     toast.success(
//       `‚úÖ Step added with ${type?.replace("_", " ") || "template"}`
//     );
//     setTimeout(() => fitView({ padding: 0.25 }), 50);
//   };

//   // --- Connection rules
//   const isValidConnection = useCallback(
//     params => {
//       if (!params?.source || !params?.sourceHandle) return false;
//       const duplicate = edges.some(
//         e =>
//           e.source === params.source && e.sourceHandle === params.sourceHandle
//       );
//       return !duplicate;
//     },
//     [edges]
//   );

//   const onConnect = useCallback(
//     params => {
//       if (readonly) return;
//       setDirty(true);
//       const label = params.sourceHandle || "";

//       setEdges(eds =>
//         addEdge(
//           {
//             ...params,
//             id: uuidv4(),
//             type: "smart",
//             animated: true,
//             style: { stroke: "#9333ea" },
//             markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
//             label,
//           },
//           eds
//         )
//       );

//       setNodes(nds =>
//         nds.map(node => {
//           if (node.id !== params.source) return node;
//           const sourceHandle = params.sourceHandle || "";
//           const updatedButtons = [...(node.data.buttons || [])];

//           const idx = updatedButtons.findIndex(
//             b =>
//               (b.text || "").toLowerCase().trim() ===
//               sourceHandle.toLowerCase().trim()
//           );

//           if (idx >= 0) {
//             updatedButtons[idx] = {
//               ...updatedButtons[idx],
//               targetNodeId: params.target,
//             };
//           } else {
//             const free = updatedButtons.findIndex(b => !b.targetNodeId);
//             if (free >= 0)
//               updatedButtons[free] = {
//                 ...updatedButtons[free],
//                 targetNodeId: params.target,
//               };
//           }

//           return { ...node, data: { ...node.data, buttons: updatedButtons } };
//         })
//       );
//     },
//     [readonly, setEdges, setNodes]
//   );

//   // --- Keyboard UX
//   useEffect(() => {
//     const onKey = e => {
//       if (readonly) return;
//       if (e.key === "Delete" || e.key === "Backspace") {
//         setDirty(true);
//         setNodes(nds => nds.filter(n => !n.selected));
//         setEdges(eds => eds.filter(ed => !ed.selected));
//       }
//       if (e.key === "Escape") {
//         setNodes(nds => nds.map(n => ({ ...n, selected: false })));
//         setEdges(eds => eds.map(ed => ({ ...ed, selected: false })));
//       }
//     };
//     window.addEventListener("keydown", onKey);
//     return () => window.removeEventListener("keydown", onKey);
//   }, [readonly, setNodes, setEdges]);

//   // --- Auto layout (dagre)
//   const applyLayout = useCallback(
//     (direction = "LR") => {
//       const g = new dagre.graphlib.Graph();
//       g.setGraph({
//         rankdir: direction,
//         nodesep: 50,
//         ranksep: 90,
//         marginx: 20,
//         marginy: 20,
//       });
//       g.setDefaultEdgeLabel(() => ({}));

//       nodes.forEach(n => {
//         const width = n?.measured?.width || NODE_DEFAULT.width;
//         const height = n?.measured?.height || NODE_DEFAULT.height;
//         g.setNode(n.id, { width, height });
//       });
//       edges.forEach(e => g.setEdge(e.source, e.target));

//       dagre.layout(g);

//       const laidOut = nodes.map(n => {
//         const { x, y } = g.node(n.id);
//         const width = n?.measured?.width || NODE_DEFAULT.width;
//         const height = n?.measured?.height || NODE_DEFAULT.height;
//         return { ...n, position: { x: x - width / 2, y: y - height / 2 } };
//       });

//       setDirty(true);
//       setNodes(laidOut);
//       setTimeout(() => fitView({ padding: 0.25 }), 50);
//     },
//     [nodes, edges, setNodes, fitView]
//   );

//   // --- Build payload (draft by default; publish is separate)
//   const buildPayload = () => {
//     const transformedNodes = nodes
//       .filter(n => n?.data?.templateName)
//       .map(node => ({
//         Id: node.id,
//         TemplateName: node.data.templateName || "Untitled",
//         TemplateType: node.data.templateType || "text_template",
//         MessageBody: node.data.messageBody || "",
//         PositionX: node.position?.x || 0,
//         PositionY: node.position?.y || 0,
//         TriggerButtonText: node.data.triggerButtonText || "",
//         TriggerButtonType: node.data.triggerButtonType || "cta",
//         RequiredTag: node.data.requiredTag || "",
//         RequiredSource: node.data.requiredSource || "",
//         UseProfileName: !!node.data.useProfileName,
//         ProfileNameSlot:
//           typeof node.data.profileNameSlot === "number" &&
//           node.data.profileNameSlot > 0
//             ? node.data.profileNameSlot
//             : 1,
//         Buttons: (node.data.buttons || [])
//           .filter(btn => (btn.text || "").trim().length > 0)
//           .map((btn, idx) => ({
//             Text: (btn.text || "").trim(),
//             Type: btn.type || "QUICK_REPLY",
//             SubType: btn.subType || "",
//             Value: btn.value || "",
//             TargetNodeId: btn.targetNodeId || null,
//             Index: typeof btn.index === "number" ? btn.index : idx,
//           })),
//       }));

//     const transformedEdges = edges.map(edge => ({
//       FromNodeId: edge.source,
//       ToNodeId: edge.target,
//       SourceHandle: edge.sourceHandle || "",
//     }));

//     return {
//       FlowName: flowName || "Untitled",
//       IsPublished: false, // always draft; publish is explicit
//       Nodes: transformedNodes,
//       Edges: transformedEdges,
//     };
//   };

//   // --- Save Draft (then go to Drafts tab)
//   const handleSaveDraft = async () => {
//     try {
//       setSaving(true);
//       const payload = buildPayload();

//       if (mode === "edit" && flowId) {
//         const res = await updateVisualFlow(flowId, payload);
//         if (res?.needsRepublish) setRepublishNeeded(true);
//         toast.success("‚úÖ Flow updated (draft)");
//       } else {
//         const res = await saveVisualFlow(payload); // create new draft
//         if (res?.flowId) {
//           // move the user to manager drafts list
//           navigate(`/app/cta-flow/flow-manager?tab=draft`);
//           return; // stop further state updates in this screen
//         }
//         toast.success("‚úÖ Flow saved (draft)");
//       }
//       setDirty(false);
//       navigate(`/app/cta-flow/flow-manager?tab=draft`);
//     } catch (error) {
//       console.error("‚ùå Save draft failed: ", error);
//       if (error?.response?.status === 409) {
//         const camps = error?.response?.data?.campaigns || [];
//         setLockInfo({ locked: true, campaigns: camps });
//         setForkModalOpen(true);
//         setReadonly(true);
//       } else {
//         toast.error("‚ùå Failed to save draft");
//       }
//     } finally {
//       setSaving(false);
//     }
//   };

//   // --- Publish / Republish (on new ‚Üí create then publish) then go to Published tab
//   const handlePublish = async () => {
//     try {
//       setSaving(true);

//       if (mode === "edit" && flowId) {
//         const payload = buildPayload();
//         await updateVisualFlow(flowId, payload);
//         await publishFlow(flowId);
//         setRepublishNeeded(false);
//         setIsPublished(true);
//         setDirty(false);
//         toast.success("‚úÖ Flow published");
//         navigate("/app/cta-flow/flow-manager?tab=published");
//         return;
//       }

//       // NEW flow: create as draft, get id, then publish that id
//       const createPayload = { ...buildPayload(), IsPublished: false };
//       const res = await saveVisualFlow(createPayload);
//       const newId = res?.flowId;

//       if (newId) {
//         await publishFlow(newId);
//         toast.success("‚úÖ Flow created & published");
//         navigate("/app/cta-flow/flow-manager?tab=published");
//         return;
//       }

//       // fallback
//       toast.success("‚úÖ Flow created (but publish step uncertain)");
//       navigate("/app/cta-flow/flow-manager?tab=published");
//     } catch (error) {
//       console.error("‚ùå Publish failed: ", error);
//       if (error?.response?.status === 409) {
//         const camps = error?.response?.data?.campaigns || [];
//         setLockInfo({ locked: true, campaigns: camps });
//         setForkModalOpen(true);
//         setReadonly(true);
//       } else {
//         toast.error("‚ùå Failed to publish");
//       }
//     } finally {
//       setSaving(false);
//     }
//   };

//   const defaultEdgeOptions = useMemo(
//     () => ({
//       type: "smart",
//       animated: true,
//       style: { stroke: "#9333ea" },
//       markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
//     }),
//     []
//   );

//   return (
//     <div className="p-6 relative">
//       {/* Page-level spinner overlay */}
//       {(loading || saving) && (
//         <div className="absolute inset-0 z-[60] bg-white/70 backdrop-blur-[1px] grid place-items-center">
//           <div className="flex items-center gap-3 px-4 py-2 bg-white rounded-xl shadow border">
//             <svg
//               className="animate-spin h-5 w-5 text-purple-600"
//               viewBox="0 0 24 24"
//             >
//               <circle
//                 className="opacity-25"
//                 cx="12"
//                 cy="12"
//                 r="10"
//                 stroke="currentColor"
//                 strokeWidth="4"
//                 fill="none"
//               />
//               <path
//                 className="opacity-75"
//                 fill="currentColor"
//                 d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
//               />
//             </svg>
//             <span className="text-sm text-gray-700">
//               {loading ? "Loading..." : "Working..."}
//             </span>
//           </div>
//         </div>
//       )}

//       {/* Header */}
//       <div className="flex flex-wrap items-center justify-between gap-3 mb-4">
//         <div className="flex items-center gap-2">
//           <button
//             onClick={goBackToManager}
//             className="bg-white border border-gray-300 text-gray-700 px-3 py-2 rounded-md shadow-sm hover:bg-gray-50 text-sm"
//             title={`Back to ${
//               backTab === "published" ? "Published" : "Drafts"
//             }`}
//           >
//             ‚Üê Back to {backTab === "published" ? "Published" : "Drafts"}
//           </button>

//           <h2 className="text-2xl font-bold text-purple-700 ml-1">
//             üß† CTA Flow Visual Builder
//           </h2>
//         </div>

//         <div className="flex items-center gap-2">
//           {readonly ? (
//             <div className="px-3 py-2 rounded-md bg-purple-50 text-purple-700 text-sm font-medium">
//               {flowName || "Untitled Flow"}
//             </div>
//           ) : (
//             <input
//               id="flowName"
//               name="flowName"
//               ref={flowNameRef}
//               value={flowName}
//               onChange={e => {
//                 setFlowName(e.target.value);
//                 setDirty(true);
//               }}
//               placeholder="Add flow name"
//               className="border border-gray-300 px-3 py-2 rounded-md shadow-sm text-sm"
//             />
//           )}

//           {/* Always available */}
//           <button
//             onClick={() => navigate(`/app/cta-flow/visual-builder`)}
//             className="bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700 text-sm"
//             title="Create a new flow"
//             disabled={saving}
//           >
//             ‚ûï Add New Flow
//           </button>

//           {!readonly && (
//             <>
//               <button
//                 onClick={() => setShowPicker(true)}
//                 className="bg-purple-600 text-white px-4 py-2 rounded shadow hover:bg-purple-700 text-sm"
//                 disabled={saving}
//               >
//                 ‚ûï Add Step
//               </button>
//               <button
//                 onClick={goBackToManager}
//                 className="bg-white border border-purple-600 text-purple-700 font-medium text-sm px-4 py-2 rounded-md shadow-sm hover:bg-purple-50"
//                 disabled={saving}
//               >
//                 ‚Ü©Ô∏è Manage All Flows
//               </button>
//             </>
//           )}
//         </div>
//       </div>

//       {/* Republish banner */}
//       {!readonly && mode === "edit" && republishNeeded && (
//         <div className="mb-3 rounded-md border bg-amber-50 text-amber-800 px-3 py-2 text-sm flex items-center justify-between">
//           <div>
//             Changes saved as <span className="font-semibold">draft</span>. Click{" "}
//             <span className="font-semibold">Republish</span> to make them live.
//           </div>
//           <button
//             onClick={handlePublish}
//             className="px-3 py-1 rounded bg-amber-600 text-white hover:bg-amber-700 text-xs"
//             disabled={saving}
//           >
//             Republish
//           </button>
//         </div>
//       )}

//       {/* Canvas */}
//       <div className="h-[70vh] border rounded-xl bg-gray-50 relative">
//         {/* Minimap + tools */}
//         <div className="absolute bottom-5 right-4 z-50 flex gap-2">
//           <button
//             onClick={() => setShowMiniMap(prev => !prev)}
//             className="bg-purple-600 text-white p-2 rounded-full shadow hover:bg-purple-700"
//             title={showMiniMap ? "Hide MiniMap" : "Show MiniMap"}
//           >
//             {showMiniMap ? <Minus size={15} /> : <Eye size={15} />}
//           </button>

//           <div className="flex items-center gap-2 bg-white/90 px-2 py-1 rounded-full border">
//             <button
//               onClick={() => fitView({ padding: 0.25 })}
//               className="text-xs px-2 py-1 rounded hover:bg-gray-100 font-medium"
//               title="Fit to screen"
//             >
//               Fit
//             </button>
//             <button
//               onClick={() => zoomIn()}
//               className="text-xs px-2 py-1 rounded hover:bg-gray-100"
//               title="Zoom In"
//             >
//               +
//             </button>
//             <button
//               onClick={() => zoomOut()}
//               className="text-xs px-2 py-1 rounded hover:bg-gray-100"
//               title="Zoom Out"
//             >
//               ‚àí
//             </button>

//             {!readonly && (
//               <>
//                 <button
//                   onClick={() => applyLayout("LR")}
//                   className="text-xs px-2 py-1 rounded hover:bg-gray-100"
//                   title="Auto-layout (Left‚ÜíRight)"
//                 >
//                   Auto LR
//                 </button>
//                 <button
//                   onClick={() => applyLayout("TB")}
//                   className="text-xs px-2 py-1 rounded hover:bg-gray-100"
//                   title="Auto-layout (Top‚ÜíBottom)"
//                 >
//                   Auto TB
//                 </button>
//               </>
//             )}
//           </div>
//         </div>

//         <ReactFlow
//           nodes={nodes}
//           edges={edges}
//           onNodesChange={onNodesChange}
//           onEdgesChange={onEdgesChange}
//           onConnect={onConnect}
//           onEdgeClick={(e, edge) => {
//             if (!readonly) {
//               setDirty(true);
//               setEdges(eds => eds.filter(ed => ed.id !== edge.id));
//             }
//           }}
//           nodeTypes={nodeTypes}
//           edgeTypes={edgeTypes}
//           fitView
//           fitViewOptions={{ padding: 0.25 }}
//           defaultEdgeOptions={defaultEdgeOptions}
//           connectionMode={ConnectionMode.Strict}
//           isValidConnection={isValidConnection}
//           snapToGrid
//           snapGrid={[GRID, GRID]}
//           panOnScroll
//           zoomOnPinch
//           panOnDrag={[1, 2]}
//           selectionOnDrag
//           nodesDraggable={!readonly}
//           nodesConnectable={!readonly}
//           elementsSelectable={!readonly}
//         >
//           {showMiniMap && (
//             <MiniMap
//               nodeColor="#9333ea"
//               nodeStrokeWidth={2}
//               maskColor="rgba(255,255,255,0.6)"
//             />
//           )}
//           <Controls />
//           <Background variant="dots" gap={GRID} size={1} />
//         </ReactFlow>
//       </div>

//       {/* Footer actions */}
//       {!readonly && (
//         <div className="mt-6 flex flex-wrap gap-3">
//           <button
//             onClick={handleSaveDraft}
//             className="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 text-sm disabled:opacity-50"
//             disabled={saving}
//           >
//             üíæ Save Draft
//           </button>

//           <button
//             onClick={handlePublish}
//             className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm disabled:opacity-50"
//             disabled={saving}
//           >
//             üöÄ {isPublished ? "Republish" : "Publish Flow"}
//           </button>
//         </div>
//       )}

//       {/* Fork modal: when published & attached */}
//       {forkModalOpen && (
//         <div className="fixed inset-0 z-50 flex items-center justify-center">
//           <div
//             className="absolute inset-0 bg-black/40"
//             onClick={() => setForkModalOpen(false)}
//           />
//           <div
//             role="dialog"
//             aria-modal="true"
//             className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
//           >
//             <div className="flex items-start gap-3 mb-4">
//               <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                 ‚ö†Ô∏è
//               </div>
//               <div>
//                 <h3 className="text-lg font-semibold text-gray-900">
//                   Editing is blocked for this flow
//                 </h3>
//                 <p className="text-sm text-gray-600">
//                   This flow is <span className="font-medium">published</span>{" "}
//                   and attached to active campaign(s). To make changes, create a{" "}
//                   <span className="font-medium">new draft version</span>.
//                 </p>
//               </div>
//             </div>

//             <div className="max-h-60 overflow-auto rounded-lg border divide-y mb-4">
//               {lockInfo.campaigns.map(c => (
//                 <div key={c.id} className="p-3 text-sm">
//                   <div className="flex items-center justify-between">
//                     <div className="font-semibold text-gray-900">{c.name}</div>
//                     <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-700">
//                       {c.status || "‚Äî"}
//                     </span>
//                   </div>
//                   <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
//                     <div>
//                       Created:{" "}
//                       <span className="font-medium text-gray-800">
//                         {c.createdAt
//                           ? new Date(c.createdAt).toLocaleString("en-IN")
//                           : "‚Äî"}
//                       </span>
//                     </div>
//                     <div>
//                       Created by:{" "}
//                       <span className="font-medium text-gray-800">
//                         {c.createdBy || "‚Äî"}
//                       </span>
//                     </div>
//                     <div>
//                       Scheduled:{" "}
//                       <span className="font-medium text-gray-800">
//                         {c.scheduledAt
//                           ? new Date(c.scheduledAt).toLocaleString("en-IN")
//                           : "‚Äî"}
//                       </span>
//                     </div>
//                     <div>
//                       First sent:{" "}
//                       <span className="font-medium text-gray-800">
//                         {c.firstSentAt
//                           ? new Date(c.firstSentAt).toLocaleString("en-IN")
//                           : "‚Äî"}
//                       </span>
//                     </div>
//                   </div>
//                 </div>
//               ))}
//               {lockInfo.campaigns.length === 0 && (
//                 <div className="p-3 text-sm text-gray-600">
//                   Could not load campaign details. You can still create a new
//                   draft version.
//                 </div>
//               )}
//             </div>

//             <div className="flex justify-end gap-2">
//               <button
//                 className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                 onClick={() => setForkModalOpen(false)}
//               >
//                 Close
//               </button>
//               <button
//                 onClick={async () => {
//                   try {
//                     if (!flowId) return;
//                     const { flowId: newId } = await forkFlow(flowId);
//                     setForkModalOpen(false);
//                     toast.success("‚úÖ New draft version created");
//                     navigate(
//                       `/app/cta-flow/visual-builder?id=${newId}&mode=edit`
//                     );
//                   } catch (e) {
//                     console.error(e);
//                     toast.error("‚ùå Failed to create draft copy");
//                   }
//                 }}
//                 className="px-3 py-2 text-sm rounded bg-purple-600 text-white hover:bg-purple-700"
//               >
//                 Create new draft version
//               </button>
//             </div>
//           </div>
//         </div>
//       )}

//       <TemplatePickerModal
//         open={showPicker}
//         onClose={() => setShowPicker(false)}
//         onSelect={handleTemplateSelect}
//       />
//     </div>
//   );
// }

// export default function CTAFlowVisualBuilder() {
//   return (
//     <ReactFlowProvider>
//       <CTAFlowVisualBuilderInner />
//     </ReactFlowProvider>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\CTAFlowVisualBuilder_AllFileDump.txt 
====================================================== 
 
Folder and File Content Report
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\CTAFlowLogs.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../api/axiosClient";
import { Card } from "../../components/ui/card";
import { Table, Thead, Tbody, Tr, Th, Td } from "../../components/ui/table";
import { format } from "date-fns";

const CTAFlowLogs = () => {
  const [logs, setLogs] = useState([]);

  useEffect(() => {
    axiosClient.get("/tracking/flow-clicks").then(res => {
      setLogs(res.data);
    });
  }, []);

  return (
    <div className="p-6">
      <h2 className="text-2xl font-bold mb-4">CTA Flow Click Logs</h2>
      <Card className="overflow-x-auto">
        <Table>
          <Thead>
            <Tr>
              <Th>Date</Th>
              <Th>Recipient</Th>
              <Th>Button</Th>
              <Th>Template</Th>
              <Th>Step ID</Th>
              <Th>Follow-Up</Th>
            </Tr>
          </Thead>
          <Tbody>
            {logs.map(log => (
              <Tr key={log.id}>
                <Td>
                  {format(new Date(log.clickedAt), "dd MMM yyyy hh:mm a")}
                </Td>
                <Td>{log.contactPhone}</Td>
                <Td>{log.buttonText}</Td>
                <Td>{log.templateId}</Td>
                <Td className="text-xs">{log.stepId}</Td>
                <Td>
                  {log.followUpSent ? (
                    <span className="text-green-600 font-semibold">‚úÖ Yes</span>
                  ) : (
                    <span className="text-gray-500">‚Äî</span>
                  )}
                </Td>
              </Tr>
            ))}
          </Tbody>
        </Table>
      </Card>
    </div>
  );
};

export default CTAFlowLogs;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\CTAFlowManager.jsx 
====================================================== 
 
// üìÑ File: src/pages/CTAFlowVisualBuilder/CTAFlowManager.jsx
import React, { useEffect, useMemo, useRef, useState } from "react";
import { useNavigate, useSearchParams } from "react-router-dom";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";

export default function CTAFlowManager() {
  const [flows, setFlows] = useState([]);
  const [loading, setLoading] = useState(true);

  const [modalOpen, setModalOpen] = useState(false);
  const [modalMode, setModalMode] = useState("confirm"); // confirm | attached
  const [modalCampaigns, setModalCampaigns] = useState([]);
  const [targetFlow, setTargetFlow] = useState(null);

  const [query, setQuery] = useState("");
  const [sortKey, setSortKey] = useState("updated");
  const closeBtnRef = useRef(null);
  const navigate = useNavigate();

  // NEW: read ?tab= from URL (published | draft). Default to 'published'
  const [searchParams, setSearchParams] = useSearchParams();
  const tabFromUrl =
    searchParams.get("tab") === "draft" ? "draft" : "published";
  const [activeTab, setActiveTab] = useState(tabFromUrl);

  const formatDate = date =>
    date
      ? new Date(date).toLocaleString("en-IN", {
          day: "2-digit",
          month: "short",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        })
      : "‚Äî";

  const statusPill = isPublished =>
    isPublished ? (
      <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">
        <span>‚óè</span> Published
      </span>
    ) : (
      <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">
        <span>‚óè</span> Draft
      </span>
    );

  const fetchFlows = async (tab = "published") => {
    setLoading(true);
    try {
      const endpoint =
        tab === "published" ? "/cta-flow/all-published" : "/cta-flow/all-draft";
      const res = await axiosClient.get(endpoint);
      setFlows(Array.isArray(res.data) ? res.data : [res.data]);
    } catch (err) {
      setFlows([]);
      toast.error("‚ùå Failed to load flows.");
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  // NEW: whenever ?tab changes (or on first render), sync state and fetch
  useEffect(() => {
    const tab = searchParams.get("tab") === "draft" ? "draft" : "published";
    setActiveTab(tab);
    fetchFlows(tab);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [searchParams]);

  const filtered = useMemo(() => {
    const q = query.trim().toLowerCase();
    let out = flows;
    if (q) {
      out = out.filter(f =>
        [f.flowName, f.createdBy]
          .filter(Boolean)
          .some(v => String(v).toLowerCase().includes(q))
      );
    }
    switch (sortKey) {
      case "name":
        return [...out].sort((a, b) => a.flowName.localeCompare(b.flowName));
      case "created":
        return [...out].sort(
          (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
        );
      default:
        return [...out].sort(
          (a, b) =>
            new Date(b.updatedAt || b.createdAt) -
            new Date(a.updatedAt || a.createdAt)
        );
    }
  }, [flows, query, sortKey]);

  // ---- delete UX (checks usage) ----
  const openDeleteModal = async flow => {
    if (loading) return; // guard
    setTargetFlow(flow);
    setLoading(true);
    try {
      const { data } = await axiosClient.get(`/cta-flow/${flow.id}/usage`);
      if (data?.canDelete) {
        setModalMode("confirm");
        setModalCampaigns([]);
      } else {
        setModalMode("attached");
        setModalCampaigns(Array.isArray(data?.campaigns) ? data.campaigns : []);
      }
      setModalOpen(true);
      setTimeout(() => closeBtnRef.current?.focus(), 0);
    } catch (err) {
      toast.error("‚ùå Could not check usage for this flow.");
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  const confirmDelete = async () => {
    if (!targetFlow) return;
    setLoading(true);
    try {
      const res = await axiosClient.delete(`/cta-flow/${targetFlow.id}`);
      if (res.status === 204 || res.status === 200) {
        toast.success("‚úÖ Flow deleted permanently.");
        setModalOpen(false);
        setTargetFlow(null);
        await fetchFlows(activeTab);
      } else {
        toast.info("‚ÑπÔ∏è Unexpected response while deleting the flow.");
      }
    } catch (err) {
      const status = err?.response?.status;
      if (status === 409) {
        const campaigns = err.response?.data?.campaigns ?? [];
        setModalMode("attached");
        setModalCampaigns(campaigns);
      } else if (status === 404) {
        toast.error("‚ùå Flow not found.");
        setModalOpen(false);
      } else {
        toast.error("‚ùå Failed to delete flow.");
        setModalOpen(false);
      }
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  // ---- publish from draft tab ----
  const publishFlow = async flow => {
    if (loading) return;
    try {
      setLoading(true);
      await axiosClient.post(`/cta-flow/${flow.id}/publish`);
      toast.success("‚úÖ Flow published.");
      // NEW: when publishing, move to Published tab (and reflect in URL)
      setSearchParams({ tab: "published" });
    } catch (err) {
      const status = err?.response?.status;
      if (status === 409) {
        toast.error(
          err?.response?.data?.message || "‚ùå Cannot publish right now."
        );
      } else if (status === 404) {
        toast.error("‚ùå Flow not found.");
      } else {
        toast.error("‚ùå Failed to publish flow.");
      }
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  const goView = flow => {
    if (loading) return;
    navigate(`/app/cta-flow/visual-builder?id=${flow.id}&mode=view`);
  };

  return (
    <div className="p-6 relative">
      {/* Loading overlay */}
      {loading && (
        <>
          <div className="absolute inset-0 z-40 bg-white/60 backdrop-blur-[1px] flex items-center justify-center">
            <div className="flex items-center gap-3 text-gray-700">
              <svg
                className="xafb-spin h-6 w-6 text-purple-600"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
              >
                <circle
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  strokeWidth="4"
                  opacity="0.25"
                />
                <path
                  d="M4 12a8 8 0 018-8"
                  stroke="currentColor"
                  strokeWidth="4"
                  strokeLinecap="round"
                  opacity="0.85"
                />
              </svg>
              <span className="text-sm">Loading‚Ä¶</span>
            </div>
          </div>
          <style>{`@keyframes xafb-spin{to{transform:rotate(360deg)}}.xafb-spin{animation:xafb-spin 1s linear infinite}`}</style>
        </>
      )}

      {/* Header */}
      <div className="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between mb-6">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">
            üß© CTA Flow Manager
          </h1>
          <p className="text-sm text-gray-500">
            Create, publish, and manage your visual flows.
          </p>
        </div>
        <div className="flex items-center gap-2">
          <button
            onClick={() => navigate("/app/cta-flow/visual-builder")}
            className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md shadow disabled:opacity-50"
            disabled={loading}
          >
            ‚ûï New Flow
          </button>
        </div>
      </div>

      {/* Sticky controls */}
      <div className="sticky top-0 z-10 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70 rounded-xl border p-3 mb-4">
        <div className="flex flex-col sm:flex-row sm:items-center gap-3">
          <div className="flex gap-3">
            {[
              { key: "published", label: "‚úÖ Published Flows" },
              { key: "draft", label: "üìù Draft Flows" },
            ].map(t => (
              <button
                key={t.key}
                className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${
                  activeTab === t.key
                    ? "bg-purple-600 text-white shadow"
                    : "text-gray-600 hover:text-purple-700 hover:bg-purple-50"
                }`}
                onClick={() => {
                  if (loading) return;
                  setSearchParams({ tab: t.key }); // NEW: keep URL in sync
                }}
                disabled={loading}
              >
                {t.label}
              </button>
            ))}
          </div>

          <div className="flex-1" />

          {/* Search + sort */}
          <div className="flex items-center gap-2">
            <div className="relative">
              <input
                type="text"
                className="w-64 max-w-full rounded-md border-gray-300 focus:ring-purple-500 focus:border-purple-500 text-sm"
                placeholder="Search by name or creator‚Ä¶"
                value={query}
                onChange={e => setQuery(e.target.value)}
              />
              <div className="absolute inset-y-0 right-2 grid place-items-center pointer-events-none text-gray-400">
                üîé
              </div>
            </div>
            <select
              className="rounded-md border-gray-300 text-sm focus:ring-purple-500 focus:border-purple-500"
              value={sortKey}
              onChange={e => setSortKey(e.target.value)}
            >
              <option value="updated">Sort: Last updated</option>
              <option value="name">Sort: Name (A‚ÄìZ)</option>
              <option value="created">Sort: Created (newest)</option>
            </select>
          </div>
        </div>
      </div>

      {/* Table */}
      {filtered.length === 0 ? (
        <div className="text-gray-500 text-center py-16">
          {query
            ? "No flows match your search."
            : activeTab === "published"
            ? "No published flows yet. Publish a draft to see it here."
            : "No draft flows yet. Create a new flow to get started."}
        </div>
      ) : (
        <div className="bg-white rounded-xl shadow overflow-hidden">
          <table className="w-full text-sm">
            <thead className="bg-gray-50 border-b text-gray-500 uppercase text-xs tracking-wide">
              <tr>
                <th className="px-4 py-3 text-left">Flow Name</th>
                <th className="px-4 py-3 text-left">Status</th>
                <th className="px-4 py-3 text-left">Last Modified</th>
                <th className="px-4 py-3 text-right">Actions</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-100">
              {filtered.map(flow => (
                <tr key={flow.id} className="hover:bg-gray-50">
                  <td className="px-4 py-3">
                    <div className="font-medium text-gray-900">
                      {flow.flowName}
                    </div>
                    <div className="text-xs text-gray-500">
                      Created {formatDate(flow.createdAt)}
                    </div>
                  </td>
                  <td className="px-4 py-3">{statusPill(flow.isPublished)}</td>
                  <td className="px-4 py-3 text-gray-700">
                    {formatDate(flow.updatedAt || flow.createdAt)}
                  </td>
                  <td className="px-4 py-3">
                    <div className="flex justify-end gap-3">
                      <button
                        onClick={() => goView(flow)}
                        className="text-blue-600 hover:underline text-xs disabled:opacity-50"
                        disabled={loading}
                      >
                        üëÅÔ∏è View
                      </button>

                      {/* PUBLISH (only for drafts) */}
                      {!flow.isPublished && (
                        <button
                          onClick={() => publishFlow(flow)}
                          className="text-emerald-600 hover:underline text-xs disabled:opacity-50"
                          disabled={loading}
                          title="Publish this draft"
                        >
                          üöÄ Publish
                        </button>
                      )}

                      {/* DELETE */}
                      <button
                        onClick={() => openDeleteModal(flow)}
                        className="text-rose-600 hover:underline text-xs disabled:opacity-50"
                        disabled={loading}
                      >
                        üóëÔ∏è Delete
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {/* Modal */}
      {modalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          <div
            className="absolute inset-0 bg-black/40"
            onClick={() => setModalOpen(false)}
          />
          <div
            role="dialog"
            aria-modal="true"
            className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
          >
            {modalMode === "attached" ? (
              <>
                <div className="flex items-start gap-3 mb-4">
                  <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
                    ‚ö†Ô∏è
                  </div>
                  <div>
                    <h3 className="text-lg font-semibold text-gray-900">
                      Cannot delete this flow
                    </h3>
                    <p className="text-sm text-gray-600">
                      <span className="font-medium">
                        {targetFlow?.flowName}
                      </span>{" "}
                      is attached to the following campaign
                      {modalCampaigns.length > 1 ? "s" : ""}. Delete those
                      first.
                    </p>
                  </div>
                </div>
                <div className="max-h-72 overflow-auto rounded-lg border divide-y">
                  {modalCampaigns.map(c => (
                    <div key={c.id} className="p-3 text-sm">
                      <div className="flex items-center justify-between">
                        <div className="font-semibold text-gray-900">
                          {c.name}
                        </div>
                        <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-700">
                          {c.status || "‚Äî"}
                        </span>
                      </div>
                      <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
                        <div>
                          Created:{" "}
                          <span className="font-medium text-gray-800">
                            {formatDate(c.createdAt)}
                          </span>
                        </div>
                        <div>
                          Created by:{" "}
                          <span className="font-medium text-gray-800">
                            {c.createdBy || "‚Äî"}
                          </span>
                        </div>
                        <div>
                          Scheduled:{" "}
                          <span className="font-medium text-gray-800">
                            {formatDate(c.scheduledAt)}
                          </span>
                        </div>
                        <div>
                          First sent:{" "}
                          <span className="font-medium text-gray-800">
                            {formatDate(c.firstSentAt)}
                          </span>
                        </div>
                      </div>
                    </div>
                  ))}
                  {modalCampaigns.length === 0 && (
                    <div className="p-3 text-sm text-gray-600">
                      Could not load campaigns.
                    </div>
                  )}
                </div>
                <div className="mt-5 flex justify-end">
                  <button
                    ref={closeBtnRef}
                    className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
                    onClick={() => setModalOpen(false)}
                  >
                    Close
                  </button>
                </div>
              </>
            ) : (
              <>
                <div className="flex items-start gap-3 mb-4">
                  <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
                    üóëÔ∏è
                  </div>
                  <div>
                    <h3 className="text-lg font-semibold text-gray-900">
                      Delete this flow permanently?
                    </h3>
                    <p className="text-sm text-gray-600">
                      This will remove{" "}
                      <span className="font-medium">
                        {targetFlow?.flowName}
                      </span>{" "}
                      and all of its steps and button links. This action cannot
                      be undone.
                    </p>
                  </div>
                </div>
                <div className="rounded-lg border p-3 bg-rose-50 text-rose-700 text-sm">
                  <span className="font-semibold">Warning:</span> Permanent
                  deletion cannot be recovered.
                </div>
                <div className="mt-5 flex justify-end gap-2">
                  <button
                    className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
                    onClick={() => setModalOpen(false)}
                  >
                    Cancel
                  </button>
                  <button
                    onClick={confirmDelete}
                    className="px-3 py-2 text-sm rounded bg-rose-600 text-white hover:bg-rose-700"
                  >
                    Permanently delete
                  </button>
                </div>
              </>
            )}
          </div>
        </div>
      )}
    </div>
  );
}

// // üìÑ File: xbytechat-ui/src/pages/CTAFlowVisualBuilder/CTAFlowManager.jsx
// import React, { useEffect, useMemo, useRef, useState } from "react";
// import { useNavigate } from "react-router-dom";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";

// export default function CTAFlowManager() {
//   const [flows, setFlows] = useState([]);
//   const [activeTab, setActiveTab] = useState("published"); // default Published
//   const [loading, setLoading] = useState(true);

//   const [modalOpen, setModalOpen] = useState(false);
//   const [modalMode, setModalMode] = useState("confirm"); // confirm | attached
//   const [modalCampaigns, setModalCampaigns] = useState([]);
//   const [targetFlow, setTargetFlow] = useState(null);

//   const [query, setQuery] = useState("");
//   const [sortKey, setSortKey] = useState("updated");
//   const closeBtnRef = useRef(null);
//   const navigate = useNavigate();

//   const formatDate = date =>
//     date
//       ? new Date(date).toLocaleString("en-IN", {
//           day: "2-digit",
//           month: "short",
//           year: "numeric",
//           hour: "2-digit",
//           minute: "2-digit",
//         })
//       : "‚Äî";

//   const statusPill = isPublished =>
//     isPublished ? (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">
//         <span>‚óè</span> Published
//       </span>
//     ) : (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">
//         <span>‚óè</span> Draft
//       </span>
//     );

//   const fetchFlows = async (tab = "published") => {
//     setLoading(true);
//     try {
//       const endpoint =
//         tab === "published" ? "/cta-flow/all-published" : "/cta-flow/all-draft";
//       const res = await axiosClient.get(endpoint);
//       setFlows(Array.isArray(res.data) ? res.data : [res.data]);
//     } catch (err) {
//       setFlows([]);
//       toast.error("‚ùå Failed to load flows.");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   useEffect(() => {
//     fetchFlows("published");
//   }, []);

//   const filtered = useMemo(() => {
//     const q = query.trim().toLowerCase();
//     let out = flows;
//     if (q) {
//       out = out.filter(f =>
//         [f.flowName, f.createdBy]
//           .filter(Boolean)
//           .some(v => String(v).toLowerCase().includes(q))
//       );
//     }
//     switch (sortKey) {
//       case "name":
//         return [...out].sort((a, b) => a.flowName.localeCompare(b.flowName));
//       case "created":
//         return [...out].sort(
//           (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
//         );
//       default:
//         return [...out].sort(
//           (a, b) =>
//             new Date(b.updatedAt || b.createdAt) -
//             new Date(a.updatedAt || a.createdAt)
//         );
//     }
//   }, [flows, query, sortKey]);

//   // ---- delete UX (checks usage) ----
//   const openDeleteModal = async flow => {
//     if (loading) return; // guard
//     setTargetFlow(flow);
//     setLoading(true);
//     try {
//       const { data } = await axiosClient.get(`/cta-flow/${flow.id}/usage`);
//       if (data?.canDelete) {
//         setModalMode("confirm");
//         setModalCampaigns([]);
//       } else {
//         setModalMode("attached");
//         setModalCampaigns(Array.isArray(data?.campaigns) ? data.campaigns : []);
//       }
//       setModalOpen(true);
//       setTimeout(() => closeBtnRef.current?.focus(), 0);
//     } catch (err) {
//       toast.error("‚ùå Could not check usage for this flow.");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   const confirmDelete = async () => {
//     if (!targetFlow) return;
//     setLoading(true);
//     try {
//       const res = await axiosClient.delete(`/cta-flow/${targetFlow.id}`);
//       if (res.status === 204 || res.status === 200) {
//         toast.success("‚úÖ Flow deleted permanently.");
//         setModalOpen(false);
//         setTargetFlow(null);
//         await fetchFlows(activeTab);
//       } else {
//         toast.info("‚ÑπÔ∏è Unexpected response while deleting the flow.");
//       }
//     } catch (err) {
//       const status = err?.response?.status;
//       if (status === 409) {
//         const campaigns = err.response?.data?.campaigns ?? [];
//         setModalMode("attached");
//         setModalCampaigns(campaigns);
//       } else if (status === 404) {
//         toast.error("‚ùå Flow not found.");
//         setModalOpen(false);
//       } else {
//         toast.error("‚ùå Failed to delete flow.");
//         setModalOpen(false);
//       }
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   // ---- publish from draft tab ----
//   const publishFlow = async flow => {
//     if (loading) return; // guard against spam clicks
//     try {
//       setLoading(true);
//       await axiosClient.post(`/cta-flow/${flow.id}/publish`);
//       toast.success("‚úÖ Flow published.");
//       // After publish, jump user to Published tab
//       setActiveTab("published");
//       await fetchFlows("published");
//     } catch (err) {
//       const status = err?.response?.status;
//       if (status === 409) {
//         // If backend blocks due to attachments (unlikely for drafts), surface message
//         toast.error(
//           err?.response?.data?.message || "‚ùå Cannot publish right now."
//         );
//       } else if (status === 404) {
//         toast.error("‚ùå Flow not found.");
//       } else {
//         toast.error("‚ùå Failed to publish flow.");
//       }
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   // ---- edit navigation (fix: ignore click while loading) ----
//   const goEdit = flow => {
//     if (loading) return;
//     // Always open builder in edit mode; builder enforces policies (fork/republish etc.)
//     navigate(`/app/cta-flow/visual-builder?id=${flow.id}&mode=edit`);
//   };

//   const goView = flow => {
//     if (loading) return;
//     navigate(`/app/cta-flow/visual-builder?id=${flow.id}&mode=view`);
//   };

//   return (
//     <div className="p-6 relative">
//       {/* Loading overlay */}
//       {loading && (
//         <>
//           <div className="absolute inset-0 z-40 bg-white/60 backdrop-blur-[1px] flex items-center justify-center">
//             <div className="flex items-center gap-3 text-gray-700">
//               <svg
//                 className="xafb-spin h-6 w-6 text-purple-600"
//                 xmlns="http://www.w3.org/2000/svg"
//                 viewBox="0 0 24 24"
//                 fill="none"
//               >
//                 <circle
//                   cx="12"
//                   cy="12"
//                   r="10"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   opacity="0.25"
//                 />
//                 <path
//                   d="M4 12a8 8 0 018-8"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   strokeLinecap="round"
//                   opacity="0.85"
//                 />
//               </svg>
//               <span className="text-sm">Loading‚Ä¶</span>
//             </div>
//           </div>
//           <style>{`@keyframes xafb-spin{to{transform:rotate(360deg)}}.xafb-spin{animation:xafb-spin 1s linear infinite}`}</style>
//         </>
//       )}

//       {/* Header */}
//       <div className="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between mb-6">
//         <div>
//           <h1 className="text-2xl font-bold text-gray-900">
//             üß© CTA Flow Manager
//           </h1>
//           <p className="text-sm text-gray-500">
//             Create, publish, and manage your visual flows.
//           </p>
//         </div>
//         <div className="flex items-center gap-2">
//           <button
//             onClick={() => navigate("/app/cta-flow/visual-builder")}
//             className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md shadow disabled:opacity-50"
//             disabled={loading}
//           >
//             ‚ûï New Flow
//           </button>
//         </div>
//       </div>

//       {/* Sticky controls */}
//       <div className="sticky top-0 z-10 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70 rounded-xl border p-3 mb-4">
//         <div className="flex flex-col sm:flex-row sm:items-center gap-3">
//           <div className="flex gap-3">
//             {[
//               { key: "published", label: "‚úÖ Published Flows" },
//               { key: "draft", label: "üìù Draft Flows" },
//             ].map(t => (
//               <button
//                 key={t.key}
//                 className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${
//                   activeTab === t.key
//                     ? "bg-purple-600 text-white shadow"
//                     : "text-gray-600 hover:text-purple-700 hover:bg-purple-50"
//                 }`}
//                 onClick={() => {
//                   if (loading) return;
//                   setActiveTab(t.key);
//                   fetchFlows(t.key);
//                 }}
//                 disabled={loading}
//               >
//                 {t.label}
//               </button>
//             ))}
//           </div>

//           <div className="flex-1" />

//           {/* Search + sort */}
//           <div className="flex items-center gap-2">
//             <div className="relative">
//               <input
//                 type="text"
//                 className="w-64 max-w-full rounded-md border-gray-300 focus:ring-purple-500 focus:border-purple-500 text-sm"
//                 placeholder="Search by name or creator‚Ä¶"
//                 value={query}
//                 onChange={e => setQuery(e.target.value)}
//               />
//               <div className="absolute inset-y-0 right-2 grid place-items-center pointer-events-none text-gray-400">
//                 üîé
//               </div>
//             </div>
//             <select
//               className="rounded-md border-gray-300 text-sm focus:ring-purple-500 focus:border-purple-500"
//               value={sortKey}
//               onChange={e => setSortKey(e.target.value)}
//             >
//               <option value="updated">Sort: Last updated</option>
//               <option value="name">Sort: Name (A‚ÄìZ)</option>
//               <option value="created">Sort: Created (newest)</option>
//             </select>
//           </div>
//         </div>
//       </div>

//       {/* Table */}
//       {filtered.length === 0 ? (
//         <div className="text-gray-500 text-center py-16">
//           {query
//             ? "No flows match your search."
//             : activeTab === "published"
//             ? "No published flows yet. Publish a draft to see it here."
//             : "No draft flows yet. Create a new flow to get started."}
//         </div>
//       ) : (
//         <div className="bg-white rounded-xl shadow overflow-hidden">
//           <table className="w-full text-sm">
//             <thead className="bg-gray-50 border-b text-gray-500 uppercase text-xs tracking-wide">
//               <tr>
//                 <th className="px-4 py-3 text-left">Flow Name</th>
//                 <th className="px-4 py-3 text-left">Status</th>
//                 <th className="px-4 py-3 text-left">Last Modified</th>
//                 <th className="px-4 py-3 text-right">Actions</th>
//               </tr>
//             </thead>
//             <tbody className="divide-y divide-gray-100">
//               {filtered.map(flow => (
//                 <tr key={flow.id} className="hover:bg-gray-50">
//                   <td className="px-4 py-3">
//                     <div className="font-medium text-gray-900">
//                       {flow.flowName}
//                     </div>
//                     <div className="text-xs text-gray-500">
//                       Created {formatDate(flow.createdAt)}
//                     </div>
//                   </td>
//                   <td className="px-4 py-3">{statusPill(flow.isPublished)}</td>
//                   <td className="px-4 py-3 text-gray-700">
//                     {formatDate(flow.updatedAt || flow.createdAt)}
//                   </td>
//                   <td className="px-4 py-3">
//                     <div className="flex justify-end gap-3">
//                       <button
//                         onClick={() => goView(flow)}
//                         className="text-blue-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üëÅÔ∏è View
//                       </button>

//                       {/* EDIT */}
//                       {/* <button
//                         onClick={() => goEdit(flow)}
//                         className="text-amber-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         ‚úèÔ∏è {flow.isPublished ? "Edit" : "Edit Draft"}
//                       </button> */}

//                       {/* PUBLISH (only show for drafts) */}
//                       {!flow.isPublished && (
//                         <button
//                           onClick={() => publishFlow(flow)}
//                           className="text-emerald-600 hover:underline text-xs disabled:opacity-50"
//                           disabled={loading}
//                           title="Publish this draft"
//                         >
//                           üöÄ Publish
//                         </button>
//                       )}

//                       {/* DELETE */}
//                       <button
//                         onClick={() => openDeleteModal(flow)}
//                         className="text-rose-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üóëÔ∏è Delete
//                       </button>
//                     </div>
//                   </td>
//                 </tr>
//               ))}
//             </tbody>
//           </table>
//         </div>
//       )}

//       {/* Modal */}
//       {modalOpen && (
//         <div className="fixed inset-0 z-50 flex items-center justify-center">
//           <div
//             className="absolute inset-0 bg-black/40"
//             onClick={() => setModalOpen(false)}
//           />
//           <div
//             role="dialog"
//             aria-modal="true"
//             className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
//           >
//             {modalMode === "attached" ? (
//               <>
//                 <div className="flex items-start gap-3 mb-4">
//                   <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                     ‚ö†Ô∏è
//                   </div>
//                   <div>
//                     <h3 className="text-lg font-semibold text-gray-900">
//                       Cannot delete this flow
//                     </h3>
//                     <p className="text-sm text-gray-600">
//                       <span className="font-medium">
//                         {targetFlow?.flowName}
//                       </span>{" "}
//                       is attached to the following campaign
//                       {modalCampaigns.length > 1 ? "s" : ""}. Delete those
//                       first.
//                     </p>
//                   </div>
//                 </div>
//                 <div className="max-h-72 overflow-auto rounded-lg border divide-y">
//                   {modalCampaigns.map(c => (
//                     <div key={c.id} className="p-3 text-sm">
//                       <div className="flex items-center justify-between">
//                         <div className="font-semibold text-gray-900">
//                           {c.name}
//                         </div>
//                         <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-700">
//                           {c.status || "‚Äî"}
//                         </span>
//                       </div>
//                       <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
//                         <div>
//                           Created:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.createdAt)}
//                           </span>
//                         </div>
//                         <div>
//                           Created by:{" "}
//                           <span className="font-medium text-gray-800">
//                             {c.createdBy || "‚Äî"}
//                           </span>
//                         </div>
//                         <div>
//                           Scheduled:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.scheduledAt)}
//                           </span>
//                         </div>
//                         <div>
//                           First sent:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.firstSentAt)}
//                           </span>
//                         </div>
//                       </div>
//                     </div>
//                   ))}
//                   {modalCampaigns.length === 0 && (
//                     <div className="p-3 text-sm text-gray-600">
//                       Could not load campaigns.
//                     </div>
//                   )}
//                 </div>
//                 <div className="mt-5 flex justify-end">
//                   <button
//                     ref={closeBtnRef}
//                     className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                     onClick={() => setModalOpen(false)}
//                   >
//                     Close
//                   </button>
//                 </div>
//               </>
//             ) : (
//               <>
//                 <div className="flex items-start gap-3 mb-4">
//                   <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                     üóëÔ∏è
//                   </div>
//                   <div>
//                     <h3 className="text-lg font-semibold text-gray-900">
//                       Delete this flow permanently?
//                     </h3>
//                     <p className="text-sm text-gray-600">
//                       This will remove{" "}
//                       <span className="font-medium">
//                         {targetFlow?.flowName}
//                       </span>{" "}
//                       and all of its steps and button links. This action cannot
//                       be undone.
//                     </p>
//                   </div>
//                 </div>
//                 <div className="rounded-lg border p-3 bg-rose-50 text-rose-700 text-sm">
//                   <span className="font-semibold">Warning:</span> Permanent
//                   deletion cannot be recovered.
//                 </div>
//                 <div className="mt-5 flex justify-end gap-2">
//                   <button
//                     className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                     onClick={() => setModalOpen(false)}
//                   >
//                     Cancel
//                   </button>
//                   <button
//                     onClick={confirmDelete}
//                     className="px-3 py-2 text-sm rounded bg-rose-600 text-white hover:bg-rose-700"
//                   >
//                     Permanently delete
//                   </button>
//                 </div>
//               </>
//             )}
//           </div>
//         </div>
//       )}
//     </div>
//   );
// }

// // üìÑ File: xbytechat-ui/src/pages/CTAFlowVisualBuilder/CTAFlowManager.jsx
// import React, { useEffect, useMemo, useRef, useState } from "react";
// import { useNavigate } from "react-router-dom";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";

// export default function CTAFlowManager() {
//   const [flows, setFlows] = useState([]);
//   const [activeTab, setActiveTab] = useState("published"); // default Published
//   const [loading, setLoading] = useState(true);

//   const [modalOpen, setModalOpen] = useState(false);
//   const [modalMode, setModalMode] = useState("confirm"); // confirm | attached
//   const [modalCampaigns, setModalCampaigns] = useState([]);
//   const [targetFlow, setTargetFlow] = useState(null);

//   const [query, setQuery] = useState("");
//   const [sortKey, setSortKey] = useState("updated");
//   const closeBtnRef = useRef(null);
//   const navigate = useNavigate();

//   const formatDate = date =>
//     date
//       ? new Date(date).toLocaleString("en-IN", {
//           day: "2-digit",
//           month: "short",
//           year: "numeric",
//           hour: "2-digit",
//           minute: "2-digit",
//         })
//       : "‚Äî";

//   const statusPill = isPublished =>
//     isPublished ? (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">
//         <span>‚óè</span> Published
//       </span>
//     ) : (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">
//         <span>‚óè</span> Draft
//       </span>
//     );

//   const fetchFlows = async (tab = "published") => {
//     setLoading(true);
//     try {
//       const endpoint =
//         tab === "published" ? "/cta-flow/all-published" : "/cta-flow/all-draft";
//       const res = await axiosClient.get(endpoint);
//       setFlows(Array.isArray(res.data) ? res.data : [res.data]);
//     } catch (err) {
//       setFlows([]);
//       toast.error("‚ùå Failed to load flows");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   useEffect(() => {
//     fetchFlows("published");
//   }, []);

//   const filtered = useMemo(() => {
//     const q = query.trim().toLowerCase();
//     let out = flows;
//     if (q) {
//       out = out.filter(f =>
//         [f.flowName, f.createdBy]
//           .filter(Boolean)
//           .some(v => String(v).toLowerCase().includes(q))
//       );
//     }
//     switch (sortKey) {
//       case "name":
//         return [...out].sort((a, b) => a.flowName.localeCompare(b.flowName));
//       case "created":
//         return [...out].sort(
//           (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
//         );
//       default:
//         return [...out].sort(
//           (a, b) =>
//             new Date(b.updatedAt || b.createdAt) -
//             new Date(a.updatedAt || a.createdAt)
//         );
//     }
//   }, [flows, query, sortKey]);

//   // ---- delete UX (checks usage) ----
//   const openDeleteModal = async flow => {
//     setTargetFlow(flow);
//     setLoading(true);
//     try {
//       const { data } = await axiosClient.get(`/cta-flow/${flow.id}/usage`);
//       if (data?.canDelete) {
//         setModalMode("confirm");
//         setModalCampaigns([]);
//       } else {
//         setModalMode("attached");
//         setModalCampaigns(Array.isArray(data?.campaigns) ? data.campaigns : []);
//       }
//       setModalOpen(true);
//       setTimeout(() => closeBtnRef.current?.focus(), 0);
//     } catch (err) {
//       toast.error("‚ùå Could not check usage for this flow.");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   const confirmDelete = async () => {
//     if (!targetFlow) return;
//     setLoading(true);
//     try {
//       const res = await axiosClient.delete(`/cta-flow/${targetFlow.id}`);
//       if (res.status === 204 || res.status === 200) {
//         toast.success("‚úÖ Flow deleted permanently.");
//         setModalOpen(false);
//         setTargetFlow(null);
//         await fetchFlows(activeTab);
//       } else {
//         toast.info("Unexpected response while deleting the flow.");
//       }
//     } catch (err) {
//       const status = err?.response?.status;
//       if (status === 409) {
//         const campaigns = err.response?.data?.campaigns ?? [];
//         setModalMode("attached");
//         setModalCampaigns(campaigns);
//       } else if (status === 404) {
//         toast.error("‚ùå Flow not found.");
//         setModalOpen(false);
//       } else {
//         toast.error("‚ùå Failed to delete flow.");
//         setModalOpen(false);
//       }
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   return (
//     <div className="p-6 relative">
//       {/* Loading overlay */}
//       {loading && (
//         <>
//           <div className="absolute inset-0 z-40 bg-white/60 backdrop-blur-[1px] flex items-center justify-center">
//             <div className="flex items-center gap-3 text-gray-700">
//               <svg
//                 className="xafb-spin h-6 w-6 text-purple-600"
//                 xmlns="http://www.w3.org/2000/svg"
//                 viewBox="0 0 24 24"
//                 fill="none"
//               >
//                 <circle
//                   cx="12"
//                   cy="12"
//                   r="10"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   opacity="0.25"
//                 />
//                 <path
//                   d="M4 12a8 8 0 018-8"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   strokeLinecap="round"
//                   opacity="0.85"
//                 />
//               </svg>
//               <span className="text-sm">Loading‚Ä¶</span>
//             </div>
//           </div>
//           <style>{`@keyframes xafb-spin{to{transform:rotate(360deg)}}.xafb-spin{animation:xafb-spin 1s linear infinite}`}</style>
//         </>
//       )}

//       {/* Header */}
//       <div className="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between mb-6">
//         <div>
//           <h1 className="text-2xl font-bold text-gray-900">
//             üß© CTA Flow Manager
//           </h1>
//           <p className="text-sm text-gray-500">
//             Create, publish, and manage your visual flows.
//           </p>
//         </div>
//         <div className="flex items-center gap-2">
//           <button
//             onClick={() => navigate("/app/cta-flow/visual-builder")}
//             className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md shadow disabled:opacity-50"
//             disabled={loading}
//           >
//             ‚ûï New Flow
//           </button>
//         </div>
//       </div>

//       {/* Sticky controls */}
//       <div className="sticky top-0 z-10 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70 rounded-xl border p-3 mb-4">
//         <div className="flex flex-col sm:flex-row sm:items-center gap-3">
//           <div className="flex gap-3">
//             {[
//               { key: "published", label: "‚úÖ Published Flows" },
//               { key: "draft", label: "üìù Draft Flows" },
//             ].map(t => (
//               <button
//                 key={t.key}
//                 className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${
//                   activeTab === t.key
//                     ? "bg-purple-600 text-white shadow"
//                     : "text-gray-600 hover:text-purple-700 hover:bg-purple-50"
//                 }`}
//                 onClick={() => {
//                   setActiveTab(t.key);
//                   fetchFlows(t.key);
//                 }}
//                 disabled={loading}
//               >
//                 {t.label}
//               </button>
//             ))}
//           </div>

//           <div className="flex-1" />

//           {/* Search + sort */}
//           <div className="flex items-center gap-2">
//             <div className="relative">
//               <input
//                 type="text"
//                 className="w-64 max-w-full rounded-md border-gray-300 focus:ring-purple-500 focus:border-purple-500 text-sm"
//                 placeholder="Search by name or creator‚Ä¶"
//                 value={query}
//                 onChange={e => setQuery(e.target.value)}
//               />
//               <div className="absolute inset-y-0 right-2 grid place-items-center pointer-events-none text-gray-400">
//                 üîé
//               </div>
//             </div>
//             <select
//               className="rounded-md border-gray-300 text-sm focus:ring-purple-500 focus:border-purple-500"
//               value={sortKey}
//               onChange={e => setSortKey(e.target.value)}
//             >
//               <option value="updated">Sort: Last updated</option>
//               <option value="name">Sort: Name (A‚ÄìZ)</option>
//               <option value="created">Sort: Created (newest)</option>
//             </select>
//           </div>
//         </div>
//       </div>

//       {/* Table */}
//       {filtered.length === 0 ? (
//         <div className="text-gray-500 text-center py-16">
//           {query
//             ? "No flows match your search."
//             : activeTab === "published"
//             ? "No published flows yet. Publish a draft to see it here."
//             : "No draft flows yet. Create a new flow to get started."}
//         </div>
//       ) : (
//         <div className="bg-white rounded-xl shadow overflow-hidden">
//           <table className="w-full text-sm">
//             <thead className="bg-gray-50 border-b text-gray-500 uppercase text-xs tracking-wide">
//               <tr>
//                 <th className="px-4 py-3 text-left">Flow Name</th>
//                 <th className="px-4 py-3 text-left">Status</th>
//                 <th className="px-4 py-3 text-left">Last Modified</th>
//                 <th className="px-4 py-3 text-right">Actions</th>
//               </tr>
//             </thead>
//             <tbody className="divide-y divide-gray-100">
//               {filtered.map(flow => (
//                 <tr key={flow.id} className="hover:bg-gray-50">
//                   <td className="px-4 py-3">
//                     <div className="font-medium text-gray-900">
//                       {flow.flowName}
//                     </div>
//                     <div className="text-xs text-gray-500">
//                       Created {formatDate(flow.createdAt)}
//                     </div>
//                   </td>
//                   <td className="px-4 py-3">{statusPill(flow.isPublished)}</td>
//                   <td className="px-4 py-3 text-gray-700">
//                     {formatDate(flow.updatedAt || flow.createdAt)}
//                   </td>
//                   <td className="px-4 py-3">
//                     <div className="flex justify-end gap-3">
//                       <button
//                         onClick={() =>
//                           navigate(
//                             `/app/cta-flow/visual-builder?id=${flow.id}&mode=view`
//                           )
//                         }
//                         className="text-blue-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üëÅÔ∏è View
//                       </button>

//                       {/* EDIT gate: if published, we'll decide in the builder whether republish is needed or fork */}
//                       <button
//                         onClick={() =>
//                           navigate(
//                             `/app/cta-flow/visual-builder?id=${flow.id}&mode=edit`
//                           )
//                         }
//                         className="text-amber-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         ‚úèÔ∏è Edit
//                       </button>

//                       <button
//                         onClick={() => openDeleteModal(flow)}
//                         className="text-rose-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üóëÔ∏è Delete
//                       </button>
//                     </div>
//                   </td>
//                 </tr>
//               ))}
//             </tbody>
//           </table>
//         </div>
//       )}

//       {/* Modal */}
//       {modalOpen && (
//         <div className="fixed inset-0 z-50 flex items-center justify-center">
//           <div
//             className="absolute inset-0 bg-black/40"
//             onClick={() => setModalOpen(false)}
//           />
//           <div
//             role="dialog"
//             aria-modal="true"
//             className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
//           >
//             {modalMode === "attached" ? (
//               <>
//                 <div className="flex items-start gap-3 mb-4">
//                   <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                     ‚ö†Ô∏è
//                   </div>
//                   <div>
//                     <h3 className="text-lg font-semibold text-gray-900">
//                       Cannot delete this flow
//                     </h3>
//                     <p className="text-sm text-gray-600">
//                       <span className="font-medium">
//                         {targetFlow?.flowName}
//                       </span>{" "}
//                       is attached to the following campaign
//                       {modalCampaigns.length > 1 ? "s" : ""}. Delete those
//                       first.
//                     </p>
//                   </div>
//                 </div>
//                 <div className="max-h-72 overflow-auto rounded-lg border divide-y">
//                   {modalCampaigns.map(c => (
//                     <div key={c.id} className="p-3 text-sm">
//                       <div className="flex items-center justify-between">
//                         <div className="font-semibold text-gray-900">
//                           {c.name}
//                         </div>
//                         <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-700">
//                           {c.status || "‚Äî"}
//                         </span>
//                       </div>
//                       <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
//                         <div>
//                           Created:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.createdAt)}
//                           </span>
//                         </div>
//                         <div>
//                           Created by:{" "}
//                           <span className="font-medium text-gray-800">
//                             {c.createdBy || "‚Äî"}
//                           </span>
//                         </div>
//                         <div>
//                           Scheduled:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.scheduledAt)}
//                           </span>
//                         </div>
//                         <div>
//                           First sent:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.firstSentAt)}
//                           </span>
//                         </div>
//                       </div>
//                     </div>
//                   ))}
//                 </div>
//                 <div className="mt-5 flex justify-end">
//                   <button
//                     ref={closeBtnRef}
//                     className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                     onClick={() => setModalOpen(false)}
//                   >
//                     Close
//                   </button>
//                 </div>
//               </>
//             ) : (
//               <>
//                 <div className="flex items-start gap-3 mb-4">
//                   <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                     üóëÔ∏è
//                   </div>
//                   <div>
//                     <h3 className="text-lg font-semibold text-gray-900">
//                       Delete this flow permanently?
//                     </h3>
//                     <p className="text-sm text-gray-600">
//                       This will remove{" "}
//                       <span className="font-medium">
//                         {targetFlow?.flowName}
//                       </span>{" "}
//                       and all of its steps and button links. This action cannot
//                       be undone.
//                     </p>
//                   </div>
//                 </div>
//                 <div className="rounded-lg border p-3 bg-rose-50 text-rose-700 text-sm">
//                   <span className="font-semibold">Warning:</span> Permanent
//                   deletion cannot be recovered.
//                 </div>
//                 <div className="mt-5 flex justify-end gap-2">
//                   <button
//                     className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                     onClick={() => setModalOpen(false)}
//                   >
//                     Cancel
//                   </button>
//                   <button
//                     onClick={confirmDelete}
//                     className="px-3 py-2 text-sm rounded bg-rose-600 text-white hover:bg-rose-700"
//                   >
//                     Permanently delete
//                   </button>
//                 </div>
//               </>
//             )}
//           </div>
//         </div>
//       )}
//     </div>
//   );
// }

// import React, { useEffect, useMemo, useRef, useState } from "react";
// import { useNavigate } from "react-router-dom";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";

// export default function CTAFlowManager() {
//   // ---------- state ----------
//   const [flows, setFlows] = useState([]);
//   const [activeTab, setActiveTab] = useState("published"); // ‚úÖ default to published
//   const [loading, setLoading] = useState(true);

//   // Search + sort (client-side)
//   const [query, setQuery] = useState("");
//   const [sortKey, setSortKey] = useState("updated"); // updated | name | created

//   // Modal
//   const [modalOpen, setModalOpen] = useState(false);
//   const [modalMode, setModalMode] = useState("confirm"); // confirm | attached
//   const [modalCampaigns, setModalCampaigns] = useState([]);
//   const [targetFlow, setTargetFlow] = useState(null);

//   const navigate = useNavigate();
//   const closeBtnRef = useRef(null);

//   // ---------- helpers ----------
//   const formatDate = date => {
//     if (!date) return "‚Äî";
//     const d = new Date(date);
//     return d.toLocaleString("en-IN", {
//       day: "2-digit",
//       month: "short",
//       year: "numeric",
//       hour: "2-digit",
//       minute: "2-digit",
//     });
//   };

//   const statusPill = isPublished =>
//     isPublished ? (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">
//         <span>‚óè</span> Published
//       </span>
//     ) : (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">
//         <span>‚óè</span> Draft
//       </span>
//     );

//   const renderStatusBadge = status => {
//     const s = (status || "").toLowerCase();
//     const map = {
//       draft: "bg-amber-100 text-amber-700",
//       scheduled: "bg-sky-100 text-sky-700",
//       running: "bg-blue-100 text-blue-700",
//       sent: "bg-emerald-100 text-emerald-700",
//       completed: "bg-emerald-100 text-emerald-700",
//       failed: "bg-rose-100 text-rose-700",
//     };
//     const cls = map[s] || "bg-gray-100 text-gray-700";
//     return (
//       <span
//         className={`inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium ${cls}`}
//       >
//         {status || "‚Äî"}
//       </span>
//     );
//   };

//   // ---------- data ----------
//   const fetchFlows = async (tab = "published") => {
//     setLoading(true);
//     try {
//       const endpoint =
//         tab === "published" ? "/cta-flow/all-published" : "/cta-flow/all-draft";
//       const res = await axiosClient.get(endpoint);
//       const list = Array.isArray(res.data) ? res.data : [res.data];
//       setFlows(list);
//     } catch (err) {
//       setFlows([]);
//       toast.error("‚ùå Failed to load flows");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   useEffect(() => {
//     fetchFlows("published"); // ‚úÖ first load = published
//   }, []);

//   // ---------- search + sort (client-side) ----------
//   const filtered = useMemo(() => {
//     const q = query.trim().toLowerCase();
//     let out = flows;
//     if (q) {
//       out = out.filter(f =>
//         [f.flowName, f.createdBy]
//           .filter(Boolean)
//           .some(v => String(v).toLowerCase().includes(q))
//       );
//     }
//     switch (sortKey) {
//       case "name":
//         out = [...out].sort((a, b) => a.flowName.localeCompare(b.flowName));
//         break;
//       case "created":
//         out = [...out].sort(
//           (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
//         );
//         break;
//       default:
//         out = [...out].sort(
//           (a, b) =>
//             new Date(b.updatedAt || b.createdAt) -
//             new Date(a.updatedAt || a.createdAt)
//         );
//     }
//     return out;
//   }, [flows, query, sortKey]);

//   // ---------- delete flow UX ----------
//   const openDeleteModal = async flow => {
//     setTargetFlow(flow);
//     setLoading(true);
//     try {
//       const { data } = await axiosClient.get(`/cta-flow/${flow.id}/usage`);
//       if (data?.canDelete) {
//         setModalMode("confirm");
//         setModalCampaigns([]);
//       } else {
//         setModalMode("attached");
//         setModalCampaigns(Array.isArray(data?.campaigns) ? data.campaigns : []);
//       }
//       setModalOpen(true);
//       setTimeout(() => closeBtnRef.current?.focus(), 0);
//     } catch (err) {
//       toast.error("‚ùå Could not check usage for this flow.");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   const confirmDelete = async () => {
//     if (!targetFlow) return;
//     setLoading(true);
//     try {
//       const res = await axiosClient.delete(`/cta-flow/${targetFlow.id}`);
//       if (res.status === 204 || res.status === 200) {
//         toast.success("‚úÖ Flow deleted permanently.");
//         setModalOpen(false);
//         setTargetFlow(null);
//         await fetchFlows(activeTab);
//       } else {
//         toast.info("Unexpected response while deleting the flow.");
//       }
//     } catch (err) {
//       const status = err?.response?.status;
//       if (status === 409) {
//         const campaigns = err.response?.data?.campaigns ?? [];
//         setModalMode("attached");
//         setModalCampaigns(campaigns);
//       } else if (status === 404) {
//         toast.error("‚ùå Flow not found.");
//         setModalOpen(false);
//       } else {
//         toast.error("‚ùå Failed to delete flow.");
//         setModalOpen(false);
//       }
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   // ---------- UI ----------
//   return (
//     <div className="p-6 relative">
//       {/* Loading overlay */}
//       {loading && (
//         <>
//           <div className="absolute inset-0 z-40 bg-white/60 backdrop-blur-[1px] flex items-center justify-center">
//             <div className="flex items-center gap-3 text-gray-700">
//               <svg
//                 className="xafb-spin h-6 w-6 text-purple-600"
//                 xmlns="http://www.w3.org/2000/svg"
//                 viewBox="0 0 24 24"
//                 fill="none"
//               >
//                 <circle
//                   cx="12"
//                   cy="12"
//                   r="10"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   opacity="0.25"
//                 />
//                 <path
//                   d="M4 12a8 8 0 018-8"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   strokeLinecap="round"
//                   opacity="0.85"
//                 />
//               </svg>
//               <span className="text-sm">Loading‚Ä¶</span>
//             </div>
//           </div>
//           <style>{`@keyframes xafb-spin{to{transform:rotate(360deg)}}.xafb-spin{animation:xafb-spin 1s linear infinite}`}</style>
//         </>
//       )}

//       {/* Page header */}
//       <div className="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between mb-6">
//         <div>
//           <h1 className="text-2xl font-bold text-gray-900">
//             üß© CTA Flow Manager
//           </h1>
//           <p className="text-sm text-gray-500">
//             Create, publish, and manage your visual flows.
//           </p>
//         </div>
//         <div className="flex items-center gap-2">
//           <button
//             onClick={() => navigate("/app/cta-flow/visual-builder")}
//             className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md shadow disabled:opacity-50"
//             disabled={loading}
//           >
//             ‚ûï New Flow
//           </button>
//         </div>
//       </div>

//       {/* Sticky controls */}
//       <div className="sticky top-0 z-10 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70 rounded-xl border p-3 mb-4">
//         <div className="flex flex-col sm:flex-row sm:items-center gap-3">
//           {/* Tabs */}
//           <div className="flex gap-3">
//             {[
//               { key: "published", label: "‚úÖ Published Flows" },
//               { key: "draft", label: "üìù Draft Flows" },
//             ].map(t => (
//               <button
//                 key={t.key}
//                 className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${
//                   activeTab === t.key
//                     ? "bg-purple-600 text-white shadow"
//                     : "text-gray-600 hover:text-purple-700 hover:bg-purple-50"
//                 }`}
//                 onClick={() => {
//                   setActiveTab(t.key);
//                   fetchFlows(t.key);
//                 }}
//                 disabled={loading}
//               >
//                 {t.label}
//               </button>
//             ))}
//           </div>

//           {/* Spacer */}
//           <div className="flex-1" />

//           {/* Search */}
//           <div className="flex items-center gap-2">
//             <div className="relative">
//               <input
//                 type="text"
//                 className="w-64 max-w-full rounded-md border-gray-300 focus:ring-purple-500 focus:border-purple-500 text-sm"
//                 placeholder="Search by name or creator‚Ä¶"
//                 value={query}
//                 onChange={e => setQuery(e.target.value)}
//               />
//               <div className="absolute inset-y-0 right-2 grid place-items-center pointer-events-none text-gray-400">
//                 üîé
//               </div>
//             </div>

//             {/* Sort */}
//             <select
//               className="rounded-md border-gray-300 text-sm focus:ring-purple-500 focus:border-purple-500"
//               value={sortKey}
//               onChange={e => setSortKey(e.target.value)}
//             >
//               <option value="updated">Sort: Last updated</option>
//               <option value="name">Sort: Name (A‚ÄìZ)</option>
//               <option value="created">Sort: Created (newest)</option>
//             </select>
//           </div>
//         </div>
//       </div>

//       {/* Content */}
//       {filtered.length === 0 ? (
//         <div className="text-gray-500 text-center py-16">
//           {query
//             ? "No flows match your search."
//             : activeTab === "published"
//             ? "No published flows yet. Publish a draft to see it here."
//             : "No draft flows yet. Create a new flow to get started."}
//         </div>
//       ) : (
//         <div className="bg-white rounded-xl shadow overflow-hidden">
//           <table className="w-full text-sm">
//             <thead className="bg-gray-50 border-b text-gray-500 uppercase text-xs tracking-wide">
//               <tr>
//                 <th className="px-4 py-3 text-left">Flow Name</th>
//                 <th className="px-4 py-3 text-left">Status</th>
//                 <th className="px-4 py-3 text-left">Last Modified</th>
//                 <th className="px-4 py-3 text-right">Actions</th>
//               </tr>
//             </thead>
//             <tbody className="divide-y divide-gray-100">
//               {filtered.map(flow => (
//                 <tr key={flow.id} className="hover:bg-gray-50">
//                   <td className="px-4 py-3">
//                     <div className="font-medium text-gray-900">
//                       {flow.flowName}
//                     </div>
//                     <div className="text-xs text-gray-500">
//                       Created {formatDate(flow.createdAt)}
//                     </div>
//                   </td>
//                   <td className="px-4 py-3">{statusPill(flow.isPublished)}</td>
//                   <td className="px-4 py-3 text-gray-700">
//                     {formatDate(flow.updatedAt || flow.createdAt)}
//                   </td>
//                   <td className="px-4 py-3">
//                     <div className="flex justify-end gap-3">
//                       <button
//                         onClick={() =>
//                           navigate(
//                             `/app/cta-flow/visual-builder?id=${flow.id}&mode=view`
//                           )
//                         }
//                         className="text-blue-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üëÅÔ∏è View
//                       </button>
//                       {!flow.isPublished && (
//                         <button
//                           onClick={() =>
//                             navigate(
//                               `/app/cta-flow/visual-builder?id=${flow.id}&mode=edit`
//                             )
//                           }
//                           className="text-amber-600 hover:underline text-xs disabled:opacity-50"
//                           disabled={loading}
//                         >
//                           ‚úèÔ∏è Edit
//                         </button>
//                       )}
//                       <button
//                         onClick={() => openDeleteModal(flow)}
//                         className="text-rose-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üóëÔ∏è Delete
//                       </button>
//                     </div>
//                   </td>
//                 </tr>
//               ))}
//             </tbody>
//           </table>
//         </div>
//       )}

//       {/* Modal */}
//       {modalOpen && (
//         <div className="fixed inset-0 z-50 flex items-center justify-center">
//           <div
//             className="absolute inset-0 bg-black/40"
//             onClick={() => setModalOpen(false)}
//           />
//           <div
//             role="dialog"
//             aria-modal="true"
//             className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
//           >
//             {/* Header */}
//             {modalMode === "attached" ? (
//               <div className="flex items-start gap-3 mb-4">
//                 <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                   ‚ö†Ô∏è
//                 </div>
//                 <div>
//                   <h3 className="text-lg font-semibold text-gray-900">
//                     Cannot delete this flow
//                   </h3>
//                   <p className="text-sm text-gray-600">
//                     <span className="font-medium">{targetFlow?.flowName}</span>{" "}
//                     is attached to the campaign
//                     {modalCampaigns.length > 1 ? "s" : ""} below. Delete those
//                     campaign
//                     {modalCampaigns.length > 1 ? "s" : ""} first.
//                   </p>
//                 </div>
//               </div>
//             ) : (
//               <div className="flex items-start gap-3 mb-4">
//                 <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                   üóëÔ∏è
//                 </div>
//                 <div>
//                   <h3 className="text-lg font-semibold text-gray-900">
//                     Delete this flow permanently?
//                   </h3>
//                   <p className="text-sm text-gray-600">
//                     This will remove{" "}
//                     <span className="font-medium">{targetFlow?.flowName}</span>{" "}
//                     and all of its steps and button links. This action cannot be
//                     undone.
//                   </p>
//                 </div>
//               </div>
//             )}

//             {/* Body */}
//             {modalMode === "attached" ? (
//               <div className="max-h-72 overflow-auto rounded-lg border divide-y">
//                 {modalCampaigns.map(c => (
//                   <div key={c.id} className="p-3 text-sm">
//                     <div className="flex items-center justify-between">
//                       <div className="font-semibold text-gray-900">
//                         {c.name}
//                       </div>
//                       {renderStatusBadge(c.status)}
//                     </div>
//                     <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
//                       <div>
//                         Created:{" "}
//                         <span className="font-medium text-gray-800">
//                           {formatDate(c.createdAt)}
//                         </span>
//                       </div>
//                       <div>
//                         Created by:{" "}
//                         <span className="font-medium text-gray-800">
//                           {c.createdBy || "‚Äî"}
//                         </span>
//                       </div>
//                       <div>
//                         Scheduled:{" "}
//                         <span className="font-medium text-gray-800">
//                           {formatDate(c.scheduledAt)}
//                         </span>
//                       </div>
//                       <div>
//                         First sent:{" "}
//                         <span className="font-medium text-gray-800">
//                           {formatDate(c.firstSentAt)}
//                         </span>
//                       </div>
//                     </div>
//                   </div>
//                 ))}
//               </div>
//             ) : (
//               <div className="rounded-lg border p-3 bg-rose-50 text-rose-700 text-sm">
//                 <span className="font-semibold">Warning:</span> This will
//                 permanently delete the flow and its data.
//               </div>
//             )}

//             {/* Footer */}
//             <div className="mt-5 flex justify-end gap-2">
//               <button
//                 ref={closeBtnRef}
//                 className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                 onClick={() => setModalOpen(false)}
//               >
//                 Close
//               </button>
//               {modalMode === "confirm" && (
//                 <button
//                   onClick={confirmDelete}
//                   className="px-3 py-2 text-sm rounded bg-rose-600 text-white hover:bg-rose-700"
//                 >
//                   Permanently delete
//                 </button>
//               )}
//             </div>
//           </div>
//         </div>
//       )}
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\ctaFlowVisualApi.js 
====================================================== 
 
// üìÑ File: xbytechat-ui/src/pages/CTAFlowVisualBuilder/ctaFlowVisualApi.js
import axiosClient from "../../api/axiosClient";

const toBool = v => v === true || v === "true" || v === 1;
const toPosInt = (v, def = 1) => {
  const n = parseInt(v, 10);
  return Number.isFinite(n) && n > 0 ? n : def;
};

// ---- shared payload normalizer ----
function normalizePayload(payload) {
  const safeNodes = (payload.Nodes || []).map(node => ({
    Id: node.Id || "",
    TemplateName: node.TemplateName || "",
    TemplateType: node.TemplateType || "text_template",
    MessageBody: node.MessageBody || "",
    PositionX: node.PositionX ?? 0,
    PositionY: node.PositionY ?? 0,
    TriggerButtonText: node.TriggerButtonText || "",
    TriggerButtonType: node.TriggerButtonType || "cta",
    UseProfileName: toBool(node.UseProfileName),
    ProfileNameSlot: toPosInt(node.ProfileNameSlot ?? 1, 1),
    Buttons: (node.Buttons || []).map((btn, idx) => ({
      Text: btn.Text || "",
      Type: btn.Type || "",
      SubType: btn.SubType || "",
      Value: btn.Value || "",
      Index: Number.isFinite(btn.Index) ? btn.Index : idx,
      TargetNodeId: btn.TargetNodeId || null,
    })),
  }));

  const safeEdges = (payload.Edges || []).map(e => ({
    FromNodeId: e.FromNodeId || "",
    ToNodeId: e.ToNodeId || "",
    SourceHandle: e.SourceHandle || "",
  }));

  return {
    FlowName: payload.FlowName || "Untitled",
    IsPublished: !!payload.IsPublished,
    Nodes: safeNodes,
    Edges: safeEdges,
  };
}

// ---- CREATE (by name) ----
export async function saveVisualFlow(payload) {
  const res = await axiosClient.post(
    "/cta-flow/save-visual",
    normalizePayload(payload)
  );
  return res.data;
}

// ---- LOAD BY ID ----
export async function getVisualFlowById(flowId) {
  if (!flowId) throw new Error("flowId is required");
  const res = await axiosClient.get(`/cta-flow/by-id/${flowId}`);
  return res.data;
}

// ---- USAGE (edit/delete gates) ----
export async function getFlowUsage(flowId) {
  if (!flowId) throw new Error("flowId is required");
  const { data } = await axiosClient.get(`/cta-flow/${flowId}/usage`);
  return data; // { canDelete, count, campaigns }
}

// ---- UPDATE BY ID ----
export async function updateVisualFlow(flowId, payload) {
  if (!flowId) throw new Error("flowId is required");
  const res = await axiosClient.put(
    `/cta-flow/${flowId}`,
    normalizePayload(payload)
  );
  return res.data; // { message, needsRepublish? }
}

// ---- PUBLISH ----
export async function publishFlow(flowId) {
  if (!flowId) throw new Error("flowId is required");
  const res = await axiosClient.post(`/cta-flow/${flowId}/publish`);
  return res.data;
}

// ---- FORK (create draft version) ----
export async function forkFlow(flowId) {
  if (!flowId) throw new Error("flowId is required");
  const res = await axiosClient.post(`/cta-flow/${flowId}/fork`);
  return res.data; // { flowId }
}

// ---- (Optional) DELETE helper for manager page ----
export async function deleteFlow(flowId) {
  if (!flowId) throw new Error("flowId is required");
  const res = await axiosClient.delete(`/cta-flow/${flowId}`);
  return res.data;
}

// // üìÑ File: xbytechat-ui/src/pages/CTAFlowVisualBuilder/ctaFlowVisualApi.js
// import axiosClient from "../../api/axiosClient";

// const toBool = v => v === true || v === "true" || v === 1;
// const toPosInt = (v, def = 1) => {
//   const n = parseInt(v, 10);
//   return Number.isFinite(n) && n > 0 ? n : def;
// };

// // ---- CREATE / UPSERT BY NAME (existing) ----
// export async function saveVisualFlow(payload) {
//   const safeNodes = (payload.Nodes || []).map(node => ({
//     Id: node.Id || "",
//     TemplateName: node.TemplateName || "",
//     TemplateType: node.TemplateType || "text_template",
//     MessageBody: node.MessageBody || "",
//     PositionX: node.PositionX ?? 0,
//     PositionY: node.PositionY ?? 0,
//     TriggerButtonText: node.TriggerButtonText || "",
//     TriggerButtonType: node.TriggerButtonType || "cta",
//     UseProfileName: toBool(node.UseProfileName),
//     ProfileNameSlot: toPosInt(node.ProfileNameSlot ?? 1, 1),
//     Buttons: (node.Buttons || []).map((btn, idx) => ({
//       Text: btn.Text || "",
//       Type: btn.Type || "",
//       SubType: btn.SubType || "",
//       Value: btn.Value || "",
//       Index: Number.isFinite(btn.Index) ? btn.Index : idx,
//       TargetNodeId: btn.TargetNodeId || null,
//     })),
//   }));

//   const safeEdges = (payload.Edges || []).map(e => ({
//     FromNodeId: e.FromNodeId || "",
//     ToNodeId: e.ToNodeId || "",
//     SourceHandle: e.SourceHandle || "",
//   }));

//   const fixedPayload = {
//     FlowName: payload.FlowName || "Untitled",
//     IsPublished: !!payload.IsPublished,
//     Nodes: safeNodes,
//     Edges: safeEdges,
//   };

//   const res = await axiosClient.post("/cta-flow/save-visual", fixedPayload);
//   return res.data;
// }

// // ---- LOAD BY ID (existing consumer in builder) ----
// export async function getVisualFlowById(flowId) {
//   const res = await axiosClient.get(`/cta-flow/by-id/${flowId}`);
//   return res.data;
// }

// // ---- NEW: usage for delete/edit gates ----
// export async function getFlowUsage(flowId) {
//   const { data } = await axiosClient.get(`/cta-flow/${flowId}/usage`);
//   return data; // { canDelete: boolean, campaigns: [] }
// }

// // ---- NEW: update by id (two-state policy on backend) ----
// export async function updateVisualFlow(flowId, payload) {
//   const res = await axiosClient.put(`/cta-flow/${flowId}`, payload);
//   return res.data; // { message, needsRepublish? }
// }

// // ---- NEW: publish ----
// export async function publishFlow(flowId) {
//   const res = await axiosClient.post(`/cta-flow/${flowId}/publish`);
//   return res.data;
// }

// // ---- NEW: fork ----
// export async function forkFlow(flowId) {
//   const res = await axiosClient.post(`/cta-flow/${flowId}/fork`);
//   return res.data; // { flowId }
// }

// import axiosClient from "../../api/axiosClient";
// /**
//  * Coerce values coming from the UI into clean types for the API.
//  */
// const toBool = v => v === true || v === "true" || v === 1;
// const toPosInt = (v, def = 1) => {
//   const n = parseInt(v, 10);
//   return Number.isFinite(n) && n > 0 ? n : def;
// };

// /**
//  * Save a visual flow (nodes + edges).
//  * Includes UseProfileName/ProfileNameSlot so the runtime knows where to inject the WA profile name.
//  */
// export async function saveVisualFlow(payload) {
//   const safeNodes = (payload.Nodes || []).map(node => ({
//     Id: node.Id || "",
//     TemplateName: node.TemplateName || "",
//     TemplateType: node.TemplateType || "text_template",
//     MessageBody: node.MessageBody || "",
//     PositionX: node.PositionX ?? 0,
//     PositionY: node.PositionY ?? 0,
//     TriggerButtonText: node.TriggerButtonText || "",
//     TriggerButtonType: node.TriggerButtonType || "cta",

//     // üëá NEW: persist the greeting controls per-step
//     UseProfileName: toBool(node.UseProfileName),
//     ProfileNameSlot: toPosInt(node.ProfileNameSlot ?? 1, 1),

//     // buttons with stable Index (used later to map clicks)
//     Buttons: (node.Buttons || []).map((btn, idx) => ({
//       Text: btn.Text || "",
//       Type: btn.Type || "",
//       SubType: btn.SubType || "",
//       Value: btn.Value || "",
//       TargetNodeId: btn.TargetNodeId || null,
//       Index: Number.isFinite(btn.Index) ? btn.Index : idx,
//     })),
//   }));

//   const safeEdges = (payload.Edges || []).map(e => ({
//     FromNodeId: e.FromNodeId || "",
//     ToNodeId: e.ToNodeId || "",
//     SourceHandle: e.SourceHandle || "", // button text
//   }));

//   const fixedPayload = {
//     FlowName: payload.FlowName || "Untitled",
//     IsPublished: !!payload.IsPublished,
//     Nodes: safeNodes,
//     Edges: safeEdges,
//   };

//   const res = await axiosClient.post("/cta-flow/save-visual", fixedPayload);
//   return res.data;
// }

// /**
//  * Load a visual flow by ID.
//  * The builder expects the response shape to include: { flowName, nodes: [...], edges: [...] }.
//  */
// export async function getVisualFlowById(flowId) {
//   const res = await axiosClient.get(`/cta-flow/by-id/${flowId}`);
//   return res.data;
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\CTAFlowVisualBuilder.jsx 
====================================================== 
 
// src/pages/CTAFlowVisualBuilder/CTAFlowVisualBuilder.jsx
import React, {
  useCallback,
  useState,
  useEffect,
  useMemo,
  useRef,
} from "react";
import {
  ReactFlow,
  ReactFlowProvider,
  Background,
  Controls,
  MiniMap,
  useNodesState,
  useEdgesState,
  addEdge,
  MarkerType,
  ConnectionMode,
  useReactFlow,
} from "@xyflow/react";
import "@xyflow/react/dist/style.css";
import { Eye, Minus } from "lucide-react";
import { useSearchParams, useNavigate } from "react-router-dom";
import TemplatePickerModal from "./components/TemplatePickerModal";
import FlowNodeBubble from "./components/FlowNodeBubble";
import {
  saveVisualFlow,
  getVisualFlowById,
  updateVisualFlow,
  publishFlow,
  forkFlow,
  getFlowUsage,
} from "./ctaFlowVisualApi";
import { v4 as uuidv4 } from "uuid";
import { toast } from "react-toastify";
import dagre from "dagre";
import SmartLabeledEdge from "./components/edges/SmartLabeledEdge";

const GRID = 16;
const NODE_DEFAULT = { width: 260, height: 140 };

function CTAFlowVisualBuilderInner() {
  const [nodes, setNodes, onNodesChange] = useNodesState([]);
  const [edges, setEdges, onEdgesChange] = useEdgesState([]);
  const nodesRef = useRef([]);
  const [showPicker, setShowPicker] = useState(false);
  const [flowName, setFlowName] = useState("");
  const flowNameRef = useRef(null);
  const [showMiniMap, setShowMiniMap] = useState(false);
  const [readonly, setReadonly] = useState(false);

  // policy state
  const [isPublished, setIsPublished] = useState(false);
  const [republishNeeded, setRepublishNeeded] = useState(false);
  const [lockInfo, setLockInfo] = useState({ locked: false, campaigns: [] });
  const [forkModalOpen, setForkModalOpen] = useState(false);

  // async state
  const [saving, setSaving] = useState(false);
  const [loading, setLoading] = useState(false);

  const [dirty, setDirty] = useState(false);

  const [searchParams] = useSearchParams();
  const navigate = useNavigate();
  const { fitView, zoomIn, zoomOut } = useReactFlow();

  const mode = searchParams.get("mode"); // 'edit' | 'view' | null
  const flowId = searchParams.get("id");
  const visualDebug = true;

  // figure out source tab for Back button
  const fromTab = (searchParams.get("from") || "draft").toLowerCase();
  const backTab = fromTab === "published" ? "published" : "draft";

  const goBackToManager = useCallback(() => {
    if (!readonly && dirty) {
      const ok = window.confirm("You have unsaved changes. Leave this page?");
      if (!ok) return;
    }
    navigate(`/app/cta-flow/flow-manager?tab=${backTab}`);
  }, [readonly, dirty, backTab, navigate]);

  useEffect(() => {
    nodesRef.current = [...nodes];
  }, [nodes]);

  // warn on unload if dirty
  useEffect(() => {
    const onBeforeUnload = e => {
      if (!dirty) return;
      e.preventDefault();
      e.returnValue = "";
    };
    window.addEventListener("beforeunload", onBeforeUnload);
    return () => window.removeEventListener("beforeunload", onBeforeUnload);
  }, [dirty]);

  // --- Node helpers
  const handleDeleteNode = useCallback(
    nodeId => {
      if (readonly) return;
      setDirty(true);
      setNodes(nds => nds.filter(n => n.id !== nodeId));
      setEdges(eds =>
        eds.filter(e => e.source !== nodeId && e.target !== nodeId)
      );
    },
    [readonly, setNodes, setEdges]
  );

  const handleNodeDataChange = useCallback(
    (nodeId, newData) => {
      setDirty(true);
      setNodes(nds =>
        nds.map(n =>
          n.id === nodeId ? { ...n, data: { ...n.data, ...newData } } : n
        )
      );
    },
    [setNodes]
  );

  const nodeTypes = useMemo(
    () => ({
      customBubble: props => (
        <FlowNodeBubble
          {...props}
          onDelete={handleDeleteNode}
          onDataChange={newData => handleNodeDataChange(props.id, newData)}
          readonly={readonly}
          visualDebug={visualDebug}
        />
      ),
    }),
    [handleDeleteNode, readonly, visualDebug, handleNodeDataChange]
  );

  const edgeTypes = useMemo(() => ({ smart: SmartLabeledEdge }), []);

  // --- Load / Bootstrap + policy checks
  useEffect(() => {
    const load = async () => {
      setLoading(true);
      if (mode === "edit" || mode === "view") {
        try {
          const data = await getVisualFlowById(flowId);

          const builtNodes = (data.nodes || []).map((node, index) => ({
            id: node.id,
            type: "customBubble",
            position: {
              x: node.positionX ?? 120 + index * 120,
              y: node.positionY ?? 150 + (index % 5) * 60,
            },
            data: {
              templateName: node.templateName,
              templateType: node.templateType,
              messageBody: node.messageBody,
              triggerButtonText: node.triggerButtonText || "",
              triggerButtonType: node.triggerButtonType || "cta",
              requiredTag: node.requiredTag || "",
              requiredSource: node.requiredSource || "",
              useProfileName: !!node.useProfileName,
              profileNameSlot:
                typeof node.profileNameSlot === "number" &&
                node.profileNameSlot > 0
                  ? node.profileNameSlot
                  : 1,
              buttons: (node.buttons || []).map((btn, i) => ({
                text: btn.text,
                type: btn.type,
                subType: btn.subType,
                value: btn.value,
                targetNodeId: btn.targetNodeId || null,
                index: typeof btn.index === "number" ? btn.index : i,
              })),
            },
          }));

          const builtEdges = (data.edges || []).map(edge => ({
            id: `e-${edge.fromNodeId}-${edge.toNodeId}-${
              edge.sourceHandle || "h"
            }`,
            source: edge.fromNodeId,
            target: edge.toNodeId,
            sourceHandle: edge.sourceHandle || null,
            type: "smart",
            animated: true,
            style: { stroke: "#9333ea" },
            markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
            label: edge.sourceHandle || "",
          }));

          const nodesWithIncoming = new Set(builtEdges.map(e => e.target));
          const nodesWithWarnings = builtNodes.map(node => ({
            ...node,
            data: {
              ...node.data,
              isUnreachable: false,
              hasNoIncoming: !nodesWithIncoming.has(node.id),
            },
          }));

          setNodes(nodesWithWarnings);
          setEdges(builtEdges);
          setFlowName(data.flowName || "Untitled Flow");
          setIsPublished(!!data.isPublished);
          setDirty(false);

          // policy: if editing a published flow, check attachment
          if (mode === "edit" && data.isPublished) {
            try {
              const usage = await getFlowUsage(flowId);
              if (usage?.campaigns?.length > 0) {
                setLockInfo({ locked: true, campaigns: usage.campaigns });
                setForkModalOpen(true);
                setReadonly(true);
              } else {
                setReadonly(false);
              }
            } catch {
              setLockInfo({ locked: true, campaigns: [] });
              setForkModalOpen(true);
              setReadonly(true);
            }
          } else {
            setReadonly(mode === "view");
          }

          // initial fit
          setTimeout(() => fitView({ padding: 0.25 }), 80);
        } catch {
          toast.error("‚ùå Failed to load flow");
        } finally {
          setLoading(false);
        }
      } else {
        // creating new flow
        setNodes([]);
        setEdges([]);
        setFlowName("Untitled Flow");
        setIsPublished(false);
        setReadonly(false);
        setDirty(false);
        setLoading(false);
        setTimeout(() => fitView({ padding: 0.25 }), 80);
      }
    };

    load();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [flowId, mode]);

  // Auto-fit when viewing, and refit on window resize
  useEffect(() => {
    if (mode !== "view") return;
    const t = setTimeout(() => fitView({ padding: 0.25 }), 80);
    const onResize = () => fitView({ padding: 0.25 });
    window.addEventListener("resize", onResize);
    return () => {
      clearTimeout(t);
      window.removeEventListener("resize", onResize);
    };
  }, [mode, nodes.length, edges.length, fitView]);

  // --- Add template
  const handleTemplateSelect = ({ name, type, body, buttons = [] }) => {
    if (readonly) return;
    const id = uuidv4();
    const newNode = {
      id,
      position: { x: Math.random() * 400 + 100, y: Math.random() * 300 + 100 },
      type: "customBubble",
      data: {
        templateName: name || "Untitled",
        templateType: type || "text_template",
        messageBody: body || "Message body preview...",
        triggerButtonText: buttons[0]?.text || "",
        triggerButtonType: "cta",
        useProfileName: false,
        profileNameSlot: 1,
        buttons: buttons.map((btn, idx) => ({
          text: btn.text || "",
          type: btn.type || "QUICK_REPLY",
          subType: btn.subType || "",
          value: btn.parameterValue || "",
          targetNodeId: null,
          index: idx,
        })),
      },
    };
    setDirty(true);
    setNodes(nds => [...nds, newNode]);
    setShowPicker(false);
    toast.success(
      `‚úÖ Step added with ${type?.replace("_", " ") || "template"}`
    );
    setTimeout(() => fitView({ padding: 0.25 }), 50);
  };

  // --- Connection rules
  const isValidConnection = useCallback(
    params => {
      if (!params?.source || !params?.sourceHandle) return false;
      const duplicate = edges.some(
        e =>
          e.source === params.source && e.sourceHandle === params.sourceHandle
      );
      return !duplicate;
    },
    [edges]
  );

  const onConnect = useCallback(
    params => {
      if (readonly) return;
      setDirty(true);
      const label = params.sourceHandle || "";

      setEdges(eds =>
        addEdge(
          {
            ...params,
            id: uuidv4(),
            type: "smart",
            animated: true,
            style: { stroke: "#9333ea" },
            markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
            label,
          },
          eds
        )
      );

      setNodes(nds =>
        nds.map(node => {
          if (node.id !== params.source) return node;
          const sourceHandle = params.sourceHandle || "";
          const updatedButtons = [...(node.data.buttons || [])];

          const idx = updatedButtons.findIndex(
            b =>
              (b.text || "").toLowerCase().trim() ===
              sourceHandle.toLowerCase().trim()
          );

          if (idx >= 0) {
            updatedButtons[idx] = {
              ...updatedButtons[idx],
              targetNodeId: params.target,
            };
          } else {
            const free = updatedButtons.findIndex(b => !b.targetNodeId);
            if (free >= 0)
              updatedButtons[free] = {
                ...updatedButtons[free],
                targetNodeId: params.target,
              };
          }

          return { ...node, data: { ...node.data, buttons: updatedButtons } };
        })
      );
    },
    [readonly, setEdges, setNodes]
  );

  // --- Keyboard UX
  useEffect(() => {
    const onKey = e => {
      if (readonly) return;
      if (e.key === "Delete" || e.key === "Backspace") {
        setDirty(true);
        setNodes(nds => nds.filter(n => !n.selected));
        setEdges(eds => eds.filter(ed => !ed.selected));
      }
      if (e.key === "Escape") {
        setNodes(nds => nds.map(n => ({ ...n, selected: false })));
        setEdges(eds => eds.map(ed => ({ ...ed, selected: false })));
      }
    };
    window.addEventListener("keydown", onKey);
    return () => window.removeEventListener("keydown", onKey);
  }, [readonly, setNodes, setEdges]);

  // --- Auto layout (dagre)
  const applyLayout = useCallback(
    (direction = "LR") => {
      const g = new dagre.graphlib.Graph();
      g.setGraph({
        rankdir: direction,
        nodesep: 50,
        ranksep: 90,
        marginx: 20,
        marginy: 20,
      });
      g.setDefaultEdgeLabel(() => ({}));

      nodes.forEach(n => {
        const width = n?.measured?.width || NODE_DEFAULT.width;
        const height = n?.measured?.height || NODE_DEFAULT.height;
        g.setNode(n.id, { width, height });
      });
      edges.forEach(e => g.setEdge(e.source, e.target));

      dagre.layout(g);

      const laidOut = nodes.map(n => {
        const { x, y } = g.node(n.id);
        const width = n?.measured?.width || NODE_DEFAULT.width;
        const height = n?.measured?.height || NODE_DEFAULT.height;
        return { ...n, position: { x: x - width / 2, y: y - height / 2 } };
      });

      setDirty(true);
      setNodes(laidOut);
      setTimeout(() => fitView({ padding: 0.25 }), 50);
    },
    [nodes, edges, setNodes, fitView]
  );

  // --- Build payload (draft by default; publish is separate)
  const buildPayload = () => {
    const transformedNodes = nodes
      .filter(n => n?.data?.templateName)
      .map(node => ({
        Id: node.id,
        TemplateName: node.data.templateName || "Untitled",
        TemplateType: node.data.templateType || "text_template",
        MessageBody: node.data.messageBody || "",
        PositionX: node.position?.x || 0,
        PositionY: node.position?.y || 0,
        TriggerButtonText: node.data.triggerButtonText || "",
        TriggerButtonType: node.data.triggerButtonType || "cta",
        RequiredTag: node.data.requiredTag || "",
        RequiredSource: node.data.requiredSource || "",
        UseProfileName: !!node.data.useProfileName,
        ProfileNameSlot:
          typeof node.data.profileNameSlot === "number" &&
          node.data.profileNameSlot > 0
            ? node.data.profileNameSlot
            : 1,
        Buttons: (node.data.buttons || [])
          .filter(btn => (btn.text || "").trim().length > 0)
          .map((btn, idx) => ({
            Text: (btn.text || "").trim(),
            Type: btn.type || "QUICK_REPLY",
            SubType: btn.subType || "",
            Value: btn.value || "",
            TargetNodeId: btn.targetNodeId || null,
            Index: typeof btn.index === "number" ? btn.index : idx,
          })),
      }));

    const transformedEdges = edges.map(edge => ({
      FromNodeId: edge.source,
      ToNodeId: edge.target,
      SourceHandle: edge.sourceHandle || "",
    }));

    return {
      FlowName: flowName || "Untitled",
      IsPublished: false, // always draft; publish is explicit
      Nodes: transformedNodes,
      Edges: transformedEdges,
    };
  };

  // --- Save Draft
  const handleSaveDraft = async () => {
    try {
      setSaving(true);
      const payload = buildPayload();

      if (mode === "edit" && flowId) {
        const res = await updateVisualFlow(flowId, payload);
        if (res?.needsRepublish) setRepublishNeeded(true);
        toast.success("‚úÖ Flow updated (draft)");
      } else {
        const res = await saveVisualFlow(payload); // create new draft
        if (res?.flowId) {
          navigate(`/app/cta-flow/flow-manager?tab=draft`);
          return;
        }
        toast.success("‚úÖ Flow saved (draft)");
      }
      setDirty(false);
      navigate(`/app/cta-flow/flow-manager?tab=draft`);
    } catch (error) {
      console.error("‚ùå Save draft failed: ", error);
      if (error?.response?.status === 409) {
        const camps = error?.response?.data?.campaigns || [];
        setLockInfo({ locked: true, campaigns: camps });
        setForkModalOpen(true);
        setReadonly(true);
      } else {
        toast.error("‚ùå Failed to save draft");
      }
    } finally {
      setSaving(false);
    }
  };

  // --- Publish / Republish
  const handlePublish = async () => {
    try {
      setSaving(true);

      if (mode === "edit" && flowId) {
        const payload = buildPayload();
        await updateVisualFlow(flowId, payload);
        await publishFlow(flowId);
        setRepublishNeeded(false);
        setIsPublished(true);
        setDirty(false);
        toast.success("‚úÖ Flow published");
        navigate("/app/cta-flow/flow-manager?tab=published");
        return;
      }

      // NEW flow: create as draft, get id, then publish that id
      const createPayload = { ...buildPayload(), IsPublished: false };
      const res = await saveVisualFlow(createPayload);
      const newId = res?.flowId;

      if (newId) {
        await publishFlow(newId);
        toast.success("‚úÖ Flow created & published");
        navigate("/app/cta-flow/flow-manager?tab=published");
        return;
      }

      toast.success("‚úÖ Flow created (but publish step uncertain)");
      navigate("/app/cta-flow/flow-manager?tab=published");
    } catch (error) {
      console.error("‚ùå Publish failed: ", error);
      if (error?.response?.status === 409) {
        const camps = error?.response?.data?.campaigns || [];
        setLockInfo({ locked: true, campaigns: camps });
        setForkModalOpen(true);
        setReadonly(true);
      } else {
        toast.error("‚ùå Failed to publish");
      }
    } finally {
      setSaving(false);
    }
  };

  const defaultEdgeOptions = useMemo(
    () => ({
      type: "smart",
      animated: true,
      style: { stroke: "#9333ea" },
      markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
    }),
    []
  );

  return (
    <div className="p-6 relative">
      {/* Page-level spinner overlay */}
      {(loading || saving) && (
        <div className="absolute inset-0 z-[60] bg-white/70 backdrop-blur-[1px] grid place-items-center">
          <div className="flex items-center gap-3 px-4 py-2 bg-white rounded-xl shadow border">
            <svg
              className="animate-spin h-5 w-5 text-purple-600"
              viewBox="0 0 24 24"
            >
              <circle
                className="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                strokeWidth="4"
                fill="none"
              />
              <path
                className="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
              />
            </svg>
            <span className="text-sm text-gray-700">
              {loading ? "Loading..." : "Working..."}
            </span>
          </div>
        </div>
      )}

      {/* ===== Header: title on left, ALL actions to top-right ===== */}
      <div className="flex flex-wrap items-center justify-between gap-3 mb-4">
        {/* Left: Title + Name */}
        <div className="flex items-center gap-3 min-w-0">
          <h2 className="text-xl sm:text-2xl font-bold text-gray-900 tracking-tight">
            üß† CTA Flow Visual Builder
          </h2>

          {/* Flow name input / badge inline with title */}
          {readonly ? (
            <span className="truncate max-w-[40ch] px-2 py-1 rounded-md bg-purple-50 text-purple-700 text-sm font-medium">
              {flowName || "Untitled Flow"}
            </span>
          ) : (
            <input
              id="flowName"
              name="flowName"
              ref={flowNameRef}
              value={flowName}
              onChange={e => {
                setFlowName(e.target.value);
                setDirty(true);
              }}
              placeholder="Add flow name"
              className="truncate max-w-[40ch] border border-gray-300 px-3 py-1.5 rounded-md shadow-sm text-sm focus:outline-none focus:ring-2 focus:ring-purple-500/50"
            />
          )}
        </div>

        {/* Right: Toolbar */}
        <div className="flex flex-wrap items-center gap-2">
          {/* Back / Manage ‚Äî keep both as small, neutral actions */}
          <button
            onClick={goBackToManager}
            className="px-3 py-2 rounded-md text-sm border border-gray-300 text-gray-700 bg-white hover:bg-gray-50"
            title={`Back to ${
              backTab === "published" ? "Published" : "Drafts"
            }`}
            disabled={saving}
          >
            ‚Üê Back to {backTab === "published" ? "Published" : "Drafts"}
          </button>

          <button
            onClick={() =>
              navigate(`/app/cta-flow/flow-manager?tab=${backTab}`)
            }
            className="px-3 py-2 rounded-md text-sm border border-gray-300 text-gray-700 bg-white hover:bg-gray-50"
            title="Manage all flows"
            disabled={saving}
          >
            ‚ñ§ Manage Flows
          </button>

          {/* Primary actions (hidden in readonly) */}
          {!readonly && (
            <>
              <button
                onClick={() => setShowPicker(true)}
                className="px-3 py-2 rounded-md text-sm bg-purple-600 text-white shadow hover:bg-purple-700"
                disabled={saving}
              >
                ‚ûï Add Step
              </button>

              <button
                onClick={handleSaveDraft}
                className="px-3 py-2 rounded-md text-sm bg-gray-800 text-white hover:bg-gray-900 disabled:opacity-50"
                disabled={saving}
              >
                üíæ Save Draft
              </button>

              <button
                onClick={handlePublish}
                className="px-3 py-2 rounded-md text-sm bg-green-600 text-white hover:bg-green-700 disabled:opacity-50"
                disabled={saving}
              >
                üöÄ {isPublished ? "Republish" : "Publish"}
              </button>
            </>
          )}
        </div>
      </div>
      {/* üîß CHANGED: removed ‚Äú‚ûï Add New Flow‚Äù from header; all buttons are now on the right */}

      {/* Republish banner (kept for clarity) */}
      {!readonly && mode === "edit" && republishNeeded && (
        <div className="mb-3 rounded-md border bg-amber-50 text-amber-800 px-3 py-2 text-sm flex items-center justify-between">
          <div>
            Changes saved as <span className="font-semibold">draft</span>. Click{" "}
            <span className="font-semibold">Republish</span> to make them live.
          </div>
          <button
            onClick={handlePublish}
            className="px-3 py-1 rounded bg-amber-600 text-white hover:bg-amber-700 text-xs"
            disabled={saving}
          >
            Republish
          </button>
        </div>
      )}

      {/* Canvas */}
      <div className="h-[70vh] border rounded-xl bg-gray-50 relative">
        {/* Minimap + tools */}
        <div className="absolute bottom-5 right-4 z-50 flex gap-2">
          <button
            onClick={() => setShowMiniMap(prev => !prev)}
            className="bg-purple-600 text-white p-2 rounded-full shadow hover:bg-purple-700"
            title={showMiniMap ? "Hide MiniMap" : "Show MiniMap"}
          >
            {showMiniMap ? <Minus size={15} /> : <Eye size={15} />}
          </button>

          <div className="flex items-center gap-2 bg-white/90 px-2 py-1 rounded-full border">
            <button
              onClick={() => fitView({ padding: 0.25 })}
              className="text-xs px-2 py-1 rounded hover:bg-gray-100 font-medium"
              title="Fit to screen"
            >
              Fit
            </button>
            <button
              onClick={() => zoomIn()}
              className="text-xs px-2 py-1 rounded hover:bg-gray-100"
              title="Zoom In"
            >
              +
            </button>
            <button
              onClick={() => zoomOut()}
              className="text-xs px-2 py-1 rounded hover:bg-gray-100"
              title="Zoom Out"
            >
              ‚àí
            </button>

            {!readonly && (
              <>
                <button
                  onClick={() => applyLayout("LR")}
                  className="text-xs px-2 py-1 rounded hover:bg-gray-100"
                  title="Auto-layout (Left‚ÜíRight)"
                >
                  Auto TB
                </button>
                <button
                  onClick={() => applyLayout("TB")}
                  className="text-xs px-2 py-1 rounded hover:bg-gray-100"
                  title="Auto-layout (Top‚ÜíBottom)"
                >
                  Auto LR
                </button>
              </>
            )}
          </div>
        </div>

        <ReactFlow
          nodes={nodes}
          edges={edges}
          onNodesChange={onNodesChange}
          onEdgesChange={onEdgesChange}
          onConnect={onConnect}
          onEdgeClick={(e, edge) => {
            if (!readonly) {
              setDirty(true);
              setEdges(eds => eds.filter(ed => ed.id !== edge.id));
            }
          }}
          nodeTypes={nodeTypes}
          edgeTypes={edgeTypes}
          fitView
          fitViewOptions={{ padding: 0.25 }}
          defaultEdgeOptions={defaultEdgeOptions}
          connectionMode={ConnectionMode.Strict}
          isValidConnection={isValidConnection}
          snapToGrid
          snapGrid={[GRID, GRID]}
          panOnScroll
          zoomOnPinch
          panOnDrag={[1, 2]}
          selectionOnDrag
          nodesDraggable={!readonly}
          nodesConnectable={!readonly}
          elementsSelectable={!readonly}
        >
          {showMiniMap && (
            <MiniMap
              nodeColor="#9333ea"
              nodeStrokeWidth={2}
              maskColor="rgba(255,255,255,0.6)"
            />
          )}
          <Controls />
          <Background variant="dots" gap={GRID} size={1} />
        </ReactFlow>
      </div>

      {/* üîß CHANGED: Footer actions removed (buttons now live in header) */}

      {/* Fork modal: when published & attached */}
      {forkModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          <div
            className="absolute inset-0 bg-black/40"
            onClick={() => setForkModalOpen(false)}
          />
          <div
            role="dialog"
            aria-modal="true"
            className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
          >
            <div className="flex items-start gap-3 mb-4">
              <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
                ‚ö†Ô∏è
              </div>
              <div>
                <h3 className="text-lg font-semibold text-gray-900">
                  Editing is blocked for this flow
                </h3>
                <p className="text-sm text-gray-600">
                  This flow is <span className="font-medium">published</span>{" "}
                  and attached to active campaign(s). To make changes, create a{" "}
                  <span className="font-medium">new draft version</span>.
                </p>
              </div>
            </div>

            <div className="max-h-60 overflow-auto rounded-lg border divide-y mb-4">
              {lockInfo.campaigns.map(c => (
                <div key={c.id} className="p-3 text-sm">
                  <div className="flex items-center justify-between">
                    <div className="font-semibold text-gray-900">{c.name}</div>
                    <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-700">
                      {c.status || "‚Äî"}
                    </span>
                  </div>
                  <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
                    <div>
                      Created:{" "}
                      <span className="font-medium text-gray-800">
                        {c.createdAt
                          ? new Date(c.createdAt).toLocaleString("en-IN")
                          : "‚Äî"}
                      </span>
                    </div>
                    <div>
                      Created by:{" "}
                      <span className="font-medium text-gray-800">
                        {c.createdBy || "‚Äî"}
                      </span>
                    </div>
                    <div>
                      Scheduled:{" "}
                      <span className="font-medium text-gray-800">
                        {c.scheduledAt
                          ? new Date(c.scheduledAt).toLocaleString("en-IN")
                          : "‚Äî"}
                      </span>
                    </div>
                    <div>
                      First sent:{" "}
                      <span className="font-medium text-gray-800">
                        {c.firstSentAt
                          ? new Date(c.firstSentAt).toLocaleString("en-IN")
                          : "‚Äî"}
                      </span>
                    </div>
                  </div>
                </div>
              ))}
              {lockInfo.campaigns.length === 0 && (
                <div className="p-3 text-sm text-gray-600">
                  Could not load campaign details. You can still create a new
                  draft version.
                </div>
              )}
            </div>

            <div className="flex justify-end gap-2">
              <button
                className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
                onClick={() => setForkModalOpen(false)}
              >
                Close
              </button>
              <button
                onClick={async () => {
                  try {
                    if (!flowId) return;
                    const { flowId: newId } = await forkFlow(flowId);
                    setForkModalOpen(false);
                    toast.success("‚úÖ New draft version created");
                    navigate(
                      `/app/cta-flow/visual-builder?id=${newId}&mode=edit`
                    );
                  } catch (e) {
                    console.error(e);
                    toast.error("‚ùå Failed to create draft copy");
                  }
                }}
                className="px-3 py-2 text-sm rounded bg-purple-600 text-white hover:bg-purple-700"
              >
                Create new draft version
              </button>
            </div>
          </div>
        </div>
      )}

      <TemplatePickerModal
        open={showPicker}
        onClose={() => setShowPicker(false)}
        onSelect={handleTemplateSelect}
      />
    </div>
  );
}

export default function CTAFlowVisualBuilder() {
  return (
    <ReactFlowProvider>
      <CTAFlowVisualBuilderInner />
    </ReactFlowProvider>
  );
}

// // src/pages/CTAFlowVisualBuilder/CTAFlowVisualBuilder.jsx
// import React, {
//   useCallback,
//   useState,
//   useEffect,
//   useMemo,
//   useRef,
// } from "react";
// import {
//   ReactFlow,
//   ReactFlowProvider,
//   Background,
//   Controls,
//   MiniMap,
//   useNodesState,
//   useEdgesState,
//   addEdge,
//   MarkerType,
//   ConnectionMode,
//   useReactFlow,
// } from "@xyflow/react";
// import "@xyflow/react/dist/style.css";
// import { Eye, Minus } from "lucide-react";
// import { useSearchParams, useNavigate } from "react-router-dom";
// import TemplatePickerModal from "./components/TemplatePickerModal";
// import FlowNodeBubble from "./components/FlowNodeBubble";
// import {
//   saveVisualFlow,
//   getVisualFlowById,
//   updateVisualFlow,
//   publishFlow,
//   forkFlow,
//   getFlowUsage,
// } from "./ctaFlowVisualApi";
// import { v4 as uuidv4 } from "uuid";
// import { toast } from "react-toastify";
// import dagre from "dagre";
// import SmartLabeledEdge from "./components/edges/SmartLabeledEdge";

// const GRID = 16;
// const NODE_DEFAULT = { width: 260, height: 140 };

// function CTAFlowVisualBuilderInner() {
//   const [nodes, setNodes, onNodesChange] = useNodesState([]);
//   const [edges, setEdges, onEdgesChange] = useEdgesState([]);
//   const nodesRef = useRef([]);
//   const [showPicker, setShowPicker] = useState(false);
//   const [flowName, setFlowName] = useState("");
//   const flowNameRef = useRef(null);
//   const [showMiniMap, setShowMiniMap] = useState(false);
//   const [readonly, setReadonly] = useState(false);

//   // policy state
//   const [isPublished, setIsPublished] = useState(false);
//   const [republishNeeded, setRepublishNeeded] = useState(false);
//   const [lockInfo, setLockInfo] = useState({ locked: false, campaigns: [] });
//   const [forkModalOpen, setForkModalOpen] = useState(false);

//   // async state
//   const [saving, setSaving] = useState(false);
//   const [loading, setLoading] = useState(false);

//   const [dirty, setDirty] = useState(false);

//   const [searchParams] = useSearchParams();
//   const navigate = useNavigate();
//   const { fitView, zoomIn, zoomOut } = useReactFlow();

//   const mode = searchParams.get("mode"); // 'edit' | 'view' | null
//   const flowId = searchParams.get("id");
//   const visualDebug = true;

//   // figure out source tab for Back button
//   const fromTab = (searchParams.get("from") || "draft").toLowerCase();
//   const backTab = fromTab === "published" ? "published" : "draft";

//   const goBackToManager = useCallback(() => {
//     if (!readonly && dirty) {
//       const ok = window.confirm("You have unsaved changes. Leave this page?");
//       if (!ok) return;
//     }
//     navigate(`/app/cta-flow/flow-manager?tab=${backTab}`);
//   }, [readonly, dirty, backTab, navigate]);

//   useEffect(() => {
//     nodesRef.current = [...nodes];
//   }, [nodes]);

//   // warn on unload if dirty
//   useEffect(() => {
//     const onBeforeUnload = e => {
//       if (!dirty) return;
//       e.preventDefault();
//       e.returnValue = "";
//     };
//     window.addEventListener("beforeunload", onBeforeUnload);
//     return () => window.removeEventListener("beforeunload", onBeforeUnload);
//   }, [dirty]);

//   // --- Node helpers
//   const handleDeleteNode = useCallback(
//     nodeId => {
//       if (readonly) return;
//       setDirty(true);
//       setNodes(nds => nds.filter(n => n.id !== nodeId));
//       setEdges(eds =>
//         eds.filter(e => e.source !== nodeId && e.target !== nodeId)
//       );
//     },
//     [readonly, setNodes, setEdges]
//   );

//   const handleNodeDataChange = useCallback(
//     (nodeId, newData) => {
//       setDirty(true);
//       setNodes(nds =>
//         nds.map(n =>
//           n.id === nodeId ? { ...n, data: { ...n.data, ...newData } } : n
//         )
//       );
//     },
//     [setNodes]
//   );

//   const nodeTypes = useMemo(
//     () => ({
//       customBubble: props => (
//         <FlowNodeBubble
//           {...props}
//           onDelete={handleDeleteNode}
//           onDataChange={newData => handleNodeDataChange(props.id, newData)}
//           readonly={readonly}
//           visualDebug={visualDebug}
//         />
//       ),
//     }),
//     [handleDeleteNode, readonly, visualDebug, handleNodeDataChange]
//   );

//   const edgeTypes = useMemo(() => ({ smart: SmartLabeledEdge }), []);

//   // --- Load / Bootstrap + policy checks
//   useEffect(() => {
//     const load = async () => {
//       setLoading(true);
//       if (mode === "edit" || mode === "view") {
//         try {
//           const data = await getVisualFlowById(flowId);

//           const builtNodes = (data.nodes || []).map((node, index) => ({
//             id: node.id,
//             type: "customBubble",
//             position: {
//               x: node.positionX ?? 120 + index * 120,
//               y: node.positionY ?? 150 + (index % 5) * 60,
//             },
//             data: {
//               templateName: node.templateName,
//               templateType: node.templateType,
//               messageBody: node.messageBody,
//               triggerButtonText: node.triggerButtonText || "",
//               triggerButtonType: node.triggerButtonType || "cta",
//               requiredTag: node.requiredTag || "",
//               requiredSource: node.requiredSource || "",
//               useProfileName: !!node.useProfileName,
//               profileNameSlot:
//                 typeof node.profileNameSlot === "number" &&
//                 node.profileNameSlot > 0
//                   ? node.profileNameSlot
//                   : 1,
//               buttons: (node.buttons || []).map((btn, i) => ({
//                 text: btn.text,
//                 type: btn.type,
//                 subType: btn.subType,
//                 value: btn.value,
//                 targetNodeId: btn.targetNodeId || null,
//                 index: typeof btn.index === "number" ? btn.index : i,
//               })),
//             },
//           }));

//           const builtEdges = (data.edges || []).map(edge => ({
//             id: `e-${edge.fromNodeId}-${edge.toNodeId}-${
//               edge.sourceHandle || "h"
//             }`,
//             source: edge.fromNodeId,
//             target: edge.toNodeId,
//             sourceHandle: edge.sourceHandle || null,
//             type: "smart",
//             animated: true,
//             style: { stroke: "#9333ea" },
//             markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
//             label: edge.sourceHandle || "",
//           }));

//           const nodesWithIncoming = new Set(builtEdges.map(e => e.target));
//           const nodesWithWarnings = builtNodes.map(node => ({
//             ...node,
//             data: {
//               ...node.data,
//               isUnreachable: false,
//               hasNoIncoming: !nodesWithIncoming.has(node.id),
//             },
//           }));

//           setNodes(nodesWithWarnings);
//           setEdges(builtEdges);
//           setFlowName(data.flowName || "Untitled Flow");
//           setIsPublished(!!data.isPublished);
//           setDirty(false);

//           // policy: if editing a published flow, check attachment
//           if (mode === "edit" && data.isPublished) {
//             try {
//               const usage = await getFlowUsage(flowId);
//               if (usage?.campaigns?.length > 0) {
//                 setLockInfo({ locked: true, campaigns: usage.campaigns });
//                 setForkModalOpen(true);
//                 setReadonly(true);
//               } else {
//                 setReadonly(false);
//               }
//             } catch {
//               setLockInfo({ locked: true, campaigns: [] });
//               setForkModalOpen(true);
//               setReadonly(true);
//             }
//           } else {
//             setReadonly(mode === "view");
//           }

//           // initial fit
//           setTimeout(() => fitView({ padding: 0.25 }), 80);
//         } catch {
//           toast.error("‚ùå Failed to load flow");
//         } finally {
//           setLoading(false);
//         }
//       } else {
//         // creating new flow
//         setNodes([]);
//         setEdges([]);
//         setFlowName("Untitled Flow");
//         setIsPublished(false);
//         setReadonly(false);
//         setDirty(false);
//         setLoading(false);
//         setTimeout(() => fitView({ padding: 0.25 }), 80);
//       }
//     };

//     load();
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, [flowId, mode]);

//   // Auto-fit when viewing, and refit on window resize
//   useEffect(() => {
//     if (mode !== "view") return;
//     const t = setTimeout(() => fitView({ padding: 0.25 }), 80);
//     const onResize = () => fitView({ padding: 0.25 });
//     window.addEventListener("resize", onResize);
//     return () => {
//       clearTimeout(t);
//       window.removeEventListener("resize", onResize);
//     };
//   }, [mode, nodes.length, edges.length, fitView]);

//   // --- Add template
//   const handleTemplateSelect = ({ name, type, body, buttons = [] }) => {
//     if (readonly) return;
//     const id = uuidv4();
//     const newNode = {
//       id,
//       position: { x: Math.random() * 400 + 100, y: Math.random() * 300 + 100 },
//       type: "customBubble",
//       data: {
//         templateName: name || "Untitled",
//         templateType: type || "text_template",
//         messageBody: body || "Message body preview...",
//         triggerButtonText: buttons[0]?.text || "",
//         triggerButtonType: "cta",
//         useProfileName: false,
//         profileNameSlot: 1,
//         buttons: buttons.map((btn, idx) => ({
//           text: btn.text || "",
//           type: btn.type || "QUICK_REPLY",
//           subType: btn.subType || "",
//           value: btn.parameterValue || "",
//           targetNodeId: null,
//           index: idx,
//         })),
//       },
//     };
//     setDirty(true);
//     setNodes(nds => [...nds, newNode]);
//     setShowPicker(false);
//     toast.success(
//       `‚úÖ Step added with ${type?.replace("_", " ") || "template"}`
//     );
//     setTimeout(() => fitView({ padding: 0.25 }), 50);
//   };

//   // --- Connection rules
//   const isValidConnection = useCallback(
//     params => {
//       if (!params?.source || !params?.sourceHandle) return false;
//       const duplicate = edges.some(
//         e =>
//           e.source === params.source && e.sourceHandle === params.sourceHandle
//       );
//       return !duplicate;
//     },
//     [edges]
//   );

//   const onConnect = useCallback(
//     params => {
//       if (readonly) return;
//       setDirty(true);
//       const label = params.sourceHandle || "";

//       setEdges(eds =>
//         addEdge(
//           {
//             ...params,
//             id: uuidv4(),
//             type: "smart",
//             animated: true,
//             style: { stroke: "#9333ea" },
//             markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
//             label,
//           },
//           eds
//         )
//       );

//       setNodes(nds =>
//         nds.map(node => {
//           if (node.id !== params.source) return node;
//           const sourceHandle = params.sourceHandle || "";
//           const updatedButtons = [...(node.data.buttons || [])];

//           const idx = updatedButtons.findIndex(
//             b =>
//               (b.text || "").toLowerCase().trim() ===
//               sourceHandle.toLowerCase().trim()
//           );

//           if (idx >= 0) {
//             updatedButtons[idx] = {
//               ...updatedButtons[idx],
//               targetNodeId: params.target,
//             };
//           } else {
//             const free = updatedButtons.findIndex(b => !b.targetNodeId);
//             if (free >= 0)
//               updatedButtons[free] = {
//                 ...updatedButtons[free],
//                 targetNodeId: params.target,
//               };
//           }

//           return { ...node, data: { ...node.data, buttons: updatedButtons } };
//         })
//       );
//     },
//     [readonly, setEdges, setNodes]
//   );

//   // --- Keyboard UX
//   useEffect(() => {
//     const onKey = e => {
//       if (readonly) return;
//       if (e.key === "Delete" || e.key === "Backspace") {
//         setDirty(true);
//         setNodes(nds => nds.filter(n => !n.selected));
//         setEdges(eds => eds.filter(ed => !ed.selected));
//       }
//       if (e.key === "Escape") {
//         setNodes(nds => nds.map(n => ({ ...n, selected: false })));
//         setEdges(eds => eds.map(ed => ({ ...ed, selected: false })));
//       }
//     };
//     window.addEventListener("keydown", onKey);
//     return () => window.removeEventListener("keydown", onKey);
//   }, [readonly, setNodes, setEdges]);

//   // --- Auto layout (dagre)
//   const applyLayout = useCallback(
//     (direction = "LR") => {
//       const g = new dagre.graphlib.Graph();
//       g.setGraph({
//         rankdir: direction,
//         nodesep: 50,
//         ranksep: 90,
//         marginx: 20,
//         marginy: 20,
//       });
//       g.setDefaultEdgeLabel(() => ({}));

//       nodes.forEach(n => {
//         const width = n?.measured?.width || NODE_DEFAULT.width;
//         const height = n?.measured?.height || NODE_DEFAULT.height;
//         g.setNode(n.id, { width, height });
//       });
//       edges.forEach(e => g.setEdge(e.source, e.target));

//       dagre.layout(g);

//       const laidOut = nodes.map(n => {
//         const { x, y } = g.node(n.id);
//         const width = n?.measured?.width || NODE_DEFAULT.width;
//         const height = n?.measured?.height || NODE_DEFAULT.height;
//         return { ...n, position: { x: x - width / 2, y: y - height / 2 } };
//       });

//       setDirty(true);
//       setNodes(laidOut);
//       setTimeout(() => fitView({ padding: 0.25 }), 50);
//     },
//     [nodes, edges, setNodes, fitView]
//   );

//   // --- Build payload (draft by default; publish is separate)
//   const buildPayload = () => {
//     const transformedNodes = nodes
//       .filter(n => n?.data?.templateName)
//       .map(node => ({
//         Id: node.id,
//         TemplateName: node.data.templateName || "Untitled",
//         TemplateType: node.data.templateType || "text_template",
//         MessageBody: node.data.messageBody || "",
//         PositionX: node.position?.x || 0,
//         PositionY: node.position?.y || 0,
//         TriggerButtonText: node.data.triggerButtonText || "",
//         TriggerButtonType: node.data.triggerButtonType || "cta",
//         RequiredTag: node.data.requiredTag || "",
//         RequiredSource: node.data.requiredSource || "",
//         UseProfileName: !!node.data.useProfileName,
//         ProfileNameSlot:
//           typeof node.data.profileNameSlot === "number" &&
//           node.data.profileNameSlot > 0
//             ? node.data.profileNameSlot
//             : 1,
//         Buttons: (node.data.buttons || [])
//           .filter(btn => (btn.text || "").trim().length > 0)
//           .map((btn, idx) => ({
//             Text: (btn.text || "").trim(),
//             Type: btn.type || "QUICK_REPLY",
//             SubType: btn.subType || "",
//             Value: btn.value || "",
//             TargetNodeId: btn.targetNodeId || null,
//             Index: typeof btn.index === "number" ? btn.index : idx,
//           })),
//       }));

//     const transformedEdges = edges.map(edge => ({
//       FromNodeId: edge.source,
//       ToNodeId: edge.target,
//       SourceHandle: edge.sourceHandle || "",
//     }));

//     return {
//       FlowName: flowName || "Untitled",
//       IsPublished: false, // always draft; publish is explicit
//       Nodes: transformedNodes,
//       Edges: transformedEdges,
//     };
//   };

//   // --- Save Draft (then go to Drafts tab)
//   const handleSaveDraft = async () => {
//     try {
//       setSaving(true);
//       const payload = buildPayload();

//       if (mode === "edit" && flowId) {
//         const res = await updateVisualFlow(flowId, payload);
//         if (res?.needsRepublish) setRepublishNeeded(true);
//         toast.success("‚úÖ Flow updated (draft)");
//       } else {
//         const res = await saveVisualFlow(payload); // create new draft
//         if (res?.flowId) {
//           // move the user to manager drafts list
//           navigate(`/app/cta-flow/flow-manager?tab=draft`);
//           return; // stop further state updates in this screen
//         }
//         toast.success("‚úÖ Flow saved (draft)");
//       }
//       setDirty(false);
//       navigate(`/app/cta-flow/flow-manager?tab=draft`);
//     } catch (error) {
//       console.error("‚ùå Save draft failed: ", error);
//       if (error?.response?.status === 409) {
//         const camps = error?.response?.data?.campaigns || [];
//         setLockInfo({ locked: true, campaigns: camps });
//         setForkModalOpen(true);
//         setReadonly(true);
//       } else {
//         toast.error("‚ùå Failed to save draft");
//       }
//     } finally {
//       setSaving(false);
//     }
//   };

//   // --- Publish / Republish (on new ‚Üí create then publish) then go to Published tab
//   const handlePublish = async () => {
//     try {
//       setSaving(true);

//       if (mode === "edit" && flowId) {
//         const payload = buildPayload();
//         await updateVisualFlow(flowId, payload);
//         await publishFlow(flowId);
//         setRepublishNeeded(false);
//         setIsPublished(true);
//         setDirty(false);
//         toast.success("‚úÖ Flow published");
//         navigate("/app/cta-flow/flow-manager?tab=published");
//         return;
//       }

//       // NEW flow: create as draft, get id, then publish that id
//       const createPayload = { ...buildPayload(), IsPublished: false };
//       const res = await saveVisualFlow(createPayload);
//       const newId = res?.flowId;

//       if (newId) {
//         await publishFlow(newId);
//         toast.success("‚úÖ Flow created & published");
//         navigate("/app/cta-flow/flow-manager?tab=published");
//         return;
//       }

//       // fallback
//       toast.success("‚úÖ Flow created (but publish step uncertain)");
//       navigate("/app/cta-flow/flow-manager?tab=published");
//     } catch (error) {
//       console.error("‚ùå Publish failed: ", error);
//       if (error?.response?.status === 409) {
//         const camps = error?.response?.data?.campaigns || [];
//         setLockInfo({ locked: true, campaigns: camps });
//         setForkModalOpen(true);
//         setReadonly(true);
//       } else {
//         toast.error("‚ùå Failed to publish");
//       }
//     } finally {
//       setSaving(false);
//     }
//   };

//   const defaultEdgeOptions = useMemo(
//     () => ({
//       type: "smart",
//       animated: true,
//       style: { stroke: "#9333ea" },
//       markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
//     }),
//     []
//   );

//   return (
//     <div className="p-6 relative">
//       {/* Page-level spinner overlay */}
//       {(loading || saving) && (
//         <div className="absolute inset-0 z-[60] bg-white/70 backdrop-blur-[1px] grid place-items-center">
//           <div className="flex items-center gap-3 px-4 py-2 bg-white rounded-xl shadow border">
//             <svg
//               className="animate-spin h-5 w-5 text-purple-600"
//               viewBox="0 0 24 24"
//             >
//               <circle
//                 className="opacity-25"
//                 cx="12"
//                 cy="12"
//                 r="10"
//                 stroke="currentColor"
//                 strokeWidth="4"
//                 fill="none"
//               />
//               <path
//                 className="opacity-75"
//                 fill="currentColor"
//                 d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
//               />
//             </svg>
//             <span className="text-sm text-gray-700">
//               {loading ? "Loading..." : "Working..."}
//             </span>
//           </div>
//         </div>
//       )}

//       {/* Header */}
//       <div className="flex flex-wrap items-center justify-between gap-3 mb-4">
//         <div className="flex items-center gap-2">
//           <button
//             onClick={goBackToManager}
//             className="bg-white border border-gray-300 text-gray-700 px-3 py-2 rounded-md shadow-sm hover:bg-gray-50 text-sm"
//             title={`Back to ${
//               backTab === "published" ? "Published" : "Drafts"
//             }`}
//           >
//             ‚Üê Back to {backTab === "published" ? "Published" : "Drafts"}
//           </button>

//           <h2 className="text-2xl font-bold text-purple-700 ml-1">
//             üß† CTA Flow Visual Builder
//           </h2>
//         </div>

//         <div className="flex items-center gap-2">
//           {readonly ? (
//             <div className="px-3 py-2 rounded-md bg-purple-50 text-purple-700 text-sm font-medium">
//               {flowName || "Untitled Flow"}
//             </div>
//           ) : (
//             <input
//               id="flowName"
//               name="flowName"
//               ref={flowNameRef}
//               value={flowName}
//               onChange={e => {
//                 setFlowName(e.target.value);
//                 setDirty(true);
//               }}
//               placeholder="Add flow name"
//               className="border border-gray-300 px-3 py-2 rounded-md shadow-sm text-sm"
//             />
//           )}

//           {/* Always available */}
//           <button
//             onClick={() => navigate(`/app/cta-flow/visual-builder`)}
//             className="bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700 text-sm"
//             title="Create a new flow"
//             disabled={saving}
//           >
//             ‚ûï Add New Flow
//           </button>

//           {!readonly && (
//             <>
//               <button
//                 onClick={() => setShowPicker(true)}
//                 className="bg-purple-600 text-white px-4 py-2 rounded shadow hover:bg-purple-700 text-sm"
//                 disabled={saving}
//               >
//                 ‚ûï Add Step
//               </button>
//               <button
//                 onClick={goBackToManager}
//                 className="bg-white border border-purple-600 text-purple-700 font-medium text-sm px-4 py-2 rounded-md shadow-sm hover:bg-purple-50"
//                 disabled={saving}
//               >
//                 ‚Ü©Ô∏è Manage All Flows
//               </button>
//             </>
//           )}
//         </div>
//       </div>

//       {/* Republish banner */}
//       {!readonly && mode === "edit" && republishNeeded && (
//         <div className="mb-3 rounded-md border bg-amber-50 text-amber-800 px-3 py-2 text-sm flex items-center justify-between">
//           <div>
//             Changes saved as <span className="font-semibold">draft</span>. Click{" "}
//             <span className="font-semibold">Republish</span> to make them live.
//           </div>
//           <button
//             onClick={handlePublish}
//             className="px-3 py-1 rounded bg-amber-600 text-white hover:bg-amber-700 text-xs"
//             disabled={saving}
//           >
//             Republish
//           </button>
//         </div>
//       )}

//       {/* Canvas */}
//       <div className="h-[70vh] border rounded-xl bg-gray-50 relative">
//         {/* Minimap + tools */}
//         <div className="absolute bottom-5 right-4 z-50 flex gap-2">
//           <button
//             onClick={() => setShowMiniMap(prev => !prev)}
//             className="bg-purple-600 text-white p-2 rounded-full shadow hover:bg-purple-700"
//             title={showMiniMap ? "Hide MiniMap" : "Show MiniMap"}
//           >
//             {showMiniMap ? <Minus size={15} /> : <Eye size={15} />}
//           </button>

//           <div className="flex items-center gap-2 bg-white/90 px-2 py-1 rounded-full border">
//             <button
//               onClick={() => fitView({ padding: 0.25 })}
//               className="text-xs px-2 py-1 rounded hover:bg-gray-100 font-medium"
//               title="Fit to screen"
//             >
//               Fit
//             </button>
//             <button
//               onClick={() => zoomIn()}
//               className="text-xs px-2 py-1 rounded hover:bg-gray-100"
//               title="Zoom In"
//             >
//               +
//             </button>
//             <button
//               onClick={() => zoomOut()}
//               className="text-xs px-2 py-1 rounded hover:bg-gray-100"
//               title="Zoom Out"
//             >
//               ‚àí
//             </button>

//             {!readonly && (
//               <>
//                 <button
//                   onClick={() => applyLayout("LR")}
//                   className="text-xs px-2 py-1 rounded hover:bg-gray-100"
//                   title="Auto-layout (Left‚ÜíRight)"
//                 >
//                   Auto LR
//                 </button>
//                 <button
//                   onClick={() => applyLayout("TB")}
//                   className="text-xs px-2 py-1 rounded hover:bg-gray-100"
//                   title="Auto-layout (Top‚ÜíBottom)"
//                 >
//                   Auto TB
//                 </button>
//               </>
//             )}
//           </div>
//         </div>

//         <ReactFlow
//           nodes={nodes}
//           edges={edges}
//           onNodesChange={onNodesChange}
//           onEdgesChange={onEdgesChange}
//           onConnect={onConnect}
//           onEdgeClick={(e, edge) => {
//             if (!readonly) {
//               setDirty(true);
//               setEdges(eds => eds.filter(ed => ed.id !== edge.id));
//             }
//           }}
//           nodeTypes={nodeTypes}
//           edgeTypes={edgeTypes}
//           fitView
//           fitViewOptions={{ padding: 0.25 }}
//           defaultEdgeOptions={defaultEdgeOptions}
//           connectionMode={ConnectionMode.Strict}
//           isValidConnection={isValidConnection}
//           snapToGrid
//           snapGrid={[GRID, GRID]}
//           panOnScroll
//           zoomOnPinch
//           panOnDrag={[1, 2]}
//           selectionOnDrag
//           nodesDraggable={!readonly}
//           nodesConnectable={!readonly}
//           elementsSelectable={!readonly}
//         >
//           {showMiniMap && (
//             <MiniMap
//               nodeColor="#9333ea"
//               nodeStrokeWidth={2}
//               maskColor="rgba(255,255,255,0.6)"
//             />
//           )}
//           <Controls />
//           <Background variant="dots" gap={GRID} size={1} />
//         </ReactFlow>
//       </div>

//       {/* Footer actions */}
//       {!readonly && (
//         <div className="mt-6 flex flex-wrap gap-3">
//           <button
//             onClick={handleSaveDraft}
//             className="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 text-sm disabled:opacity-50"
//             disabled={saving}
//           >
//             üíæ Save Draft
//           </button>

//           <button
//             onClick={handlePublish}
//             className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm disabled:opacity-50"
//             disabled={saving}
//           >
//             üöÄ {isPublished ? "Republish" : "Publish Flow"}
//           </button>
//         </div>
//       )}

//       {/* Fork modal: when published & attached */}
//       {forkModalOpen && (
//         <div className="fixed inset-0 z-50 flex items-center justify-center">
//           <div
//             className="absolute inset-0 bg-black/40"
//             onClick={() => setForkModalOpen(false)}
//           />
//           <div
//             role="dialog"
//             aria-modal="true"
//             className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
//           >
//             <div className="flex items-start gap-3 mb-4">
//               <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                 ‚ö†Ô∏è
//               </div>
//               <div>
//                 <h3 className="text-lg font-semibold text-gray-900">
//                   Editing is blocked for this flow
//                 </h3>
//                 <p className="text-sm text-gray-600">
//                   This flow is <span className="font-medium">published</span>{" "}
//                   and attached to active campaign(s). To make changes, create a{" "}
//                   <span className="font-medium">new draft version</span>.
//                 </p>
//               </div>
//             </div>

//             <div className="max-h-60 overflow-auto rounded-lg border divide-y mb-4">
//               {lockInfo.campaigns.map(c => (
//                 <div key={c.id} className="p-3 text-sm">
//                   <div className="flex items-center justify-between">
//                     <div className="font-semibold text-gray-900">{c.name}</div>
//                     <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-700">
//                       {c.status || "‚Äî"}
//                     </span>
//                   </div>
//                   <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
//                     <div>
//                       Created:{" "}
//                       <span className="font-medium text-gray-800">
//                         {c.createdAt
//                           ? new Date(c.createdAt).toLocaleString("en-IN")
//                           : "‚Äî"}
//                       </span>
//                     </div>
//                     <div>
//                       Created by:{" "}
//                       <span className="font-medium text-gray-800">
//                         {c.createdBy || "‚Äî"}
//                       </span>
//                     </div>
//                     <div>
//                       Scheduled:{" "}
//                       <span className="font-medium text-gray-800">
//                         {c.scheduledAt
//                           ? new Date(c.scheduledAt).toLocaleString("en-IN")
//                           : "‚Äî"}
//                       </span>
//                     </div>
//                     <div>
//                       First sent:{" "}
//                       <span className="font-medium text-gray-800">
//                         {c.firstSentAt
//                           ? new Date(c.firstSentAt).toLocaleString("en-IN")
//                           : "‚Äî"}
//                       </span>
//                     </div>
//                   </div>
//                 </div>
//               ))}
//               {lockInfo.campaigns.length === 0 && (
//                 <div className="p-3 text-sm text-gray-600">
//                   Could not load campaign details. You can still create a new
//                   draft version.
//                 </div>
//               )}
//             </div>

//             <div className="flex justify-end gap-2">
//               <button
//                 className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                 onClick={() => setForkModalOpen(false)}
//               >
//                 Close
//               </button>
//               <button
//                 onClick={async () => {
//                   try {
//                     if (!flowId) return;
//                     const { flowId: newId } = await forkFlow(flowId);
//                     setForkModalOpen(false);
//                     toast.success("‚úÖ New draft version created");
//                     navigate(
//                       `/app/cta-flow/visual-builder?id=${newId}&mode=edit`
//                     );
//                   } catch (e) {
//                     console.error(e);
//                     toast.error("‚ùå Failed to create draft copy");
//                   }
//                 }}
//                 className="px-3 py-2 text-sm rounded bg-purple-600 text-white hover:bg-purple-700"
//               >
//                 Create new draft version
//               </button>
//             </div>
//           </div>
//         </div>
//       )}

//       <TemplatePickerModal
//         open={showPicker}
//         onClose={() => setShowPicker(false)}
//         onSelect={handleTemplateSelect}
//       />
//     </div>
//   );
// }

// export default function CTAFlowVisualBuilder() {
//   return (
//     <ReactFlowProvider>
//       <CTAFlowVisualBuilderInner />
//     </ReactFlowProvider>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\CTAFlowVisualBuilder_AllFileDump.txt 
====================================================== 
 
Folder and File Content Report
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\CTAFlowLogs.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../api/axiosClient";
import { Card } from "../../components/ui/card";
import { Table, Thead, Tbody, Tr, Th, Td } from "../../components/ui/table";
import { format } from "date-fns";

const CTAFlowLogs = () => {
  const [logs, setLogs] = useState([]);

  useEffect(() => {
    axiosClient.get("/tracking/flow-clicks").then(res => {
      setLogs(res.data);
    });
  }, []);

  return (
    <div className="p-6">
      <h2 className="text-2xl font-bold mb-4">CTA Flow Click Logs</h2>
      <Card className="overflow-x-auto">
        <Table>
          <Thead>
            <Tr>
              <Th>Date</Th>
              <Th>Recipient</Th>
              <Th>Button</Th>
              <Th>Template</Th>
              <Th>Step ID</Th>
              <Th>Follow-Up</Th>
            </Tr>
          </Thead>
          <Tbody>
            {logs.map(log => (
              <Tr key={log.id}>
                <Td>
                  {format(new Date(log.clickedAt), "dd MMM yyyy hh:mm a")}
                </Td>
                <Td>{log.contactPhone}</Td>
                <Td>{log.buttonText}</Td>
                <Td>{log.templateId}</Td>
                <Td className="text-xs">{log.stepId}</Td>
                <Td>
                  {log.followUpSent ? (
                    <span className="text-green-600 font-semibold">‚úÖ Yes</span>
                  ) : (
                    <span className="text-gray-500">‚Äî</span>
                  )}
                </Td>
              </Tr>
            ))}
          </Tbody>
        </Table>
      </Card>
    </div>
  );
};

export default CTAFlowLogs;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\CTAFlowManager.jsx 
====================================================== 
 
// üìÑ File: src/pages/CTAFlowVisualBuilder/CTAFlowManager.jsx
import React, { useEffect, useMemo, useRef, useState } from "react";
import { useNavigate, useSearchParams } from "react-router-dom";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";

export default function CTAFlowManager() {
  const [flows, setFlows] = useState([]);
  const [loading, setLoading] = useState(true);

  const [modalOpen, setModalOpen] = useState(false);
  const [modalMode, setModalMode] = useState("confirm"); // confirm | attached
  const [modalCampaigns, setModalCampaigns] = useState([]);
  const [targetFlow, setTargetFlow] = useState(null);

  const [query, setQuery] = useState("");
  const [sortKey, setSortKey] = useState("updated");
  const closeBtnRef = useRef(null);
  const navigate = useNavigate();

  // NEW: read ?tab= from URL (published | draft). Default to 'published'
  const [searchParams, setSearchParams] = useSearchParams();
  const tabFromUrl =
    searchParams.get("tab") === "draft" ? "draft" : "published";
  const [activeTab, setActiveTab] = useState(tabFromUrl);

  const formatDate = date =>
    date
      ? new Date(date).toLocaleString("en-IN", {
          day: "2-digit",
          month: "short",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        })
      : "‚Äî";

  const statusPill = isPublished =>
    isPublished ? (
      <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">
        <span>‚óè</span> Published
      </span>
    ) : (
      <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">
        <span>‚óè</span> Draft
      </span>
    );

  const fetchFlows = async (tab = "published") => {
    setLoading(true);
    try {
      const endpoint =
        tab === "published" ? "/cta-flow/all-published" : "/cta-flow/all-draft";
      const res = await axiosClient.get(endpoint);
      setFlows(Array.isArray(res.data) ? res.data : [res.data]);
    } catch (err) {
      setFlows([]);
      toast.error("‚ùå Failed to load flows.");
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  // NEW: whenever ?tab changes (or on first render), sync state and fetch
  useEffect(() => {
    const tab = searchParams.get("tab") === "draft" ? "draft" : "published";
    setActiveTab(tab);
    fetchFlows(tab);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [searchParams]);

  const filtered = useMemo(() => {
    const q = query.trim().toLowerCase();
    let out = flows;
    if (q) {
      out = out.filter(f =>
        [f.flowName, f.createdBy]
          .filter(Boolean)
          .some(v => String(v).toLowerCase().includes(q))
      );
    }
    switch (sortKey) {
      case "name":
        return [...out].sort((a, b) => a.flowName.localeCompare(b.flowName));
      case "created":
        return [...out].sort(
          (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
        );
      default:
        return [...out].sort(
          (a, b) =>
            new Date(b.updatedAt || b.createdAt) -
            new Date(a.updatedAt || a.createdAt)
        );
    }
  }, [flows, query, sortKey]);

  // ---- delete UX (checks usage) ----
  const openDeleteModal = async flow => {
    if (loading) return; // guard
    setTargetFlow(flow);
    setLoading(true);
    try {
      const { data } = await axiosClient.get(`/cta-flow/${flow.id}/usage`);
      if (data?.canDelete) {
        setModalMode("confirm");
        setModalCampaigns([]);
      } else {
        setModalMode("attached");
        setModalCampaigns(Array.isArray(data?.campaigns) ? data.campaigns : []);
      }
      setModalOpen(true);
      setTimeout(() => closeBtnRef.current?.focus(), 0);
    } catch (err) {
      toast.error("‚ùå Could not check usage for this flow.");
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  const confirmDelete = async () => {
    if (!targetFlow) return;
    setLoading(true);
    try {
      const res = await axiosClient.delete(`/cta-flow/${targetFlow.id}`);
      if (res.status === 204 || res.status === 200) {
        toast.success("‚úÖ Flow deleted permanently.");
        setModalOpen(false);
        setTargetFlow(null);
        await fetchFlows(activeTab);
      } else {
        toast.info("‚ÑπÔ∏è Unexpected response while deleting the flow.");
      }
    } catch (err) {
      const status = err?.response?.status;
      if (status === 409) {
        const campaigns = err.response?.data?.campaigns ?? [];
        setModalMode("attached");
        setModalCampaigns(campaigns);
      } else if (status === 404) {
        toast.error("‚ùå Flow not found.");
        setModalOpen(false);
      } else {
        toast.error("‚ùå Failed to delete flow.");
        setModalOpen(false);
      }
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  // ---- publish from draft tab ----
  const publishFlow = async flow => {
    if (loading) return;
    try {
      setLoading(true);
      await axiosClient.post(`/cta-flow/${flow.id}/publish`);
      toast.success("‚úÖ Flow published.");
      // NEW: when publishing, move to Published tab (and reflect in URL)
      setSearchParams({ tab: "published" });
    } catch (err) {
      const status = err?.response?.status;
      if (status === 409) {
        toast.error(
          err?.response?.data?.message || "‚ùå Cannot publish right now."
        );
      } else if (status === 404) {
        toast.error("‚ùå Flow not found.");
      } else {
        toast.error("‚ùå Failed to publish flow.");
      }
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  const goView = flow => {
    if (loading) return;
    navigate(`/app/cta-flow/visual-builder?id=${flow.id}&mode=view`);
  };

  return (
    <div className="p-6 relative">
      {/* Loading overlay */}
      {loading && (
        <>
          <div className="absolute inset-0 z-40 bg-white/60 backdrop-blur-[1px] flex items-center justify-center">
            <div className="flex items-center gap-3 text-gray-700">
              <svg
                className="xafb-spin h-6 w-6 text-purple-600"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
              >
                <circle
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  strokeWidth="4"
                  opacity="0.25"
                />
                <path
                  d="M4 12a8 8 0 018-8"
                  stroke="currentColor"
                  strokeWidth="4"
                  strokeLinecap="round"
                  opacity="0.85"
                />
              </svg>
              <span className="text-sm">Loading‚Ä¶</span>
            </div>
          </div>
          <style>{`@keyframes xafb-spin{to{transform:rotate(360deg)}}.xafb-spin{animation:xafb-spin 1s linear infinite}`}</style>
        </>
      )}

      {/* Header */}
      <div className="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between mb-6">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">
            üß© CTA Flow Manager
          </h1>
          <p className="text-sm text-gray-500">
            Create, publish, and manage your visual flows.
          </p>
        </div>
        <div className="flex items-center gap-2">
          <button
            onClick={() => navigate("/app/cta-flow/visual-builder")}
            className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md shadow disabled:opacity-50"
            disabled={loading}
          >
            ‚ûï New Flow
          </button>
        </div>
      </div>

      {/* Sticky controls */}
      <div className="sticky top-0 z-10 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70 rounded-xl border p-3 mb-4">
        <div className="flex flex-col sm:flex-row sm:items-center gap-3">
          <div className="flex gap-3">
            {[
              { key: "published", label: "‚úÖ Published Flows" },
              { key: "draft", label: "üìù Draft Flows" },
            ].map(t => (
              <button
                key={t.key}
                className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${
                  activeTab === t.key
                    ? "bg-purple-600 text-white shadow"
                    : "text-gray-600 hover:text-purple-700 hover:bg-purple-50"
                }`}
                onClick={() => {
                  if (loading) return;
                  setSearchParams({ tab: t.key }); // NEW: keep URL in sync
                }}
                disabled={loading}
              >
                {t.label}
              </button>
            ))}
          </div>

          <div className="flex-1" />

          {/* Search + sort */}
          <div className="flex items-center gap-2">
            <div className="relative">
              <input
                type="text"
                className="w-64 max-w-full rounded-md border-gray-300 focus:ring-purple-500 focus:border-purple-500 text-sm"
                placeholder="Search by name or creator‚Ä¶"
                value={query}
                onChange={e => setQuery(e.target.value)}
              />
              <div className="absolute inset-y-0 right-2 grid place-items-center pointer-events-none text-gray-400">
                üîé
              </div>
            </div>
            <select
              className="rounded-md border-gray-300 text-sm focus:ring-purple-500 focus:border-purple-500"
              value={sortKey}
              onChange={e => setSortKey(e.target.value)}
            >
              <option value="updated">Sort: Last updated</option>
              <option value="name">Sort: Name (A‚ÄìZ)</option>
              <option value="created">Sort: Created (newest)</option>
            </select>
          </div>
        </div>
      </div>

      {/* Table */}
      {filtered.length === 0 ? (
        <div className="text-gray-500 text-center py-16">
          {query
            ? "No flows match your search."
            : activeTab === "published"
            ? "No published flows yet. Publish a draft to see it here."
            : "No draft flows yet. Create a new flow to get started."}
        </div>
      ) : (
        <div className="bg-white rounded-xl shadow overflow-hidden">
          <table className="w-full text-sm">
            <thead className="bg-gray-50 border-b text-gray-500 uppercase text-xs tracking-wide">
              <tr>
                <th className="px-4 py-3 text-left">Flow Name</th>
                <th className="px-4 py-3 text-left">Status</th>
                <th className="px-4 py-3 text-left">Last Modified</th>
                <th className="px-4 py-3 text-right">Actions</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-100">
              {filtered.map(flow => (
                <tr key={flow.id} className="hover:bg-gray-50">
                  <td className="px-4 py-3">
                    <div className="font-medium text-gray-900">
                      {flow.flowName}
                    </div>
                    <div className="text-xs text-gray-500">
                      Created {formatDate(flow.createdAt)}
                    </div>
                  </td>
                  <td className="px-4 py-3">{statusPill(flow.isPublished)}</td>
                  <td className="px-4 py-3 text-gray-700">
                    {formatDate(flow.updatedAt || flow.createdAt)}
                  </td>
                  <td className="px-4 py-3">
                    <div className="flex justify-end gap-3">
                      <button
                        onClick={() => goView(flow)}
                        className="text-blue-600 hover:underline text-xs disabled:opacity-50"
                        disabled={loading}
                      >
                        üëÅÔ∏è View
                      </button>

                      {/* PUBLISH (only for drafts) */}
                      {!flow.isPublished && (
                        <button
                          onClick={() => publishFlow(flow)}
                          className="text-emerald-600 hover:underline text-xs disabled:opacity-50"
                          disabled={loading}
                          title="Publish this draft"
                        >
                          üöÄ Publish
                        </button>
                      )}

                      {/* DELETE */}
                      <button
                        onClick={() => openDeleteModal(flow)}
                        className="text-rose-600 hover:underline text-xs disabled:opacity-50"
                        disabled={loading}
                      >
                        üóëÔ∏è Delete
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {/* Modal */}
      {modalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          <div
            className="absolute inset-0 bg-black/40"
            onClick={() => setModalOpen(false)}
          />
          <div
            role="dialog"
            aria-modal="true"
            className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
          >
            {modalMode === "attached" ? (
              <>
                <div className="flex items-start gap-3 mb-4">
                  <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
                    ‚ö†Ô∏è
                  </div>
                  <div>
                    <h3 className="text-lg font-semibold text-gray-900">
                      Cannot delete this flow
                    </h3>
                    <p className="text-sm text-gray-600">
                      <span className="font-medium">
                        {targetFlow?.flowName}
                      </span>{" "}
                      is attached to the following campaign
                      {modalCampaigns.length > 1 ? "s" : ""}. Delete those
                      first.
                    </p>
                  </div>
                </div>
                <div className="max-h-72 overflow-auto rounded-lg border divide-y">
                  {modalCampaigns.map(c => (
                    <div key={c.id} className="p-3 text-sm">
                      <div className="flex items-center justify-between">
                        <div className="font-semibold text-gray-900">
                          {c.name}
                        </div>
                        <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-700">
                          {c.status || "‚Äî"}
                        </span>
                      </div>
                      <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
                        <div>
                          Created:{" "}
                          <span className="font-medium text-gray-800">
                            {formatDate(c.createdAt)}
                          </span>
                        </div>
                        <div>
                          Created by:{" "}
                          <span className="font-medium text-gray-800">
                            {c.createdBy || "‚Äî"}
                          </span>
                        </div>
                        <div>
                          Scheduled:{" "}
                          <span className="font-medium text-gray-800">
                            {formatDate(c.scheduledAt)}
                          </span>
                        </div>
                        <div>
                          First sent:{" "}
                          <span className="font-medium text-gray-800">
                            {formatDate(c.firstSentAt)}
                          </span>
                        </div>
                      </div>
                    </div>
                  ))}
                  {modalCampaigns.length === 0 && (
                    <div className="p-3 text-sm text-gray-600">
                      Could not load campaigns.
                    </div>
                  )}
                </div>
                <div className="mt-5 flex justify-end">
                  <button
                    ref={closeBtnRef}
                    className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
                    onClick={() => setModalOpen(false)}
                  >
                    Close
                  </button>
                </div>
              </>
            ) : (
              <>
                <div className="flex items-start gap-3 mb-4">
                  <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
                    üóëÔ∏è
                  </div>
                  <div>
                    <h3 className="text-lg font-semibold text-gray-900">
                      Delete this flow permanently?
                    </h3>
                    <p className="text-sm text-gray-600">
                      This will remove{" "}
                      <span className="font-medium">
                        {targetFlow?.flowName}
                      </span>{" "}
                      and all of its steps and button links. This action cannot
                      be undone.
                    </p>
                  </div>
                </div>
                <div className="rounded-lg border p-3 bg-rose-50 text-rose-700 text-sm">
                  <span className="font-semibold">Warning:</span> Permanent
                  deletion cannot be recovered.
                </div>
                <div className="mt-5 flex justify-end gap-2">
                  <button
                    className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
                    onClick={() => setModalOpen(false)}
                  >
                    Cancel
                  </button>
                  <button
                    onClick={confirmDelete}
                    className="px-3 py-2 text-sm rounded bg-rose-600 text-white hover:bg-rose-700"
                  >
                    Permanently delete
                  </button>
                </div>
              </>
            )}
          </div>
        </div>
      )}
    </div>
  );
}

// // üìÑ File: xbytechat-ui/src/pages/CTAFlowVisualBuilder/CTAFlowManager.jsx
// import React, { useEffect, useMemo, useRef, useState } from "react";
// import { useNavigate } from "react-router-dom";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";

// export default function CTAFlowManager() {
//   const [flows, setFlows] = useState([]);
//   const [activeTab, setActiveTab] = useState("published"); // default Published
//   const [loading, setLoading] = useState(true);

//   const [modalOpen, setModalOpen] = useState(false);
//   const [modalMode, setModalMode] = useState("confirm"); // confirm | attached
//   const [modalCampaigns, setModalCampaigns] = useState([]);
//   const [targetFlow, setTargetFlow] = useState(null);

//   const [query, setQuery] = useState("");
//   const [sortKey, setSortKey] = useState("updated");
//   const closeBtnRef = useRef(null);
//   const navigate = useNavigate();

//   const formatDate = date =>
//     date
//       ? new Date(date).toLocaleString("en-IN", {
//           day: "2-digit",
//           month: "short",
//           year: "numeric",
//           hour: "2-digit",
//           minute: "2-digit",
//         })
//       : "‚Äî";

//   const statusPill = isPublished =>
//     isPublished ? (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">
//         <span>‚óè</span> Published
//       </span>
//     ) : (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">
//         <span>‚óè</span> Draft
//       </span>
//     );

//   const fetchFlows = async (tab = "published") => {
//     setLoading(true);
//     try {
//       const endpoint =
//         tab === "published" ? "/cta-flow/all-published" : "/cta-flow/all-draft";
//       const res = await axiosClient.get(endpoint);
//       setFlows(Array.isArray(res.data) ? res.data : [res.data]);
//     } catch (err) {
//       setFlows([]);
//       toast.error("‚ùå Failed to load flows.");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   useEffect(() => {
//     fetchFlows("published");
//   }, []);

//   const filtered = useMemo(() => {
//     const q = query.trim().toLowerCase();
//     let out = flows;
//     if (q) {
//       out = out.filter(f =>
//         [f.flowName, f.createdBy]
//           .filter(Boolean)
//           .some(v => String(v).toLowerCase().includes(q))
//       );
//     }
//     switch (sortKey) {
//       case "name":
//         return [...out].sort((a, b) => a.flowName.localeCompare(b.flowName));
//       case "created":
//         return [...out].sort(
//           (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
//         );
//       default:
//         return [...out].sort(
//           (a, b) =>
//             new Date(b.updatedAt || b.createdAt) -
//             new Date(a.updatedAt || a.createdAt)
//         );
//     }
//   }, [flows, query, sortKey]);

//   // ---- delete UX (checks usage) ----
//   const openDeleteModal = async flow => {
//     if (loading) return; // guard
//     setTargetFlow(flow);
//     setLoading(true);
//     try {
//       const { data } = await axiosClient.get(`/cta-flow/${flow.id}/usage`);
//       if (data?.canDelete) {
//         setModalMode("confirm");
//         setModalCampaigns([]);
//       } else {
//         setModalMode("attached");
//         setModalCampaigns(Array.isArray(data?.campaigns) ? data.campaigns : []);
//       }
//       setModalOpen(true);
//       setTimeout(() => closeBtnRef.current?.focus(), 0);
//     } catch (err) {
//       toast.error("‚ùå Could not check usage for this flow.");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   const confirmDelete = async () => {
//     if (!targetFlow) return;
//     setLoading(true);
//     try {
//       const res = await axiosClient.delete(`/cta-flow/${targetFlow.id}`);
//       if (res.status === 204 || res.status === 200) {
//         toast.success("‚úÖ Flow deleted permanently.");
//         setModalOpen(false);
//         setTargetFlow(null);
//         await fetchFlows(activeTab);
//       } else {
//         toast.info("‚ÑπÔ∏è Unexpected response while deleting the flow.");
//       }
//     } catch (err) {
//       const status = err?.response?.status;
//       if (status === 409) {
//         const campaigns = err.response?.data?.campaigns ?? [];
//         setModalMode("attached");
//         setModalCampaigns(campaigns);
//       } else if (status === 404) {
//         toast.error("‚ùå Flow not found.");
//         setModalOpen(false);
//       } else {
//         toast.error("‚ùå Failed to delete flow.");
//         setModalOpen(false);
//       }
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   // ---- publish from draft tab ----
//   const publishFlow = async flow => {
//     if (loading) return; // guard against spam clicks
//     try {
//       setLoading(true);
//       await axiosClient.post(`/cta-flow/${flow.id}/publish`);
//       toast.success("‚úÖ Flow published.");
//       // After publish, jump user to Published tab
//       setActiveTab("published");
//       await fetchFlows("published");
//     } catch (err) {
//       const status = err?.response?.status;
//       if (status === 409) {
//         // If backend blocks due to attachments (unlikely for drafts), surface message
//         toast.error(
//           err?.response?.data?.message || "‚ùå Cannot publish right now."
//         );
//       } else if (status === 404) {
//         toast.error("‚ùå Flow not found.");
//       } else {
//         toast.error("‚ùå Failed to publish flow.");
//       }
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   // ---- edit navigation (fix: ignore click while loading) ----
//   const goEdit = flow => {
//     if (loading) return;
//     // Always open builder in edit mode; builder enforces policies (fork/republish etc.)
//     navigate(`/app/cta-flow/visual-builder?id=${flow.id}&mode=edit`);
//   };

//   const goView = flow => {
//     if (loading) return;
//     navigate(`/app/cta-flow/visual-builder?id=${flow.id}&mode=view`);
//   };

//   return (
//     <div className="p-6 relative">
//       {/* Loading overlay */}
//       {loading && (
//         <>
//           <div className="absolute inset-0 z-40 bg-white/60 backdrop-blur-[1px] flex items-center justify-center">
//             <div className="flex items-center gap-3 text-gray-700">
//               <svg
//                 className="xafb-spin h-6 w-6 text-purple-600"
//                 xmlns="http://www.w3.org/2000/svg"
//                 viewBox="0 0 24 24"
//                 fill="none"
//               >
//                 <circle
//                   cx="12"
//                   cy="12"
//                   r="10"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   opacity="0.25"
//                 />
//                 <path
//                   d="M4 12a8 8 0 018-8"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   strokeLinecap="round"
//                   opacity="0.85"
//                 />
//               </svg>
//               <span className="text-sm">Loading‚Ä¶</span>
//             </div>
//           </div>
//           <style>{`@keyframes xafb-spin{to{transform:rotate(360deg)}}.xafb-spin{animation:xafb-spin 1s linear infinite}`}</style>
//         </>
//       )}

//       {/* Header */}
//       <div className="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between mb-6">
//         <div>
//           <h1 className="text-2xl font-bold text-gray-900">
//             üß© CTA Flow Manager
//           </h1>
//           <p className="text-sm text-gray-500">
//             Create, publish, and manage your visual flows.
//           </p>
//         </div>
//         <div className="flex items-center gap-2">
//           <button
//             onClick={() => navigate("/app/cta-flow/visual-builder")}
//             className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md shadow disabled:opacity-50"
//             disabled={loading}
//           >
//             ‚ûï New Flow
//           </button>
//         </div>
//       </div>

//       {/* Sticky controls */}
//       <div className="sticky top-0 z-10 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70 rounded-xl border p-3 mb-4">
//         <div className="flex flex-col sm:flex-row sm:items-center gap-3">
//           <div className="flex gap-3">
//             {[
//               { key: "published", label: "‚úÖ Published Flows" },
//               { key: "draft", label: "üìù Draft Flows" },
//             ].map(t => (
//               <button
//                 key={t.key}
//                 className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${
//                   activeTab === t.key
//                     ? "bg-purple-600 text-white shadow"
//                     : "text-gray-600 hover:text-purple-700 hover:bg-purple-50"
//                 }`}
//                 onClick={() => {
//                   if (loading) return;
//                   setActiveTab(t.key);
//                   fetchFlows(t.key);
//                 }}
//                 disabled={loading}
//               >
//                 {t.label}
//               </button>
//             ))}
//           </div>

//           <div className="flex-1" />

//           {/* Search + sort */}
//           <div className="flex items-center gap-2">
//             <div className="relative">
//               <input
//                 type="text"
//                 className="w-64 max-w-full rounded-md border-gray-300 focus:ring-purple-500 focus:border-purple-500 text-sm"
//                 placeholder="Search by name or creator‚Ä¶"
//                 value={query}
//                 onChange={e => setQuery(e.target.value)}
//               />
//               <div className="absolute inset-y-0 right-2 grid place-items-center pointer-events-none text-gray-400">
//                 üîé
//               </div>
//             </div>
//             <select
//               className="rounded-md border-gray-300 text-sm focus:ring-purple-500 focus:border-purple-500"
//               value={sortKey}
//               onChange={e => setSortKey(e.target.value)}
//             >
//               <option value="updated">Sort: Last updated</option>
//               <option value="name">Sort: Name (A‚ÄìZ)</option>
//               <option value="created">Sort: Created (newest)</option>
//             </select>
//           </div>
//         </div>
//       </div>

//       {/* Table */}
//       {filtered.length === 0 ? (
//         <div className="text-gray-500 text-center py-16">
//           {query
//             ? "No flows match your search."
//             : activeTab === "published"
//             ? "No published flows yet. Publish a draft to see it here."
//             : "No draft flows yet. Create a new flow to get started."}
//         </div>
//       ) : (
//         <div className="bg-white rounded-xl shadow overflow-hidden">
//           <table className="w-full text-sm">
//             <thead className="bg-gray-50 border-b text-gray-500 uppercase text-xs tracking-wide">
//               <tr>
//                 <th className="px-4 py-3 text-left">Flow Name</th>
//                 <th className="px-4 py-3 text-left">Status</th>
//                 <th className="px-4 py-3 text-left">Last Modified</th>
//                 <th className="px-4 py-3 text-right">Actions</th>
//               </tr>
//             </thead>
//             <tbody className="divide-y divide-gray-100">
//               {filtered.map(flow => (
//                 <tr key={flow.id} className="hover:bg-gray-50">
//                   <td className="px-4 py-3">
//                     <div className="font-medium text-gray-900">
//                       {flow.flowName}
//                     </div>
//                     <div className="text-xs text-gray-500">
//                       Created {formatDate(flow.createdAt)}
//                     </div>
//                   </td>
//                   <td className="px-4 py-3">{statusPill(flow.isPublished)}</td>
//                   <td className="px-4 py-3 text-gray-700">
//                     {formatDate(flow.updatedAt || flow.createdAt)}
//                   </td>
//                   <td className="px-4 py-3">
//                     <div className="flex justify-end gap-3">
//                       <button
//                         onClick={() => goView(flow)}
//                         className="text-blue-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üëÅÔ∏è View
//                       </button>

//                       {/* EDIT */}
//                       {/* <button
//                         onClick={() => goEdit(flow)}
//                         className="text-amber-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         ‚úèÔ∏è {flow.isPublished ? "Edit" : "Edit Draft"}
//                       </button> */}

//                       {/* PUBLISH (only show for drafts) */}
//                       {!flow.isPublished && (
//                         <button
//                           onClick={() => publishFlow(flow)}
//                           className="text-emerald-600 hover:underline text-xs disabled:opacity-50"
//                           disabled={loading}
//                           title="Publish this draft"
//                         >
//                           üöÄ Publish
//                         </button>
//                       )}

//                       {/* DELETE */}
//                       <button
//                         onClick={() => openDeleteModal(flow)}
//                         className="text-rose-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üóëÔ∏è Delete
//                       </button>
//                     </div>
//                   </td>
//                 </tr>
//               ))}
//             </tbody>
//           </table>
//         </div>
//       )}

//       {/* Modal */}
//       {modalOpen && (
//         <div className="fixed inset-0 z-50 flex items-center justify-center">
//           <div
//             className="absolute inset-0 bg-black/40"
//             onClick={() => setModalOpen(false)}
//           />
//           <div
//             role="dialog"
//             aria-modal="true"
//             className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
//           >
//             {modalMode === "attached" ? (
//               <>
//                 <div className="flex items-start gap-3 mb-4">
//                   <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                     ‚ö†Ô∏è
//                   </div>
//                   <div>
//                     <h3 className="text-lg font-semibold text-gray-900">
//                       Cannot delete this flow
//                     </h3>
//                     <p className="text-sm text-gray-600">
//                       <span className="font-medium">
//                         {targetFlow?.flowName}
//                       </span>{" "}
//                       is attached to the following campaign
//                       {modalCampaigns.length > 1 ? "s" : ""}. Delete those
//                       first.
//                     </p>
//                   </div>
//                 </div>
//                 <div className="max-h-72 overflow-auto rounded-lg border divide-y">
//                   {modalCampaigns.map(c => (
//                     <div key={c.id} className="p-3 text-sm">
//                       <div className="flex items-center justify-between">
//                         <div className="font-semibold text-gray-900">
//                           {c.name}
//                         </div>
//                         <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-700">
//                           {c.status || "‚Äî"}
//                         </span>
//                       </div>
//                       <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
//                         <div>
//                           Created:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.createdAt)}
//                           </span>
//                         </div>
//                         <div>
//                           Created by:{" "}
//                           <span className="font-medium text-gray-800">
//                             {c.createdBy || "‚Äî"}
//                           </span>
//                         </div>
//                         <div>
//                           Scheduled:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.scheduledAt)}
//                           </span>
//                         </div>
//                         <div>
//                           First sent:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.firstSentAt)}
//                           </span>
//                         </div>
//                       </div>
//                     </div>
//                   ))}
//                   {modalCampaigns.length === 0 && (
//                     <div className="p-3 text-sm text-gray-600">
//                       Could not load campaigns.
//                     </div>
//                   )}
//                 </div>
//                 <div className="mt-5 flex justify-end">
//                   <button
//                     ref={closeBtnRef}
//                     className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                     onClick={() => setModalOpen(false)}
//                   >
//                     Close
//                   </button>
//                 </div>
//               </>
//             ) : (
//               <>
//                 <div className="flex items-start gap-3 mb-4">
//                   <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                     üóëÔ∏è
//                   </div>
//                   <div>
//                     <h3 className="text-lg font-semibold text-gray-900">
//                       Delete this flow permanently?
//                     </h3>
//                     <p className="text-sm text-gray-600">
//                       This will remove{" "}
//                       <span className="font-medium">
//                         {targetFlow?.flowName}
//                       </span>{" "}
//                       and all of its steps and button links. This action cannot
//                       be undone.
//                     </p>
//                   </div>
//                 </div>
//                 <div className="rounded-lg border p-3 bg-rose-50 text-rose-700 text-sm">
//                   <span className="font-semibold">Warning:</span> Permanent
//                   deletion cannot be recovered.
//                 </div>
//                 <div className="mt-5 flex justify-end gap-2">
//                   <button
//                     className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                     onClick={() => setModalOpen(false)}
//                   >
//                     Cancel
//                   </button>
//                   <button
//                     onClick={confirmDelete}
//                     className="px-3 py-2 text-sm rounded bg-rose-600 text-white hover:bg-rose-700"
//                   >
//                     Permanently delete
//                   </button>
//                 </div>
//               </>
//             )}
//           </div>
//         </div>
//       )}
//     </div>
//   );
// }

// // üìÑ File: xbytechat-ui/src/pages/CTAFlowVisualBuilder/CTAFlowManager.jsx
// import React, { useEffect, useMemo, useRef, useState } from "react";
// import { useNavigate } from "react-router-dom";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";

// export default function CTAFlowManager() {
//   const [flows, setFlows] = useState([]);
//   const [activeTab, setActiveTab] = useState("published"); // default Published
//   const [loading, setLoading] = useState(true);

//   const [modalOpen, setModalOpen] = useState(false);
//   const [modalMode, setModalMode] = useState("confirm"); // confirm | attached
//   const [modalCampaigns, setModalCampaigns] = useState([]);
//   const [targetFlow, setTargetFlow] = useState(null);

//   const [query, setQuery] = useState("");
//   const [sortKey, setSortKey] = useState("updated");
//   const closeBtnRef = useRef(null);
//   const navigate = useNavigate();

//   const formatDate = date =>
//     date
//       ? new Date(date).toLocaleString("en-IN", {
//           day: "2-digit",
//           month: "short",
//           year: "numeric",
//           hour: "2-digit",
//           minute: "2-digit",
//         })
//       : "‚Äî";

//   const statusPill = isPublished =>
//     isPublished ? (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">
//         <span>‚óè</span> Published
//       </span>
//     ) : (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">
//         <span>‚óè</span> Draft
//       </span>
//     );

//   const fetchFlows = async (tab = "published") => {
//     setLoading(true);
//     try {
//       const endpoint =
//         tab === "published" ? "/cta-flow/all-published" : "/cta-flow/all-draft";
//       const res = await axiosClient.get(endpoint);
//       setFlows(Array.isArray(res.data) ? res.data : [res.data]);
//     } catch (err) {
//       setFlows([]);
//       toast.error("‚ùå Failed to load flows");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   useEffect(() => {
//     fetchFlows("published");
//   }, []);

//   const filtered = useMemo(() => {
//     const q = query.trim().toLowerCase();
//     let out = flows;
//     if (q) {
//       out = out.filter(f =>
//         [f.flowName, f.createdBy]
//           .filter(Boolean)
//           .some(v => String(v).toLowerCase().includes(q))
//       );
//     }
//     switch (sortKey) {
//       case "name":
//         return [...out].sort((a, b) => a.flowName.localeCompare(b.flowName));
//       case "created":
//         return [...out].sort(
//           (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
//         );
//       default:
//         return [...out].sort(
//           (a, b) =>
//             new Date(b.updatedAt || b.createdAt) -
//             new Date(a.updatedAt || a.createdAt)
//         );
//     }
//   }, [flows, query, sortKey]);

//   // ---- delete UX (checks usage) ----
//   const openDeleteModal = async flow => {
//     setTargetFlow(flow);
//     setLoading(true);
//     try {
//       const { data } = await axiosClient.get(`/cta-flow/${flow.id}/usage`);
//       if (data?.canDelete) {
//         setModalMode("confirm");
//         setModalCampaigns([]);
//       } else {
//         setModalMode("attached");
//         setModalCampaigns(Array.isArray(data?.campaigns) ? data.campaigns : []);
//       }
//       setModalOpen(true);
//       setTimeout(() => closeBtnRef.current?.focus(), 0);
//     } catch (err) {
//       toast.error("‚ùå Could not check usage for this flow.");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   const confirmDelete = async () => {
//     if (!targetFlow) return;
//     setLoading(true);
//     try {
//       const res = await axiosClient.delete(`/cta-flow/${targetFlow.id}`);
//       if (res.status === 204 || res.status === 200) {
//         toast.success("‚úÖ Flow deleted permanently.");
//         setModalOpen(false);
//         setTargetFlow(null);
//         await fetchFlows(activeTab);
//       } else {
//         toast.info("Unexpected response while deleting the flow.");
//       }
//     } catch (err) {
//       const status = err?.response?.status;
//       if (status === 409) {
//         const campaigns = err.response?.data?.campaigns ?? [];
//         setModalMode("attached");
//         setModalCampaigns(campaigns);
//       } else if (status === 404) {
//         toast.error("‚ùå Flow not found.");
//         setModalOpen(false);
//       } else {
//         toast.error("‚ùå Failed to delete flow.");
//         setModalOpen(false);
//       }
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   return (
//     <div className="p-6 relative">
//       {/* Loading overlay */}
//       {loading && (
//         <>
//           <div className="absolute inset-0 z-40 bg-white/60 backdrop-blur-[1px] flex items-center justify-center">
//             <div className="flex items-center gap-3 text-gray-700">
//               <svg
//                 className="xafb-spin h-6 w-6 text-purple-600"
//                 xmlns="http://www.w3.org/2000/svg"
//                 viewBox="0 0 24 24"
//                 fill="none"
//               >
//                 <circle
//                   cx="12"
//                   cy="12"
//                   r="10"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   opacity="0.25"
//                 />
//                 <path
//                   d="M4 12a8 8 0 018-8"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   strokeLinecap="round"
//                   opacity="0.85"
//                 />
//               </svg>
//               <span className="text-sm">Loading‚Ä¶</span>
//             </div>
//           </div>
//           <style>{`@keyframes xafb-spin{to{transform:rotate(360deg)}}.xafb-spin{animation:xafb-spin 1s linear infinite}`}</style>
//         </>
//       )}

//       {/* Header */}
//       <div className="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between mb-6">
//         <div>
//           <h1 className="text-2xl font-bold text-gray-900">
//             üß© CTA Flow Manager
//           </h1>
//           <p className="text-sm text-gray-500">
//             Create, publish, and manage your visual flows.
//           </p>
//         </div>
//         <div className="flex items-center gap-2">
//           <button
//             onClick={() => navigate("/app/cta-flow/visual-builder")}
//             className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md shadow disabled:opacity-50"
//             disabled={loading}
//           >
//             ‚ûï New Flow
//           </button>
//         </div>
//       </div>

//       {/* Sticky controls */}
//       <div className="sticky top-0 z-10 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70 rounded-xl border p-3 mb-4">
//         <div className="flex flex-col sm:flex-row sm:items-center gap-3">
//           <div className="flex gap-3">
//             {[
//               { key: "published", label: "‚úÖ Published Flows" },
//               { key: "draft", label: "üìù Draft Flows" },
//             ].map(t => (
//               <button
//                 key={t.key}
//                 className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${
//                   activeTab === t.key
//                     ? "bg-purple-600 text-white shadow"
//                     : "text-gray-600 hover:text-purple-700 hover:bg-purple-50"
//                 }`}
//                 onClick={() => {
//                   setActiveTab(t.key);
//                   fetchFlows(t.key);
//                 }}
//                 disabled={loading}
//               >
//                 {t.label}
//               </button>
//             ))}
//           </div>

//           <div className="flex-1" />

//           {/* Search + sort */}
//           <div className="flex items-center gap-2">
//             <div className="relative">
//               <input
//                 type="text"
//                 className="w-64 max-w-full rounded-md border-gray-300 focus:ring-purple-500 focus:border-purple-500 text-sm"
//                 placeholder="Search by name or creator‚Ä¶"
//                 value={query}
//                 onChange={e => setQuery(e.target.value)}
//               />
//               <div className="absolute inset-y-0 right-2 grid place-items-center pointer-events-none text-gray-400">
//                 üîé
//               </div>
//             </div>
//             <select
//               className="rounded-md border-gray-300 text-sm focus:ring-purple-500 focus:border-purple-500"
//               value={sortKey}
//               onChange={e => setSortKey(e.target.value)}
//             >
//               <option value="updated">Sort: Last updated</option>
//               <option value="name">Sort: Name (A‚ÄìZ)</option>
//               <option value="created">Sort: Created (newest)</option>
//             </select>
//           </div>
//         </div>
//       </div>

//       {/* Table */}
//       {filtered.length === 0 ? (
//         <div className="text-gray-500 text-center py-16">
//           {query
//             ? "No flows match your search."
//             : activeTab === "published"
//             ? "No published flows yet. Publish a draft to see it here."
//             : "No draft flows yet. Create a new flow to get started."}
//         </div>
//       ) : (
//         <div className="bg-white rounded-xl shadow overflow-hidden">
//           <table className="w-full text-sm">
//             <thead className="bg-gray-50 border-b text-gray-500 uppercase text-xs tracking-wide">
//               <tr>
//                 <th className="px-4 py-3 text-left">Flow Name</th>
//                 <th className="px-4 py-3 text-left">Status</th>
//                 <th className="px-4 py-3 text-left">Last Modified</th>
//                 <th className="px-4 py-3 text-right">Actions</th>
//               </tr>
//             </thead>
//             <tbody className="divide-y divide-gray-100">
//               {filtered.map(flow => (
//                 <tr key={flow.id} className="hover:bg-gray-50">
//                   <td className="px-4 py-3">
//                     <div className="font-medium text-gray-900">
//                       {flow.flowName}
//                     </div>
//                     <div className="text-xs text-gray-500">
//                       Created {formatDate(flow.createdAt)}
//                     </div>
//                   </td>
//                   <td className="px-4 py-3">{statusPill(flow.isPublished)}</td>
//                   <td className="px-4 py-3 text-gray-700">
//                     {formatDate(flow.updatedAt || flow.createdAt)}
//                   </td>
//                   <td className="px-4 py-3">
//                     <div className="flex justify-end gap-3">
//                       <button
//                         onClick={() =>
//                           navigate(
//                             `/app/cta-flow/visual-builder?id=${flow.id}&mode=view`
//                           )
//                         }
//                         className="text-blue-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üëÅÔ∏è View
//                       </button>

//                       {/* EDIT gate: if published, we'll decide in the builder whether republish is needed or fork */}
//                       <button
//                         onClick={() =>
//                           navigate(
//                             `/app/cta-flow/visual-builder?id=${flow.id}&mode=edit`
//                           )
//                         }
//                         className="text-amber-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         ‚úèÔ∏è Edit
//                       </button>

//                       <button
//                         onClick={() => openDeleteModal(flow)}
//                         className="text-rose-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üóëÔ∏è Delete
//                       </button>
//                     </div>
//                   </td>
//                 </tr>
//               ))}
//             </tbody>
//           </table>
//         </div>
//       )}

//       {/* Modal */}
//       {modalOpen && (
//         <div className="fixed inset-0 z-50 flex items-center justify-center">
//           <div
//             className="absolute inset-0 bg-black/40"
//             onClick={() => setModalOpen(false)}
//           />
//           <div
//             role="dialog"
//             aria-modal="true"
//             className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
//           >
//             {modalMode === "attached" ? (
//               <>
//                 <div className="flex items-start gap-3 mb-4">
//                   <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                     ‚ö†Ô∏è
//                   </div>
//                   <div>
//                     <h3 className="text-lg font-semibold text-gray-900">
//                       Cannot delete this flow
//                     </h3>
//                     <p className="text-sm text-gray-600">
//                       <span className="font-medium">
//                         {targetFlow?.flowName}
//                       </span>{" "}
//                       is attached to the following campaign
//                       {modalCampaigns.length > 1 ? "s" : ""}. Delete those
//                       first.
//                     </p>
//                   </div>
//                 </div>
//                 <div className="max-h-72 overflow-auto rounded-lg border divide-y">
//                   {modalCampaigns.map(c => (
//                     <div key={c.id} className="p-3 text-sm">
//                       <div className="flex items-center justify-between">
//                         <div className="font-semibold text-gray-900">
//                           {c.name}
//                         </div>
//                         <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-700">
//                           {c.status || "‚Äî"}
//                         </span>
//                       </div>
//                       <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
//                         <div>
//                           Created:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.createdAt)}
//                           </span>
//                         </div>
//                         <div>
//                           Created by:{" "}
//                           <span className="font-medium text-gray-800">
//                             {c.createdBy || "‚Äî"}
//                           </span>
//                         </div>
//                         <div>
//                           Scheduled:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.scheduledAt)}
//                           </span>
//                         </div>
//                         <div>
//                           First sent:{" "}
//                           <span className="font-medium text-gray-800">
//                             {formatDate(c.firstSentAt)}
//                           </span>
//                         </div>
//                       </div>
//                     </div>
//                   ))}
//                 </div>
//                 <div className="mt-5 flex justify-end">
//                   <button
//                     ref={closeBtnRef}
//                     className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                     onClick={() => setModalOpen(false)}
//                   >
//                     Close
//                   </button>
//                 </div>
//               </>
//             ) : (
//               <>
//                 <div className="flex items-start gap-3 mb-4">
//                   <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                     üóëÔ∏è
//                   </div>
//                   <div>
//                     <h3 className="text-lg font-semibold text-gray-900">
//                       Delete this flow permanently?
//                     </h3>
//                     <p className="text-sm text-gray-600">
//                       This will remove{" "}
//                       <span className="font-medium">
//                         {targetFlow?.flowName}
//                       </span>{" "}
//                       and all of its steps and button links. This action cannot
//                       be undone.
//                     </p>
//                   </div>
//                 </div>
//                 <div className="rounded-lg border p-3 bg-rose-50 text-rose-700 text-sm">
//                   <span className="font-semibold">Warning:</span> Permanent
//                   deletion cannot be recovered.
//                 </div>
//                 <div className="mt-5 flex justify-end gap-2">
//                   <button
//                     className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                     onClick={() => setModalOpen(false)}
//                   >
//                     Cancel
//                   </button>
//                   <button
//                     onClick={confirmDelete}
//                     className="px-3 py-2 text-sm rounded bg-rose-600 text-white hover:bg-rose-700"
//                   >
//                     Permanently delete
//                   </button>
//                 </div>
//               </>
//             )}
//           </div>
//         </div>
//       )}
//     </div>
//   );
// }

// import React, { useEffect, useMemo, useRef, useState } from "react";
// import { useNavigate } from "react-router-dom";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";

// export default function CTAFlowManager() {
//   // ---------- state ----------
//   const [flows, setFlows] = useState([]);
//   const [activeTab, setActiveTab] = useState("published"); // ‚úÖ default to published
//   const [loading, setLoading] = useState(true);

//   // Search + sort (client-side)
//   const [query, setQuery] = useState("");
//   const [sortKey, setSortKey] = useState("updated"); // updated | name | created

//   // Modal
//   const [modalOpen, setModalOpen] = useState(false);
//   const [modalMode, setModalMode] = useState("confirm"); // confirm | attached
//   const [modalCampaigns, setModalCampaigns] = useState([]);
//   const [targetFlow, setTargetFlow] = useState(null);

//   const navigate = useNavigate();
//   const closeBtnRef = useRef(null);

//   // ---------- helpers ----------
//   const formatDate = date => {
//     if (!date) return "‚Äî";
//     const d = new Date(date);
//     return d.toLocaleString("en-IN", {
//       day: "2-digit",
//       month: "short",
//       year: "numeric",
//       hour: "2-digit",
//       minute: "2-digit",
//     });
//   };

//   const statusPill = isPublished =>
//     isPublished ? (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">
//         <span>‚óè</span> Published
//       </span>
//     ) : (
//       <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">
//         <span>‚óè</span> Draft
//       </span>
//     );

//   const renderStatusBadge = status => {
//     const s = (status || "").toLowerCase();
//     const map = {
//       draft: "bg-amber-100 text-amber-700",
//       scheduled: "bg-sky-100 text-sky-700",
//       running: "bg-blue-100 text-blue-700",
//       sent: "bg-emerald-100 text-emerald-700",
//       completed: "bg-emerald-100 text-emerald-700",
//       failed: "bg-rose-100 text-rose-700",
//     };
//     const cls = map[s] || "bg-gray-100 text-gray-700";
//     return (
//       <span
//         className={`inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium ${cls}`}
//       >
//         {status || "‚Äî"}
//       </span>
//     );
//   };

//   // ---------- data ----------
//   const fetchFlows = async (tab = "published") => {
//     setLoading(true);
//     try {
//       const endpoint =
//         tab === "published" ? "/cta-flow/all-published" : "/cta-flow/all-draft";
//       const res = await axiosClient.get(endpoint);
//       const list = Array.isArray(res.data) ? res.data : [res.data];
//       setFlows(list);
//     } catch (err) {
//       setFlows([]);
//       toast.error("‚ùå Failed to load flows");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   useEffect(() => {
//     fetchFlows("published"); // ‚úÖ first load = published
//   }, []);

//   // ---------- search + sort (client-side) ----------
//   const filtered = useMemo(() => {
//     const q = query.trim().toLowerCase();
//     let out = flows;
//     if (q) {
//       out = out.filter(f =>
//         [f.flowName, f.createdBy]
//           .filter(Boolean)
//           .some(v => String(v).toLowerCase().includes(q))
//       );
//     }
//     switch (sortKey) {
//       case "name":
//         out = [...out].sort((a, b) => a.flowName.localeCompare(b.flowName));
//         break;
//       case "created":
//         out = [...out].sort(
//           (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
//         );
//         break;
//       default:
//         out = [...out].sort(
//           (a, b) =>
//             new Date(b.updatedAt || b.createdAt) -
//             new Date(a.updatedAt || a.createdAt)
//         );
//     }
//     return out;
//   }, [flows, query, sortKey]);

//   // ---------- delete flow UX ----------
//   const openDeleteModal = async flow => {
//     setTargetFlow(flow);
//     setLoading(true);
//     try {
//       const { data } = await axiosClient.get(`/cta-flow/${flow.id}/usage`);
//       if (data?.canDelete) {
//         setModalMode("confirm");
//         setModalCampaigns([]);
//       } else {
//         setModalMode("attached");
//         setModalCampaigns(Array.isArray(data?.campaigns) ? data.campaigns : []);
//       }
//       setModalOpen(true);
//       setTimeout(() => closeBtnRef.current?.focus(), 0);
//     } catch (err) {
//       toast.error("‚ùå Could not check usage for this flow.");
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   const confirmDelete = async () => {
//     if (!targetFlow) return;
//     setLoading(true);
//     try {
//       const res = await axiosClient.delete(`/cta-flow/${targetFlow.id}`);
//       if (res.status === 204 || res.status === 200) {
//         toast.success("‚úÖ Flow deleted permanently.");
//         setModalOpen(false);
//         setTargetFlow(null);
//         await fetchFlows(activeTab);
//       } else {
//         toast.info("Unexpected response while deleting the flow.");
//       }
//     } catch (err) {
//       const status = err?.response?.status;
//       if (status === 409) {
//         const campaigns = err.response?.data?.campaigns ?? [];
//         setModalMode("attached");
//         setModalCampaigns(campaigns);
//       } else if (status === 404) {
//         toast.error("‚ùå Flow not found.");
//         setModalOpen(false);
//       } else {
//         toast.error("‚ùå Failed to delete flow.");
//         setModalOpen(false);
//       }
//       console.error(err);
//     } finally {
//       setLoading(false);
//     }
//   };

//   // ---------- UI ----------
//   return (
//     <div className="p-6 relative">
//       {/* Loading overlay */}
//       {loading && (
//         <>
//           <div className="absolute inset-0 z-40 bg-white/60 backdrop-blur-[1px] flex items-center justify-center">
//             <div className="flex items-center gap-3 text-gray-700">
//               <svg
//                 className="xafb-spin h-6 w-6 text-purple-600"
//                 xmlns="http://www.w3.org/2000/svg"
//                 viewBox="0 0 24 24"
//                 fill="none"
//               >
//                 <circle
//                   cx="12"
//                   cy="12"
//                   r="10"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   opacity="0.25"
//                 />
//                 <path
//                   d="M4 12a8 8 0 018-8"
//                   stroke="currentColor"
//                   strokeWidth="4"
//                   strokeLinecap="round"
//                   opacity="0.85"
//                 />
//               </svg>
//               <span className="text-sm">Loading‚Ä¶</span>
//             </div>
//           </div>
//           <style>{`@keyframes xafb-spin{to{transform:rotate(360deg)}}.xafb-spin{animation:xafb-spin 1s linear infinite}`}</style>
//         </>
//       )}

//       {/* Page header */}
//       <div className="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between mb-6">
//         <div>
//           <h1 className="text-2xl font-bold text-gray-900">
//             üß© CTA Flow Manager
//           </h1>
//           <p className="text-sm text-gray-500">
//             Create, publish, and manage your visual flows.
//           </p>
//         </div>
//         <div className="flex items-center gap-2">
//           <button
//             onClick={() => navigate("/app/cta-flow/visual-builder")}
//             className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md shadow disabled:opacity-50"
//             disabled={loading}
//           >
//             ‚ûï New Flow
//           </button>
//         </div>
//       </div>

//       {/* Sticky controls */}
//       <div className="sticky top-0 z-10 bg-white/90 backdrop-blur supports-[backdrop-filter]:bg-white/70 rounded-xl border p-3 mb-4">
//         <div className="flex flex-col sm:flex-row sm:items-center gap-3">
//           {/* Tabs */}
//           <div className="flex gap-3">
//             {[
//               { key: "published", label: "‚úÖ Published Flows" },
//               { key: "draft", label: "üìù Draft Flows" },
//             ].map(t => (
//               <button
//                 key={t.key}
//                 className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${
//                   activeTab === t.key
//                     ? "bg-purple-600 text-white shadow"
//                     : "text-gray-600 hover:text-purple-700 hover:bg-purple-50"
//                 }`}
//                 onClick={() => {
//                   setActiveTab(t.key);
//                   fetchFlows(t.key);
//                 }}
//                 disabled={loading}
//               >
//                 {t.label}
//               </button>
//             ))}
//           </div>

//           {/* Spacer */}
//           <div className="flex-1" />

//           {/* Search */}
//           <div className="flex items-center gap-2">
//             <div className="relative">
//               <input
//                 type="text"
//                 className="w-64 max-w-full rounded-md border-gray-300 focus:ring-purple-500 focus:border-purple-500 text-sm"
//                 placeholder="Search by name or creator‚Ä¶"
//                 value={query}
//                 onChange={e => setQuery(e.target.value)}
//               />
//               <div className="absolute inset-y-0 right-2 grid place-items-center pointer-events-none text-gray-400">
//                 üîé
//               </div>
//             </div>

//             {/* Sort */}
//             <select
//               className="rounded-md border-gray-300 text-sm focus:ring-purple-500 focus:border-purple-500"
//               value={sortKey}
//               onChange={e => setSortKey(e.target.value)}
//             >
//               <option value="updated">Sort: Last updated</option>
//               <option value="name">Sort: Name (A‚ÄìZ)</option>
//               <option value="created">Sort: Created (newest)</option>
//             </select>
//           </div>
//         </div>
//       </div>

//       {/* Content */}
//       {filtered.length === 0 ? (
//         <div className="text-gray-500 text-center py-16">
//           {query
//             ? "No flows match your search."
//             : activeTab === "published"
//             ? "No published flows yet. Publish a draft to see it here."
//             : "No draft flows yet. Create a new flow to get started."}
//         </div>
//       ) : (
//         <div className="bg-white rounded-xl shadow overflow-hidden">
//           <table className="w-full text-sm">
//             <thead className="bg-gray-50 border-b text-gray-500 uppercase text-xs tracking-wide">
//               <tr>
//                 <th className="px-4 py-3 text-left">Flow Name</th>
//                 <th className="px-4 py-3 text-left">Status</th>
//                 <th className="px-4 py-3 text-left">Last Modified</th>
//                 <th className="px-4 py-3 text-right">Actions</th>
//               </tr>
//             </thead>
//             <tbody className="divide-y divide-gray-100">
//               {filtered.map(flow => (
//                 <tr key={flow.id} className="hover:bg-gray-50">
//                   <td className="px-4 py-3">
//                     <div className="font-medium text-gray-900">
//                       {flow.flowName}
//                     </div>
//                     <div className="text-xs text-gray-500">
//                       Created {formatDate(flow.createdAt)}
//                     </div>
//                   </td>
//                   <td className="px-4 py-3">{statusPill(flow.isPublished)}</td>
//                   <td className="px-4 py-3 text-gray-700">
//                     {formatDate(flow.updatedAt || flow.createdAt)}
//                   </td>
//                   <td className="px-4 py-3">
//                     <div className="flex justify-end gap-3">
//                       <button
//                         onClick={() =>
//                           navigate(
//                             `/app/cta-flow/visual-builder?id=${flow.id}&mode=view`
//                           )
//                         }
//                         className="text-blue-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üëÅÔ∏è View
//                       </button>
//                       {!flow.isPublished && (
//                         <button
//                           onClick={() =>
//                             navigate(
//                               `/app/cta-flow/visual-builder?id=${flow.id}&mode=edit`
//                             )
//                           }
//                           className="text-amber-600 hover:underline text-xs disabled:opacity-50"
//                           disabled={loading}
//                         >
//                           ‚úèÔ∏è Edit
//                         </button>
//                       )}
//                       <button
//                         onClick={() => openDeleteModal(flow)}
//                         className="text-rose-600 hover:underline text-xs disabled:opacity-50"
//                         disabled={loading}
//                       >
//                         üóëÔ∏è Delete
//                       </button>
//                     </div>
//                   </td>
//                 </tr>
//               ))}
//             </tbody>
//           </table>
//         </div>
//       )}

//       {/* Modal */}
//       {modalOpen && (
//         <div className="fixed inset-0 z-50 flex items-center justify-center">
//           <div
//             className="absolute inset-0 bg-black/40"
//             onClick={() => setModalOpen(false)}
//           />
//           <div
//             role="dialog"
//             aria-modal="true"
//             className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
//           >
//             {/* Header */}
//             {modalMode === "attached" ? (
//               <div className="flex items-start gap-3 mb-4">
//                 <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                   ‚ö†Ô∏è
//                 </div>
//                 <div>
//                   <h3 className="text-lg font-semibold text-gray-900">
//                     Cannot delete this flow
//                   </h3>
//                   <p className="text-sm text-gray-600">
//                     <span className="font-medium">{targetFlow?.flowName}</span>{" "}
//                     is attached to the campaign
//                     {modalCampaigns.length > 1 ? "s" : ""} below. Delete those
//                     campaign
//                     {modalCampaigns.length > 1 ? "s" : ""} first.
//                   </p>
//                 </div>
//               </div>
//             ) : (
//               <div className="flex items-start gap-3 mb-4">
//                 <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                   üóëÔ∏è
//                 </div>
//                 <div>
//                   <h3 className="text-lg font-semibold text-gray-900">
//                     Delete this flow permanently?
//                   </h3>
//                   <p className="text-sm text-gray-600">
//                     This will remove{" "}
//                     <span className="font-medium">{targetFlow?.flowName}</span>{" "}
//                     and all of its steps and button links. This action cannot be
//                     undone.
//                   </p>
//                 </div>
//               </div>
//             )}

//             {/* Body */}
//             {modalMode === "attached" ? (
//               <div className="max-h-72 overflow-auto rounded-lg border divide-y">
//                 {modalCampaigns.map(c => (
//                   <div key={c.id} className="p-3 text-sm">
//                     <div className="flex items-center justify-between">
//                       <div className="font-semibold text-gray-900">
//                         {c.name}
//                       </div>
//                       {renderStatusBadge(c.status)}
//                     </div>
//                     <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
//                       <div>
//                         Created:{" "}
//                         <span className="font-medium text-gray-800">
//                           {formatDate(c.createdAt)}
//                         </span>
//                       </div>
//                       <div>
//                         Created by:{" "}
//                         <span className="font-medium text-gray-800">
//                           {c.createdBy || "‚Äî"}
//                         </span>
//                       </div>
//                       <div>
//                         Scheduled:{" "}
//                         <span className="font-medium text-gray-800">
//                           {formatDate(c.scheduledAt)}
//                         </span>
//                       </div>
//                       <div>
//                         First sent:{" "}
//                         <span className="font-medium text-gray-800">
//                           {formatDate(c.firstSentAt)}
//                         </span>
//                       </div>
//                     </div>
//                   </div>
//                 ))}
//               </div>
//             ) : (
//               <div className="rounded-lg border p-3 bg-rose-50 text-rose-700 text-sm">
//                 <span className="font-semibold">Warning:</span> This will
//                 permanently delete the flow and its data.
//               </div>
//             )}

//             {/* Footer */}
//             <div className="mt-5 flex justify-end gap-2">
//               <button
//                 ref={closeBtnRef}
//                 className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                 onClick={() => setModalOpen(false)}
//               >
//                 Close
//               </button>
//               {modalMode === "confirm" && (
//                 <button
//                   onClick={confirmDelete}
//                   className="px-3 py-2 text-sm rounded bg-rose-600 text-white hover:bg-rose-700"
//                 >
//                   Permanently delete
//                 </button>
//               )}
//             </div>
//           </div>
//         </div>
//       )}
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\ctaFlowVisualApi.js 
====================================================== 
 
// üìÑ File: xbytechat-ui/src/pages/CTAFlowVisualBuilder/ctaFlowVisualApi.js
import axiosClient from "../../api/axiosClient";

const toBool = v => v === true || v === "true" || v === 1;
const toPosInt = (v, def = 1) => {
  const n = parseInt(v, 10);
  return Number.isFinite(n) && n > 0 ? n : def;
};

// ---- shared payload normalizer ----
function normalizePayload(payload) {
  const safeNodes = (payload.Nodes || []).map(node => ({
    Id: node.Id || "",
    TemplateName: node.TemplateName || "",
    TemplateType: node.TemplateType || "text_template",
    MessageBody: node.MessageBody || "",
    PositionX: node.PositionX ?? 0,
    PositionY: node.PositionY ?? 0,
    TriggerButtonText: node.TriggerButtonText || "",
    TriggerButtonType: node.TriggerButtonType || "cta",
    UseProfileName: toBool(node.UseProfileName),
    ProfileNameSlot: toPosInt(node.ProfileNameSlot ?? 1, 1),
    Buttons: (node.Buttons || []).map((btn, idx) => ({
      Text: btn.Text || "",
      Type: btn.Type || "",
      SubType: btn.SubType || "",
      Value: btn.Value || "",
      Index: Number.isFinite(btn.Index) ? btn.Index : idx,
      TargetNodeId: btn.TargetNodeId || null,
    })),
  }));

  const safeEdges = (payload.Edges || []).map(e => ({
    FromNodeId: e.FromNodeId || "",
    ToNodeId: e.ToNodeId || "",
    SourceHandle: e.SourceHandle || "",
  }));

  return {
    FlowName: payload.FlowName || "Untitled",
    IsPublished: !!payload.IsPublished,
    Nodes: safeNodes,
    Edges: safeEdges,
  };
}

// ---- CREATE (by name) ----
export async function saveVisualFlow(payload) {
  const res = await axiosClient.post(
    "/cta-flow/save-visual",
    normalizePayload(payload)
  );
  return res.data;
}

// ---- LOAD BY ID ----
export async function getVisualFlowById(flowId) {
  if (!flowId) throw new Error("flowId is required");
  const res = await axiosClient.get(`/cta-flow/by-id/${flowId}`);
  return res.data;
}

// ---- USAGE (edit/delete gates) ----
export async function getFlowUsage(flowId) {
  if (!flowId) throw new Error("flowId is required");
  const { data } = await axiosClient.get(`/cta-flow/${flowId}/usage`);
  return data; // { canDelete, count, campaigns }
}

// ---- UPDATE BY ID ----
export async function updateVisualFlow(flowId, payload) {
  if (!flowId) throw new Error("flowId is required");
  const res = await axiosClient.put(
    `/cta-flow/${flowId}`,
    normalizePayload(payload)
  );
  return res.data; // { message, needsRepublish? }
}

// ---- PUBLISH ----
export async function publishFlow(flowId) {
  if (!flowId) throw new Error("flowId is required");
  const res = await axiosClient.post(`/cta-flow/${flowId}/publish`);
  return res.data;
}

// ---- FORK (create draft version) ----
export async function forkFlow(flowId) {
  if (!flowId) throw new Error("flowId is required");
  const res = await axiosClient.post(`/cta-flow/${flowId}/fork`);
  return res.data; // { flowId }
}

// ---- (Optional) DELETE helper for manager page ----
export async function deleteFlow(flowId) {
  if (!flowId) throw new Error("flowId is required");
  const res = await axiosClient.delete(`/cta-flow/${flowId}`);
  return res.data;
}

// // üìÑ File: xbytechat-ui/src/pages/CTAFlowVisualBuilder/ctaFlowVisualApi.js
// import axiosClient from "../../api/axiosClient";

// const toBool = v => v === true || v === "true" || v === 1;
// const toPosInt = (v, def = 1) => {
//   const n = parseInt(v, 10);
//   return Number.isFinite(n) && n > 0 ? n : def;
// };

// // ---- CREATE / UPSERT BY NAME (existing) ----
// export async function saveVisualFlow(payload) {
//   const safeNodes = (payload.Nodes || []).map(node => ({
//     Id: node.Id || "",
//     TemplateName: node.TemplateName || "",
//     TemplateType: node.TemplateType || "text_template",
//     MessageBody: node.MessageBody || "",
//     PositionX: node.PositionX ?? 0,
//     PositionY: node.PositionY ?? 0,
//     TriggerButtonText: node.TriggerButtonText || "",
//     TriggerButtonType: node.TriggerButtonType || "cta",
//     UseProfileName: toBool(node.UseProfileName),
//     ProfileNameSlot: toPosInt(node.ProfileNameSlot ?? 1, 1),
//     Buttons: (node.Buttons || []).map((btn, idx) => ({
//       Text: btn.Text || "",
//       Type: btn.Type || "",
//       SubType: btn.SubType || "",
//       Value: btn.Value || "",
//       Index: Number.isFinite(btn.Index) ? btn.Index : idx,
//       TargetNodeId: btn.TargetNodeId || null,
//     })),
//   }));

//   const safeEdges = (payload.Edges || []).map(e => ({
//     FromNodeId: e.FromNodeId || "",
//     ToNodeId: e.ToNodeId || "",
//     SourceHandle: e.SourceHandle || "",
//   }));

//   const fixedPayload = {
//     FlowName: payload.FlowName || "Untitled",
//     IsPublished: !!payload.IsPublished,
//     Nodes: safeNodes,
//     Edges: safeEdges,
//   };

//   const res = await axiosClient.post("/cta-flow/save-visual", fixedPayload);
//   return res.data;
// }

// // ---- LOAD BY ID (existing consumer in builder) ----
// export async function getVisualFlowById(flowId) {
//   const res = await axiosClient.get(`/cta-flow/by-id/${flowId}`);
//   return res.data;
// }

// // ---- NEW: usage for delete/edit gates ----
// export async function getFlowUsage(flowId) {
//   const { data } = await axiosClient.get(`/cta-flow/${flowId}/usage`);
//   return data; // { canDelete: boolean, campaigns: [] }
// }

// // ---- NEW: update by id (two-state policy on backend) ----
// export async function updateVisualFlow(flowId, payload) {
//   const res = await axiosClient.put(`/cta-flow/${flowId}`, payload);
//   return res.data; // { message, needsRepublish? }
// }

// // ---- NEW: publish ----
// export async function publishFlow(flowId) {
//   const res = await axiosClient.post(`/cta-flow/${flowId}/publish`);
//   return res.data;
// }

// // ---- NEW: fork ----
// export async function forkFlow(flowId) {
//   const res = await axiosClient.post(`/cta-flow/${flowId}/fork`);
//   return res.data; // { flowId }
// }

// import axiosClient from "../../api/axiosClient";
// /**
//  * Coerce values coming from the UI into clean types for the API.
//  */
// const toBool = v => v === true || v === "true" || v === 1;
// const toPosInt = (v, def = 1) => {
//   const n = parseInt(v, 10);
//   return Number.isFinite(n) && n > 0 ? n : def;
// };

// /**
//  * Save a visual flow (nodes + edges).
//  * Includes UseProfileName/ProfileNameSlot so the runtime knows where to inject the WA profile name.
//  */
// export async function saveVisualFlow(payload) {
//   const safeNodes = (payload.Nodes || []).map(node => ({
//     Id: node.Id || "",
//     TemplateName: node.TemplateName || "",
//     TemplateType: node.TemplateType || "text_template",
//     MessageBody: node.MessageBody || "",
//     PositionX: node.PositionX ?? 0,
//     PositionY: node.PositionY ?? 0,
//     TriggerButtonText: node.TriggerButtonText || "",
//     TriggerButtonType: node.TriggerButtonType || "cta",

//     // üëá NEW: persist the greeting controls per-step
//     UseProfileName: toBool(node.UseProfileName),
//     ProfileNameSlot: toPosInt(node.ProfileNameSlot ?? 1, 1),

//     // buttons with stable Index (used later to map clicks)
//     Buttons: (node.Buttons || []).map((btn, idx) => ({
//       Text: btn.Text || "",
//       Type: btn.Type || "",
//       SubType: btn.SubType || "",
//       Value: btn.Value || "",
//       TargetNodeId: btn.TargetNodeId || null,
//       Index: Number.isFinite(btn.Index) ? btn.Index : idx,
//     })),
//   }));

//   const safeEdges = (payload.Edges || []).map(e => ({
//     FromNodeId: e.FromNodeId || "",
//     ToNodeId: e.ToNodeId || "",
//     SourceHandle: e.SourceHandle || "", // button text
//   }));

//   const fixedPayload = {
//     FlowName: payload.FlowName || "Untitled",
//     IsPublished: !!payload.IsPublished,
//     Nodes: safeNodes,
//     Edges: safeEdges,
//   };

//   const res = await axiosClient.post("/cta-flow/save-visual", fixedPayload);
//   return res.data;
// }

// /**
//  * Load a visual flow by ID.
//  * The builder expects the response shape to include: { flowName, nodes: [...], edges: [...] }.
//  */
// export async function getVisualFlowById(flowId) {
//   const res = await axiosClient.get(`/cta-flow/by-id/${flowId}`);
//   return res.data;
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\CTAFlowVisualBuilder.jsx 
====================================================== 
 
// src/pages/CTAFlowVisualBuilder/CTAFlowVisualBuilder.jsx
import React, {
  useCallback,
  useState,
  useEffect,
  useMemo,
  useRef,
} from "react";
import {
  ReactFlow,
  ReactFlowProvider,
  Background,
  Controls,
  MiniMap,
  useNodesState,
  useEdgesState,
  addEdge,
  MarkerType,
  ConnectionMode,
  useReactFlow,
} from "@xyflow/react";
import "@xyflow/react/dist/style.css";
import { Eye, Minus } from "lucide-react";
import { useSearchParams, useNavigate } from "react-router-dom";
import TemplatePickerModal from "./components/TemplatePickerModal";
import FlowNodeBubble from "./components/FlowNodeBubble";
import {
  saveVisualFlow,
  getVisualFlowById,
  updateVisualFlow,
  publishFlow,
  forkFlow,
  getFlowUsage,
} from "./ctaFlowVisualApi";
import { v4 as uuidv4 } from "uuid";
import { toast } from "react-toastify";
import dagre from "dagre";
import SmartLabeledEdge from "./components/edges/SmartLabeledEdge";

const GRID = 16;
const NODE_DEFAULT = { width: 260, height: 140 };

function CTAFlowVisualBuilderInner() {
  const [nodes, setNodes, onNodesChange] = useNodesState([]);
  const [edges, setEdges, onEdgesChange] = useEdgesState([]);
  const nodesRef = useRef([]);
  const [showPicker, setShowPicker] = useState(false);
  const [flowName, setFlowName] = useState("");
  const flowNameRef = useRef(null);
  const [showMiniMap, setShowMiniMap] = useState(false);
  const [readonly, setReadonly] = useState(false);

  // policy state
  const [isPublished, setIsPublished] = useState(false);
  const [republishNeeded, setRepublishNeeded] = useState(false);
  const [lockInfo, setLockInfo] = useState({ locked: false, campaigns: [] });
  const [forkModalOpen, setForkModalOpen] = useState(false);

  // async state
  const [saving, setSaving] = useState(false);
  const [loading, setLoading] = useState(false);

  const [dirty, setDirty] = useState(false);

  const [searchParams] = useSearchParams();
  const navigate = useNavigate();
  const { fitView, zoomIn, zoomOut } = useReactFlow();

  const mode = searchParams.get("mode"); // 'edit' | 'view' | null
  const flowId = searchParams.get("id");
  const visualDebug = true;

  // figure out source tab for Back button
  const fromTab = (searchParams.get("from") || "draft").toLowerCase();
  const backTab = fromTab === "published" ? "published" : "draft";

  const goBackToManager = useCallback(() => {
    if (!readonly && dirty) {
      const ok = window.confirm("You have unsaved changes. Leave this page?");
      if (!ok) return;
    }
    navigate(`/app/cta-flow/flow-manager?tab=${backTab}`);
  }, [readonly, dirty, backTab, navigate]);

  useEffect(() => {
    nodesRef.current = [...nodes];
  }, [nodes]);

  // warn on unload if dirty
  useEffect(() => {
    const onBeforeUnload = e => {
      if (!dirty) return;
      e.preventDefault();
      e.returnValue = "";
    };
    window.addEventListener("beforeunload", onBeforeUnload);
    return () => window.removeEventListener("beforeunload", onBeforeUnload);
  }, [dirty]);

  // --- Node helpers
  const handleDeleteNode = useCallback(
    nodeId => {
      if (readonly) return;
      setDirty(true);
      setNodes(nds => nds.filter(n => n.id !== nodeId));
      setEdges(eds =>
        eds.filter(e => e.source !== nodeId && e.target !== nodeId)
      );
    },
    [readonly, setNodes, setEdges]
  );

  const handleNodeDataChange = useCallback(
    (nodeId, newData) => {
      setDirty(true);
      setNodes(nds =>
        nds.map(n =>
          n.id === nodeId ? { ...n, data: { ...n.data, ...newData } } : n
        )
      );
    },
    [setNodes]
  );

  const nodeTypes = useMemo(
    () => ({
      customBubble: props => (
        <FlowNodeBubble
          {...props}
          onDelete={handleDeleteNode}
          onDataChange={newData => handleNodeDataChange(props.id, newData)}
          readonly={readonly}
          visualDebug={visualDebug}
        />
      ),
    }),
    [handleDeleteNode, readonly, visualDebug, handleNodeDataChange]
  );

  const edgeTypes = useMemo(() => ({ smart: SmartLabeledEdge }), []);

  // --- Load / Bootstrap + policy checks
  useEffect(() => {
    const load = async () => {
      setLoading(true);
      if (mode === "edit" || mode === "view") {
        try {
          const data = await getVisualFlowById(flowId);

          const builtNodes = (data.nodes || []).map((node, index) => ({
            id: node.id,
            type: "customBubble",
            position: {
              x: node.positionX ?? 120 + index * 120,
              y: node.positionY ?? 150 + (index % 5) * 60,
            },
            data: {
              templateName: node.templateName,
              templateType: node.templateType,
              messageBody: node.messageBody,
              triggerButtonText: node.triggerButtonText || "",
              triggerButtonType: node.triggerButtonType || "cta",
              requiredTag: node.requiredTag || "",
              requiredSource: node.requiredSource || "",
              useProfileName: !!node.useProfileName,
              profileNameSlot:
                typeof node.profileNameSlot === "number" &&
                node.profileNameSlot > 0
                  ? node.profileNameSlot
                  : 1,
              buttons: (node.buttons || []).map((btn, i) => ({
                text: btn.text,
                type: btn.type,
                subType: btn.subType,
                value: btn.value,
                targetNodeId: btn.targetNodeId || null,
                index: typeof btn.index === "number" ? btn.index : i,
              })),
            },
          }));

          const builtEdges = (data.edges || []).map(edge => ({
            id: `e-${edge.fromNodeId}-${edge.toNodeId}-${
              edge.sourceHandle || "h"
            }`,
            source: edge.fromNodeId,
            target: edge.toNodeId,
            sourceHandle: edge.sourceHandle || null,
            type: "smart",
            animated: true,
            style: { stroke: "#9333ea" },
            markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
            label: edge.sourceHandle || "",
          }));

          const nodesWithIncoming = new Set(builtEdges.map(e => e.target));
          const nodesWithWarnings = builtNodes.map(node => ({
            ...node,
            data: {
              ...node.data,
              isUnreachable: false,
              hasNoIncoming: !nodesWithIncoming.has(node.id),
            },
          }));

          setNodes(nodesWithWarnings);
          setEdges(builtEdges);
          setFlowName(data.flowName || "Untitled Flow");
          setIsPublished(!!data.isPublished);
          setDirty(false);

          // policy: if editing a published flow, check attachment
          if (mode === "edit" && data.isPublished) {
            try {
              const usage = await getFlowUsage(flowId);
              if (usage?.campaigns?.length > 0) {
                setLockInfo({ locked: true, campaigns: usage.campaigns });
                setForkModalOpen(true);
                setReadonly(true);
              } else {
                setReadonly(false);
              }
            } catch {
              setLockInfo({ locked: true, campaigns: [] });
              setForkModalOpen(true);
              setReadonly(true);
            }
          } else {
            setReadonly(mode === "view");
          }

          // initial fit
          setTimeout(() => fitView({ padding: 0.25 }), 80);
        } catch {
          toast.error("‚ùå Failed to load flow");
        } finally {
          setLoading(false);
        }
      } else {
        // creating new flow
        setNodes([]);
        setEdges([]);
        setFlowName("Untitled Flow");
        setIsPublished(false);
        setReadonly(false);
        setDirty(false);
        setLoading(false);
        setTimeout(() => fitView({ padding: 0.25 }), 80);
      }
    };

    load();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [flowId, mode]);

  // Auto-fit when viewing, and refit on window resize
  useEffect(() => {
    if (mode !== "view") return;
    const t = setTimeout(() => fitView({ padding: 0.25 }), 80);
    const onResize = () => fitView({ padding: 0.25 });
    window.addEventListener("resize", onResize);
    return () => {
      clearTimeout(t);
      window.removeEventListener("resize", onResize);
    };
  }, [mode, nodes.length, edges.length, fitView]);

  // --- Add template
  const handleTemplateSelect = ({ name, type, body, buttons = [] }) => {
    if (readonly) return;
    const id = uuidv4();
    const newNode = {
      id,
      position: { x: Math.random() * 400 + 100, y: Math.random() * 300 + 100 },
      type: "customBubble",
      data: {
        templateName: name || "Untitled",
        templateType: type || "text_template",
        messageBody: body || "Message body preview...",
        triggerButtonText: buttons[0]?.text || "",
        triggerButtonType: "cta",
        useProfileName: false,
        profileNameSlot: 1,
        buttons: buttons.map((btn, idx) => ({
          text: btn.text || "",
          type: btn.type || "QUICK_REPLY",
          subType: btn.subType || "",
          value: btn.parameterValue || "",
          targetNodeId: null,
          index: idx,
        })),
      },
    };
    setDirty(true);
    setNodes(nds => [...nds, newNode]);
    setShowPicker(false);
    toast.success(
      `‚úÖ Step added with ${type?.replace("_", " ") || "template"}`
    );
    setTimeout(() => fitView({ padding: 0.25 }), 50);
  };

  // --- Connection rules
  const isValidConnection = useCallback(
    params => {
      if (!params?.source || !params?.sourceHandle) return false;
      const duplicate = edges.some(
        e =>
          e.source === params.source && e.sourceHandle === params.sourceHandle
      );
      return !duplicate;
    },
    [edges]
  );

  const onConnect = useCallback(
    params => {
      if (readonly) return;
      setDirty(true);
      const label = params.sourceHandle || "";

      setEdges(eds =>
        addEdge(
          {
            ...params,
            id: uuidv4(),
            type: "smart",
            animated: true,
            style: { stroke: "#9333ea" },
            markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
            label,
          },
          eds
        )
      );

      setNodes(nds =>
        nds.map(node => {
          if (node.id !== params.source) return node;
          const sourceHandle = params.sourceHandle || "";
          const updatedButtons = [...(node.data.buttons || [])];

          const idx = updatedButtons.findIndex(
            b =>
              (b.text || "").toLowerCase().trim() ===
              sourceHandle.toLowerCase().trim()
          );

          if (idx >= 0) {
            updatedButtons[idx] = {
              ...updatedButtons[idx],
              targetNodeId: params.target,
            };
          } else {
            const free = updatedButtons.findIndex(b => !b.targetNodeId);
            if (free >= 0)
              updatedButtons[free] = {
                ...updatedButtons[free],
                targetNodeId: params.target,
              };
          }

          return { ...node, data: { ...node.data, buttons: updatedButtons } };
        })
      );
    },
    [readonly, setEdges, setNodes]
  );

  // --- Keyboard UX
  useEffect(() => {
    const onKey = e => {
      if (readonly) return;
      if (e.key === "Delete" || e.key === "Backspace") {
        setDirty(true);
        setNodes(nds => nds.filter(n => !n.selected));
        setEdges(eds => eds.filter(ed => !ed.selected));
      }
      if (e.key === "Escape") {
        setNodes(nds => nds.map(n => ({ ...n, selected: false })));
        setEdges(eds => eds.map(ed => ({ ...ed, selected: false })));
      }
    };
    window.addEventListener("keydown", onKey);
    return () => window.removeEventListener("keydown", onKey);
  }, [readonly, setNodes, setEdges]);

  // --- Auto layout (dagre)
  const applyLayout = useCallback(
    (direction = "LR") => {
      const g = new dagre.graphlib.Graph();
      g.setGraph({
        rankdir: direction,
        nodesep: 50,
        ranksep: 90,
        marginx: 20,
        marginy: 20,
      });
      g.setDefaultEdgeLabel(() => ({}));

      nodes.forEach(n => {
        const width = n?.measured?.width || NODE_DEFAULT.width;
        const height = n?.measured?.height || NODE_DEFAULT.height;
        g.setNode(n.id, { width, height });
      });
      edges.forEach(e => g.setEdge(e.source, e.target));

      dagre.layout(g);

      const laidOut = nodes.map(n => {
        const { x, y } = g.node(n.id);
        const width = n?.measured?.width || NODE_DEFAULT.width;
        const height = n?.measured?.height || NODE_DEFAULT.height;
        return { ...n, position: { x: x - width / 2, y: y - height / 2 } };
      });

      setDirty(true);
      setNodes(laidOut);
      setTimeout(() => fitView({ padding: 0.25 }), 50);
    },
    [nodes, edges, setNodes, fitView]
  );

  // --- Build payload (draft by default; publish is separate)
  const buildPayload = () => {
    const transformedNodes = nodes
      .filter(n => n?.data?.templateName)
      .map(node => ({
        Id: node.id,
        TemplateName: node.data.templateName || "Untitled",
        TemplateType: node.data.templateType || "text_template",
        MessageBody: node.data.messageBody || "",
        PositionX: node.position?.x || 0,
        PositionY: node.position?.y || 0,
        TriggerButtonText: node.data.triggerButtonText || "",
        TriggerButtonType: node.data.triggerButtonType || "cta",
        RequiredTag: node.data.requiredTag || "",
        RequiredSource: node.data.requiredSource || "",
        UseProfileName: !!node.data.useProfileName,
        ProfileNameSlot:
          typeof node.data.profileNameSlot === "number" &&
          node.data.profileNameSlot > 0
            ? node.data.profileNameSlot
            : 1,
        Buttons: (node.data.buttons || [])
          .filter(btn => (btn.text || "").trim().length > 0)
          .map((btn, idx) => ({
            Text: (btn.text || "").trim(),
            Type: btn.type || "QUICK_REPLY",
            SubType: btn.subType || "",
            Value: btn.value || "",
            TargetNodeId: btn.targetNodeId || null,
            Index: typeof btn.index === "number" ? btn.index : idx,
          })),
      }));

    const transformedEdges = edges.map(edge => ({
      FromNodeId: edge.source,
      ToNodeId: edge.target,
      SourceHandle: edge.sourceHandle || "",
    }));

    return {
      FlowName: flowName || "Untitled",
      IsPublished: false, // always draft; publish is explicit
      Nodes: transformedNodes,
      Edges: transformedEdges,
    };
  };

  // --- Save Draft
  const handleSaveDraft = async () => {
    try {
      setSaving(true);
      const payload = buildPayload();

      if (mode === "edit" && flowId) {
        const res = await updateVisualFlow(flowId, payload);
        if (res?.needsRepublish) setRepublishNeeded(true);
        toast.success("‚úÖ Flow updated (draft)");
      } else {
        const res = await saveVisualFlow(payload); // create new draft
        if (res?.flowId) {
          navigate(`/app/cta-flow/flow-manager?tab=draft`);
          return;
        }
        toast.success("‚úÖ Flow saved (draft)");
      }
      setDirty(false);
      navigate(`/app/cta-flow/flow-manager?tab=draft`);
    } catch (error) {
      console.error("‚ùå Save draft failed: ", error);
      if (error?.response?.status === 409) {
        const camps = error?.response?.data?.campaigns || [];
        setLockInfo({ locked: true, campaigns: camps });
        setForkModalOpen(true);
        setReadonly(true);
      } else {
        toast.error("‚ùå Failed to save draft");
      }
    } finally {
      setSaving(false);
    }
  };

  // --- Publish / Republish
  const handlePublish = async () => {
    try {
      setSaving(true);

      if (mode === "edit" && flowId) {
        const payload = buildPayload();
        await updateVisualFlow(flowId, payload);
        await publishFlow(flowId);
        setRepublishNeeded(false);
        setIsPublished(true);
        setDirty(false);
        toast.success("‚úÖ Flow published");
        navigate("/app/cta-flow/flow-manager?tab=published");
        return;
      }

      // NEW flow: create as draft, get id, then publish that id
      const createPayload = { ...buildPayload(), IsPublished: false };
      const res = await saveVisualFlow(createPayload);
      const newId = res?.flowId;

      if (newId) {
        await publishFlow(newId);
        toast.success("‚úÖ Flow created & published");
        navigate("/app/cta-flow/flow-manager?tab=published");
        return;
      }

      toast.success("‚úÖ Flow created (but publish step uncertain)");
      navigate("/app/cta-flow/flow-manager?tab=published");
    } catch (error) {
      console.error("‚ùå Publish failed: ", error);
      if (error?.response?.status === 409) {
        const camps = error?.response?.data?.campaigns || [];
        setLockInfo({ locked: true, campaigns: camps });
        setForkModalOpen(true);
        setReadonly(true);
      } else {
        toast.error("‚ùå Failed to publish");
      }
    } finally {
      setSaving(false);
    }
  };

  const defaultEdgeOptions = useMemo(
    () => ({
      type: "smart",
      animated: true,
      style: { stroke: "#9333ea" },
      markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
    }),
    []
  );

  return (
    <div className="p-6 relative">
      {/* Page-level spinner overlay */}
      {(loading || saving) && (
        <div className="absolute inset-0 z-[60] bg-white/70 backdrop-blur-[1px] grid place-items-center">
          <div className="flex items-center gap-3 px-4 py-2 bg-white rounded-xl shadow border">
            <svg
              className="animate-spin h-5 w-5 text-purple-600"
              viewBox="0 0 24 24"
            >
              <circle
                className="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                strokeWidth="4"
                fill="none"
              />
              <path
                className="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
              />
            </svg>
            <span className="text-sm text-gray-700">
              {loading ? "Loading..." : "Working..."}
            </span>
          </div>
        </div>
      )}

      {/* ===== Header: title on left, ALL actions to top-right ===== */}
      <div className="flex flex-wrap items-center justify-between gap-3 mb-4">
        {/* Left: Title + Name */}
        <div className="flex items-center gap-3 min-w-0">
          <h2 className="text-xl sm:text-2xl font-bold text-gray-900 tracking-tight">
            üß† CTA Flow Visual Builder
          </h2>

          {/* Flow name input / badge inline with title */}
          {readonly ? (
            <span className="truncate max-w-[40ch] px-2 py-1 rounded-md bg-purple-50 text-purple-700 text-sm font-medium">
              {flowName || "Untitled Flow"}
            </span>
          ) : (
            <input
              id="flowName"
              name="flowName"
              ref={flowNameRef}
              value={flowName}
              onChange={e => {
                setFlowName(e.target.value);
                setDirty(true);
              }}
              placeholder="Add flow name"
              className="truncate max-w-[40ch] border border-gray-300 px-3 py-1.5 rounded-md shadow-sm text-sm focus:outline-none focus:ring-2 focus:ring-purple-500/50"
            />
          )}
        </div>

        {/* Right: Toolbar */}
        <div className="flex flex-wrap items-center gap-2">
          {/* Back / Manage ‚Äî keep both as small, neutral actions */}
          <button
            onClick={goBackToManager}
            className="px-3 py-2 rounded-md text-sm border border-gray-300 text-gray-700 bg-white hover:bg-gray-50"
            title={`Back to ${
              backTab === "published" ? "Published" : "Drafts"
            }`}
            disabled={saving}
          >
            ‚Üê Back to {backTab === "published" ? "Published" : "Drafts"}
          </button>

          <button
            onClick={() =>
              navigate(`/app/cta-flow/flow-manager?tab=${backTab}`)
            }
            className="px-3 py-2 rounded-md text-sm border border-gray-300 text-gray-700 bg-white hover:bg-gray-50"
            title="Manage all flows"
            disabled={saving}
          >
            ‚ñ§ Manage Flows
          </button>

          {/* Primary actions (hidden in readonly) */}
          {!readonly && (
            <>
              <button
                onClick={() => setShowPicker(true)}
                className="px-3 py-2 rounded-md text-sm bg-purple-600 text-white shadow hover:bg-purple-700"
                disabled={saving}
              >
                ‚ûï Add Step
              </button>

              <button
                onClick={handleSaveDraft}
                className="px-3 py-2 rounded-md text-sm bg-gray-800 text-white hover:bg-gray-900 disabled:opacity-50"
                disabled={saving}
              >
                üíæ Save Draft
              </button>

              <button
                onClick={handlePublish}
                className="px-3 py-2 rounded-md text-sm bg-green-600 text-white hover:bg-green-700 disabled:opacity-50"
                disabled={saving}
              >
                üöÄ {isPublished ? "Republish" : "Publish"}
              </button>
            </>
          )}
        </div>
      </div>
      {/* üîß CHANGED: removed ‚Äú‚ûï Add New Flow‚Äù from header; all buttons are now on the right */}

      {/* Republish banner (kept for clarity) */}
      {!readonly && mode === "edit" && republishNeeded && (
        <div className="mb-3 rounded-md border bg-amber-50 text-amber-800 px-3 py-2 text-sm flex items-center justify-between">
          <div>
            Changes saved as <span className="font-semibold">draft</span>. Click{" "}
            <span className="font-semibold">Republish</span> to make them live.
          </div>
          <button
            onClick={handlePublish}
            className="px-3 py-1 rounded bg-amber-600 text-white hover:bg-amber-700 text-xs"
            disabled={saving}
          >
            Republish
          </button>
        </div>
      )}

      {/* Canvas */}
      <div className="h-[70vh] border rounded-xl bg-gray-50 relative">
        {/* Minimap + tools */}
        <div className="absolute bottom-5 right-4 z-50 flex gap-2">
          <button
            onClick={() => setShowMiniMap(prev => !prev)}
            className="bg-purple-600 text-white p-2 rounded-full shadow hover:bg-purple-700"
            title={showMiniMap ? "Hide MiniMap" : "Show MiniMap"}
          >
            {showMiniMap ? <Minus size={15} /> : <Eye size={15} />}
          </button>

          <div className="flex items-center gap-2 bg-white/90 px-2 py-1 rounded-full border">
            <button
              onClick={() => fitView({ padding: 0.25 })}
              className="text-xs px-2 py-1 rounded hover:bg-gray-100 font-medium"
              title="Fit to screen"
            >
              Fit
            </button>
            <button
              onClick={() => zoomIn()}
              className="text-xs px-2 py-1 rounded hover:bg-gray-100"
              title="Zoom In"
            >
              +
            </button>
            <button
              onClick={() => zoomOut()}
              className="text-xs px-2 py-1 rounded hover:bg-gray-100"
              title="Zoom Out"
            >
              ‚àí
            </button>

            {!readonly && (
              <>
                <button
                  onClick={() => applyLayout("LR")}
                  className="text-xs px-2 py-1 rounded hover:bg-gray-100"
                  title="Auto-layout (Left‚ÜíRight)"
                >
                  Auto TB
                </button>
                <button
                  onClick={() => applyLayout("TB")}
                  className="text-xs px-2 py-1 rounded hover:bg-gray-100"
                  title="Auto-layout (Top‚ÜíBottom)"
                >
                  Auto LR
                </button>
              </>
            )}
          </div>
        </div>

        <ReactFlow
          nodes={nodes}
          edges={edges}
          onNodesChange={onNodesChange}
          onEdgesChange={onEdgesChange}
          onConnect={onConnect}
          onEdgeClick={(e, edge) => {
            if (!readonly) {
              setDirty(true);
              setEdges(eds => eds.filter(ed => ed.id !== edge.id));
            }
          }}
          nodeTypes={nodeTypes}
          edgeTypes={edgeTypes}
          fitView
          fitViewOptions={{ padding: 0.25 }}
          defaultEdgeOptions={defaultEdgeOptions}
          connectionMode={ConnectionMode.Strict}
          isValidConnection={isValidConnection}
          snapToGrid
          snapGrid={[GRID, GRID]}
          panOnScroll
          zoomOnPinch
          panOnDrag={[1, 2]}
          selectionOnDrag
          nodesDraggable={!readonly}
          nodesConnectable={!readonly}
          elementsSelectable={!readonly}
        >
          {showMiniMap && (
            <MiniMap
              nodeColor="#9333ea"
              nodeStrokeWidth={2}
              maskColor="rgba(255,255,255,0.6)"
            />
          )}
          <Controls />
          <Background variant="dots" gap={GRID} size={1} />
        </ReactFlow>
      </div>

      {/* üîß CHANGED: Footer actions removed (buttons now live in header) */}

      {/* Fork modal: when published & attached */}
      {forkModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          <div
            className="absolute inset-0 bg-black/40"
            onClick={() => setForkModalOpen(false)}
          />
          <div
            role="dialog"
            aria-modal="true"
            className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
          >
            <div className="flex items-start gap-3 mb-4">
              <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
                ‚ö†Ô∏è
              </div>
              <div>
                <h3 className="text-lg font-semibold text-gray-900">
                  Editing is blocked for this flow
                </h3>
                <p className="text-sm text-gray-600">
                  This flow is <span className="font-medium">published</span>{" "}
                  and attached to active campaign(s). To make changes, create a{" "}
                  <span className="font-medium">new draft version</span>.
                </p>
              </div>
            </div>

            <div className="max-h-60 overflow-auto rounded-lg border divide-y mb-4">
              {lockInfo.campaigns.map(c => (
                <div key={c.id} className="p-3 text-sm">
                  <div className="flex items-center justify-between">
                    <div className="font-semibold text-gray-900">{c.name}</div>
                    <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-700">
                      {c.status || "‚Äî"}
                    </span>
                  </div>
                  <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
                    <div>
                      Created:{" "}
                      <span className="font-medium text-gray-800">
                        {c.createdAt
                          ? new Date(c.createdAt).toLocaleString("en-IN")
                          : "‚Äî"}
                      </span>
                    </div>
                    <div>
                      Created by:{" "}
                      <span className="font-medium text-gray-800">
                        {c.createdBy || "‚Äî"}
                      </span>
                    </div>
                    <div>
                      Scheduled:{" "}
                      <span className="font-medium text-gray-800">
                        {c.scheduledAt
                          ? new Date(c.scheduledAt).toLocaleString("en-IN")
                          : "‚Äî"}
                      </span>
                    </div>
                    <div>
                      First sent:{" "}
                      <span className="font-medium text-gray-800">
                        {c.firstSentAt
                          ? new Date(c.firstSentAt).toLocaleString("en-IN")
                          : "‚Äî"}
                      </span>
                    </div>
                  </div>
                </div>
              ))}
              {lockInfo.campaigns.length === 0 && (
                <div className="p-3 text-sm text-gray-600">
                  Could not load campaign details. You can still create a new
                  draft version.
                </div>
              )}
            </div>

            <div className="flex justify-end gap-2">
              <button
                className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
                onClick={() => setForkModalOpen(false)}
              >
                Close
              </button>
              <button
                onClick={async () => {
                  try {
                    if (!flowId) return;
                    const { flowId: newId } = await forkFlow(flowId);
                    setForkModalOpen(false);
                    toast.success("‚úÖ New draft version created");
                    navigate(
                      `/app/cta-flow/visual-builder?id=${newId}&mode=edit`
                    );
                  } catch (e) {
                    console.error(e);
                    toast.error("‚ùå Failed to create draft copy");
                  }
                }}
                className="px-3 py-2 text-sm rounded bg-purple-600 text-white hover:bg-purple-700"
              >
                Create new draft version
              </button>
            </div>
          </div>
        </div>
      )}

      <TemplatePickerModal
        open={showPicker}
        onClose={() => setShowPicker(false)}
        onSelect={handleTemplateSelect}
      />
    </div>
  );
}

export default function CTAFlowVisualBuilder() {
  return (
    <ReactFlowProvider>
      <CTAFlowVisualBuilderInner />
    </ReactFlowProvider>
  );
}

// // src/pages/CTAFlowVisualBuilder/CTAFlowVisualBuilder.jsx
// import React, {
//   useCallback,
//   useState,
//   useEffect,
//   useMemo,
//   useRef,
// } from "react";
// import {
//   ReactFlow,
//   ReactFlowProvider,
//   Background,
//   Controls,
//   MiniMap,
//   useNodesState,
//   useEdgesState,
//   addEdge,
//   MarkerType,
//   ConnectionMode,
//   useReactFlow,
// } from "@xyflow/react";
// import "@xyflow/react/dist/style.css";
// import { Eye, Minus } from "lucide-react";
// import { useSearchParams, useNavigate } from "react-router-dom";
// import TemplatePickerModal from "./components/TemplatePickerModal";
// import FlowNodeBubble from "./components/FlowNodeBubble";
// import {
//   saveVisualFlow,
//   getVisualFlowById,
//   updateVisualFlow,
//   publishFlow,
//   forkFlow,
//   getFlowUsage,
// } from "./ctaFlowVisualApi";
// import { v4 as uuidv4 } from "uuid";
// import { toast } from "react-toastify";
// import dagre from "dagre";
// import SmartLabeledEdge from "./components/edges/SmartLabeledEdge";

// const GRID = 16;
// const NODE_DEFAULT = { width: 260, height: 140 };

// function CTAFlowVisualBuilderInner() {
//   const [nodes, setNodes, onNodesChange] = useNodesState([]);
//   const [edges, setEdges, onEdgesChange] = useEdgesState([]);
//   const nodesRef = useRef([]);
//   const [showPicker, setShowPicker] = useState(false);
//   const [flowName, setFlowName] = useState("");
//   const flowNameRef = useRef(null);
//   const [showMiniMap, setShowMiniMap] = useState(false);
//   const [readonly, setReadonly] = useState(false);

//   // policy state
//   const [isPublished, setIsPublished] = useState(false);
//   const [republishNeeded, setRepublishNeeded] = useState(false);
//   const [lockInfo, setLockInfo] = useState({ locked: false, campaigns: [] });
//   const [forkModalOpen, setForkModalOpen] = useState(false);

//   // async state
//   const [saving, setSaving] = useState(false);
//   const [loading, setLoading] = useState(false);

//   const [dirty, setDirty] = useState(false);

//   const [searchParams] = useSearchParams();
//   const navigate = useNavigate();
//   const { fitView, zoomIn, zoomOut } = useReactFlow();

//   const mode = searchParams.get("mode"); // 'edit' | 'view' | null
//   const flowId = searchParams.get("id");
//   const visualDebug = true;

//   // figure out source tab for Back button
//   const fromTab = (searchParams.get("from") || "draft").toLowerCase();
//   const backTab = fromTab === "published" ? "published" : "draft";

//   const goBackToManager = useCallback(() => {
//     if (!readonly && dirty) {
//       const ok = window.confirm("You have unsaved changes. Leave this page?");
//       if (!ok) return;
//     }
//     navigate(`/app/cta-flow/flow-manager?tab=${backTab}`);
//   }, [readonly, dirty, backTab, navigate]);

//   useEffect(() => {
//     nodesRef.current = [...nodes];
//   }, [nodes]);

//   // warn on unload if dirty
//   useEffect(() => {
//     const onBeforeUnload = e => {
//       if (!dirty) return;
//       e.preventDefault();
//       e.returnValue = "";
//     };
//     window.addEventListener("beforeunload", onBeforeUnload);
//     return () => window.removeEventListener("beforeunload", onBeforeUnload);
//   }, [dirty]);

//   // --- Node helpers
//   const handleDeleteNode = useCallback(
//     nodeId => {
//       if (readonly) return;
//       setDirty(true);
//       setNodes(nds => nds.filter(n => n.id !== nodeId));
//       setEdges(eds =>
//         eds.filter(e => e.source !== nodeId && e.target !== nodeId)
//       );
//     },
//     [readonly, setNodes, setEdges]
//   );

//   const handleNodeDataChange = useCallback(
//     (nodeId, newData) => {
//       setDirty(true);
//       setNodes(nds =>
//         nds.map(n =>
//           n.id === nodeId ? { ...n, data: { ...n.data, ...newData } } : n
//         )
//       );
//     },
//     [setNodes]
//   );

//   const nodeTypes = useMemo(
//     () => ({
//       customBubble: props => (
//         <FlowNodeBubble
//           {...props}
//           onDelete={handleDeleteNode}
//           onDataChange={newData => handleNodeDataChange(props.id, newData)}
//           readonly={readonly}
//           visualDebug={visualDebug}
//         />
//       ),
//     }),
//     [handleDeleteNode, readonly, visualDebug, handleNodeDataChange]
//   );

//   const edgeTypes = useMemo(() => ({ smart: SmartLabeledEdge }), []);

//   // --- Load / Bootstrap + policy checks
//   useEffect(() => {
//     const load = async () => {
//       setLoading(true);
//       if (mode === "edit" || mode === "view") {
//         try {
//           const data = await getVisualFlowById(flowId);

//           const builtNodes = (data.nodes || []).map((node, index) => ({
//             id: node.id,
//             type: "customBubble",
//             position: {
//               x: node.positionX ?? 120 + index * 120,
//               y: node.positionY ?? 150 + (index % 5) * 60,
//             },
//             data: {
//               templateName: node.templateName,
//               templateType: node.templateType,
//               messageBody: node.messageBody,
//               triggerButtonText: node.triggerButtonText || "",
//               triggerButtonType: node.triggerButtonType || "cta",
//               requiredTag: node.requiredTag || "",
//               requiredSource: node.requiredSource || "",
//               useProfileName: !!node.useProfileName,
//               profileNameSlot:
//                 typeof node.profileNameSlot === "number" &&
//                 node.profileNameSlot > 0
//                   ? node.profileNameSlot
//                   : 1,
//               buttons: (node.buttons || []).map((btn, i) => ({
//                 text: btn.text,
//                 type: btn.type,
//                 subType: btn.subType,
//                 value: btn.value,
//                 targetNodeId: btn.targetNodeId || null,
//                 index: typeof btn.index === "number" ? btn.index : i,
//               })),
//             },
//           }));

//           const builtEdges = (data.edges || []).map(edge => ({
//             id: `e-${edge.fromNodeId}-${edge.toNodeId}-${
//               edge.sourceHandle || "h"
//             }`,
//             source: edge.fromNodeId,
//             target: edge.toNodeId,
//             sourceHandle: edge.sourceHandle || null,
//             type: "smart",
//             animated: true,
//             style: { stroke: "#9333ea" },
//             markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
//             label: edge.sourceHandle || "",
//           }));

//           const nodesWithIncoming = new Set(builtEdges.map(e => e.target));
//           const nodesWithWarnings = builtNodes.map(node => ({
//             ...node,
//             data: {
//               ...node.data,
//               isUnreachable: false,
//               hasNoIncoming: !nodesWithIncoming.has(node.id),
//             },
//           }));

//           setNodes(nodesWithWarnings);
//           setEdges(builtEdges);
//           setFlowName(data.flowName || "Untitled Flow");
//           setIsPublished(!!data.isPublished);
//           setDirty(false);

//           // policy: if editing a published flow, check attachment
//           if (mode === "edit" && data.isPublished) {
//             try {
//               const usage = await getFlowUsage(flowId);
//               if (usage?.campaigns?.length > 0) {
//                 setLockInfo({ locked: true, campaigns: usage.campaigns });
//                 setForkModalOpen(true);
//                 setReadonly(true);
//               } else {
//                 setReadonly(false);
//               }
//             } catch {
//               setLockInfo({ locked: true, campaigns: [] });
//               setForkModalOpen(true);
//               setReadonly(true);
//             }
//           } else {
//             setReadonly(mode === "view");
//           }

//           // initial fit
//           setTimeout(() => fitView({ padding: 0.25 }), 80);
//         } catch {
//           toast.error("‚ùå Failed to load flow");
//         } finally {
//           setLoading(false);
//         }
//       } else {
//         // creating new flow
//         setNodes([]);
//         setEdges([]);
//         setFlowName("Untitled Flow");
//         setIsPublished(false);
//         setReadonly(false);
//         setDirty(false);
//         setLoading(false);
//         setTimeout(() => fitView({ padding: 0.25 }), 80);
//       }
//     };

//     load();
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, [flowId, mode]);

//   // Auto-fit when viewing, and refit on window resize
//   useEffect(() => {
//     if (mode !== "view") return;
//     const t = setTimeout(() => fitView({ padding: 0.25 }), 80);
//     const onResize = () => fitView({ padding: 0.25 });
//     window.addEventListener("resize", onResize);
//     return () => {
//       clearTimeout(t);
//       window.removeEventListener("resize", onResize);
//     };
//   }, [mode, nodes.length, edges.length, fitView]);

//   // --- Add template
//   const handleTemplateSelect = ({ name, type, body, buttons = [] }) => {
//     if (readonly) return;
//     const id = uuidv4();
//     const newNode = {
//       id,
//       position: { x: Math.random() * 400 + 100, y: Math.random() * 300 + 100 },
//       type: "customBubble",
//       data: {
//         templateName: name || "Untitled",
//         templateType: type || "text_template",
//         messageBody: body || "Message body preview...",
//         triggerButtonText: buttons[0]?.text || "",
//         triggerButtonType: "cta",
//         useProfileName: false,
//         profileNameSlot: 1,
//         buttons: buttons.map((btn, idx) => ({
//           text: btn.text || "",
//           type: btn.type || "QUICK_REPLY",
//           subType: btn.subType || "",
//           value: btn.parameterValue || "",
//           targetNodeId: null,
//           index: idx,
//         })),
//       },
//     };
//     setDirty(true);
//     setNodes(nds => [...nds, newNode]);
//     setShowPicker(false);
//     toast.success(
//       `‚úÖ Step added with ${type?.replace("_", " ") || "template"}`
//     );
//     setTimeout(() => fitView({ padding: 0.25 }), 50);
//   };

//   // --- Connection rules
//   const isValidConnection = useCallback(
//     params => {
//       if (!params?.source || !params?.sourceHandle) return false;
//       const duplicate = edges.some(
//         e =>
//           e.source === params.source && e.sourceHandle === params.sourceHandle
//       );
//       return !duplicate;
//     },
//     [edges]
//   );

//   const onConnect = useCallback(
//     params => {
//       if (readonly) return;
//       setDirty(true);
//       const label = params.sourceHandle || "";

//       setEdges(eds =>
//         addEdge(
//           {
//             ...params,
//             id: uuidv4(),
//             type: "smart",
//             animated: true,
//             style: { stroke: "#9333ea" },
//             markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
//             label,
//           },
//           eds
//         )
//       );

//       setNodes(nds =>
//         nds.map(node => {
//           if (node.id !== params.source) return node;
//           const sourceHandle = params.sourceHandle || "";
//           const updatedButtons = [...(node.data.buttons || [])];

//           const idx = updatedButtons.findIndex(
//             b =>
//               (b.text || "").toLowerCase().trim() ===
//               sourceHandle.toLowerCase().trim()
//           );

//           if (idx >= 0) {
//             updatedButtons[idx] = {
//               ...updatedButtons[idx],
//               targetNodeId: params.target,
//             };
//           } else {
//             const free = updatedButtons.findIndex(b => !b.targetNodeId);
//             if (free >= 0)
//               updatedButtons[free] = {
//                 ...updatedButtons[free],
//                 targetNodeId: params.target,
//               };
//           }

//           return { ...node, data: { ...node.data, buttons: updatedButtons } };
//         })
//       );
//     },
//     [readonly, setEdges, setNodes]
//   );

//   // --- Keyboard UX
//   useEffect(() => {
//     const onKey = e => {
//       if (readonly) return;
//       if (e.key === "Delete" || e.key === "Backspace") {
//         setDirty(true);
//         setNodes(nds => nds.filter(n => !n.selected));
//         setEdges(eds => eds.filter(ed => !ed.selected));
//       }
//       if (e.key === "Escape") {
//         setNodes(nds => nds.map(n => ({ ...n, selected: false })));
//         setEdges(eds => eds.map(ed => ({ ...ed, selected: false })));
//       }
//     };
//     window.addEventListener("keydown", onKey);
//     return () => window.removeEventListener("keydown", onKey);
//   }, [readonly, setNodes, setEdges]);

//   // --- Auto layout (dagre)
//   const applyLayout = useCallback(
//     (direction = "LR") => {
//       const g = new dagre.graphlib.Graph();
//       g.setGraph({
//         rankdir: direction,
//         nodesep: 50,
//         ranksep: 90,
//         marginx: 20,
//         marginy: 20,
//       });
//       g.setDefaultEdgeLabel(() => ({}));

//       nodes.forEach(n => {
//         const width = n?.measured?.width || NODE_DEFAULT.width;
//         const height = n?.measured?.height || NODE_DEFAULT.height;
//         g.setNode(n.id, { width, height });
//       });
//       edges.forEach(e => g.setEdge(e.source, e.target));

//       dagre.layout(g);

//       const laidOut = nodes.map(n => {
//         const { x, y } = g.node(n.id);
//         const width = n?.measured?.width || NODE_DEFAULT.width;
//         const height = n?.measured?.height || NODE_DEFAULT.height;
//         return { ...n, position: { x: x - width / 2, y: y - height / 2 } };
//       });

//       setDirty(true);
//       setNodes(laidOut);
//       setTimeout(() => fitView({ padding: 0.25 }), 50);
//     },
//     [nodes, edges, setNodes, fitView]
//   );

//   // --- Build payload (draft by default; publish is separate)
//   const buildPayload = () => {
//     const transformedNodes = nodes
//       .filter(n => n?.data?.templateName)
//       .map(node => ({
//         Id: node.id,
//         TemplateName: node.data.templateName || "Untitled",
//         TemplateType: node.data.templateType || "text_template",
//         MessageBody: node.data.messageBody || "",
//         PositionX: node.position?.x || 0,
//         PositionY: node.position?.y || 0,
//         TriggerButtonText: node.data.triggerButtonText || "",
//         TriggerButtonType: node.data.triggerButtonType || "cta",
//         RequiredTag: node.data.requiredTag || "",
//         RequiredSource: node.data.requiredSource || "",
//         UseProfileName: !!node.data.useProfileName,
//         ProfileNameSlot:
//           typeof node.data.profileNameSlot === "number" &&
//           node.data.profileNameSlot > 0
//             ? node.data.profileNameSlot
//             : 1,
//         Buttons: (node.data.buttons || [])
//           .filter(btn => (btn.text || "").trim().length > 0)
//           .map((btn, idx) => ({
//             Text: (btn.text || "").trim(),
//             Type: btn.type || "QUICK_REPLY",
//             SubType: btn.subType || "",
//             Value: btn.value || "",
//             TargetNodeId: btn.targetNodeId || null,
//             Index: typeof btn.index === "number" ? btn.index : idx,
//           })),
//       }));

//     const transformedEdges = edges.map(edge => ({
//       FromNodeId: edge.source,
//       ToNodeId: edge.target,
//       SourceHandle: edge.sourceHandle || "",
//     }));

//     return {
//       FlowName: flowName || "Untitled",
//       IsPublished: false, // always draft; publish is explicit
//       Nodes: transformedNodes,
//       Edges: transformedEdges,
//     };
//   };

//   // --- Save Draft (then go to Drafts tab)
//   const handleSaveDraft = async () => {
//     try {
//       setSaving(true);
//       const payload = buildPayload();

//       if (mode === "edit" && flowId) {
//         const res = await updateVisualFlow(flowId, payload);
//         if (res?.needsRepublish) setRepublishNeeded(true);
//         toast.success("‚úÖ Flow updated (draft)");
//       } else {
//         const res = await saveVisualFlow(payload); // create new draft
//         if (res?.flowId) {
//           // move the user to manager drafts list
//           navigate(`/app/cta-flow/flow-manager?tab=draft`);
//           return; // stop further state updates in this screen
//         }
//         toast.success("‚úÖ Flow saved (draft)");
//       }
//       setDirty(false);
//       navigate(`/app/cta-flow/flow-manager?tab=draft`);
//     } catch (error) {
//       console.error("‚ùå Save draft failed: ", error);
//       if (error?.response?.status === 409) {
//         const camps = error?.response?.data?.campaigns || [];
//         setLockInfo({ locked: true, campaigns: camps });
//         setForkModalOpen(true);
//         setReadonly(true);
//       } else {
//         toast.error("‚ùå Failed to save draft");
//       }
//     } finally {
//       setSaving(false);
//     }
//   };

//   // --- Publish / Republish (on new ‚Üí create then publish) then go to Published tab
//   const handlePublish = async () => {
//     try {
//       setSaving(true);

//       if (mode === "edit" && flowId) {
//         const payload = buildPayload();
//         await updateVisualFlow(flowId, payload);
//         await publishFlow(flowId);
//         setRepublishNeeded(false);
//         setIsPublished(true);
//         setDirty(false);
//         toast.success("‚úÖ Flow published");
//         navigate("/app/cta-flow/flow-manager?tab=published");
//         return;
//       }

//       // NEW flow: create as draft, get id, then publish that id
//       const createPayload = { ...buildPayload(), IsPublished: false };
//       const res = await saveVisualFlow(createPayload);
//       const newId = res?.flowId;

//       if (newId) {
//         await publishFlow(newId);
//         toast.success("‚úÖ Flow created & published");
//         navigate("/app/cta-flow/flow-manager?tab=published");
//         return;
//       }

//       // fallback
//       toast.success("‚úÖ Flow created (but publish step uncertain)");
//       navigate("/app/cta-flow/flow-manager?tab=published");
//     } catch (error) {
//       console.error("‚ùå Publish failed: ", error);
//       if (error?.response?.status === 409) {
//         const camps = error?.response?.data?.campaigns || [];
//         setLockInfo({ locked: true, campaigns: camps });
//         setForkModalOpen(true);
//         setReadonly(true);
//       } else {
//         toast.error("‚ùå Failed to publish");
//       }
//     } finally {
//       setSaving(false);
//     }
//   };

//   const defaultEdgeOptions = useMemo(
//     () => ({
//       type: "smart",
//       animated: true,
//       style: { stroke: "#9333ea" },
//       markerEnd: { type: MarkerType.ArrowClosed, color: "#9333ea" },
//     }),
//     []
//   );

//   return (
//     <div className="p-6 relative">
//       {/* Page-level spinner overlay */}
//       {(loading || saving) && (
//         <div className="absolute inset-0 z-[60] bg-white/70 backdrop-blur-[1px] grid place-items-center">
//           <div className="flex items-center gap-3 px-4 py-2 bg-white rounded-xl shadow border">
//             <svg
//               className="animate-spin h-5 w-5 text-purple-600"
//               viewBox="0 0 24 24"
//             >
//               <circle
//                 className="opacity-25"
//                 cx="12"
//                 cy="12"
//                 r="10"
//                 stroke="currentColor"
//                 strokeWidth="4"
//                 fill="none"
//               />
//               <path
//                 className="opacity-75"
//                 fill="currentColor"
//                 d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
//               />
//             </svg>
//             <span className="text-sm text-gray-700">
//               {loading ? "Loading..." : "Working..."}
//             </span>
//           </div>
//         </div>
//       )}

//       {/* Header */}
//       <div className="flex flex-wrap items-center justify-between gap-3 mb-4">
//         <div className="flex items-center gap-2">
//           <button
//             onClick={goBackToManager}
//             className="bg-white border border-gray-300 text-gray-700 px-3 py-2 rounded-md shadow-sm hover:bg-gray-50 text-sm"
//             title={`Back to ${
//               backTab === "published" ? "Published" : "Drafts"
//             }`}
//           >
//             ‚Üê Back to {backTab === "published" ? "Published" : "Drafts"}
//           </button>

//           <h2 className="text-2xl font-bold text-purple-700 ml-1">
//             üß† CTA Flow Visual Builder
//           </h2>
//         </div>

//         <div className="flex items-center gap-2">
//           {readonly ? (
//             <div className="px-3 py-2 rounded-md bg-purple-50 text-purple-700 text-sm font-medium">
//               {flowName || "Untitled Flow"}
//             </div>
//           ) : (
//             <input
//               id="flowName"
//               name="flowName"
//               ref={flowNameRef}
//               value={flowName}
//               onChange={e => {
//                 setFlowName(e.target.value);
//                 setDirty(true);
//               }}
//               placeholder="Add flow name"
//               className="border border-gray-300 px-3 py-2 rounded-md shadow-sm text-sm"
//             />
//           )}

//           {/* Always available */}
//           <button
//             onClick={() => navigate(`/app/cta-flow/visual-builder`)}
//             className="bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700 text-sm"
//             title="Create a new flow"
//             disabled={saving}
//           >
//             ‚ûï Add New Flow
//           </button>

//           {!readonly && (
//             <>
//               <button
//                 onClick={() => setShowPicker(true)}
//                 className="bg-purple-600 text-white px-4 py-2 rounded shadow hover:bg-purple-700 text-sm"
//                 disabled={saving}
//               >
//                 ‚ûï Add Step
//               </button>
//               <button
//                 onClick={goBackToManager}
//                 className="bg-white border border-purple-600 text-purple-700 font-medium text-sm px-4 py-2 rounded-md shadow-sm hover:bg-purple-50"
//                 disabled={saving}
//               >
//                 ‚Ü©Ô∏è Manage All Flows
//               </button>
//             </>
//           )}
//         </div>
//       </div>

//       {/* Republish banner */}
//       {!readonly && mode === "edit" && republishNeeded && (
//         <div className="mb-3 rounded-md border bg-amber-50 text-amber-800 px-3 py-2 text-sm flex items-center justify-between">
//           <div>
//             Changes saved as <span className="font-semibold">draft</span>. Click{" "}
//             <span className="font-semibold">Republish</span> to make them live.
//           </div>
//           <button
//             onClick={handlePublish}
//             className="px-3 py-1 rounded bg-amber-600 text-white hover:bg-amber-700 text-xs"
//             disabled={saving}
//           >
//             Republish
//           </button>
//         </div>
//       )}

//       {/* Canvas */}
//       <div className="h-[70vh] border rounded-xl bg-gray-50 relative">
//         {/* Minimap + tools */}
//         <div className="absolute bottom-5 right-4 z-50 flex gap-2">
//           <button
//             onClick={() => setShowMiniMap(prev => !prev)}
//             className="bg-purple-600 text-white p-2 rounded-full shadow hover:bg-purple-700"
//             title={showMiniMap ? "Hide MiniMap" : "Show MiniMap"}
//           >
//             {showMiniMap ? <Minus size={15} /> : <Eye size={15} />}
//           </button>

//           <div className="flex items-center gap-2 bg-white/90 px-2 py-1 rounded-full border">
//             <button
//               onClick={() => fitView({ padding: 0.25 })}
//               className="text-xs px-2 py-1 rounded hover:bg-gray-100 font-medium"
//               title="Fit to screen"
//             >
//               Fit
//             </button>
//             <button
//               onClick={() => zoomIn()}
//               className="text-xs px-2 py-1 rounded hover:bg-gray-100"
//               title="Zoom In"
//             >
//               +
//             </button>
//             <button
//               onClick={() => zoomOut()}
//               className="text-xs px-2 py-1 rounded hover:bg-gray-100"
//               title="Zoom Out"
//             >
//               ‚àí
//             </button>

//             {!readonly && (
//               <>
//                 <button
//                   onClick={() => applyLayout("LR")}
//                   className="text-xs px-2 py-1 rounded hover:bg-gray-100"
//                   title="Auto-layout (Left‚ÜíRight)"
//                 >
//                   Auto LR
//                 </button>
//                 <button
//                   onClick={() => applyLayout("TB")}
//                   className="text-xs px-2 py-1 rounded hover:bg-gray-100"
//                   title="Auto-layout (Top‚ÜíBottom)"
//                 >
//                   Auto TB
//                 </button>
//               </>
//             )}
//           </div>
//         </div>

//         <ReactFlow
//           nodes={nodes}
//           edges={edges}
//           onNodesChange={onNodesChange}
//           onEdgesChange={onEdgesChange}
//           onConnect={onConnect}
//           onEdgeClick={(e, edge) => {
//             if (!readonly) {
//               setDirty(true);
//               setEdges(eds => eds.filter(ed => ed.id !== edge.id));
//             }
//           }}
//           nodeTypes={nodeTypes}
//           edgeTypes={edgeTypes}
//           fitView
//           fitViewOptions={{ padding: 0.25 }}
//           defaultEdgeOptions={defaultEdgeOptions}
//           connectionMode={ConnectionMode.Strict}
//           isValidConnection={isValidConnection}
//           snapToGrid
//           snapGrid={[GRID, GRID]}
//           panOnScroll
//           zoomOnPinch
//           panOnDrag={[1, 2]}
//           selectionOnDrag
//           nodesDraggable={!readonly}
//           nodesConnectable={!readonly}
//           elementsSelectable={!readonly}
//         >
//           {showMiniMap && (
//             <MiniMap
//               nodeColor="#9333ea"
//               nodeStrokeWidth={2}
//               maskColor="rgba(255,255,255,0.6)"
//             />
//           )}
//           <Controls />
//           <Background variant="dots" gap={GRID} size={1} />
//         </ReactFlow>
//       </div>

//       {/* Footer actions */}
//       {!readonly && (
//         <div className="mt-6 flex flex-wrap gap-3">
//           <button
//             onClick={handleSaveDraft}
//             className="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 text-sm disabled:opacity-50"
//             disabled={saving}
//           >
//             üíæ Save Draft
//           </button>

//           <button
//             onClick={handlePublish}
//             className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm disabled:opacity-50"
//             disabled={saving}
//           >
//             üöÄ {isPublished ? "Republish" : "Publish Flow"}
//           </button>
//         </div>
//       )}

//       {/* Fork modal: when published & attached */}
//       {forkModalOpen && (
//         <div className="fixed inset-0 z-50 flex items-center justify-center">
//           <div
//             className="absolute inset-0 bg-black/40"
//             onClick={() => setForkModalOpen(false)}
//           />
//           <div
//             role="dialog"
//             aria-modal="true"
//             className="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl p-6"
//           >
//             <div className="flex items-start gap-3 mb-4">
//               <div className="shrink-0 mt-0.5 h-8 w-8 rounded-full bg-rose-50 text-rose-600 grid place-items-center">
//                 ‚ö†Ô∏è
//               </div>
//               <div>
//                 <h3 className="text-lg font-semibold text-gray-900">
//                   Editing is blocked for this flow
//                 </h3>
//                 <p className="text-sm text-gray-600">
//                   This flow is <span className="font-medium">published</span>{" "}
//                   and attached to active campaign(s). To make changes, create a{" "}
//                   <span className="font-medium">new draft version</span>.
//                 </p>
//               </div>
//             </div>

//             <div className="max-h-60 overflow-auto rounded-lg border divide-y mb-4">
//               {lockInfo.campaigns.map(c => (
//                 <div key={c.id} className="p-3 text-sm">
//                   <div className="flex items-center justify-between">
//                     <div className="font-semibold text-gray-900">{c.name}</div>
//                     <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-700">
//                       {c.status || "‚Äî"}
//                     </span>
//                   </div>
//                   <div className="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-xs text-gray-600">
//                     <div>
//                       Created:{" "}
//                       <span className="font-medium text-gray-800">
//                         {c.createdAt
//                           ? new Date(c.createdAt).toLocaleString("en-IN")
//                           : "‚Äî"}
//                       </span>
//                     </div>
//                     <div>
//                       Created by:{" "}
//                       <span className="font-medium text-gray-800">
//                         {c.createdBy || "‚Äî"}
//                       </span>
//                     </div>
//                     <div>
//                       Scheduled:{" "}
//                       <span className="font-medium text-gray-800">
//                         {c.scheduledAt
//                           ? new Date(c.scheduledAt).toLocaleString("en-IN")
//                           : "‚Äî"}
//                       </span>
//                     </div>
//                     <div>
//                       First sent:{" "}
//                       <span className="font-medium text-gray-800">
//                         {c.firstSentAt
//                           ? new Date(c.firstSentAt).toLocaleString("en-IN")
//                           : "‚Äî"}
//                       </span>
//                     </div>
//                   </div>
//                 </div>
//               ))}
//               {lockInfo.campaigns.length === 0 && (
//                 <div className="p-3 text-sm text-gray-600">
//                   Could not load campaign details. You can still create a new
//                   draft version.
//                 </div>
//               )}
//             </div>

//             <div className="flex justify-end gap-2">
//               <button
//                 className="px-3 py-2 text-sm rounded border hover:bg-gray-50"
//                 onClick={() => setForkModalOpen(false)}
//               >
//                 Close
//               </button>
//               <button
//                 onClick={async () => {
//                   try {
//                     if (!flowId) return;
//                     const { flowId: newId } = await forkFlow(flowId);
//                     setForkModalOpen(false);
//                     toast.success("‚úÖ New draft version created");
//                     navigate(
//                       `/app/cta-flow/visual-builder?id=${newId}&mode=edit`
//                     );
//                   } catch (e) {
//                     console.error(e);
//                     toast.error("‚ùå Failed to create draft copy");
//                   }
//                 }}
//                 className="px-3 py-2 text-sm rounded bg-purple-600 text-white hover:bg-purple-700"
//               >
//                 Create new draft version
//               </button>
//             </div>
//           </div>
//         </div>
//       )}

//       <TemplatePickerModal
//         open={showPicker}
//         onClose={() => setShowPicker(false)}
//         onSelect={handleTemplateSelect}
//       />
//     </div>
//   );
// }

// export default function CTAFlowVisualBuilder() {
//   return (
//     <ReactFlowProvider>
//       <CTAFlowVisualBuilderInner />
//     </ReactFlowProvider>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\CTAFlowVisualBuilder_AllFileDump.txt 
====================================================== 
 
Folder and File Content Report
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\CTAFlowLogs.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../api/axiosClient";
import { Card } from "../../components/ui/card";
import { Table, Thead, Tbody, Tr, Th, Td } fr 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\ExtrackAllFiles.bat 
====================================================== 
 
@echo off
REM This script will find all files and output their name and content into one file.
REM The output file will be named [FolderName]_AllFileDump.txt.

REM Get the current folder's name and set it as the output file name with the custom suffix
for %%I in ("%cd%") do set "outputFile=%%~nI_AllFileDump.txt"

REM Clear the output file to start fresh
> "%outputFile%" (echo Folder and File Content Report)
echo. >> "%outputFile%"

REM Loop through all files in the current directory and subdirectories
for /R . %%F in (*.*) do (
    echo ====================================================== >> "%outputFile%"
    echo FILE: %%F >> "%outputFile%"
    echo ====================================================== >> "%outputFile%"
    echo. >> "%outputFile%"
    type "%%F" >> "%outputFile%" 2>nul
    echo. >> "%outputFile%"
    echo. >> "%outputFile%"
)

echo Finished! All content has been extracted to %outputFile% 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\components\FlowNodeBubble.jsx 
====================================================== 
 
import React, { useEffect, useMemo } from "react";
import { Handle, Position } from "@xyflow/react";
import { X, MessageSquare } from "lucide-react";

const countBodyPlaceholders = body => {
  if (!body) return 0;
  const m = String(body).match(/\{\{\s*\d+\s*\}\}/g);
  return m ? m.length : 0;
};

export default function FlowNodeBubble({
  id,
  data = {},
  onDelete = () => {},
  readonly = false,
  onDataChange = () => {},
  visualDebug = false,
}) {
  const {
    templateName = "Untitled Step",
    templateType = "text_template",
    messageBody = "",
    buttons = [],
    requiredTag = "",
    requiredSource = "",
    isUnreachable = false,

    // greeting fields
    useProfileName = false,
    profileNameSlot = 1,
  } = data;

  const isTextTemplate = (templateType || "").toLowerCase() === "text_template";
  const placeholderCount = useMemo(
    () => countBodyPlaceholders(messageBody),
    [messageBody]
  );
  const canUseProfile = isTextTemplate && placeholderCount > 0;

  // keep trigger info sync'd with first button
  useEffect(() => {
    if (buttons.length > 0) {
      const triggerText = buttons[0]?.text || "";
      onDataChange({
        triggerButtonText: triggerText,
        triggerButtonType: "cta",
      });
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [buttons]);

  // clamp/disable when template/body changes
  useEffect(() => {
    if (!canUseProfile) {
      if (useProfileName || profileNameSlot != null) {
        onDataChange({ useProfileName: false, profileNameSlot: undefined });
      }
    } else if (useProfileName) {
      const clamped = Math.max(
        1,
        Math.min(profileNameSlot ?? 1, placeholderCount)
      );
      if (clamped !== (profileNameSlot ?? 1)) {
        onDataChange({ profileNameSlot: clamped });
      }
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [canUseProfile, placeholderCount]);

  return (
    <div className="bg-white shadow-md rounded-xl border border-purple-200 w-72 p-4 relative">
      {!readonly && (
        <button
          onClick={() => onDelete(id)}
          className="absolute top-1.5 right-1.5 text-red-500 hover:text-red-700"
          title="Delete this step"
          aria-label="Delete step"
        >
          <X size={16} />
        </button>
      )}

      {isUnreachable && (
        <div
          className="text-xs text-red-600 bg-red-100 px-2 py-0.5 rounded-full font-semibold mb-2 inline-block"
          title="This step has no incoming trigger. It may never run."
        >
          ‚ö†Ô∏è Unreachable Step
        </div>
      )}

      <div className="mb-2">
        <div className="flex items-center gap-2 pb-2 border-b border-gray-200">
          <MessageSquare size={16} className="text-purple-600 shrink-0" />
          <div
            className="min-w-0 truncate text-sm font-medium text-gray-900"
            title={templateName}
          >
            {templateName}
          </div>
        </div>
      </div>

      <div
        className="text-sm text-gray-700 whitespace-pre-wrap mb-3 overflow-y-auto"
        style={{ maxHeight: 180, overscrollBehavior: "contain" }}
        title={messageBody}
      >
        üí¨ {messageBody || "Message body preview..."}
      </div>

      <div className="flex flex-wrap gap-2 mb-2">
        {!!requiredTag && (
          <span className="bg-yellow-100 text-yellow-800 text-[10px] px-2 py-0.5 rounded-full font-semibold">
            üéØ Tag: {requiredTag}
          </span>
        )}
        {!!requiredSource && (
          <span className="bg-purple-100 text-purple-800 text-[10px] px-2 py-0.5 rounded-full font-semibold">
            üîó Source: {requiredSource}
          </span>
        )}
        {useProfileName && canUseProfile && (
          <span className="bg-green-100 text-green-800 text-[10px] px-2 py-0.5 rounded-full font-semibold">
            {/* render e.g. {{1}} safely as a string */}
            üë§ Profile ‚Üí {`{{${profileNameSlot}}}`}
          </span>
        )}
      </div>

      {canUseProfile && (
        <div className="mt-3 border-t pt-3">
          <div className="flex items-center justify-between">
            <label className="text-xs font-medium">
              Use WhatsApp Profile Name
            </label>
            <input
              type="checkbox"
              disabled={readonly}
              checked={!!useProfileName}
              onChange={e => {
                const checked = e.target.checked;
                if (!checked) {
                  onDataChange({
                    useProfileName: false,
                    profileNameSlot: undefined,
                  });
                } else {
                  const clamped = Math.max(
                    1,
                    Math.min(profileNameSlot ?? 1, placeholderCount)
                  );
                  onDataChange({
                    useProfileName: true,
                    profileNameSlot: clamped,
                  });
                }
              }}
            />
          </div>

          {useProfileName && (
            <div className="mt-2">
              <label className="text-xs block mb-1">Slot ({"{{n}}"})</label>
              <select
                className="w-full border rounded px-2 py-1 text-sm"
                disabled={readonly}
                value={profileNameSlot ?? 1}
                onChange={e => {
                  const n = parseInt(e.target.value, 10) || 1;
                  onDataChange({
                    profileNameSlot: Math.max(1, Math.min(n, placeholderCount)),
                  });
                }}
              >
                {Array.from(
                  { length: Math.max(placeholderCount, 1) },
                  (_, i) => i + 1
                ).map(n => (
                  <option key={n} value={n}>
                    {`{{${n}}}`}
                  </option>
                ))}
              </select>
            </div>
          )}
        </div>
      )}

      <div className="flex flex-col gap-2">
        {buttons.map((btn, index) => {
          const text = (btn.text || "").trim() || `Button ${index + 1}`;
          return (
            <div
              key={`${text}-${index}`}
              className="relative bg-purple-100 text-purple-800 text-xs px-3 py-1 rounded shadow-sm"
              title={text}
            >
              <div className="pr-6 text-center select-none">üîò {text}</div>
              <Handle
                type="source"
                position={Position.Right}
                id={text}
                title={`Drag to connect: ${text}`}
                aria-label={`Connect from ${text}`}
                style={{
                  background: "#9333ea",
                  right: "-10px",
                  top: "50%",
                  transform: "translateY(-50%)",
                  width: 16,
                  height: 16,
                  border: "2px solid #fff",
                  borderRadius: 9999,
                  boxShadow: "0 0 0 2px rgba(147,51,234,0.25)",
                  cursor: "crosshair",
                }}
              />
              <div
                style={{
                  position: "absolute",
                  right: -18,
                  top: "50%",
                  transform: "translateY(-50%)",
                  width: 36,
                  height: 28,
                  background: "transparent",
                  pointerEvents: "none",
                }}
              />
            </div>
          );
        })}
      </div>

      {buttons.length === 0 && (
        <Handle
          type="source"
          position={Position.Bottom}
          id="default"
          title="Drag to connect"
          style={{
            background: "#9333ea",
            width: 16,
            height: 16,
            border: "2px solid #fff",
            borderRadius: 9999,
            boxShadow: "0 0 0 2px rgba(147,51,234,0.25)",
          }}
        />
      )}

      <Handle
        type="target"
        position={Position.Top}
        id="incoming"
        title="Drop a connection here"
        style={{
          background: "#9333ea",
          width: 16,
          height: 16,
          border: "2px solid #fff",
          borderRadius: 9999,
          boxShadow: "0 0 0 2px rgba(147,51,234,0.25)",
        }}
      />
    </div>
  );
}

// import React, { useEffect } from "react";
// import { Handle, Position } from "@xyflow/react";
// import { X, MessageSquare } from "lucide-react";

// export default function FlowNodeBubble({
//   id,
//   data,
//   onDelete,
//   readonly,
//   onDataChange,
//   visualDebug = false, // not rendered
// }) {
//   const {
//     templateName,
//     messageBody,
//     buttons = [],
//     requiredTag,
//     requiredSource,
//     isUnreachable,
//   } = data;

//   // Keep trigger info in sync with first button
//   useEffect(() => {
//     if (buttons.length > 0 && onDataChange) {
//       const triggerText = buttons[0]?.text || "";
//       onDataChange({
//         ...data,
//         triggerButtonText: triggerText,
//         triggerButtonType: "cta",
//       });
//     }
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, [buttons]);

//   return (
//     <div className="bg-white shadow-md rounded-xl border border-purple-200 w-72 p-4 relative">
//       {/* ‚ùå Delete */}
//       {!readonly && (
//         <button
//           onClick={() => onDelete(id)}
//           className="absolute top-1.5 right-1.5 text-red-500 hover:text-red-700"
//           title="Delete this step"
//           aria-label="Delete step"
//         >
//           <X size={16} />
//         </button>
//       )}

//       {/* ‚ö†Ô∏è Warning */}
//       {isUnreachable && (
//         <div
//           className="text-xs text-red-600 bg-red-100 px-2 py-0.5 rounded-full font-semibold mb-2 inline-block"
//           title="This step has no incoming trigger. It may never run."
//         >
//           ‚ö†Ô∏è Unreachable Step
//         </div>
//       )}

//       {/* Header ‚Äî minimal (icon + name) with divider */}
//       <div className="mb-2">
//         <div className="flex items-center gap-2 pb-2 border-b border-gray-200">
//           <MessageSquare
//             size={16}
//             className="text-purple-600 shrink-0"
//             aria-hidden
//           />
//           <div
//             className="min-w-0 truncate text-sm font-medium text-gray-900"
//             title={templateName || "Untitled Step"}
//           >
//             {templateName || "Untitled Step"}
//           </div>
//         </div>
//       </div>

//       {/* üí¨ Body ‚Äî scrollable to avoid crowding */}
//       <div
//         className="text-sm text-gray-700 whitespace-pre-wrap mb-3 overflow-y-auto"
//         style={{
//           maxHeight: 180, // control the vertical footprint
//           overscrollBehavior: "contain",
//           scrollbarWidth: "thin", // Firefox
//           WebkitOverflowScrolling: "touch", // iOS momentum
//         }}
//         title={messageBody}
//       >
//         üí¨ {messageBody || "Message body preview..."}
//       </div>

//       {/* üéØ Badges */}
//       <div className="flex flex-wrap gap-2 mb-2">
//         {!!requiredTag && (
//           <span
//             className="bg-yellow-100 text-yellow-800 text-[10px] px-2 py-0.5 rounded-full font-semibold"
//             title={`Only contacts with tag "${requiredTag}" will receive this step.`}
//           >
//             üéØ Tag: {requiredTag}
//           </span>
//         )}
//         {!!requiredSource && (
//           <span
//             className="bg-purple-100 text-purple-800 text-[10px] px-2 py-0.5 rounded-full font-semibold"
//             title={`This step runs only if Source = "${requiredSource}"`}
//           >
//             üîó Source: {requiredSource}
//           </span>
//         )}
//       </div>

//       {/* üîò Buttons + source handles (no connection status UI) */}
//       <div className="flex flex-col gap-2">
//         {buttons.map((btn, index) => {
//           const text = (btn.text || "").trim() || `Button ${index + 1}`;
//           return (
//             <div
//               key={`${text}-${index}`}
//               className="relative bg-purple-100 text-purple-800 text-xs px-3 py-1 rounded shadow-sm"
//               title={text}
//             >
//               <div className="pr-6 text-center select-none">üîò {text}</div>

//               {/* Right source handle (enlarged hit area) */}
//               <Handle
//                 type="source"
//                 position={Position.Right}
//                 id={text} // keep equal to button text for mapping
//                 title={`Drag to connect: ${text}`}
//                 aria-label={`Connect from ${text}`}
//                 style={{
//                   background: "#9333ea",
//                   right: "-10px",
//                   top: "50%",
//                   transform: "translateY(-50%)",
//                   width: 16,
//                   height: 16,
//                   border: "2px solid #fff",
//                   borderRadius: 9999,
//                   boxShadow: "0 0 0 2px rgba(147,51,234,0.25)",
//                   cursor: "crosshair",
//                 }}
//               />
//               {/* Invisible larger hotspot to make grabbing easier */}
//               <div
//                 style={{
//                   position: "absolute",
//                   right: -18,
//                   top: "50%",
//                   transform: "translateY(-50%)",
//                   width: 36,
//                   height: 28,
//                   background: "transparent",
//                   pointerEvents: "none",
//                 }}
//               />
//             </div>
//           );
//         })}
//       </div>

//       {/* üü£ Fallback source if no buttons */}
//       {buttons.length === 0 && (
//         <Handle
//           type="source"
//           position={Position.Bottom}
//           id="default"
//           title="Drag to connect"
//           style={{
//             background: "#9333ea",
//             width: 16,
//             height: 16,
//             border: "2px solid #fff",
//             borderRadius: 9999,
//             boxShadow: "0 0 0 2px rgba(147,51,234,0.25)",
//           }}
//         />
//       )}

//       {/* üîµ Incoming target */}
//       <Handle
//         type="target"
//         position={Position.Top}
//         id="incoming"
//         title="Drop a connection here"
//         style={{
//           background: "#9333ea",
//           width: 16,
//           height: 16,
//           border: "2px solid #fff",
//           borderRadius: 9999,
//           boxShadow: "0 0 0 2px rgba(147,51,234,0.25)",
//         }}
//       />
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\components\TemplatePickerModal.jsx 
====================================================== 
 
// üìÑ File: TemplatePickerModal.jsx
import React, { useEffect, useState } from "react";
import axiosClient from "../../../api/axiosClient";
import { toast } from "react-toastify";

export default function TemplatePickerModal({ open, onClose, onSelect }) {
  const [templates, setTemplates] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!open) return;

    const fetchTemplates = async () => {
      setLoading(true);
      try {
        const res = await axiosClient.get(
          "/WhatsAppTemplateFetcher/get-template-all"
        );
        if (res.data.success) {
          const validTemplates = (res.data.templates || []).filter(
            t => !!t.name
          );
          setTemplates(validTemplates);
          if (validTemplates.length === 0)
            toast.warn("‚ö†Ô∏è No valid templates found");
        } else {
          toast.error("‚ùå Failed to load templates");
        }
      } catch (err) {
        console.error("‚ùå Error fetching templates:", err);
        toast.error("‚ùå Error fetching templates");
      } finally {
        setLoading(false);
      }
    };

    fetchTemplates();
  }, [open]);

  if (!open) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center">
      <div className="bg-white w-full max-w-xl rounded-xl shadow-lg p-6 overflow-y-auto max-h-[90vh]">
        <h2 className="text-xl font-semibold text-purple-700 mb-4">
          üì¶ Select WhatsApp Template
        </h2>

        {loading ? (
          <p>Loading templates...</p>
        ) : templates.length === 0 ? (
          <p className="text-gray-500">No templates available</p>
        ) : (
          <div className="space-y-4">
            {templates.map((tpl, idx) => {
              const hasImageHeader =
                Array.isArray(tpl.components) &&
                tpl.components.some(
                  c => c.type === "HEADER" && c.format === "IMAGE"
                );

              const templateType = hasImageHeader
                ? "image_template"
                : "text_template";

              return (
                <div
                  key={idx}
                  className="border p-4 rounded cursor-pointer hover:bg-gray-50"
                  onClick={() =>
                    onSelect({
                      name: tpl.name,
                      type: templateType,
                      body: tpl.body,
                      buttons: tpl.buttonParams || [],
                    })
                  }
                >
                  <div className="font-bold text-purple-600">{tpl.name}</div>
                  <div className="text-sm text-gray-700 mt-1 whitespace-pre-wrap">
                    {tpl.body}
                  </div>
                  {tpl.buttonParams?.length > 0 && (
                    <div className="mt-2 flex gap-2 flex-wrap">
                      {tpl.buttonParams.map((btn, i) => (
                        <span
                          key={i}
                          className="bg-purple-100 text-purple-800 text-xs px-3 py-1 rounded-full"
                        >
                          {btn.text}
                        </span>
                      ))}
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        )}

        <div className="mt-6 text-right">
          <button
            onClick={onClose}
            className="text-sm px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\components\edges\SmartLabeledEdge.jsx 
====================================================== 
 
import React from "react";
import {
  BaseEdge,
  EdgeLabelRenderer,
  getSmoothStepPath,
  MarkerType,
} from "@xyflow/react";

/**
 * SmartLabeledEdge
 * - Shows button text as label
 * - If nodes are horizontally close and label is long, it renders the label vertically
 * - Supports selection and your purple style
 *
 * Optional: props.data?.labelVertical = true forces vertical label
 */
export default function SmartLabeledEdge(props) {
  const {
    id,
    sourceX,
    sourceY,
    targetX,
    targetY,
    sourcePosition,
    targetPosition,
    style,
    markerEnd = { type: MarkerType.ArrowClosed, color: "#9333ea" },
    label,
    selected,
    data,
  } = props;

  const [edgePath, labelX, labelY] = getSmoothStepPath({
    sourceX,
    sourceY,
    targetX,
    targetY,
    sourcePosition,
    targetPosition,
  });

  // Heuristic: long label + nodes are close horizontally => use vertical
  const dx = Math.abs(targetX - sourceX);
  const longLabel = String(label || "").length > 12;
  const vertical = data?.labelVertical ?? (longLabel && dx < 220);

  return (
    <>
      <BaseEdge
        id={id}
        path={edgePath}
        markerEnd={markerEnd}
        style={{ stroke: "#9333ea", strokeWidth: selected ? 2 : 1.5, ...style }}
      />

      {label && (
        <EdgeLabelRenderer>
          <div
            style={{
              position: "absolute",
              transform: `translate(-50%, -50%) translate(${labelX}px, ${labelY}px)`,
              pointerEvents: "all",
            }}
          >
            <div
              title={label}
              style={{
                // vertical when needed
                writingMode: vertical ? "vertical-rl" : "horizontal-tb",
                textOrientation: vertical ? "mixed" : "upright",

                background: "#fff",
                padding: "4px 6px",
                borderRadius: 6,
                border: "1px solid #e5e7eb",
                fontSize: 10,
                color: "#374151",
                lineHeight: 1.1,
                maxHeight: vertical ? 140 : "none",
                maxWidth: vertical ? 18 : 180,
                overflow: "hidden",
                textOverflow: "ellipsis",
                whiteSpace: vertical ? "normal" : "nowrap",
                boxShadow: "0 1px 2px rgba(0,0,0,0.06)",
              }}
            >
              {label}
            </div>
          </div>
        </EdgeLabelRenderer>
      )}
    </>
  );
}
 
 
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\ExtrackAllFiles.bat 
====================================================== 
 
@echo off
REM This script will find all files and output their name and content into one file.
REM The output file will be named [FolderName]_AllFileDump.txt.

REM Get the current folder's name and set it as the output file name with the custom suffix
for %%I in ("%cd%") do set "outputFile=%%~nI_AllFileDump.txt"

REM Clear the output file to start fresh
> "%outputFile%" (echo Folder and File Content Report)
echo. >> "%outputFile%"

REM Loop through all files in the current directory and subdirectories
for /R . %%F in (*.*) do (
    echo ====================================================== >> "%outputFile%"
    echo FILE: %%F >> "%outputFile%"
    echo ====================================================== >> "%outputFile%"
    echo. >> "%outputFile%"
    type "%%F" >> "%outputFile%" 2>nul
    echo. >> "%outputFile%"
    echo. >> "%outputFile%"
)

echo Finished! All content has been extracted to %outputFile% 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\components\FlowNodeBubble.jsx 
====================================================== 
 
import React, { useEffect, useMemo } from "react";
import { Handle, Position } from "@xyflow/react";
import { X, MessageSquare } from "lucide-react";

const countBodyPlaceholders = body => {
  if (!body) return 0;
  const m = String(body).match(/\{\{\s*\d+\s*\}\}/g);
  return m ? m.length : 0;
};

export default function FlowNodeBubble({
  id,
  data = {},
  onDelete = () => {},
  readonly = false,
  onDataChange = () => {},
  visualDebug = false,
}) {
  const {
    templateName = "Untitled Step",
    templateType = "text_template",
    messageBody = "",
    buttons = [],
    requiredTag = "",
    requiredSource = "",
    isUnreachable = false,

    // greeting fields
    useProfileName = false,
    profileNameSlot = 1,
  } = data;

  const isTextTemplate = (templateType || "").toLowerCase() === "text_template";
  const placeholderCount = useMemo(
    () => countBodyPlaceholders(messageBody),
    [messageBody]
  );
  const canUseProfile = isTextTemplate && placeholderCount > 0;

  // keep trigger info sync'd with first button
  useEffect(() => {
    if (buttons.length > 0) {
      const triggerText = buttons[0]?.text || "";
      onDataChange({
        triggerButtonText: triggerText,
        triggerButtonType: "cta",
      });
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [buttons]);

  // clamp/disable when template/body changes
  useEffect(() => {
    if (!canUseProfile) {
      if (useProfileName || profileNameSlot != null) {
        onDataChange({ useProfileName: false, profileNameSlot: undefined });
      }
    } else if (useProfileName) {
      const clamped = Math.max(
        1,
        Math.min(profileNameSlot ?? 1, placeholderCount)
      );
      if (clamped !== (profileNameSlot ?? 1)) {
        onDataChange({ profileNameSlot: clamped });
      }
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [canUseProfile, placeholderCount]);

  return (
    <div className="bg-white shadow-md rounded-xl border border-purple-200 w-72 p-4 relative">
      {!readonly && (
        <button
          onClick={() => onDelete(id)}
          className="absolute top-1.5 right-1.5 text-red-500 hover:text-red-700"
          title="Delete this step"
          aria-label="Delete step"
        >
          <X size={16} />
        </button>
      )}

      {isUnreachable && (
        <div
          className="text-xs text-red-600 bg-red-100 px-2 py-0.5 rounded-full font-semibold mb-2 inline-block"
          title="This step has no incoming trigger. It may never run."
        >
          ‚ö†Ô∏è Unreachable Step
        </div>
      )}

      <div className="mb-2">
        <div className="flex items-center gap-2 pb-2 border-b border-gray-200">
          <MessageSquare size={16} className="text-purple-600 shrink-0" />
          <div
            className="min-w-0 truncate text-sm font-medium text-gray-900"
            title={templateName}
          >
            {templateName}
          </div>
        </div>
      </div>

      <div
        className="text-sm text-gray-700 whitespace-pre-wrap mb-3 overflow-y-auto"
        style={{ maxHeight: 180, overscrollBehavior: "contain" }}
        title={messageBody}
      >
        üí¨ {messageBody || "Message body preview..."}
      </div>

      <div className="flex flex-wrap gap-2 mb-2">
        {!!requiredTag && (
          <span className="bg-yellow-100 text-yellow-800 text-[10px] px-2 py-0.5 rounded-full font-semibold">
            üéØ Tag: {requiredTag}
          </span>
        )}
        {!!requiredSource && (
          <span className="bg-purple-100 text-purple-800 text-[10px] px-2 py-0.5 rounded-full font-semibold">
            üîó Source: {requiredSource}
          </span>
        )}
        {useProfileName && canUseProfile && (
          <span className="bg-green-100 text-green-800 text-[10px] px-2 py-0.5 rounded-full font-semibold">
            {/* render e.g. {{1}} safely as a string */}
            üë§ Profile ‚Üí {`{{${profileNameSlot}}}`}
          </span>
        )}
      </div>

      {canUseProfile && (
        <div className="mt-3 border-t pt-3">
          <div className="flex items-center justify-between">
            <label className="text-xs font-medium">
              Use WhatsApp Profile Name
            </label>
            <input
              type="checkbox"
              disabled={readonly}
              checked={!!useProfileName}
              onChange={e => {
                const checked = e.target.checked;
                if (!checked) {
                  onDataChange({
                    useProfileName: false,
                    profileNameSlot: undefined,
                  });
                } else {
                  const clamped = Math.max(
                    1,
                    Math.min(profileNameSlot ?? 1, placeholderCount)
                  );
                  onDataChange({
                    useProfileName: true,
                    profileNameSlot: clamped,
                  });
                }
              }}
            />
          </div>

          {useProfileName && (
            <div className="mt-2">
              <label className="text-xs block mb-1">Slot ({"{{n}}"})</label>
              <select
                className="w-full border rounded px-2 py-1 text-sm"
                disabled={readonly}
                value={profileNameSlot ?? 1}
                onChange={e => {
                  const n = parseInt(e.target.value, 10) || 1;
                  onDataChange({
                    profileNameSlot: Math.max(1, Math.min(n, placeholderCount)),
                  });
                }}
              >
                {Array.from(
                  { length: Math.max(placeholderCount, 1) },
                  (_, i) => i + 1
                ).map(n => (
                  <option key={n} value={n}>
                    {`{{${n}}}`}
                  </option>
                ))}
              </select>
            </div>
          )}
        </div>
      )}

      <div className="flex flex-col gap-2">
        {buttons.map((btn, index) => {
          const text = (btn.text || "").trim() || `Button ${index + 1}`;
          return (
            <div
              key={`${text}-${index}`}
              className="relative bg-purple-100 text-purple-800 text-xs px-3 py-1 rounded shadow-sm"
              title={text}
            >
              <div className="pr-6 text-center select-none">üîò {text}</div>
              <Handle
                type="source"
                position={Position.Right}
                id={text}
                title={`Drag to connect: ${text}`}
                aria-label={`Connect from ${text}`}
                style={{
                  background: "#9333ea",
                  right: "-10px",
                  top: "50%",
                  transform: "translateY(-50%)",
                  width: 16,
                  height: 16,
                  border: "2px solid #fff",
                  borderRadius: 9999,
                  boxShadow: "0 0 0 2px rgba(147,51,234,0.25)",
                  cursor: "crosshair",
                }}
              />
              <div
                style={{
                  position: "absolute",
                  right: -18,
                  top: "50%",
                  transform: "translateY(-50%)",
                  width: 36,
                  height: 28,
                  background: "transparent",
                  pointerEvents: "none",
                }}
              />
            </div>
          );
        })}
      </div>

      {buttons.length === 0 && (
        <Handle
          type="source"
          position={Position.Bottom}
          id="default"
          title="Drag to connect"
          style={{
            background: "#9333ea",
            width: 16,
            height: 16,
            border: "2px solid #fff",
            borderRadius: 9999,
            boxShadow: "0 0 0 2px rgba(147,51,234,0.25)",
          }}
        />
      )}

      <Handle
        type="target"
        position={Position.Top}
        id="incoming"
        title="Drop a connection here"
        style={{
          background: "#9333ea",
          width: 16,
          height: 16,
          border: "2px solid #fff",
          borderRadius: 9999,
          boxShadow: "0 0 0 2px rgba(147,51,234,0.25)",
        }}
      />
    </div>
  );
}

// import React, { useEffect } from "react";
// import { Handle, Position } from "@xyflow/react";
// import { X, MessageSquare } from "lucide-react";

// export default function FlowNodeBubble({
//   id,
//   data,
//   onDelete,
//   readonly,
//   onDataChange,
//   visualDebug = false, // not rendered
// }) {
//   const {
//     templateName,
//     messageBody,
//     buttons = [],
//     requiredTag,
//     requiredSource,
//     isUnreachable,
//   } = data;

//   // Keep trigger info in sync with first button
//   useEffect(() => {
//     if (buttons.length > 0 && onDataChange) {
//       const triggerText = buttons[0]?.text || "";
//       onDataChange({
//         ...data,
//         triggerButtonText: triggerText,
//         triggerButtonType: "cta",
//       });
//     }
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, [buttons]);

//   return (
//     <div className="bg-white shadow-md rounded-xl border border-purple-200 w-72 p-4 relative">
//       {/* ‚ùå Delete */}
//       {!readonly && (
//         <button
//           onClick={() => onDelete(id)}
//           className="absolute top-1.5 right-1.5 text-red-500 hover:text-red-700"
//           title="Delete this step"
//           aria-label="Delete step"
//         >
//           <X size={16} />
//         </button>
//       )}

//       {/* ‚ö†Ô∏è Warning */}
//       {isUnreachable && (
//         <div
//           className="text-xs text-red-600 bg-red-100 px-2 py-0.5 rounded-full font-semibold mb-2 inline-block"
//           title="This step has no incoming trigger. It may never run."
//         >
//           ‚ö†Ô∏è Unreachable Step
//         </div>
//       )}

//       {/* Header ‚Äî minimal (icon + name) with divider */}
//       <div className="mb-2">
//         <div className="flex items-center gap-2 pb-2 border-b border-gray-200">
//           <MessageSquare
//             size={16}
//             className="text-purple-600 shrink-0"
//             aria-hidden
//           />
//           <div
//             className="min-w-0 truncate text-sm font-medium text-gray-900"
//             title={templateName || "Untitled Step"}
//           >
//             {templateName || "Untitled Step"}
//           </div>
//         </div>
//       </div>

//       {/* üí¨ Body ‚Äî scrollable to avoid crowding */}
//       <div
//         className="text-sm text-gray-700 whitespace-pre-wrap mb-3 overflow-y-auto"
//         style={{
//           maxHeight: 180, // control the vertical footprint
//           overscrollBehavior: "contain",
//           scrollbarWidth: "thin", // Firefox
//           WebkitOverflowScrolling: "touch", // iOS momentum
//         }}
//         title={messageBody}
//       >
//         üí¨ {messageBody || "Message body preview..."}
//       </div>

//       {/* üéØ Badges */}
//       <div className="flex flex-wrap gap-2 mb-2">
//         {!!requiredTag && (
//           <span
//             className="bg-yellow-100 text-yellow-800 text-[10px] px-2 py-0.5 rounded-full font-semibold"
//             title={`Only contacts with tag "${requiredTag}" will receive this step.`}
//           >
//             üéØ Tag: {requiredTag}
//           </span>
//         )}
//         {!!requiredSource && (
//           <span
//             className="bg-purple-100 text-purple-800 text-[10px] px-2 py-0.5 rounded-full font-semibold"
//             title={`This step runs only if Source = "${requiredSource}"`}
//           >
//             üîó Source: {requiredSource}
//           </span>
//         )}
//       </div>

//       {/* üîò Buttons + source handles (no connection status UI) */}
//       <div className="flex flex-col gap-2">
//         {buttons.map((btn, index) => {
//           const text = (btn.text || "").trim() || `Button ${index + 1}`;
//           return (
//             <div
//               key={`${text}-${index}`}
//               className="relative bg-purple-100 text-purple-800 text-xs px-3 py-1 rounded shadow-sm"
//               title={text}
//             >
//               <div className="pr-6 text-center select-none">üîò {text}</div>

//               {/* Right source handle (enlarged hit area) */}
//               <Handle
//                 type="source"
//                 position={Position.Right}
//                 id={text} // keep equal to button text for mapping
//                 title={`Drag to connect: ${text}`}
//                 aria-label={`Connect from ${text}`}
//                 style={{
//                   background: "#9333ea",
//                   right: "-10px",
//                   top: "50%",
//                   transform: "translateY(-50%)",
//                   width: 16,
//                   height: 16,
//                   border: "2px solid #fff",
//                   borderRadius: 9999,
//                   boxShadow: "0 0 0 2px rgba(147,51,234,0.25)",
//                   cursor: "crosshair",
//                 }}
//               />
//               {/* Invisible larger hotspot to make grabbing easier */}
//               <div
//                 style={{
//                   position: "absolute",
//                   right: -18,
//                   top: "50%",
//                   transform: "translateY(-50%)",
//                   width: 36,
//                   height: 28,
//                   background: "transparent",
//                   pointerEvents: "none",
//                 }}
//               />
//             </div>
//           );
//         })}
//       </div>

//       {/* üü£ Fallback source if no buttons */}
//       {buttons.length === 0 && (
//         <Handle
//           type="source"
//           position={Position.Bottom}
//           id="default"
//           title="Drag to connect"
//           style={{
//             background: "#9333ea",
//             width: 16,
//             height: 16,
//             border: "2px solid #fff",
//             borderRadius: 9999,
//             boxShadow: "0 0 0 2px rgba(147,51,234,0.25)",
//           }}
//         />
//       )}

//       {/* üîµ Incoming target */}
//       <Handle
//         type="target"
//         position={Position.Top}
//         id="incoming"
//         title="Drop a connection here"
//         style={{
//           background: "#9333ea",
//           width: 16,
//           height: 16,
//           border: "2px solid #fff",
//           borderRadius: 9999,
//           boxShadow: "0 0 0 2px rgba(147,51,234,0.25)",
//         }}
//       />
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\components\TemplatePickerModal.jsx 
====================================================== 
 
// üìÑ File: TemplatePickerModal.jsx
import React, { useEffect, useState } from "react";
import axiosClient from "../../../api/axiosClient";
import { toast } from "react-toastify";

export default function TemplatePickerModal({ open, onClose, onSelect }) {
  const [templates, setTemplates] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!open) return;

    const fetchTemplates = async () => {
      setLoading(true);
      try {
        const res = await axiosClient.get(
          "/WhatsAppTemplateFetcher/get-template-all"
        );
        if (res.data.success) {
          const validTemplates = (res.data.templates || []).filter(
            t => !!t.name
          );
          setTemplates(validTemplates);
          if (validTemplates.length === 0)
            toast.warn("‚ö†Ô∏è No valid templates found");
        } else {
          toast.error("‚ùå Failed to load templates");
        }
      } catch (err) {
        console.error("‚ùå Error fetching templates:", err);
        toast.error("‚ùå Error fetching templates");
      } finally {
        setLoading(false);
      }
    };

    fetchTemplates();
  }, [open]);

  if (!open) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center">
      <div className="bg-white w-full max-w-xl rounded-xl shadow-lg p-6 overflow-y-auto max-h-[90vh]">
        <h2 className="text-xl font-semibold text-purple-700 mb-4">
          üì¶ Select WhatsApp Template
        </h2>

        {loading ? (
          <p>Loading templates...</p>
        ) : templates.length === 0 ? (
          <p className="text-gray-500">No templates available</p>
        ) : (
          <div className="space-y-4">
            {templates.map((tpl, idx) => {
              const hasImageHeader =
                Array.isArray(tpl.components) &&
                tpl.components.some(
                  c => c.type === "HEADER" && c.format === "IMAGE"
                );

              const templateType = hasImageHeader
                ? "image_template"
                : "text_template";

              return (
                <div
                  key={idx}
                  className="border p-4 rounded cursor-pointer hover:bg-gray-50"
                  onClick={() =>
                    onSelect({
                      name: tpl.name,
                      type: templateType,
                      body: tpl.body,
                      buttons: tpl.buttonParams || [],
                    })
                  }
                >
                  <div className="font-bold text-purple-600">{tpl.name}</div>
                  <div className="text-sm text-gray-700 mt-1 whitespace-pre-wrap">
                    {tpl.body}
                  </div>
                  {tpl.buttonParams?.length > 0 && (
                    <div className="mt-2 flex gap-2 flex-wrap">
                      {tpl.buttonParams.map((btn, i) => (
                        <span
                          key={i}
                          className="bg-purple-100 text-purple-800 text-xs px-3 py-1 rounded-full"
                        >
                          {btn.text}
                        </span>
                      ))}
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        )}

        <div className="mt-6 text-right">
          <button
            onClick={onClose}
            className="text-sm px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAFlowVisualBuilder\components\edges\SmartLabeledEdge.jsx 
====================================================== 
 
import React from "react";
import {
  BaseEdge,
  EdgeLabelRenderer,
  getSmoothStepPath,
  MarkerType,
} from "@xyflow/react";

/**
 * SmartLabeledEdge
 * - Shows button text as label
 * - If nodes are horizontally close and label is long, it renders the label vertically
 * - Supports selection and your purple style
 *
 * Optional: props.data?.labelVertical = true forces vertical label
 */
export default function SmartLabeledEdge(props) {
  const {
    id,
    sourceX,
    sourceY,
    targetX,
    targetY,
    sourcePosition,
    targetPosition,
    style,
    markerEnd = { type: MarkerType.ArrowClosed, color: "#9333ea" },
    label,
    selected,
    data,
  } = props;

  const [edgePath, labelX, labelY] = getSmoothStepPath({
    sourceX,
    sourceY,
    targetX,
    targetY,
    sourcePosition,
    targetPosition,
  });

  // Heuristic: long label + nodes are close horizontally => use vertical
  const dx = Math.abs(targetX - sourceX);
  const longLabel = String(label || "").length > 12;
  const vertical = data?.labelVertical ?? (longLabel && dx < 220);

  return (
    <>
      <BaseEdge
        id={id}
        path={edgePath}
        markerEnd={markerEnd}
        style={{ stroke: "#9333ea", strokeWidth: selected ? 2 : 1.5, ...style }}
      />

      {label && (
        <EdgeLabelRenderer>
          <div
            style={{
              position: "absolute",
              transform: `translate(-50%, -50%) translate(${labelX}px, ${labelY}px)`,
              pointerEvents: "all",
            }}
          >
            <div
              title={label}
              style={{
                // vertical when needed
                writingMode: vertical ? "vertical-rl" : "horizontal-tb",
                textOrientation: vertical ? "mixed" : "upright",

                background: "#fff",
                padding: "4px 6px",
                borderRadius: 6,
                border: "1px solid #e5e7eb",
                fontSize: 10,
                color: "#374151",
                lineHeight: 1.1,
                maxHeight: vertical ? 140 : "none",
                maxWidth: vertical ? 18 : 180,
                overflow: "hidden",
                textOverflow: "ellipsis",
                whiteSpace: vertical ? "normal" : "nowrap",
                boxShadow: "0 1px 2px rgba(0,0,0,0.06)",
              }}
            >
              {label}
            </div>
          </div>
        </EdgeLabelRenderer>
      )}
    </>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTAManagement\CTAManagement.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";

function CTAManagement() {
  const [ctas, setCtas] = useState([]);
  const [newCta, setNewCta] = useState({
    title: "",
    buttonText: "",
    buttonType: "url",
    targetUrl: "",
    description: "",
  });

  const loadCTAs = async () => {
    try {
      const res = await axiosClient.get("/ctamanagement/get-all");
      setCtas(res.data);
    } catch {
      toast.error("‚ùå Failed to load CTA definitions");
    }
  };

  const saveCTA = async () => {
    try {
      const res = await axiosClient.post("/ctamanagement/create", {
        title: newCta.title,
        buttonText: newCta.buttonText,
        buttonType: newCta.buttonType,
        targetUrl: newCta.targetUrl,
        description: newCta.description,
      });

      console.log("‚úÖ CTA Saved Response:", res.data);
      toast.success(res?.data?.message || "‚úÖ CTA saved");

      setNewCta({
        title: "",
        buttonText: "",
        buttonType: "url",
        targetUrl: "",
        description: "",
      });

      loadCTAs();
    } catch (err) {
      console.error("CTA Save Error:", err?.response?.data);
      const message = err?.response?.data?.message || "‚ùå Failed to save CTA";
      toast.error(message);
    }
  };

  useEffect(() => {
    loadCTAs();
  }, []);

  return (
    <div className="max-w-3xl mx-auto p-6 space-y-6">
      <h2 className="text-xl font-bold text-purple-700">üéØ CTA Management</h2>

      <div className="bg-white p-4 rounded-xl shadow space-y-3">
        <input
          type="text"
          value={newCta.title}
          onChange={e => setNewCta({ ...newCta, title: e.target.value })}
          placeholder="CTA Title (e.g. Buy Now)"
          className="w-full border px-3 py-2 rounded-xl"
        />
        <input
          type="text"
          value={newCta.buttonText}
          onChange={e => setNewCta({ ...newCta, buttonText: e.target.value })}
          placeholder="Button Text (e.g. Buy Now)"
          className="w-full border px-3 py-2 rounded-xl"
        />
        <select
          value={newCta.buttonType}
          onChange={e => setNewCta({ ...newCta, buttonType: e.target.value })}
          className="w-full border px-3 py-2 rounded-xl"
        >
          <option value="url">URL</option>
          <option value="quick_reply">Quick Reply</option>
        </select>
        <input
          type="text"
          value={newCta.targetUrl}
          onChange={e => setNewCta({ ...newCta, targetUrl: e.target.value })}
          placeholder="Target URL or value"
          className="w-full border px-3 py-2 rounded-xl"
        />
        <textarea
          value={newCta.description}
          onChange={e => setNewCta({ ...newCta, description: e.target.value })}
          placeholder="Optional Description"
          className="w-full border px-3 py-2 rounded-xl"
        />
        <button
          onClick={saveCTA}
          className="bg-purple-600 text-white font-semibold px-4 py-2 rounded-xl"
        >
          ‚ûï Add CTA
        </button>
      </div>

      <div className="bg-white p-4 rounded-xl shadow space-y-3">
        <h3 className="font-semibold text-purple-700">üìã Saved CTAs</h3>
        {ctas.map(cta => (
          <div
            key={cta.id}
            className="border p-3 rounded-xl text-sm space-y-1 bg-gray-50"
          >
            <div>
              <strong>{cta.title}</strong>
            </div>
            <div>üîò Type: {cta.buttonType}</div>
            <div>üîò Text: {cta.buttonText}</div>
            <div>üîó Value: {cta.targetUrl}</div>
            <div className="text-gray-500 text-xs">{cta.description}</div>
          </div>
        ))}
      </div>
    </div>
  );
}

export default CTAManagement;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTATimeline\EmptyTimelineState.jsx 
====================================================== 
 
import React from "react";

function EmptyTimelineState() {
  return (
    <div className="text-center text-gray-500 p-10">
      <div className="text-5xl mb-3">üßπ</div>
      <h3 className="text-xl font-bold mb-2">No Timeline Yet</h3>
      <p className="text-sm">Activities will appear here once you interact!</p>
    </div>
  );
}

export default EmptyTimelineState;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTATimeline\LeadTimeline.jsx 
====================================================== 
 
import React, { useState, useEffect, useCallback } from "react";
import axiosClient from "../../api/axiosClient";
import TimelineEventCard from "./TimelineEventCard";
import { useParams } from "react-router-dom";
import { toast } from "react-toastify";

function LeadTimeline() {
  const { contactId } = useParams();
  const [timeline, setTimeline] = useState([]);
  const [loading, setLoading] = useState(true);
  const [contact, setContact] = useState(null);

  // ‚úÖ Fetch Contact Info (wrapped in useCallback)
  const fetchContactInfo = useCallback(async () => {
    try {
      const res = await axiosClient.get(`/contacts/${contactId}`);
      setContact(res.data);
    } catch (error) {
      console.error("Failed to fetch contact info", error);
      toast.error("‚ùå Failed to load contact info");
    }
  }, [contactId]);

  // ‚úÖ Fetch Timeline Events (wrapped in useCallback)
  const fetchTimeline = useCallback(async () => {
    try {
      setLoading(true);
      const res = await axiosClient.get(`/leadtimeline/contact/${contactId}`);
      setTimeline(res.data || []);
    } catch (error) {
      console.error("Failed to fetch timeline", error);
      toast.error("‚ùå Failed to load timeline events");
    } finally {
      setLoading(false);
    }
  }, [contactId]);

  useEffect(() => {
    if (contactId) {
      fetchContactInfo();
      fetchTimeline();
    }
  }, [contactId, fetchContactInfo, fetchTimeline]);

  return (
    <div className="p-6 max-w-5xl mx-auto">
      {/* Top Bar */}
      <div className="flex items-center justify-between mb-6">
        <div>
          <h2 className="text-2xl font-bold text-gray-800">üïì Lead Timeline</h2>
          {contact && (
            <p className="text-gray-600 text-sm mt-1">
              <span className="font-semibold">{contact.name || "Unknown"}</span>{" "}
              ‚Ä¢ {contact.phoneNumber}
            </p>
          )}
        </div>
        <button
          onClick={() => fetchTimeline()}
          className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded shadow text-sm"
        >
          üîÑ Refresh
        </button>
      </div>

      {/* Timeline Section */}
      <div className="relative pl-10 border-l-2 border-gray-200 space-y-8">
        {loading ? (
          <p className="text-gray-500">‚è≥ Loading timeline...</p>
        ) : timeline.length === 0 ? (
          <p className="text-gray-400 italic">
            No timeline activities found for this contact.
          </p>
        ) : (
          timeline.map(entry => (
            <TimelineEventCard key={entry.id} entry={entry} />
          ))
        )}
      </div>
    </div>
  );
}

export default LeadTimeline;

// import React, { useState, useEffect } from "react";
// import axiosClient from "../../api/axiosClient";
// import TimelineEventCard from "./TimelineEventCard";
// import { useParams } from "react-router-dom";
// import { toast } from "react-toastify";

// function LeadTimeline() {
//   const { contactId } = useParams();
//   const [timeline, setTimeline] = useState([]);
//   const [loading, setLoading] = useState(true);
//   const [contact, setContact] = useState(null);

//   // ‚úÖ Fetch Contact Info
//   const fetchContactInfo = async () => {
//     try {
//       const res = await axiosClient.get(`/contacts/${contactId}`);
//       setContact(res.data);
//     } catch (error) {
//       console.error("Failed to fetch contact info", error);
//       toast.error("‚ùå Failed to load contact info");
//     }
//   };

//   // ‚úÖ Fetch Timeline Events
//   const fetchTimeline = async () => {
//     try {
//       setLoading(true);
//       const res = await axiosClient.get(`/leadtimeline/contact/${contactId}`);
//       setTimeline(res.data || []);
//     } catch (error) {
//       console.error("Failed to fetch timeline", error);
//       toast.error("‚ùå Failed to load timeline events");
//     } finally {
//       setLoading(false);
//     }
//   };

//   useEffect(() => {
//     if (contactId) {
//       fetchContactInfo();
//       fetchTimeline();
//     }
//   }, [contactId]);

//   return (
//     <div className="p-6 max-w-5xl mx-auto">
//       {/* Top Bar */}
//       <div className="flex items-center justify-between mb-6">
//         <div>
//           <h2 className="text-2xl font-bold text-gray-800">üïì Lead Timeline</h2>
//           {contact && (
//             <p className="text-gray-600 text-sm mt-1">
//               <span className="font-semibold">{contact.name || "Unknown"}</span>{" "}
//               ‚Ä¢ {contact.phoneNumber}
//             </p>
//           )}
//         </div>
//         <button
//           onClick={() => fetchTimeline()}
//           className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded shadow text-sm"
//         >
//           üîÑ Refresh
//         </button>
//       </div>

//       {/* Timeline Section */}
//       <div className="relative pl-10 border-l-2 border-gray-200 space-y-8">
//         {loading ? (
//           <p className="text-gray-500">‚è≥ Loading timeline...</p>
//         ) : timeline.length === 0 ? (
//           <p className="text-gray-400 italic">
//             No timeline activities found for this contact.
//           </p>
//         ) : (
//           timeline.map(entry => (
//             <TimelineEventCard key={entry.id} entry={entry} />
//           ))
//         )}
//       </div>
//     </div>
//   );
// }

// export default LeadTimeline;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTATimeline\LeadTimeline_old.jsx 
====================================================== 
 
import React, { useState, useEffect, useCallback } from "react";
import { useParams } from "react-router-dom";
import axiosClient from "../../api/axiosClient";
import TimelineEntryCard from "../../components/TimelineEntryCard";
import { toast } from "react-toastify";

const LeadTimeline = () => {
  const { contactId } = useParams();
  const [timeline, setTimeline] = useState([]);
  const [loading, setLoading] = useState(true);
  const [contacts, setContacts] = useState([]);
  const [selectedContactId, setSelectedContactId] = useState("");
  const [selectedEventType, setSelectedEventType] = useState("");
  const [eventType, setEventType] = useState("");
  const [description, setDescription] = useState("");
  const [pageSize, setPageSize] = useState(10);
  const [currentPage, setCurrentPage] = useState(1);

  // 1. Wrap in useCallback!
  const fetchTimeline = useCallback(async () => {
    try {
      setLoading(true);
      const url = contactId
        ? `/leadtimeline/contact/${contactId}`
        : `/leadtimeline`;
      const response = await axiosClient.get(url);
      setTimeline(response.data);
    } catch (error) {
      // handled globally
    } finally {
      setLoading(false);
    }
  }, [contactId]);

  const fetchContacts = useCallback(async () => {
    try {
      const res = await axiosClient.get("/contacts");
      setContacts(res.data || []);
    } catch (err) {
      toast.error("‚ùå Failed to load contacts for filtering");
    }
  }, []);

  const handleAddTimeline = async () => {
    if (!eventType || !description) {
      toast.warn("Please fill in both fields.");
      return;
    }
    try {
      await axiosClient.post("/leadtimeline", {
        contactId,
        eventType,
        description,
        createdBy: "You",
        source: "UI",
        category: "Manual",
        isSystemGenerated: false,
      });
      toast.success("‚úÖ Timeline entry added");
      setEventType("");
      setDescription("");
      fetchTimeline();
    } catch (err) {
      console.error("Failed to add entry:", err);
    }
  };

  // 2. Add fetchTimeline & fetchContacts to dependencies!
  useEffect(() => {
    fetchTimeline();
    fetchContacts();
  }, [fetchTimeline, fetchContacts]);

  // ... (rest is unchanged)
  const filteredTimeline = timeline.filter(entry => {
    const contactMatch = selectedContactId
      ? entry.contactId === selectedContactId
      : true;
    const typeMatch = selectedEventType
      ? entry.eventType === selectedEventType
      : true;
    return contactMatch && typeMatch;
  });

  const totalPages = Math.ceil(filteredTimeline.length / pageSize);
  const startIndex = (currentPage - 1) * pageSize;
  const paginatedTimeline = filteredTimeline.slice(
    startIndex,
    startIndex + pageSize
  );

  const handlePageChange = direction => {
    if (direction === "prev" && currentPage > 1) {
      setCurrentPage(currentPage - 1);
    } else if (direction === "next" && currentPage < totalPages) {
      setCurrentPage(currentPage + 1);
    }
  };

  const handlePageSizeChange = e => {
    setPageSize(Number(e.target.value));
    setCurrentPage(1); // reset to page 1
  };

  return (
    <div className="p-4 bg-gray-50 min-h-screen">
      <h1 className="text-2xl font-bold mb-4">Lead Timeline</h1>
      {/* ... (rest unchanged) */}
      {/* üîç Filter Bar */}
      <div className="bg-white rounded shadow p-4 mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
        <select
          value={selectedContactId}
          onChange={e => setSelectedContactId(e.target.value)}
          className="border rounded px-3 py-2"
        >
          <option value="">All Contacts</option>
          {contacts.map(contact => (
            <option key={contact.id} value={contact.id}>
              {contact.name} ({contact.phoneNumber})
            </option>
          ))}
        </select>
        <select
          value={selectedEventType}
          onChange={e => setSelectedEventType(e.target.value)}
          className="border rounded px-3 py-2"
        >
          <option value="">All Event Types</option>
          <option value="PhoneCall">üìû Phone Call</option>
          <option value="ReminderSet">‚è∞ Reminder Set</option>
          <option value="NoteAdded">üìù Note Added</option>
          <option value="CustomActivity">‚öôÔ∏è Custom Activity</option>
        </select>
        <button
          onClick={() => {
            setSelectedContactId("");
            setSelectedEventType("");
          }}
          className="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300"
        >
          Reset Filters
        </button>
      </div>

      {/* ‚ûï Add Entry Form */}
      <div className="bg-white rounded shadow p-4 mb-6">
        <h3 className="text-lg font-semibold mb-2">Add Timeline Entry</h3>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <input
            type="text"
            placeholder="Event Type (e.g., Phone Call)"
            value={eventType}
            onChange={e => setEventType(e.target.value)}
            className="border rounded px-3 py-2"
          />
          <input
            type="text"
            placeholder="Description"
            value={description}
            onChange={e => setDescription(e.target.value)}
            className="border rounded px-3 py-2"
          />
          <button
            onClick={handleAddTimeline}
            className="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700"
          >
            ‚ûï Add Entry
          </button>
        </div>
      </div>

      {/* üî¢ Pagination Controls */}
      <div className="flex justify-between items-center mb-3">
        <div>
          <label className="text-sm text-gray-600 mr-2">Show:</label>
          <select
            value={pageSize}
            onChange={handlePageSizeChange}
            className="border rounded px-2 py-1 text-sm"
          >
            <option value={10}>10</option>
            <option value={25}>25</option>
            <option value={50}>50</option>
          </select>
          <span className="ml-2 text-sm text-gray-600">entries per page</span>
        </div>
        <div className="space-x-2">
          <button
            onClick={() => handlePageChange("prev")}
            className="text-sm px-3 py-1 border rounded bg-gray-200 hover:bg-gray-300"
            disabled={currentPage === 1}
          >
            ‚¨Ö Prev
          </button>
          <span className="text-sm text-gray-700">
            Page {currentPage} of {totalPages}
          </span>
          <button
            onClick={() => handlePageChange("next")}
            className="text-sm px-3 py-1 border rounded bg-gray-200 hover:bg-gray-300"
            disabled={currentPage === totalPages}
          >
            Next ‚û°
          </button>
        </div>
      </div>

      {/* Timeline List */}
      {loading ? (
        <p>Loading...</p>
      ) : paginatedTimeline.length > 0 ? (
        paginatedTimeline.map(entry => (
          <TimelineEntryCard key={entry.id} entry={entry} />
        ))
      ) : (
        <p className="text-gray-500">No timeline entries match your filters.</p>
      )}
    </div>
  );
};

export default LeadTimeline;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTATimeline\TimelineEventCard.jsx 
====================================================== 
 
import React from "react";
import { formatAgo } from "./timelineUtils"; // ‚úÖ Correct import

function TimelineEventCard({ entry }) {
  // üîµ Pick Icon based on eventType
  const getIcon = () => {
    if (entry.eventType === "CatalogCTA") return "üõçÔ∏è";
    if (entry.eventType === "CampaignSend") return "‚úâÔ∏è"; // ‚úÖ New: Campaign Send icon
    if (entry.eventType === "ReminderSet") return "‚è∞";
    if (entry.eventType === "NoteAdded") return "üìù";
    if (entry.eventType === "CustomActivity") return "‚öôÔ∏è";
    return "üìå"; // default for unknown event types
  };

  // üè∑Ô∏è Pick badge color
  const getBadgeStyle = () => {
    if (entry.eventType === "CatalogCTA") return "bg-green-100 text-green-800";
    if (entry.eventType === "CampaignSend")
      return "bg-indigo-100 text-indigo-800"; // ‚úÖ New: Campaign Send badge
    if (entry.eventType === "ReminderSet")
      return "bg-yellow-100 text-yellow-800";
    if (entry.eventType === "NoteAdded") return "bg-blue-100 text-blue-800";
    if (entry.eventType === "CustomActivity")
      return "bg-purple-100 text-purple-800";
    return "bg-gray-100 text-gray-800"; // default style
  };

  return (
    <div className="relative">
      {/* üîµ Dot */}
      <div className="absolute -left-7 top-5 w-4 h-4 bg-purple-600 rounded-full border-2 border-white shadow"></div>

      {/* üß© Event Card */}
      <div className="bg-white rounded-xl shadow-md p-4">
        <div className="flex justify-between items-center mb-2">
          {/* üß† Icon + Event Type */}
          <div className="flex items-center gap-2 text-purple-700 font-semibold">
            <span className="text-xl">{getIcon()}</span>
            <span>{entry.eventType}</span>
          </div>

          {/* üè∑Ô∏è Badge */}
          <div
            className={`text-xs font-bold px-2 py-1 rounded ${getBadgeStyle()}`}
          >
            {entry.eventType}
          </div>
        </div>

        {/* üìù Description */}
        <div className="text-gray-700 text-sm mb-2">
          {entry.description || "(No description provided)"}
        </div>

        {/* üïë Timestamp */}
        <div className="text-xs text-gray-400">
          {formatAgo(entry.createdAt)}
        </div>
      </div>
    </div>
  );
}

export default TimelineEventCard;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\CTATimeline\timelineUtils.js 
====================================================== 
 
// üìÖ Utility functions for Timeline

export function formatAgo(dateString) {
  const date = new Date(dateString);
  const now = new Date();

  const diffMs = now - date;
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

  if (diffDays === 0) {
    return `Today at ${date.toLocaleTimeString([], {
      hour: "2-digit",
      minute: "2-digit",
    })}`;
  } else if (diffDays === 1) {
    return `Yesterday at ${date.toLocaleTimeString([], {
      hour: "2-digit",
      minute: "2-digit",
    })}`;
  } else if (diffDays < 7) {
    return `${diffDays} days ago`;
  } else {
    return date.toLocaleDateString();
  }
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\DevTools\CTATester.jsx 
====================================================== 
 
import React, { useState, useEffect } from "react";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";

function CTATester() {
  const [form, setForm] = useState({
    templateId: "",
    userPhone: "",
    refMessageId: "",
    buttonText: "",
    ctaJourney: "",
  });

  const [logs, setLogs] = useState([]);

  const updateField = (key, value) => {
    setForm(f => ({ ...f, [key]: value }));
  };

  const handleSubmit = async e => {
    e.preventDefault();

    try {
      const payload = {
        businessId: form.businessId.trim(),
        templateId: form.templateId.trim(),
        userPhone: form.userPhone.trim(),
        refMessageId: form.refMessageId.trim(),
        buttonText: form.buttonText.trim(),
        ctaJourney: form.ctaJourney.trim() || form.buttonText.trim(),
      };

      const res = await axiosClient.post(
        "/catalog-tracking/log-click",
        payload
      );
      if (res.data.success) {
        toast.success("‚úÖ Click simulated successfully!");
        fetchRecentLogs();
      } else {
        toast.error("‚ö†Ô∏è API responded but not successful.");
      }
    } catch (err) {
      console.error(err);
      toast.error("‚ùå Failed to simulate CTA click.");
    }
  };

  const fetchRecentLogs = async () => {
    try {
      const res = await axiosClient.get("/catalog-tracking/recent?limit=10");
      setLogs(Array.isArray(res.data) ? res.data : []);
    } catch (err) {
      console.error("Failed to load logs", err);
    }
  };

  useEffect(() => {
    fetchRecentLogs();
  }, []);

  return (
    <div className="max-w-3xl mx-auto px-6 py-6 bg-white shadow-lg rounded-2xl mt-6 space-y-6">
      {/* üß™ CTA Simulation Form */}
      <div>
        <h2 className="text-2xl font-bold text-purple-700 mb-4">
          üß™ CTA Tester (Simulate Clicks)
        </h2>

        <form onSubmit={handleSubmit} className="space-y-5">
          {/* Template ID */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Business ID
            </label>
            <input
              type="text"
              value={form.businessId}
              onChange={e => updateField("businessId", e.target.value)}
              className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-400"
              placeholder="Business ID"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Template ID
            </label>
            <input
              type="text"
              value={form.templateId}
              onChange={e => updateField("templateId", e.target.value)}
              className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-400"
              placeholder="Template GUID"
            />
          </div>

          {/* User Phone */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              User Phone
            </label>
            <input
              type="text"
              value={form.userPhone}
              onChange={e => updateField("userPhone", e.target.value)}
              className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-400"
              placeholder="+91..."
            />
          </div>

          {/* Ref Message ID */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Ref Message ID
            </label>
            <input
              type="text"
              value={form.refMessageId}
              onChange={e => updateField("refMessageId", e.target.value)}
              className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-400"
              placeholder="wamid.HBgMT..."
            />
          </div>

          {/* Button Text */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Button Text
            </label>
            <input
              type="text"
              value={form.buttonText}
              onChange={e => updateField("buttonText", e.target.value)}
              className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-400"
              placeholder="Buy Now"
            />
          </div>

          {/* CTA Journey */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              CTA Journey (Optional)
            </label>
            <input
              type="text"
              value={form.ctaJourney}
              onChange={e => updateField("ctaJourney", e.target.value)}
              className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-400"
              placeholder="BuyNow | HowToUse | Ingredients"
            />
          </div>

          {/* Submit Button */}
          <button
            type="submit"
            className="w-full bg-purple-600 text-white py-2 rounded-lg font-semibold hover:bg-purple-700 transition"
          >
            üöÄ Simulate Click
          </button>
        </form>
      </div>

      {/* üìú Recent Logs Section */}
      <div className="bg-gray-50 p-4 rounded-xl shadow-inner">
        <h2 className="text-lg font-semibold text-purple-700 mb-3">
          üïµÔ∏è Recent Simulated Clicks
        </h2>

        {logs.length === 0 ? (
          <p className="text-sm text-gray-500">No simulated clicks yet.</p>
        ) : (
          <div className="space-y-3 max-h-64 overflow-y-auto">
            {logs.map((log, idx) => (
              <div
                key={idx}
                className="border p-3 rounded-md text-sm bg-white flex flex-col"
              >
                <span>
                  <strong>üìû Phone:</strong> {log.userPhone}
                </span>
                <span>
                  <strong>üîò CTA:</strong> {log.buttonText || log.ctaJourney}
                </span>
                <span>
                  <strong>üÜî Template:</strong> {log.templateId || "‚Äî"}
                </span>
                <span>
                  <strong>üïí Time:</strong>{" "}
                  {new Date(log.clickedAt).toLocaleString()}
                </span>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

export default CTATester;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\DevTools\EsuDebugPage.jsx 
====================================================== 
 
// üìÑ src/pages/Debug/EsuDebugPage.jsx
import React, { useState } from "react";
import { useNavigate } from "react-router-dom";
import { toast } from "react-toastify";
import axiosClient from "../../api/axiosClient";
import { useAuth } from "../../app/providers/AuthProvider";
import { ShieldCheck, Trash2, RefreshCcw, ArrowLeft } from "lucide-react";

const GUID_RE =
  /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;

export default function EsuDebugPage() {
  const navigate = useNavigate();
  const { role, hasAllAccess } = useAuth();

  const userRole = String(role || "").toLowerCase();
  const isSuperAdmin = hasAllAccess || userRole === "superadmin";

  const [businessId, setBusinessId] = useState("");
  const [loadingToken, setLoadingToken] = useState(false);
  const [loadingFlags, setLoadingFlags] = useState(false);
  const [deauthing, setDeauthing] = useState(false);

  const [tokenInfo, setTokenInfo] = useState(null);
  const [flagsInfo, setFlagsInfo] = useState(null);

  // Modal state for deauthorize confirmation
  const [confirmOpen, setConfirmOpen] = useState(false);
  const [confirmBiz, setConfirmBiz] = useState("");

  if (!isSuperAdmin) {
    return (
      <div className="p-6">
        <button
          onClick={() => navigate("/app/admin")}
          className="inline-flex items-center gap-2 text-sm text-purple-600 mb-4"
        >
          <ArrowLeft size={16} />
          Back to Admin
        </button>
        <div className="bg-red-50 border border-red-200 text-red-700 p-4 rounded-md">
          <div className="font-semibold mb-1">Restricted</div>
          <div className="text-sm">
            Meta ESU debug tools are only available to superadmin users.
          </div>
        </div>
      </div>
    );
  }

  const ensureBiz = () => {
    const trimmed = businessId.trim();
    if (!GUID_RE.test(trimmed)) {
      toast.error("Enter a valid BusinessId (GUID) to continue.");
      return null;
    }
    return trimmed;
  };

  // Load token info (optionally for a specific BusinessId)
  const handleLoadToken = async explicitBiz => {
    const biz = explicitBiz || ensureBiz();
    if (!biz) return;

    try {
      setLoadingToken(true);
      setTokenInfo(null);

      const res = await axiosClient.get(`/esu/facebook/debug/token`, {
        params: { businessId: biz },
      });

      setTokenInfo(res?.data || null);
      if (res?.data?.ok) {
        toast.success("Token info loaded.");
      } else {
        toast.info(res?.data?.message || "No valid token found.");
      }
    } catch (err) {
      toast.error(
        err?.response?.data?.message ||
          "Failed to load token info for this account."
      );
    } finally {
      setLoadingToken(false);
    }
  };

  // Load ESU flags (optionally for a specific BusinessId)
  const handleLoadFlags = async explicitBiz => {
    const biz = explicitBiz || ensureBiz();
    if (!biz) return;

    try {
      setLoadingFlags(true);
      setFlagsInfo(null);

      const res = await axiosClient.get(`/esu/facebook/debug/flags`, {
        params: { businessId: biz },
      });

      setFlagsInfo(res?.data || null);
      toast.success("Flags loaded.");
    } catch (err) {
      toast.error(
        err?.response?.data?.message ||
          "Failed to load ESU flags for this account."
      );
    } finally {
      setLoadingFlags(false);
    }
  };

  // Open confirmation modal
  const handleDeauthorizeClick = () => {
    const biz = ensureBiz();
    if (!biz) return;
    setConfirmBiz(biz);
    setConfirmOpen(true);
  };

  // Perform local-only deauthorize after confirmation
  const performDeauthorize = async () => {
    if (!confirmBiz) {
      setConfirmOpen(false);
      return;
    }

    try {
      setDeauthing(true);

      const res = await axiosClient.post(
        `/esu/facebook/debug/deauthorize`,
        null,
        { params: { businessId: confirmBiz } }
      );

      if (res?.data?.ok) {
        toast.success(
          `Local ESU flags/tokens cleared for account ${confirmBiz}.`
        );
      } else {
        toast.info(res?.data?.message || "Deauthorize completed.");
      }

      // Refresh debug info for the same account
      await Promise.all([
        handleLoadToken(confirmBiz),
        handleLoadFlags(confirmBiz),
      ]);
    } catch (err) {
      toast.error(
        err?.response?.data?.message ||
          "Failed to deauthorize ESU locally for this account."
      );
    } finally {
      setDeauthing(false);
      setConfirmOpen(false);
      setConfirmBiz("");
    }
  };

  return (
    <div className="p-6 max-w-3xl mx-auto">
      <button
        onClick={() => navigate("/app/admin")}
        className="inline-flex items-center gap-2 text-sm text-purple-600 mb-4"
      >
        <ArrowLeft size={16} />
        Back to Admin
      </button>

      <div className="flex items-center gap-3 mb-3">
        <div className="bg-amber-50 border border-amber-200 rounded-full p-2">
          <ShieldCheck className="text-amber-500" size={22} />
        </div>
        <div>
          <h1 className="text-xl font-semibold text-slate-900">
            Meta ESU Debug Tools
          </h1>
          <p className="text-sm text-slate-600">
            Superadmin-only utilities to inspect ESU tokens/flags and run{" "}
            <strong>local-only deauthorize</strong> for a specific account.
          </p>
        </div>
      </div>

      <div className="mt-4 mb-6 p-4 rounded-xl bg-amber-50 border border-amber-200 text-xs text-amber-900">
        <ul className="list-disc list-inside space-y-1">
          <li>
            Uses existing <code>/api/esu/facebook/debug/*</code> endpoints.
          </li>
          <li>
            <strong>Deauthorize</strong> clears ESU flags &amp; tokens in our DB
            only. It does <em>not</em> call Meta&apos;s{" "}
            <code>/me/permissions</code>.
          </li>
          <li>
            Use for local/staging debugging or targeted cleanup by
            superadmins/ops.
          </li>
        </ul>
      </div>

      <div className="bg-white border border-slate-200 rounded-xl p-4 mb-6 shadow-sm">
        <label className="block text-xs text-slate-600 mb-1">
          Target Account BusinessId (GUID)
        </label>
        <input
          type="text"
          value={businessId}
          onChange={e => setBusinessId(e.target.value)}
          placeholder="e.g. 12345678-90ab-cdef-1234-567890abcdef"
          className="w-full px-3 py-2 border border-slate-300 rounded-md text-sm font-mono"
        />
        <p className="text-[10px] text-slate-500 mt-1">
          This should be the same BusinessId used in ESU / WhatsApp settings.
        </p>

        <div className="flex flex-wrap gap-2 mt-3">
          <button
            type="button"
            onClick={() => handleLoadToken()}
            disabled={loadingToken}
            className="inline-flex items-center gap-1 px-3 py-1.5 rounded-md bg-sky-600 text-white text-xs font-semibold disabled:opacity-60"
          >
            <RefreshCcw size={14} />
            {loadingToken ? "Loading token‚Ä¶" : "Load Token Preview"}
          </button>

          <button
            type="button"
            onClick={() => handleLoadFlags()}
            disabled={loadingFlags}
            className="inline-flex items-center gap-1 px-3 py-1.5 rounded-md bg-indigo-600 text-white text-xs font-semibold disabled:opacity-60"
          >
            <RefreshCcw size={14} />
            {loadingFlags ? "Loading flags‚Ä¶" : "Load ESU Flags"}
          </button>

          <button
            type="button"
            onClick={handleDeauthorizeClick}
            disabled={deauthing}
            className="inline-flex items-center gap-1 px-3 py-1.5 rounded-md bg-amber-700 text-white text-xs font-semibold disabled:opacity-60"
          >
            <Trash2 size={14} />
            {deauthing ? "Deauthorizing‚Ä¶" : "Deauthorize (Local Only)"}
          </button>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="bg-slate-50 border border-slate-200 rounded-lg p-3 text-xs">
          <div className="font-semibold text-slate-700 mb-1">Token Info</div>
          <pre className="whitespace-pre-wrap break-all text-[10px] text-slate-700">
            {tokenInfo ? JSON.stringify(tokenInfo, null, 2) : "No data loaded."}
          </pre>
        </div>

        <div className="bg-slate-50 border border-slate-200 rounded-lg p-3 text-xs">
          <div className="font-semibold text-slate-700 mb-1">ESU Flags</div>
          <pre className="whitespace-pre-wrap break-all text-[10px] text-slate-700">
            {flagsInfo ? JSON.stringify(flagsInfo, null, 2) : "No data loaded."}
          </pre>
        </div>
      </div>

      {confirmOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
          <div className="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 p-5 border border-amber-200">
            <h2 className="text-sm font-semibold text-slate-900 mb-2">
              Deauthorize ESU locally for this account?
            </h2>
            <p className="text-xs text-slate-700 mb-2">
              <span className="font-semibold">BusinessId:</span>{" "}
              <span className="font-mono break-all">{confirmBiz}</span>
            </p>
            <p className="text-[11px] text-amber-800 mb-3">
              This will clear ESU flags and stored tokens in{" "}
              <span className="font-semibold">our DB only</span> for this
              account. It will <span className="font-semibold">not</span> call
              Meta&apos;s <code className="text-[10px]">/me/permissions</code>{" "}
              or revoke anything remotely. Use for local/staging debugging or
              targeted cleanup by superadmins/ops.
            </p>
            <div className="flex justify-end gap-2 mt-3">
              <button
                type="button"
                onClick={() => {
                  if (!deauthing) {
                    setConfirmOpen(false);
                    setConfirmBiz("");
                  }
                }}
                className="px-3 py-1.5 rounded-md text-xs border border-slate-300 text-slate-700 hover:bg-slate-50 disabled:opacity-60"
                disabled={deauthing}
              >
                Cancel
              </button>
              <button
                type="button"
                onClick={performDeauthorize}
                disabled={deauthing}
                className="px-3 py-1.5 rounded-md text-xs bg-amber-700 text-white font-semibold hover:bg-amber-800 disabled:opacity-60"
              >
                {deauthing ? "Deauthorizing‚Ä¶" : "Yes, Deauthorize Locally"}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\EmbededSignUp\FacebookEsuCard.jsx 
====================================================== 
 
import React, { useCallback, useEffect, useState } from "react";

const BIZ_ID = "9841bcab-ca71-439f-8691-d85ada887b01";
const API = p =>
  `${process.env.REACT_APP_API_BASE ?? "https://localhost:7113"}${p}`;

export default function FacebookEsuCard() {
  const [loading, setLoading] = useState(false);
  const [status, setStatus] = useState(null);
  const [error, setError] = useState("");

  const loadStatus = useCallback(async () => {
    setError("");
    try {
      const r = await fetch(
        API(`/api/esu/facebook/debug/status?businessId=${BIZ_ID}`)
      );
      const j = await r.json();
      setStatus(j);
    } catch (e) {
      setError("Failed to load status");
    }
  }, []);

  useEffect(() => {
    loadStatus();
  }, [loadStatus]);

  const handleConnect = async () => {
    setLoading(true);
    setError("");
    try {
      const r = await fetch(API("/api/esu/facebook/start"), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          businessId: BIZ_ID,
          returnUrlAfterSuccess: window.location.href,
        }),
      });
      if (!r.ok) throw new Error("start failed");
      const j = await r.json();
      window.location.href = j.launchUrl; // redirect to FB dialog
    } catch (e) {
      setError("Failed to start Facebook ESU.");
      setLoading(false);
    }
  };

  const handleDeauth = async () => {
    setLoading(true);
    setError("");
    try {
      await fetch(
        API(`/api/esu/facebook/debug/deauthorize?businessId=${BIZ_ID}`),
        { method: "POST" }
      );
      await loadStatus();
    } catch (e) {
      setError("Failed to deauthorize");
    } finally {
      setLoading(false);
    }
  };

  const expiry = status?.tokenExpiresAtUtc
    ? new Date(status.tokenExpiresAtUtc).toLocaleString()
    : "N/A";
  const connected = !!status?.connected;

  return (
    <div className="rounded-2xl border p-4 shadow-sm">
      <div className="flex items-center justify-between">
        <h3 className="text-lg font-semibold">Facebook Embedded Signup</h3>
        <span
          className={`text-sm ${
            connected ? "text-green-600" : "text-gray-500"
          }`}
        >
          {connected ? "Connected" : "Not connected"}
        </span>
      </div>

      <div className="mt-2 text-sm text-gray-600">
        <div>
          Token expiry: <b>{expiry}</b>
        </div>
        {status?.willExpireSoon && (
          <div className="text-amber-600">Token will expire soon</div>
        )}
      </div>

      {error && <div className="mt-2 text-sm text-red-600">{error}</div>}

      <div className="mt-4 flex gap-2">
        {!connected && (
          <button
            onClick={handleConnect}
            disabled={loading}
            className="rounded-xl px-4 py-2 bg-blue-600 text-white disabled:opacity-50"
          >
            {loading ? "Starting‚Ä¶" : "Connect Facebook"}
          </button>
        )}
        {connected && (
          <button
            onClick={handleDeauth}
            disabled={loading}
            className="rounded-xl px-4 py-2 bg-gray-200 hover:bg-gray-300 disabled:opacity-50"
          >
            {loading ? "Working‚Ä¶" : "Disconnect"}
          </button>
        )}
        <button onClick={loadStatus} className="rounded-xl px-4 py-2 border">
          Refresh
        </button>
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\errors\Forbidden403.jsx 
====================================================== 
 
export default function Forbidden403() {
  return (
    <div className="p-8 text-center">
      <h1 className="text-3xl font-semibold mb-2">403 ‚Äî No Access</h1>
      <p className="opacity-80">
        You‚Äôre signed in, but your role/plan lacks permission for this area.
      </p>
      <a href="/app" className="inline-block mt-6 underline">
        Go to Dashboard
      </a>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\FeatureAccess\FeatureSummaryCard.jsx 
====================================================== 
 
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\FeatureAccess\FeatureTogglePage.jsx 
====================================================== 
 
// üìÑ src/pages/FeatureAccess/FeatureTogglePage.jsx
import React, { useEffect, useState } from "react";
import axios from "axios";
import { Card } from "../../components/ui/card"; // Corrected this line
import { toast } from "react-toastify";

export default function FeatureTogglePage() {
  const [features, setFeatures] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchFeatureToggles();
  }, []);

  const fetchFeatureToggles = async () => {
    try {
      const res = await axios.get("/api/feature-access/feature-toggle-view");
      setFeatures(res.data.data || []);
    } catch (err) {
      toast.error("Failed to load features");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="p-6">
      <h1 className="text-2xl font-semibold mb-4">üß© Feature Toggle View</h1>

      {loading ? (
        <p>Loading...</p>
      ) : (
        <Card className="overflow-x-auto p-4 shadow-md">
          <table className="min-w-full table-auto border border-gray-200">
            <thead>
              <tr className="bg-gray-100">
                <th className="px-4 py-2 text-left">Feature</th>
                <th className="px-4 py-2">Group</th>
                <th className="px-4 py-2">In Plan</th>
                <th className="px-4 py-2">Overridden</th>
                <th className="px-4 py-2">Active?</th>
              </tr>
            </thead>
            <tbody>
              {features.map((f, i) => (
                <tr key={i} className="border-t">
                  <td className="px-4 py-2 font-medium">{f.featureCode}</td>
                  <td className="px-4 py-2">{f.group}</td>
                  <td className="px-4 py-2 text-center">
                    {f.isAvailableInPlan ? "‚úÖ" : "‚ùå"}
                  </td>
                  <td className="px-4 py-2 text-center">
                    {f.isOverridden === true
                      ? "‚úÖ"
                      : f.isOverridden === false
                      ? "‚ùå"
                      : "‚Äî"}
                  </td>
                  <td className="px-4 py-2 text-center">
                    {f.isActive ? "‚úÖ" : "‚ùå"}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </Card>
      )}
    </div>
  );
}

// // üìÑ src/pages/FeatureAccess/FeatureTogglePage.jsx
// import React, { useEffect, useState } from "react";
// import axios from "axios";
// import { Card, CardContent } from "../../components/ui/card";
// import { toast } from "react-toastify";

// export default function FeatureTogglePage() {
//   const [features, setFeatures] = useState([]);
//   const [loading, setLoading] = useState(true);

//   useEffect(() => {
//     fetchFeatureToggles();
//   }, []);

//   const fetchFeatureToggles = async () => {
//     try {
//       const res = await axios.get("/api/feature-access/feature-toggle-view");
//       setFeatures(res.data.data || []);
//     } catch (err) {
//       toast.error("Failed to load features");
//     } finally {
//       setLoading(false);
//     }
//   };

//   return (
//     <div className="p-6">
//       <h1 className="text-2xl font-semibold mb-4">üß© Feature Toggle View</h1>

//       {loading ? (
//         <p>Loading...</p>
//       ) : (
//         <Card className="overflow-x-auto p-4 shadow-md">
//           <table className="min-w-full table-auto border border-gray-200">
//             <thead>
//               <tr className="bg-gray-100">
//                 <th className="px-4 py-2 text-left">Feature</th>
//                 <th className="px-4 py-2">Group</th>
//                 <th className="px-4 py-2">In Plan</th>
//                 <th className="px-4 py-2">Overridden</th>
//                 <th className="px-4 py-2">Active?</th>
//               </tr>
//             </thead>
//             <tbody>
//               {features.map((f, i) => (
//                 <tr key={i} className="border-t">
//                   <td className="px-4 py-2 font-medium">{f.featureCode}</td>
//                   <td className="px-4 py-2">{f.group}</td>
//                   <td className="px-4 py-2 text-center">
//                     {f.isAvailableInPlan ? "‚úÖ" : "‚ùå"}
//                   </td>
//                   <td className="px-4 py-2 text-center">
//                     {f.isOverridden === true
//                       ? "‚úÖ"
//                       : f.isOverridden === false
//                       ? "‚ùå"
//                       : "‚Äî"}
//                   </td>
//                   <td className="px-4 py-2 text-center">
//                     {f.isActive ? "‚úÖ" : "‚ùå"}
//                   </td>
//                 </tr>
//               ))}
//             </tbody>
//           </table>
//         </Card>
//       )}
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\FeatureAccess\FeatureToggles.jsx 
====================================================== 
 
// üìÑ File: src/pages/admin/FeatureAccess/FeatureToggles.jsx
import React, { useEffect, useState } from "react";
import axios from "axios";
import { toast } from "react-toastify";

export default function FeatureToggles() {
  const [features, setFeatures] = useState([]);
  const [loading, setLoading] = useState(true);

  const fetchFeatures = async () => {
    try {
      const res = await axios.get("/api/feature-access/feature-toggle-view");
      setFeatures(res.data.data || []);
    } catch (err) {
      toast.error("Failed to load feature toggles.");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchFeatures();
  }, []);

  const handleToggle = async (featureCode, currentOverride) => {
    const nextOverride =
      currentOverride === null ? true : currentOverride === true ? false : null;

    try {
      await axios.patch(`/api/feature-access/${featureCode}`, {
        isEnabled: nextOverride,
      });

      setFeatures(prev =>
        prev.map(f =>
          f.featureCode === featureCode
            ? { ...f, isOverridden: nextOverride }
            : f
        )
      );
      toast.success("Override updated.");
    } catch (err) {
      toast.error("Failed to update override.");
    }
  };

  const groupFeatures = () => {
    const grouped = {};
    for (const feature of features) {
      const group = feature.group || "General";
      if (!grouped[group]) grouped[group] = [];
      grouped[group].push(feature);
    }
    return grouped;
  };

  if (loading) return <div className="p-4 text-gray-500">Loading...</div>;

  const groupedFeatures = groupFeatures();

  return (
    <div className="p-6">
      <h1 className="text-2xl font-semibold mb-6">üîß Feature Toggles</h1>
      {Object.entries(groupedFeatures).map(([groupName, groupFeatures]) => (
        <div key={groupName} className="mb-8">
          <h2 className="text-lg font-bold text-purple-700 mb-3">
            {groupName}
          </h2>
          <div className="bg-white shadow-md rounded-xl overflow-hidden border">
            <table className="min-w-full text-sm text-gray-700">
              <thead className="bg-gray-100">
                <tr>
                  <th className="px-4 py-2 text-left">Feature</th>
                  <th className="px-4 py-2">Plan</th>
                  <th className="px-4 py-2">Override</th>
                  <th className="px-4 py-2">Active</th>
                  <th className="px-4 py-2 text-right">Toggle</th>
                </tr>
              </thead>
              <tbody>
                {groupFeatures.map(f => {
                  const override = f.isOverridden;
                  const isActive = override ?? f.isAvailableInPlan;
                  return (
                    <tr key={f.featureCode} className="border-t">
                      <td className="px-4 py-2">
                        <div className="font-medium">{f.featureCode}</div>
                        <div className="text-xs text-gray-500">
                          {f.description}
                        </div>
                      </td>
                      <td className="px-4 py-2 text-center">
                        {f.isAvailableInPlan ? (
                          <span className="px-2 py-1 text-xs bg-green-100 text-green-700 rounded-full">
                            ‚úÖ Yes
                          </span>
                        ) : (
                          <span className="px-2 py-1 text-xs bg-red-100 text-red-700 rounded-full">
                            ‚ùå No
                          </span>
                        )}
                      </td>
                      <td className="px-4 py-2 text-center">
                        {override === true && (
                          <span className="text-green-600 font-semibold">
                            On
                          </span>
                        )}
                        {override === false && (
                          <span className="text-red-600 font-semibold">
                            Off
                          </span>
                        )}
                        {override === null && (
                          <span className="text-gray-500 italic">Default</span>
                        )}
                      </td>
                      <td className="px-4 py-2 text-center">
                        {isActive ? (
                          <span className="text-green-600 font-semibold">
                            üü¢ Enabled
                          </span>
                        ) : (
                          <span className="text-gray-500">‚ö™ Disabled</span>
                        )}
                      </td>
                      <td className="px-4 py-2 text-right">
                        <button
                          onClick={() => handleToggle(f.featureCode, override)}
                          className="text-sm bg-purple-600 text-white px-3 py-1 rounded-full hover:bg-purple-700"
                        >
                          Toggle
                        </button>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      ))}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\FlowAnalytics\FlowAnalyticsDashboard.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  CartesianGrid,
} from "recharts";

export default function FlowDashboard() {
  const [summary, setSummary] = useState(null);
  const [topSteps, setTopSteps] = useState([]);
  const [stepJourney, setStepJourney] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchData = async () => {
      try {
        const summaryRes = await axiosClient.get("/flow-analytics/summary");
        const stepsRes = await axiosClient.get(
          "/flow-analytics/most-triggered-steps"
        );
        const journeyRes = await axiosClient.get(
          "/flow-analytics/step-journey-breakdown"
        );
        setSummary(summaryRes.data);
        setTopSteps(stepsRes.data);
        setStepJourney(journeyRes.data);
      } catch (err) {
        toast.error("‚ùå Failed to load flow analytics data");
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, []);

  if (loading) return <div className="p-4">Loading analytics...</div>;
  if (!summary) return <div className="p-4">No analytics data available.</div>;

  return (
    <div className="p-6">
      <h2 className="text-2xl font-bold text-purple-700 mb-4">
        üìà Visual CTA Flow Dashboard
      </h2>

      <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6">
        <div className="bg-white p-4 shadow rounded-xl">
          <p className="text-sm text-gray-500">Total Steps Triggered</p>
          <p className="text-2xl font-bold text-purple-700">
            {summary.totalExecutions}
          </p>
        </div>

        <div className="bg-white p-4 shadow rounded-xl">
          <p className="text-sm text-gray-500">Unique Contacts</p>
          <p className="text-2xl font-bold text-purple-700">
            {summary.uniqueContacts}
          </p>
        </div>

        <div className="bg-white p-4 shadow rounded-xl">
          <p className="text-sm text-gray-500">Top Triggered Step</p>
          <p className="text-xl font-semibold text-purple-600">
            {summary.topStepTriggered}
          </p>
          <p className="text-sm text-gray-500">
            Triggered {summary.topStepCount} times
          </p>
        </div>

        <div className="bg-white p-4 shadow rounded-xl">
          <p className="text-sm text-gray-500">Last Execution</p>
          <p className="text-md text-gray-700">
            {summary.lastExecutedAt
              ? new Date(summary.lastExecutedAt).toLocaleString()
              : "-"}
          </p>
        </div>
      </div>

      <div className="bg-white p-4 shadow rounded-xl">
        <h3 className="text-lg font-bold text-purple-600 mb-2">
          üèÜ Top Triggered Steps
        </h3>
        {topSteps.length === 0 ? (
          <p className="text-gray-500">No execution data available.</p>
        ) : (
          <div className="overflow-x-auto">
            <table className="min-w-full border">
              <thead>
                <tr className="bg-gray-100">
                  <th className="text-left p-2 border">Step Name</th>
                  <th className="text-left p-2 border">Trigger Count</th>
                </tr>
              </thead>
              <tbody>
                {topSteps.map((step, idx) => (
                  <tr key={idx} className="hover:bg-gray-50">
                    <td className="p-2 border">{step.stepName}</td>
                    <td className="p-2 border">{step.count}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>

      {topSteps.length > 0 && (
        <div className="bg-white p-4 shadow rounded-xl mt-6">
          <h3 className="text-lg font-bold text-purple-600 mb-2">
            üìä Step Trigger Frequency
          </h3>
          <ResponsiveContainer width="100%" height={300}>
            <BarChart data={topSteps}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="stepName" tick={{ fontSize: 12 }} />
              <YAxis />
              <Tooltip />
              <Bar dataKey="count" fill="#7c3aed" radius={[4, 4, 0, 0]} />
            </BarChart>
          </ResponsiveContainer>
        </div>
      )}

      {stepJourney.length > 0 && (
        <div className="bg-white p-4 shadow rounded-xl mt-6">
          <h3 className="text-lg font-bold text-purple-600 mb-2">
            üß≠ Step-by-Step Journey Breakdown
          </h3>
          <div className="overflow-x-auto">
            <table className="min-w-full border">
              <thead>
                <tr className="bg-gray-100">
                  <th className="p-2 border text-left">Step Name</th>
                  <th className="p-2 border text-left">Total Reached</th>
                  <th className="p-2 border text-left">Clicked Next</th>
                  <th className="p-2 border text-left">Drop-Off</th>
                  <th className="p-2 border text-left">Next Step</th>
                </tr>
              </thead>
              <tbody>
                {stepJourney.map((step, idx) => (
                  <tr
                    key={idx}
                    className={`hover:bg-gray-50 ${
                      step.dropOff > 0 ? "bg-red-50" : ""
                    }`}
                  >
                    <td className="p-2 border font-medium text-purple-700">
                      {step.templateName}
                    </td>
                    <td className="p-2 border">{step.totalReached}</td>
                    <td className="p-2 border">{step.clickedNext}</td>
                    <td className="p-2 border font-semibold text-red-600">
                      {step.dropOff}
                    </td>
                    <td className="p-2 border text-xs text-gray-500">
                      {step.nextStepId || "-"}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\FlowAnalytics\StepJourneyBreakdown.jsx 
====================================================== 
 
import React, { useEffect, useState, useCallback } from "react";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";
import { saveAs } from "file-saver";
import * as XLSX from "xlsx";

export default function StepJourneyBreakdown() {
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState("");
  const [startDate, setStartDate] = useState("");
  const [endDate, setEndDate] = useState("");

  useEffect(() => {
    // Data fetching function is inside the effect for dependency safety
    const fetchBreakdown = async () => {
      setLoading(true);
      try {
        let url = "/api/flow-analytics/step-journey-breakdown";
        const params = [];
        if (startDate) params.push(`startDate=${startDate}`);
        if (endDate) params.push(`endDate=${endDate}`);
        if (params.length > 0) url += `?${params.join("&")}`;

        const res = await axiosClient.get(url);
        setData(res.data);
      } catch (err) {
        toast.error("‚ùå Failed to load step journey breakdown");
      } finally {
        setLoading(false);
      }
    };

    fetchBreakdown();
  }, [startDate, endDate]);

  // Only depends on data (for ESLint, useCallback ensures stable reference)
  const handleExport = useCallback(() => {
    const worksheet = XLSX.utils.json_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Journey Breakdown");
    const excelBuffer = XLSX.write(workbook, {
      bookType: "xlsx",
      type: "array",
    });
    const fileData = new Blob([excelBuffer], {
      type: "application/octet-stream",
    });
    saveAs(fileData, "step_journey_breakdown.xlsx");
  }, [data]);

  const filteredData = data.filter(step =>
    step.templateName?.toLowerCase().includes(search.toLowerCase())
  );

  // Stable callback for row click
  const handleRowClick = useCallback(
    step => {
      console.log("üìÇ Logs for Step:", step.stepId, step.templateName);
      toast.info(`Open logs for "${step.templateName}"`);
    },
    [] // no dependencies
  );

  if (loading) return <div className="p-4">Loading journey breakdown...</div>;
  if (!data.length)
    return <div className="p-4">No flow journey data available.</div>;

  return (
    <div className="p-6">
      <h2 className="text-2xl font-bold text-purple-700 mb-4">
        üîç Step-by-Step Journey Breakdown
      </h2>

      <div className="flex flex-wrap gap-4 mb-4">
        <input
          type="text"
          placeholder="üîç Search by step name..."
          className="border p-2 rounded w-full sm:w-64"
          value={search}
          onChange={e => setSearch(e.target.value)}
        />
        <input
          type="date"
          className="border p-2 rounded"
          value={startDate}
          onChange={e => setStartDate(e.target.value)}
        />
        <input
          type="date"
          className="border p-2 rounded"
          value={endDate}
          onChange={e => setEndDate(e.target.value)}
        />
        <button
          onClick={handleExport}
          className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
        >
          üì§ Export Excel
        </button>
      </div>

      <div className="overflow-x-auto">
        <table className="min-w-full bg-white shadow rounded-lg">
          <thead>
            <tr className="bg-gray-100 text-gray-600 text-sm uppercase text-left">
              <th className="p-3">Step</th>
              <th className="p-3">Total Reached</th>
              <th className="p-3">Clicked Next</th>
              <th className="p-3">Drop-Off</th>
              <th className="p-3">Conversion %</th>
              <th className="p-3">Drop-Off %</th>
              <th className="p-3">Next Step</th>
            </tr>
          </thead>
          <tbody>
            {filteredData.map((step, idx) => (
              <tr
                key={idx}
                className="border-t hover:bg-gray-50 text-sm cursor-pointer"
                onClick={() => handleRowClick(step)}
              >
                <td className="p-3 font-medium text-purple-700">
                  {step.templateName}
                </td>
                <td className="p-3">{step.totalReached}</td>
                <td className="p-3">{step.clickedNext}</td>
                <td className="p-3 text-red-600">{step.dropOff}</td>
                <td className="p-3 text-green-600">
                  {step.conversionRate?.toFixed(1) ?? "0.0"}%
                </td>
                <td className="p-3 text-orange-600">
                  {step.dropOffRate?.toFixed(1) ?? "0.0"}%
                </td>
                <td className="p-3 text-gray-500">{step.nextStepId || "‚Äî"}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\html pages\bestexample.html 
====================================================== 
 
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WhatsApp Restaurant Menu</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .phone-container {
        width: 375px;
        height: 650px;
        background: #000;
        border-radius: 40px;
        padding: 8px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        position: relative;
      }

      .phone-screen {
        width: 100%;
        height: 100%;
        background: #0a0a0a;
        border-radius: 32px;
        overflow: hidden;
        position: relative;
      }

      .status-bar {
        height: 44px;
        background: #128c7e;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        color: white;
        font-size: 14px;
        font-weight: 600;
      }

      .chat-header {
        height: 60px;
        background: #128c7e;
        display: flex;
        align-items: center;
        padding: 0 16px;
        color: white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .profile-pic {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #25d366;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        font-size: 18px;
      }

      .chat-info h3 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 2px;
      }

      .chat-info p {
        font-size: 12px;
        opacity: 0.8;
      }

      .chat-area {
        height: 546px;
        background: #0a0a0a;
        overflow-y: auto;
        padding: 16px;
        position: relative;
      }

      .message {
        margin-bottom: 16px;
        display: flex;
        animation: fadeInUp 0.5s ease-out;
      }

      .message.received {
        justify-content: flex-start;
      }

      .message.sent {
        justify-content: flex-end;
      }

      .message-content {
        max-width: 280px;
        padding: 12px 16px;
        border-radius: 18px;
        position: relative;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .message.received .message-content {
        background: #1f1f1f;
        color: white;
        border-bottom-left-radius: 6px;
      }

      .message.sent .message-content {
        background: #25d366;
        color: white;
        border-bottom-right-radius: 6px;
      }

      .message-time {
        font-size: 11px;
        opacity: 0.7;
        margin-top: 4px;
        text-align: right;
      }

      .menu-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-top: 12px;
      }

      .menu-button {
        background: #25d366;
        color: white;
        border: none;
        padding: 12px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .menu-button:hover {
        background: #1ea854;
        transform: translateY(-2px);
      }

      .menu-button.full-width {
        grid-column: 1 / -1;
      }

      .interactive-list {
        background: #2a2a2a;
        border-radius: 12px;
        margin-top: 12px;
        overflow: hidden;
      }

      .list-header {
        background: #25d366;
        color: white;
        padding: 12px 16px;
        font-weight: 600;
        font-size: 14px;
      }

      .list-item {
        background: #1f1f1f;
        color: white;
        padding: 16px;
        border-bottom: 1px solid #333;
        cursor: pointer;
        transition: background 0.2s ease;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .list-item:hover {
        background: #333;
      }

      .list-item:last-child {
        border-bottom: none;
      }

      .emoji {
        font-size: 20px;
      }

      .welcome-message {
        text-align: center;
        font-size: 16px;
        line-height: 1.5;
      }

      .brand-name {
        font-size: 18px;
        font-weight: 700;
        color: #25d366;
        margin-bottom: 8px;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .typing-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #666;
        font-size: 12px;
        margin-top: 8px;
      }

      .typing-dots {
        display: flex;
        gap: 4px;
      }

      .typing-dots span {
        width: 4px;
        height: 4px;
        border-radius: 50%;
        background: #666;
        animation: typing 1.4s infinite;
      }

      .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        60%,
        100% {
          transform: translateY(0);
        }
        30% {
          transform: translateY(-10px);
        }
      }
    </style>
  </head>
  <body>
    <div class="phone-container">
      <div class="phone-screen">
        <div class="status-bar">
          <span>9:41</span>
          <span>‚óè‚óè‚óè‚óè‚óè 4G</span>
        </div>

        <div class="chat-header">
          <div class="profile-pic">üçï</div>
          <div class="chat-info">
            <h3>Mario's Pizza</h3>
            <p>Online ‚Ä¢ Tap for menu</p>
          </div>
        </div>

        <div class="chat-area">
          <div class="message sent">
            <div class="message-content">
              Hi! I'd like to order some food
              <div class="message-time">9:41 AM</div>
            </div>
          </div>

          <div class="message received">
            <div class="message-content">
              <div class="welcome-message">
                <div class="brand-name">üçï Welcome to Mario's Pizza!</div>
                <p>
                  Hi there! üëã Ready to order some delicious food? Let me show
                  you our menu!
                </p>
              </div>

              <div class="menu-buttons">
                <button class="menu-button">üçï Pizzas</button>
                <button class="menu-button">üçî Burgers</button>
                <button class="menu-button">ü•ó Salads</button>
                <button class="menu-button">üçü Sides</button>
                <button class="menu-button">ü•§ Drinks</button>
                <button class="menu-button">üõí My Cart</button>
              </div>

              <div class="message-time">9:41 AM</div>
            </div>
          </div>

          <div class="message received">
            <div class="message-content">
              Or browse our full menu:

              <div class="interactive-list">
                <div class="list-header">üìã Full Menu Categories</div>
                <div class="list-item">
                  <span class="emoji">üçï</span>
                  <span>Pizza Collection (12 items)</span>
                </div>
                <div class="list-item">
                  <span class="emoji">üçî</span>
                  <span>Burgers & Sandwiches (8 items)</span>
                </div>
                <div class="list-item">
                  <span class="emoji">ü•ó</span>
                  <span>Fresh Salads (6 items)</span>
                </div>
                <div class="list-item">
                  <span class="emoji">üçü</span>
                  <span>Sides & Appetizers (10 items)</span>
                </div>
                <div class="list-item">
                  <span class="emoji">ü•§</span>
                  <span>Beverages (15 items)</span>
                </div>
              </div>

              <div class="message-time">9:41 AM</div>
            </div>
          </div>

          <div class="typing-indicator">
            <span>Mario's Pizza is typing</span>
            <div class="typing-dots">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\ExtrackAllFiles.bat 
====================================================== 
 
@echo off
REM This script will find all files and output their name and content into one file.
REM The output file will be named [FolderName]_AllFileDump.txt.

REM Get the current folder's name and set it as the output file name with the custom suffix
for %%I in ("%cd%") do set "outputFile=%%~nI_AllFileDump.txt"

REM Clear the output file to start fresh
> "%outputFile%" (echo Folder and File Content Report)
echo. >> "%outputFile%"

REM Loop through all files in the current directory and subdirectories
for /R . %%F in (*.*) do (
    echo ====================================================== >> "%outputFile%"
    echo FILE: %%F >> "%outputFile%"
    echo ====================================================== >> "%outputFile%"
    echo. >> "%outputFile%"
    type "%%F" >> "%outputFile%" 2>nul
    echo. >> "%outputFile%"
    echo. >> "%outputFile%"
)

echo Finished! All content has been extracted to %outputFile% 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\InboxContext.jsx 
====================================================== 
 
import React, { createContext, useContext, useState, useEffect } from "react";
import useSignalR from "../../hooks/useSignalR";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";

const InboxContext = createContext();

export const useInbox = () => useContext(InboxContext);

export const InboxProvider = ({ children }) => {
  // All state is managed here
  const { connection, isConnected } = useSignalR();
  const [messages, setMessages] = useState([]);
  const [selectedContactId, setSelectedContactId] = useState(null);
  const [newMessage, setNewMessage] = useState("");
  const [contact, setContact] = useState(null);
  const [playSound, setPlaySound] = useState(
    localStorage.getItem("playSound") === "true"
  );
  const [userHasInteracted, setUserHasInteracted] = useState(false);

  const currentUserId = localStorage.getItem("userId");

  // Track user interaction for sound autoplay
  useEffect(() => {
    const handleUserInteraction = () => setUserHasInteracted(true);
    window.addEventListener("click", handleUserInteraction);
    window.addEventListener("keydown", handleUserInteraction);
    return () => {
      window.removeEventListener("click", handleUserInteraction);
      window.removeEventListener("keydown", handleUserInteraction);
    };
  }, []);

  // Fetch contact details when a contact is selected
  useEffect(() => {
    if (!selectedContactId) {
      setContact(null);
      return;
    }
    axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
      setContact(res.data);
    });
  }, [selectedContactId]);

  // Load message history with robust clearing logic
  useEffect(() => {
    if (!selectedContactId) {
      setMessages([]);
      return;
    }
    setMessages([]); // Instantly clear old messages for better UX
    axiosClient
      .get(`/inbox/messages?contactId=${selectedContactId}`)
      .then(res => {
        const normalized = (res.data || []).map(m => ({
          ...m,
          messageContent: m.messageContent ?? m.message, // ‚úÖ normalize
        }));
        setMessages(normalized);
      })
      .catch(err => {
        console.error("‚ùå Failed to load messages:", err);
        toast.error("Failed to load messages.");
      });
  }, [selectedContactId]);

  // SignalR listener for incoming messages
  useEffect(() => {
    if (!connection) return;

    const handler = incoming => {
      const normalized = {
        ...incoming,
        messageContent: incoming.messageContent ?? incoming.message, // ‚úÖ normalize
      };

      if (
        normalized.contactId !== selectedContactId &&
        playSound &&
        userHasInteracted
      ) {
        new Audio("/sounds/inbox_notify.mp3").play().catch(() => {});
      }

      if (normalized.contactId === selectedContactId) {
        setMessages(prev => {
          if (!normalized.isIncoming) {
            // This is our own message coming back from the server; replace the temp one
            return prev.map(m => (m.status === "Sending" ? normalized : m));
          }
          // This is a new message from the contact; add it to the end
          return [...prev, normalized];
        });
      }
    };

    connection.on("ReceiveInboxMessage", handler);
    return () => connection.off("ReceiveInboxMessage", handler);
  }, [connection, selectedContactId, playSound, userHasInteracted]);

  // Function to toggle notification sound
  const toggleSound = async () => {
    const newVal = !playSound;
    if (newVal) {
      try {
        await new Audio("/sounds/inbox_notify.mp3").play();
        setPlaySound(true);
        localStorage.setItem("playSound", "true");
      } catch (err) {
        toast.error("üîá Browser blocked sound. Please enable autoplay.");
        setPlaySound(false);
        localStorage.setItem("playSound", "false");
      }
    } else {
      setPlaySound(false);
      localStorage.setItem("playSound", "false");
    }
  };

  // Function to send a message with optimistic UI
  const sendMessage = async () => {
    if (!selectedContactId || !newMessage.trim() || !isConnected) return;

    const tempId = `temp_${Date.now()}`;
    const optimisticMessage = {
      id: tempId,
      contactId: selectedContactId,
      messageContent: newMessage, // ‚úÖ consistent
      isIncoming: false,
      sentAt: new Date().toISOString(),
      status: "Sending",
    };

    setMessages(prev => [...prev, optimisticMessage]);
    setNewMessage("");

    try {
      await connection.invoke("SendMessageToContact", {
        contactId: selectedContactId,
        message: newMessage, // backend DTO expects "message"
      });
    } catch (err) {
      console.error("‚ùå Send failed:", err);
      toast.error("Failed to send message.");
      setMessages(prev =>
        prev.map(m => (m.id === tempId ? { ...m, status: "Failed" } : m))
      );
    }
  };

  // The value provided to all consumer components
  const value = {
    connection,
    isConnected,
    messages,
    selectedContactId,
    setSelectedContactId,
    newMessage,
    setNewMessage,
    contact,
    playSound,
    toggleSound,
    sendMessage,
    currentUserId,
  };

  return (
    <InboxContext.Provider value={value}>{children}</InboxContext.Provider>
  );
};

// import React, { createContext, useContext, useState, useEffect } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";

// const InboxContext = createContext();

// export const useInbox = () => useContext(InboxContext);

// export const InboxProvider = ({ children }) => {
//   // All state is managed here
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [playSound, setPlaySound] = useState(
//     localStorage.getItem("playSound") === "true"
//   );
//   const [userHasInteracted, setUserHasInteracted] = useState(false);

//   const currentUserId = localStorage.getItem("userId");

//   // Track user interaction for sound autoplay
//   useEffect(() => {
//     const handleUserInteraction = () => setUserHasInteracted(true);
//     window.addEventListener("click", handleUserInteraction);
//     window.addEventListener("keydown", handleUserInteraction);
//     return () => {
//       window.removeEventListener("click", handleUserInteraction);
//       window.removeEventListener("keydown", handleUserInteraction);
//     };
//   }, []);

//   // Fetch contact details when a contact is selected
//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
//       setContact(res.data);
//     });
//   }, [selectedContactId]);

//   // Load message history with robust clearing logic
//   useEffect(() => {
//     if (!selectedContactId) {
//       setMessages([]);
//       return;
//     }
//     setMessages([]); // Instantly clear old messages for better UX
//     axiosClient
//       .get(`/inbox/messages?contactId=${selectedContactId}`)
//       .then(res => setMessages(res.data))
//       .catch(err => {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       });
//   }, [selectedContactId]);

//   // SignalR listener for incoming messages
//   useEffect(() => {
//     if (!connection) return;
//     const handler = incoming => {
//       if (
//         incoming.contactId !== selectedContactId &&
//         playSound &&
//         userHasInteracted
//       ) {
//         new Audio("/sounds/inbox_notify.mp3").play().catch(() => {});
//       }

//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev => {
//           if (!incoming.isIncoming) {
//             // This is our own message coming back from the server; replace the temp one
//             return prev.map(m => (m.status === "Sending" ? incoming : m));
//           }
//           // This is a new message from the contact; add it to the end
//           return [...prev, incoming];
//         });
//       }
//     };

//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId, playSound, userHasInteracted]);

//   // Function to toggle notification sound
//   const toggleSound = async () => {
//     const newVal = !playSound;
//     if (newVal) {
//       try {
//         await new Audio("/sounds/inbox_notify.mp3").play();
//         setPlaySound(true);
//         localStorage.setItem("playSound", "true");
//       } catch (err) {
//         toast.error("üîá Browser blocked sound. Please enable autoplay.");
//         setPlaySound(false);
//         localStorage.setItem("playSound", "false");
//       }
//     } else {
//       setPlaySound(false);
//       localStorage.setItem("playSound", "false");
//     }
//   };

//   // Function to send a message with optimistic UI
//   const sendMessage = async () => {
//     if (!selectedContactId || !newMessage.trim() || !isConnected) return;

//     const tempId = `temp_${Date.now()}`;
//     const optimisticMessage = {
//       id: tempId,
//       contactId: selectedContactId,
//       messageContent: newMessage,
//       isIncoming: false,
//       sentAt: new Date().toISOString(),
//       status: "Sending",
//     };

//     setMessages(prev => [...prev, optimisticMessage]);
//     setNewMessage("");

//     try {
//       await connection.invoke("SendMessageToContact", {
//         contactId: selectedContactId,
//         message: newMessage,
//       });
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//       setMessages(prev =>
//         prev.map(m => (m.id === tempId ? { ...m, status: "Failed" } : m))
//       );
//     }
//   };

//   // The value provided to all consumer components
//   const value = {
//     connection,
//     isConnected,
//     messages,
//     selectedContactId,
//     setSelectedContactId,
//     newMessage,
//     setNewMessage,
//     contact,
//     playSound,
//     toggleSound,
//     sendMessage,
//     currentUserId,
//   };

//   return (
//     <InboxContext.Provider value={value}>{children}</InboxContext.Provider>
//   );
// };
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\InboxWrapper.jsx 
====================================================== 
 
import React, { useState, useEffect } from "react";
import { InboxProvider, useInbox } from "./InboxContext";
import InboxSidebar from "./components/InboxSidebar";
import ChatWindow from "./components/ChatWindow";
import ChatInput from "./components/ChatInput";
import ContactSidebar from "./components/ContactSidebar";
import ChatHeader from "./components/ChatHeader";
import { ChevronLeft, ChevronRight, Bell } from "lucide-react";

// The layout component gets its data from our new hook
function InboxLayout() {
  const {
    selectedContactId,
    setSelectedContactId,
    currentUserId,
    playSound,
    toggleSound,
  } = useInbox();

  const [showRightPanel, setShowRightPanel] = useState(true);

  // Control body scrolling when inbox is mounted
  useEffect(() => {
    // Store original styles
    const originalBodyOverflow = document.body.style.overflow;
    const originalHtmlOverflow = document.documentElement.style.overflow;

    // Add classes to prevent scrolling
    document.body.classList.add("inbox-active");
    document.documentElement.classList.add("inbox-active");

    // Force prevent scrolling
    document.body.style.overflow = "hidden";
    document.documentElement.style.overflow = "hidden";

    // Cleanup function to restore original styles
    return () => {
      document.body.classList.remove("inbox-active");
      document.documentElement.classList.remove("inbox-active");
      document.body.style.overflow = originalBodyOverflow;
      document.documentElement.style.overflow = originalHtmlOverflow;
    };
  }, []);

  return (
    <div className="inbox-fullscreen h-screen flex flex-col overflow-hidden">
      <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0">
        <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
          <span className="text-xl">üì®</span>
          Inbox
        </div>
        <div className="flex items-center gap-4">
          <button
            onClick={toggleSound}
            className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${
              playSound
                ? "bg-green-100 text-green-600 border-green-300"
                : "bg-gray-100 text-gray-500 border-gray-300"
            }`}
          >
            <Bell size={14} /> {playSound ? "Sound ON" : "Sound OFF"}
          </button>
        </div>
      </header>

      <div className="flex flex-1 overflow-hidden">
        {/* Left Sidebar - Always visible */}
        <div
          className="bg-white border-r overflow-y-auto"
          style={{
            width: "288px",
            minWidth: "288px",
            maxWidth: "288px",
            height: "100%",
          }}
        >
          <InboxSidebar
            onSelect={id => setSelectedContactId(id)}
            currentUserId={currentUserId}
          />
        </div>

        <div className="flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative">
          <button
            className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
            onClick={() => setShowRightPanel(!showRightPanel)}
            title={showRightPanel ? "Hide contact info" : "Show contact info"}
          >
            {showRightPanel ? (
              <ChevronRight size={16} />
            ) : (
              <ChevronLeft size={16} />
            )}
          </button>

          {selectedContactId ? (
            <>
              {/* Chat Header - Fixed at top */}
              <div className="shrink-0">
                <ChatHeader contactId={selectedContactId} />
              </div>

              {/* Chat Window - Scrollable area that takes remaining space */}
              <div className="flex-1 overflow-hidden">
                <ChatWindow />
              </div>

              {/* Chat Input - Fixed at bottom */}
              <div className="shrink-0" style={{ flexShrink: 0 }}>
                <ChatInput />
              </div>
            </>
          ) : (
            <div className="flex-1 flex items-center justify-center text-gray-400">
              Please select a contact to start chatting.
            </div>
          )}
        </div>

        {showRightPanel && selectedContactId && (
          <div
            className="w-80 border-l bg-white overflow-y-auto"
            style={{ height: "100%", maxHeight: "100%" }}
          >
            <ContactSidebar contactId={selectedContactId} />
          </div>
        )}
      </div>
    </div>
  );
}

// The final export wraps our layout with the provider
export default function InboxWrapper() {
  return (
    <InboxProvider>
      <InboxLayout />
    </InboxProvider>
  );
}
// import React, { useEffect, useState } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import InboxSidebar from "./components/InboxSidebar";
// import ChatWindow from "./components/ChatWindow";
// import ChatInput from "./components/ChatInput";
// import ContactSidebar from "./components/ContactSidebar";
// import ChatHeader from "./components/ChatHeader";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import { ChevronLeft, ChevronRight, Bell } from "lucide-react";
// import { InboxProvider, useInbox } from "./InboxContext";
// export default function InboxWrapper() {
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [showRightPanel, setShowRightPanel] = useState(true);
//   const [playSound, setPlaySound] = useState(
//     localStorage.getItem("playSound") === "true"
//   );
//   const [userHasInteracted, setUserHasInteracted] = useState(false);

//   const currentUserId = localStorage.getItem("userId");

//   // ‚úÖ Track first user interaction to allow audio play
//   useEffect(() => {
//     const handleUserInteraction = () => setUserHasInteracted(true);
//     window.addEventListener("click", handleUserInteraction);
//     window.addEventListener("keydown", handleUserInteraction);
//     return () => {
//       window.removeEventListener("click", handleUserInteraction);
//       window.removeEventListener("keydown", handleUserInteraction);
//     };
//   }, []);

//   // üîä Sound toggle with permission
//   const toggleSound = async () => {
//     const newVal = !playSound;

//     if (newVal) {
//       try {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         await audio.play();
//         audio.pause();
//         setPlaySound(true);
//         localStorage.setItem("playSound", "true");
//       } catch (err) {
//         toast.error("üîá Browser blocked sound. Allow autoplay.");
//         console.warn("‚ö†Ô∏è Audio play blocked:", err);
//         setPlaySound(false);
//         localStorage.setItem("playSound", "false");
//       }
//     } else {
//       setPlaySound(false);
//       localStorage.setItem("playSound", "false");
//     }
//   };

//   // üìû Fetch contact info on select
//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
//       setContact(res.data);
//     });
//   }, [selectedContactId]);

//   // üì© Load message history
//   useEffect(() => {
//     if (!selectedContactId) return;
//     axiosClient
//       .get(`/inbox/messages?contactId=${selectedContactId}`)
//       .then(res => setMessages(res.data))
//       .catch(err => {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       });
//   }, [selectedContactId]);

//   // üöÄ Send message
//   // const sendMessage = async () => {
//   //   if (!selectedContactId)
//   //     return toast.error("‚ùó Please select a contact first.");
//   //   if (!newMessage.trim()) return toast.warn("‚ö†Ô∏è Please type a message.");
//   //   if (!connection || !isConnected)
//   //     return toast.error("‚ùå SignalR not connected.");

//   //   try {
//   //     await connection.invoke("SendMessageToContact", {
//   //       contactId: selectedContactId,
//   //       message: newMessage,
//   //     });
//   //     setNewMessage("");
//   //   } catch (err) {
//   //     console.error("‚ùå Send failed:", err);
//   //     toast.error("Failed to send message.");
//   //   }
//   // };
//   const sendMessage = async () => {
//     if (!selectedContactId || !newMessage.trim()) return;
//     if (!connection || !isConnected)
//       return toast.error("‚ùå SignalR not connected.");

//     // 1. Create a temporary message for optimistic UI
//     const tempId = `temp_${Date.now()}`;
//     const optimisticMessage = {
//       id: tempId,
//       contactId: selectedContactId,
//       messageContent: newMessage,
//       isIncoming: false,
//       sentAt: new Date().toISOString(),
//       status: "Sending", // Special status for the UI
//     };

//     // 2. Add to state immediately and clear input
//     setMessages(prevMessages => [...prevMessages, optimisticMessage]);
//     setNewMessage("");

//     try {
//       // 3. Send to server
//       await connection.invoke("SendMessageToContact", {
//         contactId: selectedContactId,
//         message: newMessage,
//         // Optional: send tempId to make replacement easier
//         // tempId: tempId
//       });
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//       // Handle error: update the optimistic message to show a "Failed" status
//       setMessages(prev =>
//         prev.map(m => (m.id === tempId ? { ...m, status: "Failed" } : m))
//       );
//     }
//   };
//   // üîî Real-time message listener
//   // useEffect(() => {
//   //   if (!connection) return;

//   //   const handler = incoming => {
//   //     if (
//   //       incoming.contactId !== selectedContactId &&
//   //       playSound &&
//   //       userHasInteracted
//   //     ) {
//   //       try {
//   //         const audio = new Audio("/sounds/inbox_notify.mp3");
//   //         audio.play().catch(err => {
//   //           console.warn("üîá Browser prevented sound playback:", err);
//   //         });
//   //       } catch (err) {
//   //         console.warn("‚ùå Sound error:", err);
//   //       }
//   //     }

//   //     if (incoming.contactId === selectedContactId) {
//   //       setMessages(prev =>
//   //         [...prev, incoming].sort(
//   //           (a, b) =>
//   //             new Date(a.sentAt || a.createdAt) -
//   //             new Date(b.sentAt || b.createdAt)
//   //         )
//   //       );
//   //     }
//   //   };
//   useEffect(() => {
//     if (!connection) return;

//     const handler = incoming => {
//       // ... sound playing logic ...

//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev => {
//           // If the message is from the current user, replace the temp message
//           if (!incoming.isIncoming) {
//             return prev.map(m => (m.status === "Sending" ? incoming : m));
//           }
//           // Otherwise, just add the new incoming message
//           return [...prev, incoming];
//         });
//       }
//     };
//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId, playSound, userHasInteracted]);

//   return (
//     <div className="h-screen flex flex-col overflow-hidden">
//       {/* üîí Top App Bar */}
//       <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0">
//         <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
//           <span className="text-xl">üì®</span> Inbox
//         </div>
//         <div className="flex items-center gap-4">
//           <button
//             onClick={toggleSound}
//             className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${
//               playSound
//                 ? "bg-green-100 text-green-600 border-green-300"
//                 : "bg-gray-100 text-gray-500 border-gray-300"
//             }`}
//           >
//             <Bell size={14} /> {playSound ? "Sound ON" : "Sound OFF"}
//           </button>
//         </div>
//       </header>

//       {/* üí¨ Main layout */}
//       <div className="flex flex-1 overflow-hidden">
//         {/* üìá Left Sidebar */}
//         <div className="w-72 border-r bg-white overflow-y-auto">
//           <InboxSidebar
//             onSelect={id => setSelectedContactId(id)}
//             currentUserId={currentUserId}
//           />
//         </div>

//         {/* üí¨ Chat Area */}
//         <div className="flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative">
//           <button
//             className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
//             onClick={() => setShowRightPanel(!showRightPanel)}
//             title={showRightPanel ? "Hide contact info" : "Show contact info"}
//           >
//             {showRightPanel ? (
//               <ChevronRight size={16} />
//             ) : (
//               <ChevronLeft size={16} />
//             )}
//           </button>

//           {selectedContactId ? (
//             <>
//               <div className="shrink-0">
//                 <ChatHeader contact={contact} />
//               </div>
//               <div className="flex-1 overflow-y-auto">
//                 <ChatWindow
//                   messages={messages}
//                   currentUserId={currentUserId}
//                   selectedContactId={selectedContactId}
//                   connection={connection}
//                 />
//               </div>
//               <div className="shrink-0">
//                 <ChatInput
//                   value={newMessage}
//                   onChange={e => setNewMessage(e.target.value)}
//                   onSend={sendMessage}
//                   disabled={!isConnected}
//                 />
//               </div>
//             </>
//           ) : (
//             <div className="flex-1 flex items-center justify-center text-gray-400">
//               Please select a contact to start chatting.
//             </div>
//           )}
//         </div>

//         {/* üìá Right Panel */}
//         {showRightPanel && selectedContactId && (
//           <div className="w-80 border-l bg-white overflow-y-auto">
//             <ContactSidebar contactId={selectedContactId} />
//           </div>
//         )}
//       </div>
//     </div>
//   );
// }

// import React, { useEffect, useState } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import InboxSidebar from "./components/InboxSidebar";
// import ChatWindow from "./components/ChatWindow";
// import ChatInput from "./components/ChatInput";
// import ContactSidebar from "./components/ContactSidebar";
// import ChatHeader from "./components/ChatHeader";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import { ChevronLeft, ChevronRight, Bell } from "lucide-react";

// export default function InboxWrapper() {
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [showRightPanel, setShowRightPanel] = useState(true);
//   const [playSound, setPlaySound] = useState(
//     localStorage.getItem("playSound") === "true"
//   );

//   const currentUserId = localStorage.getItem("userId");

//   // üîä Sound toggle with permission
//   const toggleSound = async () => {
//     const newVal = !playSound;

//     if (newVal) {
//       try {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         await audio.play();
//         audio.pause();
//         setPlaySound(true);
//         localStorage.setItem("playSound", "true");
//       } catch (err) {
//         toast.error("üîá Browser blocked sound. Allow autoplay.");
//         console.warn("‚ö†Ô∏è Audio play blocked:", err);
//         setPlaySound(false);
//         localStorage.setItem("playSound", "false");
//       }
//     } else {
//       setPlaySound(false);
//       localStorage.setItem("playSound", "false");
//     }
//   };

//   // üìû Fetch contact info on select
//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
//       setContact(res.data);
//     });
//   }, [selectedContactId]);

//   // üì© Load message history
//   useEffect(() => {
//     if (!selectedContactId) return;
//     axiosClient
//       .get(`/inbox/messages?contactId=${selectedContactId}`)
//       .then(res => setMessages(res.data))
//       .catch(err => {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       });
//   }, [selectedContactId]);

//   // üöÄ Send message
//   const sendMessage = async () => {
//     if (!selectedContactId)
//       return toast.error("‚ùó Please select a contact first.");
//     if (!newMessage.trim()) return toast.warn("‚ö†Ô∏è Please type a message.");
//     if (!connection || !isConnected)
//       return toast.error("‚ùå SignalR not connected.");

//     try {
//       await connection.invoke("SendMessageToContact", {
//         contactId: selectedContactId,
//         message: newMessage,
//       });
//       setNewMessage("");
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//     }
//   };

//   // üîî Real-time message listener
//   useEffect(() => {
//     if (!connection) return;

//     const handler = incoming => {
//       if (incoming.contactId !== selectedContactId && playSound) {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         audio.play();
//       }

//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev =>
//           [...prev, incoming].sort(
//             (a, b) =>
//               new Date(a.sentAt || a.createdAt) -
//               new Date(b.sentAt || b.createdAt)
//           )
//         );
//       }
//     };

//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId, playSound]);

//   return (
//     <div className="h-screen flex flex-col overflow-hidden">
//       {/* üîí Top App Bar */}
//       <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0">
//         <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
//           <span className="text-xl">üì®</span> Inbox
//         </div>
//         <div className="flex items-center gap-4">
//           <button
//             onClick={toggleSound}
//             className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${
//               playSound
//                 ? "bg-green-100 text-green-600 border-green-300"
//                 : "bg-gray-100 text-gray-500 border-gray-300"
//             }`}
//           >
//             <Bell size={14} /> {playSound ? "Sound ON" : "Sound OFF"}
//           </button>
//           <div className="text-sm text-gray-500">xByteChat</div>
//         </div>
//       </header>

//       {/* üí¨ Main layout */}
//       <div className="flex flex-1 overflow-hidden">
//         {/* üìá Left Sidebar */}
//         <div className="w-72 border-r bg-white overflow-y-auto">
//           <InboxSidebar
//             onSelect={id => setSelectedContactId(id)}
//             currentUserId={currentUserId}
//           />
//         </div>

//         {/* üí¨ Chat Area */}
//         <div className="flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative">
//           <button
//             className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
//             onClick={() => setShowRightPanel(!showRightPanel)}
//             title={showRightPanel ? "Hide contact info" : "Show contact info"}
//           >
//             {showRightPanel ? (
//               <ChevronRight size={16} />
//             ) : (
//               <ChevronLeft size={16} />
//             )}
//           </button>

//           {selectedContactId ? (
//             <>
//               <div className="shrink-0">
//                 <ChatHeader contact={contact} />
//               </div>
//               <div className="flex-1 overflow-y-auto">
//                 <ChatWindow
//                   messages={messages}
//                   currentUserId={currentUserId}
//                   selectedContactId={selectedContactId}
//                   connection={connection}
//                 />
//               </div>
//               <div className="shrink-0">
//                 <ChatInput
//                   value={newMessage}
//                   onChange={e => setNewMessage(e.target.value)}
//                   onSend={sendMessage}
//                   disabled={!isConnected}
//                 />
//               </div>
//             </>
//           ) : (
//             <div className="flex-1 flex items-center justify-center text-gray-400">
//               Please select a contact to start chatting.
//             </div>
//           )}
//         </div>

//         {/* üìá Right Panel */}
//         {showRightPanel && selectedContactId && (
//           <div className="w-80 border-l bg-white overflow-y-auto">
//             <ContactSidebar contactId={selectedContactId} />
//           </div>
//         )}
//       </div>
//     </div>
//   );
// }

// import React, { useEffect, useState } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import InboxSidebar from "./components/InboxSidebar";
// import ChatWindow from "./components/ChatWindow";
// import ChatInput from "./components/ChatInput";
// import ContactSidebar from "./components/ContactSidebar";
// import ChatHeader from "./components/ChatHeader";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import { ChevronLeft, ChevronRight, Bell } from "lucide-react";

// export default function InboxWrapper() {
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [showRightPanel, setShowRightPanel] = useState(true);
//   const [playSound, setPlaySound] = useState(
//     localStorage.getItem("playSound") === "true"
//   );

//   const currentUserId = localStorage.getItem("userId");

//   const toggleSound = async () => {
//     const newVal = !playSound;

//     if (newVal) {
//       // Try to play dummy sound to get permission
//       try {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         await audio.play();
//         audio.pause();
//         setPlaySound(true);
//         localStorage.setItem("playSound", "true");
//       } catch (err) {
//         toast.error("üîá Your browser blocked sound. Please allow autoplay.");
//         console.warn("‚ö†Ô∏è Audio play blocked:", err);
//         setPlaySound(false);
//         localStorage.setItem("playSound", "false");
//       }
//     } else {
//       setPlaySound(false);
//       localStorage.setItem("playSound", "false");
//     }
//   };

//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
//       setContact(res.data);
//     });
//   }, [selectedContactId]);

//   useEffect(() => {
//     if (!selectedContactId) return;
//     axiosClient
//       .get(`/inbox/messages?contactId=${selectedContactId}`)
//       .then(res => setMessages(res.data))
//       .catch(err => {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       });
//   }, [selectedContactId]);

//   const sendMessage = async () => {
//     if (!selectedContactId)
//       return toast.error("‚ùó Please select a contact first.");
//     if (!newMessage.trim()) return toast.warn("‚ö†Ô∏è Please type a message.");
//     if (!connection || !isConnected)
//       return toast.error("‚ùå SignalR not connected.");

//     try {
//       await connection.invoke("SendMessageToContact", {
//         contactId: selectedContactId,
//         message: newMessage,
//       });
//       setNewMessage("");
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//     }
//   };

//   useEffect(() => {
//     if (!connection) return;
//     const handler = incoming => {
//       // ‚úÖ Play sound only if it's from another contact
//       if (incoming.contactId !== selectedContactId && playSound) {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         audio.play();
//       }
//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev =>
//           [...prev, incoming].sort(
//             (a, b) =>
//               new Date(a.sentAt || a.createdAt) -
//               new Date(b.sentAt || b.createdAt)
//           )
//         );
//       }
//     };
//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId, playSound]);

//   return (
//     <div className="h-screen flex flex-col overflow-hidden">
//       {/* üîí Top App Bar */}
//       <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0">
//         <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
//           <span className="text-xl">üì®</span> Inbox
//         </div>
//         <div className="flex items-center gap-4">
//           <button
//             onClick={toggleSound}
//             className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${
//               playSound
//                 ? "bg-green-100 text-green-600 border-green-300"
//                 : "bg-gray-100 text-gray-500 border-gray-300"
//             }`}
//           >
//             <Bell size={14} /> {playSound ? "Sound ON" : "Sound OFF"}
//           </button>
//           <div className="text-sm text-gray-500">xByteChat</div>
//         </div>
//       </header>

//       {/* üí¨ Main 3-column layout */}
//       <div className="flex flex-1 overflow-hidden">
//         {/* üìá Left Sidebar */}
//         <div className="w-72 border-r bg-white overflow-y-auto">
//           <InboxSidebar onSelect={id => setSelectedContactId(id)} />
//         </div>

//         {/* üí¨ Chat column */}
//         <div className="flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative">
//           <button
//             className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
//             onClick={() => setShowRightPanel(!showRightPanel)}
//             title={showRightPanel ? "Hide contact info" : "Show contact info"}
//           >
//             {showRightPanel ? (
//               <ChevronRight size={16} />
//             ) : (
//               <ChevronLeft size={16} />
//             )}
//           </button>

//           {selectedContactId ? (
//             <>
//               <div className="shrink-0">
//                 <ChatHeader contact={contact} />
//               </div>
//               <div className="flex-1 overflow-y-auto">
//                 <ChatWindow
//                   messages={messages}
//                   currentUserId={currentUserId}
//                   selectedContactId={selectedContactId}
//                   connection={connection}
//                 />
//               </div>
//               <div className="shrink-0">
//                 <ChatInput
//                   value={newMessage}
//                   onChange={e => setNewMessage(e.target.value)}
//                   onSend={sendMessage}
//                   disabled={!isConnected}
//                 />
//               </div>
//             </>
//           ) : (
//             <div className="flex-1 flex items-center justify-center text-gray-400">
//               Please select a contact to start chatting.
//             </div>
//           )}
//         </div>

//         {/* üìá Right Contact Info */}
//         {showRightPanel && selectedContactId && (
//           <div className="w-80 border-l bg-white overflow-y-auto">
//             <ContactSidebar contactId={selectedContactId} />
//           </div>
//         )}
//       </div>
//     </div>
//   );
// }

// import React, { useEffect, useState } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import InboxSidebar from "./components/InboxSidebar";
// import ChatWindow from "./components/ChatWindow";
// import ChatInput from "./components/ChatInput";
// import ContactSidebar from "./components/ContactSidebar";
// import ChatHeader from "./components/ChatHeader";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import { ChevronLeft, ChevronRight, Bell } from "lucide-react";

// export default function InboxWrapper() {
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [showRightPanel, setShowRightPanel] = useState(true);
//   const [playSound, setPlaySound] = useState(
//     localStorage.getItem("playSound") === "true"
//   );

//   const currentUserId = localStorage.getItem("userId");

//   const toggleSound = async () => {
//     const newVal = !playSound;

//     if (newVal) {
//       try {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         await audio.play();
//         audio.pause();
//         setPlaySound(true);
//         localStorage.setItem("playSound", "true");
//       } catch (err) {
//         toast.error("üîá Your browser blocked sound. Please allow autoplay.");
//         console.warn("‚ö†Ô∏è Audio play blocked:", err);
//         setPlaySound(false);
//         localStorage.setItem("playSound", "false");
//       }
//     } else {
//       setPlaySound(false);
//       localStorage.setItem("playSound", "false");
//     }
//   };

//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
//       setContact(res.data);
//     });
//   }, [selectedContactId]);

//   useEffect(() => {
//     if (!selectedContactId) return;
//     axiosClient
//       .get(`/inbox/messages?contactId=${selectedContactId}`)
//       .then(res => setMessages(res.data))
//       .catch(err => {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       });
//   }, [selectedContactId]);

//   const sendMessage = async () => {
//     if (!selectedContactId)
//       return toast.error("‚ùó Please select a contact first.");
//     if (!newMessage.trim()) return toast.warn("‚ö†Ô∏è Please type a message.");
//     if (!connection || !isConnected)
//       return toast.error("‚ùå SignalR not connected.");

//     try {
//       await connection.invoke("SendMessageToContact", {
//         contactId: selectedContactId,
//         message: newMessage,
//       });
//       setNewMessage("");
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//     }
//   };

//   useEffect(() => {
//     if (!connection) return;

//     const handler = incoming => {
//       if (incoming.contactId !== selectedContactId && playSound) {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         audio.play();
//       }

//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev =>
//           [...prev, incoming].sort(
//             (a, b) =>
//               new Date(a.sentAt || a.createdAt) -
//               new Date(b.sentAt || b.createdAt)
//           )
//         );
//       }
//     };

//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId, playSound]);

//   return (
//     <div className="h-screen flex flex-col overflow-hidden">
//       {/* üîí Top App Bar */}
//       <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0">
//         <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
//           üì® Inbox
//         </div>
//         <div className="flex items-center gap-4">
//           <button
//             onClick={toggleSound}
//             className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${
//               playSound
//                 ? "bg-green-100 text-green-600 border-green-300"
//                 : "bg-gray-100 text-gray-500 border-gray-300"
//             }`}
//           >
//             <Bell size={14} /> {playSound ? "Sound ON" : "Sound OFF"}
//           </button>
//           <div className="text-sm text-gray-500">xByteChat</div>
//         </div>
//       </header>

//       {/* üí¨ Main 3-column layout */}
//       <div className="flex flex-1 overflow-hidden">
//         {/* üìá Left Sidebar */}
//         <div className="w-72 border-r bg-white overflow-y-auto">
//           <InboxSidebar onSelect={id => setSelectedContactId(id)} />
//         </div>

//         {/* üí¨ Chat column */}
//         <div className="flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative">
//           <button
//             className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
//             onClick={() => setShowRightPanel(!showRightPanel)}
//             title={showRightPanel ? "Hide contact info" : "Show contact info"}
//           >
//             {showRightPanel ? (
//               <ChevronRight size={16} />
//             ) : (
//               <ChevronLeft size={16} />
//             )}
//           </button>

//           {selectedContactId ? (
//             <>
//               <div className="shrink-0">
//                 <ChatHeader contact={contact} />
//               </div>
//               <div className="flex-1 overflow-y-auto">
//                 <ChatWindow messages={messages} currentUserId={currentUserId} />
//               </div>
//               <div className="shrink-0">
//                 <ChatInput
//                   value={newMessage}
//                   onChange={e => setNewMessage(e.target.value)}
//                   onSend={sendMessage}
//                   disabled={!isConnected}
//                 />
//               </div>
//             </>
//           ) : (
//             <div className="flex-1 flex items-center justify-center text-gray-400">
//               Please select a contact to start chatting.
//             </div>
//           )}
//         </div>

//         {/* üìá Right Contact Info */}
//         {showRightPanel && selectedContactId && (
//           <div className="w-80 border-l bg-white overflow-y-auto">
//             <ContactSidebar contactId={selectedContactId} />
//           </div>
//         )}
//       </div>
//     </div>
//   );
// }

// // ‚úÖ Updated InboxWrapper.jsx with stable notification sound toggle via useNotificationSound
// import React, { useEffect, useState } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import useNotificationSound from "../../hooks/useNotificationSound";
// import InboxSidebar from "./components/InboxSidebar";
// import ChatWindow from "./components/ChatWindow";
// import ChatInput from "./components/ChatInput";
// import ContactSidebar from "./components/ContactSidebar";
// import ChatHeader from "./components/ChatHeader";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import { ChevronLeft, ChevronRight, Bell } from "lucide-react";

// export default function InboxWrapper() {
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [showRightPanel, setShowRightPanel] = useState(true);
//   const currentUserId = localStorage.getItem("userId");

//   const { isSoundOn, toggleSound, soundRef } = useNotificationSound();

//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
//       setContact(res.data);
//     });
//   }, [selectedContactId]);

//   useEffect(() => {
//     if (!selectedContactId) return;
//     axiosClient
//       .get(`/inbox/messages?contactId=${selectedContactId}`)
//       .then(res => setMessages(res.data))
//       .catch(err => {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       });
//   }, [selectedContactId]);

//   const sendMessage = async () => {
//     if (!selectedContactId)
//       return toast.error("‚ùó Please select a contact first.");
//     if (!newMessage.trim()) return toast.warn("‚ö†Ô∏è Please type a message.");
//     if (!connection || !isConnected)
//       return toast.error("‚ùå SignalR not connected.");

//     try {
//       await connection.invoke("SendMessageToContact", {
//         contactId: selectedContactId,
//         message: newMessage,
//       });
//       setNewMessage("");
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//     }
//   };

//   useEffect(() => {
//     if (!connection) return;

//     const handler = incoming => {
//       // ‚úÖ Use soundRef for latest value
//       if (incoming.contactId !== selectedContactId && soundRef.current) {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         audio.play();
//       }

//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev =>
//           [...prev, incoming].sort(
//             (a, b) =>
//               new Date(a.sentAt || a.createdAt) -
//               new Date(b.sentAt || b.createdAt)
//           )
//         );
//       }
//     };

//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId, soundRef]);

//   return (
//     <div className="h-screen flex flex-col overflow-hidden">
//       {/* üîí Top App Bar */}
//       <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0">
//         <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
//           üì® Inbox
//         </div>
//         <div className="flex items-center gap-4">
//           <button
//             onClick={toggleSound}
//             className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${
//               isSoundOn
//                 ? "bg-green-100 text-green-600 border-green-300"
//                 : "bg-gray-100 text-gray-500 border-gray-300"
//             }`}
//           >
//             <Bell size={14} /> {isSoundOn ? "Sound ON" : "Sound OFF"}
//           </button>
//           <div className="text-sm text-gray-500">xByteChat</div>
//         </div>
//       </header>

//       {/* üí¨ Main 3-column layout */}
//       <div className="flex flex-1 overflow-hidden">
//         {/* üìá Left Sidebar */}
//         <div className="w-72 border-r bg-white overflow-y-auto">
//           <InboxSidebar onSelect={id => setSelectedContactId(id)} />
//         </div>

//         {/* üí¨ Chat column */}
//         <div className="flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative">
//           <button
//             className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
//             onClick={() => setShowRightPanel(!showRightPanel)}
//             title={showRightPanel ? "Hide contact info" : "Show contact info"}
//           >
//             {showRightPanel ? (
//               <ChevronRight size={16} />
//             ) : (
//               <ChevronLeft size={16} />
//             )}
//           </button>

//           {selectedContactId ? (
//             <>
//               <div className="shrink-0">
//                 <ChatHeader contact={contact} />
//               </div>
//               <div className="flex-1 overflow-y-auto">
//                 <ChatWindow messages={messages} currentUserId={currentUserId} />
//               </div>
//               <div className="shrink-0">
//                 <ChatInput
//                   value={newMessage}
//                   onChange={e => setNewMessage(e.target.value)}
//                   onSend={sendMessage}
//                   disabled={!isConnected}
//                 />
//               </div>
//             </>
//           ) : (
//             <div className="flex-1 flex items-center justify-center text-gray-400">
//               Please select a contact to start chatting.
//             </div>
//           )}
//         </div>

//         {/* üìá Right Contact Info */}
//         {showRightPanel && selectedContactId && (
//           <div className="w-80 border-l bg-white overflow-y-auto">
//             <ContactSidebar contactId={selectedContactId} />
//           </div>
//         )}
//       </div>
//     </div>
//   );
// }

// ‚úÖ Updated InboxWrapper.jsx with Notification Sound Toggle + Play Logic
// import React, { useEffect, useState } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import InboxSidebar from "./components/InboxSidebar";
// import ChatWindow from "./components/ChatWindow";
// import ChatInput from "./components/ChatInput";
// import ContactSidebar from "./components/ContactSidebar";
// import ChatHeader from "./components/ChatHeader";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import { ChevronLeft, ChevronRight, Bell } from "lucide-react";

// export default function InboxWrapper() {
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [showRightPanel, setShowRightPanel] = useState(true);
//   const [playSound, setPlaySound] = useState(
//     localStorage.getItem("playSound") === "true"
//   );

//   const currentUserId = localStorage.getItem("userId");

//   // const toggleSound = () => {
//   //   const newVal = !playSound;
//   //   setPlaySound(newVal);
//   //   localStorage.setItem("playSound", newVal);
//   // };
//   const toggleSound = async () => {
//     const newVal = !playSound;

//     if (newVal) {
//       // Try to play dummy sound to get permission
//       try {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         await audio.play();
//         audio.pause();
//         setPlaySound(true);
//         localStorage.setItem("playSound", "true");
//       } catch (err) {
//         toast.error("üîá Your browser blocked sound. Please allow autoplay.");
//         console.warn("‚ö†Ô∏è Audio play blocked:", err);
//         setPlaySound(false);
//         localStorage.setItem("playSound", "false");
//       }
//     } else {
//       setPlaySound(false);
//       localStorage.setItem("playSound", "false");
//     }
//   };

//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
//       setContact(res.data);
//     });
//   }, [selectedContactId]);

//   useEffect(() => {
//     if (!selectedContactId) return;
//     axiosClient
//       .get(`/inbox/messages?contactId=${selectedContactId}`)
//       .then(res => setMessages(res.data))
//       .catch(err => {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       });
//   }, [selectedContactId]);

//   const sendMessage = async () => {
//     if (!selectedContactId)
//       return toast.error("‚ùó Please select a contact first.");
//     if (!newMessage.trim()) return toast.warn("‚ö†Ô∏è Please type a message.");
//     if (!connection || !isConnected)
//       return toast.error("‚ùå SignalR not connected.");

//     try {
//       await connection.invoke("SendMessageToContact", {
//         contactId: selectedContactId,
//         message: newMessage,
//       });
//       setNewMessage("");
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//     }
//   };

//   useEffect(() => {
//     if (!connection) return;
//     const handler = incoming => {
//       // ‚úÖ Play sound only if it's from another contact
//       if (incoming.contactId !== selectedContactId && playSound) {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         audio.play();
//       }
//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev =>
//           [...prev, incoming].sort(
//             (a, b) =>
//               new Date(a.sentAt || a.createdAt) -
//               new Date(b.sentAt || b.createdAt)
//           )
//         );
//       }
//     };
//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId, playSound]);

//   return (
//     <div className="h-screen flex flex-col overflow-hidden">
//       {/* üîí Top App Bar */}
//       <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0">
//         <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
//           üì® Inbox
//         </div>
//         <div className="flex items-center gap-4">
//           <button
//             onClick={toggleSound}
//             className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${
//               playSound
//                 ? "bg-green-100 text-green-600 border-green-300"
//                 : "bg-gray-100 text-gray-500 border-gray-300"
//             }`}
//           >
//             <Bell size={14} /> {playSound ? "Sound ON" : "Sound OFF"}
//           </button>
//           <div className="text-sm text-gray-500">xByteChat</div>
//         </div>
//       </header>

//       {/* üí¨ Main 3-column layout */}
//       <div className="flex flex-1 overflow-hidden">
//         {/* üìá Left Sidebar */}
//         <div className="w-72 border-r bg-white overflow-y-auto">
//           <InboxSidebar onSelect={id => setSelectedContactId(id)} />
//         </div>

//         {/* üí¨ Chat column */}
//         <div className="flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative">
//           <button
//             className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
//             onClick={() => setShowRightPanel(!showRightPanel)}
//             title={showRightPanel ? "Hide contact info" : "Show contact info"}
//           >
//             {showRightPanel ? (
//               <ChevronRight size={16} />
//             ) : (
//               <ChevronLeft size={16} />
//             )}
//           </button>

//           {selectedContactId ? (
//             <>
//               <div className="shrink-0">
//                 <ChatHeader contact={contact} />
//               </div>
//               <div className="flex-1 overflow-y-auto">
//                 <ChatWindow messages={messages} currentUserId={currentUserId} />
//               </div>
//               <div className="shrink-0">
//                 <ChatInput
//                   value={newMessage}
//                   onChange={e => setNewMessage(e.target.value)}
//                   onSend={sendMessage}
//                   disabled={!isConnected}
//                 />
//               </div>
//             </>
//           ) : (
//             <div className="flex-1 flex items-center justify-center text-gray-400">
//               Please select a contact to start chatting.
//             </div>
//           )}
//         </div>

//         {/* üìá Right Contact Info */}
//         {showRightPanel && selectedContactId && (
//           <div className="w-80 border-l bg-white overflow-y-auto">
//             <ContactSidebar contactId={selectedContactId} />
//           </div>
//         )}
//       </div>
//     </div>
//   );
// }

// import React, { useEffect, useState } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import InboxSidebar from "./components/InboxSidebar";
// import ChatWindow from "./components/ChatWindow";
// import ChatInput from "./components/ChatInput";
// import ContactSidebar from "./components/ContactSidebar";
// import ChatHeader from "./components/ChatHeader";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import { ChevronLeft, ChevronRight } from "lucide-react";

// export default function InboxWrapper() {
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [showRightPanel, setShowRightPanel] = useState(true);

//   const currentUserId = localStorage.getItem("userId");

//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
//       setContact(res.data);
//     });
//   }, [selectedContactId]);

//   useEffect(() => {
//     if (!selectedContactId) return;
//     axiosClient
//       .get(`/inbox/messages?contactId=${selectedContactId}`)
//       .then(res => setMessages(res.data))
//       .catch(err => {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       });
//   }, [selectedContactId]);

//   const sendMessage = async () => {
//     if (!selectedContactId)
//       return toast.error("‚ùó Please select a contact first.");
//     if (!newMessage.trim()) return toast.warn("‚ö†Ô∏è Please type a message.");
//     if (!connection || !isConnected)
//       return toast.error("‚ùå SignalR not connected.");

//     try {
//       await connection.invoke("SendMessageToContact", {
//         contactId: selectedContactId,
//         message: newMessage,
//       });
//       setNewMessage("");
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//     }
//   };

//   useEffect(() => {
//     if (!connection) return;
//     const handler = incoming => {
//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev =>
//           [...prev, incoming].sort(
//             (a, b) =>
//               new Date(a.sentAt || a.createdAt) -
//               new Date(b.sentAt || b.createdAt)
//           )
//         );
//       }
//     };
//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId]);

//   return (
//     <div className="h-screen flex flex-col overflow-hidden">
//       {/* üîí Top App Bar */}
//       <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0">
//         <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
//           üì® Inbox
//         </div>
//         <div className="text-sm text-gray-500">xByteChat</div>
//       </header>

//       {/* üí¨ Main 3-column layout */}
//       <div className="flex flex-1 overflow-hidden">
//         {/* üìá Left Sidebar */}
//         <div className="w-72 border-r bg-white overflow-y-auto">
//           <InboxSidebar onSelect={id => setSelectedContactId(id)} />
//         </div>

//         {/* üí¨ Chat column */}
//         <div className="flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative">
//           {/* ‚ÜîÔ∏è Toggle Right Panel */}
//           <button
//             className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
//             onClick={() => setShowRightPanel(!showRightPanel)}
//             title={showRightPanel ? "Hide contact info" : "Show contact info"}
//           >
//             {showRightPanel ? (
//               <ChevronRight size={16} />
//             ) : (
//               <ChevronLeft size={16} />
//             )}
//           </button>

//           {selectedContactId ? (
//             <>
//               {/* üßë Contact Header */}
//               <div className="shrink-0">
//                 <ChatHeader contact={contact} />
//               </div>

//               {/* üìú Message Scroll Area */}
//               <div className="flex-1 overflow-y-auto">
//                 <ChatWindow messages={messages} currentUserId={currentUserId} />
//               </div>

//               {/* ‚úèÔ∏è Chat Input (Fixed at bottom) */}
//               <div className="shrink-0">
//                 <ChatInput
//                   value={newMessage}
//                   onChange={e => setNewMessage(e.target.value)}
//                   onSend={sendMessage}
//                   disabled={!isConnected}
//                 />
//               </div>
//             </>
//           ) : (
//             <div className="flex-1 flex items-center justify-center text-gray-400">
//               Please select a contact to start chatting.
//             </div>
//           )}
//         </div>

//         {/* üìá Right Contact Info */}
//         {showRightPanel && selectedContactId && (
//           <div className="w-80 border-l bg-white overflow-y-auto">
//             <ContactSidebar contactId={selectedContactId} />
//           </div>
//         )}
//       </div>
//     </div>
//   );
// }

// import React, { useEffect, useState } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import InboxSidebar from "./components/InboxSidebar";
// import ChatWindow from "./components/ChatWindow";
// import ChatInput from "./components/ChatInput";
// import ContactSidebar from "./components/ContactSidebar";
// import ChatHeader from "./components/ChatHeader";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import { ChevronLeft, ChevronRight } from "lucide-react";
// import { Inbox } from "lucide-react"; // ‚úÖ Add this at top
// export default function InboxWrapper() {
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [showRightPanel, setShowRightPanel] = useState(true);

//   const currentUserId = localStorage.getItem("userId");

//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     const loadContact = async () => {
//       try {
//         const res = await axiosClient.get(`/contacts/${selectedContactId}`);
//         setContact(res.data);
//       } catch (err) {
//         console.error("‚ùå Failed to load contact:", err);
//       }
//     };
//     loadContact();
//   }, [selectedContactId]);

//   useEffect(() => {
//     if (!selectedContactId) return;
//     const loadMessages = async () => {
//       try {
//         const res = await axiosClient.get(
//           `/inbox/messages?contactId=${selectedContactId}`
//         );
//         setMessages(res.data);
//       } catch (err) {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       }
//     };
//     loadMessages();
//   }, [selectedContactId]);

//   const sendMessage = async () => {
//     if (!selectedContactId)
//       return toast.error("‚ùó Please select a contact first.");
//     if (!newMessage.trim()) return toast.warn("‚ö†Ô∏è Please type a message.");
//     if (!connection || !isConnected)
//       return toast.error("‚ùå SignalR not connected.");

//     const payload = {
//       contactId: selectedContactId,
//       message: newMessage,
//     };

//     try {
//       await connection.invoke("SendMessageToContact", payload);
//       setNewMessage("");
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//     }
//   };

//   useEffect(() => {
//     if (!connection) return;
//     const handler = incoming => {
//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev =>
//           [...prev, incoming].sort(
//             (a, b) =>
//               new Date(a.sentAt || a.createdAt) -
//               new Date(b.sentAt || b.createdAt)
//           )
//         );
//       }
//     };
//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId]);

//   return (
//     <div className="flex flex-col h-screen bg-white">
//       {/* üü£ Top App Bar */}
//       <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between">
//         <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
//           <Inbox size={18} className="text-purple-600" />
//           Inbox
//         </div>
//         <div className="text-sm text-gray-500">xByteChat</div>
//       </header>

//       {/* üí¨ Main Body Layout */}
//       <div className="flex flex-1 overflow-hidden">
//         {/* Sidebar */}
//         <div className="w-72 border-r bg-white overflow-y-auto">
//           <InboxSidebar onSelect={id => setSelectedContactId(id)} />
//         </div>

//         {/* Chat Column */}
//         <div className="flex flex-col flex-1 bg-[#f0f0eb] relative">
//           {/* Toggle Right Panel Button */}
//           <button
//             className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
//             onClick={() => setShowRightPanel(!showRightPanel)}
//             title={showRightPanel ? "Hide contact info" : "Show contact info"}
//           >
//             {showRightPanel ? (
//               <ChevronRight size={16} />
//             ) : (
//               <ChevronLeft size={16} />
//             )}
//           </button>

//           {selectedContactId ? (
//             <>
//               {/* Chat Header (Not Sticky) */}
//               <div className="shrink-0">
//                 <ChatHeader contact={contact} />
//               </div>

//               {/* Scrollable Chat Window */}
//               <div className="flex-1 overflow-y-auto">
//                 <ChatWindow
//                   messages={messages}
//                   currentUserId={currentUserId}
//                   contact={contact}
//                 />
//               </div>

//               {/* Input */}
//               <ChatInput
//                 value={newMessage}
//                 onChange={e => setNewMessage(e.target.value)}
//                 onSend={sendMessage}
//                 disabled={!isConnected}
//               />
//             </>
//           ) : (
//             <div className="flex-1 flex items-center justify-center text-gray-400">
//               Please select a contact to start chatting.
//             </div>
//           )}
//         </div>

//         {/* Right Panel */}
//         {showRightPanel && selectedContactId && (
//           <div className="w-80 border-l bg-white overflow-y-auto">
//             <ContactSidebar contactId={selectedContactId} />
//           </div>
//         )}
//       </div>
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\Inbox_AllFileDump.txt 
====================================================== 
 
Folder and File Content Report
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\ExtrackAllFiles.bat 
====================================================== 
 
@echo off
REM This script will find all files and output their name and content into one file.
REM The output file will be named [FolderName]_AllFileDump.txt.

REM Get the current folder's name and set it as the output file name with the custom suffix
for %%I in ("%cd%") do set "outputFile=%%~nI_AllFileDump.txt"

REM Clear the output file to start fresh
> "%outputFile%" (echo Folder and File Content Report)
echo. >> "%outputFile%"

REM Loop through all files in the current directory and subdirectories
for /R . %%F in (*.*) do (
    echo ====================================================== >> "%outputFile%"
    echo FILE: %%F >> "%outputFile%"
    echo ====================================================== >> "%outputFile%"
    echo. >> "%outputFile%"
    type "%%F" >> "%outputFile%" 2>nul
    echo. >> "%outputFile%"
    echo. >> "%outputFile%"
)

echo Finished! All content has been extracted to %outputFile% 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\InboxContext.jsx 
====================================================== 
 
import React, { createContext, useContext, useState, useEffect } from "react";
import useSignalR from "../../hooks/useSignalR";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";

const InboxContext = createContext();

export const useInbox = () => useContext(InboxContext);

export const InboxProvider = ({ children }) => {
  // All state is managed here
  const { connection, isConnected } = useSignalR();
  const [messages, setMessages] = useState([]);
  const [selectedContactId, setSelectedContactId] = useState(null);
  const [newMessage, setNewMessage] = useState("");
  const [contact, setContact] = useState(null);
  const [playSound, setPlaySound] = useState(
    localStorage.getItem("playSound") === "true"
  );
  const [userHasInteracted, setUserHasInteracted] = useState(false);

  const currentUserId = localStorage.getItem("userId");

  // Track user interaction for sound autoplay
  useEffect(() => {
    const handleUserInteraction = () => setUserHasInteracted(true);
    window.addEventListener("click", handleUserInteraction);
    window.addEventListener("keydown", handleUserInteraction);
    return () => {
      window.removeEventListener("click", handleUserInteraction);
      window.removeEventListener("keydown", handleUserInteraction);
    };
  }, []);

  // Fetch contact details when a contact is selected
  useEffect(() => {
    if (!selectedContactId) {
      setContact(null);
      return;
    }
    axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
      setContact(res.data);
    });
  }, [selectedContactId]);

  // Load message history with robust clearing logic
  useEffect(() => {
    if (!selectedContactId) {
      setMessages([]);
      return;
    }
    setMessages([]); // Instantly clear old messages for better UX
    axiosClient
      .get(`/inbox/messages?contactId=${selectedContactId}`)
      .then(res => {
        const normalized = (res.data || []).map(m => ({
          ...m,
          messageContent: m.messageContent ?? m.message, // ‚úÖ normalize
        }));
        setMessages(normalized);
      })
      .catch(err => {
        console.error("‚ùå Failed to load messages:", err);
        toast.error("Failed to load messages.");
      });
  }, [selectedContactId]);

  // SignalR listener for incoming messages
  useEffect(() => {
    if (!connection) return;

    const handler = incoming => {
      const normalized = {
        ...incoming,
        messageContent: incoming.messageContent ?? incoming.message, // ‚úÖ normalize
      };

      if (
        normalized.contactId !== selectedContactId &&
        playSound &&
        userHasInteracted
      ) {
        new Audio("/sounds/inbox_notify.mp3").play().catch(() => {});
      }

      if (normalized.contactId === selectedContactId) {
        setMessages(prev => {
          if (!normalized.isIncoming) {
            // This is our own message coming back from the server; replace the temp one
            return prev.map(m => (m.status === "Sending" ? normalized : m));
          }
          // This is a new message from the contact; add it to the end
          return [...prev, normalized];
        });
      }
    };

    connection.on("ReceiveInboxMessage", handler);
    return () => connection.off("ReceiveInboxMessage", handler);
  }, [connection, selectedContactId, playSound, userHasInteracted]);

  // Function to toggle notification sound
  const toggleSound = async () => {
    const newVal = !playSound;
    if (newVal) {
      try {
        await new Audio("/sounds/inbox_notify.mp3").play();
        setPlaySound(true);
        localStorage.setItem("playSound", "true");
      } catch (err) {
        toast.error("üîá Browser blocked sound. Please enable autoplay.");
        setPlaySound(false);
        localStorage.setItem("playSound", "false");
      }
    } else {
      setPlaySound(false);
      localStorage.setItem("playSound", "false");
    }
  };

  // Function to send a message with optimistic UI
  const sendMessage = async () => {
    if (!selectedContactId || !newMessage.trim() || !isConnected) return;

    const tempId = `temp_${Date.now()}`;
    const optimisticMessage = {
      id: tempId,
      contactId: selectedContactId,
      messageContent: newMessage, // ‚úÖ consistent
      isIncoming: false,
      sentAt: new Date().toISOString(),
      status: "Sending",
    };

    setMessages(prev => [...prev, optimisticMessage]);
    setNewMessage("");

    try {
      await connection.invoke("SendMessageToContact", {
        contactId: selectedContactId,
        message: newMessage, // backend DTO expects "message"
      });
    } catch (err) {
      console.error("‚ùå Send failed:", err);
      toast.error("Failed to send message.");
      setMessages(prev =>
        prev.map(m => (m.id === tempId ? { ...m, status: "Failed" } : m))
      );
    }
  };

  // The value provided to all consumer components
  const value = {
    connection,
    isConnected,
    messages,
    selectedContactId,
    setSelectedContactId,
    newMessage,
    setNewMessage,
    contact,
    playSound,
    toggleSound,
    sendMessage,
    currentUserId,
  };

  return (
    <InboxContext.Provider value={value}>{children}</InboxContext.Provider>
  );
};

// import React, { createContext, useContext, useState, useEffect } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";

// const InboxContext = createContext();

// export const useInbox = () => useContext(InboxContext);

// export const InboxProvider = ({ children }) => {
//   // All state is managed here
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [playSound, setPlaySound] = useState(
//     localStorage.getItem("playSound") === "true"
//   );
//   const [userHasInteracted, setUserHasInteracted] = useState(false);

//   const currentUserId = localStorage.getItem("userId");

//   // Track user interaction for sound autoplay
//   useEffect(() => {
//     const handleUserInteraction = () => setUserHasInteracted(true);
//     window.addEventListener("click", handleUserInteraction);
//     window.addEventListener("keydown", handleUserInteraction);
//     return () => {
//       window.removeEventListener("click", handleUserInteraction);
//       window.removeEventListener("keydown", handleUserInteraction);
//     };
//   }, []);

//   // Fetch contact details when a contact is selected
//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
//       setContact(res.data);
//     });
//   }, [selectedContactId]);

//   // Load message history with robust clearing logic
//   useEffect(() => {
//     if (!selectedContactId) {
//       setMessages([]);
//       return;
//     }
//     setMessages([]); // Instantly clear old messages for better UX
//     axiosClient
//       .get(`/inbox/messages?contactId=${selectedContactId}`)
//       .then(res => setMessages(res.data))
//       .catch(err => {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       });
//   }, [selectedContactId]);

//   // SignalR listener for incoming messages
//   useEffect(() => {
//     if (!connection) return;
//     const handler = incoming => {
//       if (
//         incoming.contactId !== selectedContactId &&
//         playSound &&
//         userHasInteracted
//       ) {
//         new Audio("/sounds/inbox_notify.mp3").play().catch(() => {});
//       }

//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev => {
//           if (!incoming.isIncoming) {
//             // This is our own message coming back from the server; replace the temp one
//             return prev.map(m => (m.status === "Sending" ? incoming : m));
//           }
//           // This is a new message from the contact; add it to the end
//           return [...prev, incoming];
//         });
//       }
//     };

//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId, playSound, userHasInteracted]);

//   // Function to toggle notification sound
//   const toggleSound = async () => {
//     const newVal = !playSound;
//     if (newVal) {
//       try {
//         await new Audio("/sounds/inbox_notify.mp3").play();
//         setPlaySound(true);
//         localStorage.setItem("playSound", "true");
//       } catch (err) {
//         toast.error("üîá Browser blocked sound. Please enable autoplay.");
//         setPlaySound(false);
//         localStorage.setItem("playSound", "false");
//       }
//     } else {
//       setPlaySound(false);
//       localStorage.setItem("playSound", "false");
//     }
//   };

//   // Function to send a message with optimistic UI
//   const sendMessage = async () => {
//     if (!selectedContactId || !newMessage.trim() || !isConnected) return;

//     const tempId = `temp_${Date.now()}`;
//     const optimisticMessage = {
//       id: tempId,
//       contactId: selectedContactId,
//       messageContent: newMessage,
//       isIncoming: false,
//       sentAt: new Date().toISOString(),
//       status: "Sending",
//     };

//     setMessages(prev => [...prev, optimisticMessage]);
//     setNewMessage("");

//     try {
//       await connection.invoke("SendMessageToContact", {
//         contactId: selectedContactId,
//         message: newMessage,
//       });
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//       setMessages(prev =>
//         prev.map(m => (m.id === tempId ? { ...m, status: "Failed" } : m))
//       );
//     }
//   };

//   // The value provided to all consumer components
//   const value = {
//     connection,
//     isConnected,
//     messages,
//     selectedContactId,
//     setSelectedContactId,
//     newMessage,
//     setNewMessage,
//     contact,
//     playSound,
//     toggleSound,
//     sendMessage,
//     currentUserId,
//   };

//   return (
//     <InboxContext.Provider value={value}>{children}</InboxContext.Provider>
//   );
// };
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\InboxWrapper.jsx 
====================================================== 
 
import React, { useState, useEffect } from "react";
import { InboxProvider, useInbox } from "./InboxContext";
import InboxSidebar from "./components/InboxSidebar";
import ChatWindow from "./components/ChatWindow";
import ChatInput from "./components/ChatInput";
import ContactSidebar from "./components/ContactSidebar";
import ChatHeader from "./components/ChatHeader";
import { ChevronLeft, ChevronRight, Bell } from "lucide-react";

// The layout component gets its data from our new hook
function InboxLayout() {
  const {
    selectedContactId,
    setSelectedContactId,
    currentUserId,
    playSound,
    toggleSound,
  } = useInbox();

  const [showRightPanel, setShowRightPanel] = useState(true);

  // Control body scrolling when inbox is mounted
  useEffect(() => {
    // Store original styles
    const originalBodyOverflow = document.body.style.overflow;
    const originalHtmlOverflow = document.documentElement.style.overflow;

    // Add classes to prevent scrolling
    document.body.classList.add("inbox-active");
    document.documentElement.classList.add("inbox-active");

    // Force prevent scrolling
    document.body.style.overflow = "hidden";
    document.documentElement.style.overflow = "hidden";

    // Cleanup function to restore original styles
    return () => {
      document.body.classList.remove("inbox-active");
      document.documentElement.classList.remove("inbox-active");
      document.body.style.overflow = originalBodyOverflow;
      document.documentElement.style.overflow = originalHtmlOverflow;
    };
  }, []);

  return (
    <div className="inbox-fullscreen h-screen flex flex-col overflow-hidden">
      <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0">
        <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
          <span className="text-xl">üì®</span>
          Inbox
        </div>
        <div className="flex items-center gap-4">
          <button
            onClick={toggleSound}
            className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${
              playSound
                ? "bg-green-100 text-green-600 border-green-300"
                : "bg-gray-100 text-gray-500 border-gray-300"
            }`}
          >
            <Bell size={14} /> {playSound ? "Sound ON" : "Sound OFF"}
          </button>
        </div>
      </header>

      <div className="flex flex-1 overflow-hidden">
        {/* Left Sidebar - Always visible */}
        <div
          className="bg-white border-r overflow-y-auto"
          style={{
            width: "288px",
            minWidth: "288px",
            maxWidth: "288px",
            height: "100%",
          }}
        >
          <InboxSidebar
            onSelect={id => setSelectedContactId(id)}
            currentUserId={currentUserId}
          />
        </div>

        <div className="flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative">
          <button
            className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
            onClick={() => setShowRightPanel(!showRightPanel)}
            title={showRightPanel ? "Hide contact info" : "Show contact info"}
          >
            {showRightPanel ? (
              <ChevronRight size={16} />
            ) : (
              <ChevronLeft size={16} />
            )}
          </button>

          {selectedContactId ? (
            <>
              {/* Chat Header - Fixed at top */}
              <div className="shrink-0">
                <ChatHeader contactId={selectedContactId} />
              </div>

              {/* Chat Window - Scrollable area that takes remaining space */}
              <div className="flex-1 overflow-hidden">
                <ChatWindow />
              </div>

              {/* Chat Input - Fixed at bottom */}
              <div className="shrink-0" style={{ flexShrink: 0 }}>
                <ChatInput />
              </div>
            </>
          ) : (
            <div className="flex-1 flex items-center justify-center text-gray-400">
              Please select a contact to start chatting.
            </div>
          )}
        </div>

        {showRightPanel && selectedContactId && (
          <div
            className="w-80 border-l bg-white overflow-y-auto"
            style={{ height: "100%", maxHeight: "100%" }}
          >
            <ContactSidebar contactId={selectedContactId} />
          </div>
        )}
      </div>
    </div>
  );
}

// The final export wraps our layout with the provider
export default function InboxWrapper() {
  return (
    <InboxProvider>
      <InboxLayout />
    </InboxProvider>
  );
}
// import React, { useEffect, useState } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import InboxSidebar from "./components/InboxSidebar";
// import ChatWindow from "./components/ChatWindow";
// import ChatInput from "./components/ChatInput";
// import ContactSidebar from "./components/ContactSidebar";
// import ChatHeader from "./components/ChatHeader";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import { ChevronLeft, ChevronRight, Bell } from "lucide-react";
// import { InboxProvider, useInbox } from "./InboxContext";
// export default function InboxWrapper() {
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [showRightPanel, setShowRightPanel] = useState(true);
//   const [playSound, setPlaySound] = useState(
//     localStorage.getItem("playSound") === "true"
//   );
//   const [userHasInteracted, setUserHasInteracted] = useState(false);

//   const currentUserId = localStorage.getItem("userId");

//   // ‚úÖ Track first user interaction to allow audio play
//   useEffect(() => {
//     const handleUserInteraction = () => setUserHasInteracted(true);
//     window.addEventListener("click", handleUserInteraction);
//     window.addEventListener("keydown", handleUserInteraction);
//     return () => {
//       window.removeEventListener("click", handleUserInteraction);
//       window.removeEventListener("keydown", handleUserInteraction);
//     };
//   }, []);

//   // üîä Sound toggle with permission
//   const toggleSound = async () => {
//     const newVal = !playSound;

//     if (newVal) {
//       try {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         await audio.play();
//         audio.pause();
//         setPlaySound(true);
//         localStorage.setItem("playSound", "true");
//       } catch (err) {
//         toast.error("üîá Browser blocked sound. Allow autoplay.");
//         console.warn("‚ö†Ô∏è Audio play blocked:", err);
//         setPlaySound(false);
//         localStorage.setItem("playSound", "false");
//       }
//     } else {
//       setPlaySound(false);
//       localStorage.setItem("playSound", "false");
//     }
//   };

//   // üìû Fetch contact info on select
//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
//       setContact(res.data);
//     });
//   }, [selectedContactId]);

//   // üì© Load message history
//   useEffect(() => {
//     if (!selectedContactId) return;
//     axiosClient
//       .get(`/inbox/messages?contactId=${selectedContactId}`)
//       .then(res => setMessages(res.data))
//       .catch(err => {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       });
//   }, [selectedContactId]);

//   // üöÄ Send message
//   // const sendMessage = async () => {
//   //   if (!selectedContactId)
//   //     return toast.error("‚ùó Please select a contact first.");
//   //   if (!newMessage.trim()) return toast.warn("‚ö†Ô∏è Please type a message.");
//   //   if (!connection || !isConnected)
//   //     return toast.error("‚ùå SignalR not connected.");

//   //   try {
//   //     await connection.invoke("SendMessageToContact", {
//   //       contactId: selectedContactId,
//   //       message: newMessage,
//   //     });
//   //     setNewMessage("");
//   //   } catch (err) {
//   //     console.error("‚ùå Send failed:", err);
//   //     toast.error("Failed to send message.");
//   //   }
//   // };
//   const sendMessage = async () => {
//     if (!selectedContactId || !newMessage.trim()) return;
//     if (!connection || !isConnected)
//       return toast.error("‚ùå SignalR not connected.");

//     // 1. Create a temporary message for optimistic UI
//     const tempId = `temp_${Date.now()}`;
//     const optimisticMessage = {
//       id: tempId,
//       contactId: selectedContactId,
//       messageContent: newMessage,
//       isIncoming: false,
//       sentAt: new Date().toISOString(),
//       status: "Sending", // Special status for the UI
//     };

//     // 2. Add to state immediately and clear input
//     setMessages(prevMessages => [...prevMessages, optimisticMessage]);
//     setNewMessage("");

//     try {
//       // 3. Send to server
//       await connection.invoke("SendMessageToContact", {
//         contactId: selectedContactId,
//         message: newMessage,
//         // Optional: send tempId to make replacement easier
//         // tempId: tempId
//       });
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//       // Handle error: update the optimistic message to show a "Failed" status
//       setMessages(prev =>
//         prev.map(m => (m.id === tempId ? { ...m, status: "Failed" } : m))
//       );
//     }
//   };
//   // üîî Real-time message listener
//   // useEffect(() => {
//   //   if (!connection) return;

//   //   const handler = incoming => {
//   //     if (
//   //       incoming.contactId !== selectedContactId &&
//   //       playSound &&
//   //       userHasInteracted
//   //     ) {
//   //       try {
//   //         const audio = new Audio("/sounds/inbox_notify.mp3");
//   //         audio.play().catch(err => {
//   //           console.warn("üîá Browser prevented sound playback:", err);
//   //         });
//   //       } catch (err) {
//   //         console.warn("‚ùå Sound error:", err);
//   //       }
//   //     }

//   //     if (incoming.contactId === selectedContactId) {
//   //       setMessages(prev =>
//   //         [...prev, incoming].sort(
//   //           (a, b) =>
//   //             new Date(a.sentAt || a.createdAt) -
//   //             new Date(b.sentAt || b.createdAt)
//   //         )
//   //       );
//   //     }
//   //   };
//   useEffect(() => {
//     if (!connection) return;

//     const handler = incoming => {
//       // ... sound playing logic ...

//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev => {
//           // If the message is from the current user, replace the temp message
//           if (!incoming.isIncoming) {
//             return prev.map(m => (m.status === "Sending" ? incoming : m));
//           }
//           // Otherwise, just add the new incoming message
//           return [...prev, incoming];
//         });
//       }
//     };
//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId, playSound, userHasInteracted]);

//   return (
//     <div className="h-screen flex flex-col overflow-hidden">
//       {/* üîí Top App Bar */}
//       <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0">
//         <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
//           <span className="text-xl">üì®</span> Inbox
//         </div>
//         <div className="flex items-center gap-4">
//           <button
//             onClick={toggleSound}
//             className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${
//               playSound
//                 ? "bg-green-100 text-green-600 border-green-300"
//                 : "bg-gray-100 text-gray-500 border-gray-300"
//             }`}
//           >
//             <Bell size={14} /> {playSound ? "Sound ON" : "Sound OFF"}
//           </button>
//         </div>
//       </header>

//       {/* üí¨ Main layout */}
//       <div className="flex flex-1 overflow-hidden">
//         {/* üìá Left Sidebar */}
//         <div className="w-72 border-r bg-white overflow-y-auto">
//           <InboxSidebar
//             onSelect={id => setSelectedContactId(id)}
//             currentUserId={currentUserId}
//           />
//         </div>

//         {/* üí¨ Chat Area */}
//         <div className="flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative">
//           <button
//             className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
//             onClick={() => setShowRightPanel(!showRightPanel)}
//             title={showRightPanel ? "Hide contact info" : "Show contact info"}
//           >
//             {showRightPanel ? (
//               <ChevronRight size={16} />
//             ) : (
//               <ChevronLeft size={16} />
//             )}
//           </button>

//           {selectedContactId ? (
//             <>
//               <div className="shrink-0">
//                 <ChatHeader contact={contact} />
//               </div>
//               <div className="flex-1 overflow-y-auto">
//                 <ChatWindow
//                   messages={messages}
//                   currentUserId={currentUserId}
//                   selectedContactId={selectedContactId}
//                   connection={connection}
//                 />
//               </div>
//               <div className="shrink-0">
//                 <ChatInput
//                   value={newMessage}
//                   onChange={e => setNewMessage(e.target.value)}
//                   onSend={sendMessage}
//                   disabled={!isConnected}
//                 />
//               </div>
//             </>
//           ) : (
//             <div className="flex-1 flex items-center justify-center text-gray-400">
//               Please select a contact to start chatting.
//             </div>
//           )}
//         </div>

//         {/* üìá Right Panel */}
//         {showRightPanel && selectedContactId && (
//           <div className="w-80 border-l bg-white overflow-y-auto">
//             <ContactSidebar contactId={selectedContactId} />
//           </div>
//         )}
//       </div>
//     </div>
//   );
// }

// import React, { useEffect, useState } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import InboxSidebar from "./components/InboxSidebar";
// import ChatWindow from "./components/ChatWindow";
// import ChatInput from "./components/ChatInput";
// import ContactSidebar from "./components/ContactSidebar";
// import ChatHeader from "./components/ChatHeader";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import { ChevronLeft, ChevronRight, Bell } from "lucide-react";

// export default function InboxWrapper() {
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [showRightPanel, setShowRightPanel] = useState(true);
//   const [playSound, setPlaySound] = useState(
//     localStorage.getItem("playSound") === "true"
//   );

//   const currentUserId = localStorage.getItem("userId");

//   // üîä Sound toggle with permission
//   const toggleSound = async () => {
//     const newVal = !playSound;

//     if (newVal) {
//       try {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         await audio.play();
//         audio.pause();
//         setPlaySound(true);
//         localStorage.setItem("playSound", "true");
//       } catch (err) {
//         toast.error("üîá Browser blocked sound. Allow autoplay.");
//         console.warn("‚ö†Ô∏è Audio play blocked:", err);
//         setPlaySound(false);
//         localStorage.setItem("playSound", "false");
//       }
//     } else {
//       setPlaySound(false);
//       localStorage.setItem("playSound", "false");
//     }
//   };

//   // üìû Fetch contact info on select
//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
//       setContact(res.data);
//     });
//   }, [selectedContactId]);

//   // üì© Load message history
//   useEffect(() => {
//     if (!selectedContactId) return;
//     axiosClient
//       .get(`/inbox/messages?contactId=${selectedContactId}`)
//       .then(res => setMessages(res.data))
//       .catch(err => {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       });
//   }, [selectedContactId]);

//   // üöÄ Send message
//   const sendMessage = async () => {
//     if (!selectedContactId)
//       return toast.error("‚ùó Please select a contact first.");
//     if (!newMessage.trim()) return toast.warn("‚ö†Ô∏è Please type a message.");
//     if (!connection || !isConnected)
//       return toast.error("‚ùå SignalR not connected.");

//     try {
//       await connection.invoke("SendMessageToContact", {
//         contactId: selectedContactId,
//         message: newMessage,
//       });
//       setNewMessage("");
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//     }
//   };

//   // üîî Real-time message listener
//   useEffect(() => {
//     if (!connection) return;

//     const handler = incoming => {
//       if (incoming.contactId !== selectedContactId && playSound) {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         audio.play();
//       }

//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev =>
//           [...prev, incoming].sort(
//             (a, b) =>
//               new Date(a.sentAt || a.createdAt) -
//               new Date(b.sentAt || b.createdAt)
//           )
//         );
//       }
//     };

//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId, playSound]);

//   return (
//     <div className="h-screen flex flex-col overflow-hidden">
//       {/* üîí Top App Bar */}
//       <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0">
//         <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
//           <span className="text-xl">üì®</span> Inbox
//         </div>
//         <div className="flex items-center gap-4">
//           <button
//             onClick={toggleSound}
//             className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${
//               playSound
//                 ? "bg-green-100 text-green-600 border-green-300"
//                 : "bg-gray-100 text-gray-500 border-gray-300"
//             }`}
//           >
//             <Bell size={14} /> {playSound ? "Sound ON" : "Sound OFF"}
//           </button>
//           <div className="text-sm text-gray-500">xByteChat</div>
//         </div>
//       </header>

//       {/* üí¨ Main layout */}
//       <div className="flex flex-1 overflow-hidden">
//         {/* üìá Left Sidebar */}
//         <div className="w-72 border-r bg-white overflow-y-auto">
//           <InboxSidebar
//             onSelect={id => setSelectedContactId(id)}
//             currentUserId={currentUserId}
//           />
//         </div>

//         {/* üí¨ Chat Area */}
//         <div className="flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative">
//           <button
//             className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
//             onClick={() => setShowRightPanel(!showRightPanel)}
//             title={showRightPanel ? "Hide contact info" : "Show contact info"}
//           >
//             {showRightPanel ? (
//               <ChevronRight size={16} />
//             ) : (
//               <ChevronLeft size={16} />
//             )}
//           </button>

//           {selectedContactId ? (
//             <>
//               <div className="shrink-0">
//                 <ChatHeader contact={contact} />
//               </div>
//               <div className="flex-1 overflow-y-auto">
//                 <ChatWindow
//                   messages={messages}
//                   currentUserId={currentUserId}
//                   selectedContactId={selectedContactId}
//                   connection={connection}
//                 />
//               </div>
//               <div className="shrink-0">
//                 <ChatInput
//                   value={newMessage}
//                   onChange={e => setNewMessage(e.target.value)}
//                   onSend={sendMessage}
//                   disabled={!isConnected}
//                 />
//               </div>
//             </>
//           ) : (
//             <div className="flex-1 flex items-center justify-center text-gray-400">
//               Please select a contact to start chatting.
//             </div>
//           )}
//         </div>

//         {/* üìá Right Panel */}
//         {showRightPanel && selectedContactId && (
//           <div className="w-80 border-l bg-white overflow-y-auto">
//             <ContactSidebar contactId={selectedContactId} />
//           </div>
//         )}
//       </div>
//     </div>
//   );
// }

// import React, { useEffect, useState } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import InboxSidebar from "./components/InboxSidebar";
// import ChatWindow from "./components/ChatWindow";
// import ChatInput from "./components/ChatInput";
// import ContactSidebar from "./components/ContactSidebar";
// import ChatHeader from "./components/ChatHeader";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import { ChevronLeft, ChevronRight, Bell } from "lucide-react";

// export default function InboxWrapper() {
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [showRightPanel, setShowRightPanel] = useState(true);
//   const [playSound, setPlaySound] = useState(
//     localStorage.getItem("playSound") === "true"
//   );

//   const currentUserId = localStorage.getItem("userId");

//   const toggleSound = async () => {
//     const newVal = !playSound;

//     if (newVal) {
//       // Try to play dummy sound to get permission
//       try {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         await audio.play();
//         audio.pause();
//         setPlaySound(true);
//         localStorage.setItem("playSound", "true");
//       } catch (err) {
//         toast.error("üîá Your browser blocked sound. Please allow autoplay.");
//         console.warn("‚ö†Ô∏è Audio play blocked:", err);
//         setPlaySound(false);
//         localStorage.setItem("playSound", "false");
//       }
//     } else {
//       setPlaySound(false);
//       localStorage.setItem("playSound", "false");
//     }
//   };

//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
//       setContact(res.data);
//     });
//   }, [selectedContactId]);

//   useEffect(() => {
//     if (!selectedContactId) return;
//     axiosClient
//       .get(`/inbox/messages?contactId=${selectedContactId}`)
//       .then(res => setMessages(res.data))
//       .catch(err => {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       });
//   }, [selectedContactId]);

//   const sendMessage = async () => {
//     if (!selectedContactId)
//       return toast.error("‚ùó Please select a contact first.");
//     if (!newMessage.trim()) return toast.warn("‚ö†Ô∏è Please type a message.");
//     if (!connection || !isConnected)
//       return toast.error("‚ùå SignalR not connected.");

//     try {
//       await connection.invoke("SendMessageToContact", {
//         contactId: selectedContactId,
//         message: newMessage,
//       });
//       setNewMessage("");
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//     }
//   };

//   useEffect(() => {
//     if (!connection) return;
//     const handler = incoming => {
//       // ‚úÖ Play sound only if it's from another contact
//       if (incoming.contactId !== selectedContactId && playSound) {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         audio.play();
//       }
//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev =>
//           [...prev, incoming].sort(
//             (a, b) =>
//               new Date(a.sentAt || a.createdAt) -
//               new Date(b.sentAt || b.createdAt)
//           )
//         );
//       }
//     };
//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId, playSound]);

//   return (
//     <div className="h-screen flex flex-col overflow-hidden">
//       {/* üîí Top App Bar */}
//       <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0">
//         <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
//           <span className="text-xl">üì®</span> Inbox
//         </div>
//         <div className="flex items-center gap-4">
//           <button
//             onClick={toggleSound}
//             className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${
//               playSound
//                 ? "bg-green-100 text-green-600 border-green-300"
//                 : "bg-gray-100 text-gray-500 border-gray-300"
//             }`}
//           >
//             <Bell size={14} /> {playSound ? "Sound ON" : "Sound OFF"}
//           </button>
//           <div className="text-sm text-gray-500">xByteChat</div>
//         </div>
//       </header>

//       {/* üí¨ Main 3-column layout */}
//       <div className="flex flex-1 overflow-hidden">
//         {/* üìá Left Sidebar */}
//         <div className="w-72 border-r bg-white overflow-y-auto">
//           <InboxSidebar onSelect={id => setSelectedContactId(id)} />
//         </div>

//         {/* üí¨ Chat column */}
//         <div className="flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative">
//           <button
//             className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
//             onClick={() => setShowRightPanel(!showRightPanel)}
//             title={showRightPanel ? "Hide contact info" : "Show contact info"}
//           >
//             {showRightPanel ? (
//               <ChevronRight size={16} />
//             ) : (
//               <ChevronLeft size={16} />
//             )}
//           </button>

//           {selectedContactId ? (
//             <>
//               <div className="shrink-0">
//                 <ChatHeader contact={contact} />
//               </div>
//               <div className="flex-1 overflow-y-auto">
//                 <ChatWindow
//                   messages={messages}
//                   currentUserId={currentUserId}
//                   selectedContactId={selectedContactId}
//                   connection={connection}
//                 />
//               </div>
//               <div className="shrink-0">
//                 <ChatInput
//                   value={newMessage}
//                   onChange={e => setNewMessage(e.target.value)}
//                   onSend={sendMessage}
//                   disabled={!isConnected}
//                 />
//               </div>
//             </>
//           ) : (
//             <div className="flex-1 flex items-center justify-center text-gray-400">
//               Please select a contact to start chatting.
//             </div>
//           )}
//         </div>

//         {/* üìá Right Contact Info */}
//         {showRightPanel && selectedContactId && (
//           <div className="w-80 border-l bg-white overflow-y-auto">
//             <ContactSidebar contactId={selectedContactId} />
//           </div>
//         )}
//       </div>
//     </div>
//   );
// }

// import React, { useEffect, useState } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import InboxSidebar from "./components/InboxSidebar";
// import ChatWindow from "./components/ChatWindow";
// import ChatInput from "./components/ChatInput";
// import ContactSidebar from "./components/ContactSidebar";
// import ChatHeader from "./components/ChatHeader";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import { ChevronLeft, ChevronRight, Bell } from "lucide-react";

// export default function InboxWrapper() {
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [showRightPanel, setShowRightPanel] = useState(true);
//   const [playSound, setPlaySound] = useState(
//     localStorage.getItem("playSound") === "true"
//   );

//   const currentUserId = localStorage.getItem("userId");

//   const toggleSound = async () => {
//     const newVal = !playSound;

//     if (newVal) {
//       try {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         await audio.play();
//         audio.pause();
//         setPlaySound(true);
//         localStorage.setItem("playSound", "true");
//       } catch (err) {
//         toast.error("üîá Your browser blocked sound. Please allow autoplay.");
//         console.warn("‚ö†Ô∏è Audio play blocked:", err);
//         setPlaySound(false);
//         localStorage.setItem("playSound", "false");
//       }
//     } else {
//       setPlaySound(false);
//       localStorage.setItem("playSound", "false");
//     }
//   };

//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
//       setContact(res.data);
//     });
//   }, [selectedContactId]);

//   useEffect(() => {
//     if (!selectedContactId) return;
//     axiosClient
//       .get(`/inbox/messages?contactId=${selectedContactId}`)
//       .then(res => setMessages(res.data))
//       .catch(err => {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       });
//   }, [selectedContactId]);

//   const sendMessage = async () => {
//     if (!selectedContactId)
//       return toast.error("‚ùó Please select a contact first.");
//     if (!newMessage.trim()) return toast.warn("‚ö†Ô∏è Please type a message.");
//     if (!connection || !isConnected)
//       return toast.error("‚ùå SignalR not connected.");

//     try {
//       await connection.invoke("SendMessageToContact", {
//         contactId: selectedContactId,
//         message: newMessage,
//       });
//       setNewMessage("");
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//     }
//   };

//   useEffect(() => {
//     if (!connection) return;

//     const handler = incoming => {
//       if (incoming.contactId !== selectedContactId && playSound) {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         audio.play();
//       }

//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev =>
//           [...prev, incoming].sort(
//             (a, b) =>
//               new Date(a.sentAt || a.createdAt) -
//               new Date(b.sentAt || b.createdAt)
//           )
//         );
//       }
//     };

//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId, playSound]);

//   return (
//     <div className="h-screen flex flex-col overflow-hidden">
//       {/* üîí Top App Bar */}
//       <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0">
//         <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
//           üì® Inbox
//         </div>
//         <div className="flex items-center gap-4">
//           <button
//             onClick={toggleSound}
//             className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${
//               playSound
//                 ? "bg-green-100 text-green-600 border-green-300"
//                 : "bg-gray-100 text-gray-500 border-gray-300"
//             }`}
//           >
//             <Bell size={14} /> {playSound ? "Sound ON" : "Sound OFF"}
//           </button>
//           <div className="text-sm text-gray-500">xByteChat</div>
//         </div>
//       </header>

//       {/* üí¨ Main 3-column layout */}
//       <div className="flex flex-1 overflow-hidden">
//         {/* üìá Left Sidebar */}
//         <div className="w-72 border-r bg-white overflow-y-auto">
//           <InboxSidebar onSelect={id => setSelectedContactId(id)} />
//         </div>

//         {/* üí¨ Chat column */}
//         <div className="flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative">
//           <button
//             className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
//             onClick={() => setShowRightPanel(!showRightPanel)}
//             title={showRightPanel ? "Hide contact info" : "Show contact info"}
//           >
//             {showRightPanel ? (
//               <ChevronRight size={16} />
//             ) : (
//               <ChevronLeft size={16} />
//             )}
//           </button>

//           {selectedContactId ? (
//             <>
//               <div className="shrink-0">
//                 <ChatHeader contact={contact} />
//               </div>
//               <div className="flex-1 overflow-y-auto">
//                 <ChatWindow messages={messages} currentUserId={currentUserId} />
//               </div>
//               <div className="shrink-0">
//                 <ChatInput
//                   value={newMessage}
//                   onChange={e => setNewMessage(e.target.value)}
//                   onSend={sendMessage}
//                   disabled={!isConnected}
//                 />
//               </div>
//             </>
//           ) : (
//             <div className="flex-1 flex items-center justify-center text-gray-400">
//               Please select a contact to start chatting.
//             </div>
//           )}
//         </div>

//         {/* üìá Right Contact Info */}
//         {showRightPanel && selectedContactId && (
//           <div className="w-80 border-l bg-white overflow-y-auto">
//             <ContactSidebar contactId={selectedContactId} />
//           </div>
//         )}
//       </div>
//     </div>
//   );
// }

// // ‚úÖ Updated InboxWrapper.jsx with stable notification sound toggle via useNotificationSound
// import React, { useEffect, useState } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import useNotificationSound from "../../hooks/useNotificationSound";
// import InboxSidebar from "./components/InboxSidebar";
// import ChatWindow from "./components/ChatWindow";
// import ChatInput from "./components/ChatInput";
// import ContactSidebar from "./components/ContactSidebar";
// import ChatHeader from "./components/ChatHeader";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import { ChevronLeft, ChevronRight, Bell } from "lucide-react";

// export default function InboxWrapper() {
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [showRightPanel, setShowRightPanel] = useState(true);
//   const currentUserId = localStorage.getItem("userId");

//   const { isSoundOn, toggleSound, soundRef } = useNotificationSound();

//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
//       setContact(res.data);
//     });
//   }, [selectedContactId]);

//   useEffect(() => {
//     if (!selectedContactId) return;
//     axiosClient
//       .get(`/inbox/messages?contactId=${selectedContactId}`)
//       .then(res => setMessages(res.data))
//       .catch(err => {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       });
//   }, [selectedContactId]);

//   const sendMessage = async () => {
//     if (!selectedContactId)
//       return toast.error("‚ùó Please select a contact first.");
//     if (!newMessage.trim()) return toast.warn("‚ö†Ô∏è Please type a message.");
//     if (!connection || !isConnected)
//       return toast.error("‚ùå SignalR not connected.");

//     try {
//       await connection.invoke("SendMessageToContact", {
//         contactId: selectedContactId,
//         message: newMessage,
//       });
//       setNewMessage("");
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//     }
//   };

//   useEffect(() => {
//     if (!connection) return;

//     const handler = incoming => {
//       // ‚úÖ Use soundRef for latest value
//       if (incoming.contactId !== selectedContactId && soundRef.current) {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         audio.play();
//       }

//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev =>
//           [...prev, incoming].sort(
//             (a, b) =>
//               new Date(a.sentAt || a.createdAt) -
//               new Date(b.sentAt || b.createdAt)
//           )
//         );
//       }
//     };

//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId, soundRef]);

//   return (
//     <div className="h-screen flex flex-col overflow-hidden">
//       {/* üîí Top App Bar */}
//       <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0">
//         <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
//           üì® Inbox
//         </div>
//         <div className="flex items-center gap-4">
//           <button
//             onClick={toggleSound}
//             className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${
//               isSoundOn
//                 ? "bg-green-100 text-green-600 border-green-300"
//                 : "bg-gray-100 text-gray-500 border-gray-300"
//             }`}
//           >
//             <Bell size={14} /> {isSoundOn ? "Sound ON" : "Sound OFF"}
//           </button>
//           <div className="text-sm text-gray-500">xByteChat</div>
//         </div>
//       </header>

//       {/* üí¨ Main 3-column layout */}
//       <div className="flex flex-1 overflow-hidden">
//         {/* üìá Left Sidebar */}
//         <div className="w-72 border-r bg-white overflow-y-auto">
//           <InboxSidebar onSelect={id => setSelectedContactId(id)} />
//         </div>

//         {/* üí¨ Chat column */}
//         <div className="flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative">
//           <button
//             className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
//             onClick={() => setShowRightPanel(!showRightPanel)}
//             title={showRightPanel ? "Hide contact info" : "Show contact info"}
//           >
//             {showRightPanel ? (
//               <ChevronRight size={16} />
//             ) : (
//               <ChevronLeft size={16} />
//             )}
//           </button>

//           {selectedContactId ? (
//             <>
//               <div className="shrink-0">
//                 <ChatHeader contact={contact} />
//               </div>
//               <div className="flex-1 overflow-y-auto">
//                 <ChatWindow messages={messages} currentUserId={currentUserId} />
//               </div>
//               <div className="shrink-0">
//                 <ChatInput
//                   value={newMessage}
//                   onChange={e => setNewMessage(e.target.value)}
//                   onSend={sendMessage}
//                   disabled={!isConnected}
//                 />
//               </div>
//             </>
//           ) : (
//             <div className="flex-1 flex items-center justify-center text-gray-400">
//               Please select a contact to start chatting.
//             </div>
//           )}
//         </div>

//         {/* üìá Right Contact Info */}
//         {showRightPanel && selectedContactId && (
//           <div className="w-80 border-l bg-white overflow-y-auto">
//             <ContactSidebar contactId={selectedContactId} />
//           </div>
//         )}
//       </div>
//     </div>
//   );
// }

// ‚úÖ Updated InboxWrapper.jsx with Notification Sound Toggle + Play Logic
// import React, { useEffect, useState } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import InboxSidebar from "./components/InboxSidebar";
// import ChatWindow from "./components/ChatWindow";
// import ChatInput from "./components/ChatInput";
// import ContactSidebar from "./components/ContactSidebar";
// import ChatHeader from "./components/ChatHeader";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import { ChevronLeft, ChevronRight, Bell } from "lucide-react";

// export default function InboxWrapper() {
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [showRightPanel, setShowRightPanel] = useState(true);
//   const [playSound, setPlaySound] = useState(
//     localStorage.getItem("playSound") === "true"
//   );

//   const currentUserId = localStorage.getItem("userId");

//   // const toggleSound = () => {
//   //   const newVal = !playSound;
//   //   setPlaySound(newVal);
//   //   localStorage.setItem("playSound", newVal);
//   // };
//   const toggleSound = async () => {
//     const newVal = !playSound;

//     if (newVal) {
//       // Try to play dummy sound to get permission
//       try {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         await audio.play();
//         audio.pause();
//         setPlaySound(true);
//         localStorage.setItem("playSound", "true");
//       } catch (err) {
//         toast.error("üîá Your browser blocked sound. Please allow autoplay.");
//         console.warn("‚ö†Ô∏è Audio play blocked:", err);
//         setPlaySound(false);
//         localStorage.setItem("playSound", "false");
//       }
//     } else {
//       setPlaySound(false);
//       localStorage.setItem("playSound", "false");
//     }
//   };

//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
//       setContact(res.data);
//     });
//   }, [selectedContactId]);

//   useEffect(() => {
//     if (!selectedContactId) return;
//     axiosClient
//       .get(`/inbox/messages?contactId=${selectedContactId}`)
//       .then(res => setMessages(res.data))
//       .catch(err => {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       });
//   }, [selectedContactId]);

//   const sendMessage = async () => {
//     if (!selectedContactId)
//       return toast.error("‚ùó Please select a contact first.");
//     if (!newMessage.trim()) return toast.warn("‚ö†Ô∏è Please type a message.");
//     if (!connection || !isConnected)
//       return toast.error("‚ùå SignalR not connected.");

//     try {
//       await connection.invoke("SendMessageToContact", {
//         contactId: selectedContactId,
//         message: newMessage,
//       });
//       setNewMessage("");
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//     }
//   };

//   useEffect(() => {
//     if (!connection) return;
//     const handler = incoming => {
//       // ‚úÖ Play sound only if it's from another contact
//       if (incoming.contactId !== selectedContactId && playSound) {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         audio.play();
//       }
//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev =>
//           [...prev, incoming].sort(
//             (a, b) =>
//               new Date(a.sentAt || a.createdAt) -
//               new Date(b.sentAt || b.createdAt)
//           )
//         );
//       }
//     };
//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId, playSound]);

//   return (
//     <div className="h-screen flex flex-col overflow-hidden">
//       {/* üîí Top App Bar */}
//       <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0">
//         <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
//           üì® Inbox
//         </div>
//         <div className="flex items-center gap-4">
//           <button
//             onClick={toggleSound}
//             className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${
//               playSound
//                 ? "bg-green-100 text-green-600 border-green-300"
//                 : "bg-gray-100 text-gray-500 border-gray-300"
//             }`}
//           >
//             <Bell size={14} /> {playSound ? "Sound ON" : "Sound OFF"}
//           </button>
//           <div className="text-sm text-gray-500">xByteChat</div>
//         </div>
//       </header>

//       {/* üí¨ Main 3-column layout */}
//       <div className="flex flex-1 overflow-hidden">
//         {/* üìá Left Sidebar */}
//         <div className="w-72 border-r bg-white overflow-y-auto">
//           <InboxSidebar onSelect={id => setSelectedContactId(id)} />
//         </div>

//         {/* üí¨ Chat column */}
//         <div className="flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative">
//           <button
//             className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
//             onClick={() => setShowRightPanel(!showRightPanel)}
//             title={showRightPanel ? "Hide contact info" : "Show contact info"}
//           >
//             {showRightPanel ? (
//               <ChevronRight size={16} />
//             ) : (
//               <ChevronLeft size={16} />
//             )}
//           </button>

//           {selectedContactId ? (
//             <>
//               <div className="shrink-0">
//                 <ChatHeader contact={contact} />
//               </div>
//               <div className="flex-1 overflow-y-auto">
//                 <ChatWindow messages={messages} currentUserId={currentUserId} />
//               </div>
//               <div className="shrink-0">
//                 <ChatInput
//                   value={newMessage}
//                   onChange={e => setNewMessage(e.target.value)}
//                   onSend={sendMessage}
//                   disabled={!isConnected}
//                 />
//               </div>
//             </>
//           ) : (
//             <div className="flex-1 flex items-center justify-center text-gray-400">
//               Please select a contact to start chatting.
//             </div>
//           )}
//         </div>

//         {/* üìá Right Contact Info */}
//         {showRightPanel && selectedContactId && (
//           <div className="w-80 border-l bg-white overflow-y-auto">
//             <ContactSidebar contactId={selectedContactId} />
//           </div>
//         )}
//       </div>
//     </div>
//   );
// }

// import React, { useEffect, useState } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import InboxSidebar from "./components/InboxSidebar";
// import ChatWindow from "./components/ChatWindow";
// import ChatInput from "./components/ChatInput";
// import ContactSidebar from "./components/ContactSidebar";
// import ChatHeader from "./components/ChatHeader";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import { ChevronLeft, ChevronRight } from "lucide-react";

// export default function InboxWrapper() {
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [showRightPanel, setShowRightPanel] = useState(true);

//   const currentUserId = localStorage.getItem("userId");

//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
//       setContact(res.data);
//     });
//   }, [selectedContactId]);

//   useEffect(() => {
//     if (!selectedContactId) return;
//     axiosClient
//       .get(`/inbox/messages?contactId=${selectedContactId}`)
//       .then(res => setMessages(res.data))
//       .catch(err => {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       });
//   }, [selectedContactId]);

//   const sendMessage = async () => {
//     if (!selectedContactId)
//       return toast.error("‚ùó Please select a contact first.");
//     if (!newMessage.trim()) return toast.warn("‚ö†Ô∏è Please type a message.");
//     if (!connection || !isConnected)
//       return toast.error("‚ùå SignalR not connected.");

//     try {
//       await connection.invoke("SendMessageToContact", {
//         contactId: selectedContactId,
//         message: newMessage,
//       });
//       setNewMessage("");
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//     }
//   };

//   useEffect(() => {
//     if (!connection) return;
//     const handler = incoming => {
//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev =>
//           [...prev, incoming].sort(
//             (a, b) =>
//               new Date(a.sentAt || a.createdAt) -
//               new Date(b.sentAt || b.createdAt)
//           )
//         );
//       }
//     };
//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId]);

//   return (
//     <div className="h-screen flex flex-col overflow-hidden">
//       {/* üîí Top App Bar */}
//       <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0">
//         <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
//           üì® Inbox
//         </div>
//         <div className="text-sm text-gray-500">xByteChat</div>
//       </header>

//       {/* üí¨ Main 3-column layout */}
//       <div className="flex flex-1 overflow-hidden">
//         {/* üìá Left Sidebar */}
//         <div className="w-72 border-r bg-white overflow-y-auto">
//           <InboxSidebar onSelect={id => setSelectedContactId(id)} />
//         </div>

//         {/* üí¨ Chat column */}
//         <div className="flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative">
//           {/* ‚ÜîÔ∏è Toggle Right Panel */}
//           <button
//             className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
//             onClick={() => setShowRightPanel(!showRightPanel)}
//             title={showRightPanel ? "Hide contact info" : "Show contact info"}
//           >
//             {showRightPanel ? (
//               <ChevronRight size={16} />
//             ) : (
//               <ChevronLeft size={16} />
//             )}
//           </button>

//           {selectedContactId ? (
//             <>
//               {/* üßë Contact Header */}
//               <div className="shrink-0">
//                 <ChatHeader contact={contact} />
//               </div>

//               {/* üìú Message Scroll Area */}
//               <div className="flex-1 overflow-y-auto">
//                 <ChatWindow messages={messages} currentUserId={currentUserId} />
//               </div>

//               {/* ‚úèÔ∏è Chat Input (Fixed at bottom) */}
//               <div className="shrink-0">
//                 <ChatInput
//                   value={newMessage}
//                   onChange={e => setNewMessage(e.target.value)}
//                   onSend={sendMessage}
//                   disabled={!isConnected}
//                 />
//               </div>
//             </>
//           ) : (
//             <div className="flex-1 flex items-center justify-center text-gray-400">
//               Please select a contact to start chatting.
//             </div>
//           )}
//         </div>

//         {/* üìá Right Contact Info */}
//         {showRightPanel && selectedContactId && (
//           <div className="w-80 border-l bg-white overflow-y-auto">
//             <ContactSidebar contactId={selectedContactId} />
//           </div>
//         )}
//       </div>
//     </div>
//   );
// }

// import React, { useEffect, useState } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import InboxSidebar from "./components/InboxSidebar";
// import ChatWindow from "./components/ChatWindow";
// import ChatInput from "./components/ChatInput";
// import ContactSidebar from "./components/ContactSidebar";
// import ChatHeader from "./components/ChatHeader";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import { ChevronLeft, ChevronRight } from "lucide-react";
// import { Inbox } from "lucide-react"; // ‚úÖ Add this at top
// export default function InboxWrapper() {
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [showRightPanel, setShowRightPanel] = useState(true);

//   const currentUserId = localStorage.getItem("userId");

//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     const loadContact = async () => {
//       try {
//         const res = await axiosClient.get(`/contacts/${selectedContactId}`);
//         setContact(res.data);
//       } catch (err) {
//         console.error("‚ùå Failed to load contact:", err);
//       }
//     };
//     loadContact();
//   }, [selectedContactId]);

//   useEffect(() => {
//     if (!selectedContactId) return;
//     const loadMessages = async () => {
//       try {
//         const res = await axiosClient.get(
//           `/inbox/messages?contactId=${selectedContactId}`
//         );
//         setMessages(res.data);
//       } catch (err) {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       }
//     };
//     loadMessages();
//   }, [selectedContactId]);

//   const sendMessage = async () => {
//     if (!selectedContactId)
//       return toast.error("‚ùó Please select a contact first.");
//     if (!newMessage.trim()) return toast.warn("‚ö†Ô∏è Please type a message.");
//     if (!connection || !isConnected)
//       return toast.error("‚ùå SignalR not connected.");

//     const payload = {
//       contactId: selectedContactId,
//       message: newMessage,
//     };

//     try {
//       await connection.invoke("SendMessageToContact", payload);
//       setNewMessage("");
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//     }
//   };

//   useEffect(() => {
//     if (!connection) return;
//     const handler = incoming => {
//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev =>
//           [...prev, incoming].sort(
//             (a, b) =>
//               new Date(a.sentAt || a.createdAt) -
//               new Date(b.sentAt || b.createdAt)
//           )
//         );
//       }
//     };
//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId]);

//   return (
//     <div className="flex flex-col h-screen bg-white">
//       {/* üü£ Top App Bar */}
//       <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between">
//         <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
//           <Inbox size={18} className="text-purple-600" />
//           Inbox
//         </div>
//         <div className="text-sm text-gray-500">xByteChat</div>
//       </header>

//       {/* üí¨ Main Body Layout */}
//       <div className="flex flex-1 overflow-hidden">
//         {/* Sidebar */}
//         <div className="w-72 border-r bg-white overflow-y-auto">
//           <InboxSidebar onSelect={id => setSelectedContactId(id)} />
//         </div>

//         {/* Chat Column */}
//         <div className="flex flex-col flex-1 bg-[#f0f0eb] relative">
//           {/* Toggle Right Panel Button */}
//           <button
//             className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
//             onClick={() => setShowRightPanel(!showRightPanel)}
//             title={showRightPanel ? "Hide contact info" : "Show contact info"}
//           >
//             {showRightPanel ? (
//               <ChevronRight size={16} />
//             ) : (
//               <ChevronLeft size={16} />
//             )}
//           </button>

//           {selectedContactId ? (
//             <>
//               {/* Chat Header (Not Sticky) */}
//               <div className="shrink-0">
//                 <ChatHeader contact={contact} />
//               </div>

//               {/* Scrollable Chat Window */}
//               <div className="flex-1 overflow-y-auto">
//                 <ChatWindow
//                   messages={messages}
//                   currentUserId={currentUserId}
//                   contact={contact}
//                 />
//               </div>

//               {/* Input */}
//               <ChatInput
//                 value={newMessage}
//                 onChange={e => setNewMessage(e.target.value)}
//                 onSend={sendMessage}
//                 disabled={!isConnected}
//               />
//             </>
//           ) : (
//             <div className="flex-1 flex items-center justify-center text-gray-400">
//               Please select a contact to start chatting.
//             </div>
//           )}
//         </div>

//         {/* Right Panel */}
//         {showRightPanel && selectedContactId && (
//           <div className="w-80 border-l bg-white overflow-y-auto">
//             <ContactSidebar contactId={selectedContactId} />
//           </div>
//         )}
//       </div>
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\Inbox_AllFileDump.txt 
====================================================== 
 
Folder and File Content Report
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\ExtrackAllFiles.bat 
====================================================== 
 
@echo off
REM This script will find all files and output their name and content into one file.
REM The output file will be named [FolderName]_AllFileDump.txt.

REM Get the current folder's name and set it as the output file name with the custom suffix
for %%I in ("%cd%") do set "outputFile=%%~nI_AllFileDump.txt"

REM Clear the output file to start fresh
> "%outputFile%" (echo Folder and File Content Report)
echo. >> "%outputFile%"

REM Loop through all files in the current directory and subdirectories
for /R . %%F in (*.*) do (
    echo ====================================================== >> "%outputFile%"
    echo FILE: %%F >> "%outputFile%"
    echo ====================================================== >> "%outputFile%"
    echo. >> "%outputFile%"
    type "%%F" >> "%outputFile%" 2>nul
    echo. >> "%outputFile%"
    echo. >> "%outputFile%"
)

echo Finished! All content has been extracted to %outputFile% 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\InboxContext.jsx 
====================================================== 
 
import React, { createContext, useContext, useState, useEffect } from "react";
import useSignalR from "../../hooks/useSignalR";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";

const InboxContext = createContext();

export const useInbox = () => useContext(InboxContext);

export const InboxProvider = ({ children }) => {
  // All state is managed here
  const { connection, isConnected } = useSignalR();
  const [messages, setMessages] = useState([]);
  const [selectedContactId, setSelectedContactId] = useState(null);
  const [newMessage, setNewMessage] = useState("");
  const [contact, setContact] = useState(null);
  const [playSound, setPlaySound] = useState(
    localStorage.getItem("playSound") === "true"
  );
  const [userHasInteracted, setUserHasInteracted] = useState(false);

  const currentUserId = localStorage.getItem("userId");

  // Track user interaction for sound autoplay
  useEffect(() => {
    const handleUserInteraction = () => setUserHasInteracted(true);
    window.addEventListener("click", handleUserInteraction);
    window.addEventListener("keydown", handleUserInteraction);
    return () => {
      window.removeEventListener("click", handleUserInteraction);
      window.removeEventListener("keydown", handleUserInteraction);
    };
  }, []);

  // Fetch contact details when a contact is selected
  useEffect(() => {
    if (!selectedContactId) {
      setContact(null);
      return;
    }
    axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
      setContact(res.data);
    });
  }, [selectedContactId]);

  // Load message history with robust clearing logic
  useEffect(() => {
    if (!selectedContactId) {
      setMessages([]);
      return;
    }
    setMessages([]); // Instantly clear old messages for better UX
    axiosClient
      .get(`/inbox/messages?contactId=${selectedContactId}`)
      .then(res => {
        const normalized = (res.data || []).map(m => ({
          ...m,
          messageContent: m.messageContent ?? m.message, // ‚úÖ normalize
        }));
        setMessages(normalized);
      })
      .catch(err => {
        console.error("‚ùå Failed to load messages:", err);
        toast.error("Failed to load messages.");
      });
  }, [selectedContactId]);

  // SignalR listener for incoming messages
  useEffect(() => {
    if (!connection) return;

    const handler = incoming => {
      const normalized = {
        ...incoming,
        messageContent: incoming.messageContent ?? incoming.message, // ‚úÖ normalize
      };

      if (
        normalized.contactId !== selectedContactId &&
        playSound &&
        userHasInteracted
      ) {
        new Audio("/sounds/inbox_notify.mp3").play().catch(() => {});
      }

      if (normalized.contactId === selectedContactId) {
        setMessages(prev => {
          if (!normalized.isIncoming) {
            // This is our own message coming back from the server; replace the temp one
            return prev.map(m => (m.status === "Sending" ? normalized : m));
          }
          // This is a new message from the contact; add it to the end
          return [...prev, normalized];
        });
      }
    };

    connection.on("ReceiveInboxMessage", handler);
    return () => connection.off("ReceiveInboxMessage", handler);
  }, [connection, selectedContactId, playSound, userHasInteracted]);

  // Function to toggle notification sound
  const toggleSound = async () => {
    const newVal = !playSound;
    if (newVal) {
      try {
        await new Audio("/sounds/inbox_notify.mp3").play();
        setPlaySound(true);
        localStorage.setItem("playSound", "true");
      } catch (err) {
        toast.error("üîá Browser blocked sound. Please enable autoplay.");
        setPlaySound(false);
        localStorage.setItem("playSound", "false");
      }
    } else {
      setPlaySound(false);
      localStorage.setItem("playSound", "false");
    }
  };

  // Function to send a message with optimistic UI
  const sendMessage = async () => {
    if (!selectedContactId || !newMessage.trim() || !isConnected) return;

    const tempId = `temp_${Date.now()}`;
    const optimisticMessage = {
      id: tempId,
      contactId: selectedContactId,
      messageContent: newMessage, // ‚úÖ consistent
      isIncoming: false,
      sentAt: new Date().toISOString(),
      status: "Sending",
    };

    setMessages(prev => [...prev, optimisticMessage]);
    setNewMessage("");

    try {
      await connection.invoke("SendMessageToContact", {
        contactId: selectedContactId,
        message: newMessage, // backend DTO expects "message"
      });
    } catch (err) {
      console.error("‚ùå Send failed:", err);
      toast.error("Failed to send message.");
      setMessages(prev =>
        prev.map(m => (m.id === tempId ? { ...m, status: "Failed" } : m))
      );
    }
  };

  // The value provided to all consumer components
  const value = {
    connection,
    isConnected,
    messages,
    selectedContactId,
    setSelectedContactId,
    newMessage,
    setNewMessage,
    contact,
    playSound,
    toggleSound,
    sendMessage,
    currentUserId,
  };

  return (
    <InboxContext.Provider value={value}>{children}</InboxContext.Provider>
  );
};

// import React, { createContext, useContext, useState, useEffect } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";

// const InboxContext = createContext();

// export const useInbox = () => useContext(InboxContext);

// export const InboxProvider = ({ children }) => {
//   // All state is managed here
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [playSound, setPlaySound] = useState(
//     localStorage.getItem("playSound") === "true"
//   );
//   const [userHasInteracted, setUserHasInteracted] = useState(false);

//   const currentUserId = localStorage.getItem("userId");

//   // Track user interaction for sound autoplay
//   useEffect(() => {
//     const handleUserInteraction = () => setUserHasInteracted(true);
//     window.addEventListener("click", handleUserInteraction);
//     window.addEventListener("keydown", handleUserInteraction);
//     return () => {
//       window.removeEventListener("click", handleUserInteraction);
//       window.removeEventListener("keydown", handleUserInteraction);
//     };
//   }, []);

//   // Fetch contact details when a contact is selected
//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
//       setContact(res.data);
//     });
//   }, [selectedContactId]);

//   // Load message history with robust clearing logic
//   useEffect(() => {
//     if (!selectedContactId) {
//       setMessages([]);
//       return;
//     }
//     setMessages([]); // Instantly clear old messages for better UX
//     axiosClient
//       .get(`/inbox/messages?contactId=${selectedContactId}`)
//       .then(res => setMessages(res.data))
//       .catch(err => {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       });
//   }, [selectedContactId]);

//   // SignalR listener for incoming messages
//   useEffect(() => {
//     if (!connection) return;
//     const handler = incoming => {
//       if (
//         incoming.contactId !== selectedContactId &&
//         playSound &&
//         userHasInteracted
//       ) {
//         new Audio("/sounds/inbox_notify.mp3").play().catch(() => {});
//       }

//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev => {
//           if (!incoming.isIncoming) {
//             // This is our own message coming back from the server; replace the temp one
//             return prev.map(m => (m.status === "Sending" ? incoming : m));
//           }
//           // This is a new message from the contact; add it to the end
//           return [...prev, incoming];
//         });
//       }
//     };

//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId, playSound, userHasInteracted]);

//   // Function to toggle notification sound
//   const toggleSound = async () => {
//     const newVal = !playSound;
//     if (newVal) {
//       try {
//         await new Audio("/sounds/inbox_notify.mp3").play();
//         setPlaySound(true);
//         localStorage.setItem("playSound", "true");
//       } catch (err) {
//         toast.error("üîá Browser blocked sound. Please enable autoplay.");
//         setPlaySound(false);
//         localStorage.setItem("playSound", "false");
//       }
//     } else {
//       setPlaySound(false);
//       localStorage.setItem("playSound", "false");
//     }
//   };

//   // Function to send a message with optimistic UI
//   const sendMessage = async () => {
//     if (!selectedContactId || !newMessage.trim() || !isConnected) return;

//     const tempId = `temp_${Date.now()}`;
//     const optimisticMessage = {
//       id: tempId,
//       contactId: selectedContactId,
//       messageContent: newMessage,
//       isIncoming: false,
//       sentAt: new Date().toISOString(),
//       status: "Sending",
//     };

//     setMessages(prev => [...prev, optimisticMessage]);
//     setNewMessage("");

//     try {
//       await connection.invoke("SendMessageToContact", {
//         contactId: selectedContactId,
//         message: newMessage,
//       });
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//       setMessages(prev =>
//         prev.map(m => (m.id === tempId ? { ...m, status: "Failed" } : m))
//       );
//     }
//   };

//   // The value provided to all consumer components
//   const value = {
//     connection,
//     isConnected,
//     messages,
//     selectedContactId,
//     setSelectedContactId,
//     newMessage,
//     setNewMessage,
//     contact,
//     playSound,
//     toggleSound,
//     sendMessage,
//     currentUserId,
//   };

//   return (
//     <InboxContext.Provider value={value}>{children}</InboxContext.Provider>
//   );
// };
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\InboxWrapper.jsx 
====================================================== 
 
import React, { useState, useEffect } from "react";
import { InboxProvider, useInbox } from "./InboxContext";
import InboxSidebar from "./components/InboxSidebar";
import ChatWindow from "./components/ChatWindow";
import ChatInput from "./components/ChatInput";
import ContactSidebar from "./components/ContactSidebar";
import ChatHeader from "./components/ChatHeader";
import { ChevronLeft, ChevronRight, Bell } from "lucide-react";

// The layout component gets its data from our new hook
function InboxLayout() {
  const {
    selectedContactId,
    setSelectedContactId,
    currentUserId,
    playSound,
    toggleSound,
  } = useInbox();

  const [showRightPanel, setShowRightPanel] = useState(true);

  // Control body scrolling when inbox is mounted
  useEffect(() => {
    // Store original styles
    const originalBodyOverflow = document.body.style.overflow;
    const originalHtmlOverflow = document.documentElement.style.overflow;

    // Add classes to prevent scrolling
    document.body.classList.add("inbox-active");
    document.documentElement.classList.add("inbox-active");

    // Force prevent scrolling
    document.body.style.overflow = "hidden";
    document.documentElement.style.overflow = "hidden";

    // Cleanup function to restore original styles
    return () => {
      document.body.classList.remove("inbox-active");
      document.documentElement.classList.remove("inbox-active");
      document.body.style.overflow = originalBodyOverflow;
      document.documentElement.style.overflow = originalHtmlOverflow;
    };
  }, []);

  return (
    <div className="inbox-fullscreen h-screen flex flex-col overflow-hidden">
      <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0">
        <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
          <span className="text-xl">üì®</span>
          Inbox
        </div>
        <div className="flex items-center gap-4">
          <button
            onClick={toggleSound}
            className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${
              playSound
                ? "bg-green-100 text-green-600 border-green-300"
                : "bg-gray-100 text-gray-500 border-gray-300"
            }`}
          >
            <Bell size={14} /> {playSound ? "Sound ON" : "Sound OFF"}
          </button>
        </div>
      </header>

      <div className="flex flex-1 overflow-hidden">
        {/* Left Sidebar - Always visible */}
        <div
          className="bg-white border-r overflow-y-auto"
          style={{
            width: "288px",
            minWidth: "288px",
            maxWidth: "288px",
            height: "100%",
          }}
        >
          <InboxSidebar
            onSelect={id => setSelectedContactId(id)}
            currentUserId={currentUserId}
          />
        </div>

        <div className="flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative">
          <button
            className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
            onClick={() => setShowRightPanel(!showRightPanel)}
            title={showRightPanel ? "Hide contact info" : "Show contact info"}
          >
            {showRightPanel ? (
              <ChevronRight size={16} />
            ) : (
              <ChevronLeft size={16} />
            )}
          </button>

          {selectedContactId ? (
            <>
              {/* Chat Header - Fixed at top */}
              <div className="shrink-0">
                <ChatHeader contactId={selectedContactId} />
              </div>

              {/* Chat Window - Scrollable area that takes remaining space */}
              <div className="flex-1 overflow-hidden">
                <ChatWindow />
              </div>

              {/* Chat Input - Fixed at bottom */}
              <div className="shrink-0" style={{ flexShrink: 0 }}>
                <ChatInput />
              </div>
            </>
          ) : (
            <div className="flex-1 flex items-center justify-center text-gray-400">
              Please select a contact to start chatting.
            </div>
          )}
        </div>

        {showRightPanel && selectedContactId && (
          <div
            className="w-80 border-l bg-white overflow-y-auto"
            style={{ height: "100%", maxHeight: "100%" }}
          >
            <ContactSidebar contactId={selectedContactId} />
          </div>
        )}
      </div>
    </div>
  );
}

// The final export wraps our layout with the provider
export default function InboxWrapper() {
  return (
    <InboxProvider>
      <InboxLayout />
    </InboxProvider>
  );
}
// import React, { useEffect, useState } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import InboxSidebar from "./components/InboxSidebar";
// import ChatWindow from "./components/ChatWindow";
// import ChatInput from "./components/ChatInput";
// import ContactSidebar from "./components/ContactSidebar";
// import ChatHeader from "./components/ChatHeader";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import { ChevronLeft, ChevronRight, Bell } from "lucide-react";
// import { InboxProvider, useInbox } from "./InboxContext";
// export default function InboxWrapper() {
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [showRightPanel, setShowRightPanel] = useState(true);
//   const [playSound, setPlaySound] = useState(
//     localStorage.getItem("playSound") === "true"
//   );
//   const [userHasInteracted, setUserHasInteracted] = useState(false);

//   const currentUserId = localStorage.getItem("userId");

//   // ‚úÖ Track first user interaction to allow audio play
//   useEffect(() => {
//     const handleUserInteraction = () => setUserHasInteracted(true);
//     window.addEventListener("click", handleUserInteraction);
//     window.addEventListener("keydown", handleUserInteraction);
//     return () => {
//       window.removeEventListener("click", handleUserInteraction);
//       window.removeEventListener("keydown", handleUserInteraction);
//     };
//   }, []);

//   // üîä Sound toggle with permission
//   const toggleSound = async () => {
//     const newVal = !playSound;

//     if (newVal) {
//       try {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         await audio.play();
//         audio.pause();
//         setPlaySound(true);
//         localStorage.setItem("playSound", "true");
//       } catch (err) {
//         toast.error("üîá Browser blocked sound. Allow autoplay.");
//         console.warn("‚ö†Ô∏è Audio play blocked:", err);
//         setPlaySound(false);
//         localStorage.setItem("playSound", "false");
//       }
//     } else {
//       setPlaySound(false);
//       localStorage.setItem("playSound", "false");
//     }
//   };

//   // üìû Fetch contact info on select
//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
//       setContact(res.data);
//     });
//   }, [selectedContactId]);

//   // üì© Load message history
//   useEffect(() => {
//     if (!selectedContactId) return;
//     axiosClient
//       .get(`/inbox/messages?contactId=${selectedContactId}`)
//       .then(res => setMessages(res.data))
//       .catch(err => {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       });
//   }, [selectedContactId]);

//   // üöÄ Send message
//   // const sendMessage = async () => {
//   //   if (!selectedContactId)
//   //     return toast.error("‚ùó Please select a contact first.");
//   //   if (!newMessage.trim()) return toast.warn("‚ö†Ô∏è Please type a message.");
//   //   if (!connection || !isConnected)
//   //     return toast.error("‚ùå SignalR not connected.");

//   //   try {
//   //     await connection.invoke("SendMessageToContact", {
//   //       contactId: selectedContactId,
//   //       message: newMessage,
//   //     });
//   //     setNewMessage("");
//   //   } catch (err) {
//   //     console.error("‚ùå Send failed:", err);
//   //     toast.error("Failed to send message.");
//   //   }
//   // };
//   const sendMessage = async () => {
//     if (!selectedContactId || !newMessage.trim()) return;
//     if (!connection || !isConnected)
//       return toast.error("‚ùå SignalR not connected.");

//     // 1. Create a temporary message for optimistic UI
//     const tempId = `temp_${Date.now()}`;
//     const optimisticMessage = {
//       id: tempId,
//       contactId: selectedContactId,
//       messageContent: newMessage,
//       isIncoming: false,
//       sentAt: new Date().toISOString(),
//       status: "Sending", // Special status for the UI
//     };

//     // 2. Add to state immediately and clear input
//     setMessages(prevMessages => [...prevMessages, optimisticMessage]);
//     setNewMessage("");

//     try {
//       // 3. Send to server
//       await connection.invoke("SendMessageToContact", {
//         contactId: selectedContactId,
//         message: newMessage,
//         // Optional: send tempId to make replacement easier
//         // tempId: tempId
//       });
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//       // Handle error: update the optimistic message to show a "Failed" status
//       setMessages(prev =>
//         prev.map(m => (m.id === tempId ? { ...m, status: "Failed" } : m))
//       );
//     }
//   };
//   // üîî Real-time message listener
//   // useEffect(() => {
//   //   if (!connection) return;

//   //   const handler = incoming => {
//   //     if (
//   //       incoming.contactId !== selectedContactId &&
//   //       playSound &&
//   //       userHasInteracted
//   //     ) {
//   //       try {
//   //         const audio = new Audio("/sounds/inbox_notify.mp3");
//   //         audio.play().catch(err => {
//   //           console.warn("üîá Browser prevented sound playback:", err);
//   //         });
//   //       } catch (err) {
//   //         console.warn("‚ùå Sound error:", err);
//   //       }
//   //     }

//   //     if (incoming.contactId === selectedContactId) {
//   //       setMessages(prev =>
//   //         [...prev, incoming].sort(
//   //           (a, b) =>
//   //             new Date(a.sentAt || a.createdAt) -
//   //             new Date(b.sentAt || b.createdAt)
//   //         )
//   //       );
//   //     }
//   //   };
//   useEffect(() => {
//     if (!connection) return;

//     const handler = incoming => {
//       // ... sound playing logic ...

//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev => {
//           // If the message is from the current user, replace the temp message
//           if (!incoming.isIncoming) {
//             return prev.map(m => (m.status === "Sending" ? incoming : m));
//           }
//           // Otherwise, just add the new incoming message
//           return [...prev, incoming];
//         });
//       }
//     };
//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId, playSound, userHasInteracted]);

//   return (
//     <div className="h-screen flex flex-col overflow-hidden">
//       {/* üîí Top App Bar */}
//       <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0">
//         <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
//           <span className="text-xl">üì®</span> Inbox
//         </div>
//         <div className="flex items-center gap-4">
//           <button
//             onClick={toggleSound}
//             className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${
//               playSound
//                 ? "bg-green-100 text-green-600 border-green-300"
//                 : "bg-gray-100 text-gray-500 border-gray-300"
//             }`}
//           >
//             <Bell size={14} /> {playSound ? "Sound ON" : "Sound OFF"}
//           </button>
//         </div>
//       </header>

//       {/* üí¨ Main layout */}
//       <div className="flex flex-1 overflow-hidden">
//         {/* üìá Left Sidebar */}
//         <div className="w-72 border-r bg-white overflow-y-auto">
//           <InboxSidebar
//             onSelect={id => setSelectedContactId(id)}
//             currentUserId={currentUserId}
//           />
//         </div>

//         {/* üí¨ Chat Area */}
//         <div className="flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative">
//           <button
//             className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
//             onClick={() => setShowRightPanel(!showRightPanel)}
//             title={showRightPanel ? "Hide contact info" : "Show contact info"}
//           >
//             {showRightPanel ? (
//               <ChevronRight size={16} />
//             ) : (
//               <ChevronLeft size={16} />
//             )}
//           </button>

//           {selectedContactId ? (
//             <>
//               <div className="shrink-0">
//                 <ChatHeader contact={contact} />
//               </div>
//               <div className="flex-1 overflow-y-auto">
//                 <ChatWindow
//                   messages={messages}
//                   currentUserId={currentUserId}
//                   selectedContactId={selectedContactId}
//                   connection={connection}
//                 />
//               </div>
//               <div className="shrink-0">
//                 <ChatInput
//                   value={newMessage}
//                   onChange={e => setNewMessage(e.target.value)}
//                   onSend={sendMessage}
//                   disabled={!isConnected}
//                 />
//               </div>
//             </>
//           ) : (
//             <div className="flex-1 flex items-center justify-center text-gray-400">
//               Please select a contact to start chatting.
//             </div>
//           )}
//         </div>

//         {/* üìá Right Panel */}
//         {showRightPanel && selectedContactId && (
//           <div className="w-80 border-l bg-white overflow-y-auto">
//             <ContactSidebar contactId={selectedContactId} />
//           </div>
//         )}
//       </div>
//     </div>
//   );
// }

// import React, { useEffect, useState } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import InboxSidebar from "./components/InboxSidebar";
// import ChatWindow from "./components/ChatWindow";
// import ChatInput from "./components/ChatInput";
// import ContactSidebar from "./components/ContactSidebar";
// import ChatHeader from "./components/ChatHeader";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import { ChevronLeft, ChevronRight, Bell } from "lucide-react";

// export default function InboxWrapper() {
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [showRightPanel, setShowRightPanel] = useState(true);
//   const [playSound, setPlaySound] = useState(
//     localStorage.getItem("playSound") === "true"
//   );

//   const currentUserId = localStorage.getItem("userId");

//   // üîä Sound toggle with permission
//   const toggleSound = async () => {
//     const newVal = !playSound;

//     if (newVal) {
//       try {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         await audio.play();
//         audio.pause();
//         setPlaySound(true);
//         localStorage.setItem("playSound", "true");
//       } catch (err) {
//         toast.error("üîá Browser blocked sound. Allow autoplay.");
//         console.warn("‚ö†Ô∏è Audio play blocked:", err);
//         setPlaySound(false);
//         localStorage.setItem("playSound", "false");
//       }
//     } else {
//       setPlaySound(false);
//       localStorage.setItem("playSound", "false");
//     }
//   };

//   // üìû Fetch contact info on select
//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
//       setContact(res.data);
//     });
//   }, [selectedContactId]);

//   // üì© Load message history
//   useEffect(() => {
//     if (!selectedContactId) return;
//     axiosClient
//       .get(`/inbox/messages?contactId=${selectedContactId}`)
//       .then(res => setMessages(res.data))
//       .catch(err => {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       });
//   }, [selectedContactId]);

//   // üöÄ Send message
//   const sendMessage = async () => {
//     if (!selectedContactId)
//       return toast.error("‚ùó Please select a contact first.");
//     if (!newMessage.trim()) return toast.warn("‚ö†Ô∏è Please type a message.");
//     if (!connection || !isConnected)
//       return toast.error("‚ùå SignalR not connected.");

//     try {
//       await connection.invoke("SendMessageToContact", {
//         contactId: selectedContactId,
//         message: newMessage,
//       });
//       setNewMessage("");
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//     }
//   };

//   // üîî Real-time message listener
//   useEffect(() => {
//     if (!connection) return;

//     const handler = incoming => {
//       if (incoming.contactId !== selectedContactId && playSound) {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         audio.play();
//       }

//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev =>
//           [...prev, incoming].sort(
//             (a, b) =>
//               new Date(a.sentAt || a.createdAt) -
//               new Date(b.sentAt || b.createdAt)
//           )
//         );
//       }
//     };

//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId, playSound]);

//   return (
//     <div className="h-screen flex flex-col overflow-hidden">
//       {/* üîí Top App Bar */}
//       <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0">
//         <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
//           <span className="text-xl">üì®</span> Inbox
//         </div>
//         <div className="flex items-center gap-4">
//           <button
//             onClick={toggleSound}
//             className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${
//               playSound
//                 ? "bg-green-100 text-green-600 border-green-300"
//                 : "bg-gray-100 text-gray-500 border-gray-300"
//             }`}
//           >
//             <Bell size={14} /> {playSound ? "Sound ON" : "Sound OFF"}
//           </button>
//           <div className="text-sm text-gray-500">xByteChat</div>
//         </div>
//       </header>

//       {/* üí¨ Main layout */}
//       <div className="flex flex-1 overflow-hidden">
//         {/* üìá Left Sidebar */}
//         <div className="w-72 border-r bg-white overflow-y-auto">
//           <InboxSidebar
//             onSelect={id => setSelectedContactId(id)}
//             currentUserId={currentUserId}
//           />
//         </div>

//         {/* üí¨ Chat Area */}
//         <div className="flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative">
//           <button
//             className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
//             onClick={() => setShowRightPanel(!showRightPanel)}
//             title={showRightPanel ? "Hide contact info" : "Show contact info"}
//           >
//             {showRightPanel ? (
//               <ChevronRight size={16} />
//             ) : (
//               <ChevronLeft size={16} />
//             )}
//           </button>

//           {selectedContactId ? (
//             <>
//               <div className="shrink-0">
//                 <ChatHeader contact={contact} />
//               </div>
//               <div className="flex-1 overflow-y-auto">
//                 <ChatWindow
//                   messages={messages}
//                   currentUserId={currentUserId}
//                   selectedContactId={selectedContactId}
//                   connection={connection}
//                 />
//               </div>
//               <div className="shrink-0">
//                 <ChatInput
//                   value={newMessage}
//                   onChange={e => setNewMessage(e.target.value)}
//                   onSend={sendMessage}
//                   disabled={!isConnected}
//                 />
//               </div>
//             </>
//           ) : (
//             <div className="flex-1 flex items-center justify-center text-gray-400">
//               Please select a contact to start chatting.
//             </div>
//           )}
//         </div>

//         {/* üìá Right Panel */}
//         {showRightPanel && selectedContactId && (
//           <div className="w-80 border-l bg-white overflow-y-auto">
//             <ContactSidebar contactId={selectedContactId} />
//           </div>
//         )}
//       </div>
//     </div>
//   );
// }

// import React, { useEffect, useState } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import InboxSidebar from "./components/InboxSidebar";
// import ChatWindow from "./components/ChatWindow";
// import ChatInput from "./components/ChatInput";
// import ContactSidebar from "./components/ContactSidebar";
// import ChatHeader from "./components/ChatHeader";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import { ChevronLeft, ChevronRight, Bell } from "lucide-react";

// export default function InboxWrapper() {
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [showRightPanel, setShowRightPanel] = useState(true);
//   const [playSound, setPlaySound] = useState(
//     localStorage.getItem("playSound") === "true"
//   );

//   const currentUserId = localStorage.getItem("userId");

//   const toggleSound = async () => {
//     const newVal = !playSound;

//     if (newVal) {
//       // Try to play dummy sound to get permission
//       try {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         await audio.play();
//         audio.pause();
//         setPlaySound(true);
//         localStorage.setItem("playSound", "true");
//       } catch (err) {
//         toast.error("üîá Your browser blocked sound. Please allow autoplay.");
//         console.warn("‚ö†Ô∏è Audio play blocked:", err);
//         setPlaySound(false);
//         localStorage.setItem("playSound", "false");
//       }
//     } else {
//       setPlaySound(false);
//       localStorage.setItem("playSound", "false");
//     }
//   };

//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
//       setContact(res.data);
//     });
//   }, [selectedContactId]);

//   useEffect(() => {
//     if (!selectedContactId) return;
//     axiosClient
//       .get(`/inbox/messages?contactId=${selectedContactId}`)
//       .then(res => setMessages(res.data))
//       .catch(err => {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       });
//   }, [selectedContactId]);

//   const sendMessage = async () => {
//     if (!selectedContactId)
//       return toast.error("‚ùó Please select a contact first.");
//     if (!newMessage.trim()) return toast.warn("‚ö†Ô∏è Please type a message.");
//     if (!connection || !isConnected)
//       return toast.error("‚ùå SignalR not connected.");

//     try {
//       await connection.invoke("SendMessageToContact", {
//         contactId: selectedContactId,
//         message: newMessage,
//       });
//       setNewMessage("");
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//     }
//   };

//   useEffect(() => {
//     if (!connection) return;
//     const handler = incoming => {
//       // ‚úÖ Play sound only if it's from another contact
//       if (incoming.contactId !== selectedContactId && playSound) {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         audio.play();
//       }
//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev =>
//           [...prev, incoming].sort(
//             (a, b) =>
//               new Date(a.sentAt || a.createdAt) -
//               new Date(b.sentAt || b.createdAt)
//           )
//         );
//       }
//     };
//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId, playSound]);

//   return (
//     <div className="h-screen flex flex-col overflow-hidden">
//       {/* üîí Top App Bar */}
//       <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0">
//         <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
//           <span className="text-xl">üì®</span> Inbox
//         </div>
//         <div className="flex items-center gap-4">
//           <button
//             onClick={toggleSound}
//             className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${
//               playSound
//                 ? "bg-green-100 text-green-600 border-green-300"
//                 : "bg-gray-100 text-gray-500 border-gray-300"
//             }`}
//           >
//             <Bell size={14} /> {playSound ? "Sound ON" : "Sound OFF"}
//           </button>
//           <div className="text-sm text-gray-500">xByteChat</div>
//         </div>
//       </header>

//       {/* üí¨ Main 3-column layout */}
//       <div className="flex flex-1 overflow-hidden">
//         {/* üìá Left Sidebar */}
//         <div className="w-72 border-r bg-white overflow-y-auto">
//           <InboxSidebar onSelect={id => setSelectedContactId(id)} />
//         </div>

//         {/* üí¨ Chat column */}
//         <div className="flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative">
//           <button
//             className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
//             onClick={() => setShowRightPanel(!showRightPanel)}
//             title={showRightPanel ? "Hide contact info" : "Show contact info"}
//           >
//             {showRightPanel ? (
//               <ChevronRight size={16} />
//             ) : (
//               <ChevronLeft size={16} />
//             )}
//           </button>

//           {selectedContactId ? (
//             <>
//               <div className="shrink-0">
//                 <ChatHeader contact={contact} />
//               </div>
//               <div className="flex-1 overflow-y-auto">
//                 <ChatWindow
//                   messages={messages}
//                   currentUserId={currentUserId}
//                   selectedContactId={selectedContactId}
//                   connection={connection}
//                 />
//               </div>
//               <div className="shrink-0">
//                 <ChatInput
//                   value={newMessage}
//                   onChange={e => setNewMessage(e.target.value)}
//                   onSend={sendMessage}
//                   disabled={!isConnected}
//                 />
//               </div>
//             </>
//           ) : (
//             <div className="flex-1 flex items-center justify-center text-gray-400">
//               Please select a contact to start chatting.
//             </div>
//           )}
//         </div>

//         {/* üìá Right Contact Info */}
//         {showRightPanel && selectedContactId && (
//           <div className="w-80 border-l bg-white overflow-y-auto">
//             <ContactSidebar contactId={selectedContactId} />
//           </div>
//         )}
//       </div>
//     </div>
//   );
// }

// import React, { useEffect, useState } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import InboxSidebar from "./components/InboxSidebar";
// import ChatWindow from "./components/ChatWindow";
// import ChatInput from "./components/ChatInput";
// import ContactSidebar from "./components/ContactSidebar";
// import ChatHeader from "./components/ChatHeader";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import { ChevronLeft, ChevronRight, Bell } from "lucide-react";

// export default function InboxWrapper() {
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [showRightPanel, setShowRightPanel] = useState(true);
//   const [playSound, setPlaySound] = useState(
//     localStorage.getItem("playSound") === "true"
//   );

//   const currentUserId = localStorage.getItem("userId");

//   const toggleSound = async () => {
//     const newVal = !playSound;

//     if (newVal) {
//       try {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         await audio.play();
//         audio.pause();
//         setPlaySound(true);
//         localStorage.setItem("playSound", "true");
//       } catch (err) {
//         toast.error("üîá Your browser blocked sound. Please allow autoplay.");
//         console.warn("‚ö†Ô∏è Audio play blocked:", err);
//         setPlaySound(false);
//         localStorage.setItem("playSound", "false");
//       }
//     } else {
//       setPlaySound(false);
//       localStorage.setItem("playSound", "false");
//     }
//   };

//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
//       setContact(res.data);
//     });
//   }, [selectedContactId]);

//   useEffect(() => {
//     if (!selectedContactId) return;
//     axiosClient
//       .get(`/inbox/messages?contactId=${selectedContactId}`)
//       .then(res => setMessages(res.data))
//       .catch(err => {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       });
//   }, [selectedContactId]);

//   const sendMessage = async () => {
//     if (!selectedContactId)
//       return toast.error("‚ùó Please select a contact first.");
//     if (!newMessage.trim()) return toast.warn("‚ö†Ô∏è Please type a message.");
//     if (!connection || !isConnected)
//       return toast.error("‚ùå SignalR not connected.");

//     try {
//       await connection.invoke("SendMessageToContact", {
//         contactId: selectedContactId,
//         message: newMessage,
//       });
//       setNewMessage("");
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//     }
//   };

//   useEffect(() => {
//     if (!connection) return;

//     const handler = incoming => {
//       if (incoming.contactId !== selectedContactId && playSound) {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         audio.play();
//       }

//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev =>
//           [...prev, incoming].sort(
//             (a, b) =>
//               new Date(a.sentAt || a.createdAt) -
//               new Date(b.sentAt || b.createdAt)
//           )
//         );
//       }
//     };

//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId, playSound]);

//   return (
//     <div className="h-screen flex flex-col overflow-hidden">
//       {/* üîí Top App Bar */}
//       <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0">
//         <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
//           üì® Inbox
//         </div>
//         <div className="flex items-center gap-4">
//           <button
//             onClick={toggleSound}
//             className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${
//               playSound
//                 ? "bg-green-100 text-green-600 border-green-300"
//                 : "bg-gray-100 text-gray-500 border-gray-300"
//             }`}
//           >
//             <Bell size={14} /> {playSound ? "Sound ON" : "Sound OFF"}
//           </button>
//           <div className="text-sm text-gray-500">xByteChat</div>
//         </div>
//       </header>

//       {/* üí¨ Main 3-column layout */}
//       <div className="flex flex-1 overflow-hidden">
//         {/* üìá Left Sidebar */}
//         <div className="w-72 border-r bg-white overflow-y-auto">
//           <InboxSidebar onSelect={id => setSelectedContactId(id)} />
//         </div>

//         {/* üí¨ Chat column */}
//         <div className="flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative">
//           <button
//             className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
//             onClick={() => setShowRightPanel(!showRightPanel)}
//             title={showRightPanel ? "Hide contact info" : "Show contact info"}
//           >
//             {showRightPanel ? (
//               <ChevronRight size={16} />
//             ) : (
//               <ChevronLeft size={16} />
//             )}
//           </button>

//           {selectedContactId ? (
//             <>
//               <div className="shrink-0">
//                 <ChatHeader contact={contact} />
//               </div>
//               <div className="flex-1 overflow-y-auto">
//                 <ChatWindow messages={messages} currentUserId={currentUserId} />
//               </div>
//               <div className="shrink-0">
//                 <ChatInput
//                   value={newMessage}
//                   onChange={e => setNewMessage(e.target.value)}
//                   onSend={sendMessage}
//                   disabled={!isConnected}
//                 />
//               </div>
//             </>
//           ) : (
//             <div className="flex-1 flex items-center justify-center text-gray-400">
//               Please select a contact to start chatting.
//             </div>
//           )}
//         </div>

//         {/* üìá Right Contact Info */}
//         {showRightPanel && selectedContactId && (
//           <div className="w-80 border-l bg-white overflow-y-auto">
//             <ContactSidebar contactId={selectedContactId} />
//           </div>
//         )}
//       </div>
//     </div>
//   );
// }

// // ‚úÖ Updated InboxWrapper.jsx with stable notification sound toggle via useNotificationSound
// import React, { useEffect, useState } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import useNotificationSound from "../../hooks/useNotificationSound";
// import InboxSidebar from "./components/InboxSidebar";
// import ChatWindow from "./components/ChatWindow";
// import ChatInput from "./components/ChatInput";
// import ContactSidebar from "./components/ContactSidebar";
// import ChatHeader from "./components/ChatHeader";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import { ChevronLeft, ChevronRight, Bell } from "lucide-react";

// export default function InboxWrapper() {
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [showRightPanel, setShowRightPanel] = useState(true);
//   const currentUserId = localStorage.getItem("userId");

//   const { isSoundOn, toggleSound, soundRef } = useNotificationSound();

//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
//       setContact(res.data);
//     });
//   }, [selectedContactId]);

//   useEffect(() => {
//     if (!selectedContactId) return;
//     axiosClient
//       .get(`/inbox/messages?contactId=${selectedContactId}`)
//       .then(res => setMessages(res.data))
//       .catch(err => {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       });
//   }, [selectedContactId]);

//   const sendMessage = async () => {
//     if (!selectedContactId)
//       return toast.error("‚ùó Please select a contact first.");
//     if (!newMessage.trim()) return toast.warn("‚ö†Ô∏è Please type a message.");
//     if (!connection || !isConnected)
//       return toast.error("‚ùå SignalR not connected.");

//     try {
//       await connection.invoke("SendMessageToContact", {
//         contactId: selectedContactId,
//         message: newMessage,
//       });
//       setNewMessage("");
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//     }
//   };

//   useEffect(() => {
//     if (!connection) return;

//     const handler = incoming => {
//       // ‚úÖ Use soundRef for latest value
//       if (incoming.contactId !== selectedContactId && soundRef.current) {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         audio.play();
//       }

//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev =>
//           [...prev, incoming].sort(
//             (a, b) =>
//               new Date(a.sentAt || a.createdAt) -
//               new Date(b.sentAt || b.createdAt)
//           )
//         );
//       }
//     };

//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId, soundRef]);

//   return (
//     <div className="h-screen flex flex-col overflow-hidden">
//       {/* üîí Top App Bar */}
//       <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0">
//         <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
//           üì® Inbox
//         </div>
//         <div className="flex items-center gap-4">
//           <button
//             onClick={toggleSound}
//             className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${
//               isSoundOn
//                 ? "bg-green-100 text-green-600 border-green-300"
//                 : "bg-gray-100 text-gray-500 border-gray-300"
//             }`}
//           >
//             <Bell size={14} /> {isSoundOn ? "Sound ON" : "Sound OFF"}
//           </button>
//           <div className="text-sm text-gray-500">xByteChat</div>
//         </div>
//       </header>

//       {/* üí¨ Main 3-column layout */}
//       <div className="flex flex-1 overflow-hidden">
//         {/* üìá Left Sidebar */}
//         <div className="w-72 border-r bg-white overflow-y-auto">
//           <InboxSidebar onSelect={id => setSelectedContactId(id)} />
//         </div>

//         {/* üí¨ Chat column */}
//         <div className="flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative">
//           <button
//             className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
//             onClick={() => setShowRightPanel(!showRightPanel)}
//             title={showRightPanel ? "Hide contact info" : "Show contact info"}
//           >
//             {showRightPanel ? (
//               <ChevronRight size={16} />
//             ) : (
//               <ChevronLeft size={16} />
//             )}
//           </button>

//           {selectedContactId ? (
//             <>
//               <div className="shrink-0">
//                 <ChatHeader contact={contact} />
//               </div>
//               <div className="flex-1 overflow-y-auto">
//                 <ChatWindow messages={messages} currentUserId={currentUserId} />
//               </div>
//               <div className="shrink-0">
//                 <ChatInput
//                   value={newMessage}
//                   onChange={e => setNewMessage(e.target.value)}
//                   onSend={sendMessage}
//                   disabled={!isConnected}
//                 />
//               </div>
//             </>
//           ) : (
//             <div className="flex-1 flex items-center justify-center text-gray-400">
//               Please select a contact to start chatting.
//             </div>
//           )}
//         </div>

//         {/* üìá Right Contact Info */}
//         {showRightPanel && selectedContactId && (
//           <div className="w-80 border-l bg-white overflow-y-auto">
//             <ContactSidebar contactId={selectedContactId} />
//           </div>
//         )}
//       </div>
//     </div>
//   );
// }

// ‚úÖ Updated InboxWrapper.jsx with Notification Sound Toggle + Play Logic
// import React, { useEffect, useState } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import InboxSidebar from "./components/InboxSidebar";
// import ChatWindow from "./components/ChatWindow";
// import ChatInput from "./components/ChatInput";
// import ContactSidebar from "./components/ContactSidebar";
// import ChatHeader from "./components/ChatHeader";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import { ChevronLeft, ChevronRight, Bell } from "lucide-react";

// export default function InboxWrapper() {
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [showRightPanel, setShowRightPanel] = useState(true);
//   const [playSound, setPlaySound] = useState(
//     localStorage.getItem("playSound") === "true"
//   );

//   const currentUserId = localStorage.getItem("userId");

//   // const toggleSound = () => {
//   //   const newVal = !playSound;
//   //   setPlaySound(newVal);
//   //   localStorage.setItem("playSound", newVal);
//   // };
//   const toggleSound = async () => {
//     const newVal = !playSound;

//     if (newVal) {
//       // Try to play dummy sound to get permission
//       try {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         await audio.play();
//         audio.pause();
//         setPlaySound(true);
//         localStorage.setItem("playSound", "true");
//       } catch (err) {
//         toast.error("üîá Your browser blocked sound. Please allow autoplay.");
//         console.warn("‚ö†Ô∏è Audio play blocked:", err);
//         setPlaySound(false);
//         localStorage.setItem("playSound", "false");
//       }
//     } else {
//       setPlaySound(false);
//       localStorage.setItem("playSound", "false");
//     }
//   };

//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
//       setContact(res.data);
//     });
//   }, [selectedContactId]);

//   useEffect(() => {
//     if (!selectedContactId) return;
//     axiosClient
//       .get(`/inbox/messages?contactId=${selectedContactId}`)
//       .then(res => setMessages(res.data))
//       .catch(err => {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       });
//   }, [selectedContactId]);

//   const sendMessage = async () => {
//     if (!selectedContactId)
//       return toast.error("‚ùó Please select a contact first.");
//     if (!newMessage.trim()) return toast.warn("‚ö†Ô∏è Please type a message.");
//     if (!connection || !isConnected)
//       return toast.error("‚ùå SignalR not connected.");

//     try {
//       await connection.invoke("SendMessageToContact", {
//         contactId: selectedContactId,
//         message: newMessage,
//       });
//       setNewMessage("");
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//     }
//   };

//   useEffect(() => {
//     if (!connection) return;
//     const handler = incoming => {
//       // ‚úÖ Play sound only if it's from another contact
//       if (incoming.contactId !== selectedContactId && playSound) {
//         const audio = new Audio("/sounds/inbox_notify.mp3");
//         audio.play();
//       }
//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev =>
//           [...prev, incoming].sort(
//             (a, b) =>
//               new Date(a.sentAt || a.createdAt) -
//               new Date(b.sentAt || b.createdAt)
//           )
//         );
//       }
//     };
//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId, playSound]);

//   return (
//     <div className="h-screen flex flex-col overflow-hidden">
//       {/* üîí Top App Bar */}
//       <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0">
//         <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
//           üì® Inbox
//         </div>
//         <div className="flex items-center gap-4">
//           <button
//             onClick={toggleSound}
//             className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full border shadow-sm hover:bg-purple-50 ${
//               playSound
//                 ? "bg-green-100 text-green-600 border-green-300"
//                 : "bg-gray-100 text-gray-500 border-gray-300"
//             }`}
//           >
//             <Bell size={14} /> {playSound ? "Sound ON" : "Sound OFF"}
//           </button>
//           <div className="text-sm text-gray-500">xByteChat</div>
//         </div>
//       </header>

//       {/* üí¨ Main 3-column layout */}
//       <div className="flex flex-1 overflow-hidden">
//         {/* üìá Left Sidebar */}
//         <div className="w-72 border-r bg-white overflow-y-auto">
//           <InboxSidebar onSelect={id => setSelectedContactId(id)} />
//         </div>

//         {/* üí¨ Chat column */}
//         <div className="flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative">
//           <button
//             className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
//             onClick={() => setShowRightPanel(!showRightPanel)}
//             title={showRightPanel ? "Hide contact info" : "Show contact info"}
//           >
//             {showRightPanel ? (
//               <ChevronRight size={16} />
//             ) : (
//               <ChevronLeft size={16} />
//             )}
//           </button>

//           {selectedContactId ? (
//             <>
//               <div className="shrink-0">
//                 <ChatHeader contact={contact} />
//               </div>
//               <div className="flex-1 overflow-y-auto">
//                 <ChatWindow messages={messages} currentUserId={currentUserId} />
//               </div>
//               <div className="shrink-0">
//                 <ChatInput
//                   value={newMessage}
//                   onChange={e => setNewMessage(e.target.value)}
//                   onSend={sendMessage}
//                   disabled={!isConnected}
//                 />
//               </div>
//             </>
//           ) : (
//             <div className="flex-1 flex items-center justify-center text-gray-400">
//               Please select a contact to start chatting.
//             </div>
//           )}
//         </div>

//         {/* üìá Right Contact Info */}
//         {showRightPanel && selectedContactId && (
//           <div className="w-80 border-l bg-white overflow-y-auto">
//             <ContactSidebar contactId={selectedContactId} />
//           </div>
//         )}
//       </div>
//     </div>
//   );
// }

// import React, { useEffect, useState } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import InboxSidebar from "./components/InboxSidebar";
// import ChatWindow from "./components/ChatWindow";
// import ChatInput from "./components/ChatInput";
// import ContactSidebar from "./components/ContactSidebar";
// import ChatHeader from "./components/ChatHeader";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import { ChevronLeft, ChevronRight } from "lucide-react";

// export default function InboxWrapper() {
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [showRightPanel, setShowRightPanel] = useState(true);

//   const currentUserId = localStorage.getItem("userId");

//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     axiosClient.get(`/contacts/${selectedContactId}`).then(res => {
//       setContact(res.data);
//     });
//   }, [selectedContactId]);

//   useEffect(() => {
//     if (!selectedContactId) return;
//     axiosClient
//       .get(`/inbox/messages?contactId=${selectedContactId}`)
//       .then(res => setMessages(res.data))
//       .catch(err => {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       });
//   }, [selectedContactId]);

//   const sendMessage = async () => {
//     if (!selectedContactId)
//       return toast.error("‚ùó Please select a contact first.");
//     if (!newMessage.trim()) return toast.warn("‚ö†Ô∏è Please type a message.");
//     if (!connection || !isConnected)
//       return toast.error("‚ùå SignalR not connected.");

//     try {
//       await connection.invoke("SendMessageToContact", {
//         contactId: selectedContactId,
//         message: newMessage,
//       });
//       setNewMessage("");
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//     }
//   };

//   useEffect(() => {
//     if (!connection) return;
//     const handler = incoming => {
//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev =>
//           [...prev, incoming].sort(
//             (a, b) =>
//               new Date(a.sentAt || a.createdAt) -
//               new Date(b.sentAt || b.createdAt)
//           )
//         );
//       }
//     };
//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId]);

//   return (
//     <div className="h-screen flex flex-col overflow-hidden">
//       {/* üîí Top App Bar */}
//       <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between shrink-0">
//         <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
//           üì® Inbox
//         </div>
//         <div className="text-sm text-gray-500">xByteChat</div>
//       </header>

//       {/* üí¨ Main 3-column layout */}
//       <div className="flex flex-1 overflow-hidden">
//         {/* üìá Left Sidebar */}
//         <div className="w-72 border-r bg-white overflow-y-auto">
//           <InboxSidebar onSelect={id => setSelectedContactId(id)} />
//         </div>

//         {/* üí¨ Chat column */}
//         <div className="flex flex-col flex-1 bg-[#f0f0eb] overflow-hidden relative">
//           {/* ‚ÜîÔ∏è Toggle Right Panel */}
//           <button
//             className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
//             onClick={() => setShowRightPanel(!showRightPanel)}
//             title={showRightPanel ? "Hide contact info" : "Show contact info"}
//           >
//             {showRightPanel ? (
//               <ChevronRight size={16} />
//             ) : (
//               <ChevronLeft size={16} />
//             )}
//           </button>

//           {selectedContactId ? (
//             <>
//               {/* üßë Contact Header */}
//               <div className="shrink-0">
//                 <ChatHeader contact={contact} />
//               </div>

//               {/* üìú Message Scroll Area */}
//               <div className="flex-1 overflow-y-auto">
//                 <ChatWindow messages={messages} currentUserId={currentUserId} />
//               </div>

//               {/* ‚úèÔ∏è Chat Input (Fixed at bottom) */}
//               <div className="shrink-0">
//                 <ChatInput
//                   value={newMessage}
//                   onChange={e => setNewMessage(e.target.value)}
//                   onSend={sendMessage}
//                   disabled={!isConnected}
//                 />
//               </div>
//             </>
//           ) : (
//             <div className="flex-1 flex items-center justify-center text-gray-400">
//               Please select a contact to start chatting.
//             </div>
//           )}
//         </div>

//         {/* üìá Right Contact Info */}
//         {showRightPanel && selectedContactId && (
//           <div className="w-80 border-l bg-white overflow-y-auto">
//             <ContactSidebar contactId={selectedContactId} />
//           </div>
//         )}
//       </div>
//     </div>
//   );
// }

// import React, { useEffect, useState } from "react";
// import useSignalR from "../../hooks/useSignalR";
// import InboxSidebar from "./components/InboxSidebar";
// import ChatWindow from "./components/ChatWindow";
// import ChatInput from "./components/ChatInput";
// import ContactSidebar from "./components/ContactSidebar";
// import ChatHeader from "./components/ChatHeader";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import { ChevronLeft, ChevronRight } from "lucide-react";
// import { Inbox } from "lucide-react"; // ‚úÖ Add this at top
// export default function InboxWrapper() {
//   const { connection, isConnected } = useSignalR();
//   const [messages, setMessages] = useState([]);
//   const [selectedContactId, setSelectedContactId] = useState(null);
//   const [newMessage, setNewMessage] = useState("");
//   const [contact, setContact] = useState(null);
//   const [showRightPanel, setShowRightPanel] = useState(true);

//   const currentUserId = localStorage.getItem("userId");

//   useEffect(() => {
//     if (!selectedContactId) {
//       setContact(null);
//       return;
//     }
//     const loadContact = async () => {
//       try {
//         const res = await axiosClient.get(`/contacts/${selectedContactId}`);
//         setContact(res.data);
//       } catch (err) {
//         console.error("‚ùå Failed to load contact:", err);
//       }
//     };
//     loadContact();
//   }, [selectedContactId]);

//   useEffect(() => {
//     if (!selectedContactId) return;
//     const loadMessages = async () => {
//       try {
//         const res = await axiosClient.get(
//           `/inbox/messages?contactId=${selectedContactId}`
//         );
//         setMessages(res.data);
//       } catch (err) {
//         console.error("‚ùå Failed to load messages:", err);
//         toast.error("Failed to load messages.");
//       }
//     };
//     loadMessages();
//   }, [selectedContactId]);

//   const sendMessage = async () => {
//     if (!selectedContactId)
//       return toast.error("‚ùó Please select a contact first.");
//     if (!newMessage.trim()) return toast.warn("‚ö†Ô∏è Please type a message.");
//     if (!connection || !isConnected)
//       return toast.error("‚ùå SignalR not connected.");

//     const payload = {
//       contactId: selectedContactId,
//       message: newMessage,
//     };

//     try {
//       await connection.invoke("SendMessageToContact", payload);
//       setNewMessage("");
//     } catch (err) {
//       console.error("‚ùå Send failed:", err);
//       toast.error("Failed to send message.");
//     }
//   };

//   useEffect(() => {
//     if (!connection) return;
//     const handler = incoming => {
//       if (incoming.contactId === selectedContactId) {
//         setMessages(prev =>
//           [...prev, incoming].sort(
//             (a, b) =>
//               new Date(a.sentAt || a.createdAt) -
//               new Date(b.sentAt || b.createdAt)
//           )
//         );
//       }
//     };
//     connection.on("ReceiveInboxMessage", handler);
//     return () => connection.off("ReceiveInboxMessage", handler);
//   }, [connection, selectedContactId]);

//   return (
//     <div className="flex flex-col h-screen bg-white">
//       {/* üü£ Top App Bar */}
//       <header className="h-12 bg-white border-b shadow-sm px-6 flex items-center justify-between">
//         <div className="flex items-center gap-2 text-purple-600 font-semibold text-base">
//           <Inbox size={18} className="text-purple-600" />
//           Inbox
//         </div>
//         <div className="text-sm text-gray-500">xByteChat</div>
//       </header>

//       {/* üí¨ Main Body Layout */}
//       <div className="flex flex-1 overflow-hidden">
//         {/* Sidebar */}
//         <div className="w-72 border-r bg-white overflow-y-auto">
//           <InboxSidebar onSelect={id => setSelectedContactId(id)} />
//         </div>

//         {/* Chat Column */}
//         <div className="flex flex-col flex-1 bg-[#f0f0eb] relative">
//           {/* Toggle Right Panel Button */}
//           <button
//             className="absolute right-2 top-2 z-10 bg-white border shadow-sm rounded-full p-1 text-gray-500 hover:text-purple-600"
//             onClick={() => setShowRightPanel(!showRightPanel)}
//             title={showRightPanel ? "Hide contact info" : "Show contact info"}
//           >
//             {showRightPanel ? (
//               <ChevronRight size={16} />
//             ) : (
//               <ChevronLeft size={16} />
//             )}
//           </button>

//           {selectedContactId ? (
//             <>
//               {/* Chat Header (Not Sticky) */}
//               <div className="shrink-0">
//                 <ChatHeader contact={contact} />
//               </div>

//               {/* Scrollable Chat Window */}
//               <div className="flex-1 overflow-y-auto">
//                 <ChatWindow
//                   messages={messages}
//                   currentUserId={currentUserId}
//                   contact={contact}
//                 />
//               </div>

//               {/* Input */}
//               <ChatInput
//                 value={newMessage}
//                 onChange={e => setNewMessage(e.target.value)}
//                 onSend={sendMessage}
//                 disabled={!isConnected}
//               />
//             </>
//           ) : (
//             <div className="flex-1 flex items-center justify-center text-gray-400">
//               Please select a contact to start chatting.
//             </div>
//           )}
//         </div>

//         {/* Right Panel */}
//         {showRightPanel && selectedContactId && (
//           <div className="w-80 border-l bg-white overflow-y-auto">
//             <ContactSidebar contactId={selectedContactId} />
//           </div>
//         )}
//       </div>
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\Inbox_AllFileDump.txt 
====================================================== 
 
Folder and File Content Report
 
====================================================== 
FILE: D:\xbytechat\xbytech 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\components\ChatBubble.jsx 
====================================================== 
 
import React, { useState, useRef, useEffect } from "react";
import dayjs from "dayjs";
import {
  FaCheck,
  FaCheckDouble,
  FaClock,
  FaExclamationCircle,
} from "react-icons/fa";

export default function ChatBubble({ message, isOwn }) {
  const [expanded, setExpanded] = useState(false);
  const messageRef = useRef(null);
  const [isOverflowing, setIsOverflowing] = useState(false);

  const time = dayjs(message.sentAt || message.createdAt).format("h:mm A");
  const messageText =
    message.renderedBody ||
    message.message ||
    message.messageContent ||
    "[no message]";

  useEffect(() => {
    const el = messageRef.current;
    if (el && el.scrollHeight > el.clientHeight + 10) {
      setIsOverflowing(true);
    }
  }, []);

  const baseStyle =
    "px-4 py-2 max-w-[75%] text-sm leading-snug shadow-md whitespace-pre-wrap";

  const ownStyle = "bg-green-600 text-white rounded-2xl rounded-br-sm";
  const incomingStyle = "bg-purple-100 text-gray-900 rounded-2xl rounded-bl-sm";

  const tickColor = isOwn ? "text-white/70" : "text-gray-500";

  return (
    <div className={`flex ${isOwn ? "justify-end" : "justify-start"} mb-2`}>
      <div
        ref={messageRef}
        onClick={() => isOverflowing && setExpanded(!expanded)}
        className={`${baseStyle} ${isOwn ? ownStyle : incomingStyle} ${
          expanded ? "cursor-zoom-out" : isOverflowing ? "cursor-zoom-in" : ""
        }`}
        style={{
          overflow: "hidden",
          whiteSpace: expanded ? "normal" : "pre-wrap",
        }}
      >
        <div className="flex items-end justify-between gap-2">
          <span className="flex-1">{messageText}</span>
          <span className={`text-[11px] flex items-center gap-1 ${tickColor}`}>
            {time}
            {isOwn && (
              <>
                {/* {message.status === "Sent" && <FaCheck />}
                {message.status === "Delivered" && <FaCheckDouble />}
                {message.status === "Read" && (
                  <FaCheckDouble className="text-blue-400" />
                )} */}
                {message.status === "Sending" && <FaClock />}
                {message.status === "Failed" && (
                  <FaExclamationCircle className="text-red-400" />
                )}
                {message.status === "Sent" && <FaCheck />}
                {message.status === "Delivered" && <FaCheckDouble />}
                {message.status === "Read" && (
                  <FaCheckDouble className="text-blue-400" />
                )}
              </>
            )}
          </span>
        </div>
      </div>
    </div>
  );
}

// import React, { useState, useRef, useEffect } from "react";
// import dayjs from "dayjs";
// import { FaCheck, FaCheckDouble } from "react-icons/fa";

// export default function ChatBubble({ message, isOwn }) {
//   const [expanded, setExpanded] = useState(false);
//   const messageRef = useRef(null);
//   const [isOverflowing, setIsOverflowing] = useState(false);

//   const time = dayjs(message.sentAt || message.createdAt).format("h:mm A");
//   const messageText =
//     message.renderedBody ||
//     message.message ||
//     message.messageContent ||
//     "[no message]";

//   useEffect(() => {
//     const el = messageRef.current;
//     if (el && el.scrollHeight > el.clientHeight + 10) {
//       setIsOverflowing(true);
//     }
//   }, []);

//   const baseStyle =
//     "px-4 py-2 max-w-[75%] text-sm leading-snug shadow-md whitespace-pre-wrap";

//   const ownStyle = "bg-green-600 text-white rounded-2xl rounded-br-sm";
//   const incomingStyle = "bg-purple-100 text-gray-900 rounded-2xl rounded-bl-sm";

//   const tickColor = isOwn ? "text-white/70" : "text-gray-500";

//   return (
//     <div className={`flex ${isOwn ? "justify-end" : "justify-start"} mb-2`}>
//       <div
//         ref={messageRef}
//         onClick={() => isOverflowing && setExpanded(!expanded)}
//         className={`${baseStyle} ${isOwn ? ownStyle : incomingStyle} ${
//           expanded ? "cursor-zoom-out" : isOverflowing ? "cursor-zoom-in" : ""
//         }`}
//         style={{
//           overflow: "hidden",
//           whiteSpace: expanded ? "normal" : "pre-wrap",
//         }}
//       >
//         <div className="flex items-end justify-between gap-2">
//           <span className="flex-1">
//             {messageText}
//             {message.campaignName && (
//               <div className="mt-1 text-[10px] italic text-white/80">
//                 üì¢ Sent via campaign: {message.campaignName}
//               </div>
//             )}
//           </span>

//           <span className={`text-[11px] flex items-center gap-1 ${tickColor}`}>
//             {time}
//             {isOwn && (
//               <>
//                 {message.status === "Sent" && <FaCheck />}
//                 {message.status === "Delivered" && <FaCheckDouble />}
//                 {message.status === "Read" && (
//                   <FaCheckDouble className="text-blue-400" />
//                 )}
//               </>
//             )}
//           </span>
//         </div>
//       </div>
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\components\ChatHeader.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../../api/axiosClient";

/**
 * ChatHeader ‚Äî Professional WhatsApp-style chat header
 * Props:
 * - contactId: contact ID to fetch data
 */
export default function ChatHeader({ contactId }) {
  const [contact, setContact] = useState(null);

  // Fetch contact data when contactId changes
  useEffect(() => {
    if (!contactId) {
      setContact(null);
      return;
    }

    const fetchContact = async () => {
      try {
        const res = await axiosClient.get(`/contacts/${contactId}`);
        // Handle different API response structures
        if (res?.data?.data) {
          setContact(res.data.data);
        } else if (res?.data) {
          setContact(res.data);
        } else {
          setContact(res);
        }
      } catch (err) {
        console.error("‚ùå [ChatHeader] Failed to load contact:", err);
      }
    };

    fetchContact();
  }, [contactId]);

  if (!contact) return null;

  const { name, phoneNumber } = contact;

  // üß† Extract initials from name or phone number
  const initials =
    name
      ?.split(" ")
      .map(part => part.charAt(0).toUpperCase())
      .slice(0, 2)
      .join("") ||
    phoneNumber?.slice(-2) ||
    "??";

  // Display name if present, otherwise phone number
  const displayName = name || phoneNumber || "Unknown Contact";

  return (
    <div className="bg-white border-b shadow-sm px-4 py-3 flex items-center justify-between">
      {/* Left Section: Avatar + Info */}
      <div className="flex items-center gap-4">
        {/* Avatar with Initials */}
        <div className="w-10 h-10 rounded-full bg-green-600 text-white font-semibold text-sm flex items-center justify-center shadow-sm">
          {initials}
        </div>

        {/* Name, Phone */}
        <div className="space-y-0.5">
          <h2 className="text-base font-semibold text-gray-800">
            {displayName}
          </h2>
          {name && phoneNumber && (
            <div className="text-xs text-gray-500">{phoneNumber}</div>
          )}
        </div>
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\components\ChatInput.jsx 
====================================================== 
 
import React, { useRef, useState, useCallback, useEffect } from "react";
import { useInbox } from "../InboxContext";
import { Smile, Paperclip, Send, X as CloseIcon } from "lucide-react";
import QuickReplyPicker from "./QuickReplyPicker";
import EmojiPicker from "./EmojiPicker";

export default function ChatInput() {
  const { newMessage, setNewMessage, sendMessage, isConnected } = useInbox();
  const [pickerOpen, setPickerOpen] = useState(false);
  const [emojiOpen, setEmojiOpen] = useState(false);
  const textareaRef = useRef(null);

  const clearMessage = () => setNewMessage("");

  const handleSend = () => {
    if (!isConnected || !newMessage?.trim()) return;
    setPickerOpen(false);
    setEmojiOpen(false);
    sendMessage();
    // ‚úÖ force the message list to scroll to bottom after sending
    window.dispatchEvent(new CustomEvent("xbc:scrollToBottom"));
  };

  const handleKeyDown = e => {
    if (e.key === "/" && !pickerOpen) {
      e.preventDefault();
      setPickerOpen(true);
      return;
    }
    if (e.key === "Escape" && (pickerOpen || emojiOpen)) {
      e.preventDefault();
      setPickerOpen(false);
      setEmojiOpen(false);
      return;
    }
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };

  const insertAtCursor = useCallback(
    snippet => {
      const el = textareaRef.current;
      if (!el) {
        setNewMessage(prev => (prev ? `${prev} ${snippet}` : snippet));
        return;
      }
      const start = el.selectionStart ?? newMessage?.length ?? 0;
      const end = el.selectionEnd ?? newMessage?.length ?? 0;
      const base = newMessage ?? "";
      const next = base.slice(0, start) + snippet + base.slice(end);
      setNewMessage(next);
      requestAnimationFrame(() => {
        el.focus();
        const pos = start + snippet.length;
        el.setSelectionRange(pos, pos);
      });
    },
    [newMessage, setNewMessage]
  );

  const autoResize = useCallback(() => {
    const el = textareaRef.current;
    if (!el) return;
    el.style.height = "auto";
    const max = 160; // ~4 lines
    el.style.height = Math.min(el.scrollHeight, max) + "px";
  }, []);

  useEffect(() => {
    autoResize();
  }, [newMessage, autoResize]);

  return (
    <div className="p-3 border-t bg-white overflow-visible">
      <div className="flex items-center gap-2">
        {/* Quick Reply */}
        <div className="relative">
          <button
            type="button"
            onClick={() => setPickerOpen(v => !v)}
            className="h-9 px-3 text-sm rounded-lg border bg-white hover:bg-gray-50"
            title="Saved replies"
            disabled={!isConnected}
            aria-expanded={pickerOpen}
          >
            Quick Reply
          </button>
          {pickerOpen && (
            <div className="absolute left-0 bottom-full mb-2 z-[100]">
              <QuickReplyPicker
                onInsert={text => {
                  insertAtCursor(text);
                  setPickerOpen(false);
                }}
                onClose={() => setPickerOpen(false)}
              />
            </div>
          )}
        </div>

        {/* Emoji */}
        <div className="relative">
          <button
            type="button"
            className="h-9 w-9 flex items-center justify-center rounded-lg hover:bg-gray-100"
            title="Emoji"
            disabled={!isConnected}
            aria-expanded={emojiOpen}
            onClick={() => setEmojiOpen(v => !v)}
          >
            <Smile size={16} />
          </button>
          {emojiOpen && (
            <div className="absolute left-0 bottom-full mb-2 z-[100]">
              <EmojiPicker
                onPick={emoji => {
                  insertAtCursor(emoji);
                  setEmojiOpen(false);
                }}
                onClose={() => setEmojiOpen(false)}
              />
            </div>
          )}
        </div>

        {/* Attach (placeholder) */}
        <button
          className="h-9 w-9 flex items-center justify-center rounded-lg hover:bg-gray-100"
          title="Attach"
          disabled
        >
          <Paperclip size={16} />
        </button>

        {/* Textarea + Clear X */}
        <div className="relative flex-1">
          <textarea
            ref={textareaRef}
            rows={1}
            value={newMessage}
            onChange={e => setNewMessage(e.target.value)}
            onKeyDown={handleKeyDown}
            onInput={autoResize}
            disabled={!isConnected}
            placeholder={
              !isConnected
                ? "Connecting..."
                : "Type your message‚Ä¶ (Enter to send ‚Ä¢ Shift+Enter for new line)"
            }
            className="w-full text-sm px-4 py-2 pr-12 rounded-xl border shadow-sm focus:outline-none focus:ring-1 bg-white focus:border-purple-500 resize-none min-h-[40px] max-h-40 overflow-y-auto leading-relaxed"
          />
          {!!(newMessage || "").length && (
            <button
              type="button"
              onClick={clearMessage}
              title="Clear"
              aria-label="Clear message"
              className="absolute right-2 inset-y-0 my-auto h-6 w-6 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-500"
            >
              <CloseIcon size={16} />
            </button>
          )}
        </div>

        {/* Send */}
        <button
          onClick={handleSend}
          disabled={!isConnected || !newMessage?.trim()}
          className="h-9 w-9 flex items-center justify-center rounded-full text-white bg-green-600 hover:bg-green-700 disabled:bg-green-300 disabled:cursor-not-allowed"
          title="Send"
        >
          <Send size={16} />
        </button>
      </div>
    </div>
  );
}

// import React, { useRef, useState, useCallback, useEffect } from "react";
// import { useInbox } from "../InboxContext";
// import { Smile, Paperclip, Send, X as CloseIcon } from "lucide-react";
// import QuickReplyPicker from "./QuickReplyPicker";
// import EmojiPicker from "./EmojiPicker";

// export default function ChatInput() {
//   const { newMessage, setNewMessage, sendMessage, isConnected } = useInbox();
//   const [pickerOpen, setPickerOpen] = useState(false);
//   const [emojiOpen, setEmojiOpen] = useState(false);
//   const textareaRef = useRef(null);

//   const clearMessage = () => setNewMessage("");

//   const handleSend = () => {
//     if (!isConnected || !newMessage?.trim()) return;
//     setPickerOpen(false);
//     setEmojiOpen(false);
//     sendMessage();
//   };

//   const handleKeyDown = e => {
//     if (e.key === "/" && !pickerOpen) {
//       e.preventDefault();
//       setPickerOpen(true);
//       return;
//     }
//     if (e.key === "Escape" && (pickerOpen || emojiOpen)) {
//       e.preventDefault();
//       setPickerOpen(false);
//       setEmojiOpen(false);
//       return;
//     }
//     if (e.key === "Enter" && !e.shiftKey) {
//       e.preventDefault();
//       handleSend();
//     }
//   };

//   const insertAtCursor = useCallback(
//     snippet => {
//       const el = textareaRef.current;
//       if (!el) {
//         setNewMessage(prev => (prev ? `${prev} ${snippet}` : snippet));
//         return;
//       }
//       const start = el.selectionStart ?? newMessage?.length ?? 0;
//       const end = el.selectionEnd ?? newMessage?.length ?? 0;
//       const base = newMessage ?? "";
//       const next = base.slice(0, start) + snippet + base.slice(end);
//       setNewMessage(next);
//       requestAnimationFrame(() => {
//         el.focus();
//         const pos = start + snippet.length;
//         el.setSelectionRange(pos, pos);
//       });
//     },
//     [newMessage, setNewMessage]
//   );

//   const autoResize = useCallback(() => {
//     const el = textareaRef.current;
//     if (!el) return;
//     el.style.height = "auto";
//     const max = 160; // ~4 lines
//     el.style.height = Math.min(el.scrollHeight, max) + "px";
//   }, []);

//   useEffect(() => {
//     autoResize();
//   }, [newMessage, autoResize]);

//   return (
//     <div className="p-3 border-t bg-white overflow-visible">
//       <div className="flex items-center gap-2">
//         {/* Quick Reply */}
//         <div className="relative">
//           <button
//             type="button"
//             onClick={() => setPickerOpen(v => !v)}
//             className="h-9 px-3 text-sm rounded-lg border bg-white hover:bg-gray-50"
//             title="Saved replies"
//             disabled={!isConnected}
//             aria-expanded={pickerOpen}
//           >
//             Quick Reply
//           </button>
//           {pickerOpen && (
//             <div className="absolute left-0 bottom-full mb-2 z-[100]">
//               <QuickReplyPicker
//                 onInsert={text => {
//                   insertAtCursor(text);
//                   setPickerOpen(false);
//                 }}
//                 onClose={() => setPickerOpen(false)}
//               />
//             </div>
//           )}
//         </div>

//         {/* Emoji */}
//         <div className="relative">
//           <button
//             type="button"
//             className="h-9 w-9 flex items-center justify-center rounded-lg hover:bg-gray-100"
//             title="Emoji"
//             disabled={!isConnected}
//             aria-expanded={emojiOpen}
//             onClick={() => setEmojiOpen(v => !v)}
//           >
//             <Smile size={16} />
//           </button>
//           {emojiOpen && (
//             <div className="absolute left-0 bottom-full mb-2 z-[100]">
//               <EmojiPicker
//                 onPick={emoji => {
//                   insertAtCursor(emoji);
//                   setEmojiOpen(false);
//                 }}
//                 onClose={() => setEmojiOpen(false)}
//               />
//             </div>
//           )}
//         </div>

//         {/* Attach (placeholder) */}
//         <button
//           className="h-9 w-9 flex items-center justify-center rounded-lg hover:bg-gray-100"
//           title="Attach"
//           disabled
//         >
//           <Paperclip size={16} />
//         </button>

//         {/* Textarea + Clear X */}
//         <div className="relative flex-1">
//           <textarea
//             ref={textareaRef}
//             rows={1}
//             value={newMessage}
//             onChange={e => setNewMessage(e.target.value)}
//             onKeyDown={handleKeyDown}
//             onInput={autoResize}
//             disabled={!isConnected}
//             placeholder={
//               !isConnected
//                 ? "Connecting..."
//                 : "Type your message‚Ä¶ (Enter to send ‚Ä¢ Shift+Enter for new line)"
//             }
//             className="w-full text-sm px-4 py-2 pr-12 rounded-xl border shadow-sm focus:outline-none focus:ring-1 bg-white focus:border-purple-500 resize-none min-h-[40px] max-h-40 overflow-y-auto leading-relaxed"
//           />
//           {!!(newMessage || "").length && (
//             <button
//               type="button"
//               onClick={clearMessage}
//               title="Clear"
//               aria-label="Clear message"
//               className="absolute right-2 inset-y-0 my-auto h-6 w-6 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-500"
//             >
//               <CloseIcon size={16} />
//             </button>
//           )}
//         </div>

//         {/* Send */}
//         <button
//           onClick={handleSend}
//           disabled={!isConnected || !newMessage?.trim()}
//           className="h-9 w-9 flex items-center justify-center rounded-full text-white bg-green-600 hover:bg-green-700 disabled:bg-green-300 disabled:cursor-not-allowed"
//           title="Send"
//         >
//           <Send size={16} />
//         </button>
//       </div>
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\components\ChatWindow.jsx 
====================================================== 
 
import React, { useRef, useEffect, useCallback } from "react";
import { useInbox } from "../InboxContext";
import ChatBubble from "./ChatBubble";
import dayjs from "dayjs";
import isToday from "dayjs/plugin/isToday";
import isYesterday from "dayjs/plugin/isYesterday";

dayjs.extend(isToday);
dayjs.extend(isYesterday);

function getDateLabel(date) {
  const d = dayjs(date);
  if (d.isToday()) return "Today";
  if (d.isYesterday()) return "Yesterday";
  return d.format("D MMM YYYY");
}

export default function ChatWindow() {
  const { messages = [], connection, selectedContactId } = useInbox();

  // The ONLY scroll container + a bottom anchor
  const scrollContainerRef = useRef(null);
  const bottomRef = useRef(null);

  // Track if user is already at/near bottom
  const atBottomRef = useRef(true);
  const NEAR_BOTTOM_PX = 120;

  const isNearBottom = useCallback(() => {
    const el = scrollContainerRef.current;
    if (!el) return true;
    const distance = el.scrollHeight - (el.scrollTop + el.clientHeight);
    return distance <= NEAR_BOTTOM_PX;
  }, []);

  const handleScroll = useCallback(() => {
    atBottomRef.current = isNearBottom();
  }, [isNearBottom]);

  const scrollToBottom = useCallback((smooth = true) => {
    bottomRef.current?.scrollIntoView({
      behavior: smooth ? "smooth" : "auto",
      block: "end",
    });
  }, []);

  // 1) On first mount -> jump to bottom
  useEffect(() => {
    scrollToBottom(false);
    // initialize bottom state
    atBottomRef.current = true;
  }, [scrollToBottom]);

  // 2) On contact change -> jump to bottom after DOM paints
  useEffect(() => {
    const t = setTimeout(() => scrollToBottom(false), 0);
    return () => clearTimeout(t);
  }, [selectedContactId, scrollToBottom]);

  // 3) On new messages -> only scroll if already near bottom
  useEffect(() => {
    if (atBottomRef.current) scrollToBottom(true);
  }, [messages.length, scrollToBottom]);

  // 4) Allow imperative force scroll (e.g., right after Send)
  useEffect(() => {
    const onForce = () => scrollToBottom(true);
    window.addEventListener("xbc:scrollToBottom", onForce);
    return () => window.removeEventListener("xbc:scrollToBottom", onForce);
  }, [scrollToBottom]);

  // 5) Gentle auto mark-as-read shortly after switching
  useEffect(() => {
    if (!connection || !selectedContactId) return;
    const timeout = setTimeout(() => {
      connection.invoke("MarkAsRead", selectedContactId).catch(err => {
        console.warn("‚ö†Ô∏è MarkAsRead SignalR call failed:", err);
      });
    }, 800);
    return () => clearTimeout(timeout);
  }, [connection, selectedContactId]);

  if (messages.length === 0) {
    return (
      <div className="flex-1 flex items-center justify-center text-gray-400">
        Loading messages‚Ä¶
      </div>
    );
  }

  // Group by date
  const grouped = messages.reduce((acc, msg) => {
    const dateKey = getDateLabel(msg.sentAt || msg.createdAt);
    (acc[dateKey] ||= []).push(msg);
    return acc;
  }, {});

  return (
    <div
      ref={scrollContainerRef}
      onScroll={handleScroll}
      className="p-4 space-y-6 overflow-y-auto h-full"
    >
      {Object.entries(grouped).map(([date, msgs]) => (
        <div key={date}>
          <div className="text-center text-xs text-gray-500 mb-2">{date}</div>
          <div className="space-y-1">
            {msgs.map((msg, idx) => (
              <ChatBubble
                key={msg.id || idx}
                message={msg}
                isOwn={!msg.isIncoming}
              />
            ))}
          </div>
        </div>
      ))}
      <div ref={bottomRef} />
    </div>
  );
}

// import React, { useRef, useEffect } from "react";
// import { useInbox } from "../InboxContext";
// import ChatBubble from "./ChatBubble";
// import dayjs from "dayjs";
// import isToday from "dayjs/plugin/isToday";
// import isYesterday from "dayjs/plugin/isYesterday";

// dayjs.extend(isToday);
// dayjs.extend(isYesterday);

// function getDateLabel(date) {
//   const d = dayjs(date);
//   if (d.isToday()) return "Today";
//   if (d.isYesterday()) return "Yesterday";
//   return d.format("D MMM YYYY");
// }

// export default function ChatWindow() {
//   const { messages, connection, selectedContactId } = useInbox();
//   const bottomRef = useRef(null);
//   const scrollContainerRef = useRef(null);

//   // Smart scrolling
//   useEffect(() => {
//     if (!scrollContainerRef.current) return;
//     const { scrollHeight, scrollTop, clientHeight } =
//       scrollContainerRef.current;
//     if (scrollHeight - scrollTop <= clientHeight + 100) {
//       bottomRef.current?.scrollIntoView({ behavior: "smooth" });
//     }
//   }, [messages]);

//   // Mark messages as read
//   useEffect(() => {
//     if (!connection || !selectedContactId) return;
//     const timeout = setTimeout(() => {
//       connection.invoke("MarkAsRead", selectedContactId).catch(err => {
//         console.warn("‚ö†Ô∏è MarkAsRead SignalR call failed:", err);
//       });
//     }, 800);
//     return () => clearTimeout(timeout);
//   }, [connection, selectedContactId]);

//   if (messages.length === 0) {
//     return (
//       <div className="flex-1 flex items-center justify-center text-gray-400">
//         Loading messages...
//       </div>
//     );
//   }

//   const grouped = messages.reduce((acc, msg) => {
//     const dateKey = getDateLabel(msg.sentAt || msg.createdAt);
//     if (!acc[dateKey]) acc[dateKey] = [];
//     acc[dateKey].push(msg);
//     return acc;
//   }, {});

//   return (
//     <div
//       ref={scrollContainerRef}
//       className="p-4 space-y-6 overflow-y-auto h-full"
//     >
//       {Object.entries(grouped).map(([date, msgs]) => (
//         <div key={date}>
//           <div className="text-center text-xs text-gray-500 mb-2">{date}</div>
//           <div className="space-y-1">
//             {msgs.map((msg, idx) => (
//               <ChatBubble
//                 key={msg.id || idx}
//                 message={msg}
//                 isOwn={!msg.isIncoming}
//               />
//             ))}
//           </div>
//         </div>
//       ))}
//       <div ref={bottomRef} />
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\components\ContactSidebar.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../../api/axiosClient";
// Removed Edit2 as it was unused
import { Info, StickyNote } from "lucide-react";
import dayjs from "dayjs";
import relativeTime from "dayjs/plugin/relativeTime";
dayjs.extend(relativeTime);

export default function ContactSidebar({ contactId }) {
  const [contact, setContact] = useState(null);
  const [newNote, setNewNote] = useState("");
  const [activeTab, setActiveTab] = useState("details");

  // üü£ LOG: Incoming contactId
  useEffect(() => {
    console.log("[ContactSidebar] Rendered with contactId:", contactId);
  }, [contactId]);

  useEffect(() => {
    if (!contactId) {
      console.warn("[ContactSidebar] No contactId provided");
      return;
    }

    const fetchContact = async () => {
      try {
        console.log("[ContactSidebar] Fetching contact:", contactId);
        const res = await axiosClient.get(`/contacts/${contactId}`);
        console.log("[ContactSidebar] API response:", res);

        // üü£ Some APIs wrap data in a .data.data shape!
        if (res?.data?.data) {
          setContact(res.data.data);
          console.log("[ContactSidebar] Set contact with res.data.data");
        } else if (res?.data) {
          setContact(res.data);
          console.log("[ContactSidebar] Set contact with res.data");
        } else {
          setContact(res);
          console.log("[ContactSidebar] Set contact with res");
        }
      } catch (err) {
        console.error("‚ùå [ContactSidebar] Failed to load contact:", err);
      }
    };

    fetchContact();
  }, [contactId]);

  const handleAddNote = async () => {
    if (!newNote.trim()) return;

    try {
      console.log(
        "[ContactSidebar] Adding note for contactId:",
        contactId,
        newNote
      );
      await axiosClient.post(`/notes`, {
        contactId,
        content: newNote,
      });
      setNewNote("");
      // Refetch after adding note
      const updated = await axiosClient.get(`/contacts/${contactId}`);
      if (updated?.data?.data) {
        setContact(updated.data.data);
      } else if (updated?.data) {
        setContact(updated.data);
      } else {
        setContact(updated);
      }
    } catch (err) {
      console.error("‚ùå [ContactSidebar] Failed to add note:", err);
    }
  };

  // üü£ LOG: Current contact state
  useEffect(() => {
    console.log("[ContactSidebar] Current contact state:", contact);
  }, [contact]);

  if (!contact) return <div className="p-4 text-gray-500">Loading...</div>;

  const {
    createdAt,
    tags = [],
    notes = [],
    list = "Default",
    chatWindowStatus = "Open",
    sessionStatus = "Active",
  } = contact;

  return (
    <div
      className="p-4 text-sm overflow-y-auto"
      style={{ height: "100%", maxHeight: "100%" }}
    >
      {/* üß± Tab Switcher */}
      <div className="flex mb-4 border rounded-md overflow-hidden text-sm">
        <button
          onClick={() => setActiveTab("details")}
          className={`flex-1 px-3 py-2 flex items-center justify-center gap-1 ${
            activeTab === "details"
              ? "bg-gray-200 font-semibold"
              : "bg-gray-100 hover:bg-gray-200"
          }`}
        >
          <Info size={14} /> Details
        </button>
        <button
          onClick={() => setActiveTab("notes")}
          className={`flex-1 px-3 py-2 flex items-center justify-center gap-1 ${
            activeTab === "notes"
              ? "bg-gray-200 font-semibold"
              : "bg-gray-100 hover:bg-gray-200"
          }`}
        >
          <StickyNote size={14} /> Notes
        </button>
      </div>

      {/* üìÑ Details Tab */}
      {activeTab === "details" && (
        <div className="space-y-4">
          <div className="bg-gray-50 border rounded-md p-3">
            <h4 className="text-xs font-semibold text-gray-700 mb-1">
              Conversation
            </h4>
            <div className="flex justify-between text-xs text-gray-600">
              <span>24-hour window:</span>
              <span className="text-green-600 font-medium">
                {chatWindowStatus}
              </span>
            </div>
            <div className="flex justify-between text-xs text-gray-600">
              <span>Chat session:</span>
              <span className="text-green-600 font-medium">
                {sessionStatus}
              </span>
            </div>
            <div className="flex justify-between text-xs text-gray-600">
              <span>Window ends:</span>
              <span>‚Äî</span>
            </div>
          </div>

          <div>
            <h4 className="text-xs font-semibold text-gray-700 mb-1">
              Contact data
            </h4>
            <div className="text-xs text-gray-600">
              Created: {createdAt?.slice(0, 10)}
            </div>
            <div className="text-xs text-gray-600">List: {list}</div>
          </div>

          <div>
            <h4 className="text-xs font-semibold text-gray-700 mb-1">Tags</h4>
            {tags.length === 0 ? (
              <div className="text-gray-400 italic text-xs">No tags</div>
            ) : (
              <div className="flex flex-wrap gap-2">
                {tags.map(tag => (
                  <span
                    key={tag.id}
                    className="text-xs font-medium px-2 py-1 rounded-full"
                    style={{
                      backgroundColor: tag.colorHex || "#999",
                      color:
                        tag.colorHex && tag.colorHex.toLowerCase() === "#ffffe0"
                          ? "#000"
                          : "#fff",
                    }}
                  >
                    {tag.name}
                  </span>
                ))}
              </div>
            )}
          </div>
        </div>
      )}

      {/* üìù Notes Tab */}
      {activeTab === "notes" && (
        <div className="space-y-3">
          <div className="flex gap-2">
            <input
              className="flex-1 px-2 py-1 text-xs border rounded-md"
              placeholder="Add note..."
              value={newNote}
              onChange={e => setNewNote(e.target.value)}
            />
            <button
              onClick={handleAddNote}
              className="bg-blue-600 text-white text-xs px-3 py-1 rounded-md hover:bg-blue-700"
            >
              Add
            </button>
          </div>

          {Array.isArray(notes) && notes.length > 0 ? (
            <div className="space-y-2 max-h-40 overflow-y-auto">
              {notes.map(n => (
                <div
                  key={n.id}
                  className="text-xs text-gray-700 bg-gray-100 rounded-md px-2 py-1"
                >
                  <div>{n.content}</div>
                  <div className="text-[10px] text-gray-400 mt-1">
                    {dayjs(n.createdAt).fromNow()}
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div className="text-gray-400 italic text-xs">No notes yet</div>
          )}
        </div>
      )}
    </div>
  );
}

// import React, { useEffect, useState } from "react";
// import axiosClient from "../../../api/axiosClient";
// import { Edit2, Info, StickyNote } from "lucide-react";
// import dayjs from "dayjs";
// import relativeTime from "dayjs/plugin/relativeTime";
// dayjs.extend(relativeTime);

// export default function ContactSidebar({ contactId }) {
//   const [contact, setContact] = useState(null);
//   const [newNote, setNewNote] = useState("");
//   const [activeTab, setActiveTab] = useState("details");

//   // üü£ LOG: Incoming contactId
//   useEffect(() => {
//     console.log("[ContactSidebar] Rendered with contactId:", contactId);
//   }, [contactId]);

//   useEffect(() => {
//     if (!contactId) {
//       console.warn("[ContactSidebar] No contactId provided");
//       return;
//     }

//     const fetchContact = async () => {
//       try {
//         console.log("[ContactSidebar] Fetching contact:", contactId);
//         const res = await axiosClient.get(`/contacts/${contactId}`);
//         console.log("[ContactSidebar] API response:", res);

//         // üü£ Some APIs wrap data in a .data.data shape!
//         if (res?.data?.data) {
//           setContact(res.data.data);
//           console.log("[ContactSidebar] Set contact with res.data.data");
//         } else if (res?.data) {
//           setContact(res.data);
//           console.log("[ContactSidebar] Set contact with res.data");
//         } else {
//           setContact(res);
//           console.log("[ContactSidebar] Set contact with res");
//         }
//       } catch (err) {
//         console.error("‚ùå [ContactSidebar] Failed to load contact:", err);
//       }
//     };

//     fetchContact();
//   }, [contactId]);

//   const handleAddNote = async () => {
//     if (!newNote.trim()) return;

//     try {
//       console.log(
//         "[ContactSidebar] Adding note for contactId:",
//         contactId,
//         newNote
//       );
//       await axiosClient.post(`/notes`, {
//         contactId,
//         content: newNote,
//       });
//       setNewNote("");
//       // Refetch after adding note
//       const updated = await axiosClient.get(`/contacts/${contactId}`);
//       if (updated?.data?.data) {
//         setContact(updated.data.data);
//       } else if (updated?.data) {
//         setContact(updated.data);
//       } else {
//         setContact(updated);
//       }
//     } catch (err) {
//       console.error("‚ùå [ContactSidebar] Failed to add note:", err);
//     }
//   };

//   // üü£ LOG: Current contact state
//   useEffect(() => {
//     console.log("[ContactSidebar] Current contact state:", contact);
//   }, [contact]);

//   if (!contact) return <div className="p-4 text-gray-500">Loading...</div>;

//   const {
//     name,
//     phoneNumber,
//     createdAt,
//     tags = [],
//     notes = [],
//     list = "Default",
//     chatWindowStatus = "Open",
//     sessionStatus = "Active",
//   } = contact;

//   const initials = name
//     ?.split(" ")
//     .map(n => n[0])
//     .join("")
//     .substring(0, 2)
//     .toUpperCase();

//   return (
//     <div className="p-4 text-sm overflow-y-auto h-full">
//       {/* üîπ Top Header */}
//       <div className="flex items-center gap-4 mb-4">
//         <div className="w-10 h-10 rounded-full bg-green-600 text-white flex items-center justify-center font-semibold text-sm">
//           {initials}
//         </div>
//         <div>
//           <h2 className="font-semibold text-gray-800 flex items-center gap-2">
//             {name}
//             {sessionStatus === "Active" && (
//               <span
//                 className="ml-1 inline-block w-2 h-2 rounded-full bg-green-500 animate-pulse"
//                 title="Active session"
//               ></span>
//             )}
//           </h2>
//           <div className="text-xs text-gray-500">{phoneNumber}</div>
//         </div>
//       </div>

//       {/* üß± Tab Switcher */}
//       <div className="flex mb-4 border rounded-md overflow-hidden text-sm">
//         <button
//           onClick={() => setActiveTab("details")}
//           className={`flex-1 px-3 py-2 flex items-center justify-center gap-1 ${
//             activeTab === "details"
//               ? "bg-gray-200 font-semibold"
//               : "bg-gray-100 hover:bg-gray-200"
//           }`}
//         >
//           <Info size={14} /> Details
//         </button>
//         <button
//           onClick={() => setActiveTab("notes")}
//           className={`flex-1 px-3 py-2 flex items-center justify-center gap-1 ${
//             activeTab === "notes"
//               ? "bg-gray-200 font-semibold"
//               : "bg-gray-100 hover:bg-gray-200"
//           }`}
//         >
//           <StickyNote size={14} /> Notes
//         </button>
//       </div>

//       {/* üìÑ Details Tab */}
//       {activeTab === "details" && (
//         <div className="space-y-4">
//           <div className="bg-gray-50 border rounded-md p-3">
//             <h4 className="text-xs font-semibold text-gray-700 mb-1">
//               Conversation
//             </h4>
//             <div className="flex justify-between text-xs text-gray-600">
//               <span>24-hour window:</span>
//               <span className="text-green-600 font-medium">
//                 {chatWindowStatus}
//               </span>
//             </div>
//             <div className="flex justify-between text-xs text-gray-600">
//               <span>Chat session:</span>
//               <span className="text-green-600 font-medium">
//                 {sessionStatus}
//               </span>
//             </div>
//             <div className="flex justify-between text-xs text-gray-600">
//               <span>Window ends:</span>
//               <span>‚Äî</span>
//             </div>
//           </div>

//           <div>
//             <h4 className="text-xs font-semibold text-gray-700 mb-1">
//               Contact data
//             </h4>
//             <div className="text-xs text-gray-600">
//               Created: {createdAt?.slice(0, 10)}
//             </div>
//             <div className="text-xs text-gray-600">List: {list}</div>
//           </div>

//           <div>
//             <h4 className="text-xs font-semibold text-gray-700 mb-1">Tags</h4>
//             {tags.length === 0 ? (
//               <div className="text-gray-400 italic text-xs">No tags</div>
//             ) : (
//               <div className="flex flex-wrap gap-2">
//                 {tags.map(tag => (
//                   <span
//                     key={tag.id}
//                     className="text-xs font-medium px-2 py-1 rounded-full"
//                     style={{
//                       backgroundColor: tag.colorHex || "#999",
//                       color:
//                         tag.colorHex && tag.colorHex.toLowerCase() === "#ffffe0"
//                           ? "#000"
//                           : "#fff",
//                     }}
//                   >
//                     {tag.name}
//                   </span>
//                 ))}
//               </div>
//             )}
//           </div>
//         </div>
//       )}

//       {/* üìù Notes Tab */}
//       {activeTab === "notes" && (
//         <div className="space-y-3">
//           <div className="flex gap-2">
//             <input
//               className="flex-1 px-2 py-1 text-xs border rounded-md"
//               placeholder="Add note..."
//               value={newNote}
//               onChange={e => setNewNote(e.target.value)}
//             />
//             <button
//               onClick={handleAddNote}
//               className="bg-blue-600 text-white text-xs px-3 py-1 rounded-md hover:bg-blue-700"
//             >
//               Add
//             </button>
//           </div>

//           {Array.isArray(notes) && notes.length > 0 ? (
//             <div className="space-y-2 max-h-40 overflow-y-auto">
//               {notes.map(n => (
//                 <div
//                   key={n.id}
//                   className="text-xs text-gray-700 bg-gray-100 rounded-md px-2 py-1"
//                 >
//                   <div>{n.content}</div>
//                   <div className="text-[10px] text-gray-400 mt-1">
//                     {dayjs(n.createdAt).fromNow()}
//                   </div>
//                 </div>
//               ))}
//             </div>
//           ) : (
//             <div className="text-gray-400 italic text-xs">No notes yet</div>
//           )}
//         </div>
//       )}
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\components\EmojiPicker.jsx 
====================================================== 
 
import React, { useEffect, useMemo, useRef, useState } from "react";

// Lightweight emoji set (common, chat-friendly)
const RAW = [
  ["üòÄ", "grinning"],
  ["üòÅ", "beaming"],
  ["üòÇ", "joy"],
  ["ü§£", "rofl"],
  ["üòä", "smile"],
  ["üôÇ", "slight_smile"],
  ["üòâ", "wink"],
  ["üòç", "heart_eyes"],
  ["üòò", "kiss"],
  ["üòã", "yum"],
  ["üòé", "cool"],
  ["ü§©", "star_struck"],
  ["ü•≥", "partying"],
  ["üòá", "innocent"],
  ["ü§ó", "hug"],
  ["üòÖ", "sweat_smile"],
  ["üòå", "relieved"],
  ["üò¥", "sleep"],
  ["ü§î", "think"],
  ["ü§®", "doubt"],
  ["üòê", "neutral"],
  ["üòÆ", "open_mouth"],
  ["üò¢", "cry"],
  ["üò≠", "sob"],
  ["üò°", "angry"],
  ["üò±", "scream"],
  ["ü§Ø", "mind_blown"],
  ["ü§í", "sick"],
  ["ü§ï", "injured"],
  ["ü§ß", "sneeze"],
  ["ü•∂", "cold"],
  ["ü•µ", "hot"],
  ["üëç", "thumbs_up"],
  ["üëé", "thumbs_down"],
  ["üôè", "pray"],
  ["üëè", "clap"],
  ["üôå", "raised_hands"],
  ["ü§ù", "handshake"],
  ["üí™", "muscle"],
  ["ü´∂", "heart_hands"],
  ["‚ù§Ô∏è", "red_heart"],
  ["üíõ", "yellow_heart"],
  ["üíö", "green_heart"],
  ["üíô", "blue_heart"],
  ["üíú", "purple_heart"],
  ["üñ§", "black_heart"],
  ["üíî", "broken_heart"],
  ["‚ú®", "sparkles"],
  ["üî•", "fire"],
  ["‚≠ê", "star"],
  ["‚úÖ", "check"],
  ["‚ùå", "cross"],
  ["‚ö†Ô∏è", "warning"],
  ["‚è≥", "hourglass"],
  ["üìå", "pin"],
  ["üìç", "round_pushpin"],
  ["üìÖ", "calendar"],
  ["üõçÔ∏è", "shopping"],
  ["üí∞", "money"],
  ["üéâ", "tada"],
  ["üéä", "confetti"],
  ["üí¨", "speech"],
  ["‚úâÔ∏è", "envelope"],
  ["üì±", "phone"],
  ["üìû", "telephone"],
  ["‚è∞", "alarm"],
  ["‚åõ", "timer"],
  ["üßæ", "receipt"],
  ["üß∞", "tools"],
  ["üß†", "brain"],
];

const EMOJIS = RAW.map(([char, name]) => ({ char, name }));

export default function EmojiPicker({ onPick, onClose }) {
  const ref = useRef(null);
  const [q, setQ] = useState("");

  // Close on outside click
  useEffect(() => {
    const onDocClick = e => {
      if (!ref.current) return;
      if (!ref.current.contains(e.target)) onClose?.();
    };
    document.addEventListener("mousedown", onDocClick, { capture: true });
    return () =>
      document.removeEventListener("mousedown", onDocClick, { capture: true });
  }, [onClose]);

  const filtered = useMemo(() => {
    const s = q.trim().toLowerCase();
    if (!s) return EMOJIS;
    return EMOJIS.filter(e => e.char.includes(s) || e.name.includes(s));
  }, [q]);

  return (
    <div
      ref={ref}
      className="w-80 rounded-xl border bg-white shadow-lg p-2"
      role="dialog"
      aria-label="Emoji picker"
    >
      <div className="flex items-center gap-2 mb-2">
        <input
          autoFocus
          className="flex-1 border rounded-md px-2 py-1 text-sm"
          placeholder="Search emoji‚Ä¶"
          value={q}
          onChange={e => setQ(e.target.value)}
          onKeyDown={e => {
            if (e.key === "Escape") onClose?.();
          }}
        />
        <button
          className="text-xs text-gray-500 hover:text-gray-700 px-2 py-1"
          onClick={() => onClose?.()}
          type="button"
        >
          Close
        </button>
      </div>

      {/* No scrollbar: wider + more columns + slightly smaller buttons */}
      <div className="grid grid-cols-10 gap-1 overflow-y-hidden">
        {filtered.map(e => (
          <button
            key={e.char + e.name}
            type="button"
            className="h-7 w-7 flex items-center justify-center rounded hover:bg-gray-100"
            title={e.name.replace(/_/g, " ")}
            onClick={() => onPick?.(e.char)}
          >
            <span className="text-lg">{e.char}</span>
          </button>
        ))}
      </div>

      {/* <div className="mt-2 text-[10px] text-gray-400 px-1">
        Tip: you can also use your OS emoji panel (Win + .) / (‚åò Ctrl Space)
      </div> */}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\components\InboxSidebar.jsx 
====================================================== 
 
// ‚úÖ Final Updated InboxSidebar.jsx (auto-mark-read + refresh + sound on new unread)
import React, { useEffect, useState, useCallback } from "react";
import axiosClient from "../../../api/axiosClient";
import useSignalR from "../../../hooks/useSignalR";
import useNotificationSound from "../../../hooks/useNotificationSound"; // ‚¨ÖÔ∏è NEW

export default function InboxSidebar({ onSelect, currentUserId }) {
  const [contacts, setContacts] = useState([]);
  const [selectedId, setSelectedId] = useState(null);
  const [unreadCounts, setUnreadCounts] = useState({});
  const [search, setSearch] = useState("");
  const { connection } = useSignalR();

  // üîî Sound (autoplay-safe + throttled; uses /sounds/inbox_notify.mp3 by default)
  const { play } = useNotificationSound({
    // src: "/sounds/inbox_notify.mp3", // optional (default already this)
    volume: 0.6,
    throttleMs: 800,
  });

  const fetchUnreadCounts = useCallback(async () => {
    try {
      const res = await axiosClient.get("/inbox/unread-counts");
      setUnreadCounts(res.data || {});
      console.log("‚úÖ Unread counts refreshed");
    } catch (err) {
      console.error("‚ùå Failed to refresh unread counts:", err);
    }
  }, []);

  const loadContactsAndUnread = useCallback(async () => {
    try {
      const [contactRes, countRes] = await Promise.all([
        axiosClient.get("/contacts/all"),
        axiosClient.get("/inbox/unread-counts"),
      ]);
      setContacts(contactRes.data || []);
      setUnreadCounts(countRes.data || {});
      console.log("‚úÖ Contacts and unread counts loaded");
    } catch (err) {
      console.error("‚ùå Failed to load inbox data:", err);
    }
  }, []);

  useEffect(() => {
    console.log("üì• InboxSidebar mounted | currentUserId:", currentUserId);
    loadContactsAndUnread();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [currentUserId]);

  useEffect(() => {
    if (!connection) return;

    const handleUnread = payload => {
      console.log("üîî [SignalR] UnreadCountChanged:", payload);

      // server says "refresh your snapshot"
      if (payload && typeof payload === "object" && payload.refresh) {
        fetchUnreadCounts();
        return;
      }

      if (payload && typeof payload === "object") {
        setUnreadCounts(payload);
      }
    };

    connection.on("UnreadCountChanged", handleUnread);
    return () => connection.off("UnreadCountChanged", handleUnread);
  }, [connection, fetchUnreadCounts]);

  useEffect(() => {
    if (!connection) return;

    const handleMessage = async msg => {
      const cid = msg?.contactId ?? msg?.ContactId ?? null;
      if (!cid) return;

      const isIncoming =
        typeof msg?.isIncoming !== "undefined"
          ? !!msg.isIncoming
          : msg?.senderId
          ? false
          : true;

      console.log(
        "üì© [SignalR] Message:",
        msg,
        "| parsed contactId:",
        cid,
        "| isIncoming:",
        isIncoming
      );

      // Never badge on ANY outbound message
      if (!isIncoming) return;

      // If the active chat ‚Üí mark as read immediately
      if (String(cid) === String(selectedId)) {
        try {
          if (connection?.invoke) {
            await connection.invoke("MarkAsRead", cid);
            console.log("‚úÖ MarkAsRead via SignalR for", cid);
          } else {
            await axiosClient.post(`/inbox/mark-read?contactId=${cid}`);
            console.log("‚úÖ MarkAsRead fallback HTTP for", cid);
          }
        } catch (err) {
          console.error("‚ùå Failed to mark as read in active chat:", err);
        }
        return; // do not increment badge or play sound
      }

      // Otherwise, increment unread count for that contact
      setUnreadCounts(prev => ({
        ...(prev || {}),
        [cid]: (prev?.[cid] || 0) + 1,
      }));

      // üîî Play sound only when a new unread is created (non-active chat)
      try {
        play();
      } catch {}
    };

    connection.on("ReceiveInboxMessage", handleMessage);
    return () => connection.off("ReceiveInboxMessage", handleMessage);
  }, [connection, selectedId, currentUserId, play]); // include play in deps

  useEffect(() => {
    if (!connection) return;
    if (typeof connection.onreconnected === "function") {
      connection.onreconnected(() => {
        console.log("üîÅ SignalR reconnected ‚Äî reloading unread counts");
        loadContactsAndUnread();
      });
    }
  }, [connection, loadContactsAndUnread]);

  const handleSelect = async id => {
    setSelectedId(id);
    onSelect(id);

    // Optimistic reset
    setUnreadCounts(prev => ({ ...(prev || {}), [id]: 0 }));

    try {
      if (connection?.invoke) {
        await connection.invoke("MarkAsRead", id);
        console.log("‚úÖ MarkAsRead via SignalR for", id);
        return;
      }
    } catch (err) {
      console.warn("‚ö†Ô∏è SignalR MarkAsRead failed, fallback:", err);
    }

    try {
      await axiosClient.post(`/inbox/mark-read?contactId=${id}`);
      console.log("‚úÖ MarkAsRead fallback HTTP for", id);
    } catch (err) {
      console.error("‚ùå Failed to mark as read via HTTP:", err);
    }
  };

  const getInitials = name =>
    name
      ?.split(" ")
      .map(n => n[0])
      .join("")
      .substring(0, 2)
      .toUpperCase();

  const safeContacts = Array.isArray(contacts) ? contacts : [];
  const filtered = safeContacts.filter(c =>
    (c.name || c.phoneNumber || "")
      .toString()
      .toLowerCase()
      .includes(search.toLowerCase())
  );

  return (
    <div className="flex flex-col h-full">
      <div className="p-3 border-b">
        <input
          type="text"
          placeholder="Search"
          className="w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring"
          value={search}
          onChange={e => setSearch(e.target.value)}
        />
      </div>

      <div className="flex-1 overflow-y-auto">
        <div className="text-sm font-semibold text-gray-700 px-4 py-2">
          Contacts
        </div>
        {filtered.map(contact => {
          const cid = String(contact.id);
          const unread = Number(unreadCounts[cid] || 0);
          return (
            <div
              key={contact.id}
              onClick={() => handleSelect(contact.id)}
              className={`flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-gray-100 ${
                selectedId === contact.id ? "bg-gray-200" : ""
              }`}
            >
              <div className="flex items-center gap-3">
                <div className="w-9 h-9 rounded-full bg-purple-600 text-xs font-semibold flex items-center justify-center text-white">
                  {getInitials(contact.name || contact.phoneNumber)}
                </div>
                <div className="flex flex-col">
                  <div className="font-medium text-sm text-gray-800 truncate">
                    {contact.name || contact.phoneNumber || "Unknown"}
                  </div>
                  {contact.name && (
                    <div className="text-xs text-gray-500">
                      {contact.phoneNumber}
                    </div>
                  )}
                </div>
              </div>
              {unread > 0 && (
                <div className="text-xs bg-purple-600 text-white px-2 py-0.5 rounded-full min-w-[20px] text-center">
                  {unread}
                </div>
              )}
            </div>
          );
        })}
      </div>
    </div>
  );
}

// // ‚úÖ Final Updated InboxSidebar.jsx (active chat auto-mark-read + refresh support)
// import React, { useEffect, useState, useCallback } from "react";
// import axiosClient from "../../../api/axiosClient";
// import useSignalR from "../../../hooks/useSignalR";

// export default function InboxSidebar({ onSelect, currentUserId }) {
//   const [contacts, setContacts] = useState([]);
//   const [selectedId, setSelectedId] = useState(null);
//   const [unreadCounts, setUnreadCounts] = useState({});
//   const [search, setSearch] = useState("");
//   const { connection } = useSignalR();

//   const fetchUnreadCounts = useCallback(async () => {
//     try {
//       const res = await axiosClient.get("/inbox/unread-counts");
//       setUnreadCounts(res.data || {});
//       console.log("‚úÖ Unread counts refreshed");
//     } catch (err) {
//       console.error("‚ùå Failed to refresh unread counts:", err);
//     }
//   }, []);

//   const loadContactsAndUnread = useCallback(async () => {
//     try {
//       const [contactRes, countRes] = await Promise.all([
//         axiosClient.get("/contacts/all"),
//         axiosClient.get("/inbox/unread-counts"),
//       ]);
//       setContacts(contactRes.data || []);
//       setUnreadCounts(countRes.data || {});
//       console.log("‚úÖ Contacts and unread counts loaded");
//     } catch (err) {
//       console.error("‚ùå Failed to load inbox data:", err);
//     }
//   }, []);

//   useEffect(() => {
//     console.log("üì• InboxSidebar mounted | currentUserId:", currentUserId);
//     loadContactsAndUnread();
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, [currentUserId]);

//   useEffect(() => {
//     if (!connection) return;

//     const handleUnread = payload => {
//       console.log("üîî [SignalR] UnreadCountChanged:", payload);

//       // server says "refresh your snapshot"
//       if (payload && typeof payload === "object" && payload.refresh) {
//         fetchUnreadCounts();
//         return;
//       }

//       if (payload && typeof payload === "object") {
//         setUnreadCounts(payload);
//       }
//     };

//     connection.on("UnreadCountChanged", handleUnread);
//     return () => connection.off("UnreadCountChanged", handleUnread);
//   }, [connection, fetchUnreadCounts]);

//   useEffect(() => {
//     if (!connection) return;

//     const handleMessage = async msg => {
//       const cid = msg?.contactId ?? msg?.ContactId ?? null;
//       if (!cid) return;

//       const isIncoming =
//         typeof msg?.isIncoming !== "undefined"
//           ? !!msg.isIncoming
//           : msg?.senderId
//           ? false
//           : true;

//       console.log(
//         "üì© [SignalR] Message:",
//         msg,
//         "| parsed contactId:",
//         cid,
//         "| isIncoming:",
//         isIncoming
//       );

//       // Never badge on ANY outbound message
//       if (!isIncoming) return;

//       // If the active chat ‚Üí mark as read immediately
//       if (String(cid) === String(selectedId)) {
//         try {
//           if (connection?.invoke) {
//             await connection.invoke("MarkAsRead", cid);
//             console.log("‚úÖ MarkAsRead via SignalR for", cid);
//           } else {
//             await axiosClient.post(`/inbox/mark-read?contactId=${cid}`);
//             console.log("‚úÖ MarkAsRead fallback HTTP for", cid);
//           }
//         } catch (err) {
//           console.error("‚ùå Failed to mark as read in active chat:", err);
//         }
//         return; // do not increment badge
//       }

//       // Otherwise, increment unread count for that contact
//       setUnreadCounts(prev => ({
//         ...(prev || {}),
//         [cid]: (prev?.[cid] || 0) + 1,
//       }));
//     };

//     connection.on("ReceiveInboxMessage", handleMessage);
//     return () => connection.off("ReceiveInboxMessage", handleMessage);
//   }, [connection, selectedId, currentUserId]);

//   useEffect(() => {
//     if (!connection) return;
//     if (typeof connection.onreconnected === "function") {
//       connection.onreconnected(() => {
//         console.log("üîÅ SignalR reconnected ‚Äî reloading unread counts");
//         loadContactsAndUnread();
//       });
//     }
//   }, [connection, loadContactsAndUnread]);

//   const handleSelect = async id => {
//     setSelectedId(id);
//     onSelect(id);

//     // Optimistic reset
//     setUnreadCounts(prev => ({ ...(prev || {}), [id]: 0 }));

//     try {
//       if (connection?.invoke) {
//         await connection.invoke("MarkAsRead", id);
//         console.log("‚úÖ MarkAsRead via SignalR for", id);
//         return;
//       }
//     } catch (err) {
//       console.warn("‚ö†Ô∏è SignalR MarkAsRead failed, fallback:", err);
//     }

//     try {
//       await axiosClient.post(`/inbox/mark-read?contactId=${id}`);
//       console.log("‚úÖ MarkAsRead fallback HTTP for", id);
//     } catch (err) {
//       console.error("‚ùå Failed to mark as read via HTTP:", err);
//     }
//   };

//   const getInitials = name =>
//     name
//       ?.split(" ")
//       .map(n => n[0])
//       .join("")
//       .substring(0, 2)
//       .toUpperCase();

//   const safeContacts = Array.isArray(contacts) ? contacts : [];
//   const filtered = safeContacts.filter(c =>
//     (c.name || c.phoneNumber || "")
//       .toString()
//       .toLowerCase()
//       .includes(search.toLowerCase())
//   );

//   return (
//     <div className="w-72 h-full flex flex-col border-r bg-white">
//       <div className="p-3 border-b">
//         <input
//           type="text"
//           placeholder="Search"
//           className="w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring"
//           value={search}
//           onChange={e => setSearch(e.target.value)}
//         />
//       </div>

//       <div className="flex-1 overflow-y-auto">
//         <div className="text-sm font-semibold text-gray-700 px-4 py-2">
//           Contacts
//         </div>
//         {filtered.map(contact => {
//           const cid = String(contact.id);
//           const unread = Number(unreadCounts[cid] || 0);
//           return (
//             <div
//               key={contact.id}
//               onClick={() => handleSelect(contact.id)}
//               className={`flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-gray-100 ${
//                 selectedId === contact.id ? "bg-gray-200" : ""
//               }`}
//             >
//               <div className="flex items-center gap-3">
//                 <div className="w-9 h-9 rounded-full bg-purple-600 text-xs font-semibold flex items-center justify-center text-white">
//                   {getInitials(contact.name || contact.phoneNumber)}
//                 </div>
//                 <div className="flex flex-col">
//                   <div className="font-medium text-sm text-gray-800 truncate">
//                     {contact.name || contact.phoneNumber || "Unknown"}
//                   </div>
//                   {contact.name && (
//                     <div className="text-xs text-gray-500">
//                       {contact.phoneNumber}
//                     </div>
//                   )}
//                 </div>
//               </div>
//               {unread > 0 && (
//                 <div className="text-xs bg-purple-600 text-white px-2 py-0.5 rounded-full min-w-[20px] text-center">
//                   {unread}
//                 </div>
//               )}
//             </div>
//           );
//         })}
//       </div>
//     </div>
//   );
// }

// // ‚úÖ Final Updated InboxSidebar.jsx (active chat auto-mark-read + refresh support)
// import React, { useEffect, useState, useCallback } from "react";
// import axiosClient from "../../../api/axiosClient";
// import useSignalR from "../../../hooks/useSignalR";

// export default function InboxSidebar({ onSelect, currentUserId }) {
//   const [contacts, setContacts] = useState([]);
//   const [selectedId, setSelectedId] = useState(null);
//   const [unreadCounts, setUnreadCounts] = useState({});
//   const [search, setSearch] = useState("");
//   const { connection } = useSignalR();

//   // üîÑ Helper to fetch ONLY unread counts (used by refresh signal)
//   const fetchUnreadCounts = useCallback(async () => {
//     try {
//       const res = await axiosClient.get("/inbox/unread-counts");
//       setUnreadCounts(res.data || {});
//       console.log("‚úÖ Unread counts refreshed");
//     } catch (err) {
//       console.error("‚ùå Failed to refresh unread counts:", err);
//     }
//   }, []);

//   // üîÑ Helper to fetch contacts & unread counts (initial load / reconnect)
//   const loadContactsAndUnread = useCallback(async () => {
//     try {
//       const [contactRes, countRes] = await Promise.all([
//         axiosClient.get("/contacts/all"),
//         axiosClient.get("/inbox/unread-counts"),
//       ]);
//       setContacts(contactRes.data || []);
//       setUnreadCounts(countRes.data || {});
//       console.log("‚úÖ Contacts and unread counts loaded");
//     } catch (err) {
//       console.error("‚ùå Failed to load inbox data:", err);
//     }
//   }, []);

//   useEffect(() => {
//     console.log("üì• InboxSidebar mounted | currentUserId:", currentUserId);
//     loadContactsAndUnread();
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, [currentUserId]);

//   // üì° Listen for server "UnreadCountChanged"
//   useEffect(() => {
//     if (!connection) return;

//     const handleUnread = payload => {
//       console.log("üîî [SignalR] UnreadCountChanged:", payload);

//       // üö¶ Refresh signal from server: { refresh: true }
//       if (payload && typeof payload === "object" && payload.refresh) {
//         fetchUnreadCounts();
//         return;
//       }

//       // Otherwise, payload is a map { [contactId]: count }
//       if (payload && typeof payload === "object") {
//         setUnreadCounts(payload);
//       }
//     };

//     connection.on("UnreadCountChanged", handleUnread);
//     return () => connection.off("UnreadCountChanged", handleUnread);
//   }, [connection, fetchUnreadCounts]);

//   // üì° Listen for incoming messages
//   useEffect(() => {
//     if (!connection) return;

//     const handleMessage = async msg => {
//       const cid = msg?.contactId ?? msg?.ContactId ?? null;
//       if (!cid) return;

//       const isIncoming =
//         typeof msg?.isIncoming !== "undefined"
//           ? !!msg.isIncoming
//           : msg?.senderId
//           ? false
//           : true;

//       console.log(
//         "üì© [SignalR] Message:",
//         msg,
//         "| parsed contactId:",
//         cid,
//         "| isIncoming:",
//         isIncoming
//       );

//       // üîï Never badge on ANY outbound message (self or other agents)
//       if (!isIncoming) {
//         return;
//       }

//       // üü¢ If message is for the currently open chat ‚Üí mark as read immediately
//       if (String(cid) === String(selectedId)) {
//         console.log(
//           "üëÅÔ∏è Message received in active chat, marking as read immediately"
//         );

//         try {
//           if (connection?.invoke) {
//             await connection.invoke("MarkAsRead", cid);
//             console.log("‚úÖ MarkAsRead invoked via SignalR for", cid);
//           } else {
//             await axiosClient.post(`/inbox/mark-read?contactId=${cid}`);
//             console.log("‚úÖ MarkAsRead fallback HTTP for", cid);
//           }
//         } catch (err) {
//           console.error("‚ùå Failed to mark as read in active chat:", err);
//         }

//         return; // don't increment badge
//       }

//       // Otherwise, increment unread count for that contact
//       setUnreadCounts(prev => ({
//         ...(prev || {}),
//         [cid]: (prev?.[cid] || 0) + 1,
//       }));
//     };

//     connection.on("ReceiveInboxMessage", handleMessage);
//     return () => connection.off("ReceiveInboxMessage", handleMessage);
//   }, [connection, selectedId, currentUserId]);

//   // üîÅ Handle reconnects ‚Üí reload contacts + counts (covers missed events)
//   useEffect(() => {
//     if (!connection) return;
//     if (typeof connection.onreconnected === "function") {
//       connection.onreconnected(() => {
//         console.log("üîÅ SignalR reconnected ‚Äî reloading unread counts");
//         loadContactsAndUnread();
//       });
//     }
//   }, [connection, loadContactsAndUnread]);

//   // ‚úÖ Selecting a contact
//   const handleSelect = async id => {
//     setSelectedId(id);
//     onSelect(id);

//     // Optimistic reset
//     setUnreadCounts(prev => ({ ...(prev || {}), [id]: 0 }));

//     try {
//       if (connection?.invoke) {
//         await connection.invoke("MarkAsRead", id);
//         console.log("‚úÖ MarkAsRead invoked via SignalR for", id);
//         return;
//       }
//     } catch (err) {
//       console.warn("‚ö†Ô∏è SignalR MarkAsRead failed, fallback:", err);
//     }

//     try {
//       await axiosClient.post(`/inbox/mark-read?contactId=${id}`);
//       console.log("‚úÖ MarkAsRead fallback HTTP for", id);
//     } catch (err) {
//       console.error("‚ùå Failed to mark as read via HTTP:", err);
//     }
//   };

//   const getInitials = name =>
//     name
//       ?.split(" ")
//       .map(n => n[0])
//       .join("")
//       .substring(0, 2)
//       .toUpperCase();

//   const safeContacts = Array.isArray(contacts) ? contacts : [];
//   const filtered = safeContacts.filter(c =>
//     (c.name || c.phoneNumber || "")
//       .toString()
//       .toLowerCase()
//       .includes(search.toLowerCase())
//   );

//   return (
//     <div className="w-72 h-full flex flex-col border-r bg-white">
//       <div className="p-3 border-b">
//         <input
//           type="text"
//           placeholder="Search"
//           className="w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring"
//           value={search}
//           onChange={e => setSearch(e.target.value)}
//         />
//       </div>

//       <div className="flex-1 overflow-y-auto">
//         <div className="text-sm font-semibold text-gray-700 px-4 py-2">
//           Contacts
//         </div>
//         {filtered.map(contact => {
//           const cid = String(contact.id);
//           const unread = Number(unreadCounts[cid] || 0);
//           return (
//             <div
//               key={contact.id}
//               onClick={() => handleSelect(contact.id)}
//               className={`flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-gray-100 ${
//                 selectedId === contact.id ? "bg-gray-200" : ""
//               }`}
//             >
//               <div className="flex items-center gap-3">
//                 <div className="w-9 h-9 rounded-full bg-purple-600 text-xs font-semibold flex items-center justify-center text-white">
//                   {getInitials(contact.name || contact.phoneNumber)}
//                 </div>
//                 <div className="flex flex-col">
//                   <div className="font-medium text-sm text-gray-800 truncate">
//                     {contact.name || contact.phoneNumber || "Unknown"}
//                   </div>
//                   {contact.name && (
//                     <div className="text-xs text-gray-500">
//                       {contact.phoneNumber}
//                     </div>
//                   )}
//                 </div>
//               </div>
//               {unread > 0 && (
//                 <div className="text-xs bg-purple-600 text-white px-2 py-0.5 rounded-full min-w-[20px] text-center">
//                   {unread}
//                 </div>
//               )}
//             </div>
//           );
//         })}
//       </div>
//     </div>
//   );
// }

// // ‚úÖ Final Updated InboxSidebar.jsx (active chat auto-mark-read)
// import React, { useEffect, useState, useCallback } from "react";
// import axiosClient from "../../../api/axiosClient";
// import useSignalR from "../../../hooks/useSignalR";

// export default function InboxSidebar({ onSelect, currentUserId }) {
//   const [contacts, setContacts] = useState([]);
//   const [selectedId, setSelectedId] = useState(null);
//   const [unreadCounts, setUnreadCounts] = useState({});
//   const [search, setSearch] = useState("");
//   const { connection } = useSignalR();

//   // üîÑ Helper to fetch contacts & unread counts
//   const loadContactsAndUnread = useCallback(async () => {
//     try {
//       const [contactRes, countRes] = await Promise.all([
//         axiosClient.get("/contacts/all"),
//         axiosClient.get("/inbox/unread-counts"),
//       ]);
//       setContacts(contactRes.data || []);
//       setUnreadCounts(countRes.data || {});
//       console.log("‚úÖ Contacts and unread counts loaded");
//     } catch (err) {
//       console.error("‚ùå Failed to load inbox data:", err);
//     }
//   }, []);

//   useEffect(() => {
//     console.log("üì• InboxSidebar mounted | currentUserId:", currentUserId);
//     loadContactsAndUnread();
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, [currentUserId]);

//   // üì° Listen for server "UnreadCountChanged"
//   useEffect(() => {
//     if (!connection) return;

//     const handleUnread = payload => {
//       console.log("üîî [SignalR] UnreadCountChanged:", payload);
//       if (payload && typeof payload === "object") {
//         setUnreadCounts(payload);
//       }
//     };

//     connection.on("UnreadCountChanged", handleUnread);
//     return () => connection.off("UnreadCountChanged", handleUnread);
//   }, [connection]);

//   // üì° Listen for incoming messages
//   useEffect(() => {
//     if (!connection) return;

//     const handleMessage = async msg => {
//       const cid = msg?.contactId ?? msg?.ContactId ?? null;
//       if (!cid) return;

//       const isIncoming =
//         typeof msg?.isIncoming !== "undefined"
//           ? !!msg.isIncoming
//           : msg?.senderId
//           ? false
//           : true;

//       console.log(
//         "üì© [SignalR] Message:",
//         msg,
//         "| parsed contactId:",
//         cid,
//         "| isIncoming:",
//         isIncoming
//       );

//       // Skip self/outgoing messages
//       if (
//         !isIncoming &&
//         msg.senderId &&
//         String(msg.senderId) === String(currentUserId)
//       ) {
//         console.log("‚Ü©Ô∏è Skipping self-sent message");
//         return;
//       }

//       // üü¢ If message is for the currently open chat ‚Üí mark as read immediately
//       if (String(cid) === String(selectedId)) {
//         console.log(
//           "üëÅÔ∏è Message received in active chat, marking as read immediately"
//         );

//         try {
//           if (connection?.invoke) {
//             await connection.invoke("MarkAsRead", cid);
//             console.log("‚úÖ MarkAsRead invoked via SignalR for", cid);
//           } else {
//             await axiosClient.post(`/inbox/mark-read?contactId=${cid}`);
//             console.log("‚úÖ MarkAsRead fallback HTTP for", cid);
//           }
//         } catch (err) {
//           console.error("‚ùå Failed to mark as read in active chat:", err);
//         }

//         return; // don't increment badge
//       }

//       // Otherwise, increment unread count for that contact
//       setUnreadCounts(prev => ({
//         ...prev,
//         [cid]: (prev?.[cid] || 0) + 1,
//       }));
//     };

//     connection.on("ReceiveInboxMessage", handleMessage);
//     return () => connection.off("ReceiveInboxMessage", handleMessage);
//   }, [connection, selectedId, currentUserId]);

//   // üîÅ Handle reconnects ‚Üí reload counts
//   useEffect(() => {
//     if (!connection) return;
//     if (typeof connection.onreconnected === "function") {
//       connection.onreconnected(() => {
//         console.log("üîÅ SignalR reconnected ‚Äî reloading unread counts");
//         loadContactsAndUnread();
//       });
//     }
//   }, [connection, loadContactsAndUnread]);

//   // ‚úÖ Selecting a contact
//   const handleSelect = async id => {
//     setSelectedId(id);
//     onSelect(id);

//     // Optimistic reset
//     setUnreadCounts(prev => ({ ...prev, [id]: 0 }));

//     try {
//       if (connection?.invoke) {
//         await connection.invoke("MarkAsRead", id);
//         console.log("‚úÖ MarkAsRead invoked via SignalR for", id);
//         return;
//       }
//     } catch (err) {
//       console.warn("‚ö†Ô∏è SignalR MarkAsRead failed, fallback:", err);
//     }

//     try {
//       await axiosClient.post(`/inbox/mark-read?contactId=${id}`);
//       console.log("‚úÖ MarkAsRead fallback HTTP for", id);
//     } catch (err) {
//       console.error("‚ùå Failed to mark as read via HTTP:", err);
//     }
//   };

//   const getInitials = name =>
//     name
//       ?.split(" ")
//       .map(n => n[0])
//       .join("")
//       .substring(0, 2)
//       .toUpperCase();

//   const safeContacts = Array.isArray(contacts) ? contacts : [];
//   const filtered = safeContacts.filter(c =>
//     (c.name || c.phoneNumber || "")
//       .toString()
//       .toLowerCase()
//       .includes(search.toLowerCase())
//   );

//   return (
//     <div className="w-72 h-full flex flex-col border-r bg-white">
//       <div className="p-3 border-b">
//         <input
//           type="text"
//           placeholder="Search"
//           className="w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring"
//           value={search}
//           onChange={e => setSearch(e.target.value)}
//         />
//       </div>

//       <div className="flex-1 overflow-y-auto">
//         <div className="text-sm font-semibold text-gray-700 px-4 py-2">
//           Contacts
//         </div>
//         {filtered.map(contact => {
//           const cid = String(contact.id);
//           const unread = Number(unreadCounts[cid] || 0);
//           return (
//             <div
//               key={contact.id}
//               onClick={() => handleSelect(contact.id)}
//               className={`flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-gray-100 ${
//                 selectedId === contact.id ? "bg-gray-200" : ""
//               }`}
//             >
//               <div className="flex items-center gap-3">
//                 <div className="w-9 h-9 rounded-full bg-purple-600 text-xs font-semibold flex items-center justify-center text-white">
//                   {getInitials(contact.name || contact.phoneNumber)}
//                 </div>
//                 <div className="flex flex-col">
//                   <div className="font-medium text-sm text-gray-800 truncate">
//                     {contact.name || contact.phoneNumber || "Unknown"}
//                   </div>
//                   {contact.name && (
//                     <div className="text-xs text-gray-500">
//                       {contact.phoneNumber}
//                     </div>
//                   )}
//                 </div>
//               </div>
//               {unread > 0 && (
//                 <div className="text-xs bg-purple-600 text-white px-2 py-0.5 rounded-full min-w-[20px] text-center">
//                   {unread}
//                 </div>
//               )}
//             </div>
//           );
//         })}
//       </div>
//     </div>
//   );
// }

// // ‚úÖ Final Updated InboxSidebar.jsx
// import React, { useEffect, useState, useCallback } from "react";
// import axiosClient from "../../../api/axiosClient";
// import useSignalR from "../../../hooks/useSignalR";

// export default function InboxSidebar({ onSelect, currentUserId }) {
//   const [contacts, setContacts] = useState([]);
//   const [selectedId, setSelectedId] = useState(null);
//   const [unreadCounts, setUnreadCounts] = useState({});
//   const [search, setSearch] = useState("");
//   const { connection } = useSignalR();

//   // Helper to load contacts + unread counts (used on mount & reconnect)
//   const loadContactsAndUnread = useCallback(async () => {
//     try {
//       const [contactRes, countRes] = await Promise.all([
//         axiosClient.get("/contacts/all"),
//         axiosClient.get("/inbox/unread-counts"),
//       ]);
//       setContacts(contactRes.data || []);
//       setUnreadCounts(countRes.data || {});
//       console.log("‚úÖ Contacts and unread counts loaded");
//     } catch (err) {
//       console.error("‚ùå Failed to load inbox data:", err);
//     }
//   }, []);

//   useEffect(() => {
//     console.log("üì• InboxSidebar mounted | currentUserId:", currentUserId);
//     loadContactsAndUnread();
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, [currentUserId]); // run on mount or when currentUserId changes

//   // Listen for server-side UnreadCountChanged pushes (authoritative state)
//   useEffect(() => {
//     if (!connection) return;

//     const handleUnread = payload => {
//       // payload expected to be a dictionary: { "<contactId>": <count>, ... }
//       console.log("üîî [SignalR] UnreadCountChanged:", payload);
//       if (payload && typeof payload === "object") {
//         setUnreadCounts(payload);
//       }
//     };

//     connection.on("UnreadCountChanged", handleUnread);

//     return () => {
//       connection.off("UnreadCountChanged", handleUnread);
//     };
//   }, [connection]);

//   // Listen for incoming messages and increment unread for the specific contact (optimistic)
//   useEffect(() => {
//     if (!connection) return;

//     const handleMessage = msg => {
//       // Normalize incoming payload fields safely
//       const contactId = msg?.contactId ?? msg?.ContactId ?? null;
//       const isIncoming = (() => {
//         if (typeof msg?.isIncoming !== "undefined") return !!msg.isIncoming;
//         if (typeof msg?.IsIncoming !== "undefined") return !!msg.IsIncoming;
//         // fallback: treat presence of senderId or message from contact as incoming
//         return msg?.senderId ? false : true;
//       })();

//       // choose a stable identifier (string)
//       const cid = contactId ? String(contactId) : null;
//       if (!cid) return;

//       console.log(
//         "üì© [SignalR] Received message:",
//         msg,
//         "parsed contactId:",
//         cid,
//         "isIncoming:",
//         isIncoming
//       );

//       // Don't increment for outgoing / self-sent messages
//       // (some payloads set isIncoming=false for messages sent by this user)
//       if (!isIncoming) {
//         // if the hub sends senderId for outgoing messages, we can check it too:
//         if (msg.senderId && String(msg.senderId) === String(currentUserId)) {
//           console.log("‚Ü©Ô∏è Skipping self-sent message");
//           return;
//         }
//         // otherwise skip any non-incoming message
//         return;
//       }

//       // If the contact is currently open, do not bump unread (they see it)
//       if (cid === selectedId) {
//         console.log("üëÅÔ∏è Contact already open, skipping increment for", cid);
//         return;
//       }

//       // Increment unread for that contact
//       setUnreadCounts(prev => {
//         const prevCount = Number(prev?.[cid] || 0);
//         const next = { ...(prev || {}) };
//         next[cid] = prevCount + 1;
//         console.log(`üî∫ Unread for ${cid} => ${next[cid]}`);
//         return next;
//       });
//     };

//     connection.on("ReceiveInboxMessage", handleMessage);

//     return () => {
//       connection.off("ReceiveInboxMessage", handleMessage);
//     };
//   }, [connection, selectedId, currentUserId]);

//   // On SignalR reconnect, reload authoritative unread counts to avoid missed events
//   useEffect(() => {
//     if (!connection) return;

//     // Some HubConnection implementations provide onreconnected
//     if (typeof connection.onreconnected === "function") {
//       connection.onreconnected(() => {
//         console.log(
//           "üîÅ SignalR reconnected ‚Äî reloading contacts & unread counts"
//         );
//         loadContactsAndUnread();
//       });
//     }

//     // Also handle general reconnect detection if available
//     if (typeof connection.onreconnecting === "function") {
//       connection.onreconnecting(() => {
//         console.log("‚ö†Ô∏è SignalR reconnecting...");
//       });
//     }

//     return () => {
//       try {
//         if (typeof connection.onreconnected === "function") {
//           // no off for onreconnected in some implementations - ignore if unavailable
//         }
//       } catch (e) {}
//     };
//   }, [connection, loadContactsAndUnread]);

//   // Handler when user selects a contact
//   // const handleSelect = async id => {
//   //   setSelectedId(id);
//   //   onSelect(id);

//   //   // Optimistically clear unread badge
//   //   setUnreadCounts(prev => ({ ...(prev || {}), [id]: 0 }));

//   //   // Tell server this user has read messages (preferred: SignalR)
//   //   try {
//   //     if (connection && typeof connection.invoke === "function") {
//   //       await connection.invoke("MarkAsRead", id);
//   //       console.log("‚úÖ MarkAsRead invoked via SignalR for", id);
//   //       return;
//   //     }
//   //   } catch (err) {
//   //     console.warn("‚ö†Ô∏è SignalR MarkAsRead failed, falling back to HTTP:", err);
//   //   }

//   //   // Fallback: HTTP endpoint (keeps backward compatibility)
//   //   try {
//   //     await axiosClient.post(`/inbox/mark-read?contactId=${id}`);
//   //     console.log("‚úÖ Marked messages as read (HTTP) for contact:", id);
//   //   } catch (err) {
//   //     console.error("‚ùå Failed to mark as read via HTTP:", err);
//   //   }
//   // };
//   const handleSelect = async id => {
//     setSelectedId(id);
//     onSelect(id);

//     setUnreadCounts(prev => ({ ...prev, [id]: 0 }));

//     try {
//       if (connection?.invoke) {
//         await connection.invoke("MarkAsRead", id);
//       }
//     } catch {
//       await axiosClient.post(`/inbox/mark-read?contactId=${id}`);
//     }
//   };

//   const getInitials = name =>
//     name
//       ?.split(" ")
//       .map(n => n[0])
//       .join("")
//       .substring(0, 2)
//       .toUpperCase();

//   const safeContacts = Array.isArray(contacts) ? contacts : [];
//   const filtered = safeContacts.filter(c =>
//     (c.name || c.phoneNumber || "")
//       .toString()
//       .toLowerCase()
//       .includes(search.toLowerCase())
//   );

//   return (
//     <div className="w-72 h-full flex flex-col border-r bg-white">
//       <div className="p-3 border-b">
//         <input
//           type="text"
//           placeholder="Search"
//           className="w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring"
//           value={search}
//           onChange={e => setSearch(e.target.value)}
//         />
//       </div>

//       <div className="flex-1 overflow-y-auto">
//         <div className="text-sm font-semibold text-gray-700 px-4 py-2">
//           Contacts
//         </div>
//         {filtered.map(contact => {
//           const cid = String(contact.id);
//           const unread = Number(unreadCounts[cid] || 0);
//           // debug log (can remove later)
//           // console.log(`üîç Rendering ${contact.id} | unread: ${unread}`);
//           return (
//             <div
//               key={contact.id}
//               onClick={() => handleSelect(contact.id)}
//               className={`flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-gray-100 ${
//                 selectedId === contact.id ? "bg-gray-200" : ""
//               }`}
//             >
//               <div className="flex items-center gap-3">
//                 <div className="w-9 h-9 rounded-full bg-purple-600 text-xs font-semibold flex items-center justify-center text-white">
//                   {getInitials(contact.name || contact.phoneNumber)}
//                 </div>
//                 <div className="flex flex-col">
//                   <div className="font-medium text-sm text-gray-800 truncate">
//                     {contact.name || contact.phoneNumber || "Unknown"}
//                   </div>
//                   {contact.name && (
//                     <div className="text-xs text-gray-500">
//                       {contact.phoneNumber}
//                     </div>
//                   )}
//                 </div>
//               </div>
//               {unread > 0 && (
//                 <div className="text-xs bg-purple-600 text-white px-2 py-0.5 rounded-full min-w-[20px] text-center">
//                   {unread}
//                 </div>
//               )}
//             </div>
//           );
//         })}
//       </div>
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\components\QuickReplyPicker.jsx 
====================================================== 
 
import React, {
  useCallback,
  useEffect,
  useMemo,
  useRef,
  useState,
} from "react";
import axiosClient from "../../../api/axiosClient";

/**
 * QuickReplyPicker
 * Props:
 *  - onInsert(text: string): required
 *  - onClose(): optional
 *  - scope?: "Business" | "Personal" | "All"  // initial view; default "All"
 */
export default function QuickReplyPicker({ onInsert, onClose, scope = "All" }) {
  const containerRef = useRef(null);
  const searchRef = useRef(null);

  const [q, setQ] = useState("");
  const [items, setItems] = useState([]);
  const [loading, setLoading] = useState(false);
  const [activeIndex, setActiveIndex] = useState(-1);

  // scope chips
  const [viewScope, setViewScope] = useState(() => scope || "All");
  const viewScopeParam = useMemo(() => {
    const s = (viewScope || "All").toString().toLowerCase();
    return s === "business" || s === "personal" ? s : "all";
  }, [viewScope]);

  // NEW: create mode
  const [creating, setCreating] = useState(false);
  const [title, setTitle] = useState("");
  const [body, setBody] = useState("");
  const [tagsCsv, setTagsCsv] = useState("");
  const [createScope, setCreateScope] = useState("Personal"); // default personal
  const [saving, setSaving] = useState(false);
  const [saveMsg, setSaveMsg] = useState("");

  // Debounced fetch when search or scope changes
  useEffect(() => {
    if (creating) return; // pause list fetch while creating
    let ignore = false;
    setLoading(true);

    const t = setTimeout(() => {
      const params = {};
      if (q) params.q = q;
      if (viewScopeParam) params.scope = viewScopeParam;

      axiosClient
        .get("/quick-replies", { params })
        .then(res => {
          if (ignore) return;
          setItems(Array.isArray(res.data) ? res.data : []);
          setActiveIndex(-1);
        })
        .catch(() => {
          if (ignore) return;
          setItems([]);
        })
        .finally(() => !ignore && setLoading(false));
    }, 200);

    return () => {
      clearTimeout(t);
      ignore = true;
    };
  }, [q, viewScopeParam, creating]);

  // Autofocus search on open
  useEffect(() => {
    searchRef.current?.focus();
  }, []);

  // Close on click outside
  useEffect(() => {
    const onDocClick = e => {
      if (!containerRef.current) return;
      if (!containerRef.current.contains(e.target)) onClose?.();
    };
    document.addEventListener("mousedown", onDocClick, { capture: true });
    return () =>
      document.removeEventListener("mousedown", onDocClick, { capture: true });
  }, [onClose]);

  const handleInsert = useCallback(
    text => {
      if (!text) return;
      onInsert?.(text);
    },
    [onInsert]
  );

  const handleKeyDown = e => {
    if (e.key === "Escape") {
      e.preventDefault();
      if (creating) {
        setCreating(false);
        return;
      }
      onClose?.();
      return;
    }
    if (creating) return; // no list nav while in create form
    if (e.key === "ArrowDown") {
      e.preventDefault();
      setActiveIndex(i => Math.min(i + 1, Math.max(0, items.length - 1)));
      return;
    }
    if (e.key === "ArrowUp") {
      e.preventDefault();
      setActiveIndex(i => Math.max(i - 1, -1));
      return;
    }
    if (e.key === "Enter") {
      if (activeIndex >= 0 && activeIndex < items.length) {
        e.preventDefault();
        handleInsert(items[activeIndex]?.body);
        onClose?.();
      }
    }
  };

  const handleCreate = async () => {
    setSaveMsg("");
    if (!title.trim() || !body.trim()) {
      setSaveMsg("Title and Body are required.");
      return;
    }
    setSaving(true);
    try {
      const payload = {
        title: title.trim(),
        body: body,
        tagsCsv: tagsCsv.trim() || null,
        scope: createScope === "Business" ? 2 : 0, // enum: Personal=0, Business=2
      };
      const res = await axiosClient.post("/quick-replies", payload);
      const ok = res?.data?.success === true;
      setSaveMsg(ok ? "‚úÖ Saved." : res?.data?.message || "‚ùå Failed to save.");
      if (ok) {
        // reset form and refresh list to created scope
        setTitle("");
        setBody("");
        setTagsCsv("");
        setCreating(false);
        setViewScope(createScope);
        setQ(""); // clear search
      }
    } catch (err) {
      setSaveMsg("‚ùå Failed to save.");
      // optional: console.error(err);
    } finally {
      setSaving(false);
    }
  };

  return (
    <div
      ref={containerRef}
      className="w-80 rounded-xl border bg-white shadow-lg p-2"
      role="dialog"
      aria-label="Quick replies"
    >
      {/* Header row: search + actions */}
      <div className="flex items-center gap-2 mb-2">
        {!creating ? (
          <>
            <input
              ref={searchRef}
              className="flex-1 border rounded-md px-2 py-1 text-sm"
              placeholder="Search saved replies‚Ä¶"
              value={q}
              onChange={e => setQ(e.target.value)}
              onKeyDown={handleKeyDown}
            />
            <button
              className="text-xs px-2 py-1 border rounded-md bg-white hover:bg-gray-50"
              onClick={() => setCreating(true)}
              type="button"
              title="Create a new quick reply"
            >
              New
            </button>
            <button
              className="text-xs text-gray-500 hover:text-gray-700 px-2 py-1"
              onClick={() => onClose?.()}
              type="button"
            >
              Close
            </button>
          </>
        ) : (
          <>
            <div className="text-sm font-medium">New quick reply</div>
            <div className="flex-1" />
            <button
              className="text-xs text-gray-500 hover:text-gray-700 px-2 py-1"
              onClick={() => setCreating(false)}
              type="button"
            >
              Cancel
            </button>
          </>
        )}
      </div>

      {/* Scope chips (list view) OR Create form */}
      {!creating ? (
        <>
          {/* Scope chips */}
          <div className="flex items-center gap-1 mb-2 px-1">
            {["All", "Business", "Personal"].map(s => (
              <button
                key={s}
                type="button"
                onClick={() => setViewScope(s)}
                className={`px-2 py-0.5 text-xs rounded-full border ${
                  viewScope === s ? "bg-gray-200" : "bg-white hover:bg-gray-100"
                }`}
              >
                {s}
              </button>
            ))}
          </div>

          <div className="max-h-64 overflow-y-auto">
            {loading && (
              <div className="text-xs text-gray-500 p-2">Loading‚Ä¶</div>
            )}
            {!loading && items.length === 0 && (
              <div className="text-xs text-gray-500 p-2">No results</div>
            )}

            {!loading &&
              items.map((x, idx) => {
                const isActive = idx === activeIndex;
                return (
                  <button
                    key={x.id}
                    type="button"
                    className={`w-full text-left p-2 rounded-md ${
                      isActive ? "bg-gray-200" : "hover:bg-gray-100"
                    }`}
                    onMouseEnter={() => setActiveIndex(idx)}
                    onClick={() => {
                      handleInsert(x.body);
                      onClose?.();
                    }}
                    title={x.tagsCsv || ""}
                  >
                    <div className="text-sm font-medium text-gray-800">
                      {x.title}
                    </div>
                    <div className="text-xs text-gray-600 line-clamp-2">
                      {x.body}
                    </div>
                    {x.language && (
                      <div className="text-[10px] text-gray-400 mt-1">
                        Lang: {x.language}
                      </div>
                    )}
                  </button>
                );
              })}
          </div>

          <div className="flex items-center justify-between mt-2 px-1">
            <div className="text-[10px] text-gray-400">
              Scope: <span className="uppercase">{viewScopeParam}</span>
            </div>
            <div className="text-[10px] text-gray-400">
              ‚Üë/‚Üì navigate ‚Ä¢ Enter insert ‚Ä¢ Esc close
            </div>
          </div>
        </>
      ) : (
        // CREATE FORM
        <div className="space-y-2">
          <div className="flex items-center gap-2">
            <label className="text-xs text-gray-600 w-16">Scope</label>
            <div className="flex items-center gap-2">
              {["Personal", "Business"].map(s => (
                <label key={s} className="text-xs flex items-center gap-1">
                  <input
                    type="radio"
                    name="qr-scope"
                    value={s}
                    checked={createScope === s}
                    onChange={() => setCreateScope(s)}
                  />
                  {s}
                </label>
              ))}
            </div>
          </div>

          <div className="flex items-center gap-2">
            <label className="text-xs text-gray-600 w-16">Title</label>
            <input
              className="flex-1 border rounded-md px-2 py-1 text-sm"
              value={title}
              onChange={e => setTitle(e.target.value)}
              placeholder="e.g., Greeting (EN)"
            />
          </div>

          <div className="flex items-start gap-2">
            <label className="text-xs text-gray-600 w-16 mt-1">Body</label>
            <textarea
              className="flex-1 border rounded-md px-2 py-1 text-sm h-24"
              value={body}
              onChange={e => setBody(e.target.value)}
              placeholder="Type the message‚Ä¶"
            />
          </div>

          <div className="flex items-center gap-2">
            <label className="text-xs text-gray-600 w-16">Tags</label>
            <input
              className="flex-1 border rounded-md px-2 py-1 text-sm"
              value={tagsCsv}
              onChange={e => setTagsCsv(e.target.value)}
              placeholder="e.g., greeting,eng"
            />
          </div>

          {saveMsg && (
            <div className="text-xs px-2 py-1 rounded-md bg-gray-50 border">
              {saveMsg}
            </div>
          )}

          <div className="flex items-center justify-end gap-2">
            <button
              className="text-xs px-3 py-1 rounded-md border bg-white hover:bg-gray-50"
              onClick={() => setCreating(false)}
              type="button"
              disabled={saving}
            >
              Cancel
            </button>
            <button
              className="text-xs px-3 py-1 rounded-md text-white bg-purple-600 hover:bg-purple-700 disabled:bg-purple-300"
              onClick={handleCreate}
              type="button"
              disabled={saving}
            >
              {saving ? "Saving‚Ä¶" : "Save"}
            </button>
          </div>
        </div>
      )}
    </div>
  );
}

// import React, {
//   useCallback,
//   useEffect,
//   useMemo,
//   useRef,
//   useState,
// } from "react";
// import axiosClient from "../../../api/axiosClient";

// /**
//  * QuickReplyPicker
//  * Props:
//  *  - onInsert(text: string): required
//  *  - onClose(): optional
//  *  - scope?: "Business" | "Personal" | "All"  // acts as the initial scope; default: "All"
//  */
// export default function QuickReplyPicker({ onInsert, onClose, scope = "All" }) {
//   const containerRef = useRef(null);
//   const searchRef = useRef(null);

//   const [q, setQ] = useState("");
//   const [items, setItems] = useState([]);
//   const [loading, setLoading] = useState(false);
//   const [activeIndex, setActiveIndex] = useState(-1);

//   // NEW: local scope state (chips control this)
//   const [viewScope, setViewScope] = useState(() => scope || "All");

//   const viewScopeParam = useMemo(() => {
//     const s = (viewScope || "All").toString().toLowerCase();
//     return s === "business" || s === "personal" ? s : "all";
//   }, [viewScope]);

//   // Debounced fetch when search or scope changes
//   useEffect(() => {
//     let ignore = false;
//     setLoading(true);

//     const t = setTimeout(() => {
//       const params = {};
//       if (q) params.q = q;
//       if (viewScopeParam) params.scope = viewScopeParam;

//       axiosClient
//         .get("/quick-replies", { params })
//         .then(res => {
//           if (ignore) return;
//           setItems(Array.isArray(res.data) ? res.data : []);
//           setActiveIndex(-1);
//         })
//         .catch(() => {
//           if (ignore) return;
//           setItems([]);
//         })
//         .finally(() => !ignore && setLoading(false));
//     }, 200);

//     return () => {
//       clearTimeout(t);
//       ignore = true;
//     };
//   }, [q, viewScopeParam]);

//   // Autofocus search on open
//   useEffect(() => {
//     searchRef.current?.focus();
//   }, []);

//   // Close on click outside
//   useEffect(() => {
//     const onDocClick = e => {
//       if (!containerRef.current) return;
//       if (!containerRef.current.contains(e.target)) onClose?.();
//     };
//     document.addEventListener("mousedown", onDocClick, { capture: true });
//     return () =>
//       document.removeEventListener("mousedown", onDocClick, { capture: true });
//   }, [onClose]);

//   const handleInsert = useCallback(
//     text => {
//       if (!text) return;
//       onInsert?.(text);
//     },
//     [onInsert]
//   );

//   const handleKeyDown = e => {
//     if (e.key === "Escape") {
//       e.preventDefault();
//       onClose?.();
//       return;
//     }
//     if (e.key === "ArrowDown") {
//       e.preventDefault();
//       setActiveIndex(i => Math.min(i + 1, Math.max(0, items.length - 1)));
//       return;
//     }
//     if (e.key === "ArrowUp") {
//       e.preventDefault();
//       setActiveIndex(i => Math.max(i - 1, -1));
//       return;
//     }
//     if (e.key === "Enter") {
//       if (activeIndex >= 0 && activeIndex < items.length) {
//         e.preventDefault();
//         handleInsert(items[activeIndex]?.body);
//         onClose?.();
//       }
//     }
//   };

//   return (
//     <div
//       ref={containerRef}
//       className="w-80 rounded-xl border bg-white shadow-lg p-2"
//       role="dialog"
//       aria-label="Quick replies"
//     >
//       {/* Header row: search + close */}
//       <div className="flex items-center gap-2 mb-2">
//         <input
//           ref={searchRef}
//           className="flex-1 border rounded-md px-2 py-1 text-sm"
//           placeholder="Search saved replies‚Ä¶"
//           value={q}
//           onChange={e => setQ(e.target.value)}
//           onKeyDown={handleKeyDown}
//         />
//         <button
//           className="text-xs text-gray-500 hover:text-gray-700 px-2 py-1"
//           onClick={() => onClose?.()}
//           type="button"
//         >
//           Close
//         </button>
//       </div>

//       {/* NEW: Scope chips inside the picker */}
//       <div className="flex items-center gap-1 mb-2 px-1">
//         {["All", "Business", "Personal"].map(s => (
//           <button
//             key={s}
//             type="button"
//             onClick={() => setViewScope(s)}
//             className={`px-2 py-0.5 text-xs rounded-full border ${
//               viewScope === s ? "bg-gray-200" : "bg-white hover:bg-gray-100"
//             }`}
//           >
//             {s}
//           </button>
//         ))}
//       </div>

//       <div className="max-h-64 overflow-y-auto">
//         {loading && <div className="text-xs text-gray-500 p-2">Loading‚Ä¶</div>}
//         {!loading && items.length === 0 && (
//           <div className="text-xs text-gray-500 p-2">No results</div>
//         )}

//         {!loading &&
//           items.map((x, idx) => {
//             const isActive = idx === activeIndex;
//             return (
//               <button
//                 key={x.id}
//                 type="button"
//                 className={`w-full text-left p-2 rounded-md ${
//                   isActive ? "bg-gray-200" : "hover:bg-gray-100"
//                 }`}
//                 onMouseEnter={() => setActiveIndex(idx)}
//                 onClick={() => {
//                   handleInsert(x.body);
//                   onClose?.();
//                 }}
//                 title={x.tagsCsv || ""}
//               >
//                 <div className="text-sm font-medium text-gray-800">
//                   {x.title}
//                 </div>
//                 <div className="text-xs text-gray-600 line-clamp-2">
//                   {x.body}
//                 </div>
//                 {x.language && (
//                   <div className="text-[10px] text-gray-400 mt-1">
//                     Lang: {x.language}
//                   </div>
//                 )}
//               </button>
//             );
//           })}
//       </div>

//       <div className="flex items-center justify-between mt-2 px-1">
//         <div className="text-[10px] text-gray-400">
//           Scope: <span className="uppercase">{viewScopeParam}</span>
//         </div>
//         <div className="text-[10px] text-gray-400">
//           ‚Üë/‚Üì navigate ‚Ä¢ Enter insert ‚Ä¢ Esc close
//         </div>
//       </div>
//     </div>
//   );
// }
 
 
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\components\ChatBubble.jsx 
====================================================== 
 
import React, { useState, useRef, useEffect } from "react";
import dayjs from "dayjs";
import {
  FaCheck,
  FaCheckDouble,
  FaClock,
  FaExclamationCircle,
} from "react-icons/fa";

export default function ChatBubble({ message, isOwn }) {
  const [expanded, setExpanded] = useState(false);
  const messageRef = useRef(null);
  const [isOverflowing, setIsOverflowing] = useState(false);

  const time = dayjs(message.sentAt || message.createdAt).format("h:mm A");
  const messageText =
    message.renderedBody ||
    message.message ||
    message.messageContent ||
    "[no message]";

  useEffect(() => {
    const el = messageRef.current;
    if (el && el.scrollHeight > el.clientHeight + 10) {
      setIsOverflowing(true);
    }
  }, []);

  const baseStyle =
    "px-4 py-2 max-w-[75%] text-sm leading-snug shadow-md whitespace-pre-wrap";

  const ownStyle = "bg-green-600 text-white rounded-2xl rounded-br-sm";
  const incomingStyle = "bg-purple-100 text-gray-900 rounded-2xl rounded-bl-sm";

  const tickColor = isOwn ? "text-white/70" : "text-gray-500";

  return (
    <div className={`flex ${isOwn ? "justify-end" : "justify-start"} mb-2`}>
      <div
        ref={messageRef}
        onClick={() => isOverflowing && setExpanded(!expanded)}
        className={`${baseStyle} ${isOwn ? ownStyle : incomingStyle} ${
          expanded ? "cursor-zoom-out" : isOverflowing ? "cursor-zoom-in" : ""
        }`}
        style={{
          overflow: "hidden",
          whiteSpace: expanded ? "normal" : "pre-wrap",
        }}
      >
        <div className="flex items-end justify-between gap-2">
          <span className="flex-1">{messageText}</span>
          <span className={`text-[11px] flex items-center gap-1 ${tickColor}`}>
            {time}
            {isOwn && (
              <>
                {/* {message.status === "Sent" && <FaCheck />}
                {message.status === "Delivered" && <FaCheckDouble />}
                {message.status === "Read" && (
                  <FaCheckDouble className="text-blue-400" />
                )} */}
                {message.status === "Sending" && <FaClock />}
                {message.status === "Failed" && (
                  <FaExclamationCircle className="text-red-400" />
                )}
                {message.status === "Sent" && <FaCheck />}
                {message.status === "Delivered" && <FaCheckDouble />}
                {message.status === "Read" && (
                  <FaCheckDouble className="text-blue-400" />
                )}
              </>
            )}
          </span>
        </div>
      </div>
    </div>
  );
}

// import React, { useState, useRef, useEffect } from "react";
// import dayjs from "dayjs";
// import { FaCheck, FaCheckDouble } from "react-icons/fa";

// export default function ChatBubble({ message, isOwn }) {
//   const [expanded, setExpanded] = useState(false);
//   const messageRef = useRef(null);
//   const [isOverflowing, setIsOverflowing] = useState(false);

//   const time = dayjs(message.sentAt || message.createdAt).format("h:mm A");
//   const messageText =
//     message.renderedBody ||
//     message.message ||
//     message.messageContent ||
//     "[no message]";

//   useEffect(() => {
//     const el = messageRef.current;
//     if (el && el.scrollHeight > el.clientHeight + 10) {
//       setIsOverflowing(true);
//     }
//   }, []);

//   const baseStyle =
//     "px-4 py-2 max-w-[75%] text-sm leading-snug shadow-md whitespace-pre-wrap";

//   const ownStyle = "bg-green-600 text-white rounded-2xl rounded-br-sm";
//   const incomingStyle = "bg-purple-100 text-gray-900 rounded-2xl rounded-bl-sm";

//   const tickColor = isOwn ? "text-white/70" : "text-gray-500";

//   return (
//     <div className={`flex ${isOwn ? "justify-end" : "justify-start"} mb-2`}>
//       <div
//         ref={messageRef}
//         onClick={() => isOverflowing && setExpanded(!expanded)}
//         className={`${baseStyle} ${isOwn ? ownStyle : incomingStyle} ${
//           expanded ? "cursor-zoom-out" : isOverflowing ? "cursor-zoom-in" : ""
//         }`}
//         style={{
//           overflow: "hidden",
//           whiteSpace: expanded ? "normal" : "pre-wrap",
//         }}
//       >
//         <div className="flex items-end justify-between gap-2">
//           <span className="flex-1">
//             {messageText}
//             {message.campaignName && (
//               <div className="mt-1 text-[10px] italic text-white/80">
//                 üì¢ Sent via campaign: {message.campaignName}
//               </div>
//             )}
//           </span>

//           <span className={`text-[11px] flex items-center gap-1 ${tickColor}`}>
//             {time}
//             {isOwn && (
//               <>
//                 {message.status === "Sent" && <FaCheck />}
//                 {message.status === "Delivered" && <FaCheckDouble />}
//                 {message.status === "Read" && (
//                   <FaCheckDouble className="text-blue-400" />
//                 )}
//               </>
//             )}
//           </span>
//         </div>
//       </div>
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\components\ChatHeader.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../../api/axiosClient";

/**
 * ChatHeader ‚Äî Professional WhatsApp-style chat header
 * Props:
 * - contactId: contact ID to fetch data
 */
export default function ChatHeader({ contactId }) {
  const [contact, setContact] = useState(null);

  // Fetch contact data when contactId changes
  useEffect(() => {
    if (!contactId) {
      setContact(null);
      return;
    }

    const fetchContact = async () => {
      try {
        const res = await axiosClient.get(`/contacts/${contactId}`);
        // Handle different API response structures
        if (res?.data?.data) {
          setContact(res.data.data);
        } else if (res?.data) {
          setContact(res.data);
        } else {
          setContact(res);
        }
      } catch (err) {
        console.error("‚ùå [ChatHeader] Failed to load contact:", err);
      }
    };

    fetchContact();
  }, [contactId]);

  if (!contact) return null;

  const { name, phoneNumber } = contact;

  // üß† Extract initials from name or phone number
  const initials =
    name
      ?.split(" ")
      .map(part => part.charAt(0).toUpperCase())
      .slice(0, 2)
      .join("") ||
    phoneNumber?.slice(-2) ||
    "??";

  // Display name if present, otherwise phone number
  const displayName = name || phoneNumber || "Unknown Contact";

  return (
    <div className="bg-white border-b shadow-sm px-4 py-3 flex items-center justify-between">
      {/* Left Section: Avatar + Info */}
      <div className="flex items-center gap-4">
        {/* Avatar with Initials */}
        <div className="w-10 h-10 rounded-full bg-green-600 text-white font-semibold text-sm flex items-center justify-center shadow-sm">
          {initials}
        </div>

        {/* Name, Phone */}
        <div className="space-y-0.5">
          <h2 className="text-base font-semibold text-gray-800">
            {displayName}
          </h2>
          {name && phoneNumber && (
            <div className="text-xs text-gray-500">{phoneNumber}</div>
          )}
        </div>
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\components\ChatInput.jsx 
====================================================== 
 
import React, { useRef, useState, useCallback, useEffect } from "react";
import { useInbox } from "../InboxContext";
import { Smile, Paperclip, Send, X as CloseIcon } from "lucide-react";
import QuickReplyPicker from "./QuickReplyPicker";
import EmojiPicker from "./EmojiPicker";

export default function ChatInput() {
  const { newMessage, setNewMessage, sendMessage, isConnected } = useInbox();
  const [pickerOpen, setPickerOpen] = useState(false);
  const [emojiOpen, setEmojiOpen] = useState(false);
  const textareaRef = useRef(null);

  const clearMessage = () => setNewMessage("");

  const handleSend = () => {
    if (!isConnected || !newMessage?.trim()) return;
    setPickerOpen(false);
    setEmojiOpen(false);
    sendMessage();
    // ‚úÖ force the message list to scroll to bottom after sending
    window.dispatchEvent(new CustomEvent("xbc:scrollToBottom"));
  };

  const handleKeyDown = e => {
    if (e.key === "/" && !pickerOpen) {
      e.preventDefault();
      setPickerOpen(true);
      return;
    }
    if (e.key === "Escape" && (pickerOpen || emojiOpen)) {
      e.preventDefault();
      setPickerOpen(false);
      setEmojiOpen(false);
      return;
    }
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };

  const insertAtCursor = useCallback(
    snippet => {
      const el = textareaRef.current;
      if (!el) {
        setNewMessage(prev => (prev ? `${prev} ${snippet}` : snippet));
        return;
      }
      const start = el.selectionStart ?? newMessage?.length ?? 0;
      const end = el.selectionEnd ?? newMessage?.length ?? 0;
      const base = newMessage ?? "";
      const next = base.slice(0, start) + snippet + base.slice(end);
      setNewMessage(next);
      requestAnimationFrame(() => {
        el.focus();
        const pos = start + snippet.length;
        el.setSelectionRange(pos, pos);
      });
    },
    [newMessage, setNewMessage]
  );

  const autoResize = useCallback(() => {
    const el = textareaRef.current;
    if (!el) return;
    el.style.height = "auto";
    const max = 160; // ~4 lines
    el.style.height = Math.min(el.scrollHeight, max) + "px";
  }, []);

  useEffect(() => {
    autoResize();
  }, [newMessage, autoResize]);

  return (
    <div className="p-3 border-t bg-white overflow-visible">
      <div className="flex items-center gap-2">
        {/* Quick Reply */}
        <div className="relative">
          <button
            type="button"
            onClick={() => setPickerOpen(v => !v)}
            className="h-9 px-3 text-sm rounded-lg border bg-white hover:bg-gray-50"
            title="Saved replies"
            disabled={!isConnected}
            aria-expanded={pickerOpen}
          >
            Quick Reply
          </button>
          {pickerOpen && (
            <div className="absolute left-0 bottom-full mb-2 z-[100]">
              <QuickReplyPicker
                onInsert={text => {
                  insertAtCursor(text);
                  setPickerOpen(false);
                }}
                onClose={() => setPickerOpen(false)}
              />
            </div>
          )}
        </div>

        {/* Emoji */}
        <div className="relative">
          <button
            type="button"
            className="h-9 w-9 flex items-center justify-center rounded-lg hover:bg-gray-100"
            title="Emoji"
            disabled={!isConnected}
            aria-expanded={emojiOpen}
            onClick={() => setEmojiOpen(v => !v)}
          >
            <Smile size={16} />
          </button>
          {emojiOpen && (
            <div className="absolute left-0 bottom-full mb-2 z-[100]">
              <EmojiPicker
                onPick={emoji => {
                  insertAtCursor(emoji);
                  setEmojiOpen(false);
                }}
                onClose={() => setEmojiOpen(false)}
              />
            </div>
          )}
        </div>

        {/* Attach (placeholder) */}
        <button
          className="h-9 w-9 flex items-center justify-center rounded-lg hover:bg-gray-100"
          title="Attach"
          disabled
        >
          <Paperclip size={16} />
        </button>

        {/* Textarea + Clear X */}
        <div className="relative flex-1">
          <textarea
            ref={textareaRef}
            rows={1}
            value={newMessage}
            onChange={e => setNewMessage(e.target.value)}
            onKeyDown={handleKeyDown}
            onInput={autoResize}
            disabled={!isConnected}
            placeholder={
              !isConnected
                ? "Connecting..."
                : "Type your message‚Ä¶ (Enter to send ‚Ä¢ Shift+Enter for new line)"
            }
            className="w-full text-sm px-4 py-2 pr-12 rounded-xl border shadow-sm focus:outline-none focus:ring-1 bg-white focus:border-purple-500 resize-none min-h-[40px] max-h-40 overflow-y-auto leading-relaxed"
          />
          {!!(newMessage || "").length && (
            <button
              type="button"
              onClick={clearMessage}
              title="Clear"
              aria-label="Clear message"
              className="absolute right-2 inset-y-0 my-auto h-6 w-6 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-500"
            >
              <CloseIcon size={16} />
            </button>
          )}
        </div>

        {/* Send */}
        <button
          onClick={handleSend}
          disabled={!isConnected || !newMessage?.trim()}
          className="h-9 w-9 flex items-center justify-center rounded-full text-white bg-green-600 hover:bg-green-700 disabled:bg-green-300 disabled:cursor-not-allowed"
          title="Send"
        >
          <Send size={16} />
        </button>
      </div>
    </div>
  );
}

// import React, { useRef, useState, useCallback, useEffect } from "react";
// import { useInbox } from "../InboxContext";
// import { Smile, Paperclip, Send, X as CloseIcon } from "lucide-react";
// import QuickReplyPicker from "./QuickReplyPicker";
// import EmojiPicker from "./EmojiPicker";

// export default function ChatInput() {
//   const { newMessage, setNewMessage, sendMessage, isConnected } = useInbox();
//   const [pickerOpen, setPickerOpen] = useState(false);
//   const [emojiOpen, setEmojiOpen] = useState(false);
//   const textareaRef = useRef(null);

//   const clearMessage = () => setNewMessage("");

//   const handleSend = () => {
//     if (!isConnected || !newMessage?.trim()) return;
//     setPickerOpen(false);
//     setEmojiOpen(false);
//     sendMessage();
//   };

//   const handleKeyDown = e => {
//     if (e.key === "/" && !pickerOpen) {
//       e.preventDefault();
//       setPickerOpen(true);
//       return;
//     }
//     if (e.key === "Escape" && (pickerOpen || emojiOpen)) {
//       e.preventDefault();
//       setPickerOpen(false);
//       setEmojiOpen(false);
//       return;
//     }
//     if (e.key === "Enter" && !e.shiftKey) {
//       e.preventDefault();
//       handleSend();
//     }
//   };

//   const insertAtCursor = useCallback(
//     snippet => {
//       const el = textareaRef.current;
//       if (!el) {
//         setNewMessage(prev => (prev ? `${prev} ${snippet}` : snippet));
//         return;
//       }
//       const start = el.selectionStart ?? newMessage?.length ?? 0;
//       const end = el.selectionEnd ?? newMessage?.length ?? 0;
//       const base = newMessage ?? "";
//       const next = base.slice(0, start) + snippet + base.slice(end);
//       setNewMessage(next);
//       requestAnimationFrame(() => {
//         el.focus();
//         const pos = start + snippet.length;
//         el.setSelectionRange(pos, pos);
//       });
//     },
//     [newMessage, setNewMessage]
//   );

//   const autoResize = useCallback(() => {
//     const el = textareaRef.current;
//     if (!el) return;
//     el.style.height = "auto";
//     const max = 160; // ~4 lines
//     el.style.height = Math.min(el.scrollHeight, max) + "px";
//   }, []);

//   useEffect(() => {
//     autoResize();
//   }, [newMessage, autoResize]);

//   return (
//     <div className="p-3 border-t bg-white overflow-visible">
//       <div className="flex items-center gap-2">
//         {/* Quick Reply */}
//         <div className="relative">
//           <button
//             type="button"
//             onClick={() => setPickerOpen(v => !v)}
//             className="h-9 px-3 text-sm rounded-lg border bg-white hover:bg-gray-50"
//             title="Saved replies"
//             disabled={!isConnected}
//             aria-expanded={pickerOpen}
//           >
//             Quick Reply
//           </button>
//           {pickerOpen && (
//             <div className="absolute left-0 bottom-full mb-2 z-[100]">
//               <QuickReplyPicker
//                 onInsert={text => {
//                   insertAtCursor(text);
//                   setPickerOpen(false);
//                 }}
//                 onClose={() => setPickerOpen(false)}
//               />
//             </div>
//           )}
//         </div>

//         {/* Emoji */}
//         <div className="relative">
//           <button
//             type="button"
//             className="h-9 w-9 flex items-center justify-center rounded-lg hover:bg-gray-100"
//             title="Emoji"
//             disabled={!isConnected}
//             aria-expanded={emojiOpen}
//             onClick={() => setEmojiOpen(v => !v)}
//           >
//             <Smile size={16} />
//           </button>
//           {emojiOpen && (
//             <div className="absolute left-0 bottom-full mb-2 z-[100]">
//               <EmojiPicker
//                 onPick={emoji => {
//                   insertAtCursor(emoji);
//                   setEmojiOpen(false);
//                 }}
//                 onClose={() => setEmojiOpen(false)}
//               />
//             </div>
//           )}
//         </div>

//         {/* Attach (placeholder) */}
//         <button
//           className="h-9 w-9 flex items-center justify-center rounded-lg hover:bg-gray-100"
//           title="Attach"
//           disabled
//         >
//           <Paperclip size={16} />
//         </button>

//         {/* Textarea + Clear X */}
//         <div className="relative flex-1">
//           <textarea
//             ref={textareaRef}
//             rows={1}
//             value={newMessage}
//             onChange={e => setNewMessage(e.target.value)}
//             onKeyDown={handleKeyDown}
//             onInput={autoResize}
//             disabled={!isConnected}
//             placeholder={
//               !isConnected
//                 ? "Connecting..."
//                 : "Type your message‚Ä¶ (Enter to send ‚Ä¢ Shift+Enter for new line)"
//             }
//             className="w-full text-sm px-4 py-2 pr-12 rounded-xl border shadow-sm focus:outline-none focus:ring-1 bg-white focus:border-purple-500 resize-none min-h-[40px] max-h-40 overflow-y-auto leading-relaxed"
//           />
//           {!!(newMessage || "").length && (
//             <button
//               type="button"
//               onClick={clearMessage}
//               title="Clear"
//               aria-label="Clear message"
//               className="absolute right-2 inset-y-0 my-auto h-6 w-6 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-500"
//             >
//               <CloseIcon size={16} />
//             </button>
//           )}
//         </div>

//         {/* Send */}
//         <button
//           onClick={handleSend}
//           disabled={!isConnected || !newMessage?.trim()}
//           className="h-9 w-9 flex items-center justify-center rounded-full text-white bg-green-600 hover:bg-green-700 disabled:bg-green-300 disabled:cursor-not-allowed"
//           title="Send"
//         >
//           <Send size={16} />
//         </button>
//       </div>
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\components\ChatWindow.jsx 
====================================================== 
 
import React, { useRef, useEffect, useCallback } from "react";
import { useInbox } from "../InboxContext";
import ChatBubble from "./ChatBubble";
import dayjs from "dayjs";
import isToday from "dayjs/plugin/isToday";
import isYesterday from "dayjs/plugin/isYesterday";

dayjs.extend(isToday);
dayjs.extend(isYesterday);

function getDateLabel(date) {
  const d = dayjs(date);
  if (d.isToday()) return "Today";
  if (d.isYesterday()) return "Yesterday";
  return d.format("D MMM YYYY");
}

export default function ChatWindow() {
  const { messages = [], connection, selectedContactId } = useInbox();

  // The ONLY scroll container + a bottom anchor
  const scrollContainerRef = useRef(null);
  const bottomRef = useRef(null);

  // Track if user is already at/near bottom
  const atBottomRef = useRef(true);
  const NEAR_BOTTOM_PX = 120;

  const isNearBottom = useCallback(() => {
    const el = scrollContainerRef.current;
    if (!el) return true;
    const distance = el.scrollHeight - (el.scrollTop + el.clientHeight);
    return distance <= NEAR_BOTTOM_PX;
  }, []);

  const handleScroll = useCallback(() => {
    atBottomRef.current = isNearBottom();
  }, [isNearBottom]);

  const scrollToBottom = useCallback((smooth = true) => {
    bottomRef.current?.scrollIntoView({
      behavior: smooth ? "smooth" : "auto",
      block: "end",
    });
  }, []);

  // 1) On first mount -> jump to bottom
  useEffect(() => {
    scrollToBottom(false);
    // initialize bottom state
    atBottomRef.current = true;
  }, [scrollToBottom]);

  // 2) On contact change -> jump to bottom after DOM paints
  useEffect(() => {
    const t = setTimeout(() => scrollToBottom(false), 0);
    return () => clearTimeout(t);
  }, [selectedContactId, scrollToBottom]);

  // 3) On new messages -> only scroll if already near bottom
  useEffect(() => {
    if (atBottomRef.current) scrollToBottom(true);
  }, [messages.length, scrollToBottom]);

  // 4) Allow imperative force scroll (e.g., right after Send)
  useEffect(() => {
    const onForce = () => scrollToBottom(true);
    window.addEventListener("xbc:scrollToBottom", onForce);
    return () => window.removeEventListener("xbc:scrollToBottom", onForce);
  }, [scrollToBottom]);

  // 5) Gentle auto mark-as-read shortly after switching
  useEffect(() => {
    if (!connection || !selectedContactId) return;
    const timeout = setTimeout(() => {
      connection.invoke("MarkAsRead", selectedContactId).catch(err => {
        console.warn("‚ö†Ô∏è MarkAsRead SignalR call failed:", err);
      });
    }, 800);
    return () => clearTimeout(timeout);
  }, [connection, selectedContactId]);

  if (messages.length === 0) {
    return (
      <div className="flex-1 flex items-center justify-center text-gray-400">
        Loading messages‚Ä¶
      </div>
    );
  }

  // Group by date
  const grouped = messages.reduce((acc, msg) => {
    const dateKey = getDateLabel(msg.sentAt || msg.createdAt);
    (acc[dateKey] ||= []).push(msg);
    return acc;
  }, {});

  return (
    <div
      ref={scrollContainerRef}
      onScroll={handleScroll}
      className="p-4 space-y-6 overflow-y-auto h-full"
    >
      {Object.entries(grouped).map(([date, msgs]) => (
        <div key={date}>
          <div className="text-center text-xs text-gray-500 mb-2">{date}</div>
          <div className="space-y-1">
            {msgs.map((msg, idx) => (
              <ChatBubble
                key={msg.id || idx}
                message={msg}
                isOwn={!msg.isIncoming}
              />
            ))}
          </div>
        </div>
      ))}
      <div ref={bottomRef} />
    </div>
  );
}

// import React, { useRef, useEffect } from "react";
// import { useInbox } from "../InboxContext";
// import ChatBubble from "./ChatBubble";
// import dayjs from "dayjs";
// import isToday from "dayjs/plugin/isToday";
// import isYesterday from "dayjs/plugin/isYesterday";

// dayjs.extend(isToday);
// dayjs.extend(isYesterday);

// function getDateLabel(date) {
//   const d = dayjs(date);
//   if (d.isToday()) return "Today";
//   if (d.isYesterday()) return "Yesterday";
//   return d.format("D MMM YYYY");
// }

// export default function ChatWindow() {
//   const { messages, connection, selectedContactId } = useInbox();
//   const bottomRef = useRef(null);
//   const scrollContainerRef = useRef(null);

//   // Smart scrolling
//   useEffect(() => {
//     if (!scrollContainerRef.current) return;
//     const { scrollHeight, scrollTop, clientHeight } =
//       scrollContainerRef.current;
//     if (scrollHeight - scrollTop <= clientHeight + 100) {
//       bottomRef.current?.scrollIntoView({ behavior: "smooth" });
//     }
//   }, [messages]);

//   // Mark messages as read
//   useEffect(() => {
//     if (!connection || !selectedContactId) return;
//     const timeout = setTimeout(() => {
//       connection.invoke("MarkAsRead", selectedContactId).catch(err => {
//         console.warn("‚ö†Ô∏è MarkAsRead SignalR call failed:", err);
//       });
//     }, 800);
//     return () => clearTimeout(timeout);
//   }, [connection, selectedContactId]);

//   if (messages.length === 0) {
//     return (
//       <div className="flex-1 flex items-center justify-center text-gray-400">
//         Loading messages...
//       </div>
//     );
//   }

//   const grouped = messages.reduce((acc, msg) => {
//     const dateKey = getDateLabel(msg.sentAt || msg.createdAt);
//     if (!acc[dateKey]) acc[dateKey] = [];
//     acc[dateKey].push(msg);
//     return acc;
//   }, {});

//   return (
//     <div
//       ref={scrollContainerRef}
//       className="p-4 space-y-6 overflow-y-auto h-full"
//     >
//       {Object.entries(grouped).map(([date, msgs]) => (
//         <div key={date}>
//           <div className="text-center text-xs text-gray-500 mb-2">{date}</div>
//           <div className="space-y-1">
//             {msgs.map((msg, idx) => (
//               <ChatBubble
//                 key={msg.id || idx}
//                 message={msg}
//                 isOwn={!msg.isIncoming}
//               />
//             ))}
//           </div>
//         </div>
//       ))}
//       <div ref={bottomRef} />
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\components\ContactSidebar.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../../api/axiosClient";
// Removed Edit2 as it was unused
import { Info, StickyNote } from "lucide-react";
import dayjs from "dayjs";
import relativeTime from "dayjs/plugin/relativeTime";
dayjs.extend(relativeTime);

export default function ContactSidebar({ contactId }) {
  const [contact, setContact] = useState(null);
  const [newNote, setNewNote] = useState("");
  const [activeTab, setActiveTab] = useState("details");

  // üü£ LOG: Incoming contactId
  useEffect(() => {
    console.log("[ContactSidebar] Rendered with contactId:", contactId);
  }, [contactId]);

  useEffect(() => {
    if (!contactId) {
      console.warn("[ContactSidebar] No contactId provided");
      return;
    }

    const fetchContact = async () => {
      try {
        console.log("[ContactSidebar] Fetching contact:", contactId);
        const res = await axiosClient.get(`/contacts/${contactId}`);
        console.log("[ContactSidebar] API response:", res);

        // üü£ Some APIs wrap data in a .data.data shape!
        if (res?.data?.data) {
          setContact(res.data.data);
          console.log("[ContactSidebar] Set contact with res.data.data");
        } else if (res?.data) {
          setContact(res.data);
          console.log("[ContactSidebar] Set contact with res.data");
        } else {
          setContact(res);
          console.log("[ContactSidebar] Set contact with res");
        }
      } catch (err) {
        console.error("‚ùå [ContactSidebar] Failed to load contact:", err);
      }
    };

    fetchContact();
  }, [contactId]);

  const handleAddNote = async () => {
    if (!newNote.trim()) return;

    try {
      console.log(
        "[ContactSidebar] Adding note for contactId:",
        contactId,
        newNote
      );
      await axiosClient.post(`/notes`, {
        contactId,
        content: newNote,
      });
      setNewNote("");
      // Refetch after adding note
      const updated = await axiosClient.get(`/contacts/${contactId}`);
      if (updated?.data?.data) {
        setContact(updated.data.data);
      } else if (updated?.data) {
        setContact(updated.data);
      } else {
        setContact(updated);
      }
    } catch (err) {
      console.error("‚ùå [ContactSidebar] Failed to add note:", err);
    }
  };

  // üü£ LOG: Current contact state
  useEffect(() => {
    console.log("[ContactSidebar] Current contact state:", contact);
  }, [contact]);

  if (!contact) return <div className="p-4 text-gray-500">Loading...</div>;

  const {
    createdAt,
    tags = [],
    notes = [],
    list = "Default",
    chatWindowStatus = "Open",
    sessionStatus = "Active",
  } = contact;

  return (
    <div
      className="p-4 text-sm overflow-y-auto"
      style={{ height: "100%", maxHeight: "100%" }}
    >
      {/* üß± Tab Switcher */}
      <div className="flex mb-4 border rounded-md overflow-hidden text-sm">
        <button
          onClick={() => setActiveTab("details")}
          className={`flex-1 px-3 py-2 flex items-center justify-center gap-1 ${
            activeTab === "details"
              ? "bg-gray-200 font-semibold"
              : "bg-gray-100 hover:bg-gray-200"
          }`}
        >
          <Info size={14} /> Details
        </button>
        <button
          onClick={() => setActiveTab("notes")}
          className={`flex-1 px-3 py-2 flex items-center justify-center gap-1 ${
            activeTab === "notes"
              ? "bg-gray-200 font-semibold"
              : "bg-gray-100 hover:bg-gray-200"
          }`}
        >
          <StickyNote size={14} /> Notes
        </button>
      </div>

      {/* üìÑ Details Tab */}
      {activeTab === "details" && (
        <div className="space-y-4">
          <div className="bg-gray-50 border rounded-md p-3">
            <h4 className="text-xs font-semibold text-gray-700 mb-1">
              Conversation
            </h4>
            <div className="flex justify-between text-xs text-gray-600">
              <span>24-hour window:</span>
              <span className="text-green-600 font-medium">
                {chatWindowStatus}
              </span>
            </div>
            <div className="flex justify-between text-xs text-gray-600">
              <span>Chat session:</span>
              <span className="text-green-600 font-medium">
                {sessionStatus}
              </span>
            </div>
            <div className="flex justify-between text-xs text-gray-600">
              <span>Window ends:</span>
              <span>‚Äî</span>
            </div>
          </div>

          <div>
            <h4 className="text-xs font-semibold text-gray-700 mb-1">
              Contact data
            </h4>
            <div className="text-xs text-gray-600">
              Created: {createdAt?.slice(0, 10)}
            </div>
            <div className="text-xs text-gray-600">List: {list}</div>
          </div>

          <div>
            <h4 className="text-xs font-semibold text-gray-700 mb-1">Tags</h4>
            {tags.length === 0 ? (
              <div className="text-gray-400 italic text-xs">No tags</div>
            ) : (
              <div className="flex flex-wrap gap-2">
                {tags.map(tag => (
                  <span
                    key={tag.id}
                    className="text-xs font-medium px-2 py-1 rounded-full"
                    style={{
                      backgroundColor: tag.colorHex || "#999",
                      color:
                        tag.colorHex && tag.colorHex.toLowerCase() === "#ffffe0"
                          ? "#000"
                          : "#fff",
                    }}
                  >
                    {tag.name}
                  </span>
                ))}
              </div>
            )}
          </div>
        </div>
      )}

      {/* üìù Notes Tab */}
      {activeTab === "notes" && (
        <div className="space-y-3">
          <div className="flex gap-2">
            <input
              className="flex-1 px-2 py-1 text-xs border rounded-md"
              placeholder="Add note..."
              value={newNote}
              onChange={e => setNewNote(e.target.value)}
            />
            <button
              onClick={handleAddNote}
              className="bg-blue-600 text-white text-xs px-3 py-1 rounded-md hover:bg-blue-700"
            >
              Add
            </button>
          </div>

          {Array.isArray(notes) && notes.length > 0 ? (
            <div className="space-y-2 max-h-40 overflow-y-auto">
              {notes.map(n => (
                <div
                  key={n.id}
                  className="text-xs text-gray-700 bg-gray-100 rounded-md px-2 py-1"
                >
                  <div>{n.content}</div>
                  <div className="text-[10px] text-gray-400 mt-1">
                    {dayjs(n.createdAt).fromNow()}
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div className="text-gray-400 italic text-xs">No notes yet</div>
          )}
        </div>
      )}
    </div>
  );
}

// import React, { useEffect, useState } from "react";
// import axiosClient from "../../../api/axiosClient";
// import { Edit2, Info, StickyNote } from "lucide-react";
// import dayjs from "dayjs";
// import relativeTime from "dayjs/plugin/relativeTime";
// dayjs.extend(relativeTime);

// export default function ContactSidebar({ contactId }) {
//   const [contact, setContact] = useState(null);
//   const [newNote, setNewNote] = useState("");
//   const [activeTab, setActiveTab] = useState("details");

//   // üü£ LOG: Incoming contactId
//   useEffect(() => {
//     console.log("[ContactSidebar] Rendered with contactId:", contactId);
//   }, [contactId]);

//   useEffect(() => {
//     if (!contactId) {
//       console.warn("[ContactSidebar] No contactId provided");
//       return;
//     }

//     const fetchContact = async () => {
//       try {
//         console.log("[ContactSidebar] Fetching contact:", contactId);
//         const res = await axiosClient.get(`/contacts/${contactId}`);
//         console.log("[ContactSidebar] API response:", res);

//         // üü£ Some APIs wrap data in a .data.data shape!
//         if (res?.data?.data) {
//           setContact(res.data.data);
//           console.log("[ContactSidebar] Set contact with res.data.data");
//         } else if (res?.data) {
//           setContact(res.data);
//           console.log("[ContactSidebar] Set contact with res.data");
//         } else {
//           setContact(res);
//           console.log("[ContactSidebar] Set contact with res");
//         }
//       } catch (err) {
//         console.error("‚ùå [ContactSidebar] Failed to load contact:", err);
//       }
//     };

//     fetchContact();
//   }, [contactId]);

//   const handleAddNote = async () => {
//     if (!newNote.trim()) return;

//     try {
//       console.log(
//         "[ContactSidebar] Adding note for contactId:",
//         contactId,
//         newNote
//       );
//       await axiosClient.post(`/notes`, {
//         contactId,
//         content: newNote,
//       });
//       setNewNote("");
//       // Refetch after adding note
//       const updated = await axiosClient.get(`/contacts/${contactId}`);
//       if (updated?.data?.data) {
//         setContact(updated.data.data);
//       } else if (updated?.data) {
//         setContact(updated.data);
//       } else {
//         setContact(updated);
//       }
//     } catch (err) {
//       console.error("‚ùå [ContactSidebar] Failed to add note:", err);
//     }
//   };

//   // üü£ LOG: Current contact state
//   useEffect(() => {
//     console.log("[ContactSidebar] Current contact state:", contact);
//   }, [contact]);

//   if (!contact) return <div className="p-4 text-gray-500">Loading...</div>;

//   const {
//     name,
//     phoneNumber,
//     createdAt,
//     tags = [],
//     notes = [],
//     list = "Default",
//     chatWindowStatus = "Open",
//     sessionStatus = "Active",
//   } = contact;

//   const initials = name
//     ?.split(" ")
//     .map(n => n[0])
//     .join("")
//     .substring(0, 2)
//     .toUpperCase();

//   return (
//     <div className="p-4 text-sm overflow-y-auto h-full">
//       {/* üîπ Top Header */}
//       <div className="flex items-center gap-4 mb-4">
//         <div className="w-10 h-10 rounded-full bg-green-600 text-white flex items-center justify-center font-semibold text-sm">
//           {initials}
//         </div>
//         <div>
//           <h2 className="font-semibold text-gray-800 flex items-center gap-2">
//             {name}
//             {sessionStatus === "Active" && (
//               <span
//                 className="ml-1 inline-block w-2 h-2 rounded-full bg-green-500 animate-pulse"
//                 title="Active session"
//               ></span>
//             )}
//           </h2>
//           <div className="text-xs text-gray-500">{phoneNumber}</div>
//         </div>
//       </div>

//       {/* üß± Tab Switcher */}
//       <div className="flex mb-4 border rounded-md overflow-hidden text-sm">
//         <button
//           onClick={() => setActiveTab("details")}
//           className={`flex-1 px-3 py-2 flex items-center justify-center gap-1 ${
//             activeTab === "details"
//               ? "bg-gray-200 font-semibold"
//               : "bg-gray-100 hover:bg-gray-200"
//           }`}
//         >
//           <Info size={14} /> Details
//         </button>
//         <button
//           onClick={() => setActiveTab("notes")}
//           className={`flex-1 px-3 py-2 flex items-center justify-center gap-1 ${
//             activeTab === "notes"
//               ? "bg-gray-200 font-semibold"
//               : "bg-gray-100 hover:bg-gray-200"
//           }`}
//         >
//           <StickyNote size={14} /> Notes
//         </button>
//       </div>

//       {/* üìÑ Details Tab */}
//       {activeTab === "details" && (
//         <div className="space-y-4">
//           <div className="bg-gray-50 border rounded-md p-3">
//             <h4 className="text-xs font-semibold text-gray-700 mb-1">
//               Conversation
//             </h4>
//             <div className="flex justify-between text-xs text-gray-600">
//               <span>24-hour window:</span>
//               <span className="text-green-600 font-medium">
//                 {chatWindowStatus}
//               </span>
//             </div>
//             <div className="flex justify-between text-xs text-gray-600">
//               <span>Chat session:</span>
//               <span className="text-green-600 font-medium">
//                 {sessionStatus}
//               </span>
//             </div>
//             <div className="flex justify-between text-xs text-gray-600">
//               <span>Window ends:</span>
//               <span>‚Äî</span>
//             </div>
//           </div>

//           <div>
//             <h4 className="text-xs font-semibold text-gray-700 mb-1">
//               Contact data
//             </h4>
//             <div className="text-xs text-gray-600">
//               Created: {createdAt?.slice(0, 10)}
//             </div>
//             <div className="text-xs text-gray-600">List: {list}</div>
//           </div>

//           <div>
//             <h4 className="text-xs font-semibold text-gray-700 mb-1">Tags</h4>
//             {tags.length === 0 ? (
//               <div className="text-gray-400 italic text-xs">No tags</div>
//             ) : (
//               <div className="flex flex-wrap gap-2">
//                 {tags.map(tag => (
//                   <span
//                     key={tag.id}
//                     className="text-xs font-medium px-2 py-1 rounded-full"
//                     style={{
//                       backgroundColor: tag.colorHex || "#999",
//                       color:
//                         tag.colorHex && tag.colorHex.toLowerCase() === "#ffffe0"
//                           ? "#000"
//                           : "#fff",
//                     }}
//                   >
//                     {tag.name}
//                   </span>
//                 ))}
//               </div>
//             )}
//           </div>
//         </div>
//       )}

//       {/* üìù Notes Tab */}
//       {activeTab === "notes" && (
//         <div className="space-y-3">
//           <div className="flex gap-2">
//             <input
//               className="flex-1 px-2 py-1 text-xs border rounded-md"
//               placeholder="Add note..."
//               value={newNote}
//               onChange={e => setNewNote(e.target.value)}
//             />
//             <button
//               onClick={handleAddNote}
//               className="bg-blue-600 text-white text-xs px-3 py-1 rounded-md hover:bg-blue-700"
//             >
//               Add
//             </button>
//           </div>

//           {Array.isArray(notes) && notes.length > 0 ? (
//             <div className="space-y-2 max-h-40 overflow-y-auto">
//               {notes.map(n => (
//                 <div
//                   key={n.id}
//                   className="text-xs text-gray-700 bg-gray-100 rounded-md px-2 py-1"
//                 >
//                   <div>{n.content}</div>
//                   <div className="text-[10px] text-gray-400 mt-1">
//                     {dayjs(n.createdAt).fromNow()}
//                   </div>
//                 </div>
//               ))}
//             </div>
//           ) : (
//             <div className="text-gray-400 italic text-xs">No notes yet</div>
//           )}
//         </div>
//       )}
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\components\EmojiPicker.jsx 
====================================================== 
 
import React, { useEffect, useMemo, useRef, useState } from "react";

// Lightweight emoji set (common, chat-friendly)
const RAW = [
  ["üòÄ", "grinning"],
  ["üòÅ", "beaming"],
  ["üòÇ", "joy"],
  ["ü§£", "rofl"],
  ["üòä", "smile"],
  ["üôÇ", "slight_smile"],
  ["üòâ", "wink"],
  ["üòç", "heart_eyes"],
  ["üòò", "kiss"],
  ["üòã", "yum"],
  ["üòé", "cool"],
  ["ü§©", "star_struck"],
  ["ü•≥", "partying"],
  ["üòá", "innocent"],
  ["ü§ó", "hug"],
  ["üòÖ", "sweat_smile"],
  ["üòå", "relieved"],
  ["üò¥", "sleep"],
  ["ü§î", "think"],
  ["ü§®", "doubt"],
  ["üòê", "neutral"],
  ["üòÆ", "open_mouth"],
  ["üò¢", "cry"],
  ["üò≠", "sob"],
  ["üò°", "angry"],
  ["üò±", "scream"],
  ["ü§Ø", "mind_blown"],
  ["ü§í", "sick"],
  ["ü§ï", "injured"],
  ["ü§ß", "sneeze"],
  ["ü•∂", "cold"],
  ["ü•µ", "hot"],
  ["üëç", "thumbs_up"],
  ["üëé", "thumbs_down"],
  ["üôè", "pray"],
  ["üëè", "clap"],
  ["üôå", "raised_hands"],
  ["ü§ù", "handshake"],
  ["üí™", "muscle"],
  ["ü´∂", "heart_hands"],
  ["‚ù§Ô∏è", "red_heart"],
  ["üíõ", "yellow_heart"],
  ["üíö", "green_heart"],
  ["üíô", "blue_heart"],
  ["üíú", "purple_heart"],
  ["üñ§", "black_heart"],
  ["üíî", "broken_heart"],
  ["‚ú®", "sparkles"],
  ["üî•", "fire"],
  ["‚≠ê", "star"],
  ["‚úÖ", "check"],
  ["‚ùå", "cross"],
  ["‚ö†Ô∏è", "warning"],
  ["‚è≥", "hourglass"],
  ["üìå", "pin"],
  ["üìç", "round_pushpin"],
  ["üìÖ", "calendar"],
  ["üõçÔ∏è", "shopping"],
  ["üí∞", "money"],
  ["üéâ", "tada"],
  ["üéä", "confetti"],
  ["üí¨", "speech"],
  ["‚úâÔ∏è", "envelope"],
  ["üì±", "phone"],
  ["üìû", "telephone"],
  ["‚è∞", "alarm"],
  ["‚åõ", "timer"],
  ["üßæ", "receipt"],
  ["üß∞", "tools"],
  ["üß†", "brain"],
];

const EMOJIS = RAW.map(([char, name]) => ({ char, name }));

export default function EmojiPicker({ onPick, onClose }) {
  const ref = useRef(null);
  const [q, setQ] = useState("");

  // Close on outside click
  useEffect(() => {
    const onDocClick = e => {
      if (!ref.current) return;
      if (!ref.current.contains(e.target)) onClose?.();
    };
    document.addEventListener("mousedown", onDocClick, { capture: true });
    return () =>
      document.removeEventListener("mousedown", onDocClick, { capture: true });
  }, [onClose]);

  const filtered = useMemo(() => {
    const s = q.trim().toLowerCase();
    if (!s) return EMOJIS;
    return EMOJIS.filter(e => e.char.includes(s) || e.name.includes(s));
  }, [q]);

  return (
    <div
      ref={ref}
      className="w-80 rounded-xl border bg-white shadow-lg p-2"
      role="dialog"
      aria-label="Emoji picker"
    >
      <div className="flex items-center gap-2 mb-2">
        <input
          autoFocus
          className="flex-1 border rounded-md px-2 py-1 text-sm"
          placeholder="Search emoji‚Ä¶"
          value={q}
          onChange={e => setQ(e.target.value)}
          onKeyDown={e => {
            if (e.key === "Escape") onClose?.();
          }}
        />
        <button
          className="text-xs text-gray-500 hover:text-gray-700 px-2 py-1"
          onClick={() => onClose?.()}
          type="button"
        >
          Close
        </button>
      </div>

      {/* No scrollbar: wider + more columns + slightly smaller buttons */}
      <div className="grid grid-cols-10 gap-1 overflow-y-hidden">
        {filtered.map(e => (
          <button
            key={e.char + e.name}
            type="button"
            className="h-7 w-7 flex items-center justify-center rounded hover:bg-gray-100"
            title={e.name.replace(/_/g, " ")}
            onClick={() => onPick?.(e.char)}
          >
            <span className="text-lg">{e.char}</span>
          </button>
        ))}
      </div>

      {/* <div className="mt-2 text-[10px] text-gray-400 px-1">
        Tip: you can also use your OS emoji panel (Win + .) / (‚åò Ctrl Space)
      </div> */}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\components\InboxSidebar.jsx 
====================================================== 
 
// ‚úÖ Final Updated InboxSidebar.jsx (auto-mark-read + refresh + sound on new unread)
import React, { useEffect, useState, useCallback } from "react";
import axiosClient from "../../../api/axiosClient";
import useSignalR from "../../../hooks/useSignalR";
import useNotificationSound from "../../../hooks/useNotificationSound"; // ‚¨ÖÔ∏è NEW

export default function InboxSidebar({ onSelect, currentUserId }) {
  const [contacts, setContacts] = useState([]);
  const [selectedId, setSelectedId] = useState(null);
  const [unreadCounts, setUnreadCounts] = useState({});
  const [search, setSearch] = useState("");
  const { connection } = useSignalR();

  // üîî Sound (autoplay-safe + throttled; uses /sounds/inbox_notify.mp3 by default)
  const { play } = useNotificationSound({
    // src: "/sounds/inbox_notify.mp3", // optional (default already this)
    volume: 0.6,
    throttleMs: 800,
  });

  const fetchUnreadCounts = useCallback(async () => {
    try {
      const res = await axiosClient.get("/inbox/unread-counts");
      setUnreadCounts(res.data || {});
      console.log("‚úÖ Unread counts refreshed");
    } catch (err) {
      console.error("‚ùå Failed to refresh unread counts:", err);
    }
  }, []);

  const loadContactsAndUnread = useCallback(async () => {
    try {
      const [contactRes, countRes] = await Promise.all([
        axiosClient.get("/contacts/all"),
        axiosClient.get("/inbox/unread-counts"),
      ]);
      setContacts(contactRes.data || []);
      setUnreadCounts(countRes.data || {});
      console.log("‚úÖ Contacts and unread counts loaded");
    } catch (err) {
      console.error("‚ùå Failed to load inbox data:", err);
    }
  }, []);

  useEffect(() => {
    console.log("üì• InboxSidebar mounted | currentUserId:", currentUserId);
    loadContactsAndUnread();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [currentUserId]);

  useEffect(() => {
    if (!connection) return;

    const handleUnread = payload => {
      console.log("üîî [SignalR] UnreadCountChanged:", payload);

      // server says "refresh your snapshot"
      if (payload && typeof payload === "object" && payload.refresh) {
        fetchUnreadCounts();
        return;
      }

      if (payload && typeof payload === "object") {
        setUnreadCounts(payload);
      }
    };

    connection.on("UnreadCountChanged", handleUnread);
    return () => connection.off("UnreadCountChanged", handleUnread);
  }, [connection, fetchUnreadCounts]);

  useEffect(() => {
    if (!connection) return;

    const handleMessage = async msg => {
      const cid = msg?.contactId ?? msg?.ContactId ?? null;
      if (!cid) return;

      const isIncoming =
        typeof msg?.isIncoming !== "undefined"
          ? !!msg.isIncoming
          : msg?.senderId
          ? false
          : true;

      console.log(
        "üì© [SignalR] Message:",
        msg,
        "| parsed contactId:",
        cid,
        "| isIncoming:",
        isIncoming
      );

      // Never badge on ANY outbound message
      if (!isIncoming) return;

      // If the active chat ‚Üí mark as read immediately
      if (String(cid) === String(selectedId)) {
        try {
          if (connection?.invoke) {
            await connection.invoke("MarkAsRead", cid);
            console.log("‚úÖ MarkAsRead via SignalR for", cid);
          } else {
            await axiosClient.post(`/inbox/mark-read?contactId=${cid}`);
            console.log("‚úÖ MarkAsRead fallback HTTP for", cid);
          }
        } catch (err) {
          console.error("‚ùå Failed to mark as read in active chat:", err);
        }
        return; // do not increment badge or play sound
      }

      // Otherwise, increment unread count for that contact
      setUnreadCounts(prev => ({
        ...(prev || {}),
        [cid]: (prev?.[cid] || 0) + 1,
      }));

      // üîî Play sound only when a new unread is created (non-active chat)
      try {
        play();
      } catch {}
    };

    connection.on("ReceiveInboxMessage", handleMessage);
    return () => connection.off("ReceiveInboxMessage", handleMessage);
  }, [connection, selectedId, currentUserId, play]); // include play in deps

  useEffect(() => {
    if (!connection) return;
    if (typeof connection.onreconnected === "function") {
      connection.onreconnected(() => {
        console.log("üîÅ SignalR reconnected ‚Äî reloading unread counts");
        loadContactsAndUnread();
      });
    }
  }, [connection, loadContactsAndUnread]);

  const handleSelect = async id => {
    setSelectedId(id);
    onSelect(id);

    // Optimistic reset
    setUnreadCounts(prev => ({ ...(prev || {}), [id]: 0 }));

    try {
      if (connection?.invoke) {
        await connection.invoke("MarkAsRead", id);
        console.log("‚úÖ MarkAsRead via SignalR for", id);
        return;
      }
    } catch (err) {
      console.warn("‚ö†Ô∏è SignalR MarkAsRead failed, fallback:", err);
    }

    try {
      await axiosClient.post(`/inbox/mark-read?contactId=${id}`);
      console.log("‚úÖ MarkAsRead fallback HTTP for", id);
    } catch (err) {
      console.error("‚ùå Failed to mark as read via HTTP:", err);
    }
  };

  const getInitials = name =>
    name
      ?.split(" ")
      .map(n => n[0])
      .join("")
      .substring(0, 2)
      .toUpperCase();

  const safeContacts = Array.isArray(contacts) ? contacts : [];
  const filtered = safeContacts.filter(c =>
    (c.name || c.phoneNumber || "")
      .toString()
      .toLowerCase()
      .includes(search.toLowerCase())
  );

  return (
    <div className="flex flex-col h-full">
      <div className="p-3 border-b">
        <input
          type="text"
          placeholder="Search"
          className="w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring"
          value={search}
          onChange={e => setSearch(e.target.value)}
        />
      </div>

      <div className="flex-1 overflow-y-auto">
        <div className="text-sm font-semibold text-gray-700 px-4 py-2">
          Contacts
        </div>
        {filtered.map(contact => {
          const cid = String(contact.id);
          const unread = Number(unreadCounts[cid] || 0);
          return (
            <div
              key={contact.id}
              onClick={() => handleSelect(contact.id)}
              className={`flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-gray-100 ${
                selectedId === contact.id ? "bg-gray-200" : ""
              }`}
            >
              <div className="flex items-center gap-3">
                <div className="w-9 h-9 rounded-full bg-purple-600 text-xs font-semibold flex items-center justify-center text-white">
                  {getInitials(contact.name || contact.phoneNumber)}
                </div>
                <div className="flex flex-col">
                  <div className="font-medium text-sm text-gray-800 truncate">
                    {contact.name || contact.phoneNumber || "Unknown"}
                  </div>
                  {contact.name && (
                    <div className="text-xs text-gray-500">
                      {contact.phoneNumber}
                    </div>
                  )}
                </div>
              </div>
              {unread > 0 && (
                <div className="text-xs bg-purple-600 text-white px-2 py-0.5 rounded-full min-w-[20px] text-center">
                  {unread}
                </div>
              )}
            </div>
          );
        })}
      </div>
    </div>
  );
}

// // ‚úÖ Final Updated InboxSidebar.jsx (active chat auto-mark-read + refresh support)
// import React, { useEffect, useState, useCallback } from "react";
// import axiosClient from "../../../api/axiosClient";
// import useSignalR from "../../../hooks/useSignalR";

// export default function InboxSidebar({ onSelect, currentUserId }) {
//   const [contacts, setContacts] = useState([]);
//   const [selectedId, setSelectedId] = useState(null);
//   const [unreadCounts, setUnreadCounts] = useState({});
//   const [search, setSearch] = useState("");
//   const { connection } = useSignalR();

//   const fetchUnreadCounts = useCallback(async () => {
//     try {
//       const res = await axiosClient.get("/inbox/unread-counts");
//       setUnreadCounts(res.data || {});
//       console.log("‚úÖ Unread counts refreshed");
//     } catch (err) {
//       console.error("‚ùå Failed to refresh unread counts:", err);
//     }
//   }, []);

//   const loadContactsAndUnread = useCallback(async () => {
//     try {
//       const [contactRes, countRes] = await Promise.all([
//         axiosClient.get("/contacts/all"),
//         axiosClient.get("/inbox/unread-counts"),
//       ]);
//       setContacts(contactRes.data || []);
//       setUnreadCounts(countRes.data || {});
//       console.log("‚úÖ Contacts and unread counts loaded");
//     } catch (err) {
//       console.error("‚ùå Failed to load inbox data:", err);
//     }
//   }, []);

//   useEffect(() => {
//     console.log("üì• InboxSidebar mounted | currentUserId:", currentUserId);
//     loadContactsAndUnread();
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, [currentUserId]);

//   useEffect(() => {
//     if (!connection) return;

//     const handleUnread = payload => {
//       console.log("üîî [SignalR] UnreadCountChanged:", payload);

//       // server says "refresh your snapshot"
//       if (payload && typeof payload === "object" && payload.refresh) {
//         fetchUnreadCounts();
//         return;
//       }

//       if (payload && typeof payload === "object") {
//         setUnreadCounts(payload);
//       }
//     };

//     connection.on("UnreadCountChanged", handleUnread);
//     return () => connection.off("UnreadCountChanged", handleUnread);
//   }, [connection, fetchUnreadCounts]);

//   useEffect(() => {
//     if (!connection) return;

//     const handleMessage = async msg => {
//       const cid = msg?.contactId ?? msg?.ContactId ?? null;
//       if (!cid) return;

//       const isIncoming =
//         typeof msg?.isIncoming !== "undefined"
//           ? !!msg.isIncoming
//           : msg?.senderId
//           ? false
//           : true;

//       console.log(
//         "üì© [SignalR] Message:",
//         msg,
//         "| parsed contactId:",
//         cid,
//         "| isIncoming:",
//         isIncoming
//       );

//       // Never badge on ANY outbound message
//       if (!isIncoming) return;

//       // If the active chat ‚Üí mark as read immediately
//       if (String(cid) === String(selectedId)) {
//         try {
//           if (connection?.invoke) {
//             await connection.invoke("MarkAsRead", cid);
//             console.log("‚úÖ MarkAsRead via SignalR for", cid);
//           } else {
//             await axiosClient.post(`/inbox/mark-read?contactId=${cid}`);
//             console.log("‚úÖ MarkAsRead fallback HTTP for", cid);
//           }
//         } catch (err) {
//           console.error("‚ùå Failed to mark as read in active chat:", err);
//         }
//         return; // do not increment badge
//       }

//       // Otherwise, increment unread count for that contact
//       setUnreadCounts(prev => ({
//         ...(prev || {}),
//         [cid]: (prev?.[cid] || 0) + 1,
//       }));
//     };

//     connection.on("ReceiveInboxMessage", handleMessage);
//     return () => connection.off("ReceiveInboxMessage", handleMessage);
//   }, [connection, selectedId, currentUserId]);

//   useEffect(() => {
//     if (!connection) return;
//     if (typeof connection.onreconnected === "function") {
//       connection.onreconnected(() => {
//         console.log("üîÅ SignalR reconnected ‚Äî reloading unread counts");
//         loadContactsAndUnread();
//       });
//     }
//   }, [connection, loadContactsAndUnread]);

//   const handleSelect = async id => {
//     setSelectedId(id);
//     onSelect(id);

//     // Optimistic reset
//     setUnreadCounts(prev => ({ ...(prev || {}), [id]: 0 }));

//     try {
//       if (connection?.invoke) {
//         await connection.invoke("MarkAsRead", id);
//         console.log("‚úÖ MarkAsRead via SignalR for", id);
//         return;
//       }
//     } catch (err) {
//       console.warn("‚ö†Ô∏è SignalR MarkAsRead failed, fallback:", err);
//     }

//     try {
//       await axiosClient.post(`/inbox/mark-read?contactId=${id}`);
//       console.log("‚úÖ MarkAsRead fallback HTTP for", id);
//     } catch (err) {
//       console.error("‚ùå Failed to mark as read via HTTP:", err);
//     }
//   };

//   const getInitials = name =>
//     name
//       ?.split(" ")
//       .map(n => n[0])
//       .join("")
//       .substring(0, 2)
//       .toUpperCase();

//   const safeContacts = Array.isArray(contacts) ? contacts : [];
//   const filtered = safeContacts.filter(c =>
//     (c.name || c.phoneNumber || "")
//       .toString()
//       .toLowerCase()
//       .includes(search.toLowerCase())
//   );

//   return (
//     <div className="w-72 h-full flex flex-col border-r bg-white">
//       <div className="p-3 border-b">
//         <input
//           type="text"
//           placeholder="Search"
//           className="w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring"
//           value={search}
//           onChange={e => setSearch(e.target.value)}
//         />
//       </div>

//       <div className="flex-1 overflow-y-auto">
//         <div className="text-sm font-semibold text-gray-700 px-4 py-2">
//           Contacts
//         </div>
//         {filtered.map(contact => {
//           const cid = String(contact.id);
//           const unread = Number(unreadCounts[cid] || 0);
//           return (
//             <div
//               key={contact.id}
//               onClick={() => handleSelect(contact.id)}
//               className={`flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-gray-100 ${
//                 selectedId === contact.id ? "bg-gray-200" : ""
//               }`}
//             >
//               <div className="flex items-center gap-3">
//                 <div className="w-9 h-9 rounded-full bg-purple-600 text-xs font-semibold flex items-center justify-center text-white">
//                   {getInitials(contact.name || contact.phoneNumber)}
//                 </div>
//                 <div className="flex flex-col">
//                   <div className="font-medium text-sm text-gray-800 truncate">
//                     {contact.name || contact.phoneNumber || "Unknown"}
//                   </div>
//                   {contact.name && (
//                     <div className="text-xs text-gray-500">
//                       {contact.phoneNumber}
//                     </div>
//                   )}
//                 </div>
//               </div>
//               {unread > 0 && (
//                 <div className="text-xs bg-purple-600 text-white px-2 py-0.5 rounded-full min-w-[20px] text-center">
//                   {unread}
//                 </div>
//               )}
//             </div>
//           );
//         })}
//       </div>
//     </div>
//   );
// }

// // ‚úÖ Final Updated InboxSidebar.jsx (active chat auto-mark-read + refresh support)
// import React, { useEffect, useState, useCallback } from "react";
// import axiosClient from "../../../api/axiosClient";
// import useSignalR from "../../../hooks/useSignalR";

// export default function InboxSidebar({ onSelect, currentUserId }) {
//   const [contacts, setContacts] = useState([]);
//   const [selectedId, setSelectedId] = useState(null);
//   const [unreadCounts, setUnreadCounts] = useState({});
//   const [search, setSearch] = useState("");
//   const { connection } = useSignalR();

//   // üîÑ Helper to fetch ONLY unread counts (used by refresh signal)
//   const fetchUnreadCounts = useCallback(async () => {
//     try {
//       const res = await axiosClient.get("/inbox/unread-counts");
//       setUnreadCounts(res.data || {});
//       console.log("‚úÖ Unread counts refreshed");
//     } catch (err) {
//       console.error("‚ùå Failed to refresh unread counts:", err);
//     }
//   }, []);

//   // üîÑ Helper to fetch contacts & unread counts (initial load / reconnect)
//   const loadContactsAndUnread = useCallback(async () => {
//     try {
//       const [contactRes, countRes] = await Promise.all([
//         axiosClient.get("/contacts/all"),
//         axiosClient.get("/inbox/unread-counts"),
//       ]);
//       setContacts(contactRes.data || []);
//       setUnreadCounts(countRes.data || {});
//       console.log("‚úÖ Contacts and unread counts loaded");
//     } catch (err) {
//       console.error("‚ùå Failed to load inbox data:", err);
//     }
//   }, []);

//   useEffect(() => {
//     console.log("üì• InboxSidebar mounted | currentUserId:", currentUserId);
//     loadContactsAndUnread();
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, [currentUserId]);

//   // üì° Listen for server "UnreadCountChanged"
//   useEffect(() => {
//     if (!connection) return;

//     const handleUnread = payload => {
//       console.log("üîî [SignalR] UnreadCountChanged:", payload);

//       // üö¶ Refresh signal from server: { refresh: true }
//       if (payload && typeof payload === "object" && payload.refresh) {
//         fetchUnreadCounts();
//         return;
//       }

//       // Otherwise, payload is a map { [contactId]: count }
//       if (payload && typeof payload === "object") {
//         setUnreadCounts(payload);
//       }
//     };

//     connection.on("UnreadCountChanged", handleUnread);
//     return () => connection.off("UnreadCountChanged", handleUnread);
//   }, [connection, fetchUnreadCounts]);

//   // üì° Listen for incoming messages
//   useEffect(() => {
//     if (!connection) return;

//     const handleMessage = async msg => {
//       const cid = msg?.contactId ?? msg?.ContactId ?? null;
//       if (!cid) return;

//       const isIncoming =
//         typeof msg?.isIncoming !== "undefined"
//           ? !!msg.isIncoming
//           : msg?.senderId
//           ? false
//           : true;

//       console.log(
//         "üì© [SignalR] Message:",
//         msg,
//         "| parsed contactId:",
//         cid,
//         "| isIncoming:",
//         isIncoming
//       );

//       // üîï Never badge on ANY outbound message (self or other agents)
//       if (!isIncoming) {
//         return;
//       }

//       // üü¢ If message is for the currently open chat ‚Üí mark as read immediately
//       if (String(cid) === String(selectedId)) {
//         console.log(
//           "üëÅÔ∏è Message received in active chat, marking as read immediately"
//         );

//         try {
//           if (connection?.invoke) {
//             await connection.invoke("MarkAsRead", cid);
//             console.log("‚úÖ MarkAsRead invoked via SignalR for", cid);
//           } else {
//             await axiosClient.post(`/inbox/mark-read?contactId=${cid}`);
//             console.log("‚úÖ MarkAsRead fallback HTTP for", cid);
//           }
//         } catch (err) {
//           console.error("‚ùå Failed to mark as read in active chat:", err);
//         }

//         return; // don't increment badge
//       }

//       // Otherwise, increment unread count for that contact
//       setUnreadCounts(prev => ({
//         ...(prev || {}),
//         [cid]: (prev?.[cid] || 0) + 1,
//       }));
//     };

//     connection.on("ReceiveInboxMessage", handleMessage);
//     return () => connection.off("ReceiveInboxMessage", handleMessage);
//   }, [connection, selectedId, currentUserId]);

//   // üîÅ Handle reconnects ‚Üí reload contacts + counts (covers missed events)
//   useEffect(() => {
//     if (!connection) return;
//     if (typeof connection.onreconnected === "function") {
//       connection.onreconnected(() => {
//         console.log("üîÅ SignalR reconnected ‚Äî reloading unread counts");
//         loadContactsAndUnread();
//       });
//     }
//   }, [connection, loadContactsAndUnread]);

//   // ‚úÖ Selecting a contact
//   const handleSelect = async id => {
//     setSelectedId(id);
//     onSelect(id);

//     // Optimistic reset
//     setUnreadCounts(prev => ({ ...(prev || {}), [id]: 0 }));

//     try {
//       if (connection?.invoke) {
//         await connection.invoke("MarkAsRead", id);
//         console.log("‚úÖ MarkAsRead invoked via SignalR for", id);
//         return;
//       }
//     } catch (err) {
//       console.warn("‚ö†Ô∏è SignalR MarkAsRead failed, fallback:", err);
//     }

//     try {
//       await axiosClient.post(`/inbox/mark-read?contactId=${id}`);
//       console.log("‚úÖ MarkAsRead fallback HTTP for", id);
//     } catch (err) {
//       console.error("‚ùå Failed to mark as read via HTTP:", err);
//     }
//   };

//   const getInitials = name =>
//     name
//       ?.split(" ")
//       .map(n => n[0])
//       .join("")
//       .substring(0, 2)
//       .toUpperCase();

//   const safeContacts = Array.isArray(contacts) ? contacts : [];
//   const filtered = safeContacts.filter(c =>
//     (c.name || c.phoneNumber || "")
//       .toString()
//       .toLowerCase()
//       .includes(search.toLowerCase())
//   );

//   return (
//     <div className="w-72 h-full flex flex-col border-r bg-white">
//       <div className="p-3 border-b">
//         <input
//           type="text"
//           placeholder="Search"
//           className="w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring"
//           value={search}
//           onChange={e => setSearch(e.target.value)}
//         />
//       </div>

//       <div className="flex-1 overflow-y-auto">
//         <div className="text-sm font-semibold text-gray-700 px-4 py-2">
//           Contacts
//         </div>
//         {filtered.map(contact => {
//           const cid = String(contact.id);
//           const unread = Number(unreadCounts[cid] || 0);
//           return (
//             <div
//               key={contact.id}
//               onClick={() => handleSelect(contact.id)}
//               className={`flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-gray-100 ${
//                 selectedId === contact.id ? "bg-gray-200" : ""
//               }`}
//             >
//               <div className="flex items-center gap-3">
//                 <div className="w-9 h-9 rounded-full bg-purple-600 text-xs font-semibold flex items-center justify-center text-white">
//                   {getInitials(contact.name || contact.phoneNumber)}
//                 </div>
//                 <div className="flex flex-col">
//                   <div className="font-medium text-sm text-gray-800 truncate">
//                     {contact.name || contact.phoneNumber || "Unknown"}
//                   </div>
//                   {contact.name && (
//                     <div className="text-xs text-gray-500">
//                       {contact.phoneNumber}
//                     </div>
//                   )}
//                 </div>
//               </div>
//               {unread > 0 && (
//                 <div className="text-xs bg-purple-600 text-white px-2 py-0.5 rounded-full min-w-[20px] text-center">
//                   {unread}
//                 </div>
//               )}
//             </div>
//           );
//         })}
//       </div>
//     </div>
//   );
// }

// // ‚úÖ Final Updated InboxSidebar.jsx (active chat auto-mark-read)
// import React, { useEffect, useState, useCallback } from "react";
// import axiosClient from "../../../api/axiosClient";
// import useSignalR from "../../../hooks/useSignalR";

// export default function InboxSidebar({ onSelect, currentUserId }) {
//   const [contacts, setContacts] = useState([]);
//   const [selectedId, setSelectedId] = useState(null);
//   const [unreadCounts, setUnreadCounts] = useState({});
//   const [search, setSearch] = useState("");
//   const { connection } = useSignalR();

//   // üîÑ Helper to fetch contacts & unread counts
//   const loadContactsAndUnread = useCallback(async () => {
//     try {
//       const [contactRes, countRes] = await Promise.all([
//         axiosClient.get("/contacts/all"),
//         axiosClient.get("/inbox/unread-counts"),
//       ]);
//       setContacts(contactRes.data || []);
//       setUnreadCounts(countRes.data || {});
//       console.log("‚úÖ Contacts and unread counts loaded");
//     } catch (err) {
//       console.error("‚ùå Failed to load inbox data:", err);
//     }
//   }, []);

//   useEffect(() => {
//     console.log("üì• InboxSidebar mounted | currentUserId:", currentUserId);
//     loadContactsAndUnread();
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, [currentUserId]);

//   // üì° Listen for server "UnreadCountChanged"
//   useEffect(() => {
//     if (!connection) return;

//     const handleUnread = payload => {
//       console.log("üîî [SignalR] UnreadCountChanged:", payload);
//       if (payload && typeof payload === "object") {
//         setUnreadCounts(payload);
//       }
//     };

//     connection.on("UnreadCountChanged", handleUnread);
//     return () => connection.off("UnreadCountChanged", handleUnread);
//   }, [connection]);

//   // üì° Listen for incoming messages
//   useEffect(() => {
//     if (!connection) return;

//     const handleMessage = async msg => {
//       const cid = msg?.contactId ?? msg?.ContactId ?? null;
//       if (!cid) return;

//       const isIncoming =
//         typeof msg?.isIncoming !== "undefined"
//           ? !!msg.isIncoming
//           : msg?.senderId
//           ? false
//           : true;

//       console.log(
//         "üì© [SignalR] Message:",
//         msg,
//         "| parsed contactId:",
//         cid,
//         "| isIncoming:",
//         isIncoming
//       );

//       // Skip self/outgoing messages
//       if (
//         !isIncoming &&
//         msg.senderId &&
//         String(msg.senderId) === String(currentUserId)
//       ) {
//         console.log("‚Ü©Ô∏è Skipping self-sent message");
//         return;
//       }

//       // üü¢ If message is for the currently open chat ‚Üí mark as read immediately
//       if (String(cid) === String(selectedId)) {
//         console.log(
//           "üëÅÔ∏è Message received in active chat, marking as read immediately"
//         );

//         try {
//           if (connection?.invoke) {
//             await connection.invoke("MarkAsRead", cid);
//             console.log("‚úÖ MarkAsRead invoked via SignalR for", cid);
//           } else {
//             await axiosClient.post(`/inbox/mark-read?contactId=${cid}`);
//             console.log("‚úÖ MarkAsRead fallback HTTP for", cid);
//           }
//         } catch (err) {
//           console.error("‚ùå Failed to mark as read in active chat:", err);
//         }

//         return; // don't increment badge
//       }

//       // Otherwise, increment unread count for that contact
//       setUnreadCounts(prev => ({
//         ...prev,
//         [cid]: (prev?.[cid] || 0) + 1,
//       }));
//     };

//     connection.on("ReceiveInboxMessage", handleMessage);
//     return () => connection.off("ReceiveInboxMessage", handleMessage);
//   }, [connection, selectedId, currentUserId]);

//   // üîÅ Handle reconnects ‚Üí reload counts
//   useEffect(() => {
//     if (!connection) return;
//     if (typeof connection.onreconnected === "function") {
//       connection.onreconnected(() => {
//         console.log("üîÅ SignalR reconnected ‚Äî reloading unread counts");
//         loadContactsAndUnread();
//       });
//     }
//   }, [connection, loadContactsAndUnread]);

//   // ‚úÖ Selecting a contact
//   const handleSelect = async id => {
//     setSelectedId(id);
//     onSelect(id);

//     // Optimistic reset
//     setUnreadCounts(prev => ({ ...prev, [id]: 0 }));

//     try {
//       if (connection?.invoke) {
//         await connection.invoke("MarkAsRead", id);
//         console.log("‚úÖ MarkAsRead invoked via SignalR for", id);
//         return;
//       }
//     } catch (err) {
//       console.warn("‚ö†Ô∏è SignalR MarkAsRead failed, fallback:", err);
//     }

//     try {
//       await axiosClient.post(`/inbox/mark-read?contactId=${id}`);
//       console.log("‚úÖ MarkAsRead fallback HTTP for", id);
//     } catch (err) {
//       console.error("‚ùå Failed to mark as read via HTTP:", err);
//     }
//   };

//   const getInitials = name =>
//     name
//       ?.split(" ")
//       .map(n => n[0])
//       .join("")
//       .substring(0, 2)
//       .toUpperCase();

//   const safeContacts = Array.isArray(contacts) ? contacts : [];
//   const filtered = safeContacts.filter(c =>
//     (c.name || c.phoneNumber || "")
//       .toString()
//       .toLowerCase()
//       .includes(search.toLowerCase())
//   );

//   return (
//     <div className="w-72 h-full flex flex-col border-r bg-white">
//       <div className="p-3 border-b">
//         <input
//           type="text"
//           placeholder="Search"
//           className="w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring"
//           value={search}
//           onChange={e => setSearch(e.target.value)}
//         />
//       </div>

//       <div className="flex-1 overflow-y-auto">
//         <div className="text-sm font-semibold text-gray-700 px-4 py-2">
//           Contacts
//         </div>
//         {filtered.map(contact => {
//           const cid = String(contact.id);
//           const unread = Number(unreadCounts[cid] || 0);
//           return (
//             <div
//               key={contact.id}
//               onClick={() => handleSelect(contact.id)}
//               className={`flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-gray-100 ${
//                 selectedId === contact.id ? "bg-gray-200" : ""
//               }`}
//             >
//               <div className="flex items-center gap-3">
//                 <div className="w-9 h-9 rounded-full bg-purple-600 text-xs font-semibold flex items-center justify-center text-white">
//                   {getInitials(contact.name || contact.phoneNumber)}
//                 </div>
//                 <div className="flex flex-col">
//                   <div className="font-medium text-sm text-gray-800 truncate">
//                     {contact.name || contact.phoneNumber || "Unknown"}
//                   </div>
//                   {contact.name && (
//                     <div className="text-xs text-gray-500">
//                       {contact.phoneNumber}
//                     </div>
//                   )}
//                 </div>
//               </div>
//               {unread > 0 && (
//                 <div className="text-xs bg-purple-600 text-white px-2 py-0.5 rounded-full min-w-[20px] text-center">
//                   {unread}
//                 </div>
//               )}
//             </div>
//           );
//         })}
//       </div>
//     </div>
//   );
// }

// // ‚úÖ Final Updated InboxSidebar.jsx
// import React, { useEffect, useState, useCallback } from "react";
// import axiosClient from "../../../api/axiosClient";
// import useSignalR from "../../../hooks/useSignalR";

// export default function InboxSidebar({ onSelect, currentUserId }) {
//   const [contacts, setContacts] = useState([]);
//   const [selectedId, setSelectedId] = useState(null);
//   const [unreadCounts, setUnreadCounts] = useState({});
//   const [search, setSearch] = useState("");
//   const { connection } = useSignalR();

//   // Helper to load contacts + unread counts (used on mount & reconnect)
//   const loadContactsAndUnread = useCallback(async () => {
//     try {
//       const [contactRes, countRes] = await Promise.all([
//         axiosClient.get("/contacts/all"),
//         axiosClient.get("/inbox/unread-counts"),
//       ]);
//       setContacts(contactRes.data || []);
//       setUnreadCounts(countRes.data || {});
//       console.log("‚úÖ Contacts and unread counts loaded");
//     } catch (err) {
//       console.error("‚ùå Failed to load inbox data:", err);
//     }
//   }, []);

//   useEffect(() => {
//     console.log("üì• InboxSidebar mounted | currentUserId:", currentUserId);
//     loadContactsAndUnread();
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, [currentUserId]); // run on mount or when currentUserId changes

//   // Listen for server-side UnreadCountChanged pushes (authoritative state)
//   useEffect(() => {
//     if (!connection) return;

//     const handleUnread = payload => {
//       // payload expected to be a dictionary: { "<contactId>": <count>, ... }
//       console.log("üîî [SignalR] UnreadCountChanged:", payload);
//       if (payload && typeof payload === "object") {
//         setUnreadCounts(payload);
//       }
//     };

//     connection.on("UnreadCountChanged", handleUnread);

//     return () => {
//       connection.off("UnreadCountChanged", handleUnread);
//     };
//   }, [connection]);

//   // Listen for incoming messages and increment unread for the specific contact (optimistic)
//   useEffect(() => {
//     if (!connection) return;

//     const handleMessage = msg => {
//       // Normalize incoming payload fields safely
//       const contactId = msg?.contactId ?? msg?.ContactId ?? null;
//       const isIncoming = (() => {
//         if (typeof msg?.isIncoming !== "undefined") return !!msg.isIncoming;
//         if (typeof msg?.IsIncoming !== "undefined") return !!msg.IsIncoming;
//         // fallback: treat presence of senderId or message from contact as incoming
//         return msg?.senderId ? false : true;
//       })();

//       // choose a stable identifier (string)
//       const cid = contactId ? String(contactId) : null;
//       if (!cid) return;

//       console.log(
//         "üì© [SignalR] Received message:",
//         msg,
//         "parsed contactId:",
//         cid,
//         "isIncoming:",
//         isIncoming
//       );

//       // Don't increment for outgoing / self-sent messages
//       // (some payloads set isIncoming=false for messages sent by this user)
//       if (!isIncoming) {
//         // if the hub sends senderId for outgoing messages, we can check it too:
//         if (msg.senderId && String(msg.senderId) === String(currentUserId)) {
//           console.log("‚Ü©Ô∏è Skipping self-sent message");
//           return;
//         }
//         // otherwise skip any non-incoming message
//         return;
//       }

//       // If the contact is currently open, do not bump unread (they see it)
//       if (cid === selectedId) {
//         console.log("üëÅÔ∏è Contact already open, skipping increment for", cid);
//         return;
//       }

//       // Increment unread for that contact
//       setUnreadCounts(prev => {
//         const prevCount = Number(prev?.[cid] || 0);
//         const next = { ...(prev || {}) };
//         next[cid] = prevCount + 1;
//         console.log(`üî∫ Unread for ${cid} => ${next[cid]}`);
//         return next;
//       });
//     };

//     connection.on("ReceiveInboxMessage", handleMessage);

//     return () => {
//       connection.off("ReceiveInboxMessage", handleMessage);
//     };
//   }, [connection, selectedId, currentUserId]);

//   // On SignalR reconnect, reload authoritative unread counts to avoid missed events
//   useEffect(() => {
//     if (!connection) return;

//     // Some HubConnection implementations provide onreconnected
//     if (typeof connection.onreconnected === "function") {
//       connection.onreconnected(() => {
//         console.log(
//           "üîÅ SignalR reconnected ‚Äî reloading contacts & unread counts"
//         );
//         loadContactsAndUnread();
//       });
//     }

//     // Also handle general reconnect detection if available
//     if (typeof connection.onreconnecting === "function") {
//       connection.onreconnecting(() => {
//         console.log("‚ö†Ô∏è SignalR reconnecting...");
//       });
//     }

//     return () => {
//       try {
//         if (typeof connection.onreconnected === "function") {
//           // no off for onreconnected in some implementations - ignore if unavailable
//         }
//       } catch (e) {}
//     };
//   }, [connection, loadContactsAndUnread]);

//   // Handler when user selects a contact
//   // const handleSelect = async id => {
//   //   setSelectedId(id);
//   //   onSelect(id);

//   //   // Optimistically clear unread badge
//   //   setUnreadCounts(prev => ({ ...(prev || {}), [id]: 0 }));

//   //   // Tell server this user has read messages (preferred: SignalR)
//   //   try {
//   //     if (connection && typeof connection.invoke === "function") {
//   //       await connection.invoke("MarkAsRead", id);
//   //       console.log("‚úÖ MarkAsRead invoked via SignalR for", id);
//   //       return;
//   //     }
//   //   } catch (err) {
//   //     console.warn("‚ö†Ô∏è SignalR MarkAsRead failed, falling back to HTTP:", err);
//   //   }

//   //   // Fallback: HTTP endpoint (keeps backward compatibility)
//   //   try {
//   //     await axiosClient.post(`/inbox/mark-read?contactId=${id}`);
//   //     console.log("‚úÖ Marked messages as read (HTTP) for contact:", id);
//   //   } catch (err) {
//   //     console.error("‚ùå Failed to mark as read via HTTP:", err);
//   //   }
//   // };
//   const handleSelect = async id => {
//     setSelectedId(id);
//     onSelect(id);

//     setUnreadCounts(prev => ({ ...prev, [id]: 0 }));

//     try {
//       if (connection?.invoke) {
//         await connection.invoke("MarkAsRead", id);
//       }
//     } catch {
//       await axiosClient.post(`/inbox/mark-read?contactId=${id}`);
//     }
//   };

//   const getInitials = name =>
//     name
//       ?.split(" ")
//       .map(n => n[0])
//       .join("")
//       .substring(0, 2)
//       .toUpperCase();

//   const safeContacts = Array.isArray(contacts) ? contacts : [];
//   const filtered = safeContacts.filter(c =>
//     (c.name || c.phoneNumber || "")
//       .toString()
//       .toLowerCase()
//       .includes(search.toLowerCase())
//   );

//   return (
//     <div className="w-72 h-full flex flex-col border-r bg-white">
//       <div className="p-3 border-b">
//         <input
//           type="text"
//           placeholder="Search"
//           className="w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring"
//           value={search}
//           onChange={e => setSearch(e.target.value)}
//         />
//       </div>

//       <div className="flex-1 overflow-y-auto">
//         <div className="text-sm font-semibold text-gray-700 px-4 py-2">
//           Contacts
//         </div>
//         {filtered.map(contact => {
//           const cid = String(contact.id);
//           const unread = Number(unreadCounts[cid] || 0);
//           // debug log (can remove later)
//           // console.log(`üîç Rendering ${contact.id} | unread: ${unread}`);
//           return (
//             <div
//               key={contact.id}
//               onClick={() => handleSelect(contact.id)}
//               className={`flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-gray-100 ${
//                 selectedId === contact.id ? "bg-gray-200" : ""
//               }`}
//             >
//               <div className="flex items-center gap-3">
//                 <div className="w-9 h-9 rounded-full bg-purple-600 text-xs font-semibold flex items-center justify-center text-white">
//                   {getInitials(contact.name || contact.phoneNumber)}
//                 </div>
//                 <div className="flex flex-col">
//                   <div className="font-medium text-sm text-gray-800 truncate">
//                     {contact.name || contact.phoneNumber || "Unknown"}
//                   </div>
//                   {contact.name && (
//                     <div className="text-xs text-gray-500">
//                       {contact.phoneNumber}
//                     </div>
//                   )}
//                 </div>
//               </div>
//               {unread > 0 && (
//                 <div className="text-xs bg-purple-600 text-white px-2 py-0.5 rounded-full min-w-[20px] text-center">
//                   {unread}
//                 </div>
//               )}
//             </div>
//           );
//         })}
//       </div>
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Inbox\components\QuickReplyPicker.jsx 
====================================================== 
 
import React, {
  useCallback,
  useEffect,
  useMemo,
  useRef,
  useState,
} from "react";
import axiosClient from "../../../api/axiosClient";

/**
 * QuickReplyPicker
 * Props:
 *  - onInsert(text: string): required
 *  - onClose(): optional
 *  - scope?: "Business" | "Personal" | "All"  // initial view; default "All"
 */
export default function QuickReplyPicker({ onInsert, onClose, scope = "All" }) {
  const containerRef = useRef(null);
  const searchRef = useRef(null);

  const [q, setQ] = useState("");
  const [items, setItems] = useState([]);
  const [loading, setLoading] = useState(false);
  const [activeIndex, setActiveIndex] = useState(-1);

  // scope chips
  const [viewScope, setViewScope] = useState(() => scope || "All");
  const viewScopeParam = useMemo(() => {
    const s = (viewScope || "All").toString().toLowerCase();
    return s === "business" || s === "personal" ? s : "all";
  }, [viewScope]);

  // NEW: create mode
  const [creating, setCreating] = useState(false);
  const [title, setTitle] = useState("");
  const [body, setBody] = useState("");
  const [tagsCsv, setTagsCsv] = useState("");
  const [createScope, setCreateScope] = useState("Personal"); // default personal
  const [saving, setSaving] = useState(false);
  const [saveMsg, setSaveMsg] = useState("");

  // Debounced fetch when search or scope changes
  useEffect(() => {
    if (creating) return; // pause list fetch while creating
    let ignore = false;
    setLoading(true);

    const t = setTimeout(() => {
      const params = {};
      if (q) params.q = q;
      if (viewScopeParam) params.scope = viewScopeParam;

      axiosClient
        .get("/quick-replies", { params })
        .then(res => {
          if (ignore) return;
          setItems(Array.isArray(res.data) ? res.data : []);
          setActiveIndex(-1);
        })
        .catch(() => {
          if (ignore) return;
          setItems([]);
        })
        .finally(() => !ignore && setLoading(false));
    }, 200);

    return () => {
      clearTimeout(t);
      ignore = true;
    };
  }, [q, viewScopeParam, creating]);

  // Autofocus search on open
  useEffect(() => {
    searchRef.current?.focus();
  }, []);

  // Close on click outside
  useEffect(() => {
    const onDocClick = e => {
      if (!containerRef.current) return;
      if (!containerRef.current.contains(e.target)) onClose?.();
    };
    document.addEventListener("mousedown", onDocClick, { capture: true });
    return () =>
      document.removeEventListener("mousedown", onDocClick, { capture: true });
  }, [onClose]);

  const handleInsert = useCallback(
    text => {
      if (!text) return;
      onInsert?.(text);
    },
    [onInsert]
  );

  const handleKeyDown = e => {
    if (e.key === "Escape") {
      e.preventDefault();
      if (creating) {
        setCreating(false);
        return;
      }
      onClose?.();
      return;
    }
    if (creating) return; // no list nav while in create form
    if (e.key === "ArrowDown") {
      e.preventDefault();
      setActiveIndex(i => Math.min(i + 1, Math.max(0, items.length - 1)));
      return;
    }
    if (e.key === "ArrowUp") {
      e.preventDefault();
      setActiveIndex(i => Math.max(i - 1, -1));
      return;
    }
    if (e.key === "Enter") {
      if (activeIndex >= 0 && activeIndex < items.length) {
        e.preventDefault();
        handleInsert(items[activeIndex]?.body);
        onClose?.();
      }
    }
  };

  const handleCreate = async () => {
    setSaveMsg("");
    if (!title.trim() || !body.trim()) {
      setSaveMsg("Title and Body are required.");
      return;
    }
    setSaving(true);
    try {
      const payload = {
        title: title.trim(),
        body: body,
        tagsCsv: tagsCsv.trim() || null,
        scope: createScope === "Business" ? 2 : 0, // enum: Personal=0, Business=2
      };
      const res = await axiosClient.post("/quick-replies", payload);
      const ok = res?.data?.success === true;
      setSaveMsg(ok ? "‚úÖ Saved." : res?.data?.message || "‚ùå Failed to save.");
      if (ok) {
        // reset form and refresh list to created scope
        setTitle("");
        setBody("");
        setTagsCsv("");
        setCreating(false);
        setViewScope(createScope);
        setQ(""); // clear search
      }
    } catch (err) {
      setSaveMsg("‚ùå Failed to save.");
      // optional: console.error(err);
    } finally {
      setSaving(false);
    }
  };

  return (
    <div
      ref={containerRef}
      className="w-80 rounded-xl border bg-white shadow-lg p-2"
      role="dialog"
      aria-label="Quick replies"
    >
      {/* Header row: search + actions */}
      <div className="flex items-center gap-2 mb-2">
        {!creating ? (
          <>
            <input
              ref={searchRef}
              className="flex-1 border rounded-md px-2 py-1 text-sm"
              placeholder="Search saved replies‚Ä¶"
              value={q}
              onChange={e => setQ(e.target.value)}
              onKeyDown={handleKeyDown}
            />
            <button
              className="text-xs px-2 py-1 border rounded-md bg-white hover:bg-gray-50"
              onClick={() => setCreating(true)}
              type="button"
              title="Create a new quick reply"
            >
              New
            </button>
            <button
              className="text-xs text-gray-500 hover:text-gray-700 px-2 py-1"
              onClick={() => onClose?.()}
              type="button"
            >
              Close
            </button>
          </>
        ) : (
          <>
            <div className="text-sm font-medium">New quick reply</div>
            <div className="flex-1" />
            <button
              className="text-xs text-gray-500 hover:text-gray-700 px-2 py-1"
              onClick={() => setCreating(false)}
              type="button"
            >
              Cancel
            </button>
          </>
        )}
      </div>

      {/* Scope chips (list view) OR Create form */}
      {!creating ? (
        <>
          {/* Scope chips */}
          <div className="flex items-center gap-1 mb-2 px-1">
            {["All", "Business", "Personal"].map(s => (
              <button
                key={s}
                type="button"
                onClick={() => setViewScope(s)}
                className={`px-2 py-0.5 text-xs rounded-full border ${
                  viewScope === s ? "bg-gray-200" : "bg-white hover:bg-gray-100"
                }`}
              >
                {s}
              </button>
            ))}
          </div>

          <div className="max-h-64 overflow-y-auto">
            {loading && (
              <div className="text-xs text-gray-500 p-2">Loading‚Ä¶</div>
            )}
            {!loading && items.length === 0 && (
              <div className="text-xs text-gray-500 p-2">No results</div>
            )}

            {!loading &&
              items.map((x, idx) => {
                const isActive = idx === activeIndex;
                return (
                  <button
                    key={x.id}
                    type="button"
                    className={`w-full text-left p-2 rounded-md ${
                      isActive ? "bg-gray-200" : "hover:bg-gray-100"
                    }`}
                    onMouseEnter={() => setActiveIndex(idx)}
                    onClick={() => {
                      handleInsert(x.body);
                      onClose?.();
                    }}
                    title={x.tagsCsv || ""}
                  >
                    <div className="text-sm font-medium text-gray-800">
                      {x.title}
                    </div>
                    <div className="text-xs text-gray-600 line-clamp-2">
                      {x.body}
                    </div>
                    {x.language && (
                      <div className="text-[10px] text-gray-400 mt-1">
                        Lang: {x.language}
                      </div>
                    )}
                  </button>
                );
              })}
          </div>

          <div className="flex items-center justify-between mt-2 px-1">
            <div className="text-[10px] text-gray-400">
              Scope: <span className="uppercase">{viewScopeParam}</span>
            </div>
            <div className="text-[10px] text-gray-400">
              ‚Üë/‚Üì navigate ‚Ä¢ Enter insert ‚Ä¢ Esc close
            </div>
          </div>
        </>
      ) : (
        // CREATE FORM
        <div className="space-y-2">
          <div className="flex items-center gap-2">
            <label className="text-xs text-gray-600 w-16">Scope</label>
            <div className="flex items-center gap-2">
              {["Personal", "Business"].map(s => (
                <label key={s} className="text-xs flex items-center gap-1">
                  <input
                    type="radio"
                    name="qr-scope"
                    value={s}
                    checked={createScope === s}
                    onChange={() => setCreateScope(s)}
                  />
                  {s}
                </label>
              ))}
            </div>
          </div>

          <div className="flex items-center gap-2">
            <label className="text-xs text-gray-600 w-16">Title</label>
            <input
              className="flex-1 border rounded-md px-2 py-1 text-sm"
              value={title}
              onChange={e => setTitle(e.target.value)}
              placeholder="e.g., Greeting (EN)"
            />
          </div>

          <div className="flex items-start gap-2">
            <label className="text-xs text-gray-600 w-16 mt-1">Body</label>
            <textarea
              className="flex-1 border rounded-md px-2 py-1 text-sm h-24"
              value={body}
              onChange={e => setBody(e.target.value)}
              placeholder="Type the message‚Ä¶"
            />
          </div>

          <div className="flex items-center gap-2">
            <label className="text-xs text-gray-600 w-16">Tags</label>
            <input
              className="flex-1 border rounded-md px-2 py-1 text-sm"
              value={tagsCsv}
              onChange={e => setTagsCsv(e.target.value)}
              placeholder="e.g., greeting,eng"
            />
          </div>

          {saveMsg && (
            <div className="text-xs px-2 py-1 rounded-md bg-gray-50 border">
              {saveMsg}
            </div>
          )}

          <div className="flex items-center justify-end gap-2">
            <button
              className="text-xs px-3 py-1 rounded-md border bg-white hover:bg-gray-50"
              onClick={() => setCreating(false)}
              type="button"
              disabled={saving}
            >
              Cancel
            </button>
            <button
              className="text-xs px-3 py-1 rounded-md text-white bg-purple-600 hover:bg-purple-700 disabled:bg-purple-300"
              onClick={handleCreate}
              type="button"
              disabled={saving}
            >
              {saving ? "Saving‚Ä¶" : "Save"}
            </button>
          </div>
        </div>
      )}
    </div>
  );
}

// import React, {
//   useCallback,
//   useEffect,
//   useMemo,
//   useRef,
//   useState,
// } from "react";
// import axiosClient from "../../../api/axiosClient";

// /**
//  * QuickReplyPicker
//  * Props:
//  *  - onInsert(text: string): required
//  *  - onClose(): optional
//  *  - scope?: "Business" | "Personal" | "All"  // acts as the initial scope; default: "All"
//  */
// export default function QuickReplyPicker({ onInsert, onClose, scope = "All" }) {
//   const containerRef = useRef(null);
//   const searchRef = useRef(null);

//   const [q, setQ] = useState("");
//   const [items, setItems] = useState([]);
//   const [loading, setLoading] = useState(false);
//   const [activeIndex, setActiveIndex] = useState(-1);

//   // NEW: local scope state (chips control this)
//   const [viewScope, setViewScope] = useState(() => scope || "All");

//   const viewScopeParam = useMemo(() => {
//     const s = (viewScope || "All").toString().toLowerCase();
//     return s === "business" || s === "personal" ? s : "all";
//   }, [viewScope]);

//   // Debounced fetch when search or scope changes
//   useEffect(() => {
//     let ignore = false;
//     setLoading(true);

//     const t = setTimeout(() => {
//       const params = {};
//       if (q) params.q = q;
//       if (viewScopeParam) params.scope = viewScopeParam;

//       axiosClient
//         .get("/quick-replies", { params })
//         .then(res => {
//           if (ignore) return;
//           setItems(Array.isArray(res.data) ? res.data : []);
//           setActiveIndex(-1);
//         })
//         .catch(() => {
//           if (ignore) return;
//           setItems([]);
//         })
//         .finally(() => !ignore && setLoading(false));
//     }, 200);

//     return () => {
//       clearTimeout(t);
//       ignore = true;
//     };
//   }, [q, viewScopeParam]);

//   // Autofocus search on open
//   useEffect(() => {
//     searchRef.current?.focus();
//   }, []);

//   // Close on click outside
//   useEffect(() => {
//     const onDocClick = e => {
//       if (!containerRef.current) return;
//       if (!containerRef.current.contains(e.target)) onClose?.();
//     };
//     document.addEventListener("mousedown", onDocClick, { capture: true });
//     return () =>
//       document.removeEventListener("mousedown", onDocClick, { capture: true });
//   }, [onClose]);

//   const handleInsert = useCallback(
//     text => {
//       if (!text) return;
//       onInsert?.(text);
//     },
//     [onInsert]
//   );

//   const handleKeyDown = e => {
//     if (e.key === "Escape") {
//       e.preventDefault();
//       onClose?.();
//       return;
//     }
//     if (e.key === "ArrowDown") {
//       e.preventDefault();
//       setActiveIndex(i => Math.min(i + 1, Math.max(0, items.length - 1)));
//       return;
//     }
//     if (e.key === "ArrowUp") {
//       e.preventDefault();
//       setActiveIndex(i => Math.max(i - 1, -1));
//       return;
//     }
//     if (e.key === "Enter") {
//       if (activeIndex >= 0 && activeIndex < items.length) {
//         e.preventDefault();
//         handleInsert(items[activeIndex]?.body);
//         onClose?.();
//       }
//     }
//   };

//   return (
//     <div
//       ref={containerRef}
//       className="w-80 rounded-xl border bg-white shadow-lg p-2"
//       role="dialog"
//       aria-label="Quick replies"
//     >
//       {/* Header row: search + close */}
//       <div className="flex items-center gap-2 mb-2">
//         <input
//           ref={searchRef}
//           className="flex-1 border rounded-md px-2 py-1 text-sm"
//           placeholder="Search saved replies‚Ä¶"
//           value={q}
//           onChange={e => setQ(e.target.value)}
//           onKeyDown={handleKeyDown}
//         />
//         <button
//           className="text-xs text-gray-500 hover:text-gray-700 px-2 py-1"
//           onClick={() => onClose?.()}
//           type="button"
//         >
//           Close
//         </button>
//       </div>

//       {/* NEW: Scope chips inside the picker */}
//       <div className="flex items-center gap-1 mb-2 px-1">
//         {["All", "Business", "Personal"].map(s => (
//           <button
//             key={s}
//             type="button"
//             onClick={() => setViewScope(s)}
//             className={`px-2 py-0.5 text-xs rounded-full border ${
//               viewScope === s ? "bg-gray-200" : "bg-white hover:bg-gray-100"
//             }`}
//           >
//             {s}
//           </button>
//         ))}
//       </div>

//       <div className="max-h-64 overflow-y-auto">
//         {loading && <div className="text-xs text-gray-500 p-2">Loading‚Ä¶</div>}
//         {!loading && items.length === 0 && (
//           <div className="text-xs text-gray-500 p-2">No results</div>
//         )}

//         {!loading &&
//           items.map((x, idx) => {
//             const isActive = idx === activeIndex;
//             return (
//               <button
//                 key={x.id}
//                 type="button"
//                 className={`w-full text-left p-2 rounded-md ${
//                   isActive ? "bg-gray-200" : "hover:bg-gray-100"
//                 }`}
//                 onMouseEnter={() => setActiveIndex(idx)}
//                 onClick={() => {
//                   handleInsert(x.body);
//                   onClose?.();
//                 }}
//                 title={x.tagsCsv || ""}
//               >
//                 <div className="text-sm font-medium text-gray-800">
//                   {x.title}
//                 </div>
//                 <div className="text-xs text-gray-600 line-clamp-2">
//                   {x.body}
//                 </div>
//                 {x.language && (
//                   <div className="text-[10px] text-gray-400 mt-1">
//                     Lang: {x.language}
//                   </div>
//                 )}
//               </button>
//             );
//           })}
//       </div>

//       <div className="flex items-center justify-between mt-2 px-1">
//         <div className="text-[10px] text-gray-400">
//           Scope: <span className="uppercase">{viewScopeParam}</span>
//         </div>
//         <div className="text-[10px] text-gray-400">
//           ‚Üë/‚Üì navigate ‚Ä¢ Enter insert ‚Ä¢ Esc close
//         </div>
//       </div>
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\MessageStatus\StatusTable.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axios from "axios";
// import Spinner from "../../components/common/Spinner";
import { toast } from "react-toastify";

function StatusTable() {
  const [logs, setLogs] = useState([]);
  const [loading, setLoading] = useState(true);

  const businessId = localStorage.getItem("businessId");

  useEffect(() => {
    if (!businessId) {
      toast.error("Business ID not found!");
      return;
    }

    axios
      .get(`/api/message-status?businessId=${businessId}`)
      .then(res => {
        setLogs(res.data);
        setLoading(false);
      })
      .catch(err => {
        toast.error("‚ùå Failed to fetch status logs");
        setLoading(false);
      });
  }, [businessId]);

  const getStatusPill = status => {
    switch (status?.toLowerCase()) {
      case "sent":
        return (
          <span className="px-2 py-1 text-yellow-800 bg-yellow-100 rounded-full text-xs">
            Sent
          </span>
        );
      case "delivered":
        return (
          <span className="px-2 py-1 text-green-800 bg-green-100 rounded-full text-xs">
            Delivered
          </span>
        );
      case "read":
        return (
          <span className="px-2 py-1 text-blue-800 bg-blue-100 rounded-full text-xs">
            Read
          </span>
        );
      case "failed":
        return (
          <span className="px-2 py-1 text-red-800 bg-red-100 rounded-full text-xs">
            Failed
          </span>
        );
      default:
        return (
          <span className="px-2 py-1 text-gray-800 bg-gray-100 rounded-full text-xs">
            Unknown
          </span>
        );
    }
  };

  return (
    <div className="p-6">
      <h2 className="text-xl font-semibold mb-4">üì¨ Message Delivery Status</h2>
      <div className="overflow-x-auto rounded shadow bg-white">
        <table className="min-w-full text-sm table-auto">
          <thead className="bg-gray-100 text-left">
            <tr>
              <th className="p-3">WAMID</th>
              <th className="p-3">Recipient</th>
              <th className="p-3">Status</th>
              <th className="p-3">Sent</th>
              <th className="p-3">Delivered</th>
              <th className="p-3">Read</th>
              <th className="p-3">Error</th>
            </tr>
          </thead>
          <tbody>
            {loading ? (
              <tr>
                <td colSpan={7} className="p-6 text-center text-purple-600">
                  Loading message statuses...
                </td>
              </tr>
            ) : logs.length === 0 ? (
              <tr>
                <td colSpan={7} className="p-6 text-center text-gray-400">
                  No status logs found.
                </td>
              </tr>
            ) : (
              logs.map(log => (
                <tr key={log.messageId} className="border-b">
                  <td className="p-3 font-mono text-xs">{log.messageId}</td>
                  <td className="p-3">{log.recipientNumber}</td>
                  <td className="p-3">{getStatusPill(log.status)}</td>
                  <td className="p-3">{log.sentAt || "-"}</td>
                  <td className="p-3">{log.deliveredAt || "-"}</td>
                  <td className="p-3">{log.readAt || "-"}</td>
                  <td className="p-3 text-red-600 text-xs">
                    {log.errorMessage || "-"}
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}

export default StatusTable;

// import React, { useEffect, useState } from "react";
// import axios from "axios";
// // import Spinner from "../../components/common/Spinner";

// import { toast } from "react-toastify";

// function StatusTable() {
//   const [logs, setLogs] = useState([]);
//   const [loading, setLoading] = useState(true);

//   const businessId = localStorage.getItem("businessId");

//   useEffect(() => {
//     if (!businessId) {
//       toast.error("Business ID not found!");
//       return;
//     }

//     axios
//       .get(`/api/message-status?businessId=${businessId}`)
//       .then(res => {
//         setLogs(res.data);
//         setLoading(false);
//       })
//       .catch(err => {
//         toast.error("‚ùå Failed to fetch status logs");
//         setLoading(false);
//       });
//   }, [businessId]);

//   const getStatusPill = status => {
//     switch (status?.toLowerCase()) {
//       case "sent":
//         return (
//           <span className="px-2 py-1 text-yellow-800 bg-yellow-100 rounded-full text-xs">
//             Sent
//           </span>
//         );
//       case "delivered":
//         return (
//           <span className="px-2 py-1 text-green-800 bg-green-100 rounded-full text-xs">
//             Delivered
//           </span>
//         );
//       case "read":
//         return (
//           <span className="px-2 py-1 text-blue-800 bg-blue-100 rounded-full text-xs">
//             Read
//           </span>
//         );
//       case "failed":
//         return (
//           <span className="px-2 py-1 text-red-800 bg-red-100 rounded-full text-xs">
//             Failed
//           </span>
//         );
//       default:
//         return (
//           <span className="px-2 py-1 text-gray-800 bg-gray-100 rounded-full text-xs">
//             Unknown
//           </span>
//         );
//     }
//   };

//   // if (loading) return <Spinner text="Loading message statuses..." />;

//   return (
//     <div className="p-6">
//       <h2 className="text-xl font-semibold mb-4">üì¨ Message Delivery Status</h2>
//       <div className="overflow-x-auto rounded shadow bg-white">
//         <table className="min-w-full text-sm table-auto">
//           <thead className="bg-gray-100 text-left">
//             <tr>
//               <th className="p-3">WAMID</th>
//               <th className="p-3">Recipient</th>
//               <th className="p-3">Status</th>
//               <th className="p-3">Sent</th>
//               <th className="p-3">Delivered</th>
//               <th className="p-3">Read</th>
//               <th className="p-3">Error</th>
//             </tr>
//           </thead>
//           <tbody>
//             {logs.map(log => (
//               <tr key={log.messageId} className="border-b">
//                 <td className="p-3 font-mono text-xs">{log.messageId}</td>
//                 <td className="p-3">{log.recipientNumber}</td>
//                 <td className="p-3">{getStatusPill(log.status)}</td>
//                 <td className="p-3">{log.sentAt || "-"}</td>
//                 <td className="p-3">{log.deliveredAt || "-"}</td>
//                 <td className="p-3">{log.readAt || "-"}</td>
//                 <td className="p-3 text-red-600 text-xs">
//                   {log.errorMessage || "-"}
//                 </td>
//               </tr>
//             ))}
//           </tbody>
//         </table>
//       </div>
//     </div>
//   );
// }

// export default StatusTable;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\MessageStatus\StatusTracker.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axios from "axios";

function StatusTracker() {
  const [logs, setLogs] = useState([]);

  useEffect(() => {
    const fetchData = async () => {
      const businessId = localStorage.getItem("businessId");
      const res = await axios.get(
        `/api/message-status?businessId=${businessId}`
      );
      if (res.data.success) {
        setLogs(res.data.data);
      }
    };
    fetchData();
  }, []);

  return (
    <div className="bg-white p-6 shadow rounded">
      <h2 className="text-xl font-semibold mb-4">üì© Message Status Tracker</h2>
      <div className="overflow-x-auto">
        <table className="min-w-full border text-sm">
          <thead>
            <tr className="bg-gray-100 text-left">
              <th className="p-2">Recipient</th>
              <th className="p-2">Status</th>
              <th className="p-2">Sent</th>
              <th className="p-2">Delivered</th>
              <th className="p-2">Read</th>
              <th className="p-2">Error</th>
              <th className="p-2">Type</th>
            </tr>
          </thead>
          <tbody>
            {logs.map((log, idx) => (
              <tr key={idx} className="border-t">
                <td className="p-2">{log.recipientNumber}</td>
                <td className="p-2 font-semibold text-purple-700">
                  {log.status}
                </td>
                <td className="p-2">
                  {log.sentAt ? new Date(log.sentAt).toLocaleString() : "-"}
                </td>
                <td className="p-2">
                  {log.deliveredAt
                    ? new Date(log.deliveredAt).toLocaleString()
                    : "-"}
                </td>
                <td className="p-2">
                  {log.readAt ? new Date(log.readAt).toLocaleString() : "-"}
                </td>
                <td className="p-2 text-red-500">{log.errorMessage || "-"}</td>
                <td className="p-2 text-gray-500">{log.messageType}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}

export default StatusTracker;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Messaging\ContactSelector.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";

function ContactSelector({
  onSelectionChange,
  searchQuery,
  selectedSource,
  selectedTags,
}) {
  const [contacts, setContacts] = useState([]);
  const [selectedIds, setSelectedIds] = useState([]);
  const [loadingContacts, setLoadingContacts] = useState(false);

  useEffect(() => {
    fetchContacts();
  }, []);

  const fetchContacts = async () => {
    try {
      setLoadingContacts(true);
      const res = await axiosClient.get("/api/contacts");
      setContacts(res.data || []);
    } catch (err) {
      toast.error("‚ùå Failed to fetch contacts");
      console.error(err);
    } finally {
      setLoadingContacts(false);
    }
  };

  const filtered = contacts.filter(contact => {
    const matchesSearch =
      contact.name?.toLowerCase().includes(searchQuery?.toLowerCase() || "") ||
      contact.phoneNumber?.includes(searchQuery || "") ||
      contact.email?.toLowerCase().includes(searchQuery?.toLowerCase() || "");

    const matchesLead = selectedSource
      ? contact.leadSource === selectedSource
      : true;

    const matchesTags = selectedTags.length
      ? selectedTags.every(tag => contact.tags?.some(t => t.tagName === tag))
      : true;

    return matchesSearch && matchesLead && matchesTags;
  });

  const handleCheckboxChange = (id, checked) => {
    const updated = checked
      ? [...selectedIds, id]
      : selectedIds.filter(i => i !== id);

    setSelectedIds(updated);
    onSelectionChange(filtered.filter(c => updated.includes(c.id)));
  };

  const handleSelectAll = () => {
    const allFilteredIds = filtered.map(c => c.id);
    const allSelected = allFilteredIds.every(id => selectedIds.includes(id));

    const updated = allSelected
      ? selectedIds.filter(id => !allFilteredIds.includes(id))
      : [...new Set([...selectedIds, ...allFilteredIds])];

    setSelectedIds(updated);
    onSelectionChange(filtered.filter(c => updated.includes(c.id)));
  };

  if (loadingContacts) {
    return (
      <div className="flex justify-center items-center py-10 text-gray-600">
        ‚è≥ Loading contacts...
      </div>
    );
  }

  if (!loadingContacts && contacts.length === 0) {
    return (
      <div className="flex justify-center items-center py-10 text-gray-600">
        üòï No contacts available.
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div className="overflow-x-auto rounded-md shadow-sm border border-gray-200">
        <table className="w-full text-sm text-gray-700">
          <thead className="bg-purple-50 text-gray-800 uppercase text-xs tracking-wide">
            <tr>
              <th className="p-2 text-left w-8">
                <input
                  type="checkbox"
                  onChange={handleSelectAll}
                  checked={
                    filtered.length > 0 &&
                    filtered.every(c => selectedIds.includes(c.id))
                  }
                />
              </th>
              <th className="p-2 text-left">Name</th>
              <th className="p-2 text-left">Phone</th>
              <th className="p-2 text-left">Tags</th>
            </tr>
          </thead>
          <tbody>
            {filtered.map((contact, index) => (
              <tr
                key={contact.id}
                className={`border-b border-gray-200 ${
                  index % 2 === 0 ? "bg-gray-50" : ""
                } hover:bg-purple-50`}
              >
                <td className="p-2 text-center">
                  <input
                    type="checkbox"
                    checked={selectedIds.includes(contact.id)}
                    onChange={e =>
                      handleCheckboxChange(contact.id, e.target.checked)
                    }
                  />
                </td>
                <td className="p-2">{contact.name}</td>
                <td className="p-2">{contact.phoneNumber}</td>
                <td className="p-2">
                  {contact.tags?.map(tag => (
                    <span
                      key={tag.tagId}
                      className="inline-block text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded mr-1 mb-1"
                    >
                      {tag.tagName}
                    </span>
                  ))}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      <div className="text-sm text-gray-600 text-right pr-2">
        ‚úÖ {selectedIds.length} selected out of {filtered.length} shown
      </div>
    </div>
  );
}

export default ContactSelector;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Messaging\ExtrackAllFiles.bat 
====================================================== 
 
@echo off
REM This script will find all files and output their name and content into one file.
REM The output file will be named [FolderName]_AllFileDump.txt.

REM Get the current folder's name and set it as the output file name with the custom suffix
for %%I in ("%cd%") do set "outputFile=%%~nI_AllFileDump.txt"

REM Clear the output file to start fresh
> "%outputFile%" (echo Folder and File Content Report)
echo. >> "%outputFile%"

REM Loop through all files in the current directory and subdirectories
for /R . %%F in (*.*) do (
    echo ====================================================== >> "%outputFile%"
    echo FILE: %%F >> "%outputFile%"
    echo ====================================================== >> "%outputFile%"
    echo. >> "%outputFile%"
    type "%%F" >> "%outputFile%" 2>nul
    echo. >> "%outputFile%"
    echo. >> "%outputFile%"
)

echo Finished! All content has been extracted to %outputFile% 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Messaging\MessageComposer.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";
import { MessageType } from "../../constants/messageTypes";

function MessageComposer({ onMessageReady }) {
  const [templates, setTemplates] = useState([]);
  const [templateBody, setTemplateBody] = useState("");
  const [selectedTemplate, setSelectedTemplate] = useState(null);
  const [mode, setMode] = useState(MessageType.Template);

  const [form, setForm] = useState({
    messageType: MessageType.Template,
    templateName: "",
    message: "",
    templateParams: [],
    buttonParams: [],
  });

  // üöÄ Load Templates
  useEffect(() => {
    const loadTemplates = async () => {
      try {
        const businessId = localStorage.getItem("businessId");
        if (!businessId) {
          toast.error("‚ùå BusinessId not found.");
          return;
        }
        const response = await axiosClient.get(
          `/WhatsAppTemplateFetcher/get-template-all/`
        );
        if (response.data.success && Array.isArray(response.data.templates)) {
          setTemplates(response.data.templates);

          if (!form.templateName && response.data.templates.length > 0) {
            // Auto-select first template if none selected
            handleTemplateChange({
              target: { value: response.data.templates[0].name },
            });
          }
        } else {
          toast.error("‚ö†Ô∏è Unexpected templates response format.");
        }
      } catch (err) {
        console.error(err);
        toast.error("‚ùå Failed to load templates.");
      }
    };

    loadTemplates();
    // eslint-disable-next-line
  }, []); // form/templateName intentionally left out for clean mount-only fetch

  // üîç Count placeholder params like {{1}}, {{2}}
  const extractParamCount = body => {
    const matches = body?.match(/{{\d+}}/g) || [];
    return [...new Set(matches)].length;
  };

  // üîÑ Handle template selection
  const handleTemplateChange = e => {
    const selectedName = e.target.value;
    const template = templates.find(t => t.name === selectedName);

    if (!selectedName || !template) {
      toast.warn("‚ö†Ô∏è Please select a valid template.");
      return;
    }

    const body = template.body || "";
    const paramCount = extractParamCount(body);
    const buttonParamCount = template.buttons?.length || 0;

    setForm(prev => ({
      ...prev,
      messageType: MessageType.Template,
      templateName: selectedName,
      message: "",
      templateParams: Array(paramCount).fill(""),
      buttonParams: Array(buttonParamCount).fill(""),
    }));

    setSelectedTemplate(template);
    setTemplateBody(body);
    setMode(MessageType.Template);
  };

  const updateParam = (index, value) => {
    setForm(prev => {
      const updated = [...prev.templateParams];
      updated[index] = value;
      return { ...prev, templateParams: updated };
    });
  };

  const updateButtonParam = (index, value) => {
    setForm(prev => {
      const updated = [...prev.buttonParams];
      updated[index] = value;
      return { ...prev, buttonParams: updated };
    });
  };

  // üîç Live preview generator
  const generatePreview = (template, paramValues) => {
    if (!template) return "";
    return template.replace(/{{(\d+)}}/g, (_, p1) => {
      const index = parseInt(p1, 10) - 1;
      return paramValues[index] || `{{${p1}}}`;
    });
  };

  const previewMessage =
    mode === MessageType.Template
      ? generatePreview(templateBody, form.templateParams)
      : form.message.trim();

  // üîÑ Notify parent of payload
  useEffect(() => {
    if (!onMessageReady) return;

    const hasTemplateParams = form.templateParams.some(
      val => val.trim() !== ""
    );
    const hasButtonParams = form.buttonParams.some(val => val.trim() !== "");

    const payload = {
      messageType: form.messageType,
      templateName: form.templateName,
      messageTemplate: previewMessage,
      templateVariables: hasTemplateParams
        ? Object.fromEntries(
            form.templateParams.map((val, idx) => [`${idx + 1}`, val.trim()])
          )
        : undefined,
      buttonParams: hasButtonParams
        ? form.buttonParams.map(p => p.trim()).filter(Boolean)
        : undefined,
      message: form.message,
    };

    const isValid =
      form.messageType === MessageType.Text
        ? form.message.trim().length > 0
        : form.templateName !== "";

    onMessageReady(isValid ? payload : null);
    // Only depend on form, templateBody, onMessageReady
    // eslint-disable-next-line
  }, [form, templateBody, onMessageReady]);

  return (
    <div className="bg-white p-6 rounded-md shadow space-y-5">
      <h3 className="text-lg font-semibold text-purple-600">
        ‚úçÔ∏è Compose Message
      </h3>

      {/* Mode switch */}
      <div className="flex gap-3">
        <button
          type="button"
          className={`px-4 py-1.5 rounded-md text-sm transition ${
            mode === MessageType.Template
              ? "bg-purple-600 text-white"
              : "bg-gray-200 text-gray-800 hover:bg-gray-300"
          }`}
          onClick={() => {
            setForm({
              messageType: MessageType.Template,
              templateName: "",
              message: "",
              templateParams: [],
              buttonParams: [],
            });
            setSelectedTemplate(null);
            setTemplateBody("");
            setMode(MessageType.Template);
          }}
        >
          Use Template
        </button>

        <button
          type="button"
          className={`px-4 py-1.5 rounded-md text-sm transition ${
            mode === MessageType.Text
              ? "bg-purple-600 text-white"
              : "bg-gray-200 text-gray-800 hover:bg-gray-300"
          }`}
          onClick={() => {
            setForm({
              messageType: MessageType.Text,
              templateName: "",
              message: "",
              templateParams: [],
              buttonParams: [],
            });
            setSelectedTemplate(null);
            setTemplateBody("");
            setMode(MessageType.Text);
          }}
        >
          Free Text
        </button>
      </div>

      {/* Template mode fields */}
      {mode === MessageType.Template && (
        <>
          <select
            value={form.templateName}
            onChange={handleTemplateChange}
            className="w-full border border-gray-300 px-3 py-2 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-purple-400"
          >
            <option value="">-- Select Template --</option>
            {templates.map(t => (
              <option key={t.name} value={t.name}>
                {t.name} ({t.language})
              </option>
            ))}
          </select>

          <div className="text-sm bg-gray-50 p-3 rounded-md border border-gray-300 whitespace-pre-wrap text-gray-700">
            {templateBody || "No template selected"}
          </div>

          {form.templateParams.map((val, idx) => (
            <input
              key={idx}
              type="text"
              value={val}
              onChange={e => updateParam(idx, e.target.value)}
              className="w-full border border-gray-300 px-3 py-2 mt-2 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-purple-400"
              placeholder={`Text Param ${idx + 1}`}
            />
          ))}

          {selectedTemplate?.buttons?.map((btn, idx) => (
            <input
              key={`btn-${idx}`}
              type="text"
              value={form.buttonParams[idx]}
              onChange={e => updateButtonParam(idx, e.target.value)}
              className="w-full border border-purple-300 px-3 py-2 mt-2 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-purple-400"
              placeholder={`Button Param for "${btn.text}"`}
            />
          ))}
        </>
      )}

      {/* Text message mode */}
      {mode === MessageType.Text && (
        <textarea
          rows={4}
          value={form.message}
          onChange={e =>
            setForm(prev => ({ ...prev, message: e.target.value }))
          }
          className="w-full border border-gray-300 px-4 py-2 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-purple-400 resize-none"
          placeholder="Type your WhatsApp message here..."
        />
      )}

      {/* Preview */}
      <div className="bg-gray-50 p-4 rounded-md border border-dashed border-gray-300 text-sm text-gray-700">
        <p className="font-semibold mb-2">üëÅÔ∏è Live Preview</p>
        <p className="whitespace-pre-wrap">{previewMessage}</p>
      </div>
    </div>
  );
}

export default MessageComposer;

// import React, { useEffect, useState } from "react";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import { MessageType } from "../../constants/messageTypes";

// function MessageComposer({ onMessageReady }) {
//   const [templates, setTemplates] = useState([]);
//   const [templateBody, setTemplateBody] = useState("");
//   const [selectedTemplate, setSelectedTemplate] = useState(null);
//   const [mode, setMode] = useState(MessageType.Template);

//   const [form, setForm] = useState({
//     messageType: MessageType.Template,
//     templateName: "",
//     message: "",
//     templateParams: [],
//     buttonParams: [],
//   });

//   // üöÄ Load Templates
//   useEffect(() => {
//     const loadTemplates = async () => {
//       try {
//         const businessId = localStorage.getItem("businessId");
//         if (!businessId) {
//           toast.error("‚ùå BusinessId not found.");
//           return;
//         }

//         const response = await axiosClient.get(
//           `/WhatsAppTemplateFetcher/get-template-all/`
//         );

//         if (response.data.success && Array.isArray(response.data.templates)) {
//           setTemplates(response.data.templates);

//           if (!form.templateName && response.data.templates.length > 0) {
//             handleTemplateChange({
//               target: { value: response.data.templates[0].name },
//             });
//           }
//         } else {
//           toast.error("‚ö†Ô∏è Unexpected templates response format.");
//         }
//       } catch (err) {
//         console.error(err);
//         toast.error("‚ùå Failed to load templates.");
//       }
//     };

//     loadTemplates();
//   }, []);

//   // üîç Count placeholder params like {{1}}, {{2}}
//   const extractParamCount = body => {
//     const matches = body?.match(/{{\d+}}/g) || [];
//     return [...new Set(matches)].length;
//   };

//   // üîÑ Handle template selection
//   const handleTemplateChange = e => {
//     const selectedName = e.target.value;
//     const template = templates.find(t => t.name === selectedName);

//     if (!selectedName || !template) {
//       toast.warn("‚ö†Ô∏è Please select a valid template.");
//       return;
//     }

//     const body = template.body || "";
//     const paramCount = extractParamCount(body);
//     const buttonParamCount = template.buttons?.length || 0;

//     setForm(prev => ({
//       ...prev,
//       messageType: MessageType.Template,
//       templateName: selectedName,
//       message: "",
//       templateParams: Array(paramCount).fill(""),
//       buttonParams: Array(buttonParamCount).fill(""),
//     }));

//     setSelectedTemplate(template);
//     setTemplateBody(body);
//     setMode(MessageType.Template);
//   };

//   const updateParam = (index, value) => {
//     setForm(prev => {
//       const updated = [...prev.templateParams];
//       updated[index] = value;
//       return { ...prev, templateParams: updated };
//     });
//   };

//   const updateButtonParam = (index, value) => {
//     setForm(prev => {
//       const updated = [...prev.buttonParams];
//       updated[index] = value;
//       return { ...prev, buttonParams: updated };
//     });
//   };

//   // üîç Live preview generator
//   const generatePreview = (template, paramValues) => {
//     if (!template) return "";
//     return template.replace(/{{(\d+)}}/g, (_, p1) => {
//       const index = parseInt(p1, 10) - 1;
//       return paramValues[index] || `{{${p1}}}`;
//     });
//   };

//   const previewMessage =
//     mode === MessageType.Template
//       ? generatePreview(templateBody, form.templateParams)
//       : form.message.trim();

//   // üîÑ Notify parent of payload
//   useEffect(() => {
//     if (!onMessageReady) return;

//     const hasTemplateParams = form.templateParams.some(
//       val => val.trim() !== ""
//     );
//     const hasButtonParams = form.buttonParams.some(val => val.trim() !== "");

//     const payload = {
//       messageType: form.messageType,
//       templateName: form.templateName,
//       messageTemplate: previewMessage,
//       templateVariables: hasTemplateParams
//         ? Object.fromEntries(
//             form.templateParams.map((val, idx) => [`${idx + 1}`, val.trim()])
//           )
//         : undefined,
//       buttonParams: hasButtonParams
//         ? form.buttonParams.map(p => p.trim()).filter(Boolean)
//         : undefined,
//       message: form.message,
//     };

//     const isValid =
//       form.messageType === MessageType.Text
//         ? form.message.trim().length > 0
//         : form.templateName !== "";

//     onMessageReady(isValid ? payload : null);
//   }, [form, templateBody, onMessageReady]);

//   return (
//     <div className="bg-white p-6 rounded-md shadow space-y-5">
//       <h3 className="text-lg font-semibold text-purple-600">
//         ‚úçÔ∏è Compose Message
//       </h3>

//       {/* Mode switch */}
//       <div className="flex gap-3">
//         <button
//           type="button"
//           className={`px-4 py-1.5 rounded-md text-sm transition ${
//             mode === MessageType.Template
//               ? "bg-purple-600 text-white"
//               : "bg-gray-200 text-gray-800 hover:bg-gray-300"
//           }`}
//           onClick={() => {
//             setForm({
//               messageType: MessageType.Template,
//               templateName: "",
//               message: "",
//               templateParams: [],
//               buttonParams: [],
//             });
//             setSelectedTemplate(null);
//             setTemplateBody("");
//             setMode(MessageType.Template);
//           }}
//         >
//           Use Template
//         </button>

//         <button
//           type="button"
//           className={`px-4 py-1.5 rounded-md text-sm transition ${
//             mode === MessageType.Text
//               ? "bg-purple-600 text-white"
//               : "bg-gray-200 text-gray-800 hover:bg-gray-300"
//           }`}
//           onClick={() => {
//             setForm({
//               messageType: MessageType.Text,
//               templateName: "",
//               message: "",
//               templateParams: [],
//               buttonParams: [],
//             });
//             setSelectedTemplate(null);
//             setTemplateBody("");
//             setMode(MessageType.Text);
//           }}
//         >
//           Free Text
//         </button>
//       </div>

//       {/* Template mode fields */}
//       {mode === MessageType.Template && (
//         <>
//           <select
//             value={form.templateName}
//             onChange={handleTemplateChange}
//             className="w-full border border-gray-300 px-3 py-2 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-purple-400"
//           >
//             <option value="">-- Select Template --</option>
//             {templates.map(t => (
//               <option key={t.name} value={t.name}>
//                 {t.name} ({t.language})
//               </option>
//             ))}
//           </select>

//           <div className="text-sm bg-gray-50 p-3 rounded-md border border-gray-300 whitespace-pre-wrap text-gray-700">
//             {templateBody || "No template selected"}
//           </div>

//           {form.templateParams.map((val, idx) => (
//             <input
//               key={idx}
//               type="text"
//               value={val}
//               onChange={e => updateParam(idx, e.target.value)}
//               className="w-full border border-gray-300 px-3 py-2 mt-2 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-purple-400"
//               placeholder={`Text Param ${idx + 1}`}
//             />
//           ))}

//           {selectedTemplate?.buttons?.map((btn, idx) => (
//             <input
//               key={`btn-${idx}`}
//               type="text"
//               value={form.buttonParams[idx]}
//               onChange={e => updateButtonParam(idx, e.target.value)}
//               className="w-full border border-purple-300 px-3 py-2 mt-2 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-purple-400"
//               placeholder={`Button Param for "${btn.text}"`}
//             />
//           ))}
//         </>
//       )}

//       {/* Text message mode */}
//       {mode === MessageType.Text && (
//         <textarea
//           rows={4}
//           value={form.message}
//           onChange={e =>
//             setForm(prev => ({ ...prev, message: e.target.value }))
//           }
//           className="w-full border border-gray-300 px-4 py-2 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-purple-400 resize-none"
//           placeholder="Type your WhatsApp message here..."
//         />
//       )}

//       {/* Preview */}
//       <div className="bg-gray-50 p-4 rounded-md border border-dashed border-gray-300 text-sm text-gray-700">
//         <p className="font-semibold mb-2">üëÅÔ∏è Live Preview</p>
//         <p className="whitespace-pre-wrap">{previewMessage}</p>
//       </div>
//     </div>
//   );
// }

// export default MessageComposer;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Messaging\SendMessage.jsx 
====================================================== 
 
import { useState } from "react";
import axiosClient from "../../api/axiosClient"; // ‚úÖ Import your axiosClient

function SendMessage() {
  const [name, setName] = useState("");
  const [phone, setPhone] = useState("");
  const [message, setMessage] = useState("");
  const [success, setSuccess] = useState(false);
  const [error, setError] = useState("");
  const [errorDetail, setErrorDetail] = useState("");

  const handleSubmit = async e => {
    e.preventDefault();

    setSuccess(false);
    setError("");
    setErrorDetail("");

    if (!name || !phone || !message) {
      setError("‚ùå Please fill in all fields.");
      return;
    }

    const payload = {
      recipientNumber: phone,
      messageContent: message,
      businessId: localStorage.getItem("businessId"),
      messageType: "text",
    };

    console.log("Payload being sent:", payload);

    try {
      const response = await axiosClient.post("/messages/send-text", payload);

      if (response.data.success) {
        setSuccess(true);
        setName("");
        setPhone("");
        setMessage("");
      } else {
        setError(response.data.message || "‚ùå Message failed to send.");
        setErrorDetail(
          `üß† Error: ${response.data.error || "Unknown"}\nüì• Raw: ${
            response.data.response || "-"
          }`
        );
      }
    } catch (err) {
      console.error("API Error:", err);
      setError("‚ùå Server error. Please try again.");
    }
  };

  return (
    <div className="max-w-xl mx-auto bg-white p-6 rounded-xl shadow">
      <h2 className="text-2xl font-bold text-purple-600 mb-4">
        Send WhatsApp Message
      </h2>

      {success && (
        <div className="mb-4 text-green-600 font-semibold">
          ‚úÖ Message sent successfully!
        </div>
      )}

      {error && (
        <div className="mb-2 text-red-600 font-semibold whitespace-pre-wrap">
          {error}
        </div>
      )}

      {errorDetail && (
        <pre className="mb-4 text-sm text-red-500 bg-gray-100 p-3 rounded whitespace-pre-wrap">
          {errorDetail}
        </pre>
      )}

      <form onSubmit={handleSubmit} className="space-y-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Customer Name (not sent)
          </label>
          <input
            type="text"
            value={name}
            onChange={e => setName(e.target.value)}
            className="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500"
            placeholder="e.g. Rahul"
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            WhatsApp Number
          </label>
          <input
            type="tel"
            value={phone}
            onChange={e => setPhone(e.target.value)}
            className="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500"
            placeholder="e.g. +919876543210"
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Message
          </label>
          <textarea
            rows="4"
            value={message}
            onChange={e => setMessage(e.target.value)}
            className="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500"
            placeholder="Type your message here..."
          ></textarea>
        </div>

        <button
          type="submit"
          className="w-full bg-purple-600 text-white py-2 rounded-xl hover:bg-purple-700 transition"
        >
          Send Message
        </button>
      </form>
    </div>
  );
}

export default SendMessage;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Messaging\SendMessagePage-Filter.jsx 
====================================================== 
 
import React from "react";

function FilterBar({
  searchQuery,
  onSearchChange,
  selectedSource,
  onSourceChange,
  selectedTags,
  onTagsChange,
}) {
  return (
    <div className="bg-white rounded-lg shadow-md p-4 mb-6">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        {/* üîç Search Input */}
        <input
          type="text"
          value={searchQuery}
          onChange={e => onSearchChange(e.target.value)}
          placeholder="üîç Search name, phone, or email"
          className="w-full border rounded px-2 py-1 text-sm focus:ring-2 focus:ring-purple-500 focus:outline-none hover:border-purple-500"
        />

        {/* üìÇ Source Dropdown */}
        <select
          value={selectedSource}
          onChange={e => onSourceChange(e.target.value)}
          className="w-full border rounded px-2 py-1 text-sm focus:ring-2 focus:ring-purple-500 focus:outline-none hover:border-purple-500"
        >
          <option value="">All Sources</option>
          <option value="crm">CRM</option>
          <option value="catalog">Catalog</option>
          <option value="campaign">Campaign</option>
          {/* Add other sources if needed */}
        </select>

        {/* üè∑Ô∏è Tags Dropdown (Placeholder for multi-select or manual tags) */}
        <input
          type="text"
          value={selectedTags}
          onChange={e => onTagsChange(e.target.value)}
          placeholder="üè∑Ô∏è Filter by Tag (optional)"
          className="w-full border rounded px-2 py-1 text-sm focus:ring-2 focus:ring-purple-500 focus:outline-none hover:border-purple-500"
        />
      </div>
    </div>
  );
}

export default FilterBar;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Messaging\SendMessagePage.jsx 
====================================================== 
 
import React, { useState } from "react";
import { Navigate } from "react-router-dom";
import ContactSelector from "./ContactSelector";
import MessageComposer from "./MessageComposer";
import FilterBar from "./SendMessagePage-Filter";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";

const allowedRoles = ["admin", "superadmin", "partner", "reviewer"];

function SendMessagePage() {
  const [selectedContacts, setSelectedContacts] = useState([]);
  const [messagePayload, setMessagePayload] = useState(null);
  const [submitting, setSubmitting] = useState(false);
  const [searchQuery, setSearchQuery] = useState("");
  const [selectedSource, setSelectedSource] = useState("");
  const [selectedTags, setSelectedTags] = useState("");

  const role = localStorage.getItem("role");
  const businessId = localStorage.getItem("businessId");

  if (!allowedRoles.includes(role)) {
    return <Navigate to="/login" />;
  }

  const handleSend = async () => {
    if (!messagePayload || selectedContacts.length === 0) {
      toast.warn("‚ö†Ô∏è Please select contacts and compose a message.");
      return;
    }

    setSubmitting(true);
    let success = 0;
    let failed = 0;

    for (const contact of selectedContacts) {
      // Dynamically create template parameter dictionary for WhatsApp API
      const templateParamsDict =
        messagePayload.templateParams?.reduce((acc, val, idx) => {
          if (val?.trim()) {
            acc[`{{${idx + 1}}}`] = val.trim();
          }
          return acc;
        }, {}) ?? {};

      const dto = {
        businessId,
        recipientNumber: contact.phoneNumber,
        templateName: messagePayload.templateName,
        templateParameters: templateParamsDict,
        buttonParams: messagePayload.buttonParams ?? [],
      };

      console.log("üì¶ Sending Template DTO:", dto);

      try {
        const res = await axiosClient.post("/messageengine/send-template", dto);
        console.log(
          `‚úÖ Sent to ${contact.name} (${contact.phoneNumber})`,
          res.data
        );
        success++;
      } catch (err) {
        console.error(
          "‚ùå Failed to send to",
          contact.name,
          err?.response?.data ?? err
        );
        failed++;
      }
    }

    toast.success(`‚úÖ Sent: ${success}, ‚ùå Failed: ${failed}`);
    setSelectedContacts([]);
    setMessagePayload(null);
    setSubmitting(false);
  };

  return (
    <div className="max-w-6xl mx-auto p-6 space-y-6">
      <h2 className="text-2xl font-bold text-purple-700 mb-4">
        Send WhatsApp Template Messages
      </h2>

      <FilterBar
        searchQuery={searchQuery}
        onSearchChange={setSearchQuery}
        selectedSource={selectedSource}
        onSourceChange={setSelectedSource}
        selectedTags={selectedTags}
        onTagsChange={setSelectedTags}
      />

      <ContactSelector
        onSelectionChange={setSelectedContacts}
        searchQuery={searchQuery}
        selectedSource={selectedSource}
        selectedTags={selectedTags}
      />

      <div className="text-sm text-gray-600">
        {selectedContacts.length} contacts selected.
      </div>

      <MessageComposer onMessageReady={setMessagePayload} />

      <button
        onClick={handleSend}
        disabled={!selectedContacts.length || !messagePayload || submitting}
        className={`w-full py-3 font-semibold rounded transition ${
          submitting
            ? "bg-gray-400 text-white"
            : "bg-green-600 text-white hover:bg-green-700"
        }`}
      >
        {submitting ? "Sending..." : "Send Template Message"}
      </button>
    </div>
  );
}

export default SendMessagePage;

// import React, { useState } from "react";
// import { Navigate } from "react-router-dom";
// import ContactSelector from "./ContactSelector";
// import MessageComposer from "./MessageComposer";
// import FilterBar from "./SendMessagePage-Filter";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";

// const allowedRoles = ["admin", "superadmin", "partner", "reviewer"];

// function SendMessagePage() {
//   const [selectedContacts, setSelectedContacts] = useState([]);
//   const [messagePayload, setMessagePayload] = useState(null);
//   const [submitting, setSubmitting] = useState(false);
//   const [searchQuery, setSearchQuery] = useState("");
//   const [selectedSource, setSelectedSource] = useState("");
//   const [selectedTags, setSelectedTags] = useState("");

//   const role = localStorage.getItem("role");
//   const businessId = localStorage.getItem("businessId");

//   if (!allowedRoles.includes(role)) {
//     return <Navigate to="/login" />;
//   }

//   // const handleSend = async () => {
//   //   if (!messagePayload || selectedContacts.length === 0) {
//   //     toast.warn("‚ö†Ô∏è Please select contacts and compose a message.");
//   //     return;
//   //   }

//   //   setSubmitting(true);
//   //   let success = 0;
//   //   let failed = 0;

//   //   for (const contact of selectedContacts) {
//   //     const dto = {
//   //       businessId,
//   //       recipientNumber: contact.phoneNumber,
//   //       templateName: messagePayload.templateName,
//   //       templateParameters: messagePayload.templateParams ?? [],
//   //       buttons: (messagePayload.buttonParams ?? []).map((param, idx) => ({
//   //         subType: "url",
//   //         index: `${idx}`,
//   //         param: param,
//   //       })),
//   //       languageCode: "en_US", // required by TemplateMessageDto
//   //     };

//   //     try {
//   //       const res = await axiosClient.post("/messageengine/send-template", dto);
//   //       console.log(`‚úÖ Sent to ${contact.name}`, res.data);
//   //       success++;
//   //     } catch (err) {
//   //       console.error(
//   //         "‚ùå Failed to send to",
//   //         contact.name,
//   //         err?.response?.data ?? err
//   //       );
//   //       failed++;
//   //     }
//   //   }

//   //   toast.success(`‚úÖ Sent: ${success}, ‚ùå Failed: ${failed}`);
//   //   setSelectedContacts([]);
//   //   setMessagePayload(null);
//   //   setSubmitting(false);
//   // };
//   const handleSend = async () => {
//     if (!messagePayload || selectedContacts.length === 0) {
//       toast.warn("‚ö†Ô∏è Please select contacts and compose a message.");
//       return;
//     }

//     setSubmitting(true);
//     let success = 0;
//     let failed = 0;

//     for (const contact of selectedContacts) {
//       const templateParamsDict =
//         messagePayload.templateParams?.reduce((acc, val, idx) => {
//           if (val?.trim()) {
//             acc[`{{${idx + 1}}}`] = val.trim();
//           }
//           return acc;
//         }, {}) ?? {};

//       // const dto = {
//       //   businessId,
//       //   recipientNumber: contact.phoneNumber,
//       //   templateName: messagePayload.templateName,
//       //   templateParameters: templateParamsDict, // ‚úÖ FIXED: now a dictionary
//       //   buttonParams: messagePayload.buttonParams ?? [],
//       // };
//       const dto = {
//         businessId,
//         recipientNumber: contact.phoneNumber,
//         templateName: "verify_account",
//         templateParameters: {
//           "{{1}}": "John",
//           "{{2}}": "123456",
//         },
//         buttonParams: [],
//       };

//       console.log("üì¶ Sending Template DTO:", dto);

//       try {
//         const res = await axiosClient.post("/messageengine/send-template", dto);
//         console.log(
//           `‚úÖ Sent to ${contact.name} (${contact.phoneNumber})`,
//           res.data
//         );
//         success++;
//       } catch (err) {
//         console.error(
//           "‚ùå Failed to send to",
//           contact.name,
//           err?.response?.data ?? err
//         );
//         failed++;
//       }
//     }

//     toast.success(`‚úÖ Sent: ${success}, ‚ùå Failed: ${failed}`);
//     setSelectedContacts([]);
//     setMessagePayload(null);
//     setSubmitting(false);
//   };

//   return (
//     <div className="max-w-6xl mx-auto p-6 space-y-6">
//       <h2 className="text-2xl font-bold text-purple-700 mb-4">
//         Send WhatsApp Template Messages
//       </h2>

//       <FilterBar
//         searchQuery={searchQuery}
//         onSearchChange={setSearchQuery}
//         selectedSource={selectedSource}
//         onSourceChange={setSelectedSource}
//         selectedTags={selectedTags}
//         onTagsChange={setSelectedTags}
//       />

//       <ContactSelector
//         onSelectionChange={setSelectedContacts}
//         searchQuery={searchQuery}
//         selectedSource={selectedSource}
//         selectedTags={selectedTags}
//       />

//       <div className="text-sm text-gray-600">
//         {selectedContacts.length} contacts selected.
//       </div>

//       <MessageComposer onMessageReady={setMessagePayload} />

//       <button
//         onClick={handleSend}
//         disabled={!selectedContacts.length || !messagePayload || submitting}
//         className={`w-full py-3 font-semibold rounded transition ${
//           submitting
//             ? "bg-gray-400 text-white"
//             : "bg-green-600 text-white hover:bg-green-700"
//         }`}
//       >
//         {submitting ? "Sending..." : "Send Template Message"}
//       </button>
//     </div>
//   );
// }

// export default SendMessagePage;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Messaging\TemplateSender.jsx 
====================================================== 
 
import React, { useState, useEffect } from "react";
import axios from "axios";
import { toast } from "react-toastify";

/**
 * This component allows users to send WhatsApp template messages.
 * It fetches template metadata and dynamically adjusts parameter inputs and preview.
 */
function TemplateSender() {
  const [templates, setTemplates] = useState([]);
  const [selected, setSelected] = useState(null);
  const [recipient, setRecipient] = useState("");
  const [params, setParams] = useState([]);

  const businessId =
    localStorage.getItem("businessId") ||
    "68a5b6cd-a420-41d1-9a35-08705748e855"; // fallback for testing

  // üîÅ Fetch template metadata on mount
  useEffect(() => {
    axios
      .get("/api/templates/metadata")
      .then(res => {
        if (res.data.success) {
          setTemplates(res.data.templates);
        } else {
          toast.error("‚ùå Failed to load templates");
        }
      })
      .catch(err => {
        console.error(err);
        toast.error("‚ùå Error fetching templates");
      });
  }, []);

  const handleTemplateChange = name => {
    const tpl = templates.find(t => t.name === name);
    setSelected(tpl);
    setParams(Array(tpl?.placeholderCount || 0).fill(""));
  };

  const handleParamChange = (index, value) => {
    const updated = [...params];
    updated[index] = value;
    setParams(updated);
  };

  const preview = () => {
    if (!selected?.body) return "";
    let rendered = selected.body;
    const regex = /{{(.*?)}}/g;
    let i = 0;
    rendered = rendered.replace(regex, () => {
      const val = params[i] || `[${i + 1}]`;
      i++;
      return val;
    });
    return rendered;
  };

  const handleSubmit = async e => {
    e.preventDefault();

    if (!selected || !recipient) {
      toast.error("‚ö†Ô∏è Fill all required fields");
      return;
    }

    // ‚úÖ Convert [ "Rahul", "Delhi" ] ‚Üí { "1": "Rahul", "2": "Delhi" }
    const parameterMap = {};
    params.forEach((val, i) => {
      parameterMap[(i + 1).toString()] = val;
    });

    const payload = {
      businessId,
      recipientNumber: recipient,
      templateName: selected.name,
      parameters: parameterMap, // ‚úÖ FIXED
      messageType: "template",
    };

    console.log("üì¶ Payload being sent:", payload);

    try {
      const res = await axios.post("/api/messages/send-template", payload);
      toast.success("‚úÖ Message sent successfully");
      console.log("‚úÖ Response:", res.data);
    } catch (err) {
      toast.error("‚ùå Failed to send message");
      console.error("Error:", err.response?.data || err.message);
    }
  };

  return (
    <div className="p-6 max-w-2xl mx-auto">
      <h2 className="text-xl font-bold mb-4 text-purple-700">
        üì© Send Template Message
      </h2>

      <form
        onSubmit={handleSubmit}
        className="space-y-4 bg-white shadow p-4 rounded"
      >
        {/* Template Dropdown */}
        <div>
          <label className="block font-medium mb-1">Template *</label>
          <select
            value={selected?.name || ""}
            onChange={e => handleTemplateChange(e.target.value)}
            className="w-full border px-3 py-2 rounded"
          >
            <option value="">-- Select Template --</option>
            {templates.map(tpl => (
              <option key={tpl.name} value={tpl.name}>
                {tpl.name} ({tpl.language})
              </option>
            ))}
          </select>
        </div>

        {/* Recipient Input */}
        <div>
          <label className="block font-medium mb-1">Recipient Number *</label>
          <input
            type="text"
            value={recipient}
            onChange={e => setRecipient(e.target.value)}
            className="w-full border px-3 py-2 rounded"
            placeholder="+91xxxxxxxxxx"
          />
        </div>

        {/* Dynamic Parameters */}
        {selected?.placeholderCount > 0 && (
          <div>
            <label className="block font-medium mb-1">Parameters</label>
            {params.map((val, idx) => (
              <input
                key={idx}
                type="text"
                value={val}
                onChange={e => handleParamChange(idx, e.target.value)}
                placeholder={`Value for {{${idx + 1}}}`}
                className="w-full mb-2 border px-3 py-2 rounded"
              />
            ))}
          </div>
        )}

        {/* Final Preview */}
        {selected?.body && (
          <div className="bg-gray-100 p-3 rounded text-sm">
            <p className="font-semibold mb-1">üßæ Preview</p>
            <p className="text-gray-700 whitespace-pre-wrap">{preview()}</p>
          </div>
        )}

        <button
          type="submit"
          className="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700"
        >
          üöÄ Send Template
        </button>
      </form>
    </div>
  );
}

export default TemplateSender;

// // File: src/pages/Messaging/TemplateSender.jsx

// import React, { useState, useEffect } from "react";
// import axios from "axios";
// import { toast } from "react-toastify";

// /**
//  * This component allows users to send WhatsApp template messages.
//  * It fetches template metadata from the backend and dynamically adjusts
//  * parameter fields and preview accordingly.
//  */
// function TemplateSender() {
//   const [templates, setTemplates] = useState([]);
//   const [selected, setSelected] = useState(null);
//   const [recipient, setRecipient] = useState("");
//   const [params, setParams] = useState([]);

//   const businessId =
//     localStorage.getItem("businessId") ||
//     "68a5b6cd-a420-41d1-9a35-08705748e855";

//   // üîÅ Fetch template metadata on load
//   useEffect(() => {
//     axios
//       .get("/api/templates/metadata")
//       .then(res => {
//         if (res.data.success) {
//           setTemplates(res.data.templates);
//         } else {
//           toast.error("Failed to load templates");
//         }
//       })
//       .catch(err => {
//         console.error(err);
//         toast.error("Error fetching templates");
//       });
//   }, []);

//   // üîÅ Handle selection
//   const handleTemplateChange = name => {
//     const tpl = templates.find(t => t.name === name);
//     setSelected(tpl);
//     setParams(Array(tpl?.placeholderCount || 0).fill(""));
//   };

//   const handleParamChange = (index, value) => {
//     const updated = [...params];
//     updated[index] = value;
//     setParams(updated);
//   };

//   const preview = () => {
//     if (!selected?.body) return "";
//     let rendered = selected.body;
//     const regex = /{{(.*?)}}/g;
//     let i = 0;
//     rendered = rendered.replace(regex, () => {
//       const val = params[i] || `[${i + 1}]`;
//       i++;
//       return val;
//     });
//     return rendered;
//   };

//   const handleSubmit = async e => {
//     e.preventDefault();

//     if (!selected || !recipient) {
//       toast.error("Fill all required fields");
//       return;
//     }
//     const parameterMap = {};
//     params.forEach((val, i) => {
//       parameterMap[(i + 1).toString()] = val;
//     });
//     const payload = {
//       businessId,
//       recipientNumber: recipient,
//       templateName: selected.name,
//       languageCode: selected.language,
//       parameters: parameterMap, // ‚úÖ FIXED HERE
//       templateParameters: params,
//       messageType: "template",
//     };

//     try {
//       const res = await axios.post("/api/messages/send-template", payload);
//       toast.success("‚úÖ Message sent successfully");
//       console.log(res.data);
//     } catch (err) {
//       toast.error("‚ùå Failed to send message");
//       console.error(err);
//     }
//   };

//   return (
//     <div className="p-6 max-w-2xl mx-auto">
//       <h2 className="text-xl font-bold mb-4">üì© Send Template Message</h2>
//       <form
//         onSubmit={handleSubmit}
//         className="space-y-4 bg-white shadow p-4 rounded"
//       >
//         {/* Template Dropdown */}
//         <div>
//           <label className="block font-medium mb-1">Template *</label>
//           <select
//             value={selected?.name || ""}
//             onChange={e => handleTemplateChange(e.target.value)}
//             className="w-full border px-3 py-2 rounded"
//           >
//             <option value="">-- Select Template --</option>
//             {templates.map(tpl => (
//               <option key={tpl.name} value={tpl.name}>
//                 {tpl.name} ({tpl.language})
//               </option>
//             ))}
//           </select>
//         </div>

//         {/* Recipient Input */}
//         <div>
//           <label className="block font-medium mb-1">Recipient Number *</label>
//           <input
//             type="text"
//             value={recipient}
//             onChange={e => setRecipient(e.target.value)}
//             className="w-full border px-3 py-2 rounded"
//             placeholder="+91xxxxxxxxxx"
//           />
//         </div>

//         {/* Dynamic Parameters */}
//         {selected?.placeholderCount > 0 && (
//           <div>
//             <label className="block font-medium mb-1">Parameters</label>
//             {params.map((val, idx) => (
//               <input
//                 key={idx}
//                 type="text"
//                 value={val}
//                 onChange={e => handleParamChange(idx, e.target.value)}
//                 placeholder={`Value for {{${idx + 1}}}`}
//                 className="w-full mb-2 border px-3 py-2 rounded"
//               />
//             ))}
//           </div>
//         )}

//         {/* Final Preview */}
//         {selected?.body && (
//           <div className="bg-gray-100 p-3 rounded text-sm">
//             <p className="font-semibold mb-1">üßæ Preview</p>
//             <p className="text-gray-700 whitespace-pre-wrap">{preview()}</p>
//           </div>
//         )}

//         <button
//           type="submit"
//           className="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700"
//         >
//           üöÄ Send Template
//         </button>
//       </form>
//     </div>
//   );
// }

// export default TemplateSender;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\MetaAccount\MetaAccountManagement.jsx 
====================================================== 
 
// // üìÑ src/pages/MetaAccount/MetaAccountManagement.jsx

import React, { useEffect, useState, useMemo } from "react";
import { useNavigate } from "react-router-dom";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";
import { useAuth } from "../../app/providers/AuthProvider";
import { ShieldAlert, Trash2, RefreshCw } from "lucide-react";

// --- JWT businessId helper (aligned with ClaimsBusinessDetails) ---
const TOKEN_KEY = "xbyte_token";
const GUID_RE =
  /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;

function getBusinessIdFromJwt() {
  try {
    const jwt = localStorage.getItem(TOKEN_KEY);
    if (!jwt) return null;

    const [, payloadB64] = jwt.split(".");
    if (!payloadB64) return null;

    const payload = JSON.parse(
      atob(payloadB64.replace(/-/g, "+").replace(/_/g, "/"))
    );

    const bid = payload?.businessId || payload?.BusinessId || null;

    return typeof bid === "string" && GUID_RE.test(bid) ? bid : null;
  } catch {
    return null;
  }
}

export default function MetaAccountManagement() {
  const { business, hasAllAccess } = useAuth();
  const nav = useNavigate();

  const [loading, setLoading] = useState(false);
  const [connectingEsu, setConnectingEsu] = useState(false);
  const [statusLoading, setStatusLoading] = useState(true);
  const [status, setStatus] = useState(null);

  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [deleteConfirmChecked, setDeleteConfirmChecked] = useState(false);
  const [deleteLoading, setDeleteLoading] = useState(false);

  const isDev = process.env.NODE_ENV === "development";

  // Prefer AuthProvider if present, otherwise JWT claim
  const authBusinessId =
    business?.id || business?.businessId || business?.BusinessId || null;

  const jwtBusinessId = useMemo(getBusinessIdFromJwt, []);
  const effectiveBusinessId = authBusinessId || jwtBusinessId;
  const hasBusinessContext = !!effectiveBusinessId;

  // ------- Load ESU status (JWT-based) -------
  const loadStatus = async () => {
    try {
      setStatusLoading(true);

      // Backend: GET /api/esu/facebook/status uses JWT to resolve businessId
      const res = await axiosClient.get("esu/facebook/status");
      const payload = res?.data ?? null;
      const data = payload?.data || payload?.Data || payload;

      setStatus(data || null);
    } catch (err) {
      console.error("Failed to load ESU status", err);
      setStatus(null);
    } finally {
      setStatusLoading(false);
    }
  };

  useEffect(() => {
    loadStatus();
  }, []);

  // ------- Normalized status -------
  const hasEsuFlag = status?.hasEsuFlag ?? status?.HasEsuFlag ?? false;

  const tokenExpiresAtRaw =
    status?.tokenExpiresAtUtc ??
    status?.TokenExpiresAtUtc ??
    status?.accessTokenExpiresAtUtc ??
    status?.AccessTokenExpiresAtUtc ??
    null;

  const hasValidToken =
    status?.hasValidToken ??
    status?.HasValidToken ??
    (tokenExpiresAtRaw ? true : false);

  const willExpireSoon =
    status?.willExpireSoon ??
    status?.WillExpireSoon ??
    status?.isExpiringSoon ??
    status?.IsExpiringSoon ??
    false;

  const debugMessage = status?.debug ?? status?.Debug ?? null;

  const isConfiguredViaEsu = !!hasEsuFlag;
  const isTokenExpiredOrInvalid = isConfiguredViaEsu && !hasValidToken;
  const isTokenExpiringSoon = !!hasValidToken && willExpireSoon;
  const isFullyHealthy = isConfiguredViaEsu && hasValidToken && !willExpireSoon;

  const formattedExpiry = tokenExpiresAtRaw
    ? new Date(tokenExpiresAtRaw).toLocaleString()
    : null;

  // "Any integration present?" ‚Äî drives button enabling
  const hasAnyIntegrationState =
    isConfiguredViaEsu || hasValidToken || !!tokenExpiresAtRaw;

  const canSoftDisconnect = hasBusinessContext && hasAnyIntegrationState;
  const canHardDelete = hasBusinessContext && hasAnyIntegrationState;

  // ------- ESU: Start / Generate / Manage -------
  const startFacebookEsu = async () => {
    if (!hasBusinessContext) {
      toast.error("Workspace context missing. Please log in again.");
      return;
    }

    try {
      setConnectingEsu(true);

      const res = await axiosClient.post("esu/facebook/start", {
        returnUrlAfterSuccess: "/app/settings/whatsapp",
      });

      const authUrl =
        res?.data?.data?.authUrl ||
        res?.data?.authUrl ||
        res?.data?.url ||
        res?.data?.Data?.AuthUrl;

      if (!authUrl) {
        toast.error(
          res?.data?.message || "Could not get Meta Embedded Signup URL."
        );
        return;
      }

      window.location.href = authUrl;
    } catch (err) {
      console.error("ESU start failed", err);
      toast.error("Failed to start Meta Embedded Signup.");
    } finally {
      setConnectingEsu(false);
    }
  };

  // ------- Disconnect (soft) -------
  const handleDisconnect = async () => {
    if (!hasBusinessContext) {
      toast.error("Workspace context missing. Please re-login.");
      return;
    }

    // If no integration state, treat as no-op with clear UX
    if (!hasAnyIntegrationState) {
      toast.info(
        "No active WhatsApp Business API connection found for this workspace."
      );
      return;
    }

    try {
      setLoading(true);
      const res = await axiosClient.delete("esu/facebook/disconnect");

      if (res?.data?.ok ?? true) {
        toast.success("WhatsApp disconnected successfully for this workspace.");
      } else {
        toast.error(
          res?.data?.message ||
            "Failed to disconnect. Please check logs or contact support."
        );
      }

      await loadStatus();
    } catch (err) {
      console.error("Disconnect failed", err);
      const message =
        err?.response?.data?.message ||
        "Failed to disconnect. Please check logs or contact support.";
      toast.error(message);
    } finally {
      setLoading(false);
    }
  };

  // ------- Deauthorize (debug) -------
  const handleDeauthorize = async () => {
    if (!hasBusinessContext) {
      toast.error("Workspace context missing. Please re-login.");
      return;
    }

    try {
      setLoading(true);
      await axiosClient.post("esu/facebook/debug/deauthorize");
      toast.success("Local deauthorization complete (debug/internal).");
      await loadStatus();
    } catch (err) {
      console.error("Deauthorize failed", err);
      toast.error("Deauthorize failed or endpoint disabled.");
    } finally {
      setLoading(false);
    }
  };

  // ------- Hard delete: modal + action -------
  const openDeleteModal = () => {
    if (!hasBusinessContext) {
      toast.error("Workspace context missing. Please re-login.");
      return;
    }

    if (!hasAnyIntegrationState) {
      toast.info(
        "No Meta WhatsApp onboarding data is stored for this workspace."
      );
      return;
    }

    setDeleteConfirmChecked(false);
    setShowDeleteModal(true);
  };

  const closeDeleteModal = () => {
    if (!deleteLoading) {
      setShowDeleteModal(false);
    }
  };

  const handlePermanentDelete = async () => {
    if (!hasBusinessContext) {
      toast.error("Workspace context missing. Please re-login.");
      return;
    }
    if (!deleteConfirmChecked) {
      return;
    }
    if (!hasAnyIntegrationState) {
      toast.info(
        "No Meta WhatsApp onboarding data is stored for this workspace."
      );
      setShowDeleteModal(false);
      return;
    }

    try {
      setDeleteLoading(true);

      // Use your configured hard-delete endpoint
      const res = await axiosClient.delete(
        "esu/facebook/hard-delete-full-account"
      );

      if (res?.data?.ok) {
        toast.success(
          "Meta WhatsApp onboarding configuration and related data have been deleted for this workspace."
        );
        setShowDeleteModal(false);
        await loadStatus();
      } else {
        toast.error(
          res?.data?.message ||
            "Failed to delete WhatsApp data. Please contact support."
        );
      }
    } catch (err) {
      console.error("Hard delete failed", err);
      const message =
        err?.response?.data?.message ||
        "Failed to delete WhatsApp data. Please contact support.";
      toast.error(message);
    } finally {
      setDeleteLoading(false);
    }
  };

  // ------- Status Panel -------
  const renderStatusPanel = () => {
    const isConfigured = isConfiguredViaEsu;
    const borderClass = isConfigured
      ? "border-l-emerald-500"
      : "border-l-rose-500";
    const headerBg = isConfigured
      ? "bg-emerald-50 border-b border-emerald-100"
      : "bg-rose-50 border-b border-rose-100";
    const titleColor = isConfigured ? "text-emerald-700" : "text-rose-700";
    const dotColor = isConfigured ? "bg-emerald-500" : "bg-rose-500";

    let primaryLabel = "Connect via Facebook";
    if (isConfigured && (isTokenExpiredOrInvalid || isTokenExpiringSoon)) {
      primaryLabel = "Generate Token";
    } else if (isConfigured) {
      primaryLabel = "Manage Connection";
    }

    return (
      <div
        className={`mb-8 rounded-2xl shadow-sm border-l-8 ${borderClass} bg-gradient-to-br from-white to-slate-50`}
      >
        <div className={`rounded-t-2xl px-5 py-3 ${headerBg}`}>
          <div className="text-xs uppercase tracking-wide font-semibold text-slate-500">
            Connection Status
          </div>
        </div>

        <div className="p-5 flex flex-col gap-2">
          {statusLoading ? (
            <div className="h-4 w-40 bg-slate-100 rounded animate-pulse mt-1" />
          ) : (
            <>
              <div
                className={`inline-flex items-center gap-2 text-base font-semibold ${titleColor}`}
              >
                <span className={`h-2.5 w-2.5 rounded-full ${dotColor}`} />
                {isConfigured
                  ? "Connected via Meta Embedded Signup"
                  : "Not connected"}
              </div>

              {!isConfigured && (
                <div className="text-sm text-slate-600">
                  WhatsApp Business Account <strong>Disconnected</strong>. No
                  active Meta Embedded Signup connection detected for this
                  workspace.
                </div>
              )}

              {isConfigured && (
                <>
                  {isFullyHealthy && (
                    <div className="text-sm text-slate-600">
                      WhatsApp API is configured and active for this workspace.
                    </div>
                  )}

                  {isTokenExpiredOrInvalid && (
                    <div className="text-sm text-rose-700 bg-rose-50 border border-rose-200 px-3 py-2 rounded-md mt-1">
                      <span className="font-semibold">Token expired:</span> Your
                      Meta access token is no longer valid. Click{" "}
                      <span className="font-semibold">‚ÄúGenerate Token‚Äù</span>{" "}
                      below to create a new long-lived token via Meta.
                    </div>
                  )}

                  {isTokenExpiringSoon && (
                    <div className="text-sm text-amber-700 bg-amber-50 border border-amber-200 px-3 py-2 rounded-md mt-1">
                      Your Meta access token will expire soon. Use{" "}
                      <span className="font-semibold">‚ÄúGenerate Token‚Äù</span> to
                      renew it before expiry.
                    </div>
                  )}

                  {formattedExpiry && (
                    <div className="text-xs text-slate-500">
                      Token expiry: {formattedExpiry}
                    </div>
                  )}
                </>
              )}

              {(isDev || hasAllAccess) &&
                (debugMessage ||
                  typeof hasEsuFlag === "boolean" ||
                  typeof hasValidToken === "boolean") && (
                  <div className="text-[10px] text-slate-500 mt-1">
                    {debugMessage && <div>Debug: {debugMessage}</div>}
                    <div>HasEsuFlag: {String(hasEsuFlag)}</div>
                    <div>HasValidToken: {String(hasValidToken)}</div>
                  </div>
                )}

              {/* Primary action */}
              <div className="mt-3 flex flex-wrap gap-2 flex-col sm:flex-row">
                <button
                  type="button"
                  onClick={startFacebookEsu}
                  disabled={connectingEsu || !hasBusinessContext}
                  className="inline-flex items-center justify-center gap-2 px-3 py-2 rounded-md text-xs font-semibold bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60"
                >
                  {connectingEsu ? "Opening Embedded Signup‚Ä¶" : primaryLabel}
                </button>
              </div>
            </>
          )}
        </div>
      </div>
    );
  };

  // ------- Render -------
  return (
    <div className="p-6 max-w-3xl mx-auto">
      <h1 className="text-2xl font-bold text-emerald-800 mb-2">
        Meta Account Management
      </h1>
      <p className="text-sm text-slate-600 mb-6">
        Control how this workspace is connected to Meta&apos;s WhatsApp Business
        Platform. Use these options to connect or disconnect safely, review how
        data deletion is handled, and (for internal admins) trigger local
        deauthorization.
      </p>

      {renderStatusPanel()}

      <div className="space-y-6">
        {/* Soft disconnect */}
        <button
          type="button"
          onClick={handleDisconnect}
          disabled={loading || !canSoftDisconnect}
          className={`w-full flex items-center gap-3 rounded-xl border p-4 text-left transition bg-white border-emerald-200 ${
            loading || !canSoftDisconnect
              ? "opacity-60 cursor-not-allowed"
              : "hover:shadow-md"
          }`}
        >
          <div className="p-2 rounded-md bg-emerald-50 text-emerald-700">
            <ShieldAlert size={20} />
          </div>
          <div>
            <div className="font-semibold text-emerald-800">
              Disconnect WhatsApp Business API Account
            </div>
            <div className="text-sm text-slate-600">
              {canSoftDisconnect
                ? "Runs the full disconnect pipeline for this workspace: best-effort revoke at Meta, local token/flag cleanup, and deactivation of WhatsApp sending."
                : "No active WhatsApp Business API integration is connected for this workspace."}
            </div>
          </div>
        </button>

        {/* Debug-only deauthorize */}
        {(isDev || hasAllAccess) && (
          <button
            type="button"
            onClick={handleDeauthorize}
            disabled={loading || !hasBusinessContext}
            className={`w-full flex items-center gap-3 rounded-xl border p-4 text-left transition bg-white border-yellow-200 ${
              loading || !hasBusinessContext
                ? "opacity-60 cursor-not-allowed"
                : "hover:shadow-md"
            }`}
          >
            <div className="p-2 rounded-md bg-yellow-50 text-yellow-700">
              <RefreshCw size={20} />
            </div>
            <div>
              <div className="font-semibold text-yellow-800">
                Deauthorize (Local Debug)
              </div>
              <div className="text-sm text-slate-600">
                Clears ESU flags and stored tokens locally for this workspace.
              </div>
            </div>
          </button>
        )}

        {/* Hard delete CTA */}
        <button
          type="button"
          onClick={openDeleteModal}
          disabled={!canHardDelete}
          className={`w-full flex items-center gap-3 rounded-xl border p-4 text-left transition bg-white border-rose-300 ${
            !canHardDelete ? "opacity-60 cursor-not-allowed" : "hover:shadow-md"
          }`}
        >
          <div className="p-2 rounded-md bg-rose-50 text-rose-700">
            <Trash2 size={20} />
          </div>
          <div>
            <div className="font-semibold text-rose-800">
              Delete my account and WhatsApp data
            </div>
            <div className="text-sm text-slate-600">
              {canHardDelete
                ? "Permanently disconnect your Meta WhatsApp integration and delete related onboarding configuration for this workspace. This cannot be undone."
                : "No Meta WhatsApp integration or onboarding data exists for this workspace."}
            </div>
          </div>
        </button>
      </div>

      {/* Delete confirmation modal */}
      {showDeleteModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
          <div className="bg-white rounded-2xl max-w-md w-full p-6 shadow-xl">
            <h2 className="text-lg font-semibold text-rose-700 mb-2">
              Permanently delete WhatsApp integration?
            </h2>
            <p className="text-sm text-slate-700 mb-3">This will:</p>
            <ul className="list-disc list-inside text-sm text-slate-700 mb-3">
              <li>Disconnect your WhatsApp Business API integration.</li>
              <li>Revoke Meta ESU / access tokens.</li>
              <li>
                Delete stored Meta WhatsApp onboarding settings (WABA, numbers,
                API keys, webhooks) for this workspace.
              </li>
            </ul>
            <p className="text-xs text-rose-700 font-medium mb-3">
              This action is permanent and cannot be undone.
            </p>

            <label className="flex items-start gap-2 mb-4">
              <input
                type="checkbox"
                className="mt-1"
                checked={deleteConfirmChecked}
                onChange={e => setDeleteConfirmChecked(e.target.checked)}
                disabled={deleteLoading}
              />
              <span className="text-xs text-slate-700">
                I understand that my Meta WhatsApp integration and related
                onboarding data for this workspace will be deleted permanently
                and cannot be recovered.
              </span>
            </label>

            <div className="flex justify-end gap-2">
              <button
                type="button"
                onClick={closeDeleteModal}
                disabled={deleteLoading}
                className="px-3 py-2 rounded-md text-xs font-semibold border border-slate-200 text-slate-700 hover:bg-slate-50 disabled:opacity-60"
              >
                Cancel
              </button>
              <button
                type="button"
                onClick={handlePermanentDelete}
                disabled={!deleteConfirmChecked || deleteLoading}
                className="px-4 py-2 rounded-md text-xs font-semibold bg-rose-600 text-white hover:bg-rose-700 disabled:opacity-50"
              >
                {deleteLoading ? "Deleting..." : "Delete permanently"}
              </button>
            </div>
          </div>
        </div>
      )}

      <div className="mt-8">
        <button
          type="button"
          onClick={() => nav("/app/settings")}
          className="text-sm text-emerald-700 hover:underline"
        >
          ‚Üê Back to Settings
        </button>
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Monitoring\CampaignProgressPage.jsx 
====================================================== 
 
import React, { useEffect, useMemo, useRef, useState } from "react";
import { useParams } from "react-router-dom";
import { toast } from "react-toastify";
import axiosClient from "../../api/axiosClient";
import {
  Loader2,
  RefreshCcw,
  Play,
  Pause,
  TrendingUp,
  CheckCircle2,
  AlertTriangle,
  Clock,
  Gauge,
  Target,
  PhoneOutgoing,
  Activity,
} from "lucide-react";
import {
  Area,
  AreaChart,
  CartesianGrid,
  Line,
  LineChart,
  ResponsiveContainer,
  Tooltip,
  XAxis,
  YAxis,
  Legend,
} from "recharts";

// ---- helpers ----
const nf = new Intl.NumberFormat();
const pf = new Intl.NumberFormat(undefined, { maximumFractionDigits: 2 });

function fmtMs(v) {
  if (v == null) return "‚Äì";
  if (v < 1000) return `${Math.round(v)} ms`;
  const s = v / 1000;
  if (s < 60) return `${pf.format(s)} s`;
  return `${pf.format(s / 60)} min`;
}

function tsLabel(iso) {
  if (!iso) return "‚Äì";
  try {
    return new Date(iso).toLocaleString();
  } catch {
    return iso;
  }
}

function ProgressBar({ value }) {
  const pct = Math.max(0, Math.min(100, value));
  return (
    <div className="w-full h-3 bg-gray-200 dark:bg-gray-800 rounded-full overflow-hidden">
      <div
        className="h-full bg-emerald-500 transition-all"
        style={{ width: `${pct}%` }}
      />
    </div>
  );
}

function StatCard({ title, value, subtitle, icon: Icon, accent = "" }) {
  return (
    <div
      className={`rounded-2xl p-4 shadow-sm bg-white/70 dark:bg-zinc-900/60 border border-zinc-200/50 dark:border-zinc-800 ${accent}`}
    >
      <div className="flex items-center gap-3">
        <div className="p-2 rounded-xl bg-zinc-100 dark:bg-zinc-800">
          <Icon className="w-5 h-5" />
        </div>
        <div className="text-sm opacity-70">{title}</div>
      </div>
      <div className="mt-2 text-2xl font-semibold tracking-tight">{value}</div>
      {subtitle && <div className="mt-1 text-xs opacity-60">{subtitle}</div>}
    </div>
  );
}

function ErrorBanner({ message }) {
  if (!message) return null;
  return (
    <div className="rounded-xl border border-red-200 dark:border-red-900 bg-red-50 dark:bg-red-950/40 text-red-800 dark:text-red-300 px-4 py-3 flex items-center gap-2">
      <AlertTriangle className="w-4 h-4" />
      <span className="text-sm">{message}</span>
    </div>
  );
}

export default function CampaignProgressPage({
  campaignId: campaignIdProp = "",
  refreshMs = 4000,
}) {
  const { campaignId: campaignIdParam } = useParams();
  const initialId = campaignIdParam || campaignIdProp;

  const [campaignId, setCampaignId] = useState(initialId);
  const [auto, setAuto] = useState(true);
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState("");
  const [data, setData] = useState(null);
  const [history, setHistory] = useState([]);
  const [since, setSince] = useState(null);

  const ctlRef = useRef(null);
  const canQuery = Boolean(campaignId);

  async function fetchOnce() {
    if (!canQuery) return;
    setLoading(true);
    setErr("");
    // cancel in-flight
    ctlRef.current?.abort();
    const ctl = new AbortController();
    ctlRef.current = ctl;
    try {
      // axiosClient already knows baseURL + auth; path-only like your reports pages
      const res = await axiosClient.get(`/campaigns/${campaignId}/progress`, {
        signal: ctl.signal,
      });
      const j = res.data;
      setData(j);
      setSince(s => s ?? new Date());
      setHistory(h => {
        const item = {
          t: new Date(j.retrievedAtUtc),
          pending: j.pending,
          inFlight: j.inFlight,
          sent: j.sent,
          failed: j.failed,
          dead: j.dead,
          completionPct: j.completionPct,
        };
        const next = [...h, item];
        return next.slice(Math.max(0, next.length - 50)); // last 50
      });
    } catch (e) {
      if (e?.name === "CanceledError" || e?.name === "AbortError") return;
      const msg =
        e?.response?.data?.message || e?.message || "Failed to load progress";
      setErr(msg);
      toast.error(`‚ùå ${msg}`);
    } finally {
      setLoading(false);
    }
  }

  // if route param changes later, sync it into state
  useEffect(() => {
    if (campaignIdParam && campaignIdParam !== campaignId)
      setCampaignId(campaignIdParam);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [campaignIdParam]);

  useEffect(() => {
    if (!auto) return;
    fetchOnce();
    const id = setInterval(fetchOnce, refreshMs);
    return () => clearInterval(id);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [auto, refreshMs, campaignId]);

  const completion = data?.completionPct ?? 0;
  const progressSubtitle = useMemo(() => {
    if (!data) return "";
    return `${nf.format(data.sent)} sent ‚Ä¢ ${nf.format(
      data.failed
    )} failed ‚Ä¢ ${nf.format(data.dead)} dead`;
  }, [data]);
  const lastUpdated = tsLabel(data?.retrievedAtUtc);

  return (
    <div className="p-4 md:p-6 lg:p-8 max-w-7xl mx-auto">
      {/* Header */}
      <div className="flex flex-col md:flex-row md:items-end gap-3 md:gap-4 mb-6">
        <div className="flex-1">
          <h1 className="text-2xl md:text-3xl font-bold tracking-tight flex items-center gap-2">
            <Activity className="w-6 h-6" /> Campaign Progress
          </h1>
          <p className="text-sm opacity-70 mt-1">
            Live view of queue and delivery metrics for a single campaign.
          </p>
        </div>

        <div className="flex flex-col sm:flex-row gap-2 sm:items-end">
          <div className="grid grid-cols-1 gap-2">
            <div className="flex flex-col">
              <label className="text-xs font-medium mb-1">Campaign ID</label>
              <input
                className="rounded-xl border border-zinc-300 dark:border-zinc-700 bg-white/80 dark:bg-zinc-900/60 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
                placeholder="00000000-0000-0000-0000-000000000000"
                value={campaignId}
                onChange={e => setCampaignId(e.target.value)}
              />
            </div>
          </div>

          <div className="flex gap-2">
            <button
              className="inline-flex items-center gap-2 rounded-xl border border-zinc-300 dark:border-zinc-700 px-3 py-2 text-sm hover:bg-zinc-100 dark:hover:bg-zinc-800"
              onClick={fetchOnce}
              disabled={!canQuery || loading}
              title="Refresh now"
            >
              {loading ? (
                <Loader2 className="w-4 h-4 animate-spin" />
              ) : (
                <RefreshCcw className="w-4 h-4" />
              )}{" "}
              Refresh
            </button>
            <button
              className={`inline-flex items-center gap-2 rounded-xl px-3 py-2 text-sm border ${
                auto
                  ? "border-emerald-500/60 bg-emerald-500 text-white"
                  : "border-zinc-300 dark:border-zinc-700"
              }`}
              onClick={() => setAuto(a => !a)}
              disabled={!canQuery}
              title={auto ? "Pause auto-refresh" : "Start auto-refresh"}
            >
              {auto ? (
                <Pause className="w-4 h-4" />
              ) : (
                <Play className="w-4 h-4" />
              )}{" "}
              {auto ? "Pause" : "Auto"}
            </button>
          </div>
        </div>
      </div>

      {/* Error */}
      {err && (
        <div className="mb-4">
          <ErrorBanner message={err} />
        </div>
      )}

      {/* Summary cards */}
      <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3 mb-6">
        <StatCard
          title="Total"
          value={nf.format(data?.totalJobs ?? 0)}
          icon={Target}
        />
        <StatCard
          title="Completed"
          value={nf.format(data?.completed ?? 0)}
          subtitle={`${pf.format(completion)}%`}
          icon={CheckCircle2}
        />
        <StatCard
          title="Pending"
          value={nf.format(data?.pending ?? 0)}
          icon={Clock}
        />
        <StatCard
          title="In Flight"
          value={nf.format(data?.inFlight ?? 0)}
          icon={PhoneOutgoing}
        />
        <StatCard
          title="Sent"
          value={nf.format(data?.sent ?? 0)}
          icon={TrendingUp}
        />
        <StatCard
          title="Failed"
          value={nf.format(data?.failed ?? 0)}
          icon={AlertTriangle}
        />
        <StatCard
          title="Dead"
          value={nf.format(data?.dead ?? 0)}
          icon={Gauge}
        />
        <StatCard title="Last Updated" value={lastUpdated} icon={Activity} />
      </div>

      {/* Progress */}
      <div className="rounded-2xl p-5 border border-zinc-200/60 dark:border-zinc-800 bg-white/70 dark:bg-zinc-900/60 shadow-sm mb-6">
        <div className="flex items-center justify-between mb-3">
          <div className="flex items-center gap-2 text-sm opacity-80">
            <TrendingUp className="w-4 h-4" /> Completion
          </div>
          <div className="text-sm font-medium">{pf.format(completion)}%</div>
        </div>
        <ProgressBar value={completion} />
        <div className="mt-3 text-xs opacity-70">
          {data
            ? `${nf.format(data.sent)} sent ‚Ä¢ ${nf.format(
                data.failed
              )} failed ‚Ä¢ ${nf.format(data.dead)} dead`
            : ""}
        </div>
      </div>

      {/* Charts */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div className="rounded-2xl p-4 border border-zinc-200/60 dark:border-zinc-800 bg-white/70 dark:bg-zinc-900/60 shadow-sm">
          <div className="flex items-center justify-between mb-2">
            <div className="flex items-center gap-2 text-sm opacity-80">
              <TrendingUp className="w-4 h-4" /> Completion over time
            </div>
            <div className="text-xs opacity-60">
              since {since ? since.toLocaleTimeString() : "‚Äì"}
            </div>
          </div>
          <div className="h-56">
            <ResponsiveContainer width="100%" height="100%">
              <AreaChart
                data={history}
                margin={{ left: 0, right: 8, top: 8, bottom: 0 }}
              >
                <defs>
                  <linearGradient id="grad" x1="0" y1="0" x2="0" y2="1">
                    <stop
                      offset="0%"
                      stopColor="currentColor"
                      stopOpacity={0.3}
                    />
                    <stop
                      offset="100%"
                      stopColor="currentColor"
                      stopOpacity={0.05}
                    />
                  </linearGradient>
                </defs>
                <CartesianGrid strokeDasharray="3 3" className="opacity-30" />
                <XAxis
                  dataKey="t"
                  tickFormatter={t => new Date(t).toLocaleTimeString()}
                  minTickGap={24}
                />
                <YAxis
                  domain={[0, 100]}
                  tickFormatter={v => `${v}%`}
                  width={40}
                />
                <Tooltip
                  labelFormatter={l => new Date(l).toLocaleTimeString()}
                  formatter={v => [`${pf.format(v)}%`, "completion"]}
                />
                <Area
                  type="monotone"
                  dataKey="completionPct"
                  stroke="currentColor"
                  fill="url(#grad)"
                />
              </AreaChart>
            </ResponsiveContainer>
          </div>
        </div>

        <div className="rounded-2xl p-4 border border-zinc-200/60 dark:border-zinc-800 bg-white/70 dark:bg-zinc-900/60 shadow-sm">
          <div className="flex items-center justify-between mb-2">
            <div className="flex items-center gap-2 text-sm opacity-80">
              <Clock className="w-4 h-4" /> Queue state over time
            </div>
            <div className="text-xs opacity-60">pending & in-flight</div>
          </div>
          <div className="h-56">
            <ResponsiveContainer width="100%" height="100%">
              <LineChart
                data={history}
                margin={{ left: 0, right: 8, top: 8, bottom: 0 }}
              >
                <CartesianGrid strokeDasharray="3 3" className="opacity-30" />
                <XAxis
                  dataKey="t"
                  tickFormatter={t => new Date(t).toLocaleTimeString()}
                  minTickGap={24}
                />
                <YAxis width={48} />
                <Tooltip
                  labelFormatter={l => new Date(l).toLocaleTimeString()}
                />
                <Legend />
                <Line
                  type="monotone"
                  dataKey="pending"
                  stroke="currentColor"
                  dot={false}
                  name="Pending"
                />
                <Line
                  type="monotone"
                  dataKey="inFlight"
                  stroke="currentColor"
                  dot={false}
                  name="InFlight"
                />
              </LineChart>
            </ResponsiveContainer>
          </div>
        </div>
      </div>

      {/* Latency chips */}
      <div className="mt-6 grid grid-cols-1 md:grid-cols-3 gap-3">
        <div className="rounded-xl p-3 border border-zinc-200/60 dark:border-zinc-800 bg-white/70 dark:bg-zinc-900/60">
          <div className="text-xs opacity-70">p50 latency (last hour)</div>
          <div className="text-lg font-semibold">
            {fmtMs(data?.p50ms ?? null)}
          </div>
        </div>
        <div className="rounded-xl p-3 border border-zinc-200/60 dark:border-zinc-800 bg-white/70 dark:bg-zinc-900/60">
          <div className="text-xs opacity-70">p95 latency (last hour)</div>
          <div className="text-lg font-semibold">
            {fmtMs(data?.p95ms ?? null)}
          </div>
        </div>
        <div className="rounded-xl p-3 border border-zinc-200/60 dark:border-zinc-800 bg-white/70 dark:bg-zinc-900/60">
          <div className="text-xs opacity-70">p99 latency (last hour)</div>
          <div className="text-lg font-semibold">
            {fmtMs(data?.p99ms ?? null)}
          </div>
        </div>
      </div>

      {!data && (
        <div className="mt-10 text-center text-sm opacity-60">
          Enter a campaign ID above, then enable auto-refresh.
        </div>
      )}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Notes\NoteForm.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axios from "axios";
import axiosClient from "../../api/axiosClient"; // ‚úÖ Add this for timeline entry
import { toast } from "react-toastify";

function NoteForm({ contactId, selectedNote, onSaveComplete }) {
  const [formData, setFormData] = useState({
    contactId: contactId,
    title: "",
    content: "",
    source: "Manual",
    createdBy: "Admin", // Later: pull from auth
    isPinned: false,
    isInternal: false,
  });

  useEffect(() => {
    if (selectedNote) {
      setFormData({ ...selectedNote });
    } else {
      setFormData({
        contactId: contactId,
        title: "",
        content: "",
        source: "Manual",
        createdBy: "Admin",
        isPinned: false,
        isInternal: false,
      });
    }
  }, [selectedNote, contactId]);

  const handleChange = e => {
    const { name, value, type, checked } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: type === "checkbox" ? checked : value,
    }));
  };

  const handleSubmit = async e => {
    e.preventDefault();
    try {
      const payload = { ...formData, contactId };

      if (selectedNote?.id) {
        await axios.put(`/api/notes/${selectedNote.id}`, payload);
        toast.info("üìù Note updated.");
      } else {
        await axios.post("/api/notes", payload);
        toast.success("‚úÖ Note added.");
      }

      // ‚úÖ Auto-log to timeline
      try {
        await axiosClient.post("/leadtimeline", {
          contactId,
          eventType: "NoteAdded",
          description: `Note titled '${payload.title}' was ${
            selectedNote ? "updated" : "added"
          }.`,
          createdBy: payload.createdBy,
          source: "Note",
          category: "Manual",
          isSystemGenerated: true,
        });
      } catch (timelineErr) {
        console.warn("Timeline log failed:", timelineErr);
      }

      onSaveComplete();
    } catch (err) {
      console.error("‚ùå Failed to save note:", err);
      toast.error("Failed to save note.");
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-3">
      <input
        name="title"
        value={formData.title}
        onChange={handleChange}
        placeholder="Note Title"
        className="w-full border rounded-lg px-3 py-2"
      />
      <textarea
        name="content"
        value={formData.content}
        onChange={handleChange}
        placeholder="Write your note here..."
        rows={5}
        className="w-full border rounded-lg px-3 py-2"
      />
      <div className="flex flex-wrap gap-4">
        <label className="flex items-center">
          <input
            type="checkbox"
            name="isPinned"
            checked={formData.isPinned}
            onChange={handleChange}
            className="mr-2"
          />
          Pin Note
        </label>
        <label className="flex items-center">
          <input
            type="checkbox"
            name="isInternal"
            checked={formData.isInternal}
            onChange={handleChange}
            className="mr-2"
          />
          Internal Only
        </label>
      </div>
      <button
        type="submit"
        className="bg-purple-600 text-white px-4 py-2 rounded-lg"
      >
        {selectedNote ? "Update Note" : "Add Note"}
      </button>
    </form>
  );
}

export default NoteForm;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Notes\NoteList.jsx 
====================================================== 
 
import React, { useEffect, useState, useCallback } from "react";
import axios from "axios";

function NoteList({ contactId, onEdit, refreshKey }) {
  const [notes, setNotes] = useState([]);

  // üü¢ Wrap fetchNotes in useCallback so its identity is stable across renders
  const fetchNotes = useCallback(async () => {
    if (!contactId) return;
    try {
      const res = await axios.get(`/api/notes/contact/${contactId}`);
      setNotes(res.data);
    } catch (err) {
      console.error("‚ùå Failed to fetch notes:", err);
    }
  }, [contactId]);

  useEffect(() => {
    fetchNotes();
  }, [fetchNotes, refreshKey]); // useCallback ensures fetchNotes is stable

  const handleDelete = async id => {
    if (!window.confirm("Delete this note?")) return;
    try {
      await axios.delete(`/api/notes/${id}`);
      fetchNotes();
    } catch (err) {
      console.error("‚ùå Failed to delete note:", err);
    }
  };

  return (
    <div className="grid gap-4">
      {notes.length === 0 && (
        <div className="text-gray-500 text-center py-6">
          No notes found for this contact.
        </div>
      )}

      {notes.map(note => (
        <div
          key={note.id}
          className={`border p-4 rounded-xl shadow-sm relative bg-white hover:shadow-md transition-all ${
            note.isPinned ? "border-purple-500" : "border-gray-200"
          }`}
        >
          <div className="flex justify-between items-center">
            <h3 className="font-semibold text-lg text-purple-700 flex gap-2 items-center">
              {note.title || "Untitled"}
              {note.isPinned && (
                <span title="Pinned" className="text-purple-500">
                  üìå
                </span>
              )}
              {note.isInternal && (
                <span title="Internal Note" className="text-gray-400">
                  üîí
                </span>
              )}
            </h3>
            <div className="flex gap-2 text-sm">
              <button
                onClick={() => onEdit(note)}
                className="text-blue-600 hover:underline"
              >
                Edit
              </button>
              <button
                onClick={() => handleDelete(note.id)}
                className="text-red-500 hover:underline"
              >
                Delete
              </button>
            </div>
          </div>
          <p className="text-sm text-gray-800 mt-2 whitespace-pre-line">
            {note.content}
          </p>
          <div className="text-xs text-gray-500 mt-3">
            Created by <b>{note.createdBy}</b> ¬∑{" "}
            {new Date(note.createdAt).toLocaleString()}
          </div>
        </div>
      ))}
    </div>
  );
}

export default NoteList;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Notes\Notes.jsx 
====================================================== 
 
import React, { useState } from "react";
import NoteForm from "./NoteForm";
import NoteList from "./NoteList";

function Notes({ contactId }) {
  const [selectedNote, setSelectedNote] = useState(null);
  const [isDrawerOpen, setIsDrawerOpen] = useState(false);
  const [refreshKey, setRefreshKey] = useState(0);

  const handleEdit = note => {
    setSelectedNote(note);
    setIsDrawerOpen(true);
  };

  const handleAddNew = () => {
    setSelectedNote(null);
    setIsDrawerOpen(true);
  };

  const handleSaveComplete = () => {
    setSelectedNote(null);
    setIsDrawerOpen(false);
    setRefreshKey(prev => prev + 1);
  };

  return (
    <div className="p-4 relative">
      {/* Header */}
      <div className="flex justify-between items-center mb-4">
        <h2 className="text-2xl font-semibold text-purple-700">üìù Notes</h2>
        <button
          onClick={handleAddNew}
          className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg shadow"
        >
          ‚ûï Add Note
        </button>
      </div>

      {/* Note List */}
      <NoteList
        contactId={contactId}
        onEdit={handleEdit}
        refreshKey={refreshKey}
      />

      {/* Drawer */}
      {isDrawerOpen && (
        <div className="fixed top-0 right-0 w-full max-w-md h-full bg-white shadow-2xl z-50 transition-transform duration-300 border-l overflow-y-auto">
          <div className="flex items-center justify-between p-4 border-b">
            <h2 className="text-lg font-bold">
              {selectedNote ? "Edit Note" : "Add Note"}
            </h2>
            <button
              onClick={() => setIsDrawerOpen(false)}
              className="text-gray-500 text-xl"
            >
              √ó
            </button>
          </div>
          <div className="p-4">
            <NoteForm
              contactId={contactId}
              selectedNote={selectedNote}
              onSaveComplete={handleSaveComplete}
            />
          </div>
        </div>
      )}
    </div>
  );
}

export default Notes;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Notes\NotesWrapper.jsx 
====================================================== 
 
import { useParams } from "react-router-dom";
import Notes from "./Notes";

function NotesWrapper() {
  const { contactId } = useParams();
  return <Notes contactId={contactId} />;
}

export default NotesWrapper;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Payment\BillingPage.jsx 
====================================================== 
 
// üìÑ src/pages/Payment/BillingPage.jsx

import React, { useEffect, useMemo, useState } from "react";
import { useLocation } from "react-router-dom";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";
import { getAllPlans, normalizeApiPlans } from "./planCatalog";

// Format currency (INR style by default)
const formatAmount = (amount, currency) =>
  new Intl.NumberFormat("en-IN", {
    style: "currency",
    currency: currency || "INR",
    maximumFractionDigits: 2,
  }).format(amount || 0);

// Format dates from UTC
const formatDate = utc => {
  if (!utc) return "‚Äî";
  const d = new Date(utc);
  if (Number.isNaN(d.getTime())) return "‚Äî";
  return d.toLocaleDateString("en-IN", {
    year: "numeric",
    month: "short",
    day: "numeric",
  });
};

function BillingPage() {
  const location = useLocation();

  const [loading, setLoading] = useState(true);

  const [overview, setOverview] = useState(null);
  const [plans, setPlans] = useState([]);

  const [selectedPlanId, setSelectedPlanId] = useState("");
  const [billingCycle, setBillingCycle] = useState("Monthly");

  const [couponInput, setCouponInput] = useState("");
  const [couponLoading, setCouponLoading] = useState(false);
  const [appliedCoupon, setAppliedCoupon] = useState(null);

  const [checkoutLoading, setCheckoutLoading] = useState(false);

  // Parse query params (planId, billingCycle, coupon)
  const queryParams = useMemo(() => {
    const sp = new URLSearchParams(location.search || "");
    const qp = {
      planId: sp.get("planId") || sp.get("plan") || "",
      billingCycle: sp.get("billingCycle") || sp.get("cycle") || "",
      coupon: sp.get("coupon") || sp.get("code") || "",
    };

    const normalizedCycle =
      qp.billingCycle &&
      ["monthly", "yearly"].includes(qp.billingCycle.toLowerCase())
        ? qp.billingCycle[0].toUpperCase() +
          qp.billingCycle.slice(1).toLowerCase()
        : "";

    return {
      planId: qp.planId,
      billingCycle: normalizedCycle, // "" | "Monthly" | "Yearly"
      coupon: qp.coupon,
    };
  }, [location.search]);

  // Load overview + plans
  useEffect(() => {
    const load = async () => {
      try {
        setLoading(true);

        // 1Ô∏è‚É£ Load billing overview from backend
        const ovRes = await axiosClient.get("/payment/overview");
        const ov = ovRes.data;
        setOverview(ov);

        // 2Ô∏è‚É£ Try to load plans from backend `/plans`
        let loadedPlans = [];
        try {
          const plansRes = await axiosClient.get("/plans", {
            // suppress global toast if /plans is not ready or 404
            headers: { "x-suppress-403-toast": "true" },
          });

          loadedPlans = normalizeApiPlans(plansRes.data);
        } catch (e) {
          if (process.env.NODE_ENV !== "production") {
            // eslint-disable-next-line no-console
            console.log(
              "[Billing] /plans not available or failed, using static catalog"
            );
          }
        }

        // 3Ô∏è‚É£ Fallback to static catalog (single source in planCatalog.js)
        if (!loadedPlans || loadedPlans.length === 0) {
          loadedPlans = getAllPlans();
        }

        setPlans(loadedPlans);

        // 4Ô∏è‚É£ Decide initial billing cycle
        let initialCycle = "Monthly";
        if (queryParams.billingCycle) {
          initialCycle = queryParams.billingCycle;
        }

        // 5Ô∏è‚É£ Decide initial selected plan
        let initialPlanId = "";

        // From URL
        if (queryParams.planId) {
          const match = loadedPlans.find(
            p => p.id && p.id.toLowerCase() === queryParams.planId.toLowerCase()
          );
          if (match) initialPlanId = match.id;
        }

        // From current subscription
        if (!initialPlanId && ov?.currentSubscription?.planId) {
          const match = loadedPlans.find(
            p =>
              p.id &&
              p.id.toLowerCase() === ov.currentSubscription.planId.toLowerCase()
          );
          if (match) initialPlanId = match.id;
        }

        // Default: popular plan or first plan
        if (!initialPlanId && loadedPlans.length > 0) {
          const popular = loadedPlans.find(p => p.isPopular) || loadedPlans[0];
          initialPlanId = popular.id;
        }

        setSelectedPlanId(initialPlanId);
        setBillingCycle(initialCycle);

        // 6Ô∏è‚É£ Pre-fill coupon from URL (actual validation happens on Apply)
        if (queryParams.coupon && initialPlanId) {
          setCouponInput(queryParams.coupon.toUpperCase());
        }
      } catch (err) {
        console.error(err);
        toast.error(
          err?.response?.data?.message ||
            "Failed to load billing overview. Please try again."
        );
      } finally {
        setLoading(false);
      }
    };

    load();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [queryParams.planId, queryParams.billingCycle, queryParams.coupon]);

  // Selected plan object
  const selectedPlan = useMemo(
    () => plans.find(p => p.id === selectedPlanId) || null,
    [plans, selectedPlanId]
  );

  const currency = selectedPlan?.currency || "INR";

  // Base plan price based on billing cycle
  const basePrice = useMemo(() => {
    if (!selectedPlan) return 0;
    return billingCycle === "Monthly"
      ? selectedPlan.priceMonthly
      : selectedPlan.priceYearly;
  }, [selectedPlan, billingCycle]);

  // Price breakdown with coupon + GST
  const pricePreview = useMemo(() => {
    let subtotal = basePrice || 0;
    let discount = 0;

    if (
      appliedCoupon &&
      appliedCoupon.valid &&
      appliedCoupon.discountType &&
      appliedCoupon.discountValue
    ) {
      if (appliedCoupon.discountType === "Flat") {
        discount = appliedCoupon.discountValue;
      } else if (appliedCoupon.discountType === "Percent") {
        discount = (subtotal * appliedCoupon.discountValue) / 100;
      }
    }

    if (discount > subtotal) discount = subtotal;
    const taxable = subtotal - discount;
    const gst = Math.round(taxable * 0.18 * 100) / 100;
    const total = Math.max(taxable + gst, 0);

    return { subtotal, discount, gst, total };
  }, [basePrice, appliedCoupon]);

  // Current subscription label
  const currentStatusLabel = useMemo(() => {
    const s = overview?.currentSubscription?.status;
    if (!s) return "No active subscription";
    switch (s) {
      case "Trial":
        return "Trial active";
      case "Active":
        return "Subscription active";
      case "PastDue":
        return "Payment overdue (Past Due)";
      case "Suspended":
        return "Subscription suspended";
      case "Cancelled":
      case "Expired":
        return "No active plan (Cancelled / Expired)";
      default:
        return s;
    }
  }, [overview]);

  const currentPlanId = overview?.currentSubscription?.planId || null;

  // Apply coupon
  const handleApplyCoupon = async () => {
    const code = couponInput.trim();
    if (!selectedPlan) {
      toast.warn("Select a plan before applying a coupon.");
      return;
    }
    if (!code) {
      toast.warn("Enter a coupon code.");
      return;
    }

    try {
      setCouponLoading(true);

      const res = await axiosClient.get("/payment/coupon/validate", {
        params: {
          code,
          planId: selectedPlan.id,
          billingCycle,
        },
      });

      const data = res.data;

      if (!data.ok || !data.valid) {
        setAppliedCoupon(null);
        toast.error(data.message || "Invalid or expired coupon.");
        return;
      }

      setAppliedCoupon(data);
      toast.success(data.message || "Coupon applied successfully.");
    } catch (err) {
      console.error(err);
      setAppliedCoupon(null);
      toast.error(
        err?.response?.data?.message ||
          "Failed to validate coupon. Please try again."
      );
    } finally {
      setCouponLoading(false);
    }
  };

  // Clear coupon
  const handleClearCoupon = () => {
    setCouponInput("");
    setAppliedCoupon(null);
  };

  // Start checkout flow
  const handleProceedToPay = async () => {
    if (!selectedPlan) {
      toast.warn("Please select a plan to continue.");
      return;
    }

    try {
      setCheckoutLoading(true);

      const payload = {
        planId: selectedPlan.id,
        billingCycle,
        couponCode:
          appliedCoupon && appliedCoupon.valid && appliedCoupon.code
            ? appliedCoupon.code
            : undefined,
      };

      const res = await axiosClient.post(
        "/payment/subscribe/checkout",
        payload
      );

      const data = res.data;

      if (!data || !data.redirectUrl) {
        toast.error("Checkout session created, but no redirect URL received.");
        return;
      }

      window.location.href = data.redirectUrl;
    } catch (err) {
      console.error(err);
      toast.error(
        err?.response?.data?.message ||
          "Failed to start checkout. Please try again."
      );
    } finally {
      setCheckoutLoading(false);
    }
  };

  // Status badge UI
  const renderStatusBadge = () => {
    const status = overview?.currentSubscription?.status;
    let color = "bg-slate-50 text-slate-700 border-slate-200";

    if (status === "Active" || status === "Trial") {
      color = "bg-emerald-50 text-emerald-700 border-emerald-200";
    } else if (status === "PastDue") {
      color = "bg-amber-50 text-amber-700 border-amber-200";
    } else if (
      status === "Suspended" ||
      status === "Cancelled" ||
      status === "Expired"
    ) {
      color = "bg-red-50 text-red-700 border-red-200";
    }

    return (
      <span
        className={
          "inline-flex items-center px-2.5 py-1 rounded-full text-[9px] font-semibold border " +
          color
        }
      >
        {currentStatusLabel}
      </span>
    );
  };

  // Single plan card
  const renderPlanCard = plan => {
    const isSelected = plan.id === selectedPlanId;
    const price =
      billingCycle === "Monthly" ? plan.priceMonthly : plan.priceYearly;
    const isCurrent =
      currentPlanId && currentPlanId.toLowerCase() === plan.id.toLowerCase();

    return (
      <button
        key={plan.id}
        type="button"
        onClick={() => {
          setSelectedPlanId(plan.id);
          setAppliedCoupon(null); // reset coupon when switching plan
        }}
        className={
          "flex flex-col gap-1.5 p-3.5 rounded-lg border text-left transition-all " +
          "bg-white shadow-[0_1px_2px_rgba(15,23,42,0.04)] " +
          (isSelected
            ? "border-purple-600 ring-2 ring-purple-100"
            : "border-slate-200 hover:border-slate-300")
        }
      >
        <div className="flex items-center justify-between gap-2">
          <div className="text-sm font-semibold text-slate-900">
            {plan.name}
          </div>
          <div className="flex items-center gap-1">
            {isCurrent && (
              <span className="px-2 py-0.5 rounded-full bg-emerald-50 text-[8px] text-emerald-700 border border-emerald-200">
                Current plan
              </span>
            )}
            {plan.isPopular && (
              <span className="px-2 py-0.5 rounded-full bg-slate-900 text-[8px] text-white font-semibold">
                Recommended
              </span>
            )}
          </div>
        </div>
        {plan.description && (
          <div className="text-[9px] text-slate-600">{plan.description}</div>
        )}
        <div className="mt-1">
          <div className="text-lg font-semibold text-slate-900 leading-tight">
            {formatAmount(price, plan.currency)}
          </div>
          <div className="text-[8px] text-slate-500">
            per {billingCycle === "Monthly" ? "month" : "year"}
          </div>
        </div>
        {plan.features && plan.features.length > 0 && (
          <ul className="mt-2 space-y-0.5 text-[8px] text-slate-600">
            {plan.features.slice(0, 5).map((f, i) => (
              <li key={i} className="flex gap-1">
                <span className="mt-[1px] text-[8px]">‚úî</span>
                <span>{f}</span>
              </li>
            ))}
          </ul>
        )}
      </button>
    );
  };

  if (loading) {
    return (
      <div className="px-4 sm:px-6 py-6">
        <div className="text-sm text-slate-500">Loading billing overview‚Ä¶</div>
      </div>
    );
  }

  const recentInvoices = overview?.recentInvoices || [];

  return (
    <div className="px-4 sm:px-6 py-6 space-y-4">
      {/* Header */}
      <div className="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h1 className="text-lg font-semibold text-slate-900">
            Billing &amp; Subscription
          </h1>
          <p className="text-[10px] text-slate-500 mt-0.5">
            Manage your plan, review invoices, and update your subscription
            securely.
          </p>
        </div>
        <div className="flex flex-col items-end gap-1">
          {renderStatusBadge()}
          {overview?.currentSubscription?.currentPeriodEndUtc && (
            <div className="text-[8px] text-slate-500">
              Renews / ends on{" "}
              <span className="font-semibold text-slate-800">
                {formatDate(overview.currentSubscription.currentPeriodEndUtc)}
              </span>
            </div>
          )}
        </div>
      </div>

      {/* Main layout: Plans + Summary */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 items-start">
        {/* Left: Plan selection */}
        <div className="lg:col-span-2 space-y-3">
          {/* Billing cycle toggle */}
          <div className="inline-flex items-center gap-1 rounded-full bg-slate-100 p-1">
            <button
              type="button"
              onClick={() => setBillingCycle("Monthly")}
              className={
                "px-3 py-1 rounded-full text-[9px] font-medium " +
                (billingCycle === "Monthly"
                  ? "bg-white shadow-sm text-slate-900"
                  : "text-slate-500")
              }
            >
              Monthly
            </button>
            <button
              type="button"
              onClick={() => setBillingCycle("Yearly")}
              className={
                "px-3 py-1 rounded-full text-[9px] font-medium " +
                (billingCycle === "Yearly"
                  ? "bg-white shadow-sm text-slate-900"
                  : "text-slate-500")
              }
            >
              Yearly
              <span className="ml-1 text-[7px] text-emerald-600">
                Save with annual
              </span>
            </button>
          </div>

          {/* Plan cards */}
          <div className="grid sm:grid-cols-3 gap-3">
            {plans.map(plan => renderPlanCard(plan))}
          </div>
        </div>

        {/* Right: Order summary + coupon + action */}
        <div className="lg:col-span-1">
          <div className="bg-white rounded-xl border border-slate-200 shadow-sm p-3.5 space-y-2.5">
            <div className="flex items-center justify-between gap-2">
              <div>
                <div className="text-xs font-semibold text-slate-900">
                  Order summary
                </div>
                <div className="text-[8px] text-slate-500">
                  Review your selection before proceeding to secure payment.
                </div>
              </div>
              {selectedPlan && (
                <div className="text-right">
                  <div className="text-[8px] text-slate-500">Selected plan</div>
                  <div className="text-[10px] font-semibold text-slate-900">
                    {selectedPlan.name}
                  </div>
                  <div className="text-[8px] text-slate-500">
                    {billingCycle}
                  </div>
                </div>
              )}
            </div>

            <div className="border-t border-slate-100 pt-2 space-y-1.5 text-[9px]">
              <div className="flex justify-between">
                <span className="text-slate-600">Plan subtotal</span>
                <span className="font-medium text-slate-900">
                  {formatAmount(pricePreview.subtotal, currency)}
                </span>
              </div>
              <div className="flex justify-between">
                <span className="text-slate-600">Discount</span>
                <span className="font-medium text-emerald-600">
                  -{formatAmount(pricePreview.discount, currency)}
                </span>
              </div>
              <div className="flex justify-between">
                <span className="text-slate-600">GST (18%)</span>
                <span className="font-medium text-slate-900">
                  {formatAmount(pricePreview.gst, currency)}
                </span>
              </div>
              <div className="flex justify-between pt-1 border-t border-slate-100">
                <span className="text-[9px] font-semibold text-slate-900">
                  Total payable
                </span>
                <span className="text-sm font-semibold text-slate-900">
                  {formatAmount(pricePreview.total, currency)}
                </span>
              </div>
            </div>

            {/* Coupon input */}
            <div className="pt-1 space-y-1.5">
              <div className="flex items-center gap-1.5">
                <input
                  type="text"
                  value={couponInput}
                  onChange={e => setCouponInput(e.target.value.toUpperCase())}
                  placeholder="Enter coupon code"
                  className="flex-1 px-2 py-1.5 rounded-md border border-slate-200 text-[9px] focus:outline-none focus:ring-1 focus:ring-purple-500 focus:border-purple-500"
                  disabled={couponLoading || checkoutLoading}
                />
                {appliedCoupon ? (
                  <button
                    type="button"
                    onClick={handleClearCoupon}
                    className="px-2 py-1.5 rounded-md border border-slate-200 text-[8px] text-slate-700 hover:bg-slate-50"
                    disabled={couponLoading || checkoutLoading}
                  >
                    Clear
                  </button>
                ) : (
                  <button
                    type="button"
                    onClick={handleApplyCoupon}
                    className="px-2 py-1.5 rounded-md bg-slate-900 text-white text-[8px] font-semibold hover:bg-black disabled:opacity-60"
                    disabled={couponLoading || checkoutLoading}
                  >
                    {couponLoading ? "Checking‚Ä¶" : "Apply"}
                  </button>
                )}
              </div>
              {appliedCoupon && appliedCoupon.valid && (
                <div className="text-[8px] text-emerald-700">
                  {appliedCoupon.message ||
                    `Coupon ${appliedCoupon.code} applied successfully.`}
                </div>
              )}
            </div>

            {/* Proceed button */}
            <div className="pt-1">
              <button
                type="button"
                onClick={handleProceedToPay}
                disabled={
                  checkoutLoading || !selectedPlan || pricePreview.total < 0
                }
                className={
                  "w-full px-3 py-2 rounded-md text-[10px] font-semibold " +
                  "bg-purple-600 text-white hover:bg-purple-700 " +
                  "disabled:opacity-60 disabled:cursor-not-allowed"
                }
              >
                {checkoutLoading
                  ? "Redirecting to secure payment‚Ä¶"
                  : "Proceed to secure payment"}
              </button>
              <div className="mt-1 text-[7px] text-slate-500">
                Payments are processed securely. Your plan will be activated
                automatically after confirmation.
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Recent invoices */}
      <div className="mt-4">
        <div className="flex items-center justify-between mb-1.5">
          <h2 className="text-xs font-semibold text-slate-900">
            Recent invoices
          </h2>
          <div className="text-[8px] text-slate-500">
            Showing latest billing activity for your account.
          </div>
        </div>
        {recentInvoices.length === 0 ? (
          <div className="text-[9px] text-slate-500 bg-white border border-slate-200 rounded-md px-3 py-2">
            No invoices found yet. Once you subscribe or renew, your invoices
            will appear here.
          </div>
        ) : (
          <div className="overflow-x-auto">
            <table className="min-w-full bg-white border border-slate-200 rounded-md overflow-hidden">
              <thead>
                <tr className="bg-slate-50 text-[8px] text-slate-500">
                  <th className="px-3 py-1.5 text-left font-medium">Date</th>
                  <th className="px-3 py-1.5 text-left font-medium">
                    Invoice #
                  </th>
                  <th className="px-3 py-1.5 text-left font-medium">Plan</th>
                  <th className="px-3 py-1.5 text-left font-medium">Status</th>
                  <th className="px-3 py-1.5 text-right font-medium">Amount</th>
                </tr>
              </thead>
              <tbody className="text-[8px] text-slate-700">
                {recentInvoices.map(inv => (
                  <tr
                    key={inv.id || inv.number}
                    className="border-t border-slate-100"
                  >
                    <td className="px-3 py-1.5">
                      {formatDate(inv.createdAtUtc)}
                    </td>
                    <td className="px-3 py-1.5">
                      {inv.number || inv.id || "‚Äî"}
                    </td>
                    <td className="px-3 py-1.5">
                      {inv.planName || inv.planId || "‚Äî"}
                    </td>
                    <td className="px-3 py-1.5">
                      <span
                        className={
                          "px-1.5 py-0.5 rounded-full border text-[7px] " +
                          (inv.status === "Paid"
                            ? "bg-emerald-50 text-emerald-700 border-emerald-200"
                            : inv.status === "Failed"
                            ? "bg-red-50 text-red-700 border-red-200"
                            : "bg-slate-50 text-slate-700 border-slate-200")
                        }
                      >
                        {inv.status || "‚Äî"}
                      </span>
                    </td>
                    <td className="px-3 py-1.5 text-right">
                      {formatAmount(inv.total, inv.currency || "INR")}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  );
}

export default BillingPage;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Payment\FeatureComparison.jsx 
====================================================== 
 
// üìÑ src/pages/Payment/FeatureComparison.jsx

import React from "react";
import { getAllPlans, buildFeatureMatrix } from "./planCatalog";

export default function FeatureComparison() {
  const plans = getAllPlans();
  const matrix = buildFeatureMatrix();

  if (!plans.length) return null;

  return (
    <div className="mt-6 bg-white border border-slate-200 rounded-xl shadow-sm p-4">
      <div className="flex items-center justify-between mb-3">
        <div>
          <h2 className="text-xs font-semibold text-slate-900">
            Compare plans
          </h2>
          <p className="text-[9px] text-slate-500">
            See what you get with each xByteChat plan before upgrading.
          </p>
        </div>
      </div>

      <div className="overflow-x-auto">
        <table className="min-w-full text-[8px] text-slate-700">
          <thead>
            <tr>
              <th className="text-left px-2 py-1.5 text-slate-500 font-medium">
                Features
              </th>
              {plans.map(plan => (
                <th
                  key={plan.id}
                  className="px-2 py-1.5 text-center text-slate-500 font-medium"
                >
                  <div className="text-[9px] font-semibold text-slate-900">
                    {plan.name}
                  </div>
                  {plan.isPopular && (
                    <div className="mt-0.5 inline-flex px-1.5 py-0.5 rounded-full bg-slate-900 text-white text-[7px]">
                      Recommended
                    </div>
                  )}
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {matrix.map(row => (
              <tr key={row.key} className="border-t border-slate-100">
                <td className="px-2 py-1.5 font-medium text-slate-800">
                  {row.label}
                </td>
                {plans.map(plan => (
                  <td
                    key={plan.id}
                    className="px-2 py-1.5 text-center text-slate-700"
                  >
                    {row.values[plan.id] || "‚Äî"}
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      <p className="mt-2 text-[7px] text-slate-400">
        Limits and features are indicative for MVP. Final production values are
        managed from the billing configuration and payment provider.
      </p>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Payment\PaymentStatusPage.jsx 
====================================================== 
 
// üìÑ src/pages/Payment/PaymentStatusPage.jsx

import React, { useEffect, useState } from "react";
import { useLocation, useNavigate } from "react-router-dom";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";

const formatDate = utc => {
  if (!utc) return "‚Äî";
  const d = new Date(utc);
  if (Number.isNaN(d.getTime())) return "‚Äî";
  return d.toLocaleDateString("en-IN", {
    year: "numeric",
    month: "short",
    day: "numeric",
  });
};

const isSubscriptionActiveLike = sub => {
  if (!sub || !sub.status) return false;
  const s = String(sub.status);
  return (
    s === "Active" ||
    s === "Trial" ||
    s === "Grace" ||
    (s === "Cancelled" &&
      sub.cancelAtPeriodEnd &&
      sub.currentPeriodEndUtc &&
      new Date(sub.currentPeriodEndUtc) > new Date())
  );
};

function PaymentStatusPage() {
  const location = useLocation();
  const navigate = useNavigate();

  const [loading, setLoading] = useState(true);
  const [attempts, setAttempts] = useState(0);
  const [statusView, setStatusView] = useState({
    state: "checking", // checking | success | pending | failed
    title: "Confirming your payment‚Ä¶",
    message:
      "We‚Äôre syncing your payment with our billing system. This usually takes a moment.",
    subscription: null,
    lastInvoice: null,
  });

  const searchParams = new URLSearchParams(location.search || "");
  const source = searchParams.get("source") || "razorpay";
  const orderId = searchParams.get("orderId") || null;
  const sessionId = searchParams.get("sessionId") || null;

  useEffect(() => {
    let isCancelled = false;
    let timer = null;

    const checkOverview = async isInitial => {
      try {
        // suppress generic error toast here; we handle UX locally
        const res = await axiosClient.get("/payment/overview", {
          headers: { "x-suppress-403-toast": true },
        });
        if (isCancelled) return true;

        const data = res.data || {};
        const sub = data.currentSubscription || null;
        const invoices = data.recentInvoices || [];
        const lastInvoice = invoices[0] || null;

        // Active/trial/grace ‚Üí success
        if (isSubscriptionActiveLike(sub)) {
          setStatusView({
            state: "success",
            title: "Payment successful",
            message:
              "Your subscription is active. You can now use all available features.",
            subscription: sub,
            lastInvoice,
          });
          setLoading(false);
          if (!isInitial) {
            toast.success("Subscription updated successfully.");
          }
          return true;
        }

        // Explicit failure on latest invoice
        if (
          lastInvoice &&
          (lastInvoice.status === "Failed" ||
            lastInvoice.status === "Cancelled")
        ) {
          setStatusView({
            state: "failed",
            title: "Payment failed or cancelled",
            message:
              "We couldn‚Äôt confirm a successful payment for this attempt. You can retry from your Billing page.",
            subscription: sub,
            lastInvoice,
          });
          setLoading(false);
          return true;
        }

        // No confirmation yet ‚Üí keep polling / maybe pending
        return false;
      } catch (err) {
        if (isCancelled) return true;
        console.error(err);
        // Don‚Äôt delegate to global interceptor UX here; show local pending.
        setStatusView(prev => ({
          ...prev,
          state: "pending",
          title: "Unable to confirm yet",
          message:
            "We‚Äôre having trouble confirming your payment. If this persists, please open your Billing page or contact support.",
        }));
        setLoading(false);
        return true;
      }
    };

    const start = async () => {
      const initialDone = await checkOverview(true);
      if (initialDone) {
        setLoading(false);
        return;
      }

      // Poll up to 5 times (e.g. 10s total) for webhook delay
      let tries = 0;
      timer = setInterval(async () => {
        tries += 1;
        setAttempts(tries);

        const done = await checkOverview(false);
        if (done || tries >= 5) {
          clearInterval(timer);
          setLoading(false);

          if (!done) {
            setStatusView(prev => ({
              ...prev,
              state: "pending",
              title: "Payment status is pending",
              message:
                "We haven‚Äôt received a success confirmation yet. Please refresh in a bit or check your Billing page.",
            }));
          }
        }
      }, 2000);
    };

    start();

    return () => {
      isCancelled = true;
      if (timer) clearInterval(timer);
    };
  }, []);

  const goToBilling = () => navigate("/app/settings/billing");
  const goToDashboard = () => navigate("/app/dashboard");
  const goBack = () => navigate(-1);

  const { state, title, message, subscription, lastInvoice } = statusView;

  const badgeColor =
    state === "success"
      ? "bg-emerald-50 text-emerald-700 border-emerald-200"
      : state === "failed"
      ? "bg-red-50 text-red-700 border-red-200"
      : "bg-slate-50 text-slate-700 border-slate-200";

  return (
    <div className="min-h-screen bg-slate-50 px-4 sm:px-6 py-10 flex items-start justify-center">
      <div className="w-full max-w-xl">
        <div className="bg-white rounded-xl border border-slate-200 shadow-sm p-6 space-y-4">
          <div className="flex items-center justify-between gap-3">
            <div>
              <h1 className="text-lg sm:text-xl font-semibold text-slate-900">
                {title}
              </h1>
              <p className="text-[10px] sm:text-xs text-slate-600 mt-1">
                {message}
              </p>
            </div>
            <div
              className={
                "px-2.5 py-1 rounded-full border text-[8px] font-medium " +
                badgeColor
              }
            >
              {state === "checking" && "Checking status"}
              {state === "pending" && "Pending confirmation"}
              {state === "success" && "Subscription active"}
              {state === "failed" && "Payment not confirmed"}
            </div>
          </div>

          {(source || orderId || sessionId) && (
            <div className="text-[8px] text-slate-500 space-y-0.5">
              {source && (
                <div>
                  Source: <span className="font-semibold">{source}</span>
                </div>
              )}
              {orderId && (
                <div>
                  Order:{" "}
                  <span className="font-mono font-semibold">{orderId}</span>
                </div>
              )}
              {sessionId && (
                <div>
                  Session:{" "}
                  <span className="font-mono font-semibold">{sessionId}</span>
                </div>
              )}
            </div>
          )}

          {subscription && (
            <div className="mt-2 p-3 rounded-lg bg-slate-50 border border-slate-100">
              <div className="text-[9px] text-slate-500 mb-1">
                Current subscription
              </div>
              <div className="flex items-center justify-between text-[9px]">
                <div>
                  <div className="font-semibold text-slate-900">
                    {subscription.planName || subscription.planId || "‚Äî"}
                  </div>
                  <div className="text-slate-500">
                    Status:{" "}
                    <span className="font-medium">{subscription.status}</span>
                  </div>
                </div>
                {subscription.currentPeriodEndUtc && (
                  <div className="text-right text-slate-500">
                    <div>Period ends</div>
                    <div className="font-medium text-slate-900">
                      {formatDate(subscription.currentPeriodEndUtc)}
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}

          {lastInvoice && (
            <div className="mt-1 p-3 rounded-lg bg-slate-50 border border-slate-100">
              <div className="flex items-center justify-between text-[9px]">
                <div>
                  <div className="text-slate-500">Latest invoice</div>
                  <div className="font-semibold text-slate-900">
                    {lastInvoice.number || lastInvoice.id?.slice(0, 8) || "‚Äî"}
                  </div>
                  <div className="text-slate-500">
                    Status:{" "}
                    <span className="font-medium">{lastInvoice.status}</span>
                  </div>
                </div>
                <div className="text-right text-slate-500">
                  <div>Created</div>
                  <div className="font-medium">
                    {formatDate(lastInvoice.createdAtUtc)}
                  </div>
                  {lastInvoice.total != null && (
                    <div className="mt-1 text-slate-900">
                      {new Intl.NumberFormat("en-IN", {
                        style: "currency",
                        currency: lastInvoice.currency || "INR",
                        maximumFractionDigits: 2,
                      }).format(lastInvoice.total || 0)}
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}

          <div className="mt-3 flex flex-wrap gap-2">
            {state === "success" && (
              <>
                <button
                  onClick={goToDashboard}
                  className="px-3 py-1.5 rounded-md bg-slate-900 text-white text-[10px] font-semibold hover:bg-black"
                >
                  Go to Dashboard
                </button>
                <button
                  onClick={goToBilling}
                  className="px-3 py-1.5 rounded-md border border-slate-300 text-[10px] text-slate-800 hover:bg-slate-50"
                >
                  View Billing &amp; Invoices
                </button>
              </>
            )}

            {state === "pending" && (
              <>
                <button
                  onClick={() => window.location.reload()}
                  className="px-3 py-1.5 rounded-md bg-slate-900 text-white text-[10px] font-semibold hover:bg-black"
                >
                  Refresh Status
                </button>
                <button
                  onClick={goToBilling}
                  className="px-3 py-1.5 rounded-md border border-slate-300 text-[10px] text-slate-800 hover:bg-slate-50"
                >
                  Open Billing Page
                </button>
              </>
            )}

            {state === "failed" && (
              <>
                <button
                  onClick={goToBilling}
                  className="px-3 py-1.5 rounded-md bg-red-600 text-white text-[10px] font-semibold hover:bg-red-700"
                >
                  Retry from Billing
                </button>
                <button
                  onClick={goBack}
                  className="px-3 py-1.5 rounded-md border border-slate-300 text-[10px] text-slate-800 hover:bg-slate-50"
                >
                  Go Back
                </button>
              </>
            )}

            {state === "checking" && (
              <div className="flex items-center gap-2 text-[9px] text-slate-500">
                <span className="h-3 w-3 border border-slate-400 border-t-transparent rounded-full animate-spin" />
                Checking latest subscription status‚Ä¶
              </div>
            )}
          </div>

          {attempts > 0 && (
            <div className="text-[7px] text-slate-400 mt-2">
              Checked status {attempts + 1} time(s).
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

export default PaymentStatusPage;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Payment\planCatalog.js 
====================================================== 
 
// üìÑ src/pages/Payment/planCatalog.js

// ‚úÖ Stable identifiers for internal usage
export const PLAN_IDS = {
  BASIC: "basic",
  SMART: "smart",
  ADVANCED: "advanced",
};

// ‚úÖ Static fallback / default catalog
// This is the single place to define plan metadata in the frontend.
// Backend /api/plans will later override values but keep the same IDs & codes.
const STATIC_PLANS = [
  {
    id: PLAN_IDS.BASIC,
    code: "XBASIC",
    name: "Basic",
    description: "Ideal for getting started and trying the platform.",
    isPopular: false,
    currency: "INR",
    priceMonthly: 0,
    priceYearly: 0,
    features: [
      "Send WhatsApp messages",
      "Manage contacts & tags",
      "Basic CRM access",
    ],
  },
  {
    id: PLAN_IDS.SMART,
    code: "XSMART",
    name: "Smart",
    description: "For growing teams running campaigns & catalogs.",
    isPopular: true, // highlighted tier
    currency: "INR",
    priceMonthly: 399,
    priceYearly: 3999,
    features: [
      "Campaign management",
      "Product catalog sharing",
      "Catalog analytics",
      "Reminder automation",
    ],
  },
  {
    id: PLAN_IDS.ADVANCED,
    code: "XADVANCED",
    name: "Advanced",
    description: "For advanced CRM insights and power users.",
    isPopular: false,
    currency: "INR",
    priceMonthly: 899,
    priceYearly: 8999,
    features: [
      "CRM insights & reports",
      "Advanced analytics",
      "Team collaboration tools",
      "Priority support",
    ],
  },
];

// üëâ Public helpers

// Get all plans (already normalized); used by BillingPage, selectors, etc.
export function getAllPlans() {
  return [...STATIC_PLANS];
}

// Get a plan by internal id (basic/smart/advanced)
export function getPlanById(id) {
  if (!id) return null;
  const key = String(id).toLowerCase();
  return STATIC_PLANS.find(p => p.id.toLowerCase() === key) || null;
}

// Get a plan by stable code (XBASIC / XSMART / XADVANCED)
export function getPlanByCode(code) {
  if (!code) return null;
  const key = String(code).toLowerCase();
  return STATIC_PLANS.find(p => (p.code || "").toLowerCase() === key) || null;
}

// Normalize backend /api/plans into this shape.
// If backend not ready or returns unexpected shape, caller can safely fall back.
export function normalizeApiPlans(raw) {
  if (!raw) return [];

  const list = Array.isArray(raw)
    ? raw
    : Array.isArray(raw.plans)
    ? raw.plans
    : [];

  return list
    .filter(p => p && p.id && p.name)
    .map(p => ({
      id: String(p.id),
      code: p.code || String(p.id).toUpperCase(),
      name: p.name,
      description: p.description || "",
      isPopular: Boolean(p.isPopular),
      currency: p.currency || "INR",
      priceMonthly: typeof p.priceMonthly === "number" ? p.priceMonthly : 0,
      priceYearly: typeof p.priceYearly === "number" ? p.priceYearly : 0,
      features: Array.isArray(p.features) ? p.features : [],
    }));
}

// Build a comparison matrix for UI components.
// Output:
// [
//   { key, label, values: { basic: '1 user', smart: '5 users', advanced: '20 users' } },
//   ...
// ]
export function buildFeatureMatrix() {
  const plans = getAllPlans();

  const featureDefs = [
    { key: "users", label: "Team members" },
    { key: "contacts", label: "Contacts" },
    { key: "catalog", label: "Catalog & campaigns" },
    { key: "automation", label: "Automation workflows" },
    { key: "analytics", label: "Advanced analytics" },
    { key: "support", label: "Priority support" },
  ];

  return featureDefs.map(def => {
    const values = {};
    for (const plan of plans) {
      switch (def.key) {
        case "users":
          values[plan.id] =
            plan.id === PLAN_IDS.BASIC
              ? "1"
              : plan.id === PLAN_IDS.SMART
              ? "Up to 5"
              : "Up to 20";
          break;
        case "contacts":
          values[plan.id] =
            plan.id === PLAN_IDS.BASIC
              ? "2,000"
              : plan.id === PLAN_IDS.SMART
              ? "10,000"
              : "50,000";
          break;
        case "catalog":
          values[plan.id] =
            plan.id === PLAN_IDS.BASIC
              ? "Basic tools"
              : plan.id === PLAN_IDS.SMART
              ? "Catalog + campaigns"
              : "Full catalog + bulk campaigns";
          break;
        case "automation":
          values[plan.id] =
            plan.id === PLAN_IDS.BASIC
              ? "‚Äî"
              : plan.id === PLAN_IDS.SMART
              ? "Basic journeys"
              : "Advanced journeys";
          break;
        case "analytics":
          values[plan.id] =
            plan.id === PLAN_IDS.BASIC
              ? "Basic"
              : plan.id === PLAN_IDS.SMART
              ? "Advanced"
              : "Pro-level insights";
          break;
        case "support":
          values[plan.id] =
            plan.id === PLAN_IDS.BASIC
              ? "Standard"
              : plan.id === PLAN_IDS.SMART
              ? "Priority"
              : "Priority+";
          break;
        default:
          values[plan.id] = "‚Äî";
      }
    }
    return {
      key: def.key,
      label: def.label,
      values,
    };
  });
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Payment\PlanSelectWidget.jsx 
====================================================== 
 
// üìÑ src/pages/Payment/PlanSelectWidget.jsx

import React from "react";
import { getAllPlans } from "./planCatalog";

function PlanSelectWidget({
  value,
  onChange,
  billingCycle = "Monthly",
  compact = false,
  disabled = false,
}) {
  const plans = getAllPlans();

  if (!plans.length) return null;

  const handleSelect = id => {
    if (!disabled && onChange) onChange(id);
  };

  if (compact) {
    // Compact <select> version for forms
    return (
      <div className="flex flex-col gap-1">
        <label className="text-[8px] text-slate-600">Choose a plan</label>
        <select
          value={value || ""}
          onChange={e => handleSelect(e.target.value)}
          disabled={disabled}
          className="px-2 py-1.5 rounded-md border border-slate-200 text-[9px] focus:outline-none focus:ring-1 focus:ring-purple-500 focus:border-purple-500 disabled:bg-slate-50 disabled:text-slate-400"
        >
          <option value="" disabled>
            Select a plan
          </option>
          {plans.map(plan => (
            <option key={plan.id} value={plan.id}>
              {plan.name}{" "}
              {billingCycle === "Yearly"
                ? `(${plan.priceYearly || 0} / yr)`
                : `(${plan.priceMonthly || 0} / mo)`}
            </option>
          ))}
        </select>
      </div>
    );
  }

  // Card-style selector (for upgrade modals, etc.)
  return (
    <div className="grid sm:grid-cols-3 gap-3">
      {plans.map(plan => {
        const isSelected = plan.id === value;
        const price =
          billingCycle === "Yearly" ? plan.priceYearly : plan.priceMonthly;

        return (
          <button
            key={plan.id}
            type="button"
            onClick={() => handleSelect(plan.id)}
            disabled={disabled}
            className={
              "flex flex-col gap-1.5 p-3 rounded-lg border text-left transition-all bg-white " +
              "shadow-[0_1px_2px_rgba(15,23,42,0.04)] " +
              (isSelected
                ? "border-purple-600 ring-2 ring-purple-100"
                : "border-slate-200 hover:border-slate-300") +
              (disabled ? " opacity-60 cursor-not-allowed" : "")
            }
          >
            <div className="flex items-center justify-between gap-2">
              <div className="text-[10px] font-semibold text-slate-900">
                {plan.name}
              </div>
              {plan.isPopular && (
                <span className="px-2 py-0.5 rounded-full bg-slate-900 text-[7px] text-white font-semibold">
                  Recommended
                </span>
              )}
            </div>
            <div className="text-[8px] text-slate-600">{plan.description}</div>
            <div className="mt-1">
              <div className="text-[11px] font-semibold text-slate-900">
                ‚Çπ{price || 0}
              </div>
              <div className="text-[7px] text-slate-500">
                per {billingCycle === "Yearly" ? "year" : "month"}
              </div>
            </div>
          </button>
        );
      })}
    </div>
  );
}

export default PlanSelectWidget;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Plans\FeatureComparison.jsx 
====================================================== 
 
// src/pages/Plans/PlanFeatures/FeatureComparison.jsx

const features = [
  { name: "Send Message", basic: true, smart: true, advanced: true },
  { name: "Campaigns", basic: false, smart: true, advanced: true },
  { name: "CRM Insights", basic: false, smart: false, advanced: true },
  { name: "Priority Support", basic: false, smart: false, advanced: true },
];

export default function FeatureComparison() {
  return (
    <div className="mt-8">
      <h3 className="text-lg font-semibold text-purple-800 mb-4">
        Feature Comparison
      </h3>
      <div className="overflow-auto">
        <table className="min-w-full bg-white border rounded-lg shadow-sm">
          <thead>
            <tr>
              <th className="text-left p-3 border-b">Feature</th>
              <th className="text-center p-3 border-b">Basic</th>
              <th className="text-center p-3 border-b">Smart</th>
              <th className="text-center p-3 border-b">Advanced</th>
            </tr>
          </thead>
          <tbody>
            {features.map(f => (
              <tr key={f.name}>
                <td className="p-3 border-b">{f.name}</td>
                <td className="text-center border-b">{f.basic ? "‚úÖ" : "‚Äî"}</td>
                <td className="text-center border-b">{f.smart ? "‚úÖ" : "‚Äî"}</td>
                <td className="text-center border-b">
                  {f.advanced ? "‚úÖ" : "‚Äî"}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Plans\PlanSelectWidget.jsx 
====================================================== 
 
// src/pages/Plans/PlanSelection/PlanSelectWidget.jsx

export default function PlanSelectWidget({ currentPlan, onChange }) {
  const plans = ["basic", "smart", "advanced"];

  return (
    <div className="flex items-center gap-4">
      {plans.map(plan => (
        <button
          key={plan}
          onClick={() => onChange(plan)}
          className={`px-4 py-2 rounded-full border ${
            currentPlan === plan
              ? "bg-purple-600 text-white"
              : "bg-white text-purple-600 border-purple-400"
          }`}
        >
          {plan.charAt(0).toUpperCase() + plan.slice(1)}
        </button>
      ))}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Plans\UpgradePlanPage.jsx 
====================================================== 
 
import React, { useState } from "react";
import { CheckCircle, Star, Flame } from "lucide-react";
import { usePlan } from "../auth/hooks/usePlan";

const plans = [
  {
    id: "basic",
    name: "Basic",
    priceMonthly: 0,
    priceYearly: 0,
    features: [
      "Send WhatsApp messages",
      "Manage contacts & tags",
      "Access basic CRM",
    ],
    icon: "‚ö°",
  },
  {
    id: "smart",
    name: "Smart",
    priceMonthly: 399,
    priceYearly: 3999,
    features: [
      "Campaign management",
      "Product catalog sharing",
      "Catalog analytics",
      "Reminder automation",
    ],
    tag: "popular",
    icon: "üëë",
  },
  {
    id: "advanced",
    name: "Advanced",
    priceMonthly: 899,
    priceYearly: 8999,
    features: [
      "CRM insights",
      "Catalog CTA heatmaps",
      "Team collaboration tools",
      "Priority support",
    ],
    tag: "recommended",
    icon: "üëë",
  },
];

export default function UpgradePlanPage() {
  const [billingCycle, setBillingCycle] = useState("yearly");
  const { plan: currentPlan } = usePlan();

  const getPrice = plan =>
    billingCycle === "monthly" ? plan.priceMonthly : plan.priceYearly;

  return (
    <div className="p-8">
      <h2 className="text-2xl font-bold text-purple-700 flex items-center gap-2">
        üöÄ Upgrade Your Plan
      </h2>
      <p className="text-gray-500 mt-1">
        Unlock premium features to grow your business faster.
      </p>

      {/* Toggle Monthly/Yearly */}
      <div className="flex items-center gap-4 mt-6">
        <button
          className={`px-4 py-2 rounded-full text-sm font-medium ${
            billingCycle === "monthly"
              ? "bg-purple-600 text-white"
              : "bg-gray-100 text-gray-600"
          }`}
          onClick={() => setBillingCycle("monthly")}
        >
          Monthly Billing
        </button>
        <button
          className={`px-4 py-2 rounded-full text-sm font-medium ${
            billingCycle === "yearly"
              ? "bg-purple-600 text-white"
              : "bg-gray-100 text-gray-600"
          }`}
          onClick={() => setBillingCycle("yearly")}
        >
          Yearly Billing üéÅ{" "}
          <span className="ml-1 text-yellow-400">Save 2 Months</span>
        </button>
      </div>

      {/* Plan Cards */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
        {plans.map(plan => {
          const price = getPrice(plan);
          const isCurrent = currentPlan === plan.id;
          const isYearly = billingCycle === "yearly";
          const showDiscount = plan.id !== "basic" && isYearly;
          const isRecommended = plan.tag === "recommended";
          const isPopular = plan.tag === "popular";

          return (
            <div
              key={plan.id}
              className={`relative bg-white border rounded-xl p-6 shadow-md flex flex-col ${
                isRecommended
                  ? "border-yellow-500 bg-gradient-to-br from-yellow-50 to-white"
                  : ""
              }`}
            >
              {/* Tag badges */}
              {isPopular && (
                <span className="absolute top-3 right-3 bg-purple-600 text-white text-xs font-semibold px-2 py-0.5 rounded-full shadow">
                  <Flame size={12} className="inline mr-1" />
                  Most Popular
                </span>
              )}
              {isRecommended && (
                <span className="absolute top-3 right-3 bg-yellow-500 text-white text-xs font-semibold px-2 py-0.5 rounded-full shadow">
                  <Star size={12} className="inline mr-1" />
                  Recommended
                </span>
              )}

              <div className="text-2xl font-bold text-purple-700 flex items-center gap-2 mb-2">
                <span>{plan.icon}</span> {plan.name}
              </div>

              <div className="text-3xl font-extrabold mt-2 mb-1">
                {plan.priceMonthly === 0 && plan.priceYearly === 0 ? (
                  <>Free</>
                ) : (
                  <>
                    ‚Çπ{price}
                    <span className="text-sm font-normal text-gray-500">
                      {" "}
                      /{billingCycle === "monthly" ? "mo" : "yr"}
                    </span>
                  </>
                )}
              </div>

              {/* Discount info */}
              {showDiscount && (
                <div className="text-xs text-green-600 font-semibold mt-1">
                  Save ‚Çπ{plan.priceMonthly * 12 - plan.priceYearly} per year!
                </div>
              )}

              <ul className="text-sm mt-4 space-y-2">
                {plan.features.map((f, idx) => (
                  <li
                    key={idx}
                    className="flex items-center gap-2 text-gray-700"
                  >
                    <CheckCircle className="text-green-500" size={16} />
                    {f}
                  </li>
                ))}
              </ul>

              <button
                disabled={isCurrent}
                className={`w-full mt-auto px-4 py-2 text-sm font-medium rounded-lg transition mt-6 ${
                  isCurrent
                    ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                    : "bg-purple-600 text-white hover:bg-purple-700"
                }`}
              >
                {isCurrent ? "Current Plan" : "Choose Plan"}
              </button>
            </div>
          );
        })}
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Reminders\ReminderForm.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axios from "axios";
import axiosClient from "../../api/axiosClient"; // ‚úÖ for timeline logging
import { toast } from "react-toastify";

function ReminderForm({ selectedReminder, onSaveComplete }) {
  const [formData, setFormData] = useState({
    contactId: "3fa85f64-5717-4562-b3fc-2c963f66afa6", // Will be dynamic later
    title: "",
    description: "",
    dueAt: "",
    reminderType: "",
    priority: 2,
    isRecurring: false,
    recurrencePattern: "",
    sendWhatsappNotification: false,
    linkedCampaign: "",
    status: "Pending",
  });

  useEffect(() => {
    if (selectedReminder) {
      setFormData({ ...selectedReminder });
    } else {
      setFormData({
        contactId: "3fa85f64-5717-4562-b3fc-2c963f66afa6",
        title: "",
        description: "",
        dueAt: "",
        reminderType: "",
        priority: 2,
        isRecurring: false,
        recurrencePattern: "",
        sendWhatsappNotification: false,
        linkedCampaign: "",
        status: "Pending",
      });
    }
  }, [selectedReminder]);

  const handleChange = e => {
    const { name, value, type, checked } = e.target;
    const val = type === "checkbox" ? checked : value;
    setFormData(prev => ({ ...prev, [name]: val }));
  };

  const handleSubmit = async e => {
    e.preventDefault();

    try {
      let isNew = false;

      if (selectedReminder?.id) {
        await axios.put(`/api/reminders/${selectedReminder.id}`, formData);
        toast.info("üîÑ Reminder updated.");
      } else {
        await axios.post("/api/reminders", formData);
        toast.success("‚úÖ Reminder added.");
        isNew = true;
      }

      // ‚úÖ Auto-log to timeline
      try {
        const { title, dueAt, priority, contactId } = formData;

        const priorityLabel =
          {
            1: "High",
            2: "Medium",
            3: "Low",
          }[priority] || "Medium";

        const formattedDate = new Date(dueAt).toLocaleString();

        await axiosClient.post("/leadtimeline", {
          contactId,
          eventType: "ReminderSet",
          description: `Reminder titled '${title}' ${
            isNew ? "added" : "updated"
          } for ${formattedDate} with priority ${priorityLabel}.`,
          createdBy: "System",
          source: "Reminder",
          category: "Auto",
          isSystemGenerated: true,
        });
      } catch (timelineErr) {
        console.warn("‚ö†Ô∏è Timeline log failed:", timelineErr);
      }

      onSaveComplete();
    } catch (err) {
      if (err.response) {
        console.error("üì¶ Backend error response:", err.response.data);
      } else {
        console.error("‚ùå Unknown error while saving reminder:", err);
      }
      toast.error("‚ùå Failed to save reminder.");
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-3">
      <input
        name="title"
        value={formData.title}
        onChange={handleChange}
        placeholder="Reminder Title"
        className="w-full border rounded-lg px-3 py-2"
        required
      />
      <textarea
        name="description"
        value={formData.description}
        onChange={handleChange}
        placeholder="Description"
        className="w-full border rounded-lg px-3 py-2"
      />
      <input
        type="datetime-local"
        name="dueAt"
        value={formData.dueAt}
        onChange={handleChange}
        className="w-full border rounded-lg px-3 py-2"
        required
      />
      <input
        name="reminderType"
        value={formData.reminderType}
        onChange={handleChange}
        placeholder="Type (e.g., Call, Email)"
        className="w-full border rounded-lg px-3 py-2"
      />
      <select
        name="priority"
        value={formData.priority}
        onChange={handleChange}
        className="w-full border rounded-lg px-3 py-2"
      >
        <option value={1}>High</option>
        <option value={2}>Medium</option>
        <option value={3}>Low</option>
      </select>
      <div className="flex gap-4 flex-wrap">
        <label className="flex items-center">
          <input
            type="checkbox"
            name="isRecurring"
            checked={formData.isRecurring}
            onChange={handleChange}
            className="mr-2"
          />
          Recurring
        </label>
        <input
          name="recurrencePattern"
          value={formData.recurrencePattern}
          onChange={handleChange}
          placeholder="e.g., Weekly"
          className="flex-1 border rounded-lg px-3 py-2"
        />
      </div>
      <label className="flex items-center">
        <input
          type="checkbox"
          name="sendWhatsappNotification"
          checked={formData.sendWhatsappNotification}
          onChange={handleChange}
          className="mr-2"
        />
        Send WhatsApp Notification
      </label>
      <button
        type="submit"
        className="bg-purple-600 text-white px-4 py-2 rounded-lg"
      >
        {selectedReminder ? "Update Reminder" : "Add Reminder"}
      </button>
    </form>
  );
}

export default ReminderForm;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Reminders\ReminderList.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axios from "axios";

function ReminderList({ onEdit, refreshKey }) {
  const [reminders, setReminders] = useState([]);

  useEffect(() => {
    fetchReminders();
  }, [refreshKey]);

  const fetchReminders = async () => {
    try {
      const res = await axios.get("/api/reminders");
      setReminders(res.data);
    } catch (err) {
      console.error("‚ùå Failed to fetch reminders:", err);
    }
  };

  const handleDelete = async id => {
    const confirmDelete = window.confirm("Delete this reminder?");
    if (!confirmDelete) return;

    try {
      await axios.delete(`/api/reminders/${id}`);
      fetchReminders();
    } catch (err) {
      console.error("‚ùå Failed to delete reminder:", err);
    }
  };

  return (
    <div className="overflow-x-auto">
      <table className="w-full border text-left rounded-lg">
        <thead className="bg-gray-100 text-sm font-semibold">
          <tr>
            <th className="p-2">Title</th>
            <th className="p-2">Due At</th>
            <th className="p-2">Status</th>
            <th className="p-2">Actions</th>
          </tr>
        </thead>
        <tbody>
          {reminders.map(reminder => (
            <tr key={reminder.id} className="border-t">
              <td className="p-2">{reminder.title}</td>
              <td className="p-2">
                {new Date(reminder.dueAt).toLocaleString()}
              </td>
              <td className="p-2">{reminder.status}</td>
              <td className="p-2 flex gap-2">
                <button
                  onClick={() => onEdit(reminder)}
                  className="px-2 py-1 text-sm bg-blue-500 text-white rounded"
                >
                  Edit
                </button>
                <button
                  onClick={() => handleDelete(reminder.id)}
                  className="px-2 py-1 text-sm bg-red-500 text-white rounded"
                >
                  Delete
                </button>
              </td>
            </tr>
          ))}
          {reminders.length === 0 && (
            <tr>
              <td colSpan="4" className="text-center py-4 text-gray-500">
                No reminders found.
              </td>
            </tr>
          )}
        </tbody>
      </table>
    </div>
  );
}

export default ReminderList;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Reminders\Reminders.jsx 
====================================================== 
 
import React, { useState } from "react";
import ReminderForm from "./ReminderForm";
import ReminderList from "./ReminderList";

function Reminders() {
  const [selectedReminder, setSelectedReminder] = useState(null);
  const [refreshKey, setRefreshKey] = useState(0);
  const [isDrawerOpen, setIsDrawerOpen] = useState(false);

  const handleEdit = reminder => {
    setSelectedReminder(reminder);
    setIsDrawerOpen(true);
  };

  const handleAddNew = () => {
    setSelectedReminder(null);
    setIsDrawerOpen(true);
  };

  const handleSaveComplete = () => {
    setIsDrawerOpen(false);
    setSelectedReminder(null);
    setRefreshKey(prev => prev + 1);
  };

  return (
    <div className="p-4 relative">
      {/* Header */}
      <div className="flex justify-between items-center mb-4">
        <h2 className="text-2xl font-semibold">Reminders</h2>
        <button
          onClick={handleAddNew}
          className="bg-purple-600 text-white px-4 py-2 rounded-lg"
        >
          ‚ûï Add Reminder
        </button>
      </div>

      {/* Reminder Cards */}
      <ReminderList onEdit={handleEdit} refreshKey={refreshKey} />

      {/* Drawer */}
      {isDrawerOpen && (
        <div className="fixed top-0 right-0 w-full max-w-md h-full bg-white shadow-2xl z-50 transition-transform duration-300 border-l overflow-y-auto">
          <div className="flex items-center justify-between p-4 border-b">
            <h2 className="text-lg font-bold">
              {selectedReminder ? "Edit Reminder" : "Add Reminder"}
            </h2>
            <button
              onClick={() => setIsDrawerOpen(false)}
              className="text-gray-500 text-xl"
            >
              √ó
            </button>
          </div>
          <div className="p-4">
            <ReminderForm
              selectedReminder={selectedReminder}
              onSaveComplete={handleSaveComplete}
            />
          </div>
        </div>
      )}
    </div>
  );
}

export default Reminders;

// import React, { useState } from "react";
// import ReminderForm from "./ReminderForm";
// import ReminderList from "./ReminderList";

// function Reminders() {
//   const [selectedReminder, setSelectedReminder] = useState(null);
//   const [refreshKey, setRefreshKey] = useState(0); // used to refresh list

//   const handleEdit = reminder => {
//     setSelectedReminder(reminder);
//   };

//   const handleSaveComplete = () => {
//     setSelectedReminder(null);
//     setRefreshKey(prev => prev + 1);
//   };

//   return (
//     <div className="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
//       {/* Left: Form */}
//       <div className="bg-white rounded-2xl shadow-md p-4">
//         <h2 className="text-xl font-semibold mb-2">
//           {selectedReminder ? "Edit Reminder" : "Add Reminder"}
//         </h2>
//         <ReminderForm
//           selectedReminder={selectedReminder}
//           onSaveComplete={handleSaveComplete}
//         />
//       </div>

//       {/* Right: List */}
//       <div className="bg-white rounded-2xl shadow-md p-4">
//         <h2 className="text-xl font-semibold mb-2">Reminder List</h2>
//         <ReminderList onEdit={handleEdit} refreshKey={refreshKey} />
//       </div>
//     </div>
//   );
// }

// export default Reminders;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\ReportingModule\DirectMessageHistory.jsx 
====================================================== 
 
import React, { useEffect, useState, useCallback } from "react";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";
import { Loader2 } from "lucide-react";

export default function DirectMessageHistory() {
  const [messageLogs, setMessageLogs] = useState([]);
  const [statusFilter, setStatusFilter] = useState("All");
  const [searchQuery, setSearchQuery] = useState("");
  const [page, setPage] = useState(1);
  const [pageSize] = useState(10);
  const [hasMore, setHasMore] = useState(false);
  const [loading, setLoading] = useState(false);

  // üü¢ Wrap fetchLogs in useCallback to avoid ESLint dependency warning
  const fetchLogs = useCallback(async () => {
    setLoading(true);
    try {
      const res = await axiosClient.get("/reporting/messages/history", {
        params: {
          page,
          pageSize,
          status: statusFilter === "All" ? null : statusFilter,
          search: searchQuery || null,
        },
      });

      const newLogs = res.data?.data?.items || [];
      const total = res.data?.data?.totalCount || 0;

      if (page === 1) {
        setMessageLogs(newLogs);
      } else {
        setMessageLogs(prev => [...prev, ...newLogs]);
      }

      setHasMore(page * pageSize < total);
    } catch (err) {
      console.error("Failed to load logs", err);
      toast.error("‚ö†Ô∏è Error fetching message history");
    } finally {
      setLoading(false);
    }
  }, [page, pageSize, statusFilter, searchQuery]);

  useEffect(() => {
    fetchLogs();
  }, [fetchLogs]); // Only re-run when fetchLogs identity changes

  const handleStatusChange = e => {
    setStatusFilter(e.target.value);
    setPage(1);
  };

  const handleSearch = e => {
    e.preventDefault();
    setPage(1);
    // üîµ Also search with updated value
    fetchLogs();
  };

  const handleShowMore = () => {
    if (hasMore) {
      setPage(prev => prev + 1);
    }
  };

  return (
    <div className="max-w-6xl mx-auto p-6 space-y-6">
      <h2 className="text-2xl font-bold text-purple-700">üìú Message History</h2>

      {/* üîç Filters */}
      <form
        onSubmit={handleSearch}
        className="flex flex-wrap gap-4 items-end bg-white p-4 rounded-xl shadow"
      >
        <div className="flex flex-col">
          <label className="text-sm font-medium text-gray-700">Status</label>
          <select
            value={statusFilter}
            onChange={handleStatusChange}
            className="border rounded-lg px-3 py-2"
          >
            <option>All</option>
            <option>Success</option>
            <option>Failed</option>
          </select>
        </div>

        <div className="flex flex-col flex-1">
          <label className="text-sm font-medium text-gray-700">Search</label>
          <input
            type="text"
            placeholder="Search by number or name"
            className="border rounded-lg px-3 py-2 w-full"
            value={searchQuery}
            onChange={e => setSearchQuery(e.target.value)}
          />
        </div>

        <button
          type="submit"
          className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
        >
          üîç Search
        </button>
      </form>

      {/* üìä Table */}
      <div className="bg-white rounded-xl shadow overflow-x-auto">
        <table className="w-full text-sm text-left border">
          <thead className="bg-gray-100 text-gray-700">
            <tr>
              <th className="px-3 py-2">Recipient</th>
              <th className="px-3 py-2">Status</th>
              <th className="px-3 py-2">Sent At</th>
              <th className="px-3 py-2">Message</th>
            </tr>
          </thead>
          <tbody>
            {loading && page === 1 ? (
              <tr>
                <td colSpan="4" className="text-center py-6">
                  <Loader2 className="animate-spin inline w-6 h-6 text-purple-600" />
                </td>
              </tr>
            ) : messageLogs.length > 0 ? (
              messageLogs.map(log => (
                <tr key={log.id} className="border-b">
                  <td className="px-3 py-2">{log.recipientNumber}</td>
                  <td className="px-3 py-2">
                    <span
                      className={`px-2 py-1 rounded-full text-xs font-medium ${
                        log.status === "Success"
                          ? "bg-green-100 text-green-700"
                          : "bg-red-100 text-red-600"
                      }`}
                    >
                      {log.status}
                    </span>
                  </td>
                  <td className="px-3 py-2">
                    {log.sentAt ? new Date(log.sentAt).toLocaleString() : "‚Äî"}
                  </td>
                  <td
                    className="px-3 py-2 max-w-[300px] truncate"
                    title={log.messageContent}
                  >
                    {log.messageContent || "(empty)"}
                  </td>
                </tr>
              ))
            ) : (
              <tr>
                <td colSpan="4" className="text-center text-gray-500 py-6">
                  No messages found.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>

      {/* üîΩ Show More */}
      {hasMore && !loading && (
        <div className="text-center mt-4">
          <button
            onClick={handleShowMore}
            className="px-6 py-2 text-sm font-medium bg-purple-600 text-white rounded-lg hover:bg-purple-700"
          >
            Show More
          </button>
        </div>
      )}

      {hasMore && loading && page > 1 && (
        <div className="text-center mt-4 text-purple-600">
          <Loader2 className="animate-spin inline w-5 h-5 mr-2" />
          Loading more...
        </div>
      )}
    </div>
  );
}

// import React, { useEffect, useState } from "react";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import { Loader2 } from "lucide-react";

// export default function DirectMessageHistory() {
//   const [messageLogs, setMessageLogs] = useState([]);
//   const [statusFilter, setStatusFilter] = useState("All");
//   const [searchQuery, setSearchQuery] = useState("");
//   const [page, setPage] = useState(1);
//   const [pageSize] = useState(10);
//   const [hasMore, setHasMore] = useState(false);
//   const [loading, setLoading] = useState(false);

//   useEffect(() => {
//     fetchLogs();
//   }, [page, statusFilter]);

//   const fetchLogs = async () => {
//     setLoading(true);
//     try {
//       const res = await axiosClient.get("/reporting/messages/history", {
//         params: {
//           page,
//           pageSize,
//           status: statusFilter === "All" ? null : statusFilter,
//           search: searchQuery || null,
//         },
//       });

//       const newLogs = res.data?.data?.items || [];
//       const total = res.data?.data?.totalCount || 0;

//       if (page === 1) {
//         setMessageLogs(newLogs);
//       } else {
//         setMessageLogs(prev => [...prev, ...newLogs]);
//       }

//       setHasMore(page * pageSize < total);
//     } catch (err) {
//       console.error("Failed to load logs", err);
//       toast.error("‚ö†Ô∏è Error fetching message history");
//     } finally {
//       setLoading(false);
//     }
//   };

//   const handleStatusChange = e => {
//     setStatusFilter(e.target.value);
//     setPage(1);
//   };

//   const handleSearch = e => {
//     e.preventDefault();
//     setPage(1);
//     fetchLogs();
//   };

//   const handleShowMore = () => {
//     if (hasMore) {
//       setPage(prev => prev + 1);
//     }
//   };

//   return (
//     <div className="max-w-6xl mx-auto p-6 space-y-6">
//       <h2 className="text-2xl font-bold text-purple-700">üìú Message History</h2>

//       {/* üîç Filters */}
//       <form
//         onSubmit={handleSearch}
//         className="flex flex-wrap gap-4 items-end bg-white p-4 rounded-xl shadow"
//       >
//         <div className="flex flex-col">
//           <label className="text-sm font-medium text-gray-700">Status</label>
//           <select
//             value={statusFilter}
//             onChange={handleStatusChange}
//             className="border rounded-lg px-3 py-2"
//           >
//             <option>All</option>
//             <option>Success</option>
//             <option>Failed</option>
//           </select>
//         </div>

//         <div className="flex flex-col flex-1">
//           <label className="text-sm font-medium text-gray-700">Search</label>
//           <input
//             type="text"
//             placeholder="Search by number or name"
//             className="border rounded-lg px-3 py-2 w-full"
//             value={searchQuery}
//             onChange={e => setSearchQuery(e.target.value)}
//           />
//         </div>

//         <button
//           type="submit"
//           className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
//         >
//           üîç Search
//         </button>
//       </form>

//       {/* üìä Table */}
//       <div className="bg-white rounded-xl shadow overflow-x-auto">
//         <table className="w-full text-sm text-left border">
//           <thead className="bg-gray-100 text-gray-700">
//             <tr>
//               <th className="px-3 py-2">Recipient</th>
//               <th className="px-3 py-2">Status</th>
//               <th className="px-3 py-2">Sent At</th>
//               <th className="px-3 py-2">Message</th>
//             </tr>
//           </thead>
//           <tbody>
//             {loading && page === 1 ? (
//               <tr>
//                 <td colSpan="4" className="text-center py-6">
//                   <Loader2 className="animate-spin inline w-6 h-6 text-purple-600" />
//                 </td>
//               </tr>
//             ) : messageLogs.length > 0 ? (
//               messageLogs.map(log => (
//                 <tr key={log.id} className="border-b">
//                   <td className="px-3 py-2">{log.recipientNumber}</td>
//                   <td className="px-3 py-2">
//                     <span
//                       className={`px-2 py-1 rounded-full text-xs font-medium ${
//                         log.status === "Success"
//                           ? "bg-green-100 text-green-700"
//                           : "bg-red-100 text-red-600"
//                       }`}
//                     >
//                       {log.status}
//                     </span>
//                   </td>
//                   <td className="px-3 py-2">
//                     {log.sentAt ? new Date(log.sentAt).toLocaleString() : "‚Äî"}
//                   </td>
//                   <td
//                     className="px-3 py-2 max-w-[300px] truncate"
//                     title={log.messageContent}
//                   >
//                     {log.messageContent || "(empty)"}
//                   </td>
//                 </tr>
//               ))
//             ) : (
//               <tr>
//                 <td colSpan="4" className="text-center text-gray-500 py-6">
//                   No messages found.
//                 </td>
//               </tr>
//             )}
//           </tbody>
//         </table>
//       </div>

//       {/* üîΩ Show More */}
//       {hasMore && !loading && (
//         <div className="text-center mt-4">
//           <button
//             onClick={handleShowMore}
//             className="px-6 py-2 text-sm font-medium bg-purple-600 text-white rounded-lg hover:bg-purple-700"
//           >
//             Show More
//           </button>
//         </div>
//       )}

//       {hasMore && loading && page > 1 && (
//         <div className="text-center mt-4 text-purple-600">
//           <Loader2 className="animate-spin inline w-5 h-5 mr-2" />
//           Loading more...
//         </div>
//       )}
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\reports\MessageLogsReport.jsx 
====================================================== 
 
// üìÑ src/pages/reports/MessageLogsReport.jsx
import React, { useCallback, useEffect, useMemo, useState } from "react";
import { Link } from "react-router-dom";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";
import { saveAs } from "file-saver";

// compact multiselect
import MultiSelect from "../../utils/MultiSelect";

const STATUS_OPTIONS = ["Queued", "Sent", "Delivered", "Read", "Failed"];
const DATE_PRESETS = [
  { key: "today", label: "Today" },
  { key: "yesterday", label: "Yesterday" },
  { key: "last7", label: "Last 7 days" },
  { key: "last30", label: "Last 30 days" },
  { key: "custom", label: "Custom‚Ä¶" },
];

const toOptions = arr => (arr || []).map(x => ({ label: x, value: x }));

function deriveFacetOptionsFromRows(items) {
  const senders = new Set();
  const wabas = new Set();
  for (const it of items || []) {
    if (it.senderId) senders.add(String(it.senderId).trim());
    const wid =
      it.wabaId ??
      it.wabaID ??
      it.metaWabaId ??
      it.businessWabaId ??
      it.waba_id ??
      null;
    if (wid) wabas.add(String(wid).trim());
  }
  const toSortedOptions = set =>
    Array.from(set)
      .filter(Boolean)
      .sort((a, b) => String(a).localeCompare(String(b)))
      .map(v => ({ label: v, value: v }));
  return {
    senderOptions: toSortedOptions(senders),
    wabaOptions: toSortedOptions(wabas),
  };
}

/* ---------- Message ID cell (truncate inline; multiline & Copy in HOVER POPOVER) ---------- */
function MessageIdCell({ value }) {
  const full = value || "";
  const short = full.length > 23 ? `${full.slice(0, 23)}‚Ä¶` : full;
  const [copied, setCopied] = useState(false);

  const doCopy = async () => {
    try {
      await navigator.clipboard.writeText(full);
      setCopied(true);
      setTimeout(() => setCopied(false), 1200);
    } catch {
      // keep silent per request (no toast); you can surface an inline error if desired
    }
  };

  return (
    <div className="relative group inline-block align-middle">
      {/* Inline: single line, truncated */}
      <span className="inline-block max-w-[220px] truncate font-mono text-gray-800">
        {short || "-"}
      </span>

      {/* Hover/focus popover: multiline + Copy + small 'Copied' badge */}
      {full && (
        <div
          className="
            pointer-events-auto
            invisible opacity-0 translate-y-1
            group-hover:visible group-hover:opacity-100 group-hover:translate-y-0
            group-focus-within:visible group-focus-within:opacity-100 group-focus-within:translate-y-0
            transition-opacity transition-transform
            absolute left-0 mt-1 z-30
            min-w-[320px] max-w-[560px]
            bg-white border rounded shadow px-3 py-2
          "
          role="tooltip"
        >
          <div className="flex items-start gap-2">
            <button
              type="button"
              onClick={doCopy}
              className="shrink-0 text-xs px-2 py-0.5 rounded border hover:bg-gray-50"
              title="Copy Message Id"
            >
              Copy
            </button>
            <code className="text-xs font-mono leading-snug break-all text-gray-900">
              {full}
            </code>
          </div>
          {copied && (
            <div className="mt-1 text-[11px] text-emerald-600">Copied</div>
          )}
        </div>
      )}
    </div>
  );
}

export default function MessageLogsReport() {
  // data
  const [rows, setRows] = useState([]);
  const [loading, setLoading] = useState(true);
  const [totalPages, setTotalPages] = useState(0);
  const [totalCount, setTotalCount] = useState(0);

  // filters/paging/sort
  const [search, setSearch] = useState("");
  const [dateKey, setDateKey] = useState("last7");
  const [from, setFrom] = useState("");
  const [to, setTo] = useState("");
  const [statuses, setStatuses] = useState([]);
  const [senderIds, setSenderIds] = useState([]);
  const [wabaIds, setWabaIds] = useState([]);

  // facet options
  const [senderOptions, setSenderOptions] = useState([]);
  const [wabaOptions, setWabaOptions] = useState([]);

  const [page, setPage] = useState(1);
  const [pageSize, setPageSize] = useState(25);
  const [sortBy, setSortBy] = useState("SentAt");
  const [sortDir, setSortDir] = useState("desc");

  // date range
  const range = useMemo(() => {
    const end = new Date();
    const start = new Date();
    if (dateKey === "today") start.setHours(0, 0, 0, 0);
    else if (dateKey === "yesterday") {
      start.setDate(start.getDate() - 1);
      start.setHours(0, 0, 0, 0);
      end.setDate(end.getDate() - 1);
      end.setHours(23, 59, 59, 999);
    } else if (dateKey === "last7") {
      start.setDate(start.getDate() - 6);
      start.setHours(0, 0, 0, 0);
    } else if (dateKey === "last30") {
      start.setDate(start.getDate() - 29);
      start.setHours(0, 0, 0, 0);
    } else if (dateKey === "custom" && from && to) {
      return { fromUtc: new Date(from), toUtc: new Date(to) };
    }
    return { fromUtc: start, toUtc: end };
  }, [dateKey, from, to]);

  const rangeKey = `${range.fromUtc?.toISOString?.() ?? ""}|${
    range.toUtc?.toISOString?.() ?? ""
  }`;

  /* ---- fetchers ---- */
  const fetchFacets = useCallback(async () => {
    try {
      const { data } = await axiosClient.get("/report/message-logs/facets");
      if (data?.senderIds) setSenderOptions(toOptions(data.senderIds));
      if (data?.wabaIds) setWabaOptions(toOptions(data.wabaIds));
    } catch {}
  }, []);

  const fetchRows = useCallback(async () => {
    setLoading(true);
    const body = {
      search: search || undefined,
      statuses: statuses.length ? statuses : undefined,
      senderIds: senderIds.length ? senderIds : undefined,
      wabaIds: wabaIds.length ? wabaIds : undefined,
      fromUtc: range.fromUtc?.toISOString?.(),
      toUtc: range.toUtc?.toISOString?.(),
      sortBy,
      sortDir,
      page,
      pageSize,
    };
    try {
      const { data } = await axiosClient.post(
        "/report/message-logs/search",
        body
      );
      const items = data.items || [];
      setRows(items);

      const computedTotalPages =
        typeof data.totalPages === "number"
          ? data.totalPages
          : Math.ceil((data.totalCount ?? 0) / (data.pageSize ?? pageSize));
      setTotalPages(
        Number.isFinite(computedTotalPages) ? computedTotalPages : 0
      );
      setTotalCount(data.totalCount ?? (items ? items.length : 0));

      // fallback facet derivation from rows
      const derived = deriveFacetOptionsFromRows(items);
      if (derived.senderOptions.length) {
        setSenderOptions(prev => {
          const known = new Set(prev.map(o => o.value));
          const merged = [...prev];
          derived.senderOptions.forEach(o => {
            if (!known.has(o.value)) merged.push(o);
          });
          return merged.sort((a, b) => a.label.localeCompare(b.label));
        });
      }
      if (derived.wabaOptions.length) {
        setWabaOptions(prev => {
          const known = new Set(prev.map(o => o.value));
          const merged = [...prev];
          derived.wabaOptions.forEach(o => {
            if (!known.has(o.value)) merged.push(o);
          });
          return merged.sort((a, b) => a.label.localeCompare(b.label));
        });
      }
    } catch {
      toast.error("‚ùå Failed to load message logs");
      setRows([]);
      setTotalPages(0);
      setTotalCount(0);
    } finally {
      setLoading(false);
    }
  }, [
    search,
    statuses,
    senderIds,
    wabaIds,
    rangeKey,
    sortBy,
    sortDir,
    page,
    pageSize,
  ]);

  useEffect(() => {
    fetchFacets();
  }, [fetchFacets]);

  useEffect(() => {
    const t = setTimeout(fetchRows, 250);
    return () => clearTimeout(t);
  }, [fetchRows]);

  const toggleSort = col => {
    if (sortBy === col) setSortDir(d => (d === "asc" ? "desc" : "asc"));
    else {
      setSortBy(col);
      setSortDir("desc");
    }
    setPage(1);
  };

  const commonExportBody = () => ({
    search: search || undefined,
    statuses: statuses.length ? statuses : undefined,
    senderIds: senderIds.length ? senderIds : undefined,
    wabaIds: wabaIds.length ? wabaIds : undefined,
    fromUtc: range.fromUtc?.toISOString?.(),
    toUtc: range.toUtc?.toISOString?.(),
    sortBy,
    sortDir,
  });

  const exportCsv = async () => {
    try {
      const res = await axiosClient.post(
        "/report/message-logs/export/csv",
        commonExportBody(),
        { responseType: "blob" }
      );
      saveAs(res.data, `MessageLogs.csv`);
    } catch {
      const headers = [
        "S.No",
        "Contacts",
        "Sender Id",
        "Status",
        "Campaign",
        "Message",
        "MessageId",
        "SentAt",
        "Error",
      ];
      const csvRows = [
        headers,
        ...rows.map((r, i) => [
          i + 1,
          r.recipientNumber || "",
          r.senderId || "",
          r.status || "",
          r.campaignName || r.campaignId || "",
          (r.messageContent || "").replace(/\r?\n/g, " ").slice(0, 500),
          r.providerMessageId || "",
          r.sentAt
            ? new Date(r.sentAt).toLocaleString()
            : new Date(r.createdAt).toLocaleString(),
          (r.errorMessage || "").replace(/\r?\n/g, " ").slice(0, 500),
        ]),
      ];
      const blob = new Blob([csvRows.map(r => r.join(",")).join("\n")], {
        type: "text/csv",
      });
      saveAs(blob, `MessageLogs.csv`);
    }
  };
  const exportXlsx = async () => {
    try {
      const res = await axiosClient.post(
        "/report/message-logs/export/xlsx",
        commonExportBody(),
        { responseType: "blob" }
      );
      saveAs(res.data, `MessageLogs.xlsx`);
    } catch {
      toast.error("XLSX export not available");
    }
  };

  const getDisplayPhone = log => {
    const clean = v => (typeof v === "string" ? v.trim() : v);
    const p = clean(log?.contactPhone);
    if (p && p !== "-" && p.toLowerCase() !== "n/a") return p;
    const r = clean(log?.recipientNumber) || clean(log?.to);
    return r || "";
  };

  const srBase = (page - 1) * pageSize;

  return (
    <div className="p-6 bg-gradient-to-br from-white to-gray-50 min-h-screen">
      {/* Header */}
      <div className="flex justify-between items-center mb-4">
        <h1 className="text-2xl font-bold text-black">üìä Message Send Logs </h1>
        <div className="space-x-2">
          <button
            onClick={exportCsv}
            className="bg-emerald-600 text-white text-sm px-3 py-1 rounded hover:bg-emerald-700"
          >
            CSV
          </button>
          <button
            onClick={exportXlsx}
            className="bg-emerald-700 text-white text-sm px-3 py-1 rounded hover:bg-emerald-800"
          >
            Excel
          </button>
          <Link
            to="/app/campaigns/template-campaigns-list"
            className="inline-flex items-center gap-2 rounded-lg border px-3 py-1.5 text-sm text-gray-700 hover:bg-gray-50 transition"
          >
            <span className="text-lg">‚Üê</span> Back to Campaigns
          </Link>
        </div>
      </div>

      {/* Filters ‚Äî order: WABA Id, Sender Id, Status, Search, Date range (LAST) */}
      <div className="grid lg:grid-cols-12 md:grid-cols-8 grid-cols-1 gap-4 mb-4">
        <div className="lg:col-span-2 md:col-span-4 col-span-1 relative">
          <MultiSelect
            label="WABA Id"
            options={wabaOptions}
            value={wabaIds}
            onChange={next => {
              setWabaIds(next);
              setPage(1);
            }}
            placeholder="All"
          />
        </div>

        <div className="lg:col-span-2 md:col-span-4 col-span-1 relative">
          <MultiSelect
            label="Sender Id"
            options={senderOptions}
            value={senderIds}
            onChange={next => {
              setSenderIds(next);
              setPage(1);
            }}
            placeholder="All"
          />
        </div>

        <div className="lg:col-span-2 md:col-span-4 col-span-1 relative">
          <MultiSelect
            label="Status"
            options={toOptions(STATUS_OPTIONS)}
            value={statuses}
            onChange={next => {
              setStatuses(next);
              setPage(1);
            }}
            placeholder="All"
          />
        </div>

        <div className="lg:col-span-3 md:col-span-4 col-span-1">
          <label className="text-sm text-gray-600 mb-1 block">Search</label>
          <div className="relative">
            <input
              className="w-full border px-3 py-2 rounded pr-8"
              placeholder="Search across all fields"
              value={search}
              onChange={e => {
                setSearch(e.target.value);
                setPage(1);
              }}
            />
            <span className="absolute right-2 top-2.5 text-gray-400">‚åï</span>
          </div>
        </div>

        {/* Date range presets at the end */}
        <div className="lg:col-span-3 md:col-span-4 col-span-1">
          <label className="text-sm text-gray-600 mb-1 block">Date range</label>
          <select
            className="w-full border px-3 py-2 rounded"
            value={dateKey}
            onChange={e => {
              setDateKey(e.target.value);
              setPage(1);
            }}
          >
            {DATE_PRESETS.map(p => (
              <option key={p.key} value={p.key}>
                {p.label}
              </option>
            ))}
          </select>
        </div>

        {dateKey === "custom" && (
          <>
            <div className="lg:col-span-3 md:col-span-4 col-span-1">
              <label className="text-sm text-gray-600 mb-1 block">From</label>
              <input
                type="datetime-local"
                className="w-full border px-3 py-2 rounded"
                value={from}
                onChange={e => {
                  setFrom(e.target.value);
                  setPage(1);
                }}
              />
            </div>
            <div className="lg:col-span-3 md:col-span-4 col-span-1">
              <label className="text-sm text-gray-600 mb-1 block">To</label>
              <input
                type="datetime-local"
                className="w-full border px-3 py-2 rounded"
                value={to}
                onChange={e => {
                  setTo(e.target.value);
                  setPage(1);
                }}
              />
            </div>
          </>
        )}
      </div>

      {/* Count */}
      <div className="mb-3 text-sm text-gray-500">
        Showing {rows.length} of {totalCount} logs
      </div>

      {/* Table */}
      <div className="overflow-x-auto bg-white shadow rounded">
        <table className="w-full text-sm">
          <thead className="bg-gray-100 sticky top-0 text-left">
            <tr>
              <th className="p-2 whitespace-nowrap">S.No</th>
              {[
                ["Recipient", "Contacts"],
                ["SenderId", "Sender Id"],
                ["Status", "Status"],
                ["CampaignName", "Campaign"],
                ["Message", "Message"],
                ["MessageId", "Message Id"],
                ["SentAt", "Sent At"],
                ["Error", "Error"],
              ].map(([key, label]) => (
                <th
                  key={key}
                  className="p-2 cursor-pointer select-none whitespace-nowrap"
                  onClick={() =>
                    toggleSort(key === "Message" ? "MessageType" : key)
                  }
                >
                  {label}{" "}
                  {sortBy === key ? (sortDir === "asc" ? "‚ñ≤" : "‚ñº") : ""}
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {loading ? (
              <tr>
                <td className="p-3" colSpan={11}>
                  Loading‚Ä¶
                </td>
              </tr>
            ) : rows.length === 0 ? (
              <tr>
                <td className="p-3 text-gray-500" colSpan={11}>
                  No logs found for the selected filters.
                </td>
              </tr>
            ) : (
              rows.map((log, idx) => {
                const isFailed =
                  String(log.status || "").toLowerCase() === "failed";
                const sr = (page - 1) * pageSize + idx + 1;
                return (
                  <tr
                    key={log.id ?? sr}
                    className={`border-t hover:bg-gray-50 ${
                      isFailed ? "text-red-700" : ""
                    }`}
                  >
                    <td className="p-2 whitespace-nowrap">{sr}</td>

                    <td className="p-2 whitespace-nowrap">
                      {getDisplayPhone(log) || "-"}
                    </td>
                    <td className="p-2 whitespace-nowrap">
                      {log.senderId || "-"}
                    </td>
                    <td className="p-2 whitespace-nowrap">
                      {log.status || "-"}
                    </td>
                    <td className="p-2 whitespace-nowrap">
                      {log.campaignName || log.campaignId || "-"}
                    </td>

                    <td className="p-2 max-w-[460px]">
                      <div
                        className="text-gray-800 truncate"
                        title={log.messageContent || ""}
                      >
                        {log.messageContent || "-"}
                      </div>
                    </td>

                    <td className="p-2 whitespace-nowrap align-top">
                      <MessageIdCell value={log.providerMessageId} />
                    </td>

                    <td className="p-2 whitespace-nowrap">
                      {log.sentAt
                        ? new Date(log.sentAt).toLocaleString()
                        : new Date(log.createdAt).toLocaleString()}
                    </td>

                    <td className="p-2 max-w-[320px]">
                      <div
                        className={`truncate ${
                          isFailed ? "text-red-700 font-medium" : ""
                        }`}
                        title={log.errorMessage || ""}
                      >
                        {log.errorMessage ? `‚ùó ${log.errorMessage}` : "-"}
                      </div>
                    </td>
                  </tr>
                );
              })
            )}
          </tbody>
        </table>
      </div>

      {/* Paging */}
      {totalPages > 1 && (
        <div className="flex flex-wrap gap-2 justify-end items-center mt-4">
          <button
            className="px-2 py-1 text-sm border rounded"
            disabled={page === 1}
            onClick={() => setPage(p => p - 1)}
          >
            ‚¨Ö Prev
          </button>
          <span className="text-sm text-gray-600">
            Page {page} of {totalPages}
          </span>
          <button
            className="px-2 py-1 text-sm border rounded"
            disabled={page === totalPages}
            onClick={() => setPage(p => p + 1)}
          >
            Next ‚û°
          </button>
          <select
            className="border px-2 py-1 rounded"
            value={pageSize}
            onChange={e => {
              setPageSize(parseInt(e.target.value, 10));
              setPage(1);
            }}
          >
            {[10, 25, 50, 100, 200].map(n => (
              <option key={n} value={n}>
                {n}/page
              </option>
            ))}
          </select>
        </div>
      )}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\SendTemplate\SendTemplate.jsx 
====================================================== 
 
// File: src/pages/Messaging/TemplateSender.jsx

import React, { useState, useEffect } from "react";
import axios from "axios";
import { toast } from "react-toastify";

/**
 * This component allows users to send WhatsApp template messages.
 * It fetches template metadata from the backend and dynamically adjusts
 * parameter fields and preview accordingly.
 */
function TemplateSender() {
  const [templates, setTemplates] = useState([]);
  const [selected, setSelected] = useState(null);
  const [recipient, setRecipient] = useState("");
  const [params, setParams] = useState([]);

  const businessId =
    localStorage.getItem("businessId") ||
    "68a5b6cd-a420-41d1-9a35-08705748e855";

  // üîÅ Fetch template metadata on load
  useEffect(() => {
    axios
      .get("/api/templates/metadata")
      .then(res => {
        if (res.data.success) {
          setTemplates(res.data.templates);
        } else {
          toast.error("Failed to load templates");
        }
      })
      .catch(err => {
        console.error(err);
        toast.error("Error fetching templates");
      });
  }, []);

  // üîÅ Handle selection
  const handleTemplateChange = name => {
    const tpl = templates.find(t => t.name === name);
    setSelected(tpl);
    setParams(Array(tpl?.placeholderCount || 0).fill(""));
  };

  const handleParamChange = (index, value) => {
    const updated = [...params];
    updated[index] = value;
    setParams(updated);
  };

  const preview = () => {
    if (!selected?.body) return "";
    let rendered = selected.body;
    const regex = /{{(.*?)}}/g;
    let i = 0;
    rendered = rendered.replace(regex, () => {
      const val = params[i] || `[${i + 1}]`;
      i++;
      return val;
    });
    return rendered;
  };

  const handleSubmit = async e => {
    e.preventDefault();

    if (!selected || !recipient) {
      toast.error("Fill all required fields");
      return;
    }

    const payload = {
      businessId,
      recipientNumber: recipient,
      templateName: selected.name,
      languageCode: selected.language,
      templateParameters: params,
      messageType: "template",
    };

    try {
      const res = await axios.post("/api/messages/send-template", payload);
      toast.success("‚úÖ Message sent successfully");
      console.log(res.data);
    } catch (err) {
      toast.error("‚ùå Failed to send message");
      console.error(err);
    }
  };

  return (
    <div className="p-6 max-w-2xl mx-auto">
      <h2 className="text-xl font-bold mb-4">üì© Send Template Message</h2>
      <form
        onSubmit={handleSubmit}
        className="space-y-4 bg-white shadow p-4 rounded"
      >
        {/* Template Dropdown */}
        <div>
          <label className="block font-medium mb-1">Template *</label>
          <select
            value={selected?.name || ""}
            onChange={e => handleTemplateChange(e.target.value)}
            className="w-full border px-3 py-2 rounded"
          >
            <option value="">-- Select Template --</option>
            {templates.map(tpl => (
              <option key={tpl.name} value={tpl.name}>
                {tpl.name} ({tpl.language})
              </option>
            ))}
          </select>
        </div>

        {/* Recipient Input */}
        <div>
          <label className="block font-medium mb-1">Recipient Number *</label>
          <input
            type="text"
            value={recipient}
            onChange={e => setRecipient(e.target.value)}
            className="w-full border px-3 py-2 rounded"
            placeholder="+91xxxxxxxxxx"
          />
        </div>

        {/* Dynamic Parameters */}
        {selected?.placeholderCount > 0 && (
          <div>
            <label className="block font-medium mb-1">Parameters</label>
            {params.map((val, idx) => (
              <input
                key={idx}
                type="text"
                value={val}
                onChange={e => handleParamChange(idx, e.target.value)}
                placeholder={`Value for {{${idx + 1}}}`}
                className="w-full mb-2 border px-3 py-2 rounded"
              />
            ))}
          </div>
        )}

        {/* Final Preview */}
        {selected?.body && (
          <div className="bg-gray-100 p-3 rounded text-sm">
            <p className="font-semibold mb-1">üßæ Preview</p>
            <p className="text-gray-700 whitespace-pre-wrap">{preview()}</p>
          </div>
        )}

        <button
          type="submit"
          className="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700"
        >
          üöÄ Send Template
        </button>
      </form>
    </div>
  );
}

export default TemplateSender;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\SendWhatsAppMessage\MessageTabs.css 
====================================================== 
 
.tab-button {
  padding: 10px 16px;
  border: none;
  background-color: transparent;
  font-weight: 500;
  color: #6b7280;
  border-bottom: 2px solid transparent;
  cursor: pointer;
}

.tab-button.active {
  color: #7c3aed;
  border-color: #7c3aed;
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\SendWhatsAppMessage\TemplateMessageTab.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";

function TemplateMessageTab() {
  const [templates, setTemplates] = useState([]);
  const [selectedTemplate, setSelectedTemplate] = useState(null);
  const [templateParams, setTemplateParams] = useState([]);
  const [recipientNumber, setRecipientNumber] = useState("");
  const [loading, setLoading] = useState(false);
  const [previewBody, setPreviewBody] = useState("");

  useEffect(() => {
    const loadTemplates = async () => {
      try {
        const res = await axiosClient.get(
          `/WhatsAppTemplateFetcher/get-template-all`
        );

        if (res.data.success && res.data.templates) {
          const enriched = res.data.templates.map(tpl => {
            const bodyComponent = tpl.components?.find(c => c.type === "BODY");
            const buttonComponent = tpl.components?.find(
              c => c.type === "BUTTON"
            );

            // ‚úÖ Safely extract bodyText with fallback to example
            let bodyText = "";
            if (bodyComponent) {
              if (
                typeof bodyComponent.text === "string" &&
                bodyComponent.text.trim()
              ) {
                bodyText = bodyComponent.text;
              } else if (
                bodyComponent.example &&
                Array.isArray(bodyComponent.example.body_text) &&
                bodyComponent.example.body_text.length > 0
              ) {
                bodyText = bodyComponent.example.body_text[0];
              }
            }

            const paramCount = (bodyText.match(/{{\d+}}/g) || []).length;
            const buttonText = buttonComponent?.buttons?.[0]?.text || "";

            return {
              name: tpl.name,
              language: tpl.language,
              bodyText,
              bodyParamCount: paramCount,
              buttonText,
            };
          });

          setTemplates(enriched);
        } else {
          toast.warn("‚ö†Ô∏è No templates found.");
        }
      } catch (err) {
        toast.error("‚ùå Failed to fetch templates.");
      }
    };

    loadTemplates();
  }, []);

  const handleTemplateChange = e => {
    const templateName = e.target.value;
    const found = templates.find(t => t.name === templateName);
    setSelectedTemplate(found);

    if (found) {
      const emptyParams = Array(found.bodyParamCount).fill("");
      setTemplateParams(emptyParams);

      let preview = found.bodyText || "";
      emptyParams.forEach((val, idx) => {
        preview = preview.replace(`{{${idx + 1}}}`, val || `{{${idx + 1}}}`);
      });

      setPreviewBody(preview);
    }
  };

  const handleParamChange = (index, value) => {
    const newParams = [...templateParams];
    newParams[index] = value;
    setTemplateParams(newParams);

    if (selectedTemplate?.bodyText) {
      let preview = selectedTemplate.bodyText;
      newParams.forEach((val, idx) => {
        preview = preview.replace(`{{${idx + 1}}}`, val || `{{${idx + 1}}}`);
      });
      setPreviewBody(preview);
    }
  };

  const handleSend = async () => {
    if (!recipientNumber || !selectedTemplate) {
      toast.warn("üìå Fill recipient and select a template.");
      return;
    }

    const businessId = localStorage.getItem("businessId");
    if (!businessId) {
      toast.error("‚ùå Business ID missing.");
      return;
    }

    setLoading(true);
    try {
      const payload = {
        businessId,
        recipientNumber,
        templateName: selectedTemplate.name,
        templateParams,
      };

      const res = await axiosClient.post(
        "/messageengine/send-template",
        payload
      );

      if (res.status === 200) {
        toast.success("‚úÖ Template message sent!");
        setRecipientNumber("");
        setSelectedTemplate(null);
        setTemplateParams([]);
        setPreviewBody("");
      } else {
        toast.error("‚ùå Send failed.");
      }
    } catch (err) {
      toast.error("‚ùå Error sending.");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-4">
      {/* Phone Number Input */}
      <input
        type="text"
        placeholder="Enter phone number"
        value={recipientNumber}
        onChange={e => setRecipientNumber(e.target.value)}
        className="w-full border px-3 py-2 rounded-md shadow-sm"
      />

      {/* Template Dropdown */}
      <select
        className="w-full border px-3 py-2 rounded-md"
        value={selectedTemplate?.name || ""}
        onChange={handleTemplateChange}
      >
        <option value="">-- Select Template --</option>
        {templates.map(tpl => (
          <option key={tpl.name} value={tpl.name}>
            {tpl.name} ({tpl.language})
          </option>
        ))}
      </select>

      {/* Param Inputs */}
      {templateParams.length > 0 && (
        <div className="space-y-2">
          {templateParams.map((val, idx) => (
            <input
              key={idx}
              type="text"
              placeholder={`Param ${idx + 1}`}
              value={val}
              onChange={e => handleParamChange(idx, e.target.value)}
              className="w-full border px-3 py-2 rounded-md shadow-sm"
            />
          ))}
        </div>
      )}

      {/* WhatsApp-Style Preview */}
      {selectedTemplate && (
        <div className="rounded-md bg-white border px-4 py-3 shadow-sm w-full text-gray-800">
          <div className="flex flex-col gap-2">
            <div className="bg-[#f0f0f0] rounded-lg px-4 py-3 shadow-inner">
              <p className="font-semibold text-[15px] text-black">
                {selectedTemplate?.name.replaceAll("_", " ")}
              </p>
              <p className="mt-1 whitespace-pre-line text-sm text-gray-800">
                {previewBody || "(no preview available)"}
              </p>

              {selectedTemplate?.buttonText && (
                <div className="mt-3">
                  <button className="text-blue-600 text-sm underline hover:text-blue-800">
                    {selectedTemplate.buttonText}
                  </button>
                </div>
              )}
            </div>
            <div className="text-[10px] text-right text-gray-400">07:58</div>
          </div>
        </div>
      )}

      {/* Send Button */}
      <button
        onClick={handleSend}
        disabled={loading}
        className="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 disabled:opacity-50 w-full"
      >
        {loading ? "Sending..." : "Send Message"}
      </button>
    </div>
  );
}

export default TemplateMessageTab;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\SendWhatsAppMessage\TextMessageTab.jsx 
====================================================== 
 
import React, { useState } from "react";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";

function TextMessageTab() {
  const [phone, setPhone] = useState("");
  const [message, setMessage] = useState("");
  const [loading, setLoading] = useState(false);

  const handleSend = async () => {
    if (!phone || !message) {
      toast.warn("üìå Please fill both phone and message.");
      return;
    }

    const businessId = localStorage.getItem("businessId");
    if (!businessId) {
      toast.error("‚ùå Business ID missing in localStorage.");
      return;
    }

    setLoading(true);
    try {
      const payload = {
        businessId,
        recipientNumber: phone,
        textContent: message,
      };

      const res = await axiosClient.post("/whatsappengine/send-text", payload);

      if (res.status === 200) {
        toast.success("‚úÖ Message sent!");
        setPhone("");
        setMessage("");
      } else {
        toast.error("‚ùå Send failed.");
      }
    } catch (err) {
      toast.error("‚ùå Error sending message.");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-4">
      <input
        type="text"
        placeholder="Enter phone number"
        value={phone}
        onChange={e => setPhone(e.target.value)}
        className="w-full border px-3 py-2 rounded-md shadow-sm focus:outline-none focus:ring focus:ring-purple-300"
      />

      <textarea
        rows={4}
        placeholder="Type your message"
        value={message}
        onChange={e => setMessage(e.target.value)}
        className="w-full border px-3 py-2 rounded-md shadow-sm focus:outline-none focus:ring focus:ring-purple-300"
      />

      <button
        onClick={handleSend}
        disabled={loading}
        className="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 disabled:opacity-50"
      >
        {loading ? "Sending..." : "Send Message"}
      </button>
    </div>
  );
}

export default TextMessageTab;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Tags\TagForm.jsx 
====================================================== 
 
import { useState, useEffect } from "react";
import { Tag, PlusCircle } from "lucide-react";
import { toast } from "react-toastify";

export default function TagForm({ selectedTag, onSaveComplete }) {
  const [tag, setTag] = useState({
    name: "",
    colorHex: "",
    category: "",
    notes: "",
    isSystemTag: false,
    isActive: true,
  });

  useEffect(() => {
    if (selectedTag) {
      setTag(selectedTag);
    }
  }, [selectedTag]);

  const handleChange = e => {
    const { name, value, type, checked } = e.target;
    setTag(prev => ({
      ...prev,
      [name]: type === "checkbox" ? checked : value,
    }));
  };

  const handleSubmit = async e => {
    e.preventDefault();

    if (!tag.name.trim()) return;

    try {
      const method = selectedTag ? "PUT" : "POST";
      const url = selectedTag ? `/api/tags/${selectedTag.id}` : "/api/tags";

      const res = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(tag),
      });

      if (!res.ok) throw new Error("Failed to save tag");

      toast.success(
        `‚úÖ Tag ${selectedTag ? "updated" : "added"} successfully!`
      );
      onSaveComplete();
    } catch (err) {
      console.error("‚ùå Failed to save tag:", err);
      toast.error("‚ùå Failed to save tag");
    }
  };

  const isFormValid = tag.name.trim().length > 0;

  return (
    <div className="bg-white rounded-md border shadow-sm p-6 w-full transition hover:shadow-md">
      {/* üè∑Ô∏è Form Header */}
      <div className="flex items-center gap-3 mb-5">
        <div className="bg-purple-100 text-purple-700 rounded-xl p-2">
          <Tag size={22} />
        </div>
        <div>
          <h2 className="text-lg font-bold text-gray-800">
            {selectedTag ? "Edit Tag" : "Add New Tag"}
          </h2>
          <p className="text-sm text-gray-600">
            Create custom tags with color, category, and notes.
          </p>
        </div>
      </div>

      {/* üìù Form Fields */}
      <form onSubmit={handleSubmit} className="space-y-5">
        <div>
          <label className="text-xs font-medium text-gray-600 mb-1 block">
            Tag Name <span className="text-red-500">*</span>
          </label>
          <input
            type="text"
            name="name"
            value={tag.name}
            onChange={handleChange}
            placeholder="e.g. High Priority"
            className="w-full px-4 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
          />
        </div>

        <div>
          <label className="text-xs font-medium text-gray-600 mb-1 block">
            Tag Color (Hex)
          </label>
          <input
            type="text"
            name="colorHex"
            value={tag.colorHex}
            onChange={handleChange}
            placeholder="#FF5733"
            className="w-full px-4 py-2 border rounded-md text-sm"
          />
        </div>

        <div>
          <label className="text-xs font-medium text-gray-600 mb-1 block">
            Category
          </label>
          <input
            type="text"
            name="category"
            value={tag.category}
            onChange={handleChange}
            placeholder="e.g. Priority"
            className="w-full px-4 py-2 border rounded-md text-sm"
          />
        </div>

        <div>
          <label className="text-xs font-medium text-gray-600 mb-1 block">
            Notes
          </label>
          <textarea
            name="notes"
            value={tag.notes}
            onChange={handleChange}
            placeholder="Optional description..."
            rows={3}
            className="w-full px-4 py-2 border rounded-md text-sm resize-none"
          />
        </div>

        <div className="flex items-center gap-6 mt-1">
          <label className="flex items-center text-sm gap-2">
            <input
              type="checkbox"
              name="isSystemTag"
              checked={tag.isSystemTag}
              onChange={handleChange}
            />
            System Tag
          </label>

          <label className="flex items-center text-sm gap-2">
            <input
              type="checkbox"
              name="isActive"
              checked={tag.isActive}
              onChange={handleChange}
            />
            Active
          </label>
        </div>

        {/* Submit Button */}
        <div className="pt-4 border-t flex justify-end">
          <button
            type="submit"
            disabled={!isFormValid}
            className={`inline-flex items-center gap-2 px-5 py-2 rounded-md text-white text-sm font-medium transition ${
              isFormValid
                ? "bg-purple-600 hover:bg-purple-700"
                : "bg-gray-300 cursor-not-allowed"
            }`}
          >
            <PlusCircle size={18} />
            {selectedTag ? "Update Tag" : "Add Tag"}
          </button>
        </div>
      </form>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Tags\TagList.jsx 
====================================================== 
 
import { useEffect, useState } from "react";
import { Trash2, Pencil } from "lucide-react";
import { toast } from "react-toastify";

export default function TagList({ onEditTag, refreshTrigger }) {
  const [tags, setTags] = useState([]);
  const [loading, setLoading] = useState(false);

  const fetchTags = async () => {
    setLoading(true);
    try {
      const res = await fetch("/api/tags");
      const result = await res.json();

      // ‚úÖ Extract actual array from result.data
      if (Array.isArray(result.data)) {
        setTags(result.data);
      } else {
        setTags([]);
        console.error(
          "Invalid response from /api/tags. Expected result.data to be array:",
          result
        );
        toast.error("‚ùå Invalid tag data received");
      }
    } catch (err) {
      console.error("Failed to fetch tags", err);
      toast.error("‚ùå Failed to load tags");
      setTags([]);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchTags();
  }, [refreshTrigger]);

  const handleDelete = async id => {
    if (!window.confirm("Are you sure you want to delete this tag?")) return;

    try {
      const res = await fetch(`/api/tags/${id}`, {
        method: "DELETE",
      });

      if (!res.ok) throw new Error();

      toast.success("‚úÖ Tag deleted");
      fetchTags();
    } catch (err) {
      toast.error("‚ùå Failed to delete tag");
    }
  };

  return (
    <div className="mt-6 bg-white rounded-md border shadow-sm p-6 transition hover:shadow-md">
      <h2 className="text-lg font-bold text-gray-800 mb-3">üóÇÔ∏è All Tags</h2>

      {loading ? (
        <p className="text-sm text-gray-500">Loading tags...</p>
      ) : tags.length === 0 ? (
        <p className="text-sm text-gray-500">No tags found.</p>
      ) : (
        <div className="space-y-3">
          {tags.map(tag => (
            <div
              key={tag.id}
              className="flex items-center justify-between border-b pb-2"
            >
              <div className="flex items-center gap-3">
                <div
                  className="w-4 h-4 rounded-full border"
                  style={{ backgroundColor: tag.colorHex || "#ccc" }}
                ></div>
                <div>
                  <p className="text-sm font-medium text-gray-800">
                    {tag.name}
                  </p>
                  <p className="text-xs text-gray-500">
                    {tag.category || "Uncategorized"}{" "}
                    {tag.isSystemTag && "¬∑ System"}
                  </p>
                </div>
              </div>

              <div className="flex items-center gap-3">
                <button
                  onClick={() => onEditTag(tag)}
                  className="text-gray-600 hover:text-purple-600"
                  title="Edit"
                >
                  <Pencil size={18} />
                </button>
                <button
                  onClick={() => handleDelete(tag.id)}
                  className="text-gray-600 hover:text-red-600"
                  title="Delete"
                >
                  <Trash2 size={18} />
                </button>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Tags\Tags.jsx 
====================================================== 
 
// üìÑ File: src/pages/Tags/Tags.jsx
import React, { useState } from "react";
import { Tag } from "lucide-react";
import TagForm from "./TagForm";
import TagList from "./TagList";
import { toast } from "react-toastify";

export default function Tags() {
  const [selectedTag, setSelectedTag] = useState(null);
  const [refreshKey, setRefreshKey] = useState(0);

  const handleEdit = tag => {
    setSelectedTag(tag);
  };

  const handleSaveComplete = (success = true, message = "") => {
    setSelectedTag(null);
    setRefreshKey(prev => prev + 1);

    if (success) {
      toast.success(message || "‚úÖ Tag saved successfully");
    } else {
      toast.error(message || "‚ùå Failed to save tag");
    }
  };

  const handleDeleteComplete = (success = true, message = "") => {
    setRefreshKey(prev => prev + 1);

    if (success) {
      toast.success(message || "üóëÔ∏è Tag deleted successfully");
    } else {
      toast.error(message || "‚ùå Failed to delete tag");
    }
  };

  return (
    <div className="p-6 space-y-8">
      {/* üü£ Smart Banner */}
      <div className="bg-gradient-to-br from-purple-50 to-white border border-purple-200 rounded-md shadow-sm p-5 flex items-start gap-4">
        <div className="bg-purple-100 text-purple-700 rounded-md p-2 shadow-sm">
          <Tag size={24} />
        </div>
        <div className="flex-1">
          <h2 className="text-lg font-bold text-purple-800 mb-1">
            Organise Smartly with Tags
          </h2>
          <p className="text-sm text-gray-700 leading-relaxed">
            Tags help you <strong>segment, prioritise</strong>, and manage your
            contacts effectively. Add labels like{" "}
            <span className="text-purple-700 font-medium">"Leads"</span>,{" "}
            <span className="text-purple-700 font-medium">"Follow Up"</span>, or{" "}
            <span className="text-purple-700 font-medium">"VIP"</span> to group
            and target the right audience. It‚Äôs the fastest way to personalise
            campaigns and automate your CRM flow.
          </p>
        </div>
      </div>

      {/* üß± Form + Tag List */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {/* ‚ûï Add/Edit Tag Form */}
        <TagForm
          selectedTag={selectedTag}
          onSaveComplete={handleSaveComplete}
        />

        {/* üè∑Ô∏è Tag List */}
        <div className="space-y-3">
          <h2 className="text-md font-semibold text-gray-700 px-1">
            üè∑Ô∏è Tag List
          </h2>
          <TagList
            onEdit={handleEdit}
            refreshKey={refreshKey}
            onDeleteComplete={handleDeleteComplete}
          />
        </div>
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Tags\TagSelector.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axios from "axios";

/**
 * TagSelector - A dropdown/select box to choose one or more tags.
 * Props:
 * - selected: array of selected tag IDs
 * - onChange: callback with updated tag array
 * - multi: boolean (allow multi-select or not)
 */
export default function TagSelector({ selected = [], onChange, multi = true }) {
  const [tags, setTags] = useState([]);

  useEffect(() => {
    fetchTags();
  }, []);

  const fetchTags = async () => {
    try {
      const res = await axios.get("/api/tags");
      setTags(Array.isArray(res.data) ? res.data : []);
    } catch (err) {
      console.error("‚ùå Failed to load tags", err);
      setTags([]); // fallback to empty
    }
  };

  const handleToggle = tagId => {
    if (multi) {
      const isSelected = selected.includes(tagId);
      const updated = isSelected
        ? selected.filter(id => id !== tagId)
        : [...selected, tagId];
      onChange(updated);
    } else {
      onChange([tagId]);
    }
  };

  return (
    <div className="flex flex-wrap gap-2">
      {(Array.isArray(tags) ? tags : []).map(tag => {
        const isSelected = selected.includes(tag.id);
        return (
          <button
            key={tag.id}
            onClick={() => handleToggle(tag.id)}
            className={`px-3 py-1 rounded-full text-sm border transition-all duration-150 ${
              isSelected
                ? "bg-purple-600 text-white border-purple-600"
                : "bg-gray-100 text-gray-700 border-gray-300"
            }`}
            title={tag.notes || tag.name}
          >
            <span
              className="inline-block w-2 h-2 rounded-full mr-2"
              style={{ backgroundColor: tag.colorHex || "#999" }}
            ></span>
            {tag.name}
          </button>
        );
      })}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\TemplateBuilder\api.js 
====================================================== 
 
import axiosClient from "../../api/axiosClient";

/**
 * @typedef {Object} LibraryListItem
 * @property {string} id
 * @property {string} industry
 * @property {string} key
 * @property {string} category
 * @property {boolean} isFeatured
 * @property {string} language
 * @property {"NONE"|"TEXT"|"IMAGE"|"VIDEO"|"DOCUMENT"} headerType
 * @property {number} placeholders
 * @property {string} bodyPreview
 * @property {string} buttonsSummary
 */

/**
 * @typedef {Object} LibraryBrowseResponse
 * @property {number} page
 * @property {number} pageSize
 * @property {number} total
 * @property {LibraryListItem[]} items
 */

/**
 * Browse/search library items (paged).
 * Backend: GET /api/template-builder/library/browse
 *
 * @param {{industry?: string, q?: string, sort?: "featured"|"name", page?: number, pageSize?: number}} params
 * @returns {Promise<LibraryBrowseResponse>}
 */
export async function browseLibrary(params = {}) {
  const { industry, q, sort = "featured", page = 1, pageSize = 20 } = params;
  const res = await axiosClient.get("/template-builder/library/browse", {
    params: { industry, q, sort, page, pageSize },
  });
  return res.data;
}

/**
 * Activate a library item ‚Üí create a draft with selected languages.
 * Backend: POST /api/template-builder/library/{itemId}/activate
 *
 * @param {string} itemId
 * @param {{ languages: string[] }} body
 * @returns {Promise<{ success: boolean, message?: string, draftId: string }>}
 */
export async function activateLibraryItem(itemId, body) {
  const res = await axiosClient.post(
    `/template-builder/library/${itemId}/activate`,
    body
  );
  return res.data;
}

/**
 * Get available industries (for filter dropdowns).
 * Backend: GET /api/template-builder/library/industries
 *
 * @returns {Promise<{ success:boolean, industries: string[] }>}
 */
export async function listIndustries() {
  const res = await axiosClient.get("/template-builder/library/industries");
  return res.data;
}

/**
 * Get a single library item + its variants (for preview drawer).
 * Backend: GET /api/template-builder/library/item/{itemId}
 *
 * @param {string} itemId
 * @returns {Promise<{ success:boolean, item: any, variants: any[] }>}
 */
export async function getLibraryItem(itemId) {
  const res = await axiosClient.get(`/template-builder/library/item/${itemId}`);
  return res.data;
}

/**
 * ADMIN: Export library payload (optionally by industry) for backup/migrations.
 * Backend: GET /api/template-builder/library/export?industry=...
 *
 * @param {string=} industry
 * @returns {Promise<{ success:boolean, count:number, items:any[] }>}
 */
export async function exportLibrary(industry) {
  const res = await axiosClient.get("/template-builder/library/export", {
    params: { industry },
  });
  return res.data;
}

/**
 * ADMIN: Import library payload. Supports dryRun for safe previews.
 * Backend: POST /api/template-builder/library/import?dryRun={bool}
 *
 * @param {{ items: any[] }} payload
 * @param {boolean} [dryRun=false]
 * @returns {Promise<{ success:boolean, dryRun:boolean, TotalItems:number, CreatedItems:number, UpdatedItems:number, CreatedVariants:number, UpdatedVariants:number, errors?:string[] }>}
 */
export async function importLibrary(payload, dryRun = false) {
  const res = await axiosClient.post(
    `/template-builder/library/import`,
    payload,
    { params: { dryRun } }
  );
  return res.data;
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\TemplateBuilder\ApprovedTemplatesPage.jsx 
====================================================== 
 
import React from "react";
import { Link } from "react-router-dom";
import { ChevronLeft, Trash2, Info } from "lucide-react";
import { Card } from "../../components/ui/card";

// NOTE: Minimal scaffold. We only know DELETE /templates/{name}?language=
// In Step 29, once we confirm a list endpoint (e.g., GET /api/whatsapp-templates),
// we‚Äôll replace the ‚Äúempty state‚Äù with a real grid, using axiosClient.

export default function ApprovedTemplatesPage() {
  return (
    <div className="p-6">
      <Link
        to="/app/template-builder/library"
        className="text-purple-600 hover:underline flex items-center gap-2 mb-4"
      >
        <ChevronLeft size={18} /> Back to Library
      </Link>

      <h2 className="text-2xl font-bold text-purple-800 mb-2">
        Approved Templates
      </h2>
      <p className="text-sm text-gray-600 mb-4">
        View your approved templates here and delete them from Meta if needed.
      </p>

      <Card className="p-6 flex items-start gap-3">
        <Info className="text-indigo-500 mt-0.5" size={18} />
        <div className="text-sm text-gray-700">
          We‚Äôll load the approved list after API confirmation in Step 29. The
          delete action will call:
          <pre className="mt-2 text-xs bg-gray-50 p-2 rounded border">
            DELETE
            /api/template-builder/templates/&lt;name&gt;?language=&lt;en_US&gt;
          </pre>
        </div>
      </Card>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\TemplateBuilder\DraftEditorPage.jsx 
====================================================== 
 
import React, { useEffect, useMemo, useState, useCallback } from "react";
import {
  useParams,
  useSearchParams,
  useNavigate,
  Link,
} from "react-router-dom";
import { toast } from "react-toastify";
import {
  Eye,
  Send,
  ShieldCheck,
  Save,
  ChevronLeft,
  Upload,
  Loader2,
} from "lucide-react";

import axiosClient from "../../api/axiosClient";
import { useAuth } from "../../app/providers/AuthProvider";
import { FK } from "../../capabilities/featureKeys";
import { Card } from "../../components/ui/card";
import DraftStatusBadge from "./components/DraftStatusBadge";
import HeaderMediaUploader from "./components/HeaderMediaUploader";

// Default one-language flow per your backend decision
const DEFAULT_LANG = "en_US";

export default function DraftEditorPage() {
  const { draftId } = useParams();
  const navigate = useNavigate();
  const { isLoading, can, hasAllAccess, businessId } = useAuth();
  const [params, setParams] = useSearchParams();

  const language = params.get("language") || DEFAULT_LANG;

  // RBAC: edit/submit drafts require CAMPAIGN_CREATE
  const canEdit = hasAllAccess || can(FK.CAMPAIGN_CREATE);

  // Variant form state (simple MVP)
  const [name, setName] = useState(""); // final template name (slug-like)
  const [category, setCategory] = useState("UTILITY"); // MARKETING | UTILITY | AUTHENTICATION
  const [headerType, setHeaderType] = useState("NONE"); // NONE | TEXT | IMAGE | VIDEO | DOCUMENT
  const [headerText, setHeaderText] = useState(""); // when headerType = TEXT
  const [headerMediaHandle, setHeaderMediaHandle] = useState(""); // when media header
  const [bodyText, setBodyText] = useState(""); // may include {{1}}, {{2}} ‚Ä¶
  const [footerText, setFooterText] = useState("");
  const [buttons, setButtons] = useState([]); // max 3
  const [examples, setExamples] = useState([""]); // example body values

  // Auxiliary state
  const [saving, setSaving] = useState(false);
  const [checking, setChecking] = useState(false);
  const [submitting, setSubmitting] = useState(false);
  const [previewLoading, setPreviewLoading] = useState(false);
  const [preview, setPreview] = useState(null); // { human, components }
  const [status, setStatus] = useState(null); // { name, language, status, reason }

  const onLanguageChange = next => {
    setParams(p => {
      const clone = new URLSearchParams(p);
      clone.set("language", next);
      return clone;
    });
  };

  // --- Load current status + preview as source of truth (no direct GET variant API) ---
  const loadStatus = useCallback(async () => {
    try {
      const { data } = await axiosClient.get(
        `/api/template-builder/drafts/${draftId}/status`
      );
      setStatus(data || null);
      // If backend echoes name/lang, seed name
      if (data?.name) setName(prev => prev || data.name);
    } catch (err) {
      // Non-fatal; drafts might not be approved yet
    }
  }, [draftId]);

  const loadPreview = useCallback(async () => {
    setPreviewLoading(true);
    try {
      const { data } = await axiosClient.get(
        `/api/template-builder/drafts/${draftId}/preview`,
        { params: { language } }
      );
      setPreview(data || null);

      // Seed editor state from preview payload if available
      if (data?.components) {
        // components is the exact Meta payload your preview service returns
        const header = (data.components || []).find(c => c.type === "HEADER");
        const body = (data.components || []).find(c => c.type === "BODY");
        const footer = (data.components || []).find(c => c.type === "FOOTER");
        const btns = (data.components || []).find(c => c.type === "BUTTONS");

        if (header) {
          const kind =
            header.format || header.text ? header.format || "TEXT" : "NONE";
          setHeaderType(kind); // IMAGE/VIDEO/DOCUMENT/TEXT/NONE
          if (kind === "TEXT") setHeaderText(header.text || "");
          if (["IMAGE", "VIDEO", "DOCUMENT"].includes(kind)) {
            // header example may include a "handle" hint in preview‚Äôs struct; keep empty otherwise
          }
        } else {
          setHeaderType("NONE");
          setHeaderText("");
        }

        if (body) setBodyText(body.text || "");
        if (footer) setFooterText(footer.text || "");
        if (btns?.buttons) setButtons(btns.buttons.slice(0, 3));
      }

      // Try to seed category if preview includes it
      if (data?.category) setCategory(data.category);
    } catch (err) {
      // Will be empty on first load; user will edit and save
    } finally {
      setPreviewLoading(false);
    }
  }, [draftId, language]);

  useEffect(() => {
    loadStatus();
  }, [loadStatus]);

  useEffect(() => {
    loadPreview();
  }, [loadPreview]);

  // --- Save variant (PUT /drafts/{id}/variant/{language}) ---
  const handleSave = async () => {
    if (!canEdit) return;
    if (!name?.trim()) {
      toast.warn("Template name is required.");
      return;
    }
    if (headerType === "TEXT" && !headerText?.trim()) {
      toast.warn("Header text is required when header type is TEXT.");
      return;
    }
    if (
      ["IMAGE", "VIDEO", "DOCUMENT"].includes(headerType) &&
      !headerMediaHandle
    ) {
      toast.warn("Upload/attach header media first.");
      return;
    }

    const variant = {
      name,
      language,
      category,
      headerType,
      headerText: headerType === "TEXT" ? headerText : "",
      headerMediaHandle: ["IMAGE", "VIDEO", "DOCUMENT"].includes(headerType)
        ? headerMediaHandle
        : "",
      bodyText,
      footerText,
      buttons: (buttons || []).slice(0, 3),
      examples, // array of example values to render {{n}}
    };

    setSaving(true);
    try {
      await axiosClient.put(
        `/api/template-builder/drafts/${draftId}/variant/${language}`,
        variant
      );
      toast.success("Draft saved.");
      await loadPreview();
    } catch (err) {
      toast.error("Failed to save draft.");
    } finally {
      setSaving(false);
    }
  };

  // --- Name check ---
  const handleNameCheck = async () => {
    setChecking(true);
    try {
      const { data } = await axiosClient.get(
        `/api/template-builder/drafts/${draftId}/name-check`,
        { params: { language } }
      );
      if (data?.available) {
        toast.success("Name is available in this language.");
      } else {
        toast.warn(data?.message || "Name not available.");
      }
    } catch (err) {
      toast.error("Name check failed.");
    } finally {
      setChecking(false);
    }
  };

  // --- Preview (fresh) ---
  const handlePreview = async () => {
    setPreviewLoading(true);
    try {
      const { data } = await axiosClient.get(
        `/api/template-builder/drafts/${draftId}/preview`,
        { params: { language } }
      );
      setPreview(data || null);
    } catch (err) {
      toast.error("Failed to load preview.");
    } finally {
      setPreviewLoading(false);
    }
  };

  // --- Submit to Meta ---
  const handleSubmit = async () => {
    if (!canEdit) return;
    setSubmitting(true);
    try {
      const { data } = await axiosClient.post(
        `/api/template-builder/drafts/${draftId}/submit`
      );
      toast.success("Submitted to Meta. Status will update after review.");
      await loadStatus();
      // Optional: navigate to Library or stay here
    } catch (err) {
      toast.error("Submission failed.");
    } finally {
      setSubmitting(false);
    }
  };

  if (isLoading) {
    return (
      <div className="p-8 text-center text-gray-500">Loading profile‚Ä¶</div>
    );
  }

  if (!canEdit) {
    return (
      <div className="p-8">
        <Link
          to="/app/template-builder/library"
          className="text-purple-600 hover:underline flex items-center gap-2 mb-4"
        >
          <ChevronLeft size={18} /> Back to Library
        </Link>
        <Card className="p-6">
          <div className="text-lg font-semibold text-purple-800 mb-2">
            Insufficient permissions
          </div>
          <p className="text-gray-600">
            You don‚Äôt have access to edit/submit templates. Contact your admin.
          </p>
        </Card>
      </div>
    );
  }

  return (
    <div className="p-6">
      <Link
        to="/app/template-builder/library"
        className="text-purple-600 hover:underline flex items-center gap-2 mb-4"
      >
        <ChevronLeft size={18} /> Back to Library
      </Link>

      <div className="flex items-center justify-between mb-3">
        <h2 className="text-2xl font-bold text-purple-800">Draft Editor</h2>
        <div className="flex items-center gap-3">
          <select
            value={language}
            onChange={e => onLanguageChange(e.target.value)}
            className="rounded border-gray-300 text-sm"
          >
            <option value="en_US">English (en_US)</option>
          </select>
          <DraftStatusBadge status={status} />
        </div>
      </div>

      <p className="text-sm text-gray-600 mb-4">
        Edit your draft variant, preview with examples, check name collision,
        and submit to Meta.
      </p>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Left: Editor */}
        <Card className="p-5">
          <div className="grid grid-cols-1 gap-4">
            {/* Name + Category */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div className="md:col-span-2">
                <label className="text-sm text-gray-600">Template Name</label>
                <input
                  value={name}
                  onChange={e => setName(e.target.value)}
                  placeholder="e.g., order_update_v2"
                  className="mt-1 w-full rounded border-gray-300"
                />
              </div>
              <div>
                <label className="text-sm text-gray-600">Category</label>
                <select
                  value={category}
                  onChange={e => setCategory(e.target.value)}
                  className="mt-1 w-full rounded border-gray-300"
                >
                  <option value="UTILITY">Utility</option>
                  <option value="MARKETING">Marketing</option>
                  <option value="AUTHENTICATION">Authentication</option>
                </select>
              </div>
            </div>

            {/* Header */}
            <div>
              <label className="text-sm text-gray-600">Header</label>
              <div className="mt-1 grid grid-cols-1 md:grid-cols-3 gap-3">
                <select
                  value={headerType}
                  onChange={e => setHeaderType(e.target.value)}
                  className="rounded border-gray-300"
                >
                  <option value="NONE">None</option>
                  <option value="TEXT">Text</option>
                  <option value="IMAGE">Image</option>
                  <option value="VIDEO">Video</option>
                  <option value="DOCUMENT">Document</option>
                </select>

                {headerType === "TEXT" && (
                  <input
                    value={headerText}
                    onChange={e => setHeaderText(e.target.value)}
                    placeholder="Header text"
                    className="md:col-span-2 rounded border-gray-300"
                  />
                )}

                {["IMAGE", "VIDEO", "DOCUMENT"].includes(headerType) && (
                  <div className="md:col-span-2">
                    <HeaderMediaUploader
                      mediaType={headerType}
                      handle={headerMediaHandle}
                      onUploaded={h => setHeaderMediaHandle(h)}
                    />
                  </div>
                )}
              </div>
            </div>

            {/* Body */}
            <div>
              <label className="text-sm text-gray-600">Body</label>
              <textarea
                value={bodyText}
                onChange={e => setBodyText(e.target.value)}
                rows={6}
                placeholder="Hello {{1}}, your order {{2}} is confirmed."
                className="mt-1 w-full rounded border-gray-300"
              />
              <p className="text-xs text-gray-500 mt-1">
                Use placeholders like <code>{"{{1}}"}</code>,{" "}
                <code>{"{{2}}"}</code>. Max 1024 chars.
              </p>
            </div>

            {/* Footer */}
            <div>
              <label className="text-sm text-gray-600">Footer (optional)</label>
              <input
                value={footerText}
                onChange={e => setFooterText(e.target.value)}
                placeholder="For queries, reply HELP"
                className="mt-1 w-full rounded border-gray-300"
              />
            </div>

            {/* Buttons (‚â§3) */}
            <div>
              <div className="flex items-center justify-between">
                <label className="text-sm text-gray-600">Buttons (max 3)</label>
                <button
                  type="button"
                  onClick={() =>
                    setButtons(prev =>
                      prev.length < 3
                        ? [...prev, { type: "URL", text: "", url: "" }]
                        : prev
                    )
                  }
                  className="text-purple-600 text-sm flex items-center gap-1"
                >
                  <Save size={16} /> Add Button
                </button>
              </div>
              <div className="mt-2 space-y-2">
                {buttons.map((b, i) => (
                  <div
                    key={i}
                    className="grid grid-cols-1 md:grid-cols-3 gap-2"
                  >
                    <select
                      value={b.type}
                      onChange={e =>
                        setButtons(btns => {
                          const c = [...btns];
                          c[i] = { ...c[i], type: e.target.value };
                          return c;
                        })
                      }
                      className="rounded border-gray-300"
                    >
                      <option value="URL">URL</option>
                      <option value="PHONE_NUMBER">Phone</option>
                      <option value="QUICK_REPLY">Quick Reply</option>
                    </select>
                    <input
                      value={b.text || ""}
                      onChange={e =>
                        setButtons(btns => {
                          const c = [...btns];
                          c[i] = { ...c[i], text: e.target.value };
                          return c;
                        })
                      }
                      placeholder="Button text"
                      className="rounded border-gray-300"
                    />
                    <input
                      value={b.url || b.phone_number || ""}
                      onChange={e =>
                        setButtons(btns => {
                          const c = [...btns];
                          const key =
                            c[i].type === "PHONE_NUMBER"
                              ? "phone_number"
                              : "url";
                          c[i] = { ...c[i], [key]: e.target.value };
                          return c;
                        })
                      }
                      placeholder={
                        b.type === "PHONE_NUMBER" ? "+91..." : "https://‚Ä¶"
                      }
                      className="rounded border-gray-300"
                    />
                  </div>
                ))}
              </div>
            </div>

            {/* Examples */}
            <div>
              <div className="flex items-center justify-between">
                <label className="text-sm text-gray-600">
                  Example values (for preview)
                </label>
                <button
                  type="button"
                  onClick={() => setExamples(prev => [...prev, ""])}
                  className="text-purple-600 text-sm"
                >
                  + Add example
                </button>
              </div>
              <div className="mt-2 space-y-2">
                {examples.map((ex, i) => (
                  <input
                    key={i}
                    value={ex}
                    onChange={e =>
                      setExamples(arr => {
                        const copy = [...arr];
                        copy[i] = e.target.value;
                        return copy;
                      })
                    }
                    placeholder={`Example ${i + 1}`}
                    className="w-full rounded border-gray-300"
                  />
                ))}
              </div>
            </div>

            {/* Actions */}
            <div className="flex flex-wrap items-center gap-3 pt-2">
              <button
                onClick={handleSave}
                disabled={saving}
                className="inline-flex items-center gap-2 rounded bg-purple-600 px-4 py-2 text-white hover:bg-purple-700 disabled:opacity-60"
              >
                {saving ? (
                  <Loader2 className="animate-spin" size={18} />
                ) : (
                  <Save size={18} />
                )}
                Save
              </button>

              <button
                onClick={handlePreview}
                disabled={previewLoading}
                className="inline-flex items-center gap-2 rounded border px-4 py-2 hover:bg-gray-50 disabled:opacity-60"
              >
                {previewLoading ? (
                  <Loader2 className="animate-spin" size={18} />
                ) : (
                  <Eye size={18} />
                )}
                Preview
              </button>

              <button
                onClick={handleNameCheck}
                disabled={checking}
                className="inline-flex items-center gap-2 rounded border px-4 py-2 hover:bg-gray-50 disabled:opacity-60"
              >
                {checking ? (
                  <Loader2 className="animate-spin" size={18} />
                ) : (
                  <ShieldCheck size={18} />
                )}
                Name Check
              </button>

              <button
                onClick={handleSubmit}
                disabled={submitting}
                className="ml-auto inline-flex items-center gap-2 rounded bg-green-600 px-4 py-2 text-white hover:bg-green-700 disabled:opacity-60"
              >
                {submitting ? (
                  <Loader2 className="animate-spin" size={18} />
                ) : (
                  <Send size={18} />
                )}
                Submit to Meta
              </button>
            </div>
          </div>
        </Card>

        {/* Right: Live Preview */}
        <Card className="p-5">
          <div className="flex items-center justify-between mb-2">
            <div className="text-purple-700 font-semibold">Preview</div>
            {previewLoading && (
              <Loader2 className="animate-spin text-gray-400" size={18} />
            )}
          </div>
          {!preview ? (
            <div className="text-gray-500 text-sm">
              No preview yet. Click <b>Preview</b> to render.
            </div>
          ) : (
            <div className="space-y-4">
              {/* Human preview (simple) */}
              <div className="rounded border p-3 bg-gray-50">
                <div className="text-xs uppercase text-gray-500 mb-1">
                  Human Preview
                </div>
                <pre className="whitespace-pre-wrap text-sm text-gray-800">
                  {preview.human || "‚Äî"}
                </pre>
              </div>

              {/* Meta components (payload) */}
              <div className="rounded border p-3">
                <div className="text-xs uppercase text-gray-500 mb-1">
                  Meta Components
                </div>
                <pre className="overflow-auto text-xs">
                  {JSON.stringify(preview.components || {}, null, 2)}
                </pre>
              </div>
            </div>
          )}
        </Card>
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\TemplateBuilder\LibraryBrowsePage.jsx 
====================================================== 
 
import React from "react";
import { useNavigate, useSearchParams } from "react-router-dom";
import { Card } from "../../components/ui/card";
import { browseLibrary, activateLibraryItem } from "./api";
import { toast } from "react-toastify";

function useDebouncedValue(value, delay = 300) {
  const [v, setV] = React.useState(value);
  React.useEffect(() => {
    const t = setTimeout(() => setV(value), delay);
    return () => clearTimeout(t);
  }, [value, delay]);
  return v;
}

export default function LibraryBrowsePage() {
  const navigate = useNavigate();
  const [sp, setSp] = useSearchParams();

  const [loading, setLoading] = React.useState(false);
  const [items, setItems] = React.useState([]);
  const [total, setTotal] = React.useState(0);

  const [industry, setIndustry] = React.useState(sp.get("industry") || "");
  const [q, setQ] = React.useState(sp.get("q") || "");
  const [sort, setSort] = React.useState(sp.get("sort") || "featured");
  const [page, setPage] = React.useState(Number(sp.get("page")) || 1);
  const [pageSize, setPageSize] = React.useState(20);

  const qDebounced = useDebouncedValue(q, 300);

  const refresh = React.useCallback(async () => {
    setLoading(true);
    try {
      const data = await browseLibrary({
        industry: industry || undefined,
        q: qDebounced || undefined,
        sort,
        page,
        pageSize,
      });
      setItems(data.items);
      setTotal(data.total);
      // sync URL
      const next = new URLSearchParams();
      if (industry) next.set("industry", industry);
      if (q) next.set("q", q);
      if (sort && sort !== "featured") next.set("sort", sort);
      if (page > 1) next.set("page", String(page));
      setSp(next, { replace: true });
    } finally {
      setLoading(false);
    }
  }, [industry, qDebounced, q, sort, page, pageSize, setSp]);

  React.useEffect(() => {
    refresh();
  }, [refresh]);

  const totalPages = Math.max(1, Math.ceil(total / pageSize));

  async function handleActivate(itemId) {
    try {
      setLoading(true);
      const res = await activateLibraryItem(itemId, { languages: ["en_US"] });
      toast.success("Template added to your drafts");
      navigate(`/app/template-builder/drafts/${res.draftId}`); // Step 30 page
    } catch (e) {
      /* axios interceptor toasts errors */
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="p-6 space-y-4">
      <header className="flex items-center justify-between gap-3">
        <div className="text-xl font-semibold">Template Library</div>
        <div className="text-gray-500 text-sm">
          Pick a template ‚Üí Activate ‚Üí Edit & Submit
        </div>
      </header>

      <section className="flex flex-wrap items-center gap-3">
        <select
          className="border rounded-lg px-3 py-2 text-sm"
          value={industry}
          onChange={e => {
            setPage(1);
            setIndustry(e.target.value);
          }}
        >
          <option value="">All segments</option>
          <option value="SALON">Salon</option>
          <option value="GYM">Gym</option>
          <option value="DOCTOR">Doctor</option>
          <option value="RETAILER">Retailer</option>
          <option value="MEDICAL">Medical</option>
          <option value="HOSPITAL">Hospital</option>
          <option value="REAL_ESTATE">Real Estate</option>
        </select>

        <input
          className="border rounded-lg px-3 py-2 text-sm w-64"
          placeholder="Search by keyword‚Ä¶"
          value={q}
          onChange={e => {
            setPage(1);
            setQ(e.target.value);
          }}
        />

        <select
          className="border rounded-lg px-3 py-2 text-sm"
          value={sort}
          onChange={e => {
            setPage(1);
            setSort(e.target.value);
          }}
        >
          <option value="featured">Featured first</option>
          <option value="name">Name (A‚ÄìZ)</option>
        </select>
      </section>

      <section className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {items.map(it => (
          <Card key={it.id} className="flex flex-col justify-between">
            <div className="space-y-2">
              <div className="flex items-center justify-between">
                <div className="font-medium">{it.key}</div>
                {it.isFeatured && (
                  <span className="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full">
                    Featured
                  </span>
                )}
              </div>
              <div className="text-xs text-gray-500">
                {it.industry} ‚Ä¢ {it.category} ‚Ä¢ {it.language}
              </div>
              <div className="text-sm text-gray-700 line-clamp-3">
                {it.bodyPreview}
              </div>
              <div className="text-xs text-gray-500">
                {it.placeholders > 0
                  ? `Placeholders: ${it.placeholders}`
                  : "No placeholders"}
                {it.buttonsSummary ? ` ‚Ä¢ Buttons: ${it.buttonsSummary}` : ""}
              </div>
            </div>

            <div className="pt-3 flex items-center justify-between">
              <span className="text-xs text-gray-400">
                Header: {it.headerType}
              </span>
              <button
                className="inline-flex items-center px-3 py-1.5 text-sm rounded-lg bg-purple-600 text-white hover:bg-purple-700 disabled:opacity-60"
                onClick={() => handleActivate(it.id)}
                disabled={loading}
                aria-label={`Use template ${it.key}`}
              >
                Use this template
              </button>
            </div>
          </Card>
        ))}
      </section>

      <footer className="flex items-center justify-between pt-2">
        <div className="text-sm text-gray-500">
          Total: {total.toLocaleString()}
        </div>
        <div className="flex items-center gap-2">
          <button
            className="px-3 py-1.5 text-sm rounded-md border disabled:opacity-50"
            onClick={() => setPage(p => Math.max(1, p - 1))}
            disabled={page <= 1 || loading}
          >
            Prev
          </button>
          <span className="text-sm">
            {page} / {totalPages}
          </span>
          <button
            className="px-3 py-1.5 text-sm rounded-md border disabled:opacity-50"
            onClick={() => setPage(p => Math.min(totalPages, p + 1))}
            disabled={page >= totalPages || loading}
          >
            Next
          </button>
        </div>
      </footer>

      {loading && (
        <div
          className="fixed inset-0 bg-black/5 pointer-events-none animate-pulse"
          aria-hidden
        />
      )}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\TemplateBuilder\components\DraftStatusBadge.jsx 
====================================================== 
 
import React from "react";

export default function DraftStatusBadge({ status }) {
  if (!status?.status) {
    return (
      <span className="text-xs px-2 py-1 rounded border text-gray-600">
        Draft ‚Ä¢ Not submitted
      </span>
    );
  }

  const s = String(status.status).toUpperCase();
  const color =
    s === "APPROVED"
      ? "bg-green-100 text-green-700 border-green-200"
      : s === "REJECTED"
      ? "bg-red-100 text-red-700 border-red-200"
      : s === "PAUSED"
      ? "bg-yellow-100 text-yellow-700 border-yellow-200"
      : "bg-blue-100 text-blue-700 border-blue-200";

  return (
    <span className={`text-xs px-2 py-1 rounded border ${color}`}>{s}</span>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\TemplateBuilder\components\HeaderMediaUploader.jsx 
====================================================== 
 
import React, { useState } from "react";
import { Upload, Loader2 } from "lucide-react";
import axiosClient from "../../../api/axiosClient";
import { toast } from "react-toastify";

export default function HeaderMediaUploader({ mediaType, handle, onUploaded }) {
  const [busy, setBusy] = useState(false);

  const onFile = async file => {
    if (!file) return;
    setBusy(true);
    try {
      const form = new FormData();
      form.append("file", file);
      const { data } = await axiosClient.post(
        `/api/template-builder/uploads/header`,
        form,
        { params: { mediaType } }
      );
      if (data?.handle) {
        onUploaded?.(data.handle);
        toast.success("Media uploaded.");
      } else {
        toast.warn("Upload succeeded but no handle returned.");
      }
    } catch (err) {
      toast.error("Upload failed.");
    } finally {
      setBusy(false);
    }
  };

  return (
    <div className="flex items-center gap-3">
      <label className="inline-flex items-center gap-2 px-3 py-2 rounded border cursor-pointer hover:bg-gray-50">
        {busy ? (
          <Loader2 className="animate-spin" size={16} />
        ) : (
          <Upload size={16} />
        )}
        <span className="text-sm">{busy ? "Uploading‚Ä¶" : "Choose file"}</span>
        <input
          type="file"
          className="hidden"
          accept={
            mediaType === "IMAGE"
              ? "image/*"
              : mediaType === "VIDEO"
              ? "video/*"
              : ".pdf,application/pdf"
          }
          onChange={e => onFile(e.target.files?.[0])}
        />
      </label>
      <div className="text-xs text-gray-600">
        {handle ? (
          <span>
            Handle: <code>{handle}</code>
          </span>
        ) : (
          <span>No media selected</span>
        )}
      </div>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Tracking\FailedWebhookLogs.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../api/axiosClient";
import { Dialog } from "@headlessui/react";
import { Button } from "../../components/ui/button";

const FailedWebhookLogs = () => {
  const [logs, setLogs] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedLog, setSelectedLog] = useState(null);

  useEffect(() => {
    const fetchLogs = async () => {
      try {
        const res = await axiosClient.get("/failed-webhooks");
        setLogs(res.data || []);
      } catch (error) {
        console.error("‚ùå Error fetching failed webhook logs", error);
      } finally {
        setLoading(false);
      }
    };

    fetchLogs();
  }, []);

  return (
    <div className="p-6">
      <h2 className="text-2xl font-semibold mb-4">üìâ Failed Webhook Logs</h2>

      {loading ? (
        <p>Loading logs...</p>
      ) : logs.length === 0 ? (
        <p className="text-gray-500">‚úÖ No failed webhook logs found.</p>
      ) : (
        <div className="overflow-x-auto">
          <table className="min-w-full bg-white shadow rounded text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-4 py-2 text-left">üß† Error</th>
                <th className="px-4 py-2 text-left">üì¶ Module</th>
                <th className="px-4 py-2 text-left">‚ö†Ô∏è Type</th>
                <th className="px-4 py-2 text-left">‚è± Time</th>
                <th className="px-4 py-2 text-left">üîç Raw</th>
              </tr>
            </thead>
            <tbody>
              {logs.map(log => (
                <tr key={log.id} className="border-t">
                  <td className="px-4 py-2">{log.errorMessage}</td>
                  <td className="px-4 py-2">{log.sourceModule}</td>
                  <td className="px-4 py-2">{log.failureType}</td>
                  <td className="px-4 py-2 text-gray-700">
                    {new Date(log.createdAt || log.loggedAt).toLocaleString()}
                  </td>
                  <td className="px-4 py-2">
                    <Button size="sm" onClick={() => setSelectedLog(log)}>
                      View JSON
                    </Button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {/* üîç Raw JSON Modal */}
      <Dialog
        open={!!selectedLog}
        onClose={() => setSelectedLog(null)}
        className="relative z-50"
      >
        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm" />
        <div className="fixed inset-0 flex items-center justify-center p-4">
          <Dialog.Panel className="w-full max-w-3xl rounded bg-white p-6 shadow-xl">
            <Dialog.Title className="text-lg font-semibold mb-4">
              üì¶ Raw Webhook Payload
            </Dialog.Title>
            <pre className="overflow-auto max-h-[500px] bg-gray-100 text-sm p-4 rounded border border-gray-200">
              {(() => {
                try {
                  return JSON.stringify(
                    JSON.parse(selectedLog?.rawJson || "{}"),
                    null,
                    2
                  );
                } catch {
                  return "‚ö†Ô∏è Invalid JSON";
                }
              })()}
            </pre>
            <div className="mt-4 text-right">
              <Button variant="secondary" onClick={() => setSelectedLog(null)}>
                Close
              </Button>
            </div>
          </Dialog.Panel>
        </div>
      </Dialog>
    </div>
  );
};

export default FailedWebhookLogs;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Tracking\TrackingViewer.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../api/axiosClient";
import { Card } from "../../components/ui/card";
import { toast } from "react-toastify";
import { useNavigate } from "react-router-dom";

const TrackingViewer = () => {
  const [logs, setLogs] = useState([]);
  const [loading, setLoading] = useState(true);
  const navigate = useNavigate();

  // üîÅ Fetch CTA logs on mount
  useEffect(() => {
    const fetchLogs = async () => {
      try {
        const res = await axiosClient.get("/tracking/logs");
        setLogs(res.data.data);
      } catch (err) {
        toast.error("‚ùå Failed to load CTA tracking logs");
      } finally {
        setLoading(false);
      }
    };

    fetchLogs();
  }, []);

  return (
    <div className="p-4">
      <h2 className="text-xl font-semibold mb-4">üìä CTA Tracking Logs</h2>

      <Card className="overflow-x-auto shadow-md">
        <table className="min-w-full table-auto text-sm text-left">
          <thead className="bg-gray-100">
            <tr>
              <th className="px-3 py-2">Contact</th>
              <th className="px-3 py-2">Phone</th>
              <th className="px-3 py-2">Button</th>
              <th className="px-3 py-2">Type</th>
              <th className="px-3 py-2">Source</th>
              <th className="px-3 py-2">Campaign</th>
              <th className="px-3 py-2">Device</th>
              <th className="px-3 py-2">Country</th>
              <th className="px-3 py-2">Clicked At</th>
            </tr>
          </thead>
          <tbody>
            {loading ? (
              <tr>
                <td colSpan="9" className="text-center py-4">
                  ‚è≥ Loading...
                </td>
              </tr>
            ) : logs.length === 0 ? (
              <tr>
                <td colSpan="9" className="text-center py-4">
                  üôÅ No tracking logs found.
                </td>
              </tr>
            ) : (
              logs.map(log => (
                <tr
                  key={log.id}
                  className="border-b hover:bg-gray-50 cursor-pointer transition"
                  onClick={() =>
                    // navigate(`/api/tracking/logs/${log.id}/details`)
                    navigate(`/app/tracking/logs/${log.id}`)
                  }
                >
                  <td className="px-3 py-2">{log.contactName || "(N/A)"}</td>
                  <td className="px-3 py-2">{log.contactPhone}</td>
                  <td className="px-3 py-2 font-medium text-purple-700 underline">
                    {log.buttonText}
                  </td>
                  <td className="px-3 py-2">{log.ctaType}</td>
                  <td className="px-3 py-2">{log.sourceType}</td>
                  <td className="px-3 py-2">{log.campaignName}</td>
                  <td className="px-3 py-2">{log.deviceType}</td>
                  <td className="px-3 py-2">{log.country}</td>
                  <td className="px-3 py-2">
                    {new Date(log.clickedAt).toLocaleString()}
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </Card>
    </div>
  );
};

export default TrackingViewer;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Tracking\WebhookSettings.jsx 
====================================================== 
 
import React, { useEffect, useState } from "react";
import axiosClient from "../../api/axiosClient";
import { Button } from "../../components/ui/button";
import { toast } from "react-toastify";
import "react-toastify/dist/ReactToastify.css";

const WebhookSettings = () => {
  const [autoCleanup, setAutoCleanup] = useState(false);
  const [lastCleanup, setLastCleanup] = useState(null);
  const [loading, setLoading] = useState(true);
  const [logsCount, setLogsCount] = useState(0);
  const [isSubmitting, setIsSubmitting] = useState(false);

  const fetchStatus = async () => {
    try {
      const [statusRes, countRes] = await Promise.all([
        axiosClient.get("/webhooks/settings"),
        axiosClient.get("/webhooks/failed/count"),
      ]);
      setAutoCleanup(statusRes.data.enabled); // üîÑ Make sure `enabled` matches backend key
      setLastCleanup(statusRes.data.lastCleanupAt);
      setLogsCount(countRes.data.count);
    } catch (err) {
      console.error("‚ùå Failed to load webhook settings", err);
      toast.error("‚ùå Failed to load settings");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchStatus();
  }, []);

  const toggleCleanup = async () => {
    setIsSubmitting(true);
    try {
      const endpoint = autoCleanup
        ? "/webhooks/disable-cleanup"
        : "/webhooks/enable-cleanup";
      await axiosClient.post(endpoint);
      toast.success(
        autoCleanup ? "üßπ Auto Cleanup Disabled" : "‚úÖ Auto Cleanup Enabled"
      );
      await fetchStatus();
    } catch (err) {
      console.error("‚ùå Toggle failed", err);
      toast.error("‚ùå Failed to toggle auto cleanup");
    } finally {
      setIsSubmitting(false);
    }
  };

  const runManualCleanup = async () => {
    setIsSubmitting(true);
    try {
      const res = await axiosClient.post("/webhooks/cleanup-now");
      toast.success(res.data.message || "‚úÖ Manual cleanup complete");
      await fetchStatus();
    } catch (err) {
      console.error("‚ùå Manual cleanup failed", err);
      toast.error("‚ùå Manual cleanup failed");
    } finally {
      setIsSubmitting(false);
    }
  };

  const injectTest = async () => {
    try {
      await axiosClient.post("/webhooks/inject-test-log");
      toast.success("üß™ Test failure log injected successfully.");
      await fetchStatus();
    } catch (err) {
      console.error("‚ùå Injection failed", err);
      toast.error("‚ùå Failed to inject test log");
    }
  };

  return (
    <div className="p-6">
      <h2 className="text-2xl font-semibold mb-4">‚öôÔ∏è Webhook Settings</h2>

      {loading ? (
        <p>Loading settings...</p>
      ) : (
        <div className="space-y-4">
          <div className="bg-white p-4 shadow rounded space-y-1">
            <p>
              üßÆ <strong>Total Failed Logs:</strong> {logsCount}
            </p>
            <p>
              üßπ <strong>Auto-Cleanup Enabled:</strong>{" "}
              <span className={autoCleanup ? "text-green-600" : "text-red-600"}>
                {autoCleanup ? "Yes" : "No"}
              </span>
            </p>
            <p>
              ‚è± <strong>Last Cleanup:</strong>{" "}
              {lastCleanup
                ? new Date(lastCleanup).toLocaleString()
                : "Never run"}
            </p>
          </div>

          <div className="flex flex-wrap gap-4">
            <Button onClick={toggleCleanup} disabled={isSubmitting}>
              {autoCleanup ? "Disable Auto Cleanup" : "Enable Auto Cleanup"}
            </Button>

            <Button
              onClick={runManualCleanup}
              variant="secondary"
              disabled={isSubmitting}
            >
              üßπ Run Manual Cleanup
            </Button>

            <Button onClick={injectTest} variant="destructive">
              üß™ Inject Test Log
            </Button>
          </div>
        </div>
      )}
    </div>
  );
};

export default WebhookSettings;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\UserPermissions\PermissionCheckboxList.jsx 
====================================================== 
 
// üìÑ src/pages/UserPermissions/PermissionCheckboxList.jsx

import React from "react";

export default function PermissionCheckboxList({
  allPermissions,
  assignedPermissions,
  setAssignedPermissions,
}) {
  const grouped = allPermissions.reduce((acc, p) => {
    const group = p.group || "Other";
    if (!acc[group]) acc[group] = [];
    acc[group].push(p);
    return acc;
  }, {});

  const isChecked = id => assignedPermissions.includes(id);

  const handleToggle = id => {
    if (isChecked(id)) {
      setAssignedPermissions(assignedPermissions.filter(pid => pid !== id));
    } else {
      setAssignedPermissions([...assignedPermissions, id]);
    }
  };

  return (
    <div className="space-y-6">
      {Object.entries(grouped).map(([group, permissions]) => (
        <div key={group}>
          <h3 className="font-semibold text-lg mb-2 border-b pb-1">{group}</h3>
          <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
            {permissions.map(perm => (
              <label
                key={perm.id}
                className="flex items-center space-x-2 bg-gray-50 border rounded px-3 py-2"
              >
                <input
                  type="checkbox"
                  checked={isChecked(perm.id)}
                  onChange={() => handleToggle(perm.id)}
                />
                <span>{perm.name}</span>
              </label>
            ))}
          </div>
        </div>
      ))}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\UserPermissions\UserPermissions.jsx 
====================================================== 
 
// üìÑ src/pages/UserPermissions/UserPermissions.jsx

import React, { useEffect, useState } from "react";
import axios from "axios";
import { toast } from "react-toastify";
import PermissionCheckboxList from "./PermissionCheckboxList";

export default function UserPermissions() {
  const [users, setUsers] = useState([]);
  const [selectedUserId, setSelectedUserId] = useState("");
  const [allPermissions, setAllPermissions] = useState([]);
  const [userPermissions, setUserPermissions] = useState([]);

  useEffect(() => {
    fetchUsers();
    fetchAllPermissions();
  }, []);

  const fetchUsers = async () => {
    try {
      const res = await axios.get("/api/users/by-business");
      setUsers(res.data);
    } catch (err) {
      toast.error("Failed to fetch users");
    }
  };

  const fetchAllPermissions = async () => {
    try {
      const res = await axios.get("/api/permissions");
      setAllPermissions(res.data);
    } catch (err) {
      toast.error("Failed to load permissions");
    }
  };

  const fetchUserPermissions = async userId => {
    try {
      const res = await axios.get(`/api/users/${userId}/permissions`);
      setUserPermissions(res.data);
    } catch (err) {
      toast.error("Failed to fetch user permissions");
    }
  };

  const handleUserChange = e => {
    const id = e.target.value;
    setSelectedUserId(id);
    fetchUserPermissions(id);
  };

  const handleSave = async () => {
    try {
      await axios.post(
        `/api/users/${selectedUserId}/permissions`,
        userPermissions
      );
      toast.success("Permissions updated successfully");
    } catch (err) {
      toast.error("Failed to save permissions");
    }
  };

  return (
    <div className="p-6">
      <h2 className="text-2xl font-semibold mb-4">User Permissions</h2>

      <div className="mb-4">
        <label className="block font-medium mb-1">Select User:</label>
        <select
          value={selectedUserId}
          onChange={handleUserChange}
          className="w-full border rounded p-2"
        >
          <option value="">-- Select --</option>
          {users.map(user => (
            <option key={user.id} value={user.id}>
              {user.fullName} ({user.role})
            </option>
          ))}
        </select>
      </div>

      {selectedUserId && (
        <>
          <PermissionCheckboxList
            allPermissions={allPermissions}
            assignedPermissions={userPermissions}
            setAssignedPermissions={setUserPermissions}
          />
          <button
            onClick={handleSave}
            className="mt-4 bg-purple-600 text-white px-4 py-2 rounded shadow"
          >
            Save Permissions
          </button>
        </>
      )}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\UserPermissions\UserPermissionsPage.jsx 
====================================================== 
 
// üìÑ File: src/pages/UserPermissions/UserPermissionsPage.jsx
import React, { useEffect, useState } from "react";
import axios from "axios";
import { toast } from "react-toastify";
import { Card, CardContent } from "@/components/ui/card";
import { Switch } from "@/components/ui/switch";
import { Label } from "@/components/ui/label";

export default function UserPermissionsPage() {
  const [loading, setLoading] = useState(true);
  const [users, setUsers] = useState([]);

  const fetchPermissions = async () => {
    try {
      const res = await axios.get("/api/feature-access/user-permissions");
      setUsers(res.data);
    } catch (err) {
      toast.error("Failed to load user permissions");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchPermissions();
  }, []);

  const handleToggle = async (userId, featureCode, current) => {
    try {
      await axios.patch(`/api/feature-access/user-permissions/${userId}`, {
        featureCode,
        isEnabled: !current,
      });
      toast.success("Permission updated");
      fetchPermissions();
    } catch (err) {
      toast.error("Failed to update permission");
    }
  };

  if (loading) return <p className="p-4">Loading permissions...</p>;

  return (
    <div className="p-6 space-y-6">
      <h2 className="text-xl font-semibold">User Feature Permissions</h2>
      {users.map(user => (
        <Card key={user.userId} className="shadow">
          <CardContent className="p-4 space-y-4">
            <div>
              <h3 className="font-bold">
                {user.fullName} ({user.email})
              </h3>
              <p className="text-sm text-gray-500">Role: {user.role}</p>
            </div>
            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
              {user.permissions.map(perm => (
                <div
                  key={perm.featureCode}
                  className="flex items-center gap-2 border p-2 rounded-md"
                >
                  <Switch
                    id={`${user.userId}-${perm.featureCode}`}
                    checked={perm.isEnabled}
                    onCheckedChange={() =>
                      handleToggle(
                        user.userId,
                        perm.featureCode,
                        perm.isEnabled
                      )
                    }
                  />
                  <Label
                    htmlFor={`${user.userId}-${perm.featureCode}`}
                    className="text-sm"
                  >
                    {perm.featureCode}
                  </Label>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      ))}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\WhatsAppMessageEngine\SendContentFreeTextMessage.jsx 
====================================================== 
 
import React, { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";

// üì¶ Token-style phone number input
function PhoneNumberInput({ numbers, setNumbers }) {
  const [input, setInput] = useState("");

  const handleInputChange = e => {
    const value = e.target.value;
    const lastChar = value.slice(-1);
    const isSeparator = /[\n, ]/.test(lastChar);

    if (isSeparator) {
      tryAddPhone(input.trim());
      setInput("");
    } else {
      setInput(value);
    }
  };

  const tryAddPhone = value => {
    let normalized = value.replace(/[^0-9+]/g, "");

    // Auto-add +91 if it's a 10-digit number and no +
    if (/^\d{10}$/.test(normalized)) {
      normalized = "+91" + normalized;
    }

    // Accept if it's a valid E.164 format (10‚Äì15 digits with optional +)
    if (/^\+?\d{10,15}$/.test(normalized)) {
      if (!numbers.includes(normalized)) {
        setNumbers([...numbers, normalized]);
      }
    }
  };

  const handleKeyDown = e => {
    if (e.key === "Enter") {
      tryAddPhone(input.trim());
      setInput("");
      e.preventDefault();
    } else if (e.key === "Backspace" && input === "") {
      setNumbers(numbers.slice(0, -1));
    }
  };

  const removeNumber = num => {
    setNumbers(numbers.filter(n => n !== num));
  };

  return (
    <div className="w-full border rounded-xl p-2 flex flex-wrap gap-2 min-h-[60px] bg-white shadow-sm">
      {numbers.map((num, idx) => (
        <span
          key={idx}
          className="flex items-center bg-blue-100 text-blue-800 text-sm font-medium px-3 py-1 rounded-full"
        >
          {num}
          <button
            type="button"
            className="ml-2 text-blue-600 hover:text-red-500"
            onClick={() => removeNumber(num)}
          >
            &times;
          </button>
        </span>
      ))}
      <input
        type="text"
        className="flex-grow p-1 text-sm outline-none"
        placeholder="Type or paste numbers..."
        value={input}
        onChange={handleInputChange}
        onKeyDown={handleKeyDown}
      />
    </div>
  );
}

export default function SendTextMessagePage() {
  const [manualNumbers, setManualNumbers] = useState([]);
  const [selectedNumbers, setSelectedNumbers] = useState([]);
  const [contacts, setContacts] = useState([]);
  const [message, setMessage] = useState("");
  const [submitting, setSubmitting] = useState(false);
  const [messageLogs, setMessageLogs] = useState([]);
  const [saveContact, setSaveContact] = useState(false); // ‚úÖ toggle state
  const navigate = useNavigate();

  useEffect(() => {
    const loadContacts = async () => {
      try {
        const res = await axiosClient.get("/contacts/");
        setContacts(res.data?.data?.items || []);
      } catch (err) {
        console.error("‚ùå Error loading contacts", err);
        toast.error("Failed to load contacts.");
      }
    };

    const loadHistory = async () => {
      try {
        const res = await axiosClient.get(
          "/reporting/messages/recent?limit=10"
        );
        setMessageLogs(res.data?.data || []);
      } catch (err) {
        console.error("‚ùå Error loading history", err);
      }
    };

    loadContacts();
    loadHistory();
  }, []);

  const numbers = [...new Set([...manualNumbers, ...selectedNumbers])];

  const handleSend = async () => {
    if (!message || numbers.length === 0) {
      toast.warn("‚ö†Ô∏è Please enter a message and at least one valid number.");
      return;
    }

    setSubmitting(true);
    let success = 0,
      failed = 0;

    for (const number of numbers) {
      try {
        const res = await axiosClient.post(
          "/messageengine/send-contentfree-text",
          {
            recipientNumber: number,
            textContent: message,
            isSaveContact: saveContact, // ‚úÖ pass toggle value
          }
        );
        res.data?.success ? success++ : failed++;
      } catch (err) {
        failed++;
        console.error("Send failed:", number, err);
      }
    }

    toast.success(`‚úÖ Sent: ${success}, ‚ùå Failed: ${failed}`);
    setSubmitting(false);
  };

  return (
    <div className="max-w-5xl mx-auto p-6 space-y-6">
      <div className="flex items-center justify-between">
        <h2 className="text-2xl font-bold text-purple-700">
          üì§ Send WhatsApp Message
        </h2>
        <button
          onClick={() => navigate("/messages/history")}
          className="text-sm text-blue-600 hover:underline"
        >
          üîç View Full History
        </button>
      </div>

      {/* üéØ Target Audience */}
      <div className="grid md:grid-cols-2 gap-6">
        {/* üìá Select from Contacts */}
        <div className="bg-white rounded-xl shadow p-4">
          <h3 className="font-semibold text-gray-800 mb-2">
            üìá Select Contacts
          </h3>
          <div className="max-h-60 overflow-y-auto space-y-2 pr-2">
            {contacts.length > 0 ? (
              contacts.map(contact => (
                <div key={contact.id} className="flex items-center gap-2">
                  <input
                    type="checkbox"
                    value={contact.phoneNumber}
                    checked={selectedNumbers.includes(contact.phoneNumber)}
                    onChange={e => {
                      const value = e.target.value;
                      setSelectedNumbers(prev =>
                        e.target.checked
                          ? [...prev, value]
                          : prev.filter(n => n !== value)
                      );
                    }}
                  />
                  <label className="text-sm text-gray-700">
                    {contact.name} ({contact.phoneNumber})
                  </label>
                </div>
              ))
            ) : (
              <p className="text-sm text-gray-500 italic">
                No contacts available.
              </p>
            )}
          </div>
        </div>

        {/* ‚úçÔ∏è Manual Entry */}
        {/* <div className="bg-white rounded-xl shadow p-4">
          <label className="block font-semibold text-gray-800 mb-2">
            ‚úçÔ∏è Manual Numbers
          </label>
          <PhoneNumberInput
            numbers={manualNumbers}
            setNumbers={setManualNumbers}
          />
        </div> */}
        {/* ‚úçÔ∏è Manual Entry */}
        <div className="bg-white rounded-xl shadow p-4">
          <label className="block font-semibold text-gray-800 mb-2">
            ‚úçÔ∏è Manual Numbers
          </label>
          <PhoneNumberInput
            numbers={manualNumbers}
            setNumbers={setManualNumbers}
          />

          {/* ‚úÖ Toggle Save Contact (specific to manual numbers) */}
          <div className="flex items-center gap-2 mt-3">
            <input
              type="checkbox"
              id="saveContact"
              checked={saveContact}
              onChange={e => setSaveContact(e.target.checked)}
            />
            <label htmlFor="saveContact" className="text-sm text-gray-700">
              Save manual numbers to Contacts after sending
            </label>
          </div>
        </div>
      </div>

      {/* üí¨ Message Input */}
      <div className="bg-white rounded-xl shadow p-4">
        <label className="block font-semibold text-gray-800 mb-2">
          üí¨ Message
        </label>
        <textarea
          rows={4}
          className="w-full p-3 border rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
          placeholder="Write your message..."
          value={message}
          onChange={e => setMessage(e.target.value)}
        />
      </div>

      {/* üîò Send Button */}
      <div className="text-right">
        <button
          onClick={handleSend}
          disabled={submitting}
          className={`px-6 py-3 font-semibold rounded-xl transition ${
            submitting
              ? "bg-gray-400 cursor-not-allowed text-white"
              : "bg-green-600 text-white hover:bg-green-700"
          }`}
        >
          {submitting ? "Sending..." : `Send to ${numbers.length} Recipient(s)`}
        </button>
      </div>

      {/* üïì Recent Sent Messages */}
      <div className="bg-white mt-6 p-4 rounded-xl shadow">
        <h3 className="font-semibold text-lg text-gray-800 mb-4">
          üïì Recent Sent Messages
        </h3>
        <div className="overflow-x-auto">
          <table className="w-full text-sm text-left border">
            <thead className="bg-gray-100 text-gray-700">
              <tr>
                <th className="px-3 py-2">Recipient</th>
                <th className="px-3 py-2">Status</th>
                <th className="px-3 py-2">Sent At</th>
                <th className="px-3 py-2">Message</th>
              </tr>
            </thead>
            <tbody>
              {messageLogs.length > 0 ? (
                messageLogs.map(log => (
                  <tr key={log.id} className="border-b">
                    <td className="px-3 py-2">{log.recipientNumber}</td>
                    <td className="px-3 py-2">
                      <span
                        className={`px-2 py-1 rounded-full text-xs font-medium ${
                          log.status === "Success"
                            ? "bg-green-100 text-green-700"
                            : "bg-red-100 text-red-600"
                        }`}
                      >
                        {log.status}
                      </span>
                    </td>
                    <td className="px-3 py-2">
                      {log.sentAt ? new Date(log.sentAt).toLocaleString() : "‚Äî"}
                    </td>
                    <td
                      className="px-3 py-2 max-w-[250px] truncate"
                      title={log.messageContent}
                    >
                      {log.messageContent || "(empty)"}
                    </td>
                  </tr>
                ))
              ) : (
                <tr>
                  <td colSpan="4" className="text-center text-gray-500 py-4">
                    No messages sent yet.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}

// import React, { useState, useEffect } from "react";
// import { useNavigate } from "react-router-dom";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";

// // üì¶ Token-style phone number input
// function PhoneNumberInput({ numbers, setNumbers }) {
//   const [input, setInput] = useState("");

//   const handleInputChange = e => {
//     const value = e.target.value;
//     const lastChar = value.slice(-1);
//     const isSeparator = /[\n, ]/.test(lastChar);

//     if (isSeparator) {
//       tryAddPhone(input.trim());
//       setInput("");
//     } else {
//       setInput(value);
//     }
//   };

//   const tryAddPhone = value => {
//     let normalized = value.replace(/[^0-9+]/g, "");

//     // Auto-add +91 if it's a 10-digit number and no +
//     if (/^\d{10}$/.test(normalized)) {
//       normalized = "+91" + normalized;
//     }

//     // Accept if it's a valid E.164 format (10‚Äì15 digits with optional +)
//     if (/^\+?\d{10,15}$/.test(normalized)) {
//       if (!numbers.includes(normalized)) {
//         setNumbers([...numbers, normalized]);
//       }
//     }
//   };

//   const handleKeyDown = e => {
//     if (e.key === "Enter") {
//       tryAddPhone(input.trim());
//       setInput("");
//       e.preventDefault();
//     } else if (e.key === "Backspace" && input === "") {
//       setNumbers(numbers.slice(0, -1));
//     }
//   };

//   const removeNumber = num => {
//     setNumbers(numbers.filter(n => n !== num));
//   };

//   return (
//     <div className="w-full border rounded-xl p-2 flex flex-wrap gap-2 min-h-[60px] bg-white shadow-sm">
//       {numbers.map((num, idx) => (
//         <span
//           key={idx}
//           className="flex items-center bg-blue-100 text-blue-800 text-sm font-medium px-3 py-1 rounded-full"
//         >
//           {num}
//           <button
//             type="button"
//             className="ml-2 text-blue-600 hover:text-red-500"
//             onClick={() => removeNumber(num)}
//           >
//             &times;
//           </button>
//         </span>
//       ))}
//       <input
//         type="text"
//         className="flex-grow p-1 text-sm outline-none"
//         placeholder="Type or paste numbers..."
//         value={input}
//         onChange={handleInputChange}
//         onKeyDown={handleKeyDown}
//       />
//     </div>
//   );
// }

// export default function SendTextMessagePage() {
//   const [manualNumbers, setManualNumbers] = useState([]);
//   const [selectedNumbers, setSelectedNumbers] = useState([]);
//   const [contacts, setContacts] = useState([]);
//   const [message, setMessage] = useState("");
//   const [submitting, setSubmitting] = useState(false);
//   const [messageLogs, setMessageLogs] = useState([]);
//   const navigate = useNavigate();

//   useEffect(() => {
//     const loadContacts = async () => {
//       try {
//         const res = await axiosClient.get("/contacts");
//         setContacts(res.data?.data?.items || []);
//       } catch (err) {
//         console.error("‚ùå Error loading contacts", err);
//         toast.error("Failed to load contacts.");
//       }
//     };

//     const loadHistory = async () => {
//       try {
//         const res = await axiosClient.get(
//           "/reporting/messages/recent?limit=10"
//         );
//         setMessageLogs(res.data?.data || []);
//       } catch (err) {
//         console.error("‚ùå Error loading history", err);
//       }
//     };

//     loadContacts();
//     loadHistory();
//   }, []);

//   const numbers = [...new Set([...manualNumbers, ...selectedNumbers])];

//   const handleSend = async () => {
//     if (!message || numbers.length === 0) {
//       toast.warn("‚ö†Ô∏è Please enter a message and at least one valid number.");
//       return;
//     }

//     setSubmitting(true);
//     let success = 0,
//       failed = 0;

//     for (const number of numbers) {
//       try {
//         const res = await axiosClient.post(
//           "/messageengine/send-contentfree-text",
//           {
//             recipientNumber: number,
//             textContent: message,
//           }
//         );
//         res.data?.success ? success++ : failed++;
//       } catch (err) {
//         failed++;
//         console.error("Send failed:", number, err);
//       }
//     }

//     toast.success(`‚úÖ Sent: ${success}, ‚ùå Failed: ${failed}`);
//     setSubmitting(false);
//   };

//   return (
//     <div className="max-w-5xl mx-auto p-6 space-y-6">
//       <div className="flex items-center justify-between">
//         <h2 className="text-2xl font-bold text-purple-700">
//           üì§ Send WhatsApp Message
//         </h2>
//         <button
//           onClick={() => navigate("/messages/history")}
//           className="text-sm text-blue-600 hover:underline"
//         >
//           üîç View Full History
//         </button>
//       </div>

//       {/* üéØ Target Audience */}
//       <div className="grid md:grid-cols-2 gap-6">
//         {/* üìá Select from Contacts */}
//         <div className="bg-white rounded-xl shadow p-4">
//           <h3 className="font-semibold text-gray-800 mb-2">
//             üìá Select Contacts
//           </h3>
//           <div className="max-h-60 overflow-y-auto space-y-2 pr-2">
//             {contacts.length > 0 ? (
//               contacts.map(contact => (
//                 <div key={contact.id} className="flex items-center gap-2">
//                   <input
//                     type="checkbox"
//                     value={contact.phoneNumber}
//                     checked={selectedNumbers.includes(contact.phoneNumber)}
//                     onChange={e => {
//                       const value = e.target.value;
//                       setSelectedNumbers(prev =>
//                         e.target.checked
//                           ? [...prev, value]
//                           : prev.filter(n => n !== value)
//                       );
//                     }}
//                   />
//                   <label className="text-sm text-gray-700">
//                     {contact.name} ({contact.phoneNumber})
//                   </label>
//                 </div>
//               ))
//             ) : (
//               <p className="text-sm text-gray-500 italic">
//                 No contacts available.
//               </p>
//             )}
//           </div>
//         </div>

//         {/* ‚úçÔ∏è Manual Entry */}
//         <div className="bg-white rounded-xl shadow p-4">
//           <label className="block font-semibold text-gray-800 mb-2">
//             ‚úçÔ∏è Manual Numbers
//           </label>
//           <PhoneNumberInput
//             numbers={manualNumbers}
//             setNumbers={setManualNumbers}
//           />
//         </div>
//       </div>

//       {/* üí¨ Message Input */}
//       <div className="bg-white rounded-xl shadow p-4">
//         <label className="block font-semibold text-gray-800 mb-2">
//           üí¨ Message
//         </label>
//         <textarea
//           rows={4}
//           className="w-full p-3 border rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
//           placeholder="Write your message..."
//           value={message}
//           onChange={e => setMessage(e.target.value)}
//         />
//       </div>

//       {/* üîò Send Button */}
//       <div className="text-right">
//         <button
//           onClick={handleSend}
//           disabled={submitting}
//           className={`px-6 py-3 font-semibold rounded-xl transition ${
//             submitting
//               ? "bg-gray-400 cursor-not-allowed text-white"
//               : "bg-green-600 text-white hover:bg-green-700"
//           }`}
//         >
//           {submitting ? "Sending..." : `Send to ${numbers.length} Recipient(s)`}
//         </button>
//       </div>

//       {/* üïì Recent Sent Messages */}
//       <div className="bg-white mt-6 p-4 rounded-xl shadow">
//         <h3 className="font-semibold text-lg text-gray-800 mb-4">
//           üïì Recent Sent Messages
//         </h3>
//         <div className="overflow-x-auto">
//           <table className="w-full text-sm text-left border">
//             <thead className="bg-gray-100 text-gray-700">
//               <tr>
//                 <th className="px-3 py-2">Recipient</th>
//                 <th className="px-3 py-2">Status</th>
//                 <th className="px-3 py-2">Sent At</th>
//                 <th className="px-3 py-2">Message</th>
//               </tr>
//             </thead>
//             <tbody>
//               {messageLogs.length > 0 ? (
//                 messageLogs.map(log => (
//                   <tr key={log.id} className="border-b">
//                     <td className="px-3 py-2">{log.recipientNumber}</td>
//                     <td className="px-3 py-2">
//                       <span
//                         className={`px-2 py-1 rounded-full text-xs font-medium ${
//                           log.status === "Success"
//                             ? "bg-green-100 text-green-700"
//                             : "bg-red-100 text-red-600"
//                         }`}
//                       >
//                         {log.status}
//                       </span>
//                     </td>
//                     <td className="px-3 py-2">
//                       {log.sentAt ? new Date(log.sentAt).toLocaleString() : "‚Äî"}
//                     </td>
//                     <td
//                       className="px-3 py-2 max-w-[250px] truncate"
//                       title={log.messageContent}
//                     >
//                       {log.messageContent || "(empty)"}
//                     </td>
//                   </tr>
//                 ))
//               ) : (
//                 <tr>
//                   <td colSpan="4" className="text-center text-gray-500 py-4">
//                     No messages sent yet.
//                   </td>
//                 </tr>
//               )}
//             </tbody>
//           </table>
//         </div>
//       </div>
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\WhatsAppMessageEngine\SendTemplateMessagePage.jsx 
====================================================== 
 
// üìÑ src/pages/Send/SendTemplateMessagePage.jsx
import React, { useEffect, useMemo, useState } from "react";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";
import WhatsAppBubblePreview from "../../components/WhatsAppBubblePreview";

// === Canonical providers (MUST match backend exactly) ===
const PROVIDERS = [
  { value: "PINNACLE", label: "Pinnacle (Official)" },
  { value: "META_CLOUD", label: "Meta Cloud API" },
];

// --- BusinessId helper (optional header) ---
const TOKEN_KEY = "xbyte_token";
const GUID_RE =
  /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;

function getBusinessId() {
  try {
    const saved = localStorage.getItem("business_id");
    if (saved && GUID_RE.test(saved)) return saved;

    const jwt = localStorage.getItem(TOKEN_KEY);
    if (!jwt) return null;
    const [, payloadB64] = jwt.split(".");
    if (!payloadB64) return null;
    const payload = JSON.parse(
      atob(payloadB64.replace(/-/g, "+").replace(/_/g, "/"))
    );
    const bid =
      payload?.BusinessId ||
      payload?.businessId ||
      payload?.biz ||
      payload?.bid ||
      null;
    return typeof bid === "string" && GUID_RE.test(bid) ? bid : null;
  } catch {
    return null;
  }
}

// Normalize to the two uppercase values the backend accepts
const normalizeProvider = p => {
  const up = (p ?? "").toString().trim().toUpperCase();
  if (up === "PINNACLE") return "PINNACLE";
  if (
    up === "META_CLOUD" ||
    up === "META" ||
    up === "METACLOUD" ||
    up === "META-CLOUD"
  )
    return "META_CLOUD";
  return "PINNACLE";
};

export default function SendTemplateMessagePage() {
  const [contacts, setContacts] = useState([]);
  const [selectedNumbers, setSelectedNumbers] = useState([]);
  const [templates, setTemplates] = useState([]);
  const [selectedTemplate, setSelectedTemplate] = useState(null);
  const [templateParams, setTemplateParams] = useState([]);
  const [imageUrl, setImageUrl] = useState("");
  const [submitting, setSubmitting] = useState(false);

  // Provider + senders
  const [provider, setProvider] = useState("PINNACLE");
  const [senders, setSenders] = useState([]); // [{id, phoneNumberId, wbn, isDefault}]
  const [selectedPhoneNumberId, setSelectedPhoneNumberId] = useState("");

  const businessId = useMemo(getBusinessId, []);
  const withBiz = (cfg = {}) =>
    businessId
      ? {
          ...cfg,
          headers: { ...(cfg.headers || {}), "X-Business-Id": businessId },
        }
      : cfg;

  // === Data loading ===
  useEffect(() => {
    axiosClient
      .get("/contacts", withBiz())
      .then(res => setContacts(res.data?.data?.items || []))
      .catch(() => toast.error("‚ùå Failed to load contacts"));
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  useEffect(() => {
    axiosClient
      // If your route is actually mixed-case, revert to that. Lowercase is typical.
      .get("/whatsapptemplatefetcher/get-template-all", withBiz())
      .then(res => {
        if (res.data?.success && res.data?.templates) {
          setTemplates(res.data.templates);
        } else {
          toast.error("‚ùå Template fetch failed");
        }
      })
      .catch(() => toast.error("‚ùå Error loading templates"));
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // Load numbers for current provider
  async function loadSenders(p) {
    try {
      const P = normalizeProvider(p);
      const { data } = await axiosClient.get(
        `/whatsappsettings/${P}/numbers`,
        withBiz()
      );
      const rows = Array.isArray(data) ? data : [];
      setSenders(
        rows.map(n => ({
          id: n.id,
          phoneNumberId: n.phoneNumberId || "",
          wbn: n.whatsAppBusinessNumber || "",
          isDefault: !!n.isDefault,
        }))
      );

      // pick default if current selection is not present anymore
      const stillThere = rows.some(
        n => n.phoneNumberId === selectedPhoneNumberId
      );
      if (!stillThere) {
        const def = rows.find(n => n.isDefault);
        setSelectedPhoneNumberId(def?.phoneNumberId || "");
      }
    } catch {
      setSenders([]);
      setSelectedPhoneNumberId("");
    }
  }

  useEffect(() => {
    loadSenders(provider);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [provider]);

  // === Template helpers ===
  const isImageTemplate = tpl => tpl?.hasImageHeader === true;

  const handleTemplateSelect = name => {
    const tpl = templates.find(t => t.name === name);
    setSelectedTemplate(tpl || null);
    setTemplateParams(Array(tpl?.parametersCount || 0).fill(""));
    setImageUrl("");
  };

  // === Send ===
  const handleSend = async () => {
    if (!selectedTemplate) {
      toast.warn("‚ö†Ô∏è Choose a template");
      return;
    }
    if (templateParams.some(p => !p)) {
      toast.warn("‚ö†Ô∏è Fill all template variables");
      return;
    }
    if (selectedNumbers.length === 0) {
      toast.warn("‚ö†Ô∏è Select at least one recipient");
      return;
    }

    const P = normalizeProvider(provider); // MUST be PINNACLE or META_CLOUD
    const phoneNumberId = (selectedPhoneNumberId || "").trim() || null;

    const wantsImage = selectedTemplate && isImageTemplate(selectedTemplate);
    if (wantsImage && !imageUrl.trim()) {
      toast.warn("‚ö†Ô∏è This template expects an image header URL");
      return;
    }

    setSubmitting(true);
    let success = 0,
      failed = 0;

    for (const number of selectedNumbers) {
      const basePayload = {
        RecipientNumber: number,
        TemplateName: selectedTemplate.name,
        LanguageCode: selectedTemplate.language || "en_US",
        TemplateParameters: templateParams,
        Provider: P, // ‚úÖ server expects exact uppercase
        PhoneNumberId: phoneNumberId, // optional sender override
      };

      const buttonParams = (selectedTemplate?.buttonParams || []).map(b => ({
        buttonText: b.text,
        buttonType: b.type || "quick_reply",
        targetUrl: b.payload || "",
      }));

      try {
        if (wantsImage) {
          const payload = {
            ...basePayload,
            HeaderImageUrl: imageUrl,
            ButtonParameters: buttonParams,
          };
          const res = await axiosClient.post(
            "/messageengine/send-image-template",
            payload,
            withBiz()
          );
          const ok =
            res?.data?.success === true ||
            res?.data?.isSuccess === true ||
            `${res?.data?.message || ""}`.toLowerCase().includes("success");
          ok ? success++ : failed++;
        } else {
          const payload = {
            ...basePayload,
            ButtonParameters: buttonParams, // harmless; BE can ignore for simple body-only templates
          };
          const res = await axiosClient.post(
            "/messageengine/send-template-simple",
            payload,
            withBiz()
          );
          const ok =
            res?.data?.success === true ||
            res?.data?.isSuccess === true ||
            `${res?.data?.message || ""}`.toLowerCase().includes("success");
          ok ? success++ : failed++;
        }
      } catch {
        failed++;
      }
    }

    toast.success(`‚úÖ Sent: ${success}, ‚ùå Failed: ${failed}`);
    setSubmitting(false);
  };

  return (
    <div className="p-6 max-w-6xl mx-auto space-y-8">
      <h2 className="text-2xl font-bold text-purple-700">
        Send WhatsApp Template
      </h2>

      {/* Provider + Sender selection */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label className="block font-medium mb-1 text-sm">Provider</label>
          <select
            className="w-full border p-2 rounded"
            value={provider}
            onChange={e => {
              const p = normalizeProvider(e.target.value);
              setProvider(p);
              setSelectedPhoneNumberId(""); // reset; will auto-pick default after load
            }}
          >
            {PROVIDERS.map(p => (
              <option key={p.value} value={p.value}>
                {p.label}
              </option>
            ))}
          </select>
        </div>

        <div className="md:col-span-2">
          <label className="block font-medium mb-1 text-sm">
            Sender (Phone Number ID)
          </label>
          <div className="flex gap-2">
            <select
              className="w-full border p-2 rounded"
              value={selectedPhoneNumberId}
              onChange={e => setSelectedPhoneNumberId(e.target.value)}
            >
              <option value="">‚Äî Use default (if configured) ‚Äî</option>
              {senders.map(s => (
                <option key={s.id} value={s.phoneNumberId}>
                  {s.wbn || s.phoneNumberId}
                  {s.isDefault ? " ‚Äî Default" : ""}
                </option>
              ))}
            </select>
            <button
              type="button"
              className="px-3 py-2 text-sm rounded bg-gray-100"
              onClick={() => loadSenders(provider)}
              title="Refresh senders"
            >
              Refresh
            </button>
          </div>
        </div>
      </div>

      {/* Main Section */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {/* Template Selection & Inputs */}
        <div className="space-y-4">
          <div>
            <label className="block font-medium mb-1 text-sm">
              Select Template
            </label>
            <select
              className="w-full border p-2 rounded"
              onChange={e => handleTemplateSelect(e.target.value)}
            >
              <option value="">-- Choose Template --</option>
              {templates.map(tpl => (
                <option key={tpl.name} value={tpl.name}>
                  {tpl.name} ({tpl.language}) ‚Äî {tpl.parametersCount} param
                </option>
              ))}
            </select>
          </div>

          {templateParams.length > 0 && (
            <div className="space-y-2">
              <label className="block font-medium text-sm text-gray-700">
                Template Parameters
              </label>
              {templateParams.map((val, idx) => (
                <input
                  key={idx}
                  className="w-full border p-2 rounded"
                  placeholder={`Enter value for {{${idx + 1}}}`}
                  value={val}
                  onChange={e => {
                    const copy = [...templateParams];
                    copy[idx] = e.target.value;
                    setTemplateParams(copy);
                  }}
                />
              ))}
            </div>
          )}

          {selectedTemplate && isImageTemplate(selectedTemplate) && (
            <div>
              <label className="block font-medium text-sm">Image URL</label>
              <input
                type="text"
                className="w-full p-2 border rounded"
                placeholder="https://example.com/image.jpg"
                value={imageUrl}
                onChange={e => setImageUrl(e.target.value)}
              />
            </div>
          )}
        </div>

        {/* Preview Card */}
        <div className="p-4 border rounded shadow-sm bg-white">
          <h3 className="text-sm font-semibold mb-2 text-gray-700">
            Message Preview
          </h3>
          {selectedTemplate ? (
            <WhatsAppBubblePreview
              templateBody={selectedTemplate.body}
              parameters={templateParams}
              buttonParams={selectedTemplate?.buttonParams}
              imageUrl={imageUrl}
            />
          ) : (
            <p className="text-gray-500 text-sm">No template selected</p>
          )}
        </div>
      </div>

      {/* Recipients */}
      <div className="p-4 border rounded bg-gray-50 shadow-sm">
        <h3 className="font-semibold mb-2 text-gray-700">
          Select Recipients ({selectedNumbers.length} selected)
        </h3>
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-64 overflow-y-auto">
          {contacts.map(c => (
            <label key={c.id} className="flex items-center text-sm gap-2">
              <input
                type="checkbox"
                value={c.phoneNumber}
                checked={selectedNumbers.includes(c.phoneNumber)}
                onChange={e => {
                  const value = e.target.value;
                  setSelectedNumbers(prev =>
                    e.target.checked
                      ? [...prev, value]
                      : prev.filter(n => n !== value)
                  );
                }}
              />
              {c.name} ({c.phoneNumber})
            </label>
          ))}
        </div>
      </div>

      {/* Submit Button */}
      <div className="flex justify-center">
        <button
          onClick={handleSend}
          disabled={submitting}
          className={`px-6 py-3 font-semibold rounded-xl transition duration-200 shadow-md ${
            submitting
              ? "bg-gray-400 text-white cursor-not-allowed"
              : "bg-purple-600 text-white hover:bg-purple-700"
          }`}
        >
          {submitting ? "Sending..." : "Send Template Message"}
        </button>
      </div>
    </div>
  );
}

// import React, { useEffect, useState } from "react";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import WhatsAppBubblePreview from "../../components/WhatsAppBubblePreview";

// export default function SendTemplateMessagePage() {
//   const [contacts, setContacts] = useState([]);
//   const [selectedNumbers, setSelectedNumbers] = useState([]);
//   const [templates, setTemplates] = useState([]);
//   const [selectedTemplate, setSelectedTemplate] = useState(null);
//   const [templateParams, setTemplateParams] = useState([]);
//   const [imageUrl, setImageUrl] = useState("");
//   const [submitting, setSubmitting] = useState(false);

//   useEffect(() => {
//     axiosClient
//       .get("/contacts")
//       .then(res => {
//         setContacts(res.data?.data?.items || []);
//       })
//       .catch(() => toast.error("‚ùå Failed to load contacts"));
//   }, []);

//   useEffect(() => {
//     axiosClient
//       .get("/WhatsAppTemplateFetcher/get-template-all")
//       .then(res => {
//         if (res.data.success && res.data.templates) {
//           setTemplates(res.data.templates);
//         } else {
//           toast.error("‚ùå Template fetch failed");
//         }
//       })
//       .catch(() => toast.error("‚ùå Error loading templates"));
//   }, []);

//   const isImageTemplate = tpl => tpl?.hasImageHeader === true;

//   const handleTemplateSelect = name => {
//     const tpl = templates.find(t => t.name === name);
//     setSelectedTemplate(tpl);
//     setTemplateParams(Array(tpl?.parametersCount || 0).fill(""));
//     setImageUrl("");
//   };

//   const handleSend = async () => {
//     if (!selectedTemplate || templateParams.some(p => !p)) {
//       toast.warn("‚ö†Ô∏è Fill all template variables");
//       return;
//     }
//     if (selectedNumbers.length === 0) {
//       toast.warn("‚ö†Ô∏è Select at least one recipient");
//       return;
//     }

//     setSubmitting(true);
//     let success = 0,
//       failed = 0;
//     const isImage = isImageTemplate(selectedTemplate);

//     for (const number of selectedNumbers) {
//       const payload = {
//         RecipientNumber: number,
//         TemplateName: selectedTemplate.name,
//         LanguageCode: selectedTemplate.language || "en_US",
//         HeaderImageUrl: isImage ? imageUrl : null,
//         TemplateParameters: templateParams,
//         ButtonParameters: (selectedTemplate?.buttonParams || []).map(b => ({
//           buttonText: b.text,
//           buttonType: b.type || "quick_reply",
//           targetUrl: b.payload || "",
//         })),
//       };

//       try {
//         const res = await axiosClient.post(
//           isImage
//             ? "/messageengine/send-image-template"
//             : "/messageengine/send-template-simple",
//           payload
//         );

//         const raw = res?.data;
//         const isSuccess =
//           raw?.isSuccess === true ||
//           raw?.success === true ||
//           raw?.message?.toLowerCase()?.includes("successfully");

//         isSuccess ? success++ : failed++;
//       } catch {
//         failed++;
//       }
//     }

//     toast.success(`‚úÖ Sent: ${success}, ‚ùå Failed: ${failed}`);
//     setSubmitting(false);
//   };

//   return (
//     <div className="p-6 max-w-6xl mx-auto space-y-8">
//       <h2 className="text-2xl font-bold text-purple-700">
//         Send WhatsApp Template
//       </h2>

//       {/* Main Section */}
//       <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
//         {/* Template Selection & Inputs */}
//         <div className="space-y-4">
//           <div>
//             <label className="block font-medium mb-1 text-sm">
//               Select Template
//             </label>
//             <select
//               className="w-full border p-2 rounded"
//               onChange={e => handleTemplateSelect(e.target.value)}
//             >
//               <option value="">-- Choose Template --</option>
//               {templates.map(tpl => (
//                 <option key={tpl.name} value={tpl.name}>
//                   {tpl.name} ({tpl.language}) ‚Äî {tpl.parametersCount} param
//                 </option>
//               ))}
//             </select>
//           </div>

//           {templateParams.length > 0 && (
//             <div className="space-y-2">
//               <label className="block font-medium text-sm text-gray-700">
//                 Template Parameters
//               </label>
//               {templateParams.map((val, idx) => (
//                 <input
//                   key={idx}
//                   className="w-full border p-2 rounded"
//                   placeholder={`Enter value for {{${idx + 1}}}`}
//                   value={val}
//                   onChange={e => {
//                     const copy = [...templateParams];
//                     copy[idx] = e.target.value;
//                     setTemplateParams(copy);
//                   }}
//                 />
//               ))}
//             </div>
//           )}

//           {selectedTemplate && isImageTemplate(selectedTemplate) && (
//             <div>
//               <label className="block font-medium text-sm">Image URL</label>
//               <input
//                 type="text"
//                 className="w-full p-2 border rounded"
//                 placeholder="https://example.com/image.jpg"
//                 value={imageUrl}
//                 onChange={e => setImageUrl(e.target.value)}
//               />
//             </div>
//           )}
//         </div>

//         {/* Preview Card */}
//         <div className="p-4 border rounded shadow-sm bg-white">
//           <h3 className="text-sm font-semibold mb-2 text-gray-700">
//             Message Preview
//           </h3>
//           {selectedTemplate ? (
//             <WhatsAppBubblePreview
//               templateBody={selectedTemplate.body}
//               parameters={templateParams}
//               buttonParams={selectedTemplate?.buttonParams}
//               imageUrl={imageUrl}
//             />
//           ) : (
//             <p className="text-gray-500 text-sm">No template selected</p>
//           )}
//         </div>
//       </div>

//       {/* Recipients */}
//       <div className="p-4 border rounded bg-gray-50 shadow-sm">
//         <h3 className="font-semibold mb-2 text-gray-700">
//           Select Recipients ({selectedNumbers.length} selected)
//         </h3>
//         <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-64 overflow-y-auto">
//           {contacts.map(c => (
//             <label key={c.id} className="flex items-center text-sm gap-2">
//               <input
//                 type="checkbox"
//                 value={c.phoneNumber}
//                 checked={selectedNumbers.includes(c.phoneNumber)}
//                 onChange={e => {
//                   const value = e.target.value;
//                   setSelectedNumbers(prev =>
//                     e.target.checked
//                       ? [...prev, value]
//                       : prev.filter(n => n !== value)
//                   );
//                 }}
//               />
//               {c.name} ({c.phoneNumber})
//             </label>
//           ))}
//         </div>
//       </div>

//       {/* Submit Button */}
//       <div className="flex justify-center">
//         <button
//           onClick={handleSend}
//           disabled={submitting}
//           className={`px-6 py-3 font-semibold rounded-xl transition duration-200 shadow-md ${
//             submitting
//               ? "bg-gray-400 text-white cursor-not-allowed"
//               : "bg-purple-600 text-white hover:bg-purple-700"
//           }`}
//         >
//           {submitting ? "Sending..." : "Send Template Message"}
//         </button>
//       </div>
//     </div>
//   );
// }

// import React, { useEffect, useState } from "react";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";
// import WhatsAppBubblePreview from "../../components/WhatsAppBubblePreview";

// function SendTemplateMessagePage() {
//   const [contacts, setContacts] = useState([]);
//   const [selectedNumbers, setSelectedNumbers] = useState([]);
//   const [templates, setTemplates] = useState([]);
//   const [selectedTemplate, setSelectedTemplate] = useState(null);
//   const [templateParams, setTemplateParams] = useState([]);
//   const [imageUrl, setImageUrl] = useState("");
//   const [submitting, setSubmitting] = useState(false);

//   const businessId = localStorage.getItem("businessId");

//   // üîÅ Load contacts
//   useEffect(() => {
//     const loadContacts = async () => {
//       try {
//         const res = await axiosClient.get("/contacts");
//         const contactList = res.data?.data?.items;
//         if (Array.isArray(contactList)) {
//           setContacts(contactList);
//         } else {
//           console.error("Unexpected contact response:", res.data);
//           toast.error("‚ö†Ô∏è Invalid contact data format.");
//         }
//       } catch (err) {
//         toast.error("‚ùå Failed to load contacts.");
//         console.error("Contact fetch error:", err);
//       }
//     };
//     loadContacts();
//   }, []);

//   // üîÅ Load templates
//   useEffect(() => {
//     const loadTemplates = async () => {
//       try {
//         const res = await axiosClient.get(
//           "/WhatsAppTemplateFetcher/get-template-all"
//         );
//         if (res.data.success && res.data.templates) {
//           setTemplates(res.data.templates);
//         } else {
//           toast.error("‚ùå Template fetch failed.");
//         }
//       } catch {
//         toast.error("‚ùå Error fetching templates.");
//       }
//     };
//     loadTemplates();
//   }, []);

//   // ‚úÖ Image header logic
//   const isImageTemplate = tpl => tpl?.hasImageHeader === true;

//   const handleTemplateSelect = name => {
//     const tpl = templates.find(t => t.name === name);
//     setSelectedTemplate(tpl);
//     setTemplateParams(Array(tpl?.parametersCount || 0).fill(""));
//     setImageUrl(""); // reset
//   };

//   const handleSend = async () => {
//     if (!selectedTemplate || templateParams.some(p => !p)) {
//       toast.warn("‚ö†Ô∏è Please select a template and fill all variables.");
//       return;
//     }

//     if (selectedNumbers.length === 0) {
//       toast.warn("‚ö†Ô∏è Select at least one recipient.");
//       return;
//     }

//     setSubmitting(true);
//     let success = 0;
//     let failed = 0;
//     const imageTemplate = isImageTemplate(selectedTemplate);

//     for (const number of selectedNumbers) {
//       const payload = {
//         RecipientNumber: number,
//         TemplateName: selectedTemplate.name,
//         LanguageCode: selectedTemplate?.language || "en_US",
//         HeaderImageUrl: imageTemplate ? imageUrl : null,
//         TemplateParameters: templateParams,
//         ButtonParameters: (selectedTemplate?.buttonParams || []).map(b => ({
//           buttonText: b.text,
//           buttonType: b.type || "quick_reply",
//           targetUrl: b.payload || "",
//         })),
//       };

//       try {
//         const res = await axiosClient.post(
//           imageTemplate
//             ? "/messageengine/send-image-template"
//             : "/messageengine/send-template-simple",
//           payload
//         );

//         const raw = res?.data;
//         const isSuccess =
//           raw?.isSuccess === true ||
//           raw?.success === true ||
//           raw?.message?.toLowerCase()?.includes("successfully");

//         if (isSuccess) {
//           success++;
//         } else {
//           failed++;
//           console.warn("‚ö†Ô∏è Unexpected response:", raw);
//         }
//       } catch (err) {
//         failed++;
//         console.error("‚ùå Axios error:", err);
//       }
//     }

//     toast.success(`‚úÖ Sent: ${success}, ‚ùå Failed: ${failed}`);
//     setSubmitting(false);
//   };

//   return (
//     <div className="max-w-3xl mx-auto p-6 space-y-6">
//       <h2 className="text-xl font-bold text-purple-700">
//         Send WhatsApp Template Message
//       </h2>

//       <div>
//         <label className="font-semibold">Select Template</label>
//         <select
//           className="w-full border p-2 rounded"
//           onChange={e => handleTemplateSelect(e.target.value)}
//         >
//           <option value="">-- Choose Template --</option>
//           {templates.map(tpl => (
//             <option key={tpl.name} value={tpl.name}>
//               {tpl.name} ({tpl.language}) ‚Äî {tpl.parametersCount} param
//             </option>
//           ))}
//         </select>
//       </div>

//       {templateParams.length > 0 && (
//         <div className="space-y-3 border p-4 rounded bg-gray-50">
//           <h3 className="font-semibold text-sm text-gray-700">
//             Template Parameters
//           </h3>
//           {templateParams.map((val, idx) => (
//             <input
//               key={idx}
//               className="w-full p-2 border rounded"
//               placeholder={`Enter value for {{${idx + 1}}}`}
//               value={val}
//               onChange={e => {
//                 const updated = [...templateParams];
//                 updated[idx] = e.target.value;
//                 setTemplateParams(updated);
//               }}
//             />
//           ))}
//         </div>
//       )}

//       {selectedTemplate && isImageTemplate(selectedTemplate) && (
//         <div>
//           <label className="font-semibold text-sm text-gray-700">
//             Image URL
//           </label>
//           <input
//             type="text"
//             className="w-full p-2 border rounded mt-1"
//             placeholder="https://example.com/image.jpg"
//             value={imageUrl}
//             onChange={e => setImageUrl(e.target.value)}
//           />
//         </div>
//       )}

//       {selectedTemplate && (
//         <WhatsAppBubblePreview
//           templateBody={selectedTemplate?.body}
//           parameters={templateParams}
//           buttonParams={selectedTemplate?.buttonParams}
//           imageUrl={imageUrl}
//         />
//       )}

//       <div className="border rounded p-3">
//         <label className="block font-semibold text-gray-700 mb-2">
//           Select Recipients:
//         </label>
//         <div className="max-h-52 overflow-y-auto space-y-1">
//           {contacts.map(contact => (
//             <div key={contact.id} className="flex items-center gap-2">
//               <input
//                 type="checkbox"
//                 value={contact.phoneNumber}
//                 checked={selectedNumbers.includes(contact.phoneNumber)}
//                 onChange={e => {
//                   const val = e.target.value;
//                   setSelectedNumbers(prev =>
//                     e.target.checked
//                       ? [...prev, val]
//                       : prev.filter(n => n !== val)
//                   );
//                 }}
//               />
//               <label className="text-sm">
//                 {contact.name} ({contact.phoneNumber})
//               </label>
//             </div>
//           ))}
//         </div>
//       </div>

//       <button
//         onClick={handleSend}
//         disabled={submitting}
//         className={`w-full py-3 font-semibold rounded transition ${
//           submitting
//             ? "bg-gray-400 text-white"
//             : "bg-purple-600 text-white hover:bg-purple-700"
//         }`}
//       >
//         {submitting ? "Sending..." : "Send Template Message"}
//       </button>
//     </div>
//   );
// }

// export default SendTemplateMessagePage;
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\WhatsAppSettings\WhatsAppSettings.jsx 
====================================================== 
 
// üìÑ src/pages/Settings/WhatsAppSettings.jsx
import React, { useState, useEffect, useMemo } from "react";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";

// === Canonical providers (MUST match backend exactly) ===
const PROVIDERS = [
  { value: "PINNACLE", label: "PINNACLE" },
  { value: "META_CLOUD", label: "META_CLOUD" },
];

// --- BusinessId helper (used only as a sanity check / legacy headers) ---
const TOKEN_KEY = "xbyte_token";
const GUID_RE =
  /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;

function getBusinessId() {
  try {
    const saved = localStorage.getItem("business_id");
    if (saved && GUID_RE.test(saved)) return saved;

    const jwt = localStorage.getItem(TOKEN_KEY);
    if (!jwt) return null;

    const [, payloadB64] = jwt.split(".");
    if (!payloadB64) return null;

    const payload = JSON.parse(
      atob(payloadB64.replace(/-/g, "+").replace(/_/g, "/"))
    );

    const bid =
      payload?.BusinessId ||
      payload?.businessId ||
      payload?.biz ||
      payload?.bid ||
      null;

    return typeof bid === "string" && GUID_RE.test(bid) ? bid : null;
  } catch {
    return null;
  }
}

// Normalize provider names
const normalizeProvider = p => {
  const raw = (p ?? "").toString().trim();
  if (!raw) return "PINNACLE";
  const up = raw.toUpperCase();
  if (up === "PINNACLE") return "PINNACLE";
  if (
    up === "META_CLOUD" ||
    up === "META" ||
    up === "METACLOUD" ||
    up === "META-CLOUD"
  ) {
    return "META_CLOUD";
  }
  return "PINNACLE";
};

// UI label per provider (still binds to apiKey field)
const secretLabelFor = provider =>
  normalizeProvider(provider) === "PINNACLE" ? "API Key" : "Token";

// Initial blank global settings
const blank = {
  provider: "PINNACLE",
  apiUrl: "",
  apiKey: "",
  wabaId: "",
  senderDisplayName: "",
  webhookSecret: "",
  webhookVerifyToken: "",
  webhookCallbackUrl: "",
  isActive: true,
};

export default function WhatsAppSettings() {
  const [formData, setFormData] = useState(blank);
  const [loading, setLoading] = useState(false);
  const [saving, setSaving] = useState(false);
  const [testing, setTesting] = useState(false);
  const [testResult, setTestResult] = useState("");
  const [senders, setSenders] = useState([]);
  const [fetchingMeta, setFetchingMeta] = useState(false);
  const [hasSavedOnce, setHasSavedOnce] = useState(false);
  const [savedProvider, setSavedProvider] = useState(null);

  // ESU status (normalized)
  const [esuStatus, setEsuStatus] = useState({
    loading: true,
    hasEsuFlag: false,
    hasValidToken: false,
    willExpireSoon: false,
    tokenExpiresAtUtc: null,
    isConfiguredViaEsu: false,
    isTokenExpiredOrInvalid: false,
    isTokenExpiringSoon: false,
    isFullyHealthy: false,
    phoneCount: 0,
    hasWaba: false,
    debug: null,
  });

  const [connectingEsu, setConnectingEsu] = useState(false);

  const businessId = useMemo(getBusinessId, []);
  const hasBusinessContext = !!businessId;

  const withBiz = (cfg = {}) =>
    businessId
      ? {
          ...cfg,
          headers: { ...(cfg.headers || {}), "X-Business-Id": businessId },
        }
      : cfg;

  // ===== Numbers API helpers =====
  const listNumbers = async provider => {
    const p = normalizeProvider(provider);
    const { data } = await axiosClient.get(
      `/whatsappsettings/${p}/numbers`,
      withBiz()
    );
    return Array.isArray(data) ? data : [];
  };

  const upsertNumber = async (provider, row) => {
    const p = normalizeProvider(provider);
    const payload = {
      phoneNumberId: (row.phoneNumberId || "").trim(),
      whatsAppBusinessNumber: (row.whatsAppBusinessNumber || "").trim(),
      senderDisplayName: (row.label || row.senderDisplayName || "").trim(),
      isActive: row.isActive ?? true,
      isDefault: !!row.isDefault,
    };
    const { data } = await axiosClient.post(
      `/whatsappsettings/${p}/numbers`,
      payload,
      withBiz()
    );
    return data;
  };

  const deleteNumber = async (provider, id) => {
    const p = normalizeProvider(provider);
    await axiosClient.delete(`/whatsappsettings/${p}/numbers/${id}`, withBiz());
  };

  const setDefaultNumber = async (provider, id) => {
    const p = normalizeProvider(provider);
    await axiosClient.patch(
      `/whatsappsettings/${p}/numbers/${id}/default`,
      null,
      withBiz()
    );
  };

  const fetchNumbers = async provider => {
    try {
      const items = await listNumbers(provider);
      setSenders(
        items.map(n => ({
          id: n.id,
          label: n.senderDisplayName || "",
          phoneNumberId: n.phoneNumberId || "",
          whatsAppBusinessNumber: n.whatsAppBusinessNumber || "",
          isDefault: !!n.isDefault,
          isActive: n.isActive ?? true,
        }))
      );
    } catch {
      setSenders([]);
    }
  };

  // ===== Derived UI =====
  const providerLabel = useMemo(
    () => secretLabelFor(formData.provider),
    [formData.provider]
  );
  const selectedProvider = useMemo(
    () => normalizeProvider(formData.provider),
    [formData.provider]
  );
  const showFetchButton = hasSavedOnce;

  // ===== ESU: load connection status (JWT-based) =====
  useEffect(() => {
    const loadStatus = async () => {
      try {
        setEsuStatus(s => ({ ...s, loading: true }));

        // Backend: GET /api/esu/facebook/status (uses JWT for businessId)
        const res = await axiosClient.get("esu/facebook/status");
        const payload = res?.data ?? {};
        const dto = payload?.data || payload?.Data || payload || {};

        const hasEsuFlag =
          dto.hasEsuFlag ?? dto.HasEsuFlag ?? dto.facebookEsuCompleted ?? false;

        const tokenExpiresAtUtc =
          dto.tokenExpiresAtUtc ?? dto.TokenExpiresAtUtc ?? null;

        const hasValidToken =
          dto.hasValidToken ??
          dto.HasValidToken ??
          (tokenExpiresAtUtc ? true : false);

        const willExpireSoon =
          dto.willExpireSoon ??
          dto.WillExpireSoon ??
          dto.isExpiringSoon ??
          dto.IsExpiringSoon ??
          false;

        const isConfiguredViaEsu = !!hasEsuFlag;
        const isTokenExpiredOrInvalid = isConfiguredViaEsu && !hasValidToken;
        const isTokenExpiringSoon = !!hasValidToken && willExpireSoon;
        const isFullyHealthy =
          isConfiguredViaEsu && hasValidToken && !willExpireSoon;

        const phoneCount = dto.phoneCount || dto.numbersCount || 0;
        const hasWaba = !!(dto.wabaId || dto.WabaId);
        const debug = dto.debug ?? dto.Debug ?? null;

        setEsuStatus({
          loading: false,
          hasEsuFlag,
          hasValidToken,
          willExpireSoon,
          tokenExpiresAtUtc,
          isConfiguredViaEsu,
          isTokenExpiredOrInvalid,
          isTokenExpiringSoon,
          isFullyHealthy,
          phoneCount,
          hasWaba,
          debug,
        });
      } catch (err) {
        console.error("Unable to load Meta ESU status", err);
        setEsuStatus({
          loading: false,
          hasEsuFlag: false,
          hasValidToken: false,
          willExpireSoon: false,
          tokenExpiresAtUtc: null,
          isConfiguredViaEsu: false,
          isTokenExpiredOrInvalid: false,
          isTokenExpiringSoon: false,
          isFullyHealthy: false,
          phoneCount: 0,
          hasWaba: false,
          debug: "status-error",
        });
      }
    };

    loadStatus();
  }, []);
  // ===== Initial load of saved settings + numbers =====
  useEffect(() => {
    let mounted = true;

    (async () => {
      try {
        setLoading(true);

        const res = await axiosClient.get("/whatsappsettings/me", withBiz());
        if (!mounted) return;

        const body = res?.data || {};

        // Support both:
        // 1) New shape: { ok, hasSettings, data }
        // 2) Legacy shape: settings object directly
        const hasSettingsFlag =
          typeof body.hasSettings === "boolean" ? body.hasSettings : undefined;

        const settings =
          hasSettingsFlag === false
            ? null
            : body.data !== undefined
            ? body.data
            : body;

        // No settings configured yet (expected state)
        if (!settings || Object.keys(settings).length === 0) {
          // UX hint (safe even if removed later; logic below still holds)
          toast.info("‚ÑπÔ∏è No WhatsApp settings found. You can create them now.");
          setHasSavedOnce(false);
          setSavedProvider(null);
          setSenders([]);
          return;
        }

        const provider = normalizeProvider(settings.provider);
        const secret = settings.apiKey || settings.apiToken || "";

        setFormData(prev => ({
          ...prev,
          provider,
          apiUrl: settings.apiUrl || "",
          apiKey: secret,
          wabaId: settings.wabaId || "",
          senderDisplayName: settings.senderDisplayName || "",
          webhookSecret: settings.webhookSecret || "",
          webhookVerifyToken: settings.webhookVerifyToken || "",
          webhookCallbackUrl: settings.webhookCallbackUrl || "",
          isActive: settings.isActive ?? true,
        }));

        setSavedProvider(provider);

        const existed =
          !!settings.provider ||
          !!settings.apiKey ||
          !!settings.apiToken ||
          !!settings.wabaId;
        setHasSavedOnce(!!existed);

        await fetchNumbers(provider);
      } catch (err) {
        // Real errors (network, 500, etc.) will already be surfaced
        // by the global axiosClient interceptor.
        if (process.env.NODE_ENV !== "production") {
          // eslint-disable-next-line no-console
          console.error("Failed to load WhatsApp settings", err);
        }
        setHasSavedOnce(false);
        setSavedProvider(null);
      } finally {
        if (mounted) setLoading(false);
      }
    })();

    return () => {
      mounted = false;
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // // ===== Initial load of saved settings + numbers =====
  // useEffect(() => {
  //   let mounted = true;
  //   (async () => {
  //     try {
  //       setLoading(true);
  //       const res = await axiosClient.get("/whatsappsettings/me", withBiz());
  //       if (!mounted) return;
  //       const data = res?.data ?? {};

  //       const provider = normalizeProvider(data?.provider);
  //       const secret = data?.apiKey || data?.apiToken || "";

  //       setFormData(prev => ({
  //         ...prev,
  //         provider,
  //         apiUrl: data?.apiUrl || "",
  //         apiKey: secret,
  //         wabaId: data?.wabaId || "",
  //         senderDisplayName: data?.senderDisplayName || "",
  //         webhookSecret: data?.webhookSecret || "",
  //         webhookVerifyToken: data?.webhookVerifyToken || "",
  //         webhookCallbackUrl: data?.webhookCallbackUrl || "",
  //         isActive: data?.isActive ?? true,
  //       }));

  //       setSavedProvider(provider);

  //       const existed =
  //         !!data?.provider ||
  //         !!data?.apiKey ||
  //         !!data?.apiToken ||
  //         !!data?.wabaId;
  //       setHasSavedOnce(!!existed);

  //       await fetchNumbers(provider);
  //     } catch {
  //       toast.info("‚ÑπÔ∏è No WhatsApp settings found. You can create them now.");
  //       setHasSavedOnce(false);
  //       setSavedProvider(null);
  //     } finally {
  //       mounted && setLoading(false);
  //     }
  //   })();

  //   return () => {
  //     mounted = false;
  //   };
  //   // eslint-disable-next-line react-hooks/exhaustive-deps
  // }, []);

  // Refresh numbers when dropdown provider changes
  useEffect(() => {
    fetchNumbers(formData.provider);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [formData.provider]);

  // Auto-fetch numbers when redirected with ?connected=1 after ESU flow
  useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    if (params.get("connected") === "1") {
      (async () => {
        try {
          await handleFetchFromMeta();
          toast.success("Meta connection completed. Numbers synced.");
        } finally {
          const url = new URL(window.location.href);
          url.searchParams.delete("connected");
          window.history.replaceState({}, "", url.toString());
        }
      })();
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // ===== Local sender mutations =====
  const addSender = () =>
    setSenders(s => [
      ...s,
      {
        label: "",
        phoneNumberId: "",
        whatsAppBusinessNumber: "",
        isDefault: s.length === 0,
        isActive: true,
      },
    ]);

  const removeSender = idx => setSenders(s => s.filter((_, i) => i !== idx));

  const updateSender = (idx, key, value) =>
    setSenders(s =>
      s.map((row, i) => (i === idx ? { ...row, [key]: value } : row))
    );

  const setDefaultSenderLocal = idx =>
    setSenders(s => s.map((row, i) => ({ ...row, isDefault: i === idx })));

  // ===== Global form handlers =====
  const handleChange = e => {
    const { name, value } = e.target;
    setFormData(p => ({ ...p, [name]: value }));
  };

  const handleToggle = e => {
    const { name, checked } = e.target;
    setFormData(p => ({ ...p, [name]: checked }));
  };

  const handleProviderChange = e => {
    const provider = normalizeProvider(e.target.value);
    setFormData(p => ({ ...p, provider }));
  };

  // ===== Save global settings =====
  const validateBeforeSave = () => {
    if (!formData.apiKey.trim()) {
      toast.error("API Key / Token is required.");
      return false;
    }
    return true;
  };

  const handleSaveGlobal = async () => {
    if (!validateBeforeSave()) return;
    try {
      setSaving(true);
      const payload = {
        provider: normalizeProvider(formData.provider),
        apiUrl: (formData.apiUrl || "").trim(),
        apiKey: (formData.apiKey || "").trim(),
        wabaId: (formData.wabaId || "").trim() || null,
        senderDisplayName: (formData.senderDisplayName || "").trim() || null,
        webhookSecret: (formData.webhookSecret || "").trim() || null,
        webhookVerifyToken: (formData.webhookVerifyToken || "").trim() || null,
        webhookCallbackUrl: (formData.webhookCallbackUrl || "").trim() || null,
        isActive: !!formData.isActive,
      };

      await axiosClient.put("/whatsappsettings/update", payload, withBiz());

      setHasSavedOnce(true);
      setSavedProvider(payload.provider);

      toast.success("Settings saved.");
    } catch (err) {
      toast.error(err?.response?.data?.message || "Failed to save settings.");
    } finally {
      setSaving(false);
    }
  };

  // ===== Test connection using backend "current" settings =====
  const handleTest = async () => {
    setTesting(true);
    setTestResult("");
    try {
      const res = await axiosClient.post(
        "/whatsappsettings/test-connection/current",
        {},
        withBiz()
      );
      setTestResult(JSON.stringify(res?.data ?? {}, null, 2));
      toast.success(res?.data?.message || "Connection test complete.");
    } catch (err) {
      setTestResult(
        JSON.stringify(err?.response?.data ?? { error: String(err) }, null, 2)
      );
      toast.error(err?.response?.data?.message || "Connection test failed.");
    } finally {
      setTesting(false);
    }
  };

  // ===== ESU: start Embedded Signup / Refresh Token from Settings page =====
  const startFacebookEsu = async () => {
    if (!hasBusinessContext) {
      toast.error("Business context missing. Please re-login.");
      return;
    }

    try {
      setConnectingEsu(true);

      const returnUrlAfterSuccess = "/app/settings/whatsapp";

      // JWT-based; no X-Business-Id here
      const res = await axiosClient.post("esu/facebook/start", {
        returnUrlAfterSuccess,
      });

      const authUrl =
        res?.data?.data?.authUrl ||
        res?.data?.authUrl ||
        res?.data?.url ||
        res?.data?.Data?.AuthUrl;

      if (!authUrl) {
        toast.error(
          res?.data?.message || "Could not get Meta Embedded Signup URL."
        );
        return;
      }

      window.location.href = authUrl;
    } catch (err) {
      toast.error(
        err?.response?.data?.message ||
          err?.message ||
          "Failed to start Meta Embedded Signup."
      );
    } finally {
      setConnectingEsu(false);
    }
  };

  // ===== Fetch numbers via backend sync =====
  const handleFetchFromMeta = async () => {
    if (!formData.apiKey?.trim() || !formData.wabaId?.trim()) {
      toast.warn(
        "Please provide API Key/Token and WABA ID, then Save Settings."
      );
      return;
    }
    try {
      setFetchingMeta(true);
      const res = await axiosClient.post(
        "/whatsappsettings/fetch-numbers",
        {},
        withBiz()
      );

      const serverBucket = normalizeProvider(res?.data?.provider);
      const fallbackBucket = savedProvider || selectedProvider;
      const bucket = serverBucket || fallbackBucket;

      await fetchNumbers(bucket);

      if (bucket && bucket !== selectedProvider) {
        setFormData(p => ({ ...p, provider: bucket }));
      }

      const { added = 0, updated = 0, total = 0 } = res?.data || {};
      toast.success(
        `Synced ‚Äî added ${added}, updated ${updated}, total ${total} (${bucket}).`
      );
    } catch (err) {
      const msg =
        err?.response?.data?.message || err?.message || "Fetch failed.";
      toast.error(msg);
    } finally {
      setFetchingMeta(false);
    }
  };

  // ===== Connection Status card UI (ESU-aware) =====
  const renderConnectionStatus = () => {
    const {
      loading,
      isConfiguredViaEsu,
      isTokenExpiredOrInvalid,
      isTokenExpiringSoon,
      isFullyHealthy,
      phoneCount,
      hasWaba,
      tokenExpiresAtUtc,
      debug,
    } = esuStatus;

    const formattedExpiry = tokenExpiresAtUtc
      ? new Date(tokenExpiresAtUtc).toLocaleString()
      : null;

    if (loading) {
      return (
        <div className="mb-4 rounded-xl bg-slate-50 border border-slate-200 px-4 py-3 text-sm text-slate-600">
          Checking Meta connection status‚Ä¶
        </div>
      );
    }

    // Not configured via ESU at all
    if (!isConfiguredViaEsu) {
      return (
        <div className="mb-5 rounded-2xl border border-red-100 bg-red-50/70 shadow-sm overflow-hidden">
          <div className="px-4 py-2 bg-red-50 border-b border-red-100 flex items-center gap-2">
            <span className="text-[10px] uppercase tracking-wide text-slate-500">
              Connection Status
            </span>
          </div>
          <div className="px-4 py-3 flex items-start gap-3">
            <span className="mt-1 w-3 h-3 inline-block rounded-full bg-red-500" />
            <div>
              <div className="font-semibold text-red-600 mb-0.5">
                Not connected
              </div>
              <p className="text-xs text-slate-600 mb-2">
                WhatsApp Business Account <strong>Disconnected</strong>. Connect
                your WhatsApp Business Account via Facebook.
              </p>
              <button
                type="button"
                onClick={startFacebookEsu}
                disabled={connectingEsu || !hasBusinessContext}
                className="inline-flex items-center gap-2 px-3 py-1.5 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-semibold disabled:opacity-60"
              >
                {connectingEsu
                  ? "Opening Embedded Signup‚Ä¶"
                  : "Connect via Facebook"}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Configured via ESU ‚Üí green base; token health as secondary
    return (
      <div className="mb-5 rounded-2xl border border-emerald-100 bg-emerald-50/70 shadow-sm overflow-hidden">
        <div className="px-4 py-2 bg-emerald-50 border-b border-emerald-100 flex items-center justify-between">
          <span className="text-[10px] uppercase tracking-wide text-slate-500">
            Connection Status
          </span>
          <span className="text-[10px] text-emerald-700">
            Via Meta Embedded Signup
          </span>
        </div>
        <div className="px-4 py-3 flex items-start gap-3">
          <span className="mt-1 w-3 h-3 inline-block rounded-full bg-emerald-500" />
          <div>
            <div className="font-semibold text-emerald-700 mb-0.5">
              Connected via Meta Embedded Signup
            </div>

            {isFullyHealthy && (
              <p className="text-xs text-slate-700">
                WhatsApp API is configured and active for this workspace
                {phoneCount
                  ? ` ¬∑ ${phoneCount} phone${phoneCount > 1 ? "s" : ""} synced`
                  : ""}
                {hasWaba ? " ¬∑ WABA configured" : ""}.
              </p>
            )}

            {isTokenExpiredOrInvalid && (
              <div className="mt-1 text-xs text-rose-700 bg-rose-50 border border-rose-200 px-3 py-2 rounded-md">
                <span className="font-semibold">Token expired:</span> Your Meta
                access token is no longer valid. Use{" "}
                <span className="font-semibold">‚ÄúRefresh Token‚Äù</span> below to
                securely generate a new long-lived token.
              </div>
            )}

            {isTokenExpiringSoon && (
              <div className="mt-1 text-xs text-amber-700 bg-amber-50 border border-amber-200 px-3 py-2 rounded-md">
                Your Meta access token will expire soon. Use{" "}
                <span className="font-semibold">‚ÄúRefresh Token‚Äù</span> to renew
                it and avoid interruptions.
              </div>
            )}

            {formattedExpiry && (
              <div className="mt-1 text-[10px] text-slate-500">
                Token expiry: {formattedExpiry}
              </div>
            )}

            {(debug || process.env.NODE_ENV === "development") && debug && (
              <div className="mt-1 text-[9px] text-slate-500">
                Debug: {debug}
              </div>
            )}

            <div className="mt-2 flex flex-col gap-1">
              <button
                type="button"
                onClick={startFacebookEsu}
                disabled={connectingEsu || !hasBusinessContext}
                className="inline-flex items-center gap-2 px-3 py-1.5 rounded-md bg-emerald-600 text-white border border-emerald-600 text-xs font-semibold hover:bg-emerald-700 disabled:opacity-60"
              >
                {connectingEsu
                  ? "Opening Embedded Signup‚Ä¶"
                  : isTokenExpiredOrInvalid || isTokenExpiringSoon
                  ? "Refresh Token"
                  : "Manage Connection"}
              </button>

              {(isTokenExpiredOrInvalid || isTokenExpiringSoon) && (
                <div className="text-[10px] text-slate-600">
                  Clicking <strong>‚ÄúRefresh Token‚Äù</strong> will reopen Meta
                  Embedded Signup and update your WhatsApp access token without
                  extra manual configuration.
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    );
  };

  // ===== Render =====
  return (
    <div className="max-w-5xl mx-auto px-4 py-6">
      <div className="flex items-center justify-between mb-3">
        <h1 className="text-xl font-semibold text-slate-900">
          WhatsApp Settings
        </h1>

        <div className="flex gap-2">
          <button
            type="button"
            onClick={handleSaveGlobal}
            disabled={saving}
            className={`px-4 py-2 rounded-md text-sm ${
              saving
                ? "bg-gray-300 text-gray-600"
                : "bg-emerald-600 hover:bg-emerald-700 text-white"
            }`}
          >
            {saving ? "Saving‚Ä¶" : "Save Settings"}
          </button>

          <button
            type="button"
            onClick={handleTest}
            disabled={testing}
            className={`px-4 py-2 rounded-md text-sm ${
              testing
                ? "bg-gray-200 text-gray-500"
                : "bg-white border border-gray-300 text-gray-700 hover:bg-gray-50"
            }`}
          >
            {testing ? "Testing‚Ä¶" : "Test Connection"}
          </button>
        </div>
      </div>

      {renderConnectionStatus()}

      {loading && (
        <div className="text-xs text-gray-500 mb-4">Loading settings‚Ä¶</div>
      )}

      {/* GLOBAL provider-level settings */}
      <div className="grid grid-cols-1 md:grid-cols-12 gap-4">
        <div className="md:col-span-4">
          <label className="text-xs text-gray-600 block mb-1">Provider</label>
          <select
            name="provider"
            value={normalizeProvider(formData.provider)}
            onChange={handleProviderChange}
            className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
          >
            {PROVIDERS.map(p => (
              <option key={p.value} value={p.value}>
                {p.label}
              </option>
            ))}
          </select>
        </div>

        <div className="md:col-span-4">
          <label className="text-xs text-gray-600 block mb-1">
            API URL (optional)
          </label>
          <input
            type="text"
            name="apiUrl"
            value={formData.apiUrl}
            onChange={handleChange}
            placeholder="https://graph.facebook.com/v20.0 or provider URL"
            className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
          />
        </div>

        <div className="md:col-span-4">
          <label className="text-xs text-gray-600 block mb-1">
            {providerLabel}
          </label>
          <input
            type="text"
            name="apiKey"
            value={formData.apiKey}
            onChange={handleChange}
            placeholder={providerLabel}
            className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
          />
        </div>

        <div className="md:col-span-4">
          <label className="text-xs text-gray-600 block mb-1">
            WABA ID (Meta only)
          </label>
          <input
            type="text"
            name="wabaId"
            value={formData.wabaId}
            onChange={handleChange}
            placeholder="e.g. 123456789012345"
            className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
          />
        </div>

        <div className="md:col-span-4">
          <label className="text-xs text-gray-600 block mb-1">
            Sender Display Name (optional)
          </label>
          <input
            type="text"
            name="senderDisplayName"
            value={formData.senderDisplayName}
            onChange={handleChange}
            placeholder="e.g. Acme Support"
            className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
          />
        </div>

        <div className="md:col-span-4">
          <label className="text-xs text-gray-600 block mb-1">
            Webhook Verify Token
          </label>
          <input
            type="text"
            name="webhookVerifyToken"
            value={formData.webhookVerifyToken}
            onChange={handleChange}
            placeholder="verify-token"
            className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
          />
        </div>

        <div className="md:col-span-4">
          <label className="text-xs text-gray-600 block mb-1">
            Webhook Secret
          </label>
          <input
            type="text"
            name="webhookSecret"
            value={formData.webhookSecret}
            onChange={handleChange}
            placeholder="secret"
            className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
          />
        </div>

        <div className="md:col-span-8">
          <label className="text-xs text-gray-600 block mb-1">
            Webhook Callback URL
          </label>
          <input
            type="text"
            name="webhookCallbackUrl"
            value={formData.webhookCallbackUrl}
            onChange={handleChange}
            placeholder="https://example.com/api/webhooks/whatsapp"
            className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
          />
        </div>

        <div className="md:col-span-4 flex items-end">
          <label className="inline-flex items-center gap-2 text-sm text-gray-700">
            <input
              type="checkbox"
              name="isActive"
              checked={!!formData.isActive}
              onChange={handleToggle}
              className="h-4 w-4"
            />
            Active
          </label>
        </div>
      </div>

      {/* SENDERS */}
      <div className="mt-8 border-t pt-6">
        <div className="flex items-center justify-between mb-3">
          <h3 className="text-sm font-semibold text-gray-700">
            Senders (phone numbers)
          </h3>

          <div className="flex gap-2">
            {showFetchButton && (
              <button
                type="button"
                onClick={handleFetchFromMeta}
                disabled={fetchingMeta}
                className={`px-3 py-1.5 rounded-md text-sm ${
                  fetchingMeta
                    ? "bg-gray-200 text-gray-500"
                    : "bg-emerald-600 text-white hover:bg-emerald-700"
                }`}
              >
                {fetchingMeta ? "Fetching‚Ä¶" : "Fetch from Meta"}
              </button>
            )}
            <button
              type="button"
              onClick={addSender}
              className="px-3 py-1.5 rounded-md text-sm bg-gray-100 hover:bg-gray-200"
            >
              + Add number
            </button>
          </div>
        </div>

        {senders.length === 0 && (
          <div className="text-xs text-gray-500 mb-2">
            No senders yet. Use <b>Fetch from Meta</b> after connecting, or{" "}
            <b>+ Add number</b> to configure manually.
          </div>
        )}

        <div className="space-y-3">
          {senders.map((row, idx) => (
            <div
              key={idx}
              className="grid grid-cols-1 md:grid-cols-12 gap-3 bg-gray-50 p-3 rounded"
            >
              <div className="md:col-span-3">
                <label className="text-xs text-gray-600 block mb-1">
                  Label (optional)
                </label>
                <input
                  type="text"
                  value={row.label || ""}
                  onChange={e => updateSender(idx, "label", e.target.value)}
                  placeholder="e.g. Sales India"
                  className="w-full px-3 py-1.5 border rounded-md text-sm border-gray-300"
                />
              </div>

              <div className="md:col-span-4">
                <label className="text-xs text-gray-600 block mb-1">
                  WhatsApp Business Number
                </label>
                <input
                  type="text"
                  value={row.whatsAppBusinessNumber || ""}
                  onChange={e =>
                    updateSender(idx, "whatsAppBusinessNumber", e.target.value)
                  }
                  placeholder="+14150000001"
                  className="w-full px-3 py-1.5 border rounded-md text-sm border-gray-300"
                />
              </div>

              <div className="md:col-span-4">
                <label className="text-xs text-gray-600 block mb-1">
                  Phone Number ID
                </label>
                <input
                  type="text"
                  value={row.phoneNumberId || ""}
                  onChange={e =>
                    updateSender(idx, "phoneNumberId", e.target.value)
                  }
                  placeholder="1234567890"
                  className="w-full px-3 py-1.5 border rounded-md text-sm border-gray-300"
                />
              </div>

              <div className="md:col-span-1 flex items-end gap-2 flex-wrap">
                <button
                  type="button"
                  onClick={async () => {
                    try {
                      const saved = await upsertNumber(formData.provider, row);
                      setSenders(s =>
                        s.map((r, i) =>
                          i === idx ? { ...r, id: saved?.id || r.id } : r
                        )
                      );
                      toast.success("Sender saved.");
                    } catch {
                      toast.error("Save failed.");
                    }
                  }}
                  className="px-2 py-1 rounded text-xs bg-blue-600 text-white"
                >
                  Save
                </button>

                <button
                  type="button"
                  onClick={async () => {
                    try {
                      if (!row.id) {
                        removeSender(idx);
                        return;
                      }
                      await deleteNumber(formData.provider, row.id);
                      removeSender(idx);
                      toast.success("Sender deleted.");
                    } catch {
                      toast.error("Delete failed.");
                    }
                  }}
                  className="px-2 py-1 rounded text-xs bg-red-50 text-red-700"
                >
                  ‚úï
                </button>

                <button
                  type="button"
                  onClick={async () => {
                    try {
                      if (!row.id) {
                        const saved = await upsertNumber(
                          formData.provider,
                          row
                        );
                        await setDefaultNumber(formData.provider, saved?.id);
                      } else {
                        await setDefaultNumber(formData.provider, row.id);
                      }
                      setDefaultSenderLocal(idx);
                      toast.success("Default sender set.");
                    } catch {
                      toast.error("Failed to set default.");
                    }
                  }}
                  className={`px-2 py-1 rounded text-xs ${
                    row.isDefault
                      ? "bg-emerald-600 text-white"
                      : "bg-gray-200 text-gray-800"
                  }`}
                >
                  {row.isDefault ? "Default" : "Make default"}
                </button>
              </div>
            </div>
          ))}
        </div>

        <p className="text-[11px] text-gray-500 mt-2">
          The <b>Default</b> sender will be used when no phone is chosen
          explicitly while sending.
        </p>
      </div>

      {testResult && (
        <div className="mt-6">
          <label className="text-xs text-gray-600 block mb-1">
            Test Result
          </label>
          <pre className="text-xs bg-gray-50 border border-gray-200 p-3 rounded overflow-auto">
            {testResult}
          </pre>
        </div>
      )}
    </div>
  );
}

// // üìÑ src/pages/Settings/WhatsAppSettings.jsx
// import React, { useState, useEffect, useMemo } from "react";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";

// // === Canonical providers (MUST match backend exactly) ===
// const PROVIDERS = [
//   { value: "PINNACLE", label: "PINNACLE" },
//   { value: "META_CLOUD", label: "META_CLOUD" },
// ];

// // --- BusinessId helper ---
// const TOKEN_KEY = "xbyte_token";
// const GUID_RE =
//   /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;

// function getBusinessId() {
//   try {
//     const saved = localStorage.getItem("business_id");
//     if (saved && GUID_RE.test(saved)) return saved;

//     const jwt = localStorage.getItem(TOKEN_KEY);
//     if (!jwt) return null;

//     const [, payloadB64] = jwt.split(".");
//     if (!payloadB64) return null;

//     const payload = JSON.parse(
//       atob(payloadB64.replace(/-/g, "+").replace(/_/g, "/"))
//     );

//     const bid =
//       payload?.BusinessId ||
//       payload?.businessId ||
//       payload?.biz ||
//       payload?.bid ||
//       null;

//     return typeof bid === "string" && GUID_RE.test(bid) ? bid : null;
//   } catch {
//     return null;
//   }
// }

// // Normalize provider names
// const normalizeProvider = p => {
//   const raw = (p ?? "").toString().trim();
//   if (!raw) return "PINNACLE";
//   const up = raw.toUpperCase();
//   if (up === "PINNACLE") return "PINNACLE";
//   if (
//     up === "META_CLOUD" ||
//     up === "META" ||
//     up === "METACLOUD" ||
//     up === "META-CLOUD"
//   ) {
//     return "META_CLOUD";
//   }
//   return "PINNACLE";
// };

// // UI label per provider (still binds to apiKey field)
// const secretLabelFor = provider =>
//   normalizeProvider(provider) === "PINNACLE" ? "API Key" : "Token";

// // Initial blank global settings
// const blank = {
//   provider: "PINNACLE",
//   apiUrl: "",
//   apiKey: "",
//   wabaId: "",
//   senderDisplayName: "",
//   webhookSecret: "",
//   webhookVerifyToken: "",
//   webhookCallbackUrl: "",
//   isActive: true,
// };

// export default function WhatsAppSettings() {
//   const [formData, setFormData] = useState(blank);
//   const [loading, setLoading] = useState(false);
//   const [saving, setSaving] = useState(false);
//   const [testing, setTesting] = useState(false);
//   const [testResult, setTestResult] = useState("");
//   const [senders, setSenders] = useState([]);
//   const [fetchingMeta, setFetchingMeta] = useState(false);
//   const [hasSavedOnce, setHasSavedOnce] = useState(false);
//   const [savedProvider, setSavedProvider] = useState(null);

//   // ESU status
//   const [esuStatus, setEsuStatus] = useState({
//     loading: true,
//     connected: false,
//     hasToken: false,
//     hasWaba: false,
//     phoneCount: 0,
//     message: "",
//   });
//   const [connectingEsu, setConnectingEsu] = useState(false);

//   const businessId = useMemo(getBusinessId, []);
//   const withBiz = (cfg = {}) =>
//     businessId
//       ? {
//           ...cfg,
//           headers: { ...(cfg.headers || {}), "X-Business-Id": businessId },
//         }
//       : cfg;

//   // ===== Numbers API helpers =====
//   const listNumbers = async provider => {
//     const p = normalizeProvider(provider);
//     const { data } = await axiosClient.get(
//       `/whatsappsettings/${p}/numbers`,
//       withBiz()
//     );
//     return Array.isArray(data) ? data : [];
//   };

//   const upsertNumber = async (provider, row) => {
//     const p = normalizeProvider(provider);
//     const payload = {
//       phoneNumberId: (row.phoneNumberId || "").trim(),
//       whatsAppBusinessNumber: (row.whatsAppBusinessNumber || "").trim(),
//       senderDisplayName: (row.label || row.senderDisplayName || "").trim(),
//       isActive: row.isActive ?? true,
//       isDefault: !!row.isDefault,
//     };
//     const { data } = await axiosClient.post(
//       `/whatsappsettings/${p}/numbers`,
//       payload,
//       withBiz()
//     );
//     return data;
//   };

//   const deleteNumber = async (provider, id) => {
//     const p = normalizeProvider(provider);
//     await axiosClient.delete(`/whatsappsettings/${p}/numbers/${id}`, withBiz());
//   };

//   const setDefaultNumber = async (provider, id) => {
//     const p = normalizeProvider(provider);
//     await axiosClient.patch(
//       `/whatsappsettings/${p}/numbers/${id}/default`,
//       null,
//       withBiz()
//     );
//   };

//   const fetchNumbers = async provider => {
//     try {
//       const items = await listNumbers(provider);
//       setSenders(
//         items.map(n => ({
//           id: n.id,
//           label: n.senderDisplayName || "",
//           phoneNumberId: n.phoneNumberId || "",
//           whatsAppBusinessNumber: n.whatsAppBusinessNumber || "",
//           isDefault: !!n.isDefault,
//           isActive: n.isActive ?? true,
//         }))
//       );
//     } catch {
//       setSenders([]);
//     }
//   };

//   // ===== Derived UI =====
//   const providerLabel = useMemo(
//     () => secretLabelFor(formData.provider),
//     [formData.provider]
//   );
//   const selectedProvider = useMemo(
//     () => normalizeProvider(formData.provider),
//     [formData.provider]
//   );
//   const showFetchButton = hasSavedOnce;

//   // ===== ESU: load connection status =====
//   useEffect(() => {
//     const loadStatus = async () => {
//       if (!businessId) {
//         setEsuStatus(s => ({
//           ...s,
//           loading: false,
//           connected: false,
//           message: "Business context missing.",
//         }));
//         return;
//       }
//       try {
//         setEsuStatus(s => ({ ...s, loading: true }));
//         const res = await axiosClient.get(`/esu/facebook/status`, {
//           params: { businessId },
//         });
//         const dto = res?.data || {};
//         const connected =
//           !!dto.hasActiveMeta ||
//           !!dto.hasValidToken ||
//           (!!dto.hasToken && !!dto.wabaId);

//         setEsuStatus({
//           loading: false,
//           connected,
//           hasToken: !!dto.hasToken || !!dto.hasValidToken,
//           hasWaba: !!dto.wabaId,
//           phoneCount: dto.phoneCount || dto.numbersCount || 0,
//           message: dto.message || "",
//         });
//       } catch {
//         setEsuStatus({
//           loading: false,
//           connected: false,
//           hasToken: false,
//           hasWaba: false,
//           phoneCount: 0,
//           message: "Unable to load Meta connection status.",
//         });
//       }
//     };

//     loadStatus();
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, [businessId]);

//   // ===== Initial load of saved settings + numbers =====
//   useEffect(() => {
//     let mounted = true;
//     (async () => {
//       try {
//         setLoading(true);
//         const res = await axiosClient.get("/whatsappsettings/me", withBiz());
//         if (!mounted) return;
//         const data = res?.data ?? {};

//         const provider = normalizeProvider(data?.provider);
//         const secret = data?.apiKey || data?.apiToken || "";

//         setFormData(prev => ({
//           ...prev,
//           provider,
//           apiUrl: data?.apiUrl || "",
//           apiKey: secret,
//           wabaId: data?.wabaId || "",
//           senderDisplayName: data?.senderDisplayName || "",
//           webhookSecret: data?.webhookSecret || "",
//           webhookVerifyToken: data?.webhookVerifyToken || "",
//           webhookCallbackUrl: data?.webhookCallbackUrl || "",
//           isActive: data?.isActive ?? true,
//         }));

//         setSavedProvider(provider);

//         const existed =
//           !!data?.provider ||
//           !!data?.apiKey ||
//           !!data?.apiToken ||
//           !!data?.wabaId;
//         setHasSavedOnce(!!existed);

//         await fetchNumbers(provider);
//       } catch {
//         toast.info("‚ÑπÔ∏è No WhatsApp settings found. You can create them now.");
//         setHasSavedOnce(false);
//         setSavedProvider(null);
//       } finally {
//         mounted && setLoading(false);
//       }
//     })();

//     return () => {
//       mounted = false;
//     };
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, []);

//   // Refresh numbers when dropdown provider changes
//   useEffect(() => {
//     fetchNumbers(formData.provider);
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, [formData.provider]);

//   // Auto-fetch numbers when ESU redirect adds ?connected=1
//   useEffect(() => {
//     const params = new URLSearchParams(window.location.search);
//     if (params.get("connected") === "1") {
//       (async () => {
//         try {
//           await handleFetchFromMeta();
//           toast.success("Meta connection completed. Numbers synced.");
//         } finally {
//           const url = new URL(window.location.href);
//           url.searchParams.delete("connected");
//           window.history.replaceState({}, "", url.toString());
//         }
//       })();
//     }
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, []);

//   // ===== Local sender mutations =====
//   const addSender = () =>
//     setSenders(s => [
//       ...s,
//       {
//         label: "",
//         phoneNumberId: "",
//         whatsAppBusinessNumber: "",
//         isDefault: s.length === 0,
//         isActive: true,
//       },
//     ]);

//   const removeSender = idx => setSenders(s => s.filter((_, i) => i !== idx));

//   const updateSender = (idx, key, value) =>
//     setSenders(s =>
//       s.map((row, i) => (i === idx ? { ...row, [key]: value } : row))
//     );

//   const setDefaultSenderLocal = idx =>
//     setSenders(s => s.map((row, i) => ({ ...row, isDefault: i === idx })));

//   // ===== Global form handlers =====
//   const handleChange = e => {
//     const { name, value } = e.target;
//     setFormData(p => ({ ...p, [name]: value }));
//   };

//   const handleToggle = e => {
//     const { name, checked } = e.target;
//     setFormData(p => ({ ...p, [name]: checked }));
//   };

//   const handleProviderChange = e => {
//     const provider = normalizeProvider(e.target.value);
//     setFormData(p => ({ ...p, provider }));
//   };

//   // ===== Save global settings =====
//   const validateBeforeSave = () => {
//     if (!formData.apiKey.trim()) {
//       toast.error("API Key / Token is required.");
//       return false;
//     }
//     return true;
//   };

//   const handleSaveGlobal = async () => {
//     if (!validateBeforeSave()) return;
//     try {
//       setSaving(true);
//       const payload = {
//         provider: normalizeProvider(formData.provider),
//         apiUrl: (formData.apiUrl || "").trim(),
//         apiKey: (formData.apiKey || "").trim(),
//         wabaId: (formData.wabaId || "").trim() || null,
//         senderDisplayName: (formData.senderDisplayName || "").trim() || null,
//         webhookSecret: (formData.webhookSecret || "").trim() || null,
//         webhookVerifyToken: (formData.webhookVerifyToken || "").trim() || null,
//         webhookCallbackUrl: (formData.webhookCallbackUrl || "").trim() || null,
//         isActive: !!formData.isActive,
//       };

//       await axiosClient.put("/whatsappsettings/update", payload, withBiz());

//       setHasSavedOnce(true);
//       setSavedProvider(payload.provider);

//       toast.success("Settings saved.");
//     } catch (err) {
//       toast.error(err?.response?.data?.message || "Failed to save settings.");
//     } finally {
//       setSaving(false);
//     }
//   };

//   // ===== Test connection using backend "current" settings =====
//   const handleTest = async () => {
//     setTesting(true);
//     setTestResult("");
//     try {
//       const res = await axiosClient.post(
//         "/whatsappsettings/test-connection/current",
//         {},
//         withBiz()
//       );
//       setTestResult(JSON.stringify(res?.data ?? {}, null, 2));
//       toast.success(res?.data?.message || "Connection test complete.");
//     } catch (err) {
//       setTestResult(
//         JSON.stringify(err?.response?.data ?? { error: String(err) }, null, 2)
//       );
//       toast.error(err?.response?.data?.message || "Connection test failed.");
//     } finally {
//       setTesting(false);
//     }
//   };

//   // ===== ESU: start Embedded Signup from Settings page =====
//   const startFacebookEsu = async () => {
//     try {
//       setConnectingEsu(true);

//       if (!businessId) {
//         toast.error("Business context missing. Please re-login.");
//         return;
//       }

//       const returnUrlAfterSuccess = "/app/settings/whatsapp";

//       const res = await axiosClient.post(
//         "/esu/facebook/start",
//         { returnUrlAfterSuccess },
//         {
//           headers: {
//             "X-Business-Id": businessId,
//           },
//         }
//       );

//       const authUrl =
//         res?.data?.data?.authUrl || res?.data?.authUrl || res?.data?.url;

//       if (!authUrl) {
//         toast.error(
//           res?.data?.message || "Could not get Meta Embedded Signup URL."
//         );
//         return;
//       }

//       window.location.href = authUrl;
//     } catch (err) {
//       toast.error(
//         err?.response?.data?.message ||
//           err?.message ||
//           "Failed to start Meta Embedded Signup."
//       );
//     } finally {
//       setConnectingEsu(false);
//     }
//   };

//   // ===== Fetch numbers via backend sync =====
//   const handleFetchFromMeta = async () => {
//     if (!formData.apiKey?.trim() || !formData.wabaId?.trim()) {
//       toast.warn(
//         "Please provide API Key/Token and WABA ID, then Save Settings."
//       );
//       return;
//     }
//     try {
//       setFetchingMeta(true);
//       const res = await axiosClient.post(
//         "/whatsappsettings/fetch-numbers",
//         {},
//         withBiz()
//       );

//       const serverBucket = normalizeProvider(res?.data?.provider);
//       const fallbackBucket = savedProvider || selectedProvider;
//       const bucket = serverBucket || fallbackBucket;

//       await fetchNumbers(bucket);

//       if (bucket && bucket !== selectedProvider) {
//         setFormData(p => ({ ...p, provider: bucket }));
//       }

//       const { added = 0, updated = 0, total = 0 } = res?.data || {};
//       toast.success(
//         `Synced ‚Äî added ${added}, updated ${updated}, total ${total} (${bucket}).`
//       );
//     } catch (err) {
//       const msg =
//         err?.response?.data?.message || err?.message || "Fetch failed.";
//       toast.error(msg);
//     } finally {
//       setFetchingMeta(false);
//     }
//   };

//   // ===== Connection Status card UI =====
//   const renderConnectionStatus = () => {
//     if (esuStatus.loading) {
//       return (
//         <div className="mb-4 rounded-xl bg-slate-50 border border-slate-200 px-4 py-3 text-sm text-slate-600">
//           Checking Meta connection status‚Ä¶
//         </div>
//       );
//     }

//     if (!esuStatus.connected) {
//       return (
//         <div className="mb-5 rounded-2xl border border-red-100 bg-red-50/70 shadow-sm overflow-hidden">
//           <div className="px-4 py-2 bg-red-50 border-b border-red-100 flex items-center gap-2">
//             <span className="text-[10px] uppercase tracking-wide text-slate-500">
//               Connection Status
//             </span>
//           </div>
//           <div className="px-4 py-3 flex items-start gap-3">
//             <div className="mt-1">
//               <span className="w-3 h-3 inline-block rounded-full bg-red-500 mr-2" />
//             </div>
//             <div>
//               <div className="font-semibold text-red-600 mb-0.5">
//                 Not connected
//               </div>
//               <p className="text-xs text-slate-600 mb-2">
//                 No active Meta token detected. Use Embedded Signup to connect
//                 your WhatsApp Business Account.
//               </p>
//               <button
//                 type="button"
//                 onClick={startFacebookEsu}
//                 disabled={connectingEsu}
//                 className="inline-flex items-center gap-2 px-3 py-1.5 rounded-md bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-semibold disabled:opacity-60"
//               >
//                 {connectingEsu
//                   ? "Opening Embedded Signup‚Ä¶"
//                   : "Connect via Facebook (Embedded Signup)"}
//               </button>
//             </div>
//           </div>
//         </div>
//       );
//     }

//     return (
//       <div className="mb-5 rounded-2xl border border-emerald-100 bg-emerald-50/70 shadow-sm overflow-hidden">
//         <div className="px-4 py-2 bg-emerald-50 border-b border-emerald-100 flex items-center justify-between">
//           <span className="text-[10px] uppercase tracking-wide text-slate-500">
//             Connection Status
//           </span>
//           <span className="text-[10px] text-emerald-700">
//             Via Meta Embedded Signup
//           </span>
//         </div>
//         <div className="px-4 py-3 flex items-start gap-3">
//           <div className="mt-1">
//             <span className="w-3 h-3 inline-block rounded-full bg-emerald-500 mr-2" />
//           </div>
//           <div>
//             <div className="font-semibold text-emerald-700 mb-0.5">
//               Connected
//             </div>
//             <p className="text-xs text-slate-700">
//               Valid Meta token detected
//               {esuStatus.phoneCount
//                 ? ` ¬∑ ${esuStatus.phoneCount} phone${
//                     esuStatus.phoneCount > 1 ? "s" : ""
//                   } synced`
//                 : ""}
//               {esuStatus.hasWaba ? " ¬∑ WABA configured" : ""}.
//             </p>
//             <div className="mt-2 flex flex-wrap gap-2">
//               <button
//                 type="button"
//                 onClick={startFacebookEsu}
//                 disabled={connectingEsu}
//                 className="px-3 py-1.5 rounded-md bg-white text-emerald-700 border border-emerald-300 text-xs font-semibold hover:bg-emerald-50 disabled:opacity-60"
//               >
//                 {connectingEsu
//                   ? "Opening Embedded Signup‚Ä¶"
//                   : "Manage connection (Embedded Signup)"}
//               </button>
//             </div>
//           </div>
//         </div>
//       </div>
//     );
//   };

//   // ===== Render =====
//   return (
//     <div className="max-w-5xl mx-auto px-4 py-6">
//       <div className="flex items-center justify-between mb-3">
//         <h1 className="text-xl font-semibold text-slate-900">
//           WhatsApp Settings
//         </h1>

//         <div className="flex gap-2">
//           <button
//             type="button"
//             onClick={handleSaveGlobal}
//             disabled={saving}
//             className={`px-4 py-2 rounded-md text-sm ${
//               saving
//                 ? "bg-gray-300 text-gray-600"
//                 : "bg-emerald-600 hover:bg-emerald-700 text-white"
//             }`}
//           >
//             {saving ? "Saving‚Ä¶" : "Save Settings"}
//           </button>

//           <button
//             type="button"
//             onClick={handleTest}
//             disabled={testing}
//             className={`px-4 py-2 rounded-md text-sm ${
//               testing
//                 ? "bg-gray-200 text-gray-500"
//                 : "bg-white border border-gray-300 text-gray-700 hover:bg-gray-50"
//             }`}
//           >
//             {testing ? "Testing‚Ä¶" : "Test Connection"}
//           </button>
//         </div>
//       </div>

//       {renderConnectionStatus()}

//       {loading && (
//         <div className="text-xs text-gray-500 mb-4">Loading settings‚Ä¶</div>
//       )}

//       {/* GLOBAL provider-level settings */}
//       <div className="grid grid-cols-1 md:grid-cols-12 gap-4">
//         <div className="md:col-span-4">
//           <label className="text-xs text-gray-600 block mb-1">Provider</label>
//           <select
//             name="provider"
//             value={normalizeProvider(formData.provider)}
//             onChange={handleProviderChange}
//             className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
//           >
//             {PROVIDERS.map(p => (
//               <option key={p.value} value={p.value}>
//                 {p.label}
//               </option>
//             ))}
//           </select>
//         </div>

//         <div className="md:col-span-4">
//           <label className="text-xs text-gray-600 block mb-1">
//             API URL (optional)
//           </label>
//           <input
//             type="text"
//             name="apiUrl"
//             value={formData.apiUrl}
//             onChange={handleChange}
//             placeholder="https://graph.facebook.com/v20.0 or provider URL"
//             className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
//           />
//         </div>

//         <div className="md:col-span-4">
//           <label className="text-xs text-gray-600 block mb-1">
//             {providerLabel}
//           </label>
//           <input
//             type="text"
//             name="apiKey"
//             value={formData.apiKey}
//             onChange={handleChange}
//             placeholder={providerLabel}
//             className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
//           />
//         </div>

//         <div className="md:col-span-4">
//           <label className="text-xs text-gray-600 block mb-1">
//             WABA ID (Meta only)
//           </label>
//           <input
//             type="text"
//             name="wabaId"
//             value={formData.wabaId}
//             onChange={handleChange}
//             placeholder="e.g. 123456789012345"
//             className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
//           />
//         </div>

//         <div className="md:col-span-4">
//           <label className="text-xs text-gray-600 block mb-1">
//             Sender Display Name (optional)
//           </label>
//           <input
//             type="text"
//             name="senderDisplayName"
//             value={formData.senderDisplayName}
//             onChange={handleChange}
//             placeholder="e.g. Acme Support"
//             className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
//           />
//         </div>

//         <div className="md:col-span-4">
//           <label className="text-xs text-gray-600 block mb-1">
//             Webhook Verify Token
//           </label>
//           <input
//             type="text"
//             name="webhookVerifyToken"
//             value={formData.webhookVerifyToken}
//             onChange={handleChange}
//             placeholder="verify-token"
//             className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
//           />
//         </div>

//         <div className="md:col-span-4">
//           <label className="text-xs text-gray-600 block mb-1">
//             Webhook Secret
//           </label>
//           <input
//             type="text"
//             name="webhookSecret"
//             value={formData.webhookSecret}
//             onChange={handleChange}
//             placeholder="secret"
//             className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
//           />
//         </div>

//         <div className="md:col-span-8">
//           <label className="text-xs text-gray-600 block mb-1">
//             Webhook Callback URL
//           </label>
//           <input
//             type="text"
//             name="webhookCallbackUrl"
//             value={formData.webhookCallbackUrl}
//             onChange={handleChange}
//             placeholder="https://example.com/api/webhooks/whatsapp"
//             className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
//           />
//         </div>

//         <div className="md:col-span-4 flex items-end">
//           <label className="inline-flex items-center gap-2 text-sm text-gray-700">
//             <input
//               type="checkbox"
//               name="isActive"
//               checked={!!formData.isActive}
//               onChange={handleToggle}
//               className="h-4 w-4"
//             />
//             Active
//           </label>
//         </div>
//       </div>

//       {/* SENDERS */}
//       <div className="mt-8 border-t pt-6">
//         <div className="flex items-center justify-between mb-3">
//           <h3 className="text-sm font-semibold text-gray-700">
//             Senders (phone numbers)
//           </h3>

//           <div className="flex gap-2">
//             {showFetchButton && (
//               <button
//                 type="button"
//                 onClick={handleFetchFromMeta}
//                 disabled={fetchingMeta}
//                 className={`px-3 py-1.5 rounded-md text-sm ${
//                   fetchingMeta
//                     ? "bg-gray-200 text-gray-500"
//                     : "bg-emerald-600 text-white hover:bg-emerald-700"
//                 }`}
//               >
//                 {fetchingMeta ? "Fetching‚Ä¶" : "Fetch from Meta"}
//               </button>
//             )}
//             <button
//               type="button"
//               onClick={addSender}
//               className="px-3 py-1.5 rounded-md text-sm bg-gray-100 hover:bg-gray-200"
//             >
//               + Add number
//             </button>
//           </div>
//         </div>

//         {senders.length === 0 && (
//           <div className="text-xs text-gray-500 mb-2">
//             No senders yet. Use <b>Fetch from Meta</b> after connecting, or{" "}
//             <b>+ Add number</b> to configure manually.
//           </div>
//         )}

//         <div className="space-y-3">
//           {senders.map((row, idx) => (
//             <div
//               key={idx}
//               className="grid grid-cols-1 md:grid-cols-12 gap-3 bg-gray-50 p-3 rounded"
//             >
//               <div className="md:col-span-3">
//                 <label className="text-xs text-gray-600 block mb-1">
//                   Label (optional)
//                 </label>
//                 <input
//                   type="text"
//                   value={row.label || ""}
//                   onChange={e => updateSender(idx, "label", e.target.value)}
//                   placeholder="e.g. Sales India"
//                   className="w-full px-3 py-1.5 border rounded-md text-sm border-gray-300"
//                 />
//               </div>

//               <div className="md:col-span-4">
//                 <label className="text-xs text-gray-600 block mb-1">
//                   WhatsApp Business Number
//                 </label>
//                 <input
//                   type="text"
//                   value={row.whatsAppBusinessNumber || ""}
//                   onChange={e =>
//                     updateSender(idx, "whatsAppBusinessNumber", e.target.value)
//                   }
//                   placeholder="+14150000001"
//                   className="w-full px-3 py-1.5 border rounded-md text-sm border-gray-300"
//                 />
//               </div>

//               <div className="md:col-span-4">
//                 <label className="text-xs text-gray-600 block mb-1">
//                   Phone Number ID
//                 </label>
//                 <input
//                   type="text"
//                   value={row.phoneNumberId || ""}
//                   onChange={e =>
//                     updateSender(idx, "phoneNumberId", e.target.value)
//                   }
//                   placeholder="1234567890"
//                   className="w-full px-3 py-1.5 border rounded-md text-sm border-gray-300"
//                 />
//               </div>

//               <div className="md:col-span-1 flex items-end gap-2 flex-wrap">
//                 <button
//                   type="button"
//                   onClick={async () => {
//                     try {
//                       const saved = await upsertNumber(formData.provider, row);
//                       setSenders(s =>
//                         s.map((r, i) =>
//                           i === idx ? { ...r, id: saved?.id || r.id } : r
//                         )
//                       );
//                       toast.success("Sender saved.");
//                     } catch {
//                       toast.error("Save failed.");
//                     }
//                   }}
//                   className="px-2 py-1 rounded text-xs bg-blue-600 text-white"
//                 >
//                   Save
//                 </button>

//                 <button
//                   type="button"
//                   onClick={async () => {
//                     try {
//                       if (!row.id) {
//                         removeSender(idx);
//                         return;
//                       }
//                       await deleteNumber(formData.provider, row.id);
//                       removeSender(idx);
//                       toast.success("Sender deleted.");
//                     } catch {
//                       toast.error("Delete failed.");
//                     }
//                   }}
//                   className="px-2 py-1 rounded text-xs bg-red-50 text-red-700"
//                 >
//                   ‚úï
//                 </button>

//                 <button
//                   type="button"
//                   onClick={async () => {
//                     try {
//                       if (!row.id) {
//                         const saved = await upsertNumber(
//                           formData.provider,
//                           row
//                         );
//                         await setDefaultNumber(formData.provider, saved?.id);
//                       } else {
//                         await setDefaultNumber(formData.provider, row.id);
//                       }
//                       setDefaultSenderLocal(idx);
//                       toast.success("Default sender set.");
//                     } catch {
//                       toast.error("Failed to set default.");
//                     }
//                   }}
//                   className={`px-2 py-1 rounded text-xs ${
//                     row.isDefault
//                       ? "bg-emerald-600 text-white"
//                       : "bg-gray-200 text-gray-800"
//                   }`}
//                 >
//                   {row.isDefault ? "Default" : "Make default"}
//                 </button>
//               </div>
//             </div>
//           ))}
//         </div>

//         <p className="text-[11px] text-gray-500 mt-2">
//           The <b>Default</b> sender will be used when no phone is chosen
//           explicitly while sending.
//         </p>
//       </div>

//       {testResult && (
//         <div className="mt-6">
//           <label className="text-xs text-gray-600 block mb-1">
//             Test Result
//           </label>
//           <pre className="text-xs bg-gray-50 border border-gray-200 p-3 rounded overflow-auto">
//             {testResult}
//           </pre>
//         </div>
//       )}
//     </div>
//   );
// }

// // üìÑ src/pages/Settings/WhatsAppSettings.jsx
// import React, { useState, useEffect, useMemo } from "react";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";

// // === Canonical providers (MUST match backend exactly) ===
// const PROVIDERS = [
//   { value: "PINNACLE", label: "PINNACLE" },
//   { value: "META_CLOUD", label: "META_CLOUD" },
// ];

// // --- BusinessId helper (unchanged) ---
// const TOKEN_KEY = "xbyte_token";
// const GUID_RE =
//   /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;

// function getBusinessId() {
//   try {
//     const saved = localStorage.getItem("business_id");
//     if (saved && GUID_RE.test(saved)) return saved;

//     const jwt = localStorage.getItem(TOKEN_KEY);
//     if (!jwt) return null;

//     const [, payloadB64] = jwt.split(".");
//     if (!payloadB64) return null;

//     const payload = JSON.parse(
//       atob(payloadB64.replace(/-/g, "+").replace(/_/g, "/"))
//     );

//     const bid =
//       payload?.BusinessId ||
//       payload?.businessId ||
//       payload?.biz ||
//       payload?.bid ||
//       null;

//     return typeof bid === "string" && GUID_RE.test(bid) ? bid : null;
//   } catch {
//     return null;
//   }
// }

// // Map any input to UPPERCASE canonical values
// const normalizeProvider = p => {
//   const raw = (p ?? "").toString().trim();
//   if (!raw) return "PINNACLE";
//   const up = raw.toUpperCase();
//   if (up === "PINNACLE") return "PINNACLE";
//   if (
//     up === "META_CLOUD" ||
//     up === "META" ||
//     up === "METACLOUD" ||
//     up === "META-CLOUD"
//   )
//     return "META_CLOUD";
//   return "PINNACLE";
// };

// // UI label per provider (still binds to apiKey)
// const secretLabelFor = provider =>
//   normalizeProvider(provider) === "PINNACLE" ? "API Key" : "Token";

// // Initial blank form (GLOBAL SETTINGS ONLY)
// const blank = {
//   provider: "PINNACLE",
//   apiUrl: "",
//   apiKey: "",
//   wabaId: "",
//   senderDisplayName: "",
//   webhookSecret: "",
//   webhookVerifyToken: "",
//   webhookCallbackUrl: "",
//   isActive: true,
// };

// export default function WhatsAppSettings() {
//   const [formData, setFormData] = useState(blank);
//   const [loading, setLoading] = useState(false);
//   const [saving, setSaving] = useState(false);
//   const [testing, setTesting] = useState(false);
//   const [testResult, setTestResult] = useState("");
//   const [senders, setSenders] = useState([]);
//   const [fetchingMeta, setFetchingMeta] = useState(false);
//   const [hasSavedOnce, setHasSavedOnce] = useState(false);
//   const [savedProvider, setSavedProvider] = useState(null);

//   // ESU status + launch
//   const [esuStatusLoading, setEsuStatusLoading] = useState(false);
//   const [esuConnected, setEsuConnected] = useState(false);
//   const [esuExpiresAt, setEsuExpiresAt] = useState(null);
//   const [esuWillExpireSoon, setEsuWillExpireSoon] = useState(false);
//   const [startingEsu, setStartingEsu] = useState(false);

//   const businessId = useMemo(getBusinessId, []);
//   const withBiz = (cfg = {}) =>
//     businessId
//       ? {
//           ...cfg,
//           headers: { ...(cfg.headers || {}), "X-Business-Id": businessId },
//         }
//       : cfg;

//   // ===== Numbers API helpers (DB-backed) =====
//   const listNumbers = async provider => {
//     const p = normalizeProvider(provider);
//     const { data } = await axiosClient.get(
//       `/whatsappsettings/${p}/numbers`,
//       withBiz()
//     );
//     return Array.isArray(data) ? data : [];
//   };

//   const upsertNumber = async (provider, row) => {
//     const p = normalizeProvider(provider);
//     const payload = {
//       phoneNumberId: (row.phoneNumberId || "").trim(),
//       whatsAppBusinessNumber: (row.whatsAppBusinessNumber || "").trim(),
//       senderDisplayName: (row.label || row.senderDisplayName || "").trim(),
//       isActive: row.isActive ?? true,
//       isDefault: !!row.isDefault,
//     };
//     const { data } = await axiosClient.post(
//       `/whatsappsettings/${p}/numbers`,
//       payload,
//       withBiz()
//     );
//     return data;
//   };

//   const deleteNumber = async (provider, id) => {
//     const p = normalizeProvider(provider);
//     await axiosClient.delete(`/whatsappsettings/${p}/numbers/${id}`, withBiz());
//   };

//   const setDefaultNumber = async (provider, id) => {
//     const p = normalizeProvider(provider);
//     await axiosClient.patch(
//       `/whatsappsettings/${p}/numbers/${id}/default`,
//       null,
//       withBiz()
//     );
//   };

//   const fetchNumbers = async provider => {
//     try {
//       const items = await listNumbers(provider);
//       setSenders(
//         items.map(n => ({
//           id: n.id,
//           label: n.senderDisplayName || "",
//           phoneNumberId: n.phoneNumberId || "",
//           whatsAppBusinessNumber: n.whatsAppBusinessNumber || "",
//           isDefault: !!n.isDefault,
//           isActive: n.isActive ?? true,
//         }))
//       );
//     } catch {
//       // ignore; empty list is fine
//     }
//   };

//   // ===== Derived UI =====
//   const providerLabel = useMemo(
//     () => secretLabelFor(formData.provider),
//     [formData.provider]
//   );
//   const selectedProvider = useMemo(
//     () => normalizeProvider(formData.provider),
//     [formData.provider]
//   );

//   const showFetchButton = hasSavedOnce;

//   // ===== Initial load of saved settings + initial numbers =====
//   useEffect(() => {
//     let mounted = true;

//     (async () => {
//       try {
//         setLoading(true);
//         const res = await axiosClient.get("/whatsappsettings/me", withBiz());
//         if (!mounted) return;

//         const data = res?.data ?? {};
//         const provider = normalizeProvider(data?.provider);
//         const secret = data?.apiKey || data?.apiToken || "";

//         setFormData(prev => ({
//           ...prev,
//           provider,
//           apiUrl: data?.apiUrl || "",
//           apiKey: secret,
//           wabaId: data?.wabaId || "",
//           senderDisplayName: data?.senderDisplayName || "",
//           webhookSecret: data?.webhookSecret || "",
//           webhookVerifyToken: data?.webhookVerifyToken || "",
//           webhookCallbackUrl: data?.webhookCallbackUrl || "",
//           isActive: data?.isActive ?? true,
//         }));

//         setSavedProvider(provider);

//         const existed =
//           !!data?.provider ||
//           !!data?.apiKey ||
//           !!data?.apiToken ||
//           !!data?.wabaId;
//         setHasSavedOnce(!!existed);

//         await fetchNumbers(provider);
//       } catch {
//         toast.info("No WhatsApp settings found. You can configure them now.");
//         setHasSavedOnce(false);
//         setSavedProvider(null);
//       } finally {
//         mounted && setLoading(false);
//       }
//     })();

//     return () => {
//       mounted = false;
//     };
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, []);

//   // ===== ESU connection status (debug endpoint) =====
//   useEffect(() => {
//     if (!businessId) return;
//     let cancelled = false;

//     (async () => {
//       try {
//         setEsuStatusLoading(true);
//         const res = await axiosClient.get("esu/facebook/debug/status", {
//           params: { businessId },
//           ...withBiz(),
//         });

//         if (cancelled) return;
//         const dto = res?.data ?? {};

//         const connected =
//           dto.Connected ?? dto.connected ?? dto.connected === true;
//         setEsuConnected(!!connected);

//         const expires =
//           dto.TokenExpiresAtUtc ||
//           dto.tokenExpiresAtUtc ||
//           dto.expiresAtUtc ||
//           null;
//         setEsuExpiresAt(expires || null);

//         const soon = dto.WillExpireSoon ?? dto.willExpireSoon ?? false;
//         setEsuWillExpireSoon(!!soon);
//       } catch {
//         if (!cancelled) {
//           // Silent: we just show "Not connected"
//           setEsuConnected(false);
//           setEsuExpiresAt(null);
//           setEsuWillExpireSoon(false);
//         }
//       } finally {
//         !cancelled && setEsuStatusLoading(false);
//       }
//     })();

//     return () => {
//       cancelled = true;
//     };
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, [businessId]);

//   // Refresh numbers when provider dropdown changes
//   useEffect(() => {
//     fetchNumbers(formData.provider);
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, [formData.provider]);

//   // Auto-sync after ESU redirect (?connected=1)
//   useEffect(() => {
//     const params = new URLSearchParams(window.location.search);
//     if (params.get("connected") === "1") {
//       (async () => {
//         try {
//           await handleFetchFromMeta();
//           toast.success("Meta Embedded Signup completed. Numbers synced.");
//         } finally {
//           const url = new URL(window.location.href);
//           url.searchParams.delete("connected");
//           window.history.replaceState({}, "", url.toString());
//         }
//       })();
//     }
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, []);

//   // ===== Local sender mutations =====
//   const addSender = () =>
//     setSenders(s => [
//       ...s,
//       {
//         label: "",
//         phoneNumberId: "",
//         whatsAppBusinessNumber: "",
//         isDefault: s.length === 0,
//         isActive: true,
//       },
//     ]);

//   const removeSender = idx => setSenders(s => s.filter((_, i) => i !== idx));

//   const updateSender = (idx, key, value) =>
//     setSenders(s =>
//       s.map((row, i) => (i === idx ? { ...row, [key]: value } : row))
//     );

//   const setDefaultSender = idx =>
//     setSenders(s => s.map((row, i) => ({ ...row, isDefault: i === idx })));

//   // ===== Global form handlers =====
//   const handleChange = e => {
//     const { name, value } = e.target;
//     setFormData(p => ({ ...p, [name]: value }));
//   };

//   const handleToggle = e => {
//     const { name, checked } = e.target;
//     setFormData(p => ({ ...p, [name]: checked }));
//   };

//   const handleProviderChange = e => {
//     const provider = normalizeProvider(e.target.value);
//     setFormData(p => ({ ...p, provider }));
//   };

//   // ===== Save global settings ONLY =====
//   const validateBeforeSave = () => {
//     if (!formData.apiKey.trim()) {
//       toast.error("API Key / Token is required.");
//       return false;
//     }
//     return true;
//   };

//   const handleSaveGlobal = async () => {
//     if (!validateBeforeSave()) return;

//     try {
//       setSaving(true);

//       const payload = {
//         provider: normalizeProvider(formData.provider),
//         apiUrl: (formData.apiUrl || "").trim(),
//         apiKey: (formData.apiKey || "").trim(),
//         wabaId: (formData.wabaId || "").trim() || null,
//         senderDisplayName: (formData.senderDisplayName || "").trim() || null,
//         webhookSecret: (formData.webhookSecret || "").trim() || null,
//         webhookVerifyToken: (formData.webhookVerifyToken || "").trim() || null,
//         webhookCallbackUrl: (formData.webhookCallbackUrl || "").trim() || null,
//         isActive: !!formData.isActive,
//       };

//       await axiosClient.put("/whatsappsettings/update", payload, withBiz());

//       setHasSavedOnce(true);
//       setSavedProvider(payload.provider);

//       toast.success("Settings saved.");
//     } catch {
//       toast.error("Failed to save settings.");
//     } finally {
//       setSaving(false);
//     }
//   };

//   // ===== Test connection against SAVED settings =====
//   const handleTest = async () => {
//     setTesting(true);
//     setTestResult("");
//     try {
//       const res = await axiosClient.post(
//         "/whatsappsettings/test-connection/current",
//         {},
//         withBiz()
//       );
//       setTestResult(JSON.stringify(res?.data ?? {}, null, 2));
//       toast.success(res?.data?.message || "Connection test complete.");
//     } catch (err) {
//       setTestResult(
//         JSON.stringify(err?.response?.data ?? { error: String(err) }, null, 2)
//       );
//       toast.error(err?.response?.data?.message || "Connection test failed.");
//     } finally {
//       setTesting(false);
//     }
//   };

//   // ===== Fetch numbers using SAVED provider (Meta sync) =====
//   const handleFetchFromMeta = async () => {
//     if (!formData.apiKey?.trim() || !formData.wabaId?.trim()) {
//       toast.warn(
//         "Please provide API Key/Token and WABA ID, then Save Settings."
//       );
//       return;
//     }

//     try {
//       setFetchingMeta(true);

//       const res = await axiosClient.post(
//         "/whatsappsettings/fetch-numbers",
//         {},
//         withBiz()
//       );

//       const serverBucket = normalizeProvider(res?.data?.provider);
//       const fallbackBucket = savedProvider || selectedProvider;
//       const bucket = serverBucket || fallbackBucket;

//       await fetchNumbers(bucket);

//       if (bucket && bucket !== selectedProvider) {
//         setFormData(p => ({ ...p, provider: bucket }));
//       }

//       const { added = 0, updated = 0, total = 0 } = res?.data || {};
//       toast.success(
//         `Synced ‚Äî added ${added}, updated ${updated}, total ${total} (${bucket}).`
//       );
//     } catch (err) {
//       const msg =
//         err?.response?.data?.message || err?.message || "Fetch failed.";
//       toast.error(msg);
//     } finally {
//       setFetchingMeta(false);
//     }
//   };

//   // ===== Start Meta Embedded Signup (ESU) =====
//   const startEmbeddedSignup = async () => {
//     try {
//       if (!businessId) {
//         toast.error("Business context missing. Please re-login.");
//         return;
//       }

//       setStartingEsu(true);

//       const res = await axiosClient.post(
//         "esu/facebook/start",
//         { returnUrlAfterSuccess: "/app/settings/whatsapp" },
//         withBiz()
//       );

//       const authUrl =
//         res?.data?.data?.authUrl || res?.data?.authUrl || res?.data?.url;

//       if (!authUrl) {
//         toast.error(
//           res?.data?.message || "Could not get Meta Embedded Signup URL."
//         );
//         return;
//       }

//       window.location.href = authUrl;
//     } catch (err) {
//       const msg =
//         err?.response?.data?.message ||
//         err?.message ||
//         "Failed to start Meta Embedded Signup.";
//       toast.error(msg);
//     } finally {
//       setStartingEsu(false);
//     }
//   };

//   // ===== RENDER =====
//   return (
//     <div className="max-w-5xl mx-auto px-4 py-6">
//       <div className="flex items-center justify-between mb-4">
//         <h1 className="text-xl font-semibold">WhatsApp Settings</h1>

//         <div className="flex gap-2">
//           <button
//             type="button"
//             onClick={handleSaveGlobal}
//             disabled={saving}
//             className={`px-4 py-2 rounded-md text-sm ${
//               saving
//                 ? "bg-gray-300 text-gray-600"
//                 : "bg-blue-600 hover:bg-blue-700 text-white"
//             }`}
//             title="Save global settings"
//           >
//             {saving ? "Saving‚Ä¶" : "Save Settings"}
//           </button>

//           <button
//             type="button"
//             onClick={handleTest}
//             disabled={testing}
//             className={`px-4 py-2 rounded-md text-sm ${
//               testing
//                 ? "bg-gray-200 text-gray-500"
//                 : "bg-gray-100 hover:bg-gray-200 text-gray-800"
//             }`}
//             title="Test connection using saved settings"
//           >
//             {testing ? "Testing‚Ä¶" : "Test Connection"}
//           </button>
//         </div>
//       </div>

//       {/* ESU Connection Status */}
//       <div className="mb-6">
//         <div
//           className={`relative rounded-2xl border-2 shadow-sm overflow-hidden ${
//             esuConnected
//               ? "border-emerald-500 bg-emerald-50"
//               : "border-red-400 bg-red-50/40"
//           }`}
//         >
//           <div
//             className={`absolute left-0 top-0 bottom-0 w-2 ${
//               esuConnected ? "bg-emerald-500" : "bg-red-500"
//             }`}
//           />
//           <div className="px-5 pt-3 pb-4 ml-3">
//             <div className="flex items-center justify-between gap-4">
//               <div>
//                 <div className="text-xs font-semibold tracking-wide text-slate-500">
//                   CONNECTION STATUS
//                 </div>

//                 {esuStatusLoading ? (
//                   <div className="mt-1 text-sm text-slate-600">
//                     Checking Meta connection‚Ä¶
//                   </div>
//                 ) : esuConnected ? (
//                   <>
//                     <div className="mt-1 flex items-center gap-2 text-emerald-700 font-semibold">
//                       <span className="w-2.5 h-2.5 rounded-full bg-emerald-500 inline-block" />
//                       Connected via Meta Embedded Signup
//                     </div>
//                     {esuExpiresAt && (
//                       <div className="text-[11px] text-slate-600 mt-1">
//                         Token valid until{" "}
//                         <span className="font-medium">
//                           {new Date(esuExpiresAt).toLocaleString()}
//                         </span>
//                         {esuWillExpireSoon ? " (will expire soon)" : ""}.
//                       </div>
//                     )}
//                   </>
//                 ) : (
//                   <>
//                     <div className="mt-1 flex items-center gap-2 text-red-600 font-semibold">
//                       <span className="w-2.5 h-2.5 rounded-full bg-red-500 inline-block" />
//                       Not connected to Meta
//                     </div>
//                     <div className="text-[11px] text-slate-600 mt-1">
//                       No active Meta ESU token detected for this workspace. Use
//                       Embedded Signup to connect your WhatsApp Business Account
//                       and auto-sync WABA and phone numbers.
//                     </div>
//                   </>
//                 )}
//               </div>

//               <div className="flex flex-col items-end gap-1">
//                 <button
//                   type="button"
//                   onClick={startEmbeddedSignup}
//                   disabled={startingEsu}
//                   className={`px-3 py-1.5 rounded-md text-xs font-semibold shadow-sm disabled:opacity-60 ${
//                     esuConnected
//                       ? "bg-emerald-600 hover:bg-emerald-700 text-white"
//                       : "bg-red-500 hover:bg-red-600 text-white"
//                   }`}
//                 >
//                   {startingEsu
//                     ? "Opening Meta‚Ä¶"
//                     : esuConnected
//                     ? "Reconnect via Embedded Signup"
//                     : "Connect via Embedded Signup"}
//                 </button>

//                 {!esuConnected && (
//                   <span className="text-[10px] text-slate-500">
//                     Uses Meta‚Äôs official flow in a new window.
//                   </span>
//                 )}
//               </div>
//             </div>
//           </div>
//         </div>
//       </div>

//       {loading && (
//         <div className="text-sm text-gray-500 mb-4">Loading settings‚Ä¶</div>
//       )}

//       {/* GLOBAL provider-level settings */}
//       <div className="grid grid-cols-1 md:grid-cols-12 gap-4">
//         <div className="md:col-span-4">
//           <label className="text-xs text-gray-600 block mb-1">Provider</label>
//           <select
//             name="provider"
//             value={normalizeProvider(formData.provider)}
//             onChange={handleProviderChange}
//             className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
//           >
//             {PROVIDERS.map(p => (
//               <option key={p.value} value={p.value}>
//                 {p.label}
//               </option>
//             ))}
//           </select>
//         </div>

//         <div className="md:col-span-4">
//           <label className="text-xs text-gray-600 block mb-1">
//             API URL (optional)
//           </label>
//           <input
//             type="text"
//             name="apiUrl"
//             value={formData.apiUrl}
//             onChange={handleChange}
//             placeholder="https://graph.facebook.com/v20.0 or provider URL"
//             className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
//           />
//         </div>

//         <div className="md:col-span-4">
//           <label className="text-xs text-gray-600 block mb-1">
//             {providerLabel}
//           </label>
//           <input
//             type="text"
//             name="apiKey"
//             value={formData.apiKey}
//             onChange={handleChange}
//             placeholder={providerLabel}
//             className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
//           />
//         </div>

//         <div className="md:col-span-4">
//           <label className="text-xs text-gray-600 block mb-1">
//             WABA ID (Meta only)
//           </label>
//           <input
//             type="text"
//             name="wabaId"
//             value={formData.wabaId}
//             onChange={handleChange}
//             placeholder="e.g. 123456789012345"
//             className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
//           />
//         </div>

//         <div className="md:col-span-4">
//           <label className="text-xs text-gray-600 block mb-1">
//             Sender Display Name (optional)
//           </label>
//           <input
//             type="text"
//             name="senderDisplayName"
//             value={formData.senderDisplayName}
//             onChange={handleChange}
//             placeholder="e.g. Acme Support"
//             className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
//           />
//         </div>

//         <div className="md:col-span-4">
//           <label className="text-xs text-gray-600 block mb-1">
//             Webhook Verify Token
//           </label>
//           <input
//             type="text"
//             name="webhookVerifyToken"
//             value={formData.webhookVerifyToken}
//             onChange={handleChange}
//             placeholder="verify-token"
//             className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
//           />
//         </div>

//         <div className="md:col-span-4">
//           <label className="text-xs text-gray-600 block mb-1">
//             Webhook Secret
//           </label>
//           <input
//             type="text"
//             name="webhookSecret"
//             value={formData.webhookSecret}
//             onChange={handleChange}
//             placeholder="secret"
//             className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
//           />
//         </div>

//         <div className="md:col-span-8">
//           <label className="text-xs text-gray-600 block mb-1">
//             Webhook Callback URL
//           </label>
//           <input
//             type="text"
//             name="webhookCallbackUrl"
//             value={formData.webhookCallbackUrl}
//             onChange={handleChange}
//             placeholder="https://example.com/api/webhooks/whatsapp"
//             className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
//           />
//         </div>

//         <div className="md:col-span-4 flex items-end">
//           <label className="inline-flex items-center gap-2 text-sm text-gray-700">
//             <input
//               type="checkbox"
//               name="isActive"
//               checked={!!formData.isActive}
//               onChange={handleToggle}
//               className="h-4 w-4"
//             />
//             Active
//           </label>
//         </div>
//       </div>

//       {/* SENDERS (phone numbers) */}
//       <div className="mt-8 border-t pt-6">
//         <div className="flex items-center justify-between mb-3">
//           <h3 className="text-sm font-semibold text-gray-700">
//             Senders (multiple numbers)
//           </h3>

//           <div className="flex gap-2">
//             {showFetchButton && (
//               <button
//                 type="button"
//                 onClick={handleFetchFromMeta}
//                 disabled={fetchingMeta}
//                 className={`px-3 py-1.5 rounded-md text-sm ${
//                   fetchingMeta
//                     ? "bg-gray-200 text-gray-500"
//                     : "bg-green-600 text-white hover:bg-green-700"
//                 }`}
//                 title="Fetch phone numbers from Meta / provider"
//               >
//                 {fetchingMeta ? "Fetching‚Ä¶" : "Fetch from Meta"}
//               </button>
//             )}
//             <button
//               type="button"
//               onClick={addSender}
//               className="px-3 py-1.5 rounded-md text-sm bg-gray-100 hover:bg-gray-200"
//             >
//               + Add number
//             </button>
//           </div>
//         </div>

//         {senders.length === 0 && (
//           <div className="text-xs text-gray-500 mb-2">
//             No senders yet. Use <b>Connect via Embedded Signup</b> to auto-sync
//             numbers, or click <b>+ Add number</b> to configure manually.
//           </div>
//         )}

//         <div className="space-y-3">
//           {senders.map((row, idx) => (
//             <div
//               key={idx}
//               className="grid grid-cols-1 md:grid-cols-12 gap-3 bg-gray-50 p-3 rounded"
//             >
//               <div className="md:col-span-3">
//                 <label className="text-xs text-gray-600 block mb-1">
//                   Label (optional)
//                 </label>
//                 <input
//                   type="text"
//                   value={row.label || ""}
//                   onChange={e => updateSender(idx, "label", e.target.value)}
//                   placeholder="e.g. Sales India"
//                   className="w-full px-3 py-1.5 border rounded-md text-sm border-gray-300"
//                 />
//               </div>

//               <div className="md:col-span-4">
//                 <label className="text-xs text-gray-600 block mb-1">
//                   WhatsApp Business Number
//                 </label>
//                 <input
//                   type="text"
//                   value={row.whatsAppBusinessNumber || ""}
//                   onChange={e =>
//                     updateSender(idx, "whatsAppBusinessNumber", e.target.value)
//                   }
//                   placeholder="+14150000001"
//                   className="w-full px-3 py-1.5 border rounded-md text-sm border-gray-300"
//                 />
//               </div>

//               <div className="md:col-span-4">
//                 <label className="text-xs text-gray-600 block mb-1">
//                   Phone Number ID
//                 </label>
//                 <input
//                   type="text"
//                   value={row.phoneNumberId || ""}
//                   onChange={e =>
//                     updateSender(idx, "phoneNumberId", e.target.value)
//                   }
//                   placeholder="1234567890"
//                   className="w-full px-3 py-1.5 border rounded-md text-sm border-gray-300"
//                 />
//               </div>

//               <div className="md:col-span-1 flex items-end gap-2 flex-wrap">
//                 <button
//                   type="button"
//                   onClick={async () => {
//                     try {
//                       const saved = await upsertNumber(formData.provider, row);
//                       setSenders(s =>
//                         s.map((r, i) =>
//                           i === idx ? { ...r, id: saved?.id || r.id } : r
//                         )
//                       );
//                       toast.success("Saved.");
//                     } catch {
//                       toast.error("Save failed.");
//                     }
//                   }}
//                   className="px-2 py-1 rounded text-xs bg-blue-600 text-white"
//                   title="Save this sender"
//                 >
//                   Save
//                 </button>

//                 <button
//                   type="button"
//                   onClick={async () => {
//                     try {
//                       if (!row.id) {
//                         removeSender(idx);
//                         return;
//                       }
//                       await deleteNumber(formData.provider, row.id);
//                       removeSender(idx);
//                       toast.success("Deleted.");
//                     } catch {
//                       toast.error("Delete failed.");
//                     }
//                   }}
//                   className="px-2 py-1 rounded text-xs bg-red-50 text-red-700"
//                   title="Remove"
//                 >
//                   ‚úï
//                 </button>

//                 <button
//                   type="button"
//                   onClick={async () => {
//                     try {
//                       if (!row.id) {
//                         const saved = await upsertNumber(
//                           formData.provider,
//                           row
//                         );
//                         await setDefaultNumber(formData.provider, saved?.id);
//                       } else {
//                         await setDefaultNumber(formData.provider, row.id);
//                       }
//                       setDefaultSender(idx);
//                       toast.success("Default set.");
//                     } catch {
//                       toast.error("Failed to set default.");
//                     }
//                   }}
//                   className={`px-2 py-1 rounded text-xs ${
//                     row.isDefault ? "bg-green-600 text-white" : "bg-gray-200"
//                   }`}
//                   title="Set as default sender"
//                 >
//                   {row.isDefault ? "Default" : "Make default"}
//                 </button>
//               </div>
//             </div>
//           ))}
//         </div>

//         <p className="text-[11px] text-gray-500 mt-2">
//           The <b>Default</b> sender will be used when no phone is chosen
//           explicitly while sending.
//         </p>
//       </div>

//       {testResult && (
//         <div className="mt-6">
//           <label className="text-xs text-gray-600 block mb-1">
//             Test Result
//           </label>
//           <pre className="text-xs bg-gray-50 border border-gray-200 p-3 rounded overflow-auto">
//             {testResult}
//           </pre>
//         </div>
//       )}
//     </div>
//   );
// }

// // üìÑ src/pages/Settings/WhatsAppSettings.jsx
// import React, { useState, useEffect, useMemo } from "react";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";

// // === Canonical providers (MUST match backend exactly) ===
// const PROVIDERS = [
//   { value: "PINNACLE", label: "PINNACLE" },
//   { value: "META_CLOUD", label: "META_CLOUD" },
// ];

// // --- BusinessId helper (unchanged) ---
// const TOKEN_KEY = "xbyte_token";
// const GUID_RE =
//   /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
// function getBusinessId() {
//   try {
//     const saved = localStorage.getItem("business_id");
//     if (saved && GUID_RE.test(saved)) return saved;

//     const jwt = localStorage.getItem(TOKEN_KEY);
//     if (!jwt) return null;
//     const [, payloadB64] = jwt.split(".");
//     if (!payloadB64) return null;
//     const payload = JSON.parse(
//       atob(payloadB64.replace(/-/g, "+").replace(/_/g, "/"))
//     );
//     const bid =
//       payload?.BusinessId ||
//       payload?.businessId ||
//       payload?.biz ||
//       payload?.bid ||
//       null;
//     return typeof bid === "string" && GUID_RE.test(bid) ? bid : null;
//   } catch {
//     return null;
//   }
// }

// // Map any input to UPPERCASE canonical values
// const normalizeProvider = p => {
//   const raw = (p ?? "").toString().trim();
//   if (!raw) return "PINNACLE";
//   const up = raw.toUpperCase();
//   if (up === "PINNACLE") return "PINNACLE";
//   if (
//     up === "META_CLOUD" ||
//     up === "META" ||
//     up === "METACLOUD" ||
//     up === "META-CLOUD"
//   )
//     return "META_CLOUD";
//   return "PINNACLE";
// };

// // UI label per provider (still binds to apiKey)
// const secretLabelFor = provider =>
//   normalizeProvider(provider) === "PINNACLE" ? "API Key" : "Token";

// // Initial blank form (GLOBAL SETTINGS ONLY ‚Äî no legacy number fields up here)
// const blank = {
//   provider: "PINNACLE",
//   apiUrl: "", // keep string (ApiUrl is NOT NULL on BE)
//   apiKey: "",
//   wabaId: "",
//   senderDisplayName: "",
//   webhookSecret: "",
//   webhookVerifyToken: "",
//   webhookCallbackUrl: "",
//   isActive: true,
// };

// export default function WhatsAppSettings() {
//   const [formData, setFormData] = useState(blank);
//   const [loading, setLoading] = useState(false);
//   const [saving, setSaving] = useState(false);
//   const [testing, setTesting] = useState(false);
//   const [testResult, setTestResult] = useState("");
//   const [senders, setSenders] = useState([]);
//   const [fetchingMeta, setFetchingMeta] = useState(false);
//   const [hasSavedOnce, setHasSavedOnce] = useState(false);
//   const [savedProvider, setSavedProvider] = useState(null); // ‚¨ÖÔ∏è NEW: track provider persisted in DB

//   const businessId = useMemo(getBusinessId, []);
//   const withBiz = (cfg = {}) =>
//     businessId
//       ? {
//           ...cfg,
//           headers: { ...(cfg.headers || {}), "X-Business-Id": businessId },
//         }
//       : cfg;

//   // ===== Numbers API helpers (DB-backed) =====
//   const listNumbers = async provider => {
//     const p = normalizeProvider(provider);
//     const { data } = await axiosClient.get(
//       `/whatsappsettings/${p}/numbers`,
//       withBiz()
//     );
//     return Array.isArray(data) ? data : [];
//   };

//   const upsertNumber = async (provider, row) => {
//     const p = normalizeProvider(provider);
//     const payload = {
//       phoneNumberId: (row.phoneNumberId || "").trim(),
//       whatsAppBusinessNumber: (row.whatsAppBusinessNumber || "").trim(),
//       senderDisplayName: (row.label || row.senderDisplayName || "").trim(),
//       isActive: row.isActive ?? true,
//       isDefault: !!row.isDefault,
//     };
//     const { data } = await axiosClient.post(
//       `/whatsappsettings/${p}/numbers`,
//       payload,
//       withBiz()
//     );
//     return data; // returns the saved row with id
//   };

//   const deleteNumber = async (provider, id) => {
//     const p = normalizeProvider(provider);
//     await axiosClient.delete(`/whatsappsettings/${p}/numbers/${id}`, withBiz());
//   };

//   const setDefaultNumber = async (provider, id) => {
//     const p = normalizeProvider(provider);
//     await axiosClient.patch(
//       `/whatsappsettings/${p}/numbers/${id}/default`,
//       null,
//       withBiz()
//     );
//   };

//   const fetchNumbers = async provider => {
//     try {
//       const items = await listNumbers(provider);
//       setSenders(
//         items.map(n => ({
//           id: n.id,
//           label: n.senderDisplayName || "",
//           phoneNumberId: n.phoneNumberId || "",
//           whatsAppBusinessNumber: n.whatsAppBusinessNumber || "",
//           isDefault: !!n.isDefault,
//           isActive: n.isActive ?? true,
//         }))
//       );
//     } catch {
//       // ignore; empty list is fine
//     }
//   };

//   // ===== Derived UI =====
//   const providerLabel = useMemo(
//     () => secretLabelFor(formData.provider),
//     [formData.provider]
//   );
//   const selectedProvider = useMemo(
//     () => normalizeProvider(formData.provider),
//     [formData.provider]
//   );

//   // Show "Fetch from Meta" once global settings exist (saved at least once)
//   const showFetchButton = hasSavedOnce;

//   // ===== Initial load of saved GLOBAL settings + initial numbers =====
//   useEffect(() => {
//     let mounted = true;
//     (async () => {
//       try {
//         setLoading(true);
//         const res = await axiosClient.get("/whatsappsettings/me", withBiz());
//         if (!mounted) return;
//         const data = res?.data ?? {};

//         const provider = normalizeProvider(data?.provider);
//         const secret = data?.apiKey || data?.apiToken || "";

//         setFormData(prev => ({
//           ...prev,
//           provider,
//           apiUrl: data?.apiUrl || "",
//           apiKey: secret,
//           wabaId: data?.wabaId || "",
//           senderDisplayName: data?.senderDisplayName || "",
//           webhookSecret: data?.webhookSecret || "",
//           webhookVerifyToken: data?.webhookVerifyToken || "",
//           webhookCallbackUrl: data?.webhookCallbackUrl || "",
//           isActive: data?.isActive ?? true,
//         }));

//         setSavedProvider(provider); // ‚¨ÖÔ∏è track what‚Äôs persisted

//         const existed =
//           !!data?.provider ||
//           !!data?.apiKey ||
//           !!data?.apiToken ||
//           !!data?.wabaId;
//         setHasSavedOnce(!!existed);

//         await fetchNumbers(provider);
//       } catch {
//         toast.info("‚ÑπÔ∏è No WhatsApp settings found. You can create them now.");
//         setHasSavedOnce(false);
//         setSavedProvider(null);
//       } finally {
//         mounted && setLoading(false);
//       }
//     })();
//     return () => {
//       mounted = false;
//     };
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, []);

//   // Refresh numbers when provider changes
//   useEffect(() => {
//     fetchNumbers(formData.provider);
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, [formData.provider]);

//   useEffect(() => {
//     const params = new URLSearchParams(window.location.search);
//     if (params.get("connected") === "1") {
//       (async () => {
//         try {
//           await handleFetchFromMeta(); // pulls & stores numbers
//           toast.success("Facebook connected. Numbers synced.");
//         } finally {
//           // drop the query param so refreshes don‚Äôt keep re-syncing
//           const url = new URL(window.location.href);
//           url.searchParams.delete("connected");
//           window.history.replaceState({}, "", url.toString());
//         }
//       })();
//     }
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, []);

//   // ===== Local mutations for sender rows =====
//   const addSender = () =>
//     setSenders(s => [
//       ...s,
//       {
//         label: "",
//         phoneNumberId: "",
//         whatsAppBusinessNumber: "",
//         isDefault: s.length === 0,
//         isActive: true,
//       },
//     ]);
//   const removeSender = idx => setSenders(s => s.filter((_, i) => i !== idx));
//   const updateSender = (idx, key, value) =>
//     setSenders(s =>
//       s.map((row, i) => (i === idx ? { ...row, [key]: value } : row))
//     );
//   const setDefaultSender = idx =>
//     setSenders(s => s.map((row, i) => ({ ...row, isDefault: i === idx })));

//   // ===== Global form handlers =====
//   const handleChange = e => {
//     const { name, value } = e.target;
//     setFormData(p => ({ ...p, [name]: value }));
//   };
//   const handleToggle = e => {
//     const { name, checked } = e.target;
//     setFormData(p => ({ ...p, [name]: checked }));
//   };
//   const handleProviderChange = e => {
//     const provider = normalizeProvider(e.target.value);
//     setFormData(p => ({ ...p, provider }));
//   };

//   // ===== Save global settings ONLY =====
//   const validateBeforeSave = () => {
//     if (!formData.apiKey.trim()) {
//       toast.error("API Key / Token is required.");
//       return false;
//     }
//     return true;
//   };

//   const handleSaveGlobal = async () => {
//     if (!validateBeforeSave()) return;
//     try {
//       setSaving(true);
//       const payload = {
//         provider: normalizeProvider(formData.provider),
//         apiUrl: (formData.apiUrl || "").trim(),
//         apiKey: (formData.apiKey || "").trim(),
//         wabaId: (formData.wabaId || "").trim() || null,
//         senderDisplayName: (formData.senderDisplayName || "").trim() || null,
//         webhookSecret: (formData.webhookSecret || "").trim() || null,
//         webhookVerifyToken: (formData.webhookVerifyToken || "").trim() || null,
//         webhookCallbackUrl: (formData.webhookCallbackUrl || "").trim() || null,
//         isActive: !!formData.isActive,
//       };
//       await axiosClient.put("/whatsappsettings/update", payload, withBiz());

//       setHasSavedOnce(true); // settings now exist
//       setSavedProvider(payload.provider); // ‚¨ÖÔ∏è keep in sync with DB

//       toast.success("Settings saved.");
//     } catch {
//       toast.error("Failed to save settings.");
//     } finally {
//       setSaving(false);
//     }
//   };

//   // ===== Test connection against SAVED settings (your /current endpoint) =====
//   const handleTest = async () => {
//     setTesting(true);
//     setTestResult("");
//     try {
//       const res = await axiosClient.post(
//         "/whatsappsettings/test-connection/current",
//         {},
//         withBiz()
//       );
//       setTestResult(JSON.stringify(res?.data ?? {}, null, 2));
//       toast.success(res?.data?.message || "Connection test complete.");
//     } catch (err) {
//       setTestResult(
//         JSON.stringify(err?.response?.data ?? { error: String(err) }, null, 2)
//       );
//       toast.error(err?.response?.data?.message || "Connection test failed.");
//     } finally {
//       setTesting(false);
//     }
//   };

//   // ===== Fetch numbers via saved provider ‚Üí backend sync ‚Üí refresh table =====
//   const handleFetchFromMeta = async () => {
//     // guardrails: most gateways need API key; WABA is needed for Meta and commonly for gateways
//     if (!formData.apiKey?.trim() || !formData.wabaId?.trim()) {
//       toast.warn(
//         "Please provide API Key/Token and WABA ID, then Save Settings."
//       );
//       return;
//     }
//     try {
//       setFetchingMeta(true);
//       const res = await axiosClient.post(
//         "/whatsappsettings/fetch-numbers",
//         {}, // server uses SAVED provider to choose the auth flow
//         withBiz()
//       );

//       // Use the provider bucket the SERVER actually wrote to
//       const serverBucket = normalizeProvider(res?.data?.provider);
//       const fallbackBucket = savedProvider || selectedProvider;
//       const bucket = serverBucket || fallbackBucket;

//       // Refresh that bucket
//       await fetchNumbers(bucket);

//       // Align dropdown so UI reflects the persisted bucket (prevents empty table confusion)
//       if (bucket && bucket !== selectedProvider) {
//         setFormData(p => ({ ...p, provider: bucket }));
//       }

//       const { added = 0, updated = 0, total = 0 } = res?.data || {};
//       toast.success(
//         `Synced ‚Äî added ${added}, updated ${updated}, total ${total} (${bucket}).`
//       );
//     } catch (err) {
//       const msg =
//         err?.response?.data?.message || err?.message || "Fetch failed.";
//       toast.error(msg);
//     } finally {
//       setFetchingMeta(false);
//     }
//   };

//   return (
//     <div className="max-w-5xl mx-auto px-4 py-6">
//       <div className="flex items-center justify-between mb-4">
//         <h1 className="text-xl font-semibold">WhatsApp Settings</h1>

//         <div className="flex gap-2">
//           <button
//             type="button"
//             onClick={handleSaveGlobal}
//             disabled={saving}
//             className={`px-4 py-2 rounded-md text-sm ${
//               saving
//                 ? "bg-gray-300"
//                 : "bg-blue-600 hover:bg-blue-700 text-white"
//             }`}
//             title="Save global settings only"
//           >
//             {saving ? "Saving‚Ä¶" : "Save Settings"}
//           </button>

//           <button
//             type="button"
//             onClick={handleTest}
//             disabled={testing}
//             className={`px-4 py-2 rounded-md text-sm ${
//               testing ? "bg-gray-300" : "bg-gray-100 hover:bg-gray-200"
//             }`}
//             title="Test connection using saved settings"
//           >
//             {testing ? "Testing‚Ä¶" : "Test Connection"}
//           </button>
//         </div>
//       </div>

//       {loading && (
//         <div className="text-sm text-gray-500 mb-4">Loading settings‚Ä¶</div>
//       )}

//       {/* GLOBAL provider-level settings ONLY */}
//       <div className="grid grid-cols-1 md:grid-cols-12 gap-4">
//         <div className="md:col-span-4">
//           <label className="text-xs text-gray-600 block mb-1">Provider</label>
//           <select
//             name="provider"
//             value={normalizeProvider(formData.provider)}
//             onChange={handleProviderChange}
//             className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
//           >
//             {PROVIDERS.map(p => (
//               <option key={p.value} value={p.value}>
//                 {p.label}
//               </option>
//             ))}
//           </select>
//         </div>

//         <div className="md:col-span-4">
//           <label className="text-xs text-gray-600 block mb-1">
//             API URL (optional)
//           </label>
//           <input
//             type="text"
//             name="apiUrl"
//             value={formData.apiUrl}
//             onChange={handleChange}
//             placeholder="https://graph.facebook.com/v22.0 or provider URL"
//             className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
//           />
//         </div>

//         <div className="md:col-span-4">
//           <label className="text-xs text-gray-600 block mb-1">
//             {providerLabel}
//           </label>
//           <input
//             type="text"
//             name="apiKey"
//             value={formData.apiKey}
//             onChange={handleChange}
//             placeholder={providerLabel}
//             className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
//           />
//         </div>

//         <div className="md:col-span-4">
//           <label className="text-xs text-gray-600 block mb-1">
//             WABA ID (Meta only)
//           </label>
//           <input
//             type="text"
//             name="wabaId"
//             value={formData.wabaId}
//             onChange={handleChange}
//             placeholder="e.g. 123456789012345"
//             className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
//           />
//         </div>

//         <div className="md:col-span-4">
//           <label className="text-xs text-gray-600 block mb-1">
//             Sender Display Name (optional)
//           </label>
//           <input
//             type="text"
//             name="senderDisplayName"
//             value={formData.senderDisplayName}
//             onChange={handleChange}
//             placeholder="e.g. Acme Support"
//             className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
//           />
//         </div>

//         <div className="md:col-span-4">
//           <label className="text-xs text-gray-600 block mb-1">
//             Webhook Verify Token
//           </label>
//           <input
//             type="text"
//             name="webhookVerifyToken"
//             value={formData.webhookVerifyToken}
//             onChange={handleChange}
//             placeholder="verify-token"
//             className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
//           />
//         </div>

//         <div className="md:col-span-4">
//           <label className="text-xs text-gray-600 block mb-1">
//             Webhook Secret
//           </label>
//           <input
//             type="text"
//             name="webhookSecret"
//             value={formData.webhookSecret}
//             onChange={handleChange}
//             placeholder="secret"
//             className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
//           />
//         </div>

//         <div className="md:col-span-8">
//           <label className="text-xs text-gray-600 block mb-1">
//             Webhook Callback URL
//           </label>
//           <input
//             type="text"
//             name="webhookCallbackUrl"
//             value={formData.webhookCallbackUrl}
//             onChange={handleChange}
//             placeholder="https://example.com/api/webhooks/whatsapp"
//             className="w-full px-3 py-2 border rounded-md text-sm border-gray-300"
//           />
//         </div>

//         <div className="md:col-span-4 flex items-end">
//           <label className="inline-flex items-center gap-2 text-sm text-gray-700">
//             <input
//               type="checkbox"
//               name="isActive"
//               checked={!!formData.isActive}
//               onChange={handleToggle}
//               className="h-4 w-4"
//             />
//             Active
//           </label>
//         </div>
//       </div>

//       {/* SENDERS (all phone numbers live here) */}
//       <div className="mt-8 border-t pt-6">
//         <div className="flex items-center justify-between mb-3">
//           <h3 className="text-sm font-semibold text-gray-700">
//             Senders (multiple numbers)
//           </h3>

//           <div className="flex gap-2">
//             {showFetchButton && (
//               <button
//                 type="button"
//                 onClick={handleFetchFromMeta}
//                 disabled={fetchingMeta}
//                 className={`px-3 py-1.5 rounded-md text-sm ${
//                   fetchingMeta
//                     ? "bg-gray-200 text-gray-500"
//                     : "bg-green-600 text-white hover:bg-green-700"
//                 }`}
//                 title="Fetch linked phone numbers"
//               >
//                 {fetchingMeta ? "Fetching‚Ä¶" : "Fetch from Meta"}
//               </button>
//             )}
//             <button
//               type="button"
//               onClick={addSender}
//               className="px-3 py-1.5 rounded-md text-sm bg-gray-100 hover:bg-gray-200"
//             >
//               + Add number
//             </button>
//           </div>
//         </div>

//         {senders.length === 0 && (
//           <div className="text-xs text-gray-500 mb-2">
//             No senders yet. Click <b>Fetch from Meta</b> or <b>+ Add number</b>{" "}
//             to add your first phone.
//           </div>
//         )}

//         <div className="space-y-3">
//           {senders.map((row, idx) => (
//             <div
//               key={idx}
//               className="grid grid-cols-1 md:grid-cols-12 gap-3 bg-gray-50 p-3 rounded"
//             >
//               <div className="md:col-span-3">
//                 <label className="text-xs text-gray-600 block mb-1">
//                   Label (optional)
//                 </label>
//                 <input
//                   type="text"
//                   value={row.label || ""}
//                   onChange={e => updateSender(idx, "label", e.target.value)}
//                   placeholder="e.g. Sales India"
//                   className="w-full px-3 py-1.5 border rounded-md text-sm border-gray-300"
//                 />
//               </div>

//               <div className="md:col-span-4">
//                 <label className="text-xs text-gray-600 block mb-1">
//                   WhatsApp Business Number
//                 </label>
//                 <input
//                   type="text"
//                   value={row.whatsAppBusinessNumber || ""}
//                   onChange={e =>
//                     updateSender(idx, "whatsAppBusinessNumber", e.target.value)
//                   }
//                   placeholder="+14150000001"
//                   className="w-full px-3 py-1.5 border rounded-md text-sm border-gray-300"
//                 />
//               </div>

//               <div className="md:col-span-4">
//                 <label className="text-xs text-gray-600 block mb-1">
//                   Phone Number ID
//                 </label>
//                 <input
//                   type="text"
//                   value={row.phoneNumberId || ""}
//                   onChange={e =>
//                     updateSender(idx, "phoneNumberId", e.target.value)
//                   }
//                   placeholder="1234567890"
//                   className="w-full px-3 py-1.5 border rounded-md text-sm border-gray-300"
//                 />
//               </div>

//               <div className="md:col-span-1 flex items-end gap-2 flex-wrap">
//                 <button
//                   type="button"
//                   onClick={async () => {
//                     try {
//                       const saved = await upsertNumber(formData.provider, row);
//                       setSenders(s =>
//                         s.map((r, i) =>
//                           i === idx ? { ...r, id: saved?.id || r.id } : r
//                         )
//                       );
//                       toast.success("Saved.");
//                     } catch {
//                       toast.error("Save failed.");
//                     }
//                   }}
//                   className="px-2 py-1 rounded text-xs bg-blue-600 text-white"
//                   title="Save this sender"
//                 >
//                   Save
//                 </button>

//                 <button
//                   type="button"
//                   onClick={async () => {
//                     try {
//                       if (!row.id) {
//                         removeSender(idx);
//                         return;
//                       }
//                       await deleteNumber(formData.provider, row.id);
//                       removeSender(idx);
//                       toast.success("Deleted.");
//                     } catch {
//                       toast.error("Delete failed.");
//                     }
//                   }}
//                   className="px-2 py-1 rounded text-xs bg-red-50 text-red-700"
//                   title="Remove"
//                 >
//                   ‚úï
//                 </button>

//                 <button
//                   type="button"
//                   onClick={async () => {
//                     try {
//                       if (!row.id) {
//                         const saved = await upsertNumber(
//                           formData.provider,
//                           row
//                         );
//                         await setDefaultNumber(formData.provider, saved?.id);
//                       } else {
//                         await setDefaultNumber(formData.provider, row.id);
//                       }
//                       setDefaultSender(idx);
//                       toast.success("Default set.");
//                     } catch {
//                       toast.error("Failed to set default.");
//                     }
//                   }}
//                   className={`px-2 py-1 rounded text-xs ${
//                     row.isDefault ? "bg-green-600 text-white" : "bg-gray-200"
//                   }`}
//                   title="Set as default sender"
//                 >
//                   {row.isDefault ? "Default" : "Make default"}
//                 </button>
//               </div>
//             </div>
//           ))}
//         </div>

//         <p className="text-[11px] text-gray-500 mt-2">
//           The <b>Default</b> sender will be used when no phone is chosen
//           explicitly while sending.
//         </p>
//       </div>

//       {testResult && (
//         <div className="mt-6">
//           <label className="text-xs text-gray-600 block mb-1">
//             Test Result
//           </label>
//           <pre className="text-xs bg-gray-50 border border-gray-200 p-3 rounded overflow-auto">
//             {testResult}
//           </pre>
//         </div>
//       )}
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Workspaces\AdminWorkspacePage.jsx 
====================================================== 
 
// üìÑ src/pages/Workspaces/AdminWorkspacePage.jsx
import {
  ShieldCheck,
  SquareStack,
  Archive,
  Pin,
  ArrowRightCircle,
  MoreVertical,
  AlertTriangle,
  BarChart3,
} from "lucide-react";
import { useNavigate } from "react-router-dom";
import { useState } from "react";
import { DragDropContext, Droppable, Draggable } from "react-beautiful-dnd";

import { useAuth } from "../../app/providers/AuthProvider";
import { FK } from "../../capabilities/featureKeys";

// map blocks ‚Üí permission codes (empty = no extra perm check)
const PERM_BY_BLOCK = {
  "business-approvals": [FK.ADMIN_BUSINESS_APPROVE],
  "feature-toggles": [],
  "plan-manager": [FK.ADMIN_PLANS_VIEW],
  "plan-feature-mapping": [FK.ADMIN_PLANS_VIEW],
  "test-trigger": [FK?.AUTOMATION_TRIGGER_TEST],
  "esu-debug": [],

  "account-insights": [FK.ADMIN_ACCOUNT_INSIGHTS_VIEW],
  "account-insights-reports": [FK.ADMIN_ACCOUNT_REPORTS_VIEW],
};

const allAdminBlocks = [
  {
    id: "business-approvals",
    label: "Business Approvals",
    description: "Approve or reject pending business signups.",
    path: "/app/admin/approvals",
    icon: <ShieldCheck className="text-green-600" size={22} />,
    action: "Review Requests",
    roles: ["superadmin", "partner", "reseller", "admin"],
  },
  {
    id: "feature-toggles",
    label: "Feature Toggles",
    description: "Enable or disable features for your platform.",
    path: "/app/admin/features",
    icon: <SquareStack className="text-blue-500" size={22} />,
    action: "Open Toggles",
    roles: ["superadmin", "admin", "business", "business owner"],
  },
  {
    id: "plan-manager",
    label: "Plan Manager",
    description: "Define feature limits for each plan tier.",
    path: "/app/admin/plans",
    icon: <SquareStack className="text-purple-500" size={22} />,
    action: "Manage Plans",
    roles: ["superadmin", "admin"],
  },
  {
    id: "plan-feature-mapping",
    label: "Plan ‚Üí Feature Mapping",
    description: "Assign features (permissions) to each subscription plan.",
    path: "/app/admin/plan-feature-mapping",
    icon: <SquareStack className="text-purple-500" size={22} />,
    action: "Manage Mapping",
    roles: ["superadmin", "admin"],
  },
  {
    id: "test-trigger",
    label: "Trigger Tester",
    description: "Simulate CTA button clicks to test automation logic.",
    path: "/app/devtools/cta-tester",
    icon: <ShieldCheck className="text-green-500" size={22} />,
    action: "Run Test",
  },
  {
    id: "esu-debug",
    label: "FB Embedded Signup Debug",
    description:
      "Inspect ESU tokens/flags and locally deauthorize a workspace (dev / superadmin only).",
    path: "/app/devtools/esu-debug",
    icon: <ShieldCheck className="text-amber-500" size={22} />,
    action: "Open ESU Debug",
    roles: ["superadmin"], // only superadmins see it
  },
  {
    id: "account-insights",
    label: "Account Insights",
    description:
      "Track signup ‚Üí activation ‚Üí WhatsApp setup ‚Üí paid conversion across all accounts.",
    path: "/app/admin/account-insights",
    icon: <BarChart3 className="text-purple-600" size={22} />,
    action: "View Insights",
    roles: ["superadmin", "admin"],
  },

  {
    id: "account-insights-reports",
    label: "Account Reports",
    description:
      "Detailed lifecycle, trial, and risk reports with drilldowns and exports.",
    path: "/app/admin/account-insights/account-reports",
    icon: <BarChart3 className="text-slate-700" size={22} />,
    action: "Open Reports",
    roles: ["superadmin", "admin"],
  },
];

export default function AdminWorkspacePage() {
  const navigate = useNavigate();
  const { role, hasAllAccess, can, isLoading } = useAuth();
  const userRole = String(role || "").toLowerCase();

  const [pinned, setPinned] = useState(
    JSON.parse(localStorage.getItem("admin-pinned") || "[]")
  );
  const [archived, setArchived] = useState(
    JSON.parse(localStorage.getItem("admin-archived") || "[]")
  );
  const [order, setOrder] = useState(
    JSON.parse(localStorage.getItem("admin-order")) ||
      allAdminBlocks.map(b => b.id)
  );

  const togglePin = (e, id) => {
    e.stopPropagation();
    const updated = pinned.includes(id)
      ? pinned.filter(i => i !== id)
      : [...pinned, id];
    setPinned(updated);
    localStorage.setItem("admin-pinned", JSON.stringify(updated));
  };

  const toggleArchive = (e, id) => {
    e.stopPropagation();
    const updated = archived.includes(id)
      ? archived.filter(i => i !== id)
      : [...archived, id];
    setArchived(updated);
    localStorage.setItem("admin-archived", JSON.stringify(updated));
  };

  const onDragEnd = result => {
    if (!result.destination) return;
    const newOrder = Array.from(order);
    const [moved] = newOrder.splice(result.source.index, 1);
    newOrder.splice(result.destination.index, 0, moved);
    setOrder(newOrder);
    localStorage.setItem("admin-order", JSON.stringify(newOrder));
  };

  const canAny = codes =>
    hasAllAccess ||
    (codes || []).length === 0 ||
    (codes || []).some(code => can(code));

  const roleOk = block =>
    hasAllAccess ||
    !Array.isArray(block.roles) ||
    block.roles.map(r => String(r).toLowerCase()).includes(userRole);

  const isAllowed = block => roleOk(block) && canAny(PERM_BY_BLOCK[block.id]);

  const visibleBlocks = order
    .map(id => allAdminBlocks.find(b => b.id === id))
    .filter(Boolean)
    .filter(b => !archived.includes(b.id))
    .filter(isAllowed);

  if (isLoading) {
    return (
      <div className="p-10 text-center text-lg text-gray-500">
        Loading admin tools‚Ä¶
      </div>
    );
  }

  return (
    <div className="p-6">
      {/* sequential border animation (top‚Üíright‚Üíbottom‚Üíleft) with gray‚Üídark gray‚Üívery-light purple */}
      <style>{`
        @keyframes drawRight { from { transform: scaleX(0) } to { transform: scaleX(1) } }
        @keyframes drawDown  { from { transform: scaleY(0) } to { transform: scaleY(1) } }
        @keyframes drawLeft  { from { transform: scaleX(0) } to { transform: scaleX(1) } }
        @keyframes drawUp    { from { transform: scaleY(0) } to { transform: scaleY(1) } }

        .tile:hover .topline    { animation: drawRight .9s ease forwards; }
        .tile:hover .rightline  { animation: drawDown  .9s ease .18s forwards; }
        .tile:hover .bottomline { animation: drawLeft  .9s ease .36s forwards; }
        .tile:hover .leftline   { animation: drawUp    .9s ease .54s forwards; }
      `}</style>

      <h2 className="text-2xl font-bold text-purple-800 mb-4">
        üõ° Admin Workspace
      </h2>

      {!visibleBlocks.length && (
        <div className="bg-red-100 text-red-700 p-4 border-l-4 border-red-500 rounded-md mb-6 shadow-sm flex items-start gap-3">
          <AlertTriangle size={22} className="mt-1" />
          <div>
            <strong>Restricted:</strong> You don‚Äôt have admin permissions to
            access these tools.
            <div className="text-sm mt-1 text-gray-600">
              Contact your administrator if this is a mistake.
            </div>
          </div>
        </div>
      )}

      {visibleBlocks.length > 0 && (
        <DragDropContext onDragEnd={onDragEnd}>
          <Droppable droppableId="admin-blocks" direction="horizontal">
            {provided => (
              <div
                className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"
                ref={provided.innerRef}
                {...provided.droppableProps}
              >
                {visibleBlocks.map((block, index) => (
                  <Draggable
                    key={block.id}
                    draggableId={block.id}
                    index={index}
                  >
                    {provided => (
                      <div
                        ref={provided.innerRef}
                        {...provided.draggableProps}
                        role="button"
                        tabIndex={0}
                        aria-label={`${block.label}: ${block.action}`}
                        onKeyDown={e => {
                          if (e.key === "Enter") navigate(block.path);
                        }}
                        onClick={() => navigate(block.path)}
                        className="tile group relative overflow-hidden cursor-pointer bg-white rounded-md border shadow-sm hover:shadow-md transition transform hover:-translate-y-0.5 duration-200 focus:outline-none focus:ring-2 focus:ring-purple-300"
                        style={{ userSelect: "none" }}
                      >
                        {/* animated border segments */}
                        <span
                          aria-hidden
                          className="topline pointer-events-none absolute left-0 -top-[2px] h-[2px] w-full origin-left rounded opacity-0 group-hover:opacity-100"
                          style={{
                            background:
                              "linear-gradient(90deg, #6B7280, #374151, #F3E8FF)",
                            transform: "scaleX(0)",
                          }}
                        />
                        <span
                          aria-hidden
                          className="rightline pointer-events-none absolute right-0 -top-[2px] h-[calc(100%+4px)] w-[2px] origin-top rounded opacity-0 group-hover:opacity-100"
                          style={{
                            background:
                              "linear-gradient(180deg, #6B7280, #374151, #F3E8FF)",
                            transform: "scaleY(0)",
                          }}
                        />
                        <span
                          aria-hidden
                          className="bottomline pointer-events-none absolute left-0 -bottom-[2px] h-[2px] w-full origin-right rounded opacity-0 group-hover:opacity-100"
                          style={{
                            background:
                              "linear-gradient(270deg, #6B7280, #374151, #F3E8FF)",
                            transform: "scaleX(0)",
                          }}
                        />
                        <span
                          aria-hidden
                          className="leftline pointer-events-none absolute left-0 -top-[2px] h-[calc(100%+4px)] w-[2px] origin-bottom rounded opacity-0 group-hover:opacity-100"
                          style={{
                            background:
                              "linear-gradient(0deg, #6B7280, #374151, #F3E8FF)",
                            transform: "scaleY(0)",
                          }}
                        />

                        {/* content */}
                        <div className="flex items-start gap-4 p-5">
                          <div className="bg-gray-100 rounded-md p-2">
                            {block.icon}
                          </div>
                          <div className="flex-1">
                            <h3 className="text-md font-semibold text-purple-700">
                              {block.label}
                            </h3>
                            <p className="text-sm text-gray-600">
                              {block.description}
                            </p>
                          </div>

                          {/* kebab = the ONLY drag handle */}
                          <div
                            {...provided.dragHandleProps}
                            title="Drag to re-order"
                            className="ml-2 rounded p-1 text-gray-400 hover:text-gray-600 cursor-grab active:cursor-grabbing"
                            onClick={e => e.stopPropagation()}
                          >
                            <MoreVertical size={16} />
                          </div>
                        </div>

                        <div className="px-5 py-3 border-t border-gray-200 flex items-center justify-between">
                          <button
                            onClick={e => {
                              e.stopPropagation();
                              navigate(block.path);
                            }}
                            className="text-sm text-purple-600 font-medium flex items-center gap-1 hover:text-purple-800"
                          >
                            {block.action} <ArrowRightCircle size={18} />
                          </button>
                          <div className="flex items-center gap-3">
                            <button
                              onClick={e => togglePin(e, block.id)}
                              title="Pin this"
                            >
                              <Pin
                                size={18}
                                className={
                                  pinned.includes(block.id)
                                    ? "text-red-600"
                                    : "text-gray-400 hover:text-red-500"
                                }
                              />
                            </button>
                            <button
                              onClick={e => toggleArchive(e, block.id)}
                              title="Archive this"
                            >
                              <Archive
                                size={18}
                                className={
                                  archived.includes(block.id)
                                    ? "text-indigo-600"
                                    : "text-gray-400 hover:text-indigo-500"
                                }
                              />
                            </button>
                          </div>
                        </div>
                      </div>
                    )}
                  </Draggable>
                ))}
                {provided.placeholder}
              </div>
            )}
          </Droppable>
        </DragDropContext>
      )}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Workspaces\AutomationWorkspace.jsx 
====================================================== 
 
// // üìÑ src/pages/Workspaces/AutomationWorkspace.jsx

// import {
//   MessageCircleHeart,
//   RefreshCcw,
//   ShieldCheck,
//   MessageSquareText,
//   ArrowRightCircle,
//   MoreVertical,
//   Archive,
//   Pin,
//   FileBarChart,
// } from "lucide-react";
// import { useNavigate } from "react-router-dom";
// import { useMemo, useState } from "react";
// import { DragDropContext, Droppable, Draggable } from "react-beautiful-dnd";

// // ‚úÖ server-authoritative perms
// import { useAuth } from "../../app/providers/AuthProvider";
// // ‚úÖ centralized capability keys
// import { FK } from "../../capabilities/featureKeys";

// // Map blocks ‚Üí permission codes (covers Automation + Flow)

// const PERM_BY_BLOCK = {
//   "create-template-flow": [FK?.AUTOMATION_CREATE_TEMPLATE_FLOW],
//   "create-auto-reply-bot": [FK?.AUTOMATION_CREATE_TEMPLATE_PLUS_FREE_TEXT_FLOW],
//   "flow-manager": [FK?.AUTOMATION_VIEW_TEMPLATE_FLOW_MANGE],

//   "flow-analytics": [FK?.AUTOMATION_VIEW_TEMPLATE_PLUS_FREETEXT_FLOW_ANALYTICS],
//   "test-trigger": [FK?.AUTOMATION_TRIGGER_TEST],
// };
// const automationBlocks = [
//   {
//     id: "create-template-flow",
//     label: "Create Template Flow",
//     description: "Visually design the flow using a drag-and-drop builder.",
//     path: "/app/cta-flow/visual-builder",
//     icon: <RefreshCcw className="text-indigo-500" size={22} />,
//     action: "Create Template Flow",
//   },

//   {
//     id: "create-auto-reply-bot",
//     label: "Create Auto Reply Bot",
//     description:
//       "Design an automated bot to reply to specific keywords, triggers or contacts.",
//     path: "/app/automation/auto-reply-builder",
//     icon: <MessageCircleHeart className="text-purple-600" size={22} />,
//     action: "Create Bot",
//   },
//   {
//     id: "flow-manager",
//     label: "Flow Manager",
//     description: "Organize and manage all auto-reply flows.",
//     path: "/app/cta-flow/flow-manager",
//     icon: <MessageSquareText className="text-green-600" size={22} />,
//     action: "Flow Manager",
//   },

//   {
//     id: "flow-analytics",
//     label: "Flow Analytics",
//     description: "Analyze visual flows and CTA button performance.",
//     path: "/app/campaigns/FlowAnalyticsDashboard",
//     icon: <FileBarChart className="text-teal-600" size={22} />,
//     action: "Open Dashboard",
//   },
//   {
//     id: "test-trigger",
//     label: "Trigger Tester",
//     description: "Simulate CTA button clicks to test automation logic.",
//     path: "/app/devtools/cta-tester",
//     icon: <ShieldCheck className="text-green-500" size={22} />,
//     action: "Run Test",
//   },
// ];

// export default function AutomationWorkspace() {
//   const navigate = useNavigate();
//   const { isLoading, can, hasAllAccess } = useAuth();

//   // --- LocalStorage keys stay under "automation-*"
//   const [pinned, setPinned] = useState(
//     JSON.parse(localStorage.getItem("automation-pinned") || "[]")
//   );
//   const [archived, setArchived] = useState(
//     JSON.parse(localStorage.getItem("automation-archived") || "[]")
//   );

//   // Seed order with all current block ids; if user has an older order saved,
//   // reconcile so new tiles appear at the end.
//   const allIds = useMemo(() => automationBlocks.map(b => b.id), []);
//   const storedOrder =
//     JSON.parse(localStorage.getItem("automation-order") || "null") || [];
//   const initialOrder = useMemo(() => {
//     if (!Array.isArray(storedOrder) || storedOrder.length === 0) return allIds;
//     const known = storedOrder.filter(id => allIds.includes(id));
//     const missing = allIds.filter(id => !known.includes(id));
//     return [...known, ...missing];
//   }, [allIds]); // eslint-disable-line react-hooks/exhaustive-deps

//   const [order, setOrder] = useState(initialOrder);
//   const [showArchived, setShowArchived] = useState(false);

//   const togglePin = id => {
//     const updated = pinned.includes(id)
//       ? pinned.filter(i => i !== id)
//       : [...pinned, id];
//     setPinned(updated);
//     localStorage.setItem("automation-pinned", JSON.stringify(updated));
//   };

//   const toggleArchive = id => {
//     const updated = archived.includes(id)
//       ? archived.filter(i => i !== id)
//       : [...archived, id];
//     setArchived(updated);
//     localStorage.setItem("automation-archived", JSON.stringify(updated));
//   };

//   const onDragEnd = result => {
//     if (!result.destination) return;
//     const newOrder = Array.from(order);
//     const [moved] = newOrder.splice(result.source.index, 1);
//     newOrder.splice(result.destination.index, 0, moved);
//     setOrder(newOrder);
//     localStorage.setItem("automation-order", JSON.stringify(newOrder));
//   };

//   const canAny = codes => hasAllAccess || (codes || []).some(code => can(code));

//   const visibleBlocks = order
//     .map(id => automationBlocks.find(b => b.id === id))
//     .filter(Boolean)
//     .filter(b => (showArchived ? true : !archived.includes(b.id)))
//     .filter(b => canAny(PERM_BY_BLOCK[b.id]));

//   if (isLoading)
//     return (
//       <div className="p-10 text-center text-lg text-gray-500">
//         Loading features‚Ä¶
//       </div>
//     );

//   return (
//     <div className="p-6">
//       <div className="flex justify-between items-center mb-4">
//         <h2 className="text-2xl font-bold text-purple-800">
//           ü§ñ Automation Workspace
//         </h2>
//         <label className="flex items-center gap-2 text-sm text-gray-700">
//           <input
//             type="checkbox"
//             checked={showArchived}
//             onChange={() => setShowArchived(!showArchived)}
//             className="accent-purple-600"
//           />
//           Show Archived Tools
//         </label>
//       </div>

//       <DragDropContext onDragEnd={onDragEnd}>
//         <Droppable droppableId="automation-blocks" direction="horizontal">
//           {provided => (
//             <div
//               className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"
//               ref={provided.innerRef}
//               {...provided.droppableProps}
//             >
//               {visibleBlocks.map((block, index) => (
//                 <Draggable key={block.id} draggableId={block.id} index={index}>
//                   {provided => (
//                     <div
//                       ref={provided.innerRef}
//                       {...provided.draggableProps}
//                       {...provided.dragHandleProps}
//                       className="bg-white rounded-md border shadow-sm hover:shadow-md transition transform hover:-translate-y-0.5 duration-200"
//                     >
//                       <div className="flex items-start gap-4 p-5">
//                         <div className="bg-gray-100 rounded-md p-2">
//                           {block.icon}
//                         </div>
//                         <div className="flex-1">
//                           <h3 className="text-md font-semibold text-purple-700">
//                             {block.label}
//                           </h3>
//                           <p className="text-sm text-gray-600">
//                             {block.description}
//                           </p>
//                         </div>
//                         <MoreVertical size={16} className="text-gray-400" />
//                       </div>
//                       <div className="px-5 py-3 border-t border-gray-200 flex items-center justify-between">
//                         <button
//                           onClick={() => navigate(block.path)}
//                           className="text-sm text-purple-600 font-medium flex items-center gap-1 hover:text-purple-800"
//                         >
//                           {block.action} <ArrowRightCircle size={18} />
//                         </button>
//                         <div className="flex items-center gap-3">
//                           <button
//                             onClick={() => togglePin(block.id)}
//                             title="Pin this"
//                           >
//                             <Pin
//                               size={18}
//                               className={
//                                 pinned.includes(block.id)
//                                   ? "text-red-600"
//                                   : "text-gray-400 hover:text-red-500"
//                               }
//                             />
//                           </button>
//                           <button
//                             onClick={() => toggleArchive(block.id)}
//                             title="Archive this"
//                           >
//                             <Archive
//                               size={18}
//                               className={
//                                 archived.includes(block.id)
//                                   ? "text-indigo-600"
//                                   : "text-gray-400 hover:text-indigo-500"
//                               }
//                             />
//                           </button>
//                         </div>
//                       </div>
//                     </div>
//                   )}
//                 </Draggable>
//               ))}
//               {provided.placeholder}
//             </div>
//           )}
//         </Droppable>
//       </DragDropContext>
//     </div>
//   );
// }
// üìÑ src/pages/Workspaces/AutomationWorkspace.jsx

import {
  MessageCircleHeart,
  RefreshCcw,
  MessageSquareText,
  ArrowRightCircle,
  MoreVertical,
  Archive,
  Pin,
  FileBarChart,
} from "lucide-react";
import { useNavigate } from "react-router-dom";
import { useMemo, useState } from "react";
import { DragDropContext, Droppable, Draggable } from "react-beautiful-dnd";

// ‚úÖ server-authoritative perms
import { useAuth } from "../../app/providers/AuthProvider";
// ‚úÖ centralized capability keys
import { FK } from "../../capabilities/featureKeys";

/* ---------- Permissions map ---------- */
const PERM_BY_BLOCK = {
  "create-template-flow": [FK?.AUTOMATION_CREATE_TEMPLATE_FLOW],
  "create-auto-reply-bot": [FK?.AUTOMATION_CREATE_TEMPLATE_PLUS_FREE_TEXT_FLOW],
  "flow-manager": [FK?.AUTOMATION_VIEW_TEMPLATE_FLOW_MANGE],
  "flow-analytics": [FK?.AUTOMATION_VIEW_TEMPLATE_PLUS_FREETEXT_FLOW_ANALYTICS],
};

/* ---------- Tiles ---------- */
const automationBlocks = [
  {
    id: "create-template-flow",
    label: "Create Template Flow",
    description: "Visually design the flow using a drag-and-drop builder.",
    path: "/app/cta-flow/visual-builder",
    icon: <RefreshCcw className="text-emerald-800" size={22} />,
    action: "Create Template Flow",
  },
  {
    id: "create-auto-reply-bot",
    label: "Create Auto Reply Bot",
    description:
      "Design an automated bot to reply to specific keywords, triggers or contacts.",
    path: "/app/automation/auto-reply-builder",
    icon: <MessageCircleHeart className="text-emerald-800" size={22} />,
    action: "Create Bot",
  },
  {
    id: "flow-manager",
    label: "Flow Manager",
    description: "Organize and manage all auto-reply flows.",
    path: "/app/cta-flow/flow-manager",
    icon: <MessageSquareText className="text-emerald-800" size={22} />,
    action: "Flow Manager",
  },
  {
    id: "flow-analytics",
    label: "Flow Analytics",
    description: "Analyze visual flows and CTA button performance.",
    path: "/app/campaigns/FlowAnalyticsDashboard",
    icon: <FileBarChart className="text-emerald-800" size={22} />,
    action: "Open Dashboard",
  },
];

export default function AutomationWorkspace() {
  const navigate = useNavigate();
  const { isLoading, can, hasAllAccess } = useAuth();

  // --- LocalStorage keys under "automation-*"
  const [pinned, setPinned] = useState(
    JSON.parse(localStorage.getItem("automation-pinned") || "[]")
  );
  const [archived, setArchived] = useState(
    JSON.parse(localStorage.getItem("automation-archived") || "[]")
  );

  // Seed order with all current ids; reconcile with any saved order
  const allIds = useMemo(() => automationBlocks.map(b => b.id), []);
  const storedOrder =
    JSON.parse(localStorage.getItem("automation-order") || "null") || [];
  const initialOrder = useMemo(() => {
    if (!Array.isArray(storedOrder) || storedOrder.length === 0) return allIds;
    const known = storedOrder.filter(id => allIds.includes(id));
    const missing = allIds.filter(id => !known.includes(id));
    return [...known, ...missing];
  }, [allIds]); // eslint-disable-line react-hooks/exhaustive-deps

  const [order, setOrder] = useState(initialOrder);
  const [showArchived, setShowArchived] = useState(false);

  const togglePin = (e, id) => {
    e.stopPropagation();
    const updated = pinned.includes(id)
      ? pinned.filter(i => i !== id)
      : [...pinned, id];
    setPinned(updated);
    localStorage.setItem("automation-pinned", JSON.stringify(updated));
  };

  const toggleArchive = (e, id) => {
    e.stopPropagation();
    const updated = archived.includes(id)
      ? archived.filter(i => i !== id)
      : [...archived, id];
    setArchived(updated);
    localStorage.setItem("automation-archived", JSON.stringify(updated));
  };

  const onDragEnd = result => {
    if (!result.destination) return;
    const newOrder = Array.from(order);
    const [moved] = newOrder.splice(result.source.index, 1);
    newOrder.splice(result.destination.index, 0, moved);
    setOrder(newOrder);
    localStorage.setItem("automation-order", JSON.stringify(newOrder));
  };

  const canAny = codes => hasAllAccess || (codes || []).some(code => can(code));

  const visibleBlocks = order
    .map(id => automationBlocks.find(b => b.id === id))
    .filter(Boolean)
    .filter(b => (showArchived ? true : !archived.includes(b.id)))
    .filter(b => canAny(PERM_BY_BLOCK[b.id]));

  if (isLoading)
    return (
      <div className="p-10 text-center text-lg text-gray-500">
        Loading features‚Ä¶
      </div>
    );

  return (
    <div className="p-6">
      {/* Local CSS: animated border; standard pointer so system hand color is unchanged */}
      <style>{`
        @keyframes drawRight { from { transform: scaleX(0) } to { transform: scaleX(1) } }
        @keyframes drawDown  { from { transform: scaleY(0) } to { transform: scaleY(1) } }
        @keyframes drawLeft  { from { transform: scaleX(0) } to { transform: scaleX(1) } }
        @keyframes drawUp    { from { transform: scaleY(0) } to { transform: scaleY(1) } }

        .tile:hover .topline    { animation: drawRight .9s ease forwards; }
        .tile:hover .rightline  { animation: drawDown  .9s ease .18s forwards; }
        .tile:hover .bottomline { animation: drawLeft  .9s ease .36s forwards; }
        .tile:hover .leftline   { animation: drawUp    .9s ease .54s forwards; }

        /* Keep system cursor style/color */
        .cursor-finger { cursor: pointer; }
      `}</style>

      <div className="flex justify-between items-center mb-4">
        <h2 className="text-2xl font-bold text-emerald-800">
          ü§ñ Automation Workspace
        </h2>
        <label className="flex items-center gap-2 text-sm text-black">
          <input
            type="checkbox"
            checked={showArchived}
            onChange={() => setShowArchived(!showArchived)}
            className="accent-purple-600"
          />
          Show Archived Tools
        </label>
      </div>

      <DragDropContext onDragEnd={onDragEnd}>
        <Droppable droppableId="automation-blocks" direction="horizontal">
          {provided => (
            <div
              className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"
              ref={provided.innerRef}
              {...provided.droppableProps}
            >
              {visibleBlocks.map((block, index) => (
                <Draggable key={block.id} draggableId={block.id} index={index}>
                  {provided => (
                    <div
                      ref={provided.innerRef}
                      {...provided.draggableProps}
                      {...provided.dragHandleProps}
                      role="button"
                      tabIndex={0}
                      aria-label={`${block.label}: ${block.action}`}
                      onKeyDown={e => {
                        if (e.key === "Enter") navigate(block.path);
                      }}
                      onClick={() => navigate(block.path)}
                      className="tile group relative overflow-hidden rounded-md border bg-white shadow-sm transition duration-200 hover:-translate-y-0.5 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-purple-300 cursor-finger"
                    >
                      {/* Animated border (top ‚Üí right ‚Üí bottom ‚Üí left) */}
                      <span
                        aria-hidden
                        className="topline pointer-events-none absolute left-0 -top-[2px] h-[2px] w-full origin-left rounded opacity-0 group-hover:opacity-100"
                        style={{
                          background:
                            "linear-gradient(90deg, #374151, #D1D5DB, #F3E8FF)",
                          transform: "scaleX(0)",
                        }}
                      />
                      <span
                        aria-hidden
                        className="rightline pointer-events-none absolute right-0 -top-[2px] h-[calc(100%+4px)] w-[2px] origin-top rounded opacity-0 group-hover:opacity-100"
                        style={{
                          background:
                            "linear-gradient(180deg, #374151, #D1D5DB, #F3E8FF)",
                          transform: "scaleY(0)",
                        }}
                      />
                      <span
                        aria-hidden
                        className="bottomline pointer-events-none absolute left-0 -bottom-[2px] h-[2px] w-full origin-right rounded opacity-0 group-hover:opacity-100"
                        style={{
                          background:
                            "linear-gradient(270deg, #374151, #D1D5DB, #F3E8FF)",
                          transform: "scaleX(0)",
                        }}
                      />
                      <span
                        aria-hidden
                        className="leftline pointer-events-none absolute left-0 -top-[2px] h-[calc(100%+4px)] w-[2px] origin-bottom rounded opacity-0 group-hover:opacity-100"
                        style={{
                          background:
                            "linear-gradient(0deg, #374151, #D1D5DB, #F3E8FF)",
                          transform: "scaleY(0)",
                        }}
                      />

                      {/* Card body */}
                      <div className="flex items-start gap-4 p-5">
                        <div className="bg-emerald-50 rounded-md p-2">
                          {block.icon}
                        </div>
                        <div className="flex-1 min-w-0">
                          <h3 className="text-md font-semibold text-emerald-800 truncate group-hover:text-emerald-900">
                            {block.label}
                          </h3>
                          <p className="text-sm text-slate-600">
                            {block.description}
                          </p>
                        </div>
                        <MoreVertical size={16} className="text-gray-400" />
                      </div>

                      {/* Footer */}
                      <div className="px-5 py-3 border-t border-gray-200 flex items-center justify-between">
                        <button
                          onClick={e => {
                            e.stopPropagation();
                            navigate(block.path);
                          }}
                          className="text-sm text-gray-700 font-medium flex items-center gap-1 hover:text-gray-900"
                        >
                          {block.action} <ArrowRightCircle size={18} />
                        </button>

                        <div className="flex items-center gap-3">
                          <button
                            onClick={e => togglePin(e, block.id)}
                            title="Pin this"
                          >
                            <Pin
                              size={18}
                              className={
                                pinned.includes(block.id)
                                  ? "text-red-600"
                                  : "text-gray-400 hover:text-red-500"
                              }
                            />
                          </button>
                          <button
                            onClick={e => toggleArchive(e, block.id)}
                            title="Archive this"
                          >
                            <Archive
                              size={18}
                              className={
                                archived.includes(block.id)
                                  ? "text-indigo-600"
                                  : "text-gray-400 hover:text-indigo-500"
                              }
                            />
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                </Draggable>
              ))}
              {provided.placeholder}
            </div>
          )}
        </Droppable>
      </DragDropContext>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Workspaces\CampaignWorkspacePage.jsx 
====================================================== 
 
import {
  ListChecks,
  FolderKanban,
  PlusCircle,
  Archive,
  Pin,
  ArrowRightCircle,
  MoreVertical,
  FileBarChart,
  Image,
  ImagePlus,
  MessageSquareText,
} from "lucide-react";
import { useNavigate } from "react-router-dom";
import { useState } from "react";
import { DragDropContext, Draggable, Droppable } from "react-beautiful-dnd";

import { useAuth } from "../../app/providers/AuthProvider";
import { FK } from "../../capabilities/featureKeys";

// map UI blocks ‚Üí required permissions
const PERM_BY_BLOCK = {
  "campaign-table": [FK.CAMPAIGN_VIEW],
  "status-logs": [FK.CAMPAIGN_VIEW],
  "image-campaign-list": [FK.CAMPAIGN_VIEW],
  "image-assign-contact": [FK.CAMPAIGN_VIEW],
  "template-campainlist": [FK.CAMPAIGN_CREATE],
  "template-campaign-list": [FK.CAMPAIGN_VIEW],
  "send-template-msg": [FK.CAMPAIGN_CREATE],
  "campaign-builder": [FK.CAMPAIGN_CREATE],
  "campaign-send-template-simple": [FK.CAMPAIGN_SEND_TEMPLATE_SIMPLE],
  "campaign-tracking-logs": [FK.CAMPAIGN_TRACKING_LOGS_VIEW],
  TrackingViewer: [FK.CAMPAIGN_VIEW],
};

const campaignBlocks = [
  {
    id: "campaign-builder",
    label: "Campaign Builder ",
    description: "Create campaign using Approved templates.",
    path: "/app/campaigns/template-campaign-builder",
    icon: <PlusCircle className="text-emerald-800" size={22} />,
    action: "Create Campaign-Template",
    featureKey: "Campaigns",
  },

  {
    id: "template-campaign-list",
    label: "Manage Campaigns",
    description: "View and manage Meta template-based campaigns.",
    path: "/app/campaigns/template-campaigns-list",
    icon: <PlusCircle className="text-emerald-800" size={22} />,
    action: "View & Send",
  },

  {
    id: "template-campaignlist",
    label: "Campaign Builder",
    description: "Launch a multi-step campaign using Meta templates.",
    path: "/app/campaigns/template-campaigns-list",
    icon: <PlusCircle className="text-emerald-800" size={22} />,
    action: "Create Campaign-Template",
  },
  {
    id: "campaign-send-template-simple",
    label: "Send Template Message",
    description:
      "Send approved WhatsApp  (Text + button + Image) messages to contacts.",
    path: "/app/campaigns/send-template-simple",
    icon: <MessageSquareText className="text-emerald-800" size={22} />,
    action: "Send Template Message",
  },
  {
    id: "template-single",
    label: "New Campaign",
    description: "Send one-time messages to individual or multiple contacts.",
    path: "/app/campaigns/template-single",
    icon: <ListChecks className="text-emerald-800" size={22} />,
    action: "Send Single",
  },
  {
    id: "status-logs",
    label: "Message Send Logs",
    description: "Track delivery status for all sent messages.",
    path: "/app/campaigns/messagelogs",
    icon: <FileBarChart className="text-emerald-800" size={22} />,
    action: "View Logs",
  },
  {
    id: "cta-management",
    label: "CTA Management",
    description: "Add, edit, or delete campaign CTA buttons as needed.",
    path: "/app/campaigns/cta-management",
    icon: <MessageSquareText className="text-emerald-800" size={22} />,
    action: "Call-To-Action",
  },

  {
    id: "CampaignWizard",
    label: "Campaign Wizard (New)",
    description:
      "Build a campaign using wizard steps: Text, Image, or Template.",
    path: "/app/campaigns/CampaignWizard",
    icon: <PlusCircle className="text-emerald-800" size={22} />,
    action: "Campaign Wizard",
  },
  {
    id: "campaign-tracking-logs",
    label: "Tracking Logs",
    description: "See detailed logs for campaign interactions and events.",
    path: "/app/tracking/logs",
    icon: <PlusCircle className="text-emerald-800" size={22} />,
    action: "View Campaign Logs",
  },
];

export default function CampaignWorkspacePage() {
  const navigate = useNavigate();
  const { isLoading, can, hasAllAccess } = useAuth();

  const [pinned, setPinned] = useState(
    JSON.parse(localStorage.getItem("campaign-pinned") || "[]")
  );
  const [archived, setArchived] = useState(
    JSON.parse(localStorage.getItem("campaign-archived") || "[]")
  );
  const [order, setOrder] = useState(
    JSON.parse(localStorage.getItem("campaign-order")) ||
      campaignBlocks.map(b => b.id)
  );

  const togglePin = (e, id) => {
    e.stopPropagation();
    const updated = pinned.includes(id)
      ? pinned.filter(i => i !== id)
      : [...pinned, id];
    setPinned(updated);
    localStorage.setItem("campaign-pinned", JSON.stringify(updated));
  };

  const toggleArchive = (e, id) => {
    e.stopPropagation();
    const updated = archived.includes(id)
      ? archived.filter(i => i !== id)
      : [...archived, id];
    setArchived(updated);
    localStorage.setItem("campaign-archived", JSON.stringify(updated));
  };

  const onDragEnd = result => {
    if (!result.destination) return;
    const newOrder = Array.from(order);
    const [moved] = newOrder.splice(result.source.index, 1);
    newOrder.splice(result.destination.index, 0, moved);
    setOrder(newOrder);
    localStorage.setItem("campaign-order", JSON.stringify(newOrder));
  };

  const canAny = codes => hasAllAccess || (codes || []).some(code => can(code));
  const isAllowed = block => canAny(PERM_BY_BLOCK[block.id]);

  const visibleBlocks = order
    .map(id => campaignBlocks.find(b => b.id === id))
    .filter(Boolean)
    .filter(b => !archived.includes(b.id))
    .filter(isAllowed);

  if (isLoading)
    return (
      <div className="p-10 text-center text-lg text-gray-500">
        Loading features‚Ä¶
      </div>
    );

  return (
    <div className="p-6">
      {/* Local CSS for animated sequential ‚Äúhand-drawn‚Äù border.
          Gradient: gray ‚Üí dark gray ‚Üí very light purple.
          Cursor uses default pointer (system hand color unchanged). */}
      <style>{`
        @keyframes drawRight { from { transform: scaleX(0) } to { transform: scaleX(1) } }
        @keyframes drawDown  { from { transform: scaleY(0) } to { transform: scaleY(1) } }
        @keyframes drawLeft  { from { transform: scaleX(0) } to { transform: scaleX(1) } }
        @keyframes drawUp    { from { transform: scaleY(0) } to { transform: scaleY(1) } }

        .tile:hover .topline    { animation: drawRight .9s ease forwards; }
        .tile:hover .rightline  { animation: drawDown  .9s ease .18s forwards; }
        .tile:hover .bottomline { animation: drawLeft  .9s ease .36s forwards; }
        .tile:hover .leftline   { animation: drawUp    .9s ease .54s forwards; }
      `}</style>

      <h2 className="text-2xl font-bold text-emerald-800 mb-4">
        üì¶ Campaign Workspace
      </h2>

      <DragDropContext onDragEnd={onDragEnd}>
        <Droppable droppableId="campaign-blocks" direction="horizontal">
          {provided => (
            <div
              className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"
              ref={provided.innerRef}
              {...provided.droppableProps}
            >
              {visibleBlocks.map((block, index) => (
                <Draggable key={block.id} draggableId={block.id} index={index}>
                  {provided => (
                    <div
                      ref={provided.innerRef}
                      {...provided.draggableProps}
                      // Do NOT spread dragHandleProps here, we put it on the kebab only
                      role="button"
                      tabIndex={0}
                      aria-label={`${block.label}: ${block.action}`}
                      onKeyDown={e => {
                        if (e.key === "Enter") navigate(block.path);
                      }}
                      onClick={() => navigate(block.path)}
                      className="tile group relative overflow-hidden cursor-pointer bg-white rounded-md border shadow-sm hover:shadow-md transition transform hover:-translate-y-0.5 duration-200 focus:outline-none focus:ring-2 focus:ring-purple-300"
                      style={{ userSelect: "none" }}
                    >
                      {/* Animated border segments (top ‚Üí right ‚Üí bottom ‚Üí left) */}
                      <span
                        aria-hidden
                        className="topline pointer-events-none absolute left-0 -top-[2px] h-[2px] w-full origin-left rounded opacity-0 group-hover:opacity-100"
                        style={{
                          background:
                            "linear-gradient(90deg, #6B7280, #374151, #F3E8FF)",
                          transform: "scaleX(0)",
                        }}
                      />
                      <span
                        aria-hidden
                        className="rightline pointer-events-none absolute right-0 -top-[2px] h-[calc(100%+4px)] w-[2px] origin-top rounded opacity-0 group-hover:opacity-100"
                        style={{
                          background:
                            "linear-gradient(180deg, #6B7280, #374151, #F3E8FF)",
                          transform: "scaleY(0)",
                        }}
                      />
                      <span
                        aria-hidden
                        className="bottomline pointer-events-none absolute left-0 -bottom-[2px] h-[2px] w-full origin-right rounded opacity-0 group-hover:opacity-100"
                        style={{
                          background:
                            "linear-gradient(270deg, #6B7280, #374151, #F3E8FF)",
                          transform: "scaleX(0)",
                        }}
                      />
                      <span
                        aria-hidden
                        className="leftline pointer-events-none absolute left-0 -top-[2px] h-[calc(100%+4px)] w-[2px] origin-bottom rounded opacity-0 group-hover:opacity-100"
                        style={{
                          background:
                            "linear-gradient(0deg, #6B7280, #374151, #F3E8FF)",
                          transform: "scaleY(0)",
                        }}
                      />

                      <div className="flex items-start gap-4 p-5">
                        <div className="bg-emerald-50 rounded-md p-2">
                          {block.icon}
                        </div>
                        <div className="flex-1">
                          <h3 className="text-md font-semibold text-emerald-800 group-hover:text-emerald-900">
                            {block.label}
                          </h3>
                          <p className="text-sm text-slate-600">
                            {block.description}
                          </p>
                        </div>

                        {/* Only this area acts as drag handle */}
                        <div
                          {...provided.dragHandleProps}
                          title="Drag to re-order"
                          className="ml-2 rounded p-1 text-gray-400 hover:text-gray-600 cursor-grab active:cursor-grabbing"
                          onClick={e => e.stopPropagation()}
                        >
                          <MoreVertical size={16} />
                        </div>
                      </div>

                      <div className="px-5 py-3 border-t border-gray-200 flex items-center justify-between">
                        <button
                          onClick={e => {
                            e.stopPropagation();
                            navigate(block.path);
                          }}
                          className="text-sm text-gray-700 font-medium flex items-center gap-1 hover:text-gray-900"
                        >
                          {block.action} <ArrowRightCircle size={18} />
                        </button>

                        <div className="flex items-center gap-3">
                          <button
                            onClick={e => togglePin(e, block.id)}
                            title="Pin this"
                          >
                            <Pin
                              size={18}
                              className={
                                pinned.includes(block.id)
                                  ? "text-red-600"
                                  : "text-gray-400 hover:text-red-500"
                              }
                            />
                          </button>
                          <button
                            onClick={e => toggleArchive(e, block.id)}
                            title="Archive this"
                          >
                            <Archive
                              size={18}
                              className={
                                archived.includes(block.id)
                                  ? "text-indigo-600"
                                  : "text-gray-400 hover:text-indigo-500"
                              }
                            />
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                </Draggable>
              ))}
              {provided.placeholder}
            </div>
          )}
        </Droppable>
      </DragDropContext>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Workspaces\CatalogWorkspacePage.jsx 
====================================================== 
 
// üìÑ src/pages/Workspaces/CatalogWorkspacePage.jsx

import {
  Archive,
  Pin,
  ArrowRightCircle,
  MoreVertical,
  ShoppingCart,
  PlusCircle,
  BarChart2,
  Zap,
} from "lucide-react";
import { useNavigate } from "react-router-dom";
import { useState } from "react";
import { DragDropContext, Droppable, Draggable } from "react-beautiful-dnd";

// ‚úÖ use the real provider hook
import { useAuth } from "../../app/providers/AuthProvider";
// ‚úÖ fine-grained capability codes (mirror backend)
import { FK } from "../../capabilities/featureKeys";

const PERM_BY_BLOCK = {
  "product-catalog": [FK.PRODUCT_VIEW], // view products
  "product-form": [FK.PRODUCT_CREATE], // create products
  // No explicit FK for insights yet; allow if they can view products.
  "catalog-dashboard": [FK.PRODUCT_VIEW],
  // "catalog-automation" is still plan-gated only (no FK yet)
};

const catalogBlocks = [
  {
    id: "product-catalog",
    label: "Product Catalog",
    description: "Browse, manage, and organize all your products in one place.",
    path: "/app/catalog/products",
    icon: <ShoppingCart className="text-purple-600" size={22} />,
    action: "Manage Products",
  },
  {
    id: "product-form",
    label: "Add New Product",
    description: "Create and publish new items to your WhatsApp catalog.",
    path: "/app/catalog/form",
    icon: <PlusCircle className="text-green-600" size={22} />,
    action: "Add Product",
  },
  {
    id: "catalog-dashboard",
    label: "Catalog Dashboard",
    description: "Get insights into catalog performance and user interactions.",
    path: "/app/catalog/insights",
    icon: <BarChart2 className="text-blue-600" size={22} />,
    action: "View Insights",
  },
  {
    id: "catalog-automation",
    label: "Auto-Responders",
    description: "Set up auto-replies triggered by catalog engagement events.",
    path: "/app/catalog/automation",
    icon: <Zap className="text-yellow-600" size={22} />,
    action: "Configure Bots",
    requiredPlan: "advanced",
  },
];

export default function CatalogWorkspacePage() {
  const navigate = useNavigate();
  const { isLoading, can, hasAllAccess, planId } = useAuth();

  const [pinned, setPinned] = useState(
    JSON.parse(localStorage.getItem("catalog-pinned") || "[]")
  );
  const [archived, setArchived] = useState(
    JSON.parse(localStorage.getItem("catalog-archived") || "[]")
  );
  const [order, setOrder] = useState(
    JSON.parse(localStorage.getItem("catalog-order")) ||
      catalogBlocks.map(b => b.id)
  );

  const togglePin = id => {
    const updated = pinned.includes(id)
      ? pinned.filter(i => i !== id)
      : [...pinned, id];
    setPinned(updated);
    localStorage.setItem("catalog-pinned", JSON.stringify(updated));
  };

  const toggleArchive = id => {
    const updated = archived.includes(id)
      ? archived.filter(i => i !== id)
      : [...archived, id];
    setArchived(updated);
    localStorage.setItem("catalog-archived", JSON.stringify(updated));
  };

  const onDragEnd = result => {
    if (!result.destination) return;
    const newOrder = Array.from(order);
    const [moved] = newOrder.splice(result.source.index, 1);
    newOrder.splice(result.destination.index, 0, moved);
    setOrder(newOrder);
    localStorage.setItem("catalog-order", JSON.stringify(newOrder));
  };

  // ---- plan helper (you were already using this UX gate) --------------------
  const hasPlan = requiredPlan => {
    if (!requiredPlan) return true;
    const tiers = ["trial", "basic", "smart", "advanced"];
    // if you store planId as name already, great; else map your numeric ids here
    const current = String(planId || "basic").toLowerCase();
    return tiers.indexOf(current) >= tiers.indexOf(requiredPlan.toLowerCase());
  };

  // ---- permission helper using FK + can() -----------------------------------
  const canAny = codes => hasAllAccess || (codes || []).some(code => can(code));

  const visibleBlocks = order
    .map(id => catalogBlocks.find(b => b.id === id))
    .filter(Boolean)
    .filter(b => !archived.includes(b.id))
    .filter(b => canAny(PERM_BY_BLOCK[b.id]))
    .filter(b => hasPlan(b.requiredPlan));

  if (isLoading)
    return (
      <div className="p-10 text-center text-lg text-gray-500">
        Loading features‚Ä¶
      </div>
    );

  return (
    <div className="p-6">
      <h2 className="text-2xl font-bold text-purple-800 mb-4">
        üõçÔ∏è Catalog Workspace
      </h2>

      <DragDropContext onDragEnd={onDragEnd}>
        <Droppable droppableId="catalog-blocks" direction="horizontal">
          {provided => (
            <div
              className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"
              ref={provided.innerRef}
              {...provided.droppableProps}
            >
              {visibleBlocks.map((block, index) => (
                <Draggable key={block.id} draggableId={block.id} index={index}>
                  {provided => (
                    <div
                      ref={provided.innerRef}
                      {...provided.draggableProps}
                      {...provided.dragHandleProps}
                      className="bg-white rounded-md border shadow-sm hover:shadow-md transition transform hover:-translate-y-0.5 duration-200"
                    >
                      <div className="flex items-start gap-4 p-5">
                        <div className="bg-gray-100 rounded-md p-2">
                          {block.icon}
                        </div>
                        <div className="flex-1">
                          <h3 className="text-md font-semibold text-purple-700">
                            {block.label}
                          </h3>
                          <p className="text-sm text-gray-600">
                            {block.description}
                          </p>
                        </div>
                        <MoreVertical size={16} className="text-gray-400" />
                      </div>
                      <div className="px-5 py-3 border-t border-gray-200 flex items-center justify-between">
                        <button
                          onClick={() => navigate(block.path)}
                          className="text-sm text-purple-600 font-medium flex items-center gap-1 hover:text-purple-800"
                        >
                          {block.action} <ArrowRightCircle size={18} />
                        </button>
                        <div className="flex items-center gap-3">
                          <button
                            onClick={() => togglePin(block.id)}
                            title="Pin this"
                          >
                            <Pin
                              size={18}
                              className={
                                pinned.includes(block.id)
                                  ? "text-red-600"
                                  : "text-gray-400 hover:text-red-500"
                              }
                            />
                          </button>
                          <button
                            onClick={() => toggleArchive(block.id)}
                            title="Archive this"
                          >
                            <Archive
                              size={18}
                              className={
                                archived.includes(block.id)
                                  ? "text-indigo-600"
                                  : "text-gray-400 hover:text-indigo-500"
                              }
                            />
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                </Draggable>
              ))}
              {provided.placeholder}
            </div>
          )}
        </Droppable>
      </DragDropContext>
    </div>
  );
}

// // üìÑ src/pages/Workspaces/CatalogWorkspacePage.jsx

// import {
//   Archive,
//   Pin,
//   ArrowRightCircle,
//   MoreVertical,
//   ShoppingCart,
//   PlusCircle,
//   BarChart2,
//   Zap,
// } from "lucide-react";
// import { useNavigate } from "react-router-dom";
// import { useState } from "react";
// import { DragDropContext, Droppable, Draggable } from "react-beautiful-dnd";
// import { useAuth } from "../auth/context/pld_AuthContext";

// const catalogBlocks = [
//   {
//     id: "product-catalog",
//     label: "Product Catalog",
//     description: "Browse, manage, and organize all your products in one place.",
//     path: "/app/catalog/products",
//     icon: <ShoppingCart className="text-purple-600" size={22} />,
//     action: "Manage Products",
//     featureKey: "Catalog",
//   },
//   {
//     id: "product-form",
//     label: "Add New Product",
//     description: "Create and publish new items to your WhatsApp catalog.",
//     path: "/app/catalog/form",
//     icon: <PlusCircle className="text-green-600" size={22} />,
//     action: "Add Product",
//     featureKey: "Catalog",
//   },
//   {
//     id: "catalog-dashboard",
//     label: "Catalog Dashboard",
//     description: "Get insights into catalog performance and user interactions.",
//     path: "/app/catalog/insights",
//     icon: <BarChart2 className="text-blue-600" size={22} />,
//     action: "View Insights",
//     featureKey: "CatalogInsights",
//   },
//   {
//     id: "catalog-automation",
//     label: "Auto-Responders",
//     description: "Set up auto-replies triggered by catalog engagement events.",
//     path: "/app/catalog/automation",
//     icon: <Zap className="text-yellow-600" size={22} />,
//     action: "Configure Bots",
//     requiredPlan: "advanced",
//   },
// ];

// export default function CatalogWorkspacePage() {
//   const navigate = useNavigate();
//   const { plan, availableFeatures = {}, isLoading } = useAuth();

//   const [pinned, setPinned] = useState(() =>
//     JSON.parse(localStorage.getItem("catalog-pinned") || "[]")
//   );
//   const [archived, setArchived] = useState(() =>
//     JSON.parse(localStorage.getItem("catalog-archived") || "[]")
//   );
//   const [order, setOrder] = useState(
//     () =>
//       JSON.parse(localStorage.getItem("catalog-order")) ||
//       catalogBlocks.map(b => b.id)
//   );

//   const togglePin = id => {
//     const updated = pinned.includes(id)
//       ? pinned.filter(i => i !== id)
//       : [...pinned, id];
//     setPinned(updated);
//     localStorage.setItem("catalog-pinned", JSON.stringify(updated));
//   };

//   const toggleArchive = id => {
//     const updated = archived.includes(id)
//       ? archived.filter(i => i !== id)
//       : [...archived, id];
//     setArchived(updated);
//     localStorage.setItem("catalog-archived", JSON.stringify(updated));
//   };

//   const onDragEnd = result => {
//     if (!result.destination) return;
//     const newOrder = Array.from(order);
//     const [moved] = newOrder.splice(result.source.index, 1);
//     newOrder.splice(result.destination.index, 0, moved);
//     setOrder(newOrder);
//     localStorage.setItem("catalog-order", JSON.stringify(newOrder));
//   };

//   // üö© Use both featureKey and plan for gating blocks
//   const hasFeature = key => availableFeatures[key];

//   const hasPlan = requiredPlan => {
//     const tiers = ["trial", "basic", "smart", "advanced"];
//     const userTier = tiers.indexOf(plan?.toLowerCase() || "basic");
//     const requiredTier = tiers.indexOf(requiredPlan?.toLowerCase() || "basic");
//     return userTier >= requiredTier;
//   };

//   const visibleBlocks = order
//     .filter(id => {
//       const block = catalogBlocks.find(b => b.id === id);
//       if (!block || archived.includes(id)) return false;
//       if (block.featureKey && !hasFeature(block.featureKey)) return false;
//       if (block.requiredPlan && !hasPlan(block.requiredPlan)) return false;
//       return true;
//     })
//     .map(id => catalogBlocks.find(b => b.id === id));

//   if (isLoading)
//     return (
//       <div className="p-10 text-center text-lg text-gray-500">
//         Loading features‚Ä¶
//       </div>
//     );

//   return (
//     <div className="p-6">
//       <h2 className="text-2xl font-bold text-purple-800 mb-4">
//         üõçÔ∏è Catalog Workspace
//       </h2>

//       {plan === "basic" && (
//         <div className="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 px-4 py-3 rounded-md mb-6 shadow">
//           You‚Äôre on the <strong>Basic</strong> plan. Upgrade to unlock advanced
//           analytics and automation for your catalog.
//           <button
//             onClick={() => navigate("/app/upgrade")}
//             className="ml-3 text-purple-700 underline hover:text-purple-900 font-medium"
//           >
//             Upgrade Now
//           </button>
//         </div>
//       )}

//       <DragDropContext onDragEnd={onDragEnd}>
//         <Droppable droppableId="catalog-blocks" direction="horizontal">
//           {provided => (
//             <div
//               className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"
//               ref={provided.innerRef}
//               {...provided.droppableProps}
//             >
//               {visibleBlocks.map((block, index) => (
//                 <Draggable key={block.id} draggableId={block.id} index={index}>
//                   {provided => (
//                     <div
//                       ref={provided.innerRef}
//                       {...provided.draggableProps}
//                       {...provided.dragHandleProps}
//                       className="bg-white rounded-md border shadow-sm hover:shadow-md transition transform hover:-translate-y-0.5 duration-200"
//                     >
//                       <div className="flex items-start gap-4 p-5">
//                         <div className="bg-gray-100 rounded-md p-2">
//                           {block.icon}
//                         </div>
//                         <div className="flex-1">
//                           <h3 className="text-md font-semibold text-purple-700">
//                             {block.label}
//                           </h3>
//                           <p className="text-sm text-gray-600">
//                             {block.description}
//                           </p>
//                         </div>
//                         <MoreVertical size={16} className="text-gray-400" />
//                       </div>
//                       <div className="px-5 py-3 border-t border-gray-200 flex items-center justify-between">
//                         <button
//                           onClick={() => navigate(block.path)}
//                           className="text-sm text-purple-600 font-medium flex items-center gap-1 hover:text-purple-800"
//                         >
//                           {block.action} <ArrowRightCircle size={18} />
//                         </button>
//                         <div className="flex items-center gap-3">
//                           <button
//                             onClick={() => togglePin(block.id)}
//                             title="Pin this"
//                           >
//                             <Pin
//                               size={18}
//                               className={
//                                 pinned.includes(block.id)
//                                   ? "text-red-600"
//                                   : "text-gray-400 hover:text-red-500"
//                               }
//                             />
//                           </button>
//                           <button
//                             onClick={() => toggleArchive(block.id)}
//                             title="Archive this"
//                           >
//                             <Archive
//                               size={18}
//                               className={
//                                 archived.includes(block.id)
//                                   ? "text-indigo-600"
//                                   : "text-gray-400 hover:text-indigo-500"
//                               }
//                             />
//                           </button>
//                         </div>
//                       </div>
//                     </div>
//                   )}
//                 </Draggable>
//               ))}
//               {provided.placeholder}
//             </div>
//           )}
//         </Droppable>
//       </DragDropContext>
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Workspaces\CrmWorkspacePage.jsx 
====================================================== 
 
// üìÑ File: src/pages/Workspaces/CrmWorkspacePage.jsx

import {
  Archive,
  Pin,
  ArrowRightCircle,
  UserCircle2,
  Tags,
  BellRing,
  Clock4,
  GripVertical,
} from "lucide-react";
import { useNavigate } from "react-router-dom";
import { useState } from "react";
import { DragDropContext, Droppable, Draggable } from "react-beautiful-dnd";
// ‚úÖ Use the new server-authoritative AuthProvider
import { useAuth } from "../../app/providers/AuthProvider";

/**
 * üîê Map CRM blocks to EXACT Permission.Code values from your back end.
 * Adjust these strings to match your seeded permissions.
 */
const PERM_BY_BLOCK = {
  contacts: "crm.contacts.view",
  tags: "crm.tags.view",
  reminders: "reminders.view", // change/remove if not seeded
  timeline: "crm.timeline", // change/remove if not seeded
};

const crmBlocks = [
  {
    id: "contacts",
    label: "Contacts",
    description: "Central place to manage leads, customers, and their details.",
    path: "/app/crm/contacts",
    icon: <UserCircle2 className="text-purple-600" size={26} />,
    action: "Open Contacts",
    statLabel: "Total Contacts",
    statValue: 245,
  },
  {
    id: "tags",
    label: "Tags",
    description: "Organize and filter contacts using color-coded tags.",
    path: "/app/crm/tags",
    icon: <Tags className="text-yellow-500" size={26} />,
    action: "Manage Tags",
    statLabel: "Total Tags",
    statValue: 12,
  },
  {
    id: "reminders",
    label: "Reminders",
    description: "Schedule follow-ups and set alerts to never miss a lead.",
    path: "/app/crm/reminders",
    icon: <BellRing className="text-blue-500" size={26} />,
    action: "View Reminders",
    statLabel: "Pending",
    statValue: 3,
  },
  {
    id: "timeline",
    label: "Timeline",
    description: "Track every interaction and touchpoint with each contact.",
    path: "/app/crm/timeline",
    icon: <Clock4 className="text-green-600" size={26} />,
    action: "View Timeline",
    statLabel: "Entries",
    statValue: 150,
  },
];

export default function CrmWorkspacePage() {
  const navigate = useNavigate();

  const { isLoading, hasAllAccess, can } = useAuth();

  const [pinned, setPinned] = useState(
    JSON.parse(localStorage.getItem("crm-pinned") || "[]")
  );
  const [archived, setArchived] = useState(
    JSON.parse(localStorage.getItem("crm-archived") || "[]")
  );
  const [order, setOrder] = useState(
    JSON.parse(localStorage.getItem("crm-order")) || crmBlocks.map(b => b.id)
  );

  const togglePin = id => {
    const updated = pinned.includes(id)
      ? pinned.filter(i => i !== id)
      : [...pinned, id];
    setPinned(updated);
    localStorage.setItem("crm-pinned", JSON.stringify(updated));
  };

  const toggleArchive = id => {
    const updated = archived.includes(id)
      ? archived.filter(i => i !== id)
      : [...archived, id];
    setArchived(updated);
    localStorage.setItem("crm-archived", JSON.stringify(updated));
  };

  const onDragEnd = result => {
    if (!result.destination) return;
    const newOrder = Array.from(order);
    const [moved] = newOrder.splice(result.source.index, 1);
    newOrder.splice(result.destination.index, 0, moved);
    setOrder(newOrder);
    localStorage.setItem("crm-order", JSON.stringify(newOrder));
  };

  // ‚úÖ server-first permission check
  const isAllowedBlock = block => {
    if (hasAllAccess) return true;
    if (typeof can === "function") {
      const code = PERM_BY_BLOCK[block.id];
      // hide blocks with no mapped code until you seed them
      return !!code && can(code);
    }
    // If can() is missing for some reason, keep visible (safer for legacy)
    return true;
  };

  const visibleBlocks = order
    .filter(id => {
      const block = crmBlocks.find(b => b.id === id);
      if (!block || archived.includes(id)) return false;
      return isAllowedBlock(block);
    })
    .map(id => crmBlocks.find(b => b.id === id));

  if (isLoading) {
    return (
      <div className="p-10 text-center text-lg text-gray-500">
        Loading features‚Ä¶
      </div>
    );
  }

  return (
    <div
      className="p-6 space-y-6 bg-gray-50 min-h-screen"
      data-test-id="crm-root"
    >
      {/* Header */}
      <h2 className="text-2xl font-bold text-gray-900">CRM</h2>
      <p className="text-gray-600">
        Manage contacts, tags & interactions stay on top of reminders.
      </p>

      {/* Cards */}
      <DragDropContext onDragEnd={onDragEnd}>
        <Droppable droppableId="crm-blocks" direction="horizontal">
          {provided => (
            <div
              className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"
              ref={provided.innerRef}
              {...provided.droppableProps}
            >
              {visibleBlocks.map((block, index) => (
                <Draggable key={block.id} draggableId={block.id} index={index}>
                  {provided => (
                    <div
                      ref={provided.innerRef}
                      {...provided.draggableProps}
                      className="rounded-2xl border bg-white shadow-lg/5 hover:shadow-lg transition transform hover:-translate-y-1 hover:border-purple-300 duration-200 overflow-hidden cursor-pointer min-h-[220px] flex flex-col justify-between"
                      onClick={e => {
                        if (!e.target.closest("button,svg")) {
                          navigate(block.path);
                        }
                      }}
                    >
                      {/* Top */}
                      <div className="flex items-start gap-4 p-5 flex-1">
                        <div className="bg-gradient-to-br from-gray-100 to-white rounded-full p-3 flex-shrink-0">
                          {block.icon}
                        </div>
                        <div className="flex-1">
                          <h3 className="text-lg font-semibold text-gray-900">
                            {block.label}
                          </h3>
                          <p className="text-sm text-gray-500 mb-2 line-clamp-2">
                            {block.description}
                          </p>
                          <div>
                            <span className="text-2xl font-bold text-gray-900">
                              {block.statValue}
                            </span>
                            <span className="ml-1 text-xs text-gray-500">
                              {block.statLabel}
                            </span>
                          </div>
                        </div>
                        <div
                          {...provided.dragHandleProps}
                          className="cursor-grab text-gray-400 hover:text-gray-600"
                        >
                          <GripVertical size={16} />
                        </div>
                      </div>

                      {/* Bottom actions */}
                      <div className="px-5 py-3 border-t border-gray-100 flex items-center justify-between bg-gray-50">
                        <button
                          onClick={() => navigate(block.path)}
                          className="text-sm text-purple-600 font-medium flex items-center gap-1 hover:bg-purple-50 px-3 py-1 rounded-md transition"
                        >
                          {block.action} <ArrowRightCircle size={18} />
                        </button>
                        <div className="flex items-center gap-3">
                          <button
                            onClick={() => togglePin(block.id)}
                            title={pinned.includes(block.id) ? "Unpin" : "Pin"}
                          >
                            <Pin
                              size={18}
                              className={
                                pinned.includes(block.id)
                                  ? "text-red-500"
                                  : "text-gray-400 hover:text-red-500"
                              }
                            />
                          </button>
                          <button
                            onClick={() => toggleArchive(block.id)}
                            title="Archive"
                          >
                            <Archive
                              size={18}
                              className={
                                archived.includes(block.id)
                                  ? "text-indigo-500"
                                  : "text-gray-400 hover:text-indigo-500"
                              }
                            />
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                </Draggable>
              ))}
              {provided.placeholder}
            </div>
          )}
        </Droppable>
      </DragDropContext>
    </div>
  );
}

// import {
//   Archive,
//   Pin,
//   ArrowRightCircle,
//   UserCircle2,
//   Tags,
//   BellRing,
//   Clock4,
//   GripVertical,
// } from "lucide-react";
// import { useNavigate } from "react-router-dom";
// import { useState } from "react";
// import { DragDropContext, Droppable, Draggable } from "react-beautiful-dnd";
// // import { useAuth } from "../auth/context/AuthContext";
// // import { useAuth } from "../../../pages/auth/context/AuthContext";
// import { useAuth } from "../auth/context/pld_AuthContext";
// /**
//  * üîê Map CRM blocks to EXACT Permission.Code values from your DB.
//  * Adjust these strings to match your seeded permissions.
//  */
// const PERM_BY_BLOCK = {
//   contacts: "contacts.view", // seen in your tables
//   tags: "tags.edit", // seen in your tables
//   reminders: "reminders.view", // TODO: change if your code differs or remove if not seeded
//   timeline: "crm.timeline", // TODO: change if your code differs or remove if not seeded
// };

// const crmBlocks = [
//   {
//     id: "contacts",
//     label: "Contacts",
//     description: "Central place to manage leads, customers, and their details.",
//     path: "/app/crm/contacts",
//     icon: <UserCircle2 className="text-purple-600" size={26} />,
//     action: "Open Contacts",
//     statLabel: "Total Contacts",
//     statValue: 245,
//   },
//   {
//     id: "tags",
//     label: "Tags",
//     description: "Organize and filter contacts using color-coded tags.",
//     path: "/app/crm/tags",
//     icon: <Tags className="text-yellow-500" size={26} />,
//     action: "Manage Tags",
//     statLabel: "Total Tags",
//     statValue: 12,
//   },
//   {
//     id: "reminders",
//     label: "Reminders",
//     description: "Schedule follow-ups and set alerts to never miss a lead.",
//     path: "/app/crm/reminders",
//     icon: <BellRing className="text-blue-500" size={26} />,
//     action: "View Reminders",
//     statLabel: "Pending",
//     statValue: 3,
//   },
//   {
//     id: "timeline",
//     label: "Timeline",
//     description: "Track every interaction and touchpoint with each contact.",
//     path: "/app/crm/timeline",
//     icon: <Clock4 className="text-green-600" size={26} />,
//     action: "View Timeline",
//     statLabel: "Entries",
//     statValue: 150,
//     // featureKey left here as legacy fallback only (not used if can() exists)
//     featureKey: "CRMInsights",
//   },
// ];

// export default function CrmWorkspacePage() {
//   const navigate = useNavigate();
//   // Pull can()/hasAllAccess if your AuthContext exposes them; keep legacy map for fallback.
//   const {
//     availableFeatures = {},
//     isLoading,
//     plan,
//     can,
//     hasAllAccess,
//   } = useAuth();

//   const [pinned, setPinned] = useState(
//     JSON.parse(localStorage.getItem("crm-pinned") || "[]")
//   );
//   const [archived, setArchived] = useState(
//     JSON.parse(localStorage.getItem("crm-archived") || "[]")
//   );
//   const [order, setOrder] = useState(
//     JSON.parse(localStorage.getItem("crm-order")) || crmBlocks.map(b => b.id)
//   );

//   const togglePin = id => {
//     const updated = pinned.includes(id)
//       ? pinned.filter(i => i !== id)
//       : [...pinned, id];
//     setPinned(updated);
//     localStorage.setItem("crm-pinned", JSON.stringify(updated));
//   };

//   const toggleArchive = id => {
//     const updated = archived.includes(id)
//       ? archived.filter(i => i !== id)
//       : [...archived, id];
//     setArchived(updated);
//     localStorage.setItem("crm-archived", JSON.stringify(updated));
//   };

//   const onDragEnd = result => {
//     if (!result.destination) return;
//     const newOrder = Array.from(order);
//     const [moved] = newOrder.splice(result.source.index, 1);
//     newOrder.splice(result.destination.index, 0, moved);
//     setOrder(newOrder);
//     localStorage.setItem("crm-order", JSON.stringify(newOrder));
//   };

//   // ‚úÖ unified permission check (server-first, legacy fallback)
//   const isAllowedBlock = block => {
//     const code = PERM_BY_BLOCK[block.id];

//     // Prefer server-authorized check if available
//     if (typeof can === "function") {
//       if (hasAllAccess) return true;
//       // If no mapped code (temporary), default to hidden for safety
//       if (!code) return false;
//       return can(code);
//     }

//     // Legacy fallback: use your old availableFeatures and block.featureKey
//     if (block.featureKey) return availableFeatures[block.featureKey] === true;

//     // If no featureKey and no can(), default to visible to preserve current behavior
//     // (flip to false later once all codes exist)
//     return true;
//   };

//   const visibleBlocks = order
//     .filter(id => {
//       const block = crmBlocks.find(b => b.id === id);
//       if (!block || archived.includes(id)) return false;
//       return isAllowedBlock(block);
//     })
//     .map(id => crmBlocks.find(b => b.id === id));

//   if (isLoading) {
//     return (
//       <div className="p-10 text-center text-lg text-gray-500">
//         Loading features‚Ä¶
//       </div>
//     );
//   }

//   return (
//     <div
//       className="p-6 space-y-6 bg-gray-50 min-h-screen"
//       data-test-id="crm-root"
//     >
//       {/* Header */}
//       <h2 className="text-3xl font-bold text-gray-900 tracking-tight">
//         üß† CRM Workspace
//       </h2>
//       <p className="text-gray-600">
//         Manage your contacts, organize them with tags, track interactions, and
//         stay on top of reminders.
//       </p>

//       {/* Plan alert (UX only; access still enforced by permission) */}
//       {String(plan).toLowerCase() === "basic" && (
//         <div className="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-sm shadow-sm">
//           You‚Äôre on the <strong>Basic</strong> plan. Upgrade to use CRM
//           timelines and get detailed history of contacts.
//           <button
//             onClick={() => navigate("/app/upgrade")}
//             className="ml-3 text-purple-700 underline hover:text-purple-900 font-medium"
//           >
//             Upgrade Now
//           </button>
//         </div>
//       )}

//       {/* Cards */}
//       <DragDropContext onDragEnd={onDragEnd}>
//         <Droppable droppableId="crm-blocks" direction="horizontal">
//           {provided => (
//             <div
//               className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"
//               ref={provided.innerRef}
//               {...provided.droppableProps}
//             >
//               {visibleBlocks.map((block, index) => (
//                 <Draggable key={block.id} draggableId={block.id} index={index}>
//                   {provided => (
//                     <div
//                       ref={provided.innerRef}
//                       {...provided.draggableProps}
//                       className="rounded-2xl border bg-white shadow-lg/5 hover:shadow-lg transition transform hover:-translate-y-1 hover:border-purple-300 duration-200 overflow-hidden cursor-pointer min-h-[220px] flex flex-col justify-between"
//                       onClick={e => {
//                         if (!e.target.closest("button,svg")) {
//                           navigate(block.path);
//                         }
//                       }}
//                     >
//                       {/* Top */}
//                       <div className="flex items-start gap-4 p-5 flex-1">
//                         <div className="bg-gradient-to-br from-gray-100 to-white rounded-full p-3 flex-shrink-0">
//                           {block.icon}
//                         </div>
//                         <div className="flex-1">
//                           <h3 className="text-lg font-semibold text-gray-900">
//                             {block.label}
//                           </h3>
//                           <p className="text-sm text-gray-500 mb-2 line-clamp-2">
//                             {block.description}
//                           </p>
//                           <div>
//                             <span className="text-2xl font-bold text-gray-900">
//                               {block.statValue}
//                             </span>
//                             <span className="ml-1 text-xs text-gray-500">
//                               {block.statLabel}
//                             </span>
//                           </div>
//                         </div>
//                         <div
//                           {...provided.dragHandleProps}
//                           className="cursor-grab text-gray-400 hover:text-gray-600"
//                         >
//                           <GripVertical size={16} />
//                         </div>
//                       </div>

//                       {/* Bottom actions */}
//                       <div className="px-5 py-3 border-t border-gray-100 flex items-center justify-between bg-gray-50">
//                         <button
//                           onClick={() => navigate(block.path)}
//                           className="text-sm text-purple-600 font-medium flex items-center gap-1 hover:bg-purple-50 px-3 py-1 rounded-md transition"
//                         >
//                           {block.action} <ArrowRightCircle size={18} />
//                         </button>
//                         <div className="flex items-center gap-3">
//                           <button
//                             onClick={() => togglePin(block.id)}
//                             title={pinned.includes(block.id) ? "Unpin" : "Pin"}
//                           >
//                             <Pin
//                               size={18}
//                               className={
//                                 pinned.includes(block.id)
//                                   ? "text-red-500"
//                                   : "text-gray-400 hover:text-red-500"
//                               }
//                             />
//                           </button>
//                           <button
//                             onClick={() => toggleArchive(block.id)}
//                             title="Archive"
//                           >
//                             <Archive
//                               size={18}
//                               className={
//                                 archived.includes(block.id)
//                                   ? "text-indigo-500"
//                                   : "text-gray-400 hover:text-indigo-500"
//                               }
//                             />
//                           </button>
//                         </div>
//                       </div>
//                     </div>
//                   )}
//                 </Draggable>
//               ))}
//               {provided.placeholder}
//             </div>
//           )}
//         </Droppable>
//       </DragDropContext>
//     </div>
//   );
// }

// import {
//   Archive,
//   Pin,
//   ArrowRightCircle,
//   UserCircle2,
//   Tags,
//   BellRing,
//   Clock4,
//   GripVertical,
// } from "lucide-react";
// import { useNavigate } from "react-router-dom";
// import { useState } from "react";
// import { DragDropContext, Droppable, Draggable } from "react-beautiful-dnd";
// import { useAuth } from "../auth/context/AuthContext";

// const crmBlocks = [
//   {
//     id: "contacts",
//     label: "Contacts",
//     description: "Central place to manage leads, customers, and their details.",
//     path: "/app/crm/contacts",
//     icon: <UserCircle2 className="text-purple-600" size={26} />,
//     action: "Open Contacts",
//     statLabel: "Total Contacts",
//     statValue: 245,
//   },
//   {
//     id: "tags",
//     label: "Tags",
//     description: "Organize and filter contacts using color-coded tags.",
//     path: "/app/crm/tags",
//     icon: <Tags className="text-yellow-500" size={26} />,
//     action: "Manage Tags",
//     statLabel: "Total Tags",
//     statValue: 12,
//   },
//   {
//     id: "reminders",
//     label: "Reminders",
//     description: "Schedule follow-ups and set alerts to never miss a lead.",
//     path: "/app/crm/reminders",
//     icon: <BellRing className="text-blue-500" size={26} />,
//     action: "View Reminders",
//     statLabel: "Pending",
//     statValue: 3,
//   },
//   {
//     id: "timeline",
//     label: "Timeline",
//     description: "Track every interaction and touchpoint with each contact.",
//     path: "/app/crm/timeline",
//     icon: <Clock4 className="text-green-600" size={26} />,
//     action: "View Timeline",
//     statLabel: "Entries",
//     statValue: 150,
//     featureKey: "CRMInsights",
//   },
// ];

// export default function CrmWorkspacePage() {
//   const navigate = useNavigate();
//   const { availableFeatures = {}, isLoading, plan } = useAuth();

//   const [pinned, setPinned] = useState(
//     JSON.parse(localStorage.getItem("crm-pinned") || "[]")
//   );
//   const [archived, setArchived] = useState(
//     JSON.parse(localStorage.getItem("crm-archived") || "[]")
//   );
//   const [order, setOrder] = useState(
//     JSON.parse(localStorage.getItem("crm-order")) || crmBlocks.map(b => b.id)
//   );

//   const togglePin = id => {
//     const updated = pinned.includes(id)
//       ? pinned.filter(i => i !== id)
//       : [...pinned, id];
//     setPinned(updated);
//     localStorage.setItem("crm-pinned", JSON.stringify(updated));
//   };

//   const toggleArchive = id => {
//     const updated = archived.includes(id)
//       ? archived.filter(i => i !== id)
//       : [...archived, id];
//     setArchived(updated);
//     localStorage.setItem("crm-archived", JSON.stringify(updated));
//   };

//   const onDragEnd = result => {
//     if (!result.destination) return;
//     const newOrder = Array.from(order);
//     const [moved] = newOrder.splice(result.source.index, 1);
//     newOrder.splice(result.destination.index, 0, moved);
//     setOrder(newOrder);
//     localStorage.setItem("crm-order", JSON.stringify(newOrder));
//   };

//   const visibleBlocks = order
//     .filter(id => {
//       const block = crmBlocks.find(b => b.id === id);
//       if (!block || archived.includes(id)) return false;
//       if (block.featureKey && !availableFeatures[block.featureKey])
//         return false;
//       return true;
//     })
//     .map(id => crmBlocks.find(b => b.id === id));

//   if (isLoading) {
//     return (
//       <div className="p-10 text-center text-lg text-gray-500">
//         Loading features‚Ä¶
//       </div>
//     );
//   }

//   return (
//     <div
//       className="p-6 space-y-6 bg-gray-50 min-h-screen"
//       data-test-id="crm-root"
//     >
//       {/* Header */}
//       <h2 className="text-3xl font-bold text-gray-900 tracking-tight">
//         üß† CRM Workspace
//       </h2>
//       <p className="text-gray-600">
//         Manage your contacts, organize them with tags, track interactions, and
//         stay on top of reminders.
//       </p>

//       {/* Plan alert */}
//       {plan === "basic" && (
//         <div className="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-sm shadow-sm">
//           You‚Äôre on the <strong>Basic</strong> plan. Upgrade to use CRM
//           timelines and get detailed history of contacts.
//           <button
//             onClick={() => navigate("/app/upgrade")}
//             className="ml-3 text-purple-700 underline hover:text-purple-900 font-medium"
//           >
//             Upgrade Now
//           </button>
//         </div>
//       )}

//       {/* Cards */}
//       <DragDropContext onDragEnd={onDragEnd}>
//         <Droppable droppableId="crm-blocks" direction="horizontal">
//           {provided => (
//             <div
//               className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"
//               ref={provided.innerRef}
//               {...provided.droppableProps}
//             >
//               {visibleBlocks.map((block, index) => (
//                 <Draggable key={block.id} draggableId={block.id} index={index}>
//                   {provided => (
//                     <div
//                       ref={provided.innerRef}
//                       {...provided.draggableProps}
//                       className="rounded-2xl border bg-white shadow-lg/5 hover:shadow-lg transition transform hover:-translate-y-1 hover:border-purple-300 duration-200 overflow-hidden cursor-pointer min-h-[220px] flex flex-col justify-between"
//                       onClick={e => {
//                         if (!e.target.closest("button,svg")) {
//                           navigate(block.path);
//                         }
//                       }}
//                     >
//                       {/* Top */}
//                       <div className="flex items-start gap-4 p-5 flex-1">
//                         <div className="bg-gradient-to-br from-gray-100 to-white rounded-full p-3 flex-shrink-0">
//                           {block.icon}
//                         </div>
//                         <div className="flex-1">
//                           <h3 className="text-lg font-semibold text-gray-900">
//                             {block.label}
//                           </h3>
//                           <p className="text-sm text-gray-500 mb-2 line-clamp-2">
//                             {block.description}
//                           </p>
//                           <div>
//                             <span className="text-2xl font-bold text-gray-900">
//                               {block.statValue}
//                             </span>
//                             <span className="ml-1 text-xs text-gray-500">
//                               {block.statLabel}
//                             </span>
//                           </div>
//                         </div>
//                         <div
//                           {...provided.dragHandleProps}
//                           className="cursor-grab text-gray-400 hover:text-gray-600"
//                         >
//                           <GripVertical size={16} />
//                         </div>
//                       </div>

//                       {/* Bottom actions */}
//                       <div className="px-5 py-3 border-t border-gray-100 flex items-center justify-between bg-gray-50">
//                         <button
//                           onClick={() => navigate(block.path)}
//                           className="text-sm text-purple-600 font-medium flex items-center gap-1 hover:bg-purple-50 px-3 py-1 rounded-md transition"
//                         >
//                           {block.action} <ArrowRightCircle size={18} />
//                         </button>
//                         <div className="flex items-center gap-3">
//                           <button
//                             onClick={() => togglePin(block.id)}
//                             title={pinned.includes(block.id) ? "Unpin" : "Pin"}
//                           >
//                             <Pin
//                               size={18}
//                               className={
//                                 pinned.includes(block.id)
//                                   ? "text-red-500"
//                                   : "text-gray-400 hover:text-red-500"
//                               }
//                             />
//                           </button>
//                           <button
//                             onClick={() => toggleArchive(block.id)}
//                             title="Archive"
//                           >
//                             <Archive
//                               size={18}
//                               className={
//                                 archived.includes(block.id)
//                                   ? "text-indigo-500"
//                                   : "text-gray-400 hover:text-indigo-500"
//                               }
//                             />
//                           </button>
//                         </div>
//                       </div>
//                     </div>
//                   )}
//                 </Draggable>
//               ))}
//               {provided.placeholder}
//             </div>
//           )}
//         </Droppable>
//       </DragDropContext>
//     </div>
//   );
// }

// import {
//   Archive,
//   Pin,
//   ArrowRightCircle,
//   MoreVertical,
//   UserCircle2,
//   Tags,
//   BellRing,
//   Clock4,
//   GripVertical,
// } from "lucide-react";
// import { useNavigate } from "react-router-dom";
// import { useState } from "react";
// import { DragDropContext, Droppable, Draggable } from "react-beautiful-dnd";
// import { useAuth } from "../auth/context/AuthContext";

// const crmBlocks = [
//   {
//     id: "contacts",
//     label: "Contacts",
//     description: "Central place to manage leads, customers, and their details.",
//     path: "/app/crm/contacts",
//     icon: <UserCircle2 className="text-purple-600" size={26} />,
//     action: "Open Contacts",
//     statLabel: "Total Contacts",
//     statValue: 245,
//   },
//   {
//     id: "tags",
//     label: "Tags",
//     description: "Organize and filter contacts using color-coded tags.",
//     path: "/app/crm/tags",
//     icon: <Tags className="text-yellow-500" size={26} />,
//     action: "Manage Tags",
//     statLabel: "Total Tags",
//     statValue: 12,
//   },
//   {
//     id: "reminders",
//     label: "Reminders",
//     description: "Schedule follow-ups and set alerts to never miss a lead.",
//     path: "/app/crm/reminders",
//     icon: <BellRing className="text-blue-500" size={26} />,
//     action: "View Reminders",
//     statLabel: "Pending",
//     statValue: 3,
//   },
//   {
//     id: "timeline",
//     label: "Timeline",
//     description: "Track every interaction and touchpoint with each contact.",
//     path: "/app/crm/timeline",
//     icon: <Clock4 className="text-green-600" size={26} />,
//     action: "View Timeline",
//     statLabel: "Entries",
//     statValue: 150,
//     featureKey: "CRMInsights",
//   },
// ];

// export default function CrmWorkspacePage() {
//   const navigate = useNavigate();
//   const { availableFeatures = {}, isLoading, plan } = useAuth();

//   const [pinned, setPinned] = useState(
//     JSON.parse(localStorage.getItem("crm-pinned") || "[]")
//   );
//   const [archived, setArchived] = useState(
//     JSON.parse(localStorage.getItem("crm-archived") || "[]")
//   );
//   const [order, setOrder] = useState(
//     JSON.parse(localStorage.getItem("crm-order")) || crmBlocks.map(b => b.id)
//   );

//   const togglePin = id => {
//     const updated = pinned.includes(id)
//       ? pinned.filter(i => i !== id)
//       : [...pinned, id];
//     setPinned(updated);
//     localStorage.setItem("crm-pinned", JSON.stringify(updated));
//   };

//   const toggleArchive = id => {
//     const updated = archived.includes(id)
//       ? archived.filter(i => i !== id)
//       : [...archived, id];
//     setArchived(updated);
//     localStorage.setItem("crm-archived", JSON.stringify(updated));
//   };

//   const onDragEnd = result => {
//     if (!result.destination) return;
//     const newOrder = Array.from(order);
//     const [moved] = newOrder.splice(result.source.index, 1);
//     newOrder.splice(result.destination.index, 0, moved);
//     setOrder(newOrder);
//     localStorage.setItem("crm-order", JSON.stringify(newOrder));
//   };

//   const visibleBlocks = order
//     .filter(id => {
//       const block = crmBlocks.find(b => b.id === id);
//       if (!block || archived.includes(id)) return false;
//       if (block.featureKey && !availableFeatures[block.featureKey])
//         return false;
//       return true;
//     })
//     .map(id => crmBlocks.find(b => b.id === id));

//   if (isLoading) {
//     return (
//       <div className="p-10 text-center text-lg text-gray-500">
//         Loading features‚Ä¶
//       </div>
//     );
//   }

//   return (
//     <div
//       className="p-6 space-y-6 bg-gray-50 min-h-screen"
//       data-test-id="crm-root"
//     >
//       {/* Header */}
//       <h2 className="text-3xl font-bold text-gray-900 tracking-tight">
//         üß† CRM Workspace
//       </h2>
//       <p className="text-gray-600">
//         Manage your contacts, organize them with tags, track interactions, and
//         stay on top of reminders.
//       </p>

//       {/* Plan alert */}
//       {plan === "basic" && (
//         <div className="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-md shadow-sm">
//           You‚Äôre on the <strong>Basic</strong> plan. Upgrade to use CRM
//           timelines and get detailed history of contacts.
//           <button
//             onClick={() => navigate("/app/upgrade")}
//             className="ml-3 text-purple-700 underline hover:text-purple-900 font-medium"
//           >
//             Upgrade Now
//           </button>
//         </div>
//       )}

//       {/* Cards */}
//       <DragDropContext onDragEnd={onDragEnd}>
//         <Droppable droppableId="crm-blocks" direction="horizontal">
//           {provided => (
//             <div
//               className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"
//               ref={provided.innerRef}
//               {...provided.droppableProps}
//             >
//               {visibleBlocks.map((block, index) => (
//                 <Draggable key={block.id} draggableId={block.id} index={index}>
//                   {provided => (
//                     <div
//                       ref={provided.innerRef}
//                       {...provided.draggableProps}
//                       className={`rounded-2xl border bg-white shadow-lg/5 hover:shadow-lg transition transform hover:-translate-y-1 hover:border-purple-300 duration-200 overflow-hidden cursor-pointer`}
//                       onClick={e => {
//                         // prevent clicks on actions from triggering nav
//                         if (!e.target.closest("button,svg")) {
//                           navigate(block.path);
//                         }
//                       }}
//                     >
//                       {/* Top */}
//                       <div className="flex items-start gap-4 p-5">
//                         <div className="bg-gradient-to-br from-gray-100 to-white rounded-full p-3">
//                           {block.icon}
//                         </div>
//                         <div className="flex-1">
//                           <h3 className="text-lg font-semibold text-gray-900">
//                             {block.label}
//                           </h3>
//                           <p className="text-sm text-gray-500 mb-2">
//                             {block.description}
//                           </p>
//                           <div>
//                             <span className="text-2xl font-bold text-gray-900">
//                               {block.statValue}
//                             </span>
//                             <span className="ml-1 text-xs text-gray-500">
//                               {block.statLabel}
//                             </span>
//                           </div>
//                         </div>
//                         <div
//                           {...provided.dragHandleProps}
//                           className="cursor-grab text-gray-400 hover:text-gray-600"
//                         >
//                           <GripVertical size={16} />
//                         </div>
//                       </div>

//                       {/* Bottom actions */}
//                       <div className="px-5 py-3 border-t border-gray-100 flex items-center justify-between bg-gray-50">
//                         <button
//                           onClick={() => navigate(block.path)}
//                           className="text-sm text-purple-600 font-medium flex items-center gap-1 hover:bg-purple-50 px-3 py-1 rounded-md transition"
//                         >
//                           {block.action} <ArrowRightCircle size={18} />
//                         </button>
//                         <div className="flex items-center gap-3">
//                           <button
//                             onClick={() => togglePin(block.id)}
//                             title={pinned.includes(block.id) ? "Unpin" : "Pin"}
//                           >
//                             <Pin
//                               size={18}
//                               className={
//                                 pinned.includes(block.id)
//                                   ? "text-red-500"
//                                   : "text-gray-400 hover:text-red-500"
//                               }
//                             />
//                           </button>
//                           <button
//                             onClick={() => toggleArchive(block.id)}
//                             title="Archive"
//                           >
//                             <Archive
//                               size={18}
//                               className={
//                                 archived.includes(block.id)
//                                   ? "text-indigo-500"
//                                   : "text-gray-400 hover:text-indigo-500"
//                               }
//                             />
//                           </button>
//                         </div>
//                       </div>
//                     </div>
//                   )}
//                 </Draggable>
//               ))}
//               {provided.placeholder}
//             </div>
//           )}
//         </Droppable>
//       </DragDropContext>
//     </div>
//   );
// }

// import {
//   Archive,
//   Pin,
//   ArrowRightCircle,
//   MoreVertical,
//   UserCircle2,
//   Tags,
//   BellRing,
//   Clock4,
// } from "lucide-react";
// import { useNavigate } from "react-router-dom";
// import { useState } from "react";
// import { DragDropContext, Droppable, Draggable } from "react-beautiful-dnd";
// import { useAuth } from "../auth/context/AuthContext";

// const crmBlocks = [
//   {
//     id: "contacts",
//     label: "Contacts",
//     description: "Central place to manage leads, customers, and their details.",
//     path: "/app/crm/contacts",
//     icon: <UserCircle2 className="text-purple-600" size={26} />,
//     action: "Open Contacts",
//     statLabel: "Total Contacts",
//     statValue: 245,
//   },
//   {
//     id: "tags",
//     label: "Tags",
//     description: "Organize and filter contacts using color-coded tags.",
//     path: "/app/crm/tags",
//     icon: <Tags className="text-yellow-500" size={26} />,
//     action: "Manage Tags",
//     statLabel: "Total Tags",
//     statValue: 12,
//   },
//   {
//     id: "reminders",
//     label: "Reminders",
//     description: "Schedule follow-ups and set alerts to never miss a lead.",
//     path: "/app/crm/reminders",
//     icon: <BellRing className="text-blue-500" size={26} />,
//     action: "View Reminders",
//     statLabel: "Pending",
//     statValue: 3,
//   },
//   {
//     id: "timeline",
//     label: "Timeline",
//     description: "Track every interaction and touchpoint with each contact.",
//     path: "/app/crm/timeline",
//     icon: <Clock4 className="text-green-600" size={26} />,
//     action: "View Timeline",
//     statLabel: "Entries",
//     statValue: 150,
//     featureKey: "CRMInsights",
//   },
// ];

// export default function CrmWorkspacePage() {
//   const navigate = useNavigate();
//   const { availableFeatures = {}, isLoading, plan } = useAuth();

//   const [pinned, setPinned] = useState(
//     JSON.parse(localStorage.getItem("crm-pinned") || "[]")
//   );
//   const [archived, setArchived] = useState(
//     JSON.parse(localStorage.getItem("crm-archived") || "[]")
//   );
//   const [order, setOrder] = useState(
//     JSON.parse(localStorage.getItem("crm-order")) || crmBlocks.map(b => b.id)
//   );

//   const togglePin = id => {
//     const updated = pinned.includes(id)
//       ? pinned.filter(i => i !== id)
//       : [...pinned, id];
//     setPinned(updated);
//     localStorage.setItem("crm-pinned", JSON.stringify(updated));
//   };

//   const toggleArchive = id => {
//     const updated = archived.includes(id)
//       ? archived.filter(i => i !== id)
//       : [...archived, id];
//     setArchived(updated);
//     localStorage.setItem("crm-archived", JSON.stringify(updated));
//   };

//   const onDragEnd = result => {
//     if (!result.destination) return;
//     const newOrder = Array.from(order);
//     const [moved] = newOrder.splice(result.source.index, 1);
//     newOrder.splice(result.destination.index, 0, moved);
//     setOrder(newOrder);
//     localStorage.setItem("crm-order", JSON.stringify(newOrder));
//   };

//   const visibleBlocks = order
//     .filter(id => {
//       const block = crmBlocks.find(b => b.id === id);
//       if (!block || archived.includes(id)) return false;
//       if (block.featureKey && !availableFeatures[block.featureKey])
//         return false;
//       return true;
//     })
//     .map(id => crmBlocks.find(b => b.id === id));

//   if (isLoading) {
//     return (
//       <div className="p-10 text-center text-lg text-gray-500">
//         Loading features‚Ä¶
//       </div>
//     );
//   }

//   return (
//     <div className="p-6 space-y-6" data-test-id="crm-root">
//       {/* Header */}
//       <h2 className="text-3xl font-bold text-purple-800 mb-1">
//         üß† CRM Workspace
//       </h2>
//       <p className="text-gray-600 mb-4">
//         Manage your contacts, organize them with tags, track interactions, and
//         stay on top of reminders.
//       </p>

//       {/* Plan alert */}
//       {plan === "basic" && (
//         <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-md shadow-sm">
//           You‚Äôre on the <strong>Basic</strong> plan. Upgrade to use CRM
//           timelines and get detailed history of contacts.
//           <button
//             onClick={() => navigate("/app/upgrade")}
//             className="ml-3 text-purple-700 underline hover:text-purple-900 font-medium"
//           >
//             Upgrade Now
//           </button>
//         </div>
//       )}

//       {/* Cards */}
//       <DragDropContext onDragEnd={onDragEnd}>
//         <Droppable droppableId="crm-blocks" direction="horizontal">
//           {provided => (
//             <div
//               className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 overflow-x-auto pb-2"
//               ref={provided.innerRef}
//               {...provided.droppableProps}
//             >
//               {visibleBlocks.map((block, index) => (
//                 <Draggable key={block.id} draggableId={block.id} index={index}>
//                   {provided => (
//                     <div
//                       ref={provided.innerRef}
//                       {...provided.draggableProps}
//                       {...provided.dragHandleProps}
//                       className={`rounded-xl border shadow-sm transition transform hover:-translate-y-1 hover:shadow-lg duration-200 overflow-hidden cursor-pointer ${
//                         pinned.includes(block.id)
//                           ? "border-purple-500"
//                           : "border-gray-200"
//                       } ${
//                         index % 2 === 0
//                           ? "bg-gradient-to-br from-purple-50 to-white"
//                           : "bg-white"
//                       }`}
//                     >
//                       {/* Top */}
//                       <div className="flex items-start gap-4 p-5">
//                         <div className="bg-gray-100 rounded-lg p-3">
//                           {block.icon}
//                         </div>
//                         <div className="flex-1">
//                           <h3 className="text-md font-semibold text-purple-700">
//                             {block.label}
//                           </h3>
//                           <p className="text-sm text-gray-600 mb-2">
//                             {block.description}
//                           </p>
//                           <div>
//                             <span className="text-xl font-bold text-gray-900">
//                               {block.statValue}
//                             </span>
//                             <span className="ml-1 text-xs text-gray-500">
//                               {block.statLabel}
//                             </span>
//                           </div>
//                         </div>
//                         <MoreVertical
//                           size={16}
//                           className="text-gray-400 hover:text-gray-600"
//                         />
//                       </div>

//                       {/* Bottom actions */}
//                       <div className="px-5 py-3 border-t border-gray-200 flex items-center justify-between">
//                         <button
//                           onClick={() => navigate(block.path)}
//                           className="text-sm text-purple-600 font-medium flex items-center gap-1 hover:text-purple-800"
//                         >
//                           {block.action} <ArrowRightCircle size={18} />
//                         </button>
//                         <div className="flex items-center gap-3">
//                           <button
//                             onClick={() => togglePin(block.id)}
//                             title={pinned.includes(block.id) ? "Unpin" : "Pin"}
//                           >
//                             <Pin
//                               size={18}
//                               className={
//                                 pinned.includes(block.id)
//                                   ? "text-red-600"
//                                   : "text-gray-400 hover:text-red-500"
//                               }
//                             />
//                           </button>
//                           <button
//                             onClick={() => toggleArchive(block.id)}
//                             title="Archive"
//                           >
//                             <Archive
//                               size={18}
//                               className={
//                                 archived.includes(block.id)
//                                   ? "text-indigo-600"
//                                   : "text-gray-400 hover:text-indigo-500"
//                               }
//                             />
//                           </button>
//                         </div>
//                       </div>
//                     </div>
//                   )}
//                 </Draggable>
//               ))}
//               {provided.placeholder}
//             </div>
//           )}
//         </Droppable>
//       </DragDropContext>
//     </div>
//   );
// }
// import React, { useState } from "react";
// import {
//   Archive,
//   Pin,
//   ArrowRightCircle,
//   MoreVertical,
//   UserCircle2,
//   Tags,
//   BellRing,
//   Clock4,
// } from "lucide-react";
// import { useNavigate } from "react-router-dom";
// import { DragDropContext, Droppable, Draggable } from "react-beautiful-dnd";
// import { motion } from "framer-motion";
// import { useAuth } from "../auth/context/AuthContext";

// // Hook for count-up animation
// function useCountUp(target, duration = 1000) {
//   const [count, setCount] = useState(0);

//   React.useEffect(() => {
//     let start = 0;
//     const increment = target / (duration / 16);
//     const timer = setInterval(() => {
//       start += increment;
//       if (start >= target) {
//         setCount(target);
//         clearInterval(timer);
//       } else {
//         setCount(Math.floor(start));
//       }
//     }, 16);
//     return () => clearInterval(timer);
//   }, [target, duration]);

//   return count;
// }

// const crmBlocks = [
//   {
//     id: "contacts",
//     label: "Contacts",
//     description: "Central place to manage leads, customers, and their details.",
//     path: "/app/crm/contacts",
//     icon: <UserCircle2 className="text-purple-400" size={22} />,
//     action: "Open Contacts",
//     statLabel: "Total Contacts",
//     statValue: 245,
//   },
//   {
//     id: "tags",
//     label: "Tags",
//     description: "Organize and filter contacts using color-coded tags.",
//     path: "/app/crm/tags",
//     icon: <Tags className="text-yellow-400" size={22} />,
//     action: "Manage Tags",
//     statLabel: "Total Tags",
//     statValue: 12,
//   },
//   {
//     id: "reminders",
//     label: "Reminders",
//     description: "Schedule follow-ups and set alerts to never miss a lead.",
//     path: "/app/crm/reminders",
//     icon: <BellRing className="text-blue-400" size={22} />,
//     action: "View Reminders",
//     statLabel: "Pending",
//     statValue: 3,
//   },
//   {
//     id: "timeline",
//     label: "Timeline",
//     description: "Track every interaction and touchpoint with each contact.",
//     path: "/app/crm/timeline",
//     icon: <Clock4 className="text-green-400" size={22} />,
//     action: "View Timeline",
//     statLabel: "Entries",
//     statValue: 150,
//     featureKey: "CRMInsights",
//   },
// ];

// // Separate Card Component
// function StatCard({
//   block,
//   index,
//   navigate,
//   pinned,
//   togglePin,
//   archived,
//   toggleArchive,
// }) {
//   const count = useCountUp(block.statValue, 1200);

//   return (
//     <motion.div
//       initial={{ opacity: 0, y: 15 }}
//       animate={{ opacity: 1, y: 0 }}
//       transition={{ delay: index * 0.1 }}
//       className="rounded-xl bg-gray-900 border border-gray-800 hover:border-green-400 shadow-md hover:shadow-lg transition duration-300 flex flex-col justify-between"
//     >
//       <div className="flex items-start gap-4 p-5">
//         <div className="bg-gray-800 rounded-md p-2">{block.icon}</div>
//         <div className="flex-1">
//           <h3 className="text-md font-semibold text-white">{block.label}</h3>
//           <p className="text-sm text-gray-400 mb-2">{block.description}</p>
//           <div className="text-xs font-medium text-gray-500">
//             {block.statLabel}: <span className="text-white">{count}</span>
//           </div>
//         </div>
//         <MoreVertical size={16} className="text-gray-500" />
//       </div>
//       <div className="px-5 py-3 border-t border-gray-800 flex items-center justify-between">
//         <button
//           onClick={() => navigate(block.path)}
//           className="text-sm text-green-400 font-medium flex items-center gap-1 hover:text-green-300"
//         >
//           {block.action} <ArrowRightCircle size={18} />
//         </button>
//         <div className="flex items-center gap-3">
//           <button onClick={() => togglePin(block.id)} title="Pin this">
//             <Pin
//               size={18}
//               className={
//                 pinned.includes(block.id)
//                   ? "text-red-500"
//                   : "text-gray-500 hover:text-red-400"
//               }
//             />
//           </button>
//           <button onClick={() => toggleArchive(block.id)} title="Archive this">
//             <Archive
//               size={18}
//               className={
//                 archived.includes(block.id)
//                   ? "text-indigo-400"
//                   : "text-gray-500 hover:text-indigo-300"
//               }
//             />
//           </button>
//         </div>
//       </div>
//     </motion.div>
//   );
// }

// export default function CrmWorkspacePage() {
//   const navigate = useNavigate();
//   const { availableFeatures = {}, isLoading, plan } = useAuth();

//   const [pinned, setPinned] = useState(
//     JSON.parse(localStorage.getItem("crm-pinned") || "[]")
//   );
//   const [archived, setArchived] = useState(
//     JSON.parse(localStorage.getItem("crm-archived") || "[]")
//   );
//   const [order, setOrder] = useState(
//     JSON.parse(localStorage.getItem("crm-order")) || crmBlocks.map(b => b.id)
//   );

//   const togglePin = id => {
//     const updated = pinned.includes(id)
//       ? pinned.filter(i => i !== id)
//       : [...pinned, id];
//     setPinned(updated);
//     localStorage.setItem("crm-pinned", JSON.stringify(updated));
//   };

//   const toggleArchive = id => {
//     const updated = archived.includes(id)
//       ? archived.filter(i => i !== id)
//       : [...archived, id];
//     setArchived(updated);
//     localStorage.setItem("crm-archived", JSON.stringify(updated));
//   };

//   const onDragEnd = result => {
//     if (!result.destination) return;
//     const newOrder = Array.from(order);
//     const [moved] = newOrder.splice(result.source.index, 1);
//     newOrder.splice(result.destination.index, 0, moved);
//     setOrder(newOrder);
//     localStorage.setItem("crm-order", JSON.stringify(newOrder));
//   };

//   const visibleBlocks = order
//     .filter(id => {
//       const block = crmBlocks.find(b => b.id === id);
//       if (!block || archived.includes(id)) return false;
//       if (block.featureKey && !availableFeatures[block.featureKey])
//         return false;
//       return true;
//     })
//     .map(id => crmBlocks.find(b => b.id === id));

//   if (isLoading) {
//     return (
//       <div className="p-10 text-center text-lg text-gray-400">
//         Loading features‚Ä¶
//       </div>
//     );
//   }

//   return (
//     <div className="p-6 space-y-6 bg-gray-950 min-h-full">
//       <h2 className="text-3xl font-bold text-green-400">üß† CRM Workspace</h2>
//       <p className="text-gray-400">
//         Manage your contacts, organize them with tags, track interactions, and
//         stay on top of reminders.
//       </p>

//       {plan === "basic" && (
//         <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-md shadow-sm">
//           You‚Äôre on the <strong>Basic</strong> plan. Upgrade to use CRM
//           timelines and get detailed history of contacts.
//           <button
//             onClick={() => navigate("/app/upgrade")}
//             className="ml-3 text-green-600 underline hover:text-green-800 font-medium"
//           >
//             Upgrade Now
//           </button>
//         </div>
//       )}

//       <DragDropContext onDragEnd={onDragEnd}>
//         <Droppable droppableId="crm-blocks" direction="horizontal">
//           {provided => (
//             <div
//               className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"
//               ref={provided.innerRef}
//               {...provided.droppableProps}
//             >
//               {visibleBlocks.map((block, index) => (
//                 <Draggable key={block.id} draggableId={block.id} index={index}>
//                   {provided => (
//                     <div
//                       ref={provided.innerRef}
//                       {...provided.draggableProps}
//                       {...provided.dragHandleProps}
//                     >
//                       <StatCard
//                         block={block}
//                         index={index}
//                         navigate={navigate}
//                         pinned={pinned}
//                         togglePin={togglePin}
//                         archived={archived}
//                         toggleArchive={toggleArchive}
//                       />
//                     </div>
//                   )}
//                 </Draggable>
//               ))}
//               {provided.placeholder}
//             </div>
//           )}
//         </Droppable>
//       </DragDropContext>
//     </div>
//   );
// }

// üìÑ src/pages/Workspaces/CrmWorkspacePage.jsx

// below code is dark withour border effect
// import {
//   Archive,
//   Pin,
//   ArrowRightCircle,
//   MoreVertical,
//   UserCircle2,
//   Tags,
//   BellRing,
//   Clock4,
// } from "lucide-react";
// import { useNavigate } from "react-router-dom";
// import { useState } from "react";
// import { DragDropContext, Droppable, Draggable } from "react-beautiful-dnd";
// import { useAuth } from "../auth/context/AuthContext";

// const crmBlocks = [
//   {
//     id: "contacts",
//     label: "Contacts",
//     description: "Central place to manage leads, customers, and their details.",
//     path: "/app/crm/contacts",
//     icon: <UserCircle2 className="text-purple-400" size={28} />,
//     action: "Open Contacts",
//   },
//   {
//     id: "tags",
//     label: "Tags",
//     description: "Organize and filter contacts using color-coded tags.",
//     path: "/app/crm/tags",
//     icon: <Tags className="text-yellow-400" size={28} />,
//     action: "Manage Tags",
//   },
//   {
//     id: "reminders",
//     label: "Reminders",
//     description: "Schedule follow-ups and set alerts to never miss a lead.",
//     path: "/app/crm/reminders",
//     icon: <BellRing className="text-blue-400" size={28} />,
//     action: "View Reminders",
//   },
//   {
//     id: "timeline",
//     label: "Timeline",
//     description: "Track every interaction and touchpoint with each contact.",
//     path: "/app/crm/timeline",
//     icon: <Clock4 className="text-green-400" size={28} />,
//     action: "View Timeline",
//     featureKey: "CRMInsights",
//   },
// ];

// export default function CrmWorkspacePage() {
//   const navigate = useNavigate();
//   const { availableFeatures = {}, isLoading, plan } = useAuth();

//   const [pinned, setPinned] = useState(
//     JSON.parse(localStorage.getItem("crm-pinned") || "[]")
//   );
//   const [archived, setArchived] = useState(
//     JSON.parse(localStorage.getItem("crm-archived") || "[]")
//   );
//   const [order, setOrder] = useState(
//     JSON.parse(localStorage.getItem("crm-order")) || crmBlocks.map(b => b.id)
//   );

//   const togglePin = id => {
//     const updated = pinned.includes(id)
//       ? pinned.filter(i => i !== id)
//       : [...pinned, id];
//     setPinned(updated);
//     localStorage.setItem("crm-pinned", JSON.stringify(updated));
//   };

//   const toggleArchive = id => {
//     const updated = archived.includes(id)
//       ? archived.filter(i => i !== id)
//       : [...archived, id];
//     setArchived(updated);
//     localStorage.setItem("crm-archived", JSON.stringify(updated));
//   };

//   const onDragEnd = result => {
//     if (!result.destination) return;
//     const newOrder = Array.from(order);
//     const [moved] = newOrder.splice(result.source.index, 1);
//     newOrder.splice(result.destination.index, 0, moved);
//     setOrder(newOrder);
//     localStorage.setItem("crm-order", JSON.stringify(newOrder));
//   };

//   const visibleBlocks = order
//     .filter(id => {
//       const block = crmBlocks.find(b => b.id === id);
//       if (!block || archived.includes(id)) return false;
//       if (block.featureKey && !availableFeatures[block.featureKey])
//         return false;
//       return true;
//     })
//     .map(id => crmBlocks.find(b => b.id === id));

//   if (isLoading) {
//     return (
//       <div className="p-10 text-center text-lg text-gray-400">
//         Loading workspace‚Ä¶
//       </div>
//     );
//   }

//   return (
//     <div className="p-6 space-y-6">
//       <div>
//         <h2 className="text-2xl font-bold text-white mb-1">üß† CRM Workspace</h2>
//         <p className="text-gray-400">
//           Quick access to manage contacts, tags, reminders, and timelines.
//         </p>
//       </div>

//       {plan === "basic" && (
//         <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-md shadow-sm">
//           You‚Äôre on the <strong>Basic</strong> plan. Upgrade to use CRM
//           timelines and get detailed history of contacts.
//           <button
//             onClick={() => navigate("/app/upgrade")}
//             className="ml-3 text-purple-700 underline hover:text-purple-900 font-medium"
//           >
//             Upgrade Now
//           </button>
//         </div>
//       )}

//       <DragDropContext onDragEnd={onDragEnd}>
//         <Droppable droppableId="crm-blocks" direction="horizontal">
//           {provided => (
//             <div
//               className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
//               ref={provided.innerRef}
//               {...provided.droppableProps}
//             >
//               {visibleBlocks.map((block, index) => (
//                 <Draggable key={block.id} draggableId={block.id} index={index}>
//                   {provided => (
//                     <div
//                       ref={provided.innerRef}
//                       {...provided.draggableProps}
//                       {...provided.dragHandleProps}
//                       className="bg-[#1e293b] rounded-xl p-5 flex flex-col justify-between shadow-md hover:shadow-lg hover:-translate-y-0.5 transition transform duration-200"
//                     >
//                       <div className="flex items-start justify-between">
//                         <div className="bg-gray-800 p-3 rounded-lg">
//                           {block.icon}
//                         </div>
//                         <MoreVertical size={16} className="text-gray-500" />
//                       </div>
//                       <div className="mt-4 flex-1">
//                         <h3 className="text-lg font-semibold text-white">
//                           {block.label}
//                         </h3>
//                         <p className="text-gray-400 text-sm mt-1">
//                           {block.description}
//                         </p>
//                       </div>
//                       <div className="mt-5 flex items-center justify-between">
//                         <button
//                           onClick={() => navigate(block.path)}
//                           className="text-sm text-green-400 font-medium flex items-center gap-1 hover:text-green-300"
//                         >
//                           {block.action} <ArrowRightCircle size={18} />
//                         </button>
//                         <div className="flex items-center gap-3">
//                           <button onClick={() => togglePin(block.id)}>
//                             <Pin
//                               size={18}
//                               className={
//                                 pinned.includes(block.id)
//                                   ? "text-red-400"
//                                   : "text-gray-500 hover:text-red-400"
//                               }
//                             />
//                           </button>
//                           <button onClick={() => toggleArchive(block.id)}>
//                             <Archive
//                               size={18}
//                               className={
//                                 archived.includes(block.id)
//                                   ? "text-indigo-400"
//                                   : "text-gray-500 hover:text-indigo-400"
//                               }
//                             />
//                           </button>
//                         </div>
//                       </div>
//                     </div>
//                   )}
//                 </Draggable>
//               ))}
//               {provided.placeholder}
//             </div>
//           )}
//         </Droppable>
//       </DragDropContext>
//     </div>
//   );
// }

// import {
//   Archive,
//   Pin,
//   ArrowRightCircle,
//   MoreVertical,
//   TrendingUp,
//   TrendingDown,
//   UserCircle2,
//   Tags,
//   BellRing,
//   Clock4,
// } from "lucide-react";
// import { useNavigate } from "react-router-dom";
// import { useState } from "react";
// import { DragDropContext, Droppable, Draggable } from "react-beautiful-dnd";
// import { useAuth } from "../auth/context/AuthContext";

// const crmBlocks = [
//   {
//     id: "contacts",
//     label: "Contacts",
//     description: "Central place to manage leads, customers, and their details.",
//     path: "/app/crm/contacts",
//     icon: <UserCircle2 className="text-emerald-400" size={28} />,
//     action: "Open Contacts",
//     statLabel: "Total Contacts",
//     statValue: 245,
//     trend: { type: "up", value: "+12 this week" },
//   },
//   {
//     id: "tags",
//     label: "Tags",
//     description: "Organize and filter contacts using color-coded tags.",
//     path: "/app/crm/tags",
//     icon: <Tags className="text-yellow-400" size={28} />,
//     action: "Manage Tags",
//     statLabel: "Total Tags",
//     statValue: 12,
//     trend: { type: "up", value: "+3" },
//   },
//   {
//     id: "reminders",
//     label: "Reminders",
//     description: "Schedule follow-ups and set alerts to never miss a lead.",
//     path: "/app/crm/reminders",
//     icon: <BellRing className="text-blue-400" size={28} />,
//     action: "View Reminders",
//     statLabel: "Pending",
//     statValue: 3,
//     trend: { type: "down", value: "-1 overdue" },
//   },
//   {
//     id: "timeline",
//     label: "Timeline",
//     description: "Track every interaction and touchpoint with each contact.",
//     path: "/app/crm/timeline",
//     icon: <Clock4 className="text-purple-400" size={28} />,
//     action: "View Timeline",
//     statLabel: "Entries",
//     statValue: 150,
//     trend: { type: "up", value: "+20" },
//     featureKey: "CRMInsights",
//   },
// ];

// export default function CrmWorkspacePage() {
//   const navigate = useNavigate();
//   const { availableFeatures = {}, isLoading, plan } = useAuth();

//   const [pinned, setPinned] = useState(
//     JSON.parse(localStorage.getItem("crm-pinned") || "[]")
//   );
//   const [archived, setArchived] = useState(
//     JSON.parse(localStorage.getItem("crm-archived") || "[]")
//   );
//   const [order, setOrder] = useState(
//     JSON.parse(localStorage.getItem("crm-order")) || crmBlocks.map(b => b.id)
//   );

//   const togglePin = id => {
//     const updated = pinned.includes(id)
//       ? pinned.filter(i => i !== id)
//       : [...pinned, id];
//     setPinned(updated);
//     localStorage.setItem("crm-pinned", JSON.stringify(updated));
//   };

//   const toggleArchive = id => {
//     const updated = archived.includes(id)
//       ? archived.filter(i => i !== id)
//       : [...archived, id];
//     setArchived(updated);
//     localStorage.setItem("crm-archived", JSON.stringify(updated));
//   };

//   const onDragEnd = result => {
//     if (!result.destination) return;
//     const newOrder = Array.from(order);
//     const [moved] = newOrder.splice(result.source.index, 1);
//     newOrder.splice(result.destination.index, 0, moved);
//     setOrder(newOrder);
//     localStorage.setItem("crm-order", JSON.stringify(newOrder));
//   };

//   const visibleBlocks = order
//     .filter(id => {
//       const block = crmBlocks.find(b => b.id === id);
//       if (!block || archived.includes(id)) return false;
//       if (block.featureKey && !availableFeatures[block.featureKey])
//         return false;
//       return true;
//     })
//     .map(id => crmBlocks.find(b => b.id === id));

//   const pinnedBlocks = visibleBlocks.filter(b => pinned.includes(b.id));
//   const mainBlocks = visibleBlocks.filter(b => !pinned.includes(b.id));

//   if (isLoading) {
//     return (
//       <div className="p-10 text-center text-lg text-gray-400">
//         Loading features‚Ä¶
//       </div>
//     );
//   }

//   return (
//     <div
//       className="p-6 space-y-6 bg-[#0f172a] min-h-screen text-white"
//       data-test-id="crm-root"
//     >
//       {/* Header */}
//       <h2 className="text-3xl font-bold mb-1">
//         üß† <span className="text-white">CRM</span>{" "}
//         <span className="text-emerald-400">Workspace</span>
//       </h2>
//       <p className="text-gray-400 mb-4">
//         Manage your contacts, organize them with tags, track interactions, and
//         stay on top of reminders.
//       </p>

//       {/* Plan alert */}
//       {plan === "basic" && (
//         <div className="bg-yellow-900/30 border-l-4 border-yellow-500 text-yellow-300 p-4 rounded-md shadow-sm">
//           You‚Äôre on the <strong>Basic</strong> plan. Upgrade to use CRM
//           timelines and get detailed history of contacts.
//           <button
//             onClick={() => navigate("/app/upgrade")}
//             className="ml-3 text-emerald-400 underline hover:text-emerald-300 font-medium"
//           >
//             Upgrade Now
//           </button>
//         </div>
//       )}

//       {/* Pinned Favorites */}
//       {pinnedBlocks.length > 0 && (
//         <div>
//           <h3 className="text-lg font-semibold text-gray-300 mb-2">
//             ‚≠ê Favorites
//           </h3>
//           <div className="flex gap-4 overflow-x-auto pb-2">
//             {pinnedBlocks.map(block => (
//               <Card
//                 key={block.id}
//                 block={block}
//                 pinned
//                 togglePin={togglePin}
//                 toggleArchive={toggleArchive}
//                 navigate={navigate}
//               />
//             ))}
//           </div>
//         </div>
//       )}

//       {/* Main Cards */}
//       <DragDropContext onDragEnd={onDragEnd}>
//         <Droppable droppableId="crm-blocks" direction="horizontal">
//           {provided => (
//             <div
//               className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"
//               ref={provided.innerRef}
//               {...provided.droppableProps}
//             >
//               {mainBlocks.map((block, index) => (
//                 <Draggable key={block.id} draggableId={block.id} index={index}>
//                   {provided => (
//                     <div
//                       ref={provided.innerRef}
//                       {...provided.draggableProps}
//                       {...provided.dragHandleProps}
//                     >
//                       <Card
//                         block={block}
//                         pinned={false}
//                         togglePin={togglePin}
//                         toggleArchive={toggleArchive}
//                         navigate={navigate}
//                       />
//                     </div>
//                   )}
//                 </Draggable>
//               ))}
//               {provided.placeholder}
//             </div>
//           )}
//         </Droppable>
//       </DragDropContext>
//     </div>
//   );
// }

// /* Card Component */
// function Card({ block, pinned, togglePin, toggleArchive, navigate }) {
//   return (
//     <div className="rounded-xl border border-gray-700 bg-[#1e293b] shadow-md transition transform hover:-translate-y-1 hover:shadow-lg hover:border-emerald-400/50 duration-200 overflow-hidden">
//       {/* Top */}
//       <div className="flex items-start gap-4 p-5">
//         <div className="rounded-full p-3 bg-[#0f172a] border border-gray-600">
//           {block.icon}
//         </div>
//         <div className="flex-1">
//           <h3 className="text-md font-semibold text-white">{block.label}</h3>
//           <p className="text-sm text-gray-400 mb-1">{block.description}</p>

//           {/* Stat + Trend */}
//           {block.statValue > 0 ? (
//             <div className="flex items-center gap-2">
//               <span className="text-xl font-bold text-white">
//                 {block.statValue}
//               </span>
//               <span className="text-xs text-gray-400">{block.statLabel}</span>
//               {block.trend && (
//                 <span
//                   className={`flex items-center text-xs font-medium ${
//                     block.trend.type === "up"
//                       ? "text-emerald-400"
//                       : "text-red-400"
//                   }`}
//                 >
//                   {block.trend.type === "up" ? (
//                     <TrendingUp size={14} />
//                   ) : (
//                     <TrendingDown size={14} />
//                   )}
//                   {block.trend.value}
//                 </span>
//               )}
//             </div>
//           ) : (
//             <span className="text-xs text-gray-500 italic">
//               No data yet ‚Äî get started!
//             </span>
//           )}
//         </div>
//         <MoreVertical size={16} className="text-gray-500 hover:text-gray-300" />
//       </div>

//       {/* Bottom actions */}
//       <div className="px-5 py-3 border-t border-gray-700 flex items-center justify-between">
//         <button
//           onClick={() => navigate(block.path)}
//           className="text-sm text-emerald-400 font-medium flex items-center gap-1 hover:text-emerald-300"
//         >
//           {block.action} <ArrowRightCircle size={18} />
//         </button>
//         <div className="flex items-center gap-3">
//           <button
//             onClick={() => togglePin(block.id)}
//             title={pinned ? "Unpin" : "Pin"}
//           >
//             <Pin
//               size={18}
//               className={
//                 pinned ? "text-red-400" : "text-gray-500 hover:text-red-300"
//               }
//             />
//           </button>
//           <button onClick={() => toggleArchive(block.id)} title="Archive">
//             <Archive
//               size={18}
//               className="text-gray-500 hover:text-emerald-300"
//             />
//           </button>
//         </div>
//       </div>
//     </div>
//   );
// }

// import {
//   Archive,
//   Pin,
//   ArrowRightCircle,
//   MoreVertical,
//   UserCircle2,
//   Tags,
//   BellRing,
//   Clock4,
// } from "lucide-react";
// import { useNavigate } from "react-router-dom";
// import { useState } from "react";
// import { DragDropContext, Droppable, Draggable } from "react-beautiful-dnd";
// import { useAuth } from "../auth/context/AuthContext";

// const crmBlocks = [
//   {
//     id: "contacts",
//     label: "Contacts",
//     description: "Central place to manage leads, customers, and their details.",
//     path: "/app/crm/contacts",
//     icon: <UserCircle2 className="text-purple-600" size={22} />,
//     action: "Open Contacts",
//     statLabel: "Total Contacts",
//     statValue: 245, // placeholder
//   },
//   {
//     id: "tags",
//     label: "Tags",
//     description: "Organize and filter contacts using color-coded tags.",
//     path: "/app/crm/tags",
//     icon: <Tags className="text-yellow-500" size={22} />,
//     action: "Manage Tags",
//     statLabel: "Total Tags",
//     statValue: 12, // placeholder
//   },
//   {
//     id: "reminders",
//     label: "Reminders",
//     description: "Schedule follow-ups and set alerts to never miss a lead.",
//     path: "/app/crm/reminders",
//     icon: <BellRing className="text-blue-500" size={22} />,
//     action: "View Reminders",
//     statLabel: "Pending",
//     statValue: 3, // placeholder
//   },
//   {
//     id: "timeline",
//     label: "Timeline",
//     description: "Track every interaction and touchpoint with each contact.",
//     path: "/app/crm/timeline",
//     icon: <Clock4 className="text-green-600" size={22} />,
//     action: "View Timeline",
//     statLabel: "Entries",
//     statValue: 150, // placeholder
//     featureKey: "CRMInsights",
//   },
// ];

// export default function CrmWorkspacePage() {
//   const navigate = useNavigate();
//   const { availableFeatures = {}, isLoading, plan } = useAuth();

//   const [pinned, setPinned] = useState(
//     JSON.parse(localStorage.getItem("crm-pinned") || "[]")
//   );
//   const [archived, setArchived] = useState(
//     JSON.parse(localStorage.getItem("crm-archived") || "[]")
//   );
//   const [order, setOrder] = useState(
//     JSON.parse(localStorage.getItem("crm-order")) || crmBlocks.map(b => b.id)
//   );

//   const togglePin = id => {
//     const updated = pinned.includes(id)
//       ? pinned.filter(i => i !== id)
//       : [...pinned, id];
//     setPinned(updated);
//     localStorage.setItem("crm-pinned", JSON.stringify(updated));
//   };

//   const toggleArchive = id => {
//     const updated = archived.includes(id)
//       ? archived.filter(i => i !== id)
//       : [...archived, id];
//     setArchived(updated);
//     localStorage.setItem("crm-archived", JSON.stringify(updated));
//   };

//   const onDragEnd = result => {
//     if (!result.destination) return;
//     const newOrder = Array.from(order);
//     const [moved] = newOrder.splice(result.source.index, 1);
//     newOrder.splice(result.destination.index, 0, moved);
//     setOrder(newOrder);
//     localStorage.setItem("crm-order", JSON.stringify(newOrder));
//   };

//   const visibleBlocks = order
//     .filter(id => {
//       const block = crmBlocks.find(b => b.id === id);
//       if (!block || archived.includes(id)) return false;
//       if (block.featureKey && !availableFeatures[block.featureKey])
//         return false;
//       return true;
//     })
//     .map(id => crmBlocks.find(b => b.id === id));

//   if (isLoading) {
//     return (
//       <div className="p-10 text-center text-lg text-gray-500">
//         Loading features‚Ä¶
//       </div>
//     );
//   }

//   return (
//     <div className="p-6 space-y-6" data-test-id="crm-root">
//       <h2 className="text-3xl font-bold text-purple-800 mb-2">
//         üß† CRM Workspace
//       </h2>
//       <p className="text-gray-600 mb-6">
//         Manage your contacts, organize them with tags, track interactions, and
//         stay on top of reminders.
//       </p>

//       {plan === "basic" && (
//         <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-md shadow-sm">
//           You‚Äôre on the <strong>Basic</strong> plan. Upgrade to use CRM
//           timelines and get detailed history of contacts.
//           <button
//             onClick={() => navigate("/app/upgrade")}
//             className="ml-3 text-purple-700 underline hover:text-purple-900 font-medium"
//           >
//             Upgrade Now
//           </button>
//         </div>
//       )}

//       <DragDropContext onDragEnd={onDragEnd}>
//         <Droppable droppableId="crm-blocks" direction="horizontal">
//           {provided => (
//             <div
//               className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"
//               ref={provided.innerRef}
//               {...provided.droppableProps}
//             >
//               {visibleBlocks.map((block, index) => (
//                 <Draggable key={block.id} draggableId={block.id} index={index}>
//                   {provided => (
//                     <div
//                       ref={provided.innerRef}
//                       {...provided.draggableProps}
//                       {...provided.dragHandleProps}
//                       className={`rounded-xl border shadow-sm hover:shadow-md transition transform hover:-translate-y-0.5 duration-200 overflow-hidden ${
//                         index === 0
//                           ? "bg-gradient-to-br from-purple-50 to-white"
//                           : "bg-white"
//                       }`}
//                     >
//                       <div className="flex items-start gap-4 p-5">
//                         <div className="bg-gray-100 rounded-md p-2">
//                           {block.icon}
//                         </div>
//                         <div className="flex-1">
//                           <h3 className="text-md font-semibold text-purple-700">
//                             {block.label}
//                           </h3>
//                           <p className="text-sm text-gray-600 mb-2">
//                             {block.description}
//                           </p>
//                           <div className="text-xs font-medium text-gray-500">
//                             {block.statLabel}:{" "}
//                             <span className="text-gray-900">
//                               {block.statValue}
//                             </span>
//                           </div>
//                         </div>
//                         <MoreVertical size={16} className="text-gray-400" />
//                       </div>
//                       <div className="px-5 py-3 border-t border-gray-200 flex items-center justify-between">
//                         <button
//                           onClick={() => navigate(block.path)}
//                           className="text-sm text-purple-600 font-medium flex items-center gap-1 hover:text-purple-800"
//                         >
//                           {block.action} <ArrowRightCircle size={18} />
//                         </button>
//                         <div className="flex items-center gap-3">
//                           <button
//                             onClick={() => togglePin(block.id)}
//                             title="Pin this"
//                           >
//                             <Pin
//                               size={18}
//                               className={
//                                 pinned.includes(block.id)
//                                   ? "text-red-600"
//                                   : "text-gray-400 hover:text-red-500"
//                               }
//                             />
//                           </button>
//                           <button
//                             onClick={() => toggleArchive(block.id)}
//                             title="Archive this"
//                           >
//                             <Archive
//                               size={18}
//                               className={
//                                 archived.includes(block.id)
//                                   ? "text-indigo-600"
//                                   : "text-gray-400 hover:text-indigo-500"
//                               }
//                             />
//                           </button>
//                         </div>
//                       </div>
//                     </div>
//                   )}
//                 </Draggable>
//               ))}
//               {provided.placeholder}
//             </div>
//           )}
//         </Droppable>
//       </DragDropContext>
//     </div>
//   );
// }

// üìÑ src/pages/Workspaces/CrmWorkspacePage.jsx
// import {
//   Archive,
//   Pin,
//   ArrowRightCircle,
//   MoreVertical,
//   UserCircle2,
//   Tags,
//   BellRing,
//   Clock4,
// } from "lucide-react";
// import { useNavigate } from "react-router-dom";
// import { useState } from "react";
// import { DragDropContext, Droppable, Draggable } from "react-beautiful-dnd";
// import { useAuth } from "../auth/context/AuthContext";

// const crmBlocks = [
//   {
//     id: "contacts",
//     label: "Contacts",
//     description: "Central place to manage leads, customers, and their details.",
//     path: "/app/crm/contacts",
//     icon: <UserCircle2 className="text-purple-600" size={22} />,
//     action: "Open Contacts",
//   },
//   {
//     id: "tags",
//     label: "Tags",
//     description: "Organize and filter contacts using color-coded tags.",
//     path: "/app/crm/tags",
//     icon: <Tags className="text-yellow-500" size={22} />,
//     action: "Manage Tags",
//   },
//   {
//     id: "reminders",
//     label: "Reminders",
//     description: "Schedule follow-ups and set alerts to never miss a lead.",
//     path: "/app/crm/reminders",
//     icon: <BellRing className="text-blue-500" size={22} />,
//     action: "View Reminders",
//   },
//   {
//     id: "timeline",
//     label: "Timeline",
//     description: "Track every interaction and touchpoint with each contact.",
//     path: "/app/crm/timeline",
//     icon: <Clock4 className="text-green-600" size={22} />,
//     action: "View Timeline",
//     featureKey: "CRMInsights", // This must match backend
//   },
// ];

// export default function CrmWorkspacePage() {
//   const navigate = useNavigate();
//   const { availableFeatures = {}, isLoading, plan } = useAuth();

//   const [pinned, setPinned] = useState(() =>
//     JSON.parse(localStorage.getItem("crm-pinned") || "[]")
//   );
//   const [archived, setArchived] = useState(() =>
//     JSON.parse(localStorage.getItem("crm-archived") || "[]")
//   );
//   const [order, setOrder] = useState(
//     () =>
//       JSON.parse(localStorage.getItem("crm-order")) || crmBlocks.map(b => b.id)
//   );

//   const togglePin = id => {
//     const updated = pinned.includes(id)
//       ? pinned.filter(i => i !== id)
//       : [...pinned, id];
//     setPinned(updated);
//     localStorage.setItem("crm-pinned", JSON.stringify(updated));
//   };

//   const toggleArchive = id => {
//     const updated = archived.includes(id)
//       ? archived.filter(i => i !== id)
//       : [...archived, id];
//     setArchived(updated);
//     localStorage.setItem("crm-archived", JSON.stringify(updated));
//   };

//   const onDragEnd = result => {
//     if (!result.destination) return;
//     const newOrder = Array.from(order);
//     const [moved] = newOrder.splice(result.source.index, 1);
//     newOrder.splice(result.destination.index, 0, moved);
//     setOrder(newOrder);
//     localStorage.setItem("crm-order", JSON.stringify(newOrder));
//   };

//   // üö© Use featureKey to gate feature blocks
//   const visibleBlocks = order
//     .filter(id => {
//       const block = crmBlocks.find(b => b.id === id);
//       if (!block || archived.includes(id)) return false;
//       if (block.featureKey && !availableFeatures[block.featureKey])
//         return false;
//       return true;
//     })
//     .map(id => crmBlocks.find(b => b.id === id));

//   if (isLoading)
//     return (
//       <div className="p-10 text-center text-lg text-gray-500">
//         Loading features‚Ä¶
//       </div>
//     );

//   return (
//     <div className="p-6" data-test-id="crm-root">
//       <h2 className="text-2xl font-bold text-purple-800 mb-4">
//         üß† CRM Workspace
//       </h2>

//       {plan === "basic" && (
//         <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 mb-6 rounded-md shadow-sm">
//           You‚Äôre on the <strong>Basic</strong> plan. Upgrade to use CRM
//           timelines and get detailed history of contacts.{" "}
//           <button
//             onClick={() => navigate("/app/upgrade")}
//             className="ml-3 text-purple-700 underline hover:text-purple-900 font-medium"
//           >
//             Upgrade Now
//           </button>
//         </div>
//       )}

//       <DragDropContext onDragEnd={onDragEnd}>
//         <Droppable droppableId="crm-blocks" direction="horizontal">
//           {provided => (
//             <div
//               className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"
//               ref={provided.innerRef}
//               {...provided.droppableProps}
//             >
//               {visibleBlocks.map((block, index) => (
//                 <Draggable key={block.id} draggableId={block.id} index={index}>
//                   {provided => (
//                     <div
//                       ref={provided.innerRef}
//                       {...provided.draggableProps}
//                       {...provided.dragHandleProps}
//                       className="bg-white rounded-md border shadow-sm hover:shadow-md transition transform hover:-translate-y-0.5 duration-200"
//                     >
//                       <div className="flex items-start gap-4 p-5">
//                         <div className="bg-gray-100 rounded-md p-2">
//                           {block.icon}
//                         </div>
//                         <div className="flex-1">
//                           <h3 className="text-md font-semibold text-purple-700">
//                             {block.label}
//                           </h3>
//                           <p className="text-sm text-gray-600">
//                             {block.description}
//                           </p>
//                         </div>
//                         <MoreVertical size={16} className="text-gray-400" />
//                       </div>
//                       <div className="px-5 py-3 border-t border-gray-200 flex items-center justify-between">
//                         <button
//                           onClick={() => navigate(block.path)}
//                           className="text-sm text-purple-600 font-medium flex items-center gap-1 hover:text-purple-800"
//                         >
//                           {block.action} <ArrowRightCircle size={18} />
//                         </button>
//                         <div className="flex items-center gap-3">
//                           <button
//                             onClick={() => togglePin(block.id)}
//                             title="Pin this"
//                           >
//                             <Pin
//                               size={18}
//                               className={
//                                 pinned.includes(block.id)
//                                   ? "text-red-600"
//                                   : "text-gray-400 hover:text-red-500"
//                               }
//                             />
//                           </button>
//                           <button
//                             onClick={() => toggleArchive(block.id)}
//                             title="Archive this"
//                           >
//                             <Archive
//                               size={18}
//                               className={
//                                 archived.includes(block.id)
//                                   ? "text-indigo-600"
//                                   : "text-gray-400 hover:text-indigo-500"
//                               }
//                             />
//                           </button>
//                         </div>
//                       </div>
//                     </div>
//                   )}
//                 </Draggable>
//               ))}
//               {provided.placeholder}
//             </div>
//           )}
//         </Droppable>
//       </DragDropContext>
//     </div>
//   );
// }

// // üìÑ src/pages/Workspaces/CrmWorkspacePage.jsx

// import {
//   Archive,
//   Pin,
//   ArrowRightCircle,
//   MoreVertical,
//   UserCircle2,
//   Tags,
//   BellRing,
//   Clock4,
// } from "lucide-react";
// import { useNavigate } from "react-router-dom";
// import { useState } from "react";
// import { DragDropContext, Droppable, Draggable } from "react-beautiful-dnd";
// import { useAuth } from "../auth/context/AuthContext";

// const crmBlocks = [
//   {
//     id: "contacts",
//     label: "Contacts",
//     description: "Central place to manage leads, customers, and their details.",
//     path: "/app/crm/contacts",
//     icon: <UserCircle2 className="text-purple-600" size={22} />,
//     action: "Open Contacts",
//   },
//   {
//     id: "tags",
//     label: "Tags",
//     description: "Organize and filter contacts using color-coded tags.",
//     path: "/app/crm/tags",
//     icon: <Tags className="text-yellow-500" size={22} />,
//     action: "Manage Tags",
//   },
//   {
//     id: "reminders",
//     label: "Reminders",
//     description: "Schedule follow-ups and set alerts to never miss a lead.",
//     path: "/app/crm/reminders",
//     icon: <BellRing className="text-blue-500" size={22} />,
//     action: "View Reminders",
//   },
//   {
//     id: "timeline",
//     label: "Timeline",
//     description: "Track every interaction and touchpoint with each contact.",
//     path: "/app/crm/timeline",
//     icon: <Clock4 className="text-green-600" size={22} />,
//     action: "View Timeline",
//     featureKey: "CRMInsights", // This must match backend
//   },
// ];

// export default function CrmWorkspacePage() {
//   const navigate = useNavigate();
//   const { availableFeatures = {}, isLoading, plan } = useAuth();

//   const [pinned, setPinned] = useState(() =>
//     JSON.parse(localStorage.getItem("crm-pinned") || "[]")
//   );
//   const [archived, setArchived] = useState(() =>
//     JSON.parse(localStorage.getItem("crm-archived") || "[]")
//   );
//   const [order, setOrder] = useState(
//     () =>
//       JSON.parse(localStorage.getItem("crm-order")) || crmBlocks.map(b => b.id)
//   );

//   const togglePin = id => {
//     const updated = pinned.includes(id)
//       ? pinned.filter(i => i !== id)
//       : [...pinned, id];
//     setPinned(updated);
//     localStorage.setItem("crm-pinned", JSON.stringify(updated));
//   };

//   const toggleArchive = id => {
//     const updated = archived.includes(id)
//       ? archived.filter(i => i !== id)
//       : [...archived, id];
//     setArchived(updated);
//     localStorage.setItem("crm-archived", JSON.stringify(updated));
//   };

//   const onDragEnd = result => {
//     if (!result.destination) return;
//     const newOrder = Array.from(order);
//     const [moved] = newOrder.splice(result.source.index, 1);
//     newOrder.splice(result.destination.index, 0, moved);
//     setOrder(newOrder);
//     localStorage.setItem("crm-order", JSON.stringify(newOrder));
//   };

//   // üö© Use featureKey to gate feature blocks
//   const visibleBlocks = order
//     .filter(id => {
//       const block = crmBlocks.find(b => b.id === id);
//       if (!block || archived.includes(id)) return false;
//       if (block.featureKey && !availableFeatures[block.featureKey])
//         return false;
//       return true;
//     })
//     .map(id => crmBlocks.find(b => b.id === id));

//   if (isLoading)
//     return (
//       <div className="p-10 text-center text-lg text-gray-500">
//         Loading features‚Ä¶
//       </div>
//     );

//   return (
//     <div className="p-6">
//       <h2 className="text-2xl font-bold text-purple-800 mb-4">
//         üß† CRM Workspace
//       </h2>

//       {plan === "basic" && (
//         <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 mb-6 rounded-md shadow-sm">
//           You‚Äôre on the <strong>Basic</strong> plan. Upgrade to use CRM
//           timelines and get detailed history of contacts.{" "}
//           <button
//             onClick={() => navigate("/app/upgrade")}
//             className="ml-3 text-purple-700 underline hover:text-purple-900 font-medium"
//           >
//             Upgrade Now
//           </button>
//         </div>
//       )}

//       <DragDropContext onDragEnd={onDragEnd}>
//         <Droppable droppableId="crm-blocks" direction="horizontal">
//           {provided => (
//             <div
//               className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"
//               ref={provided.innerRef}
//               {...provided.droppableProps}
//             >
//               {visibleBlocks.map((block, index) => (
//                 <Draggable key={block.id} draggableId={block.id} index={index}>
//                   {provided => (
//                     <div
//                       ref={provided.innerRef}
//                       {...provided.draggableProps}
//                       {...provided.dragHandleProps}
//                       className="bg-white rounded-md border shadow-sm hover:shadow-md transition transform hover:-translate-y-0.5 duration-200"
//                     >
//                       <div className="flex items-start gap-4 p-5">
//                         <div className="bg-gray-100 rounded-md p-2">
//                           {block.icon}
//                         </div>
//                         <div className="flex-1">
//                           <h3 className="text-md font-semibold text-purple-700">
//                             {block.label}
//                           </h3>
//                           <p className="text-sm text-gray-600">
//                             {block.description}
//                           </p>
//                         </div>
//                         <MoreVertical size={16} className="text-gray-400" />
//                       </div>
//                       <div className="px-5 py-3 border-t border-gray-200 flex items-center justify-between">
//                         <button
//                           onClick={() => navigate(block.path)}
//                           className="text-sm text-purple-600 font-medium flex items-center gap-1 hover:text-purple-800"
//                         >
//                           {block.action} <ArrowRightCircle size={18} />
//                         </button>
//                         <div className="flex items-center gap-3">
//                           <button
//                             onClick={() => togglePin(block.id)}
//                             title="Pin this"
//                           >
//                             <Pin
//                               size={18}
//                               className={
//                                 pinned.includes(block.id)
//                                   ? "text-red-600"
//                                   : "text-gray-400 hover:text-red-500"
//                               }
//                             />
//                           </button>
//                           <button
//                             onClick={() => toggleArchive(block.id)}
//                             title="Archive this"
//                           >
//                             <Archive
//                               size={18}
//                               className={
//                                 archived.includes(block.id)
//                                   ? "text-indigo-600"
//                                   : "text-gray-400 hover:text-indigo-500"
//                               }
//                             />
//                           </button>
//                         </div>
//                       </div>
//                     </div>
//                   )}
//                 </Draggable>
//               ))}
//               {provided.placeholder}
//             </div>
//           )}
//         </Droppable>
//       </DragDropContext>
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Workspaces\DashboardWorkspace.jsx 
====================================================== 
 
// // import { useState } from "react";
// // import { useNavigate } from "react-router-dom";
// // import { Bar, Doughnut } from "react-chartjs-2";
// // import {
// //   Chart as ChartJS,
// //   CategoryScale,
// //   LinearScale,
// //   BarElement,
// //   Title,
// //   Tooltip,
// //   Legend,
// //   ArcElement,
// // } from "chart.js";
// // // ‚úÖ use the new provider (server-authoritative permissions)
// // import { useAuth } from "../../app/providers/AuthProvider";
// // import WelcomeCenter from "./WelcomeCenter";
// // import React from "react";
// // import axiosClient from "../../api/axiosClient";
// // import { toast } from "react-toastify";
// // ChartJS.register(
// //   CategoryScale,
// //   LinearScale,
// //   BarElement,
// //   Title,
// //   Tooltip,
// //   Legend,
// //   ArcElement
// // );

// // const widgetColors = [
// //   {
// //     icon: "üí∞",
// //     bg: "bg-emerald-50",
// //     ring: "ring-emerald-500",
// //     text: "text-emerald-600",
// //   },
// //   {
// //     icon: "üìà",
// //     bg: "bg-cyan-50",
// //     ring: "ring-cyan-500",
// //     text: "text-cyan-600",
// //   },
// //   {
// //     icon: "üìä",
// //     bg: "bg-sapphire-50",
// //     ring: "ring-sapphire-500",
// //     text: "text-sapphire-600",
// //   },
// //   {
// //     icon: "üí≥",
// //     bg: "bg-emerald-50",
// //     ring: "ring-emerald-500",
// //     text: "text-emerald-600",
// //   },
// //   {
// //     icon: "üë•",
// //     bg: "bg-cyan-50",
// //     ring: "ring-cyan-500",
// //     text: "text-cyan-600",
// //   },
// //   { icon: "‚Ü©Ô∏è", bg: "bg-red-50", ring: "ring-red-500", text: "text-red-600" },
// // ];

// // export default function DashboardWorkspace() {
// //   const { isLoading, hasAllAccess, can, userName } = useAuth();
// //   const navigate = useNavigate();
// //   const handleApplyWhatsAppAPI = () => navigate("/app/settings/whatsapp");

// //   // if you‚Äôve seeded "dashboard.view" on the server, this will gate the page
// //   const allowed =
// //     hasAllAccess || (typeof can === "function" && can("dashboard.view"));

// //   const [selectedRange, setSelectedRange] = useState("Last 7 days");
// //   const [activeTab, setActiveTab] = useState("welcome");
// //   const [showMigration, setShowMigration] = useState(false);
// //   const [showApplyModal, setShowApplyModal] = useState(false);
// //   const [migrationSubmitted, setMigrationSubmitted] = useState(false);

// //   const handleRangeChange = e => setSelectedRange(e.target.value);

// //   const kpis = [
// //     { label: "Total Revenue", value: "$12.5K" },
// //     { label: "New Leads", value: "384" },
// //     { label: "Conv. Rate", value: "3.7%" },
// //     { label: "Active Users", value: "1.2K" },
// //     { label: "Sessions", value: "3.4K" },
// //     { label: "Bounce Rate", value: "41%" },
// //   ];

// //   const messagesData = {
// //     labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
// //     datasets: [
// //       {
// //         label: "Messages Sent",
// //         data: [150, 200, 180, 220, 300, 250, 270],
// //         backgroundColor: "rgba(16, 185, 129, 0.8)",
// //         borderColor: "rgba(16, 185, 129, 1)",
// //         borderRadius: 6,
// //         borderWidth: 2,
// //         barThickness: 20,
// //       },
// //     ],
// //   };

// //   const deliveryData = {
// //     labels: ["Delivered", "Pending", "Failed"],
// //     datasets: [
// //       {
// //         label: "Delivery Status",
// //         data: [70, 20, 10],
// //         backgroundColor: ["#10b981", "#06b6d4", "#ef4444"],
// //         borderColor: ["#059669", "#0891b2", "#dc2626"],
// //         borderWidth: 2,
// //       },
// //     ],
// //   };
// //   const [connecting, setConnecting] = useState(false);
// //   // ‚¨áÔ∏è add
// //   const startFacebookConnect = async () => {
// //     try {
// //       setConnecting(true);

// //       // where user should land after Meta sends them back
// //       const returnUrl = "/app/settings/whatsapp";

// //       // you said BusinessId is always in localStorage
// //       const businessId =
// //         localStorage.getItem("businessId") ||
// //         localStorage.getItem("business_id");

// //       const res = await axiosClient.post("esu/facebook/start", {
// //         businessId,
// //         returnUrl,
// //       });

// //       const authUrl = res?.data?.authUrl;
// //       if (!authUrl) {
// //         toast.error("Could not get Facebook connect URL.");
// //         return;
// //       }

// //       // Go to Meta ESU
// //       window.location.href = authUrl;
// //     } catch (err) {
// //       toast.error(
// //         err?.response?.data?.message || "Failed to start Facebook Connect."
// //       );
// //     } finally {
// //       setConnecting(false);
// //     }
// //   };

// //   if (isLoading) {
// //     return (
// //       <div className="min-h-screen bg-gradient-to-br from-emerald-50 to-cyan-50 flex items-center justify-center">
// //         <div className="text-center">
// //           <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600 mx-auto mb-4"></div>
// //           <p className="text-emerald-700 font-semibold">Loading dashboard‚Ä¶</p>
// //         </div>
// //       </div>
// //     );
// //   }

// //   if (!allowed) {
// //     // If the route is already wrapped in a FeatureGuard (FEATURE_KEYS.Dashboard),
// //     // you won't normally hit this. It's a safe fallback.
// //     return (
// //       <div className="min-h-screen bg-gradient-to-br from-emerald-50 to-cyan-50 flex items-center justify-center p-6">
// //         <div className="bg-white rounded-xl shadow-lg border border-red-200 p-8 max-w-md text-center">
// //           <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
// //             <span className="text-2xl">üö´</span>
// //           </div>
// //           <h3 className="text-lg font-semibold text-gray-900 mb-2">
// //             Access Denied
// //           </h3>
// //           <p className="text-red-700">
// //             You don't have access to the Dashboard.
// //           </p>
// //         </div>
// //       </div>
// //     );
// //   }

// //   return (
// //     <div className="min-h-screen">
// //       <div className="max-w-7xl mx-auto px-4 pt-4 pb-8">
// //         <div className="mb-4">
// //           <h1 className="text-2xl font-bold text-gray-900 mb-1">Dashboard</h1>
// //         </div>

// //         {/* Start WhatsApp Engagement Section - redesigned */}
// //         <div className="relative rounded-xl bg-gradient-to-br from-emerald-50 via-cyan-50 to-white border border-emerald-100 shadow-md overflow-hidden mb-6">
// //           {/* Subtle background accent icon */}
// //           <div className="hidden md:block absolute right-6 bottom-0 opacity-10 pointer-events-none select-none">
// //             <div className="bg-emerald-200 rounded-full w-36 h-36 flex items-center justify-center">
// //               <svg width="64" height="64" fill="none" viewBox="0 0 64 64">
// //                 <rect width="64" height="64" rx="32" fill="#059669" />
// //                 <path
// //                   d="M32 19c-5.523 0-10 4.252-10 9.5 0 2.5 1.23 4.523 3.073 6.223l-1.073 3.527c-.124.412.328.779.705.567l3.51-2.076c1.151.334 2.343.505 3.785.505 5.523 0 10-4.253 10-9.5C42 23.252 37.523 19 32 19z"
// //                   fill="#fff"
// //                 />
// //               </svg>
// //             </div>
// //           </div>
// //           <div className="relative z-10 flex flex-col md:flex-row gap-6 items-center md:items-stretch justify-between p-6">
// //             <div className="max-w-xl flex-1">
// //               <h3 className="text-xl md:text-2xl font-bold text-emerald-900 mb-2">
// //                 Start WhatsApp Engagement for your Business
// //               </h3>
// //               <p className="text-slate-700 mb-3">
// //                 You'll need to Apply for WhatsApp Business API to use XploreByte
// //                 for your Business. Start your API application by choosing one of
// //                 the options.
// //               </p>
// //               <div className="flex flex-col gap-2 sm:flex-row">
// //                 <button
// //                   onClick={() => setShowApplyModal(true)}
// //                   className="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg font-semibold shadow hover:shadow-md focus:outline-none focus:ring-2 focus:ring-emerald-300 transition"
// //                 >
// //                   Apply for WhatsApp Business API (FREE)
// //                 </button>
// //                 <button
// //                   className="border-2 border-emerald-500 text-emerald-700 hover:bg-emerald-50 hover:border-emerald-600 px-6 py-2 rounded-lg font-semibold transition"
// //                   onClick={() => setShowMigration(true)}
// //                 >
// //                   Migrate from Another Vendor
// //                 </button>
// //               </div>
// //               <p className="text-xs text-emerald-700 mt-3">
// //                 Want to know more about XploreByte?{" "}
// //                 <button className="underline font-semibold hover:text-emerald-900">
// //                   Click to schedule a Live Demo
// //                 </button>
// //               </p>
// //             </div>
// //             <div className="flex-shrink-0 flex justify-center items-center md:justify-end mt-6 md:mt-0">
// //               <img
// //                 src="/img/applyforwhatsappapi.webp"
// //                 alt="Apply for WhatsApp API"
// //                 className="h-52 w-auto md:h-64 object-contain drop-shadow-xl"
// //               />
// //             </div>
// //           </div>
// //         </div>

// //         {/* Welcome badge above tabs - aligned to emerald/cyan theme */}

// //         {/* Tabs */}
// //         <div className="bg-white rounded-t-lg shadow-sm border border-gray-200 border-b-0">
// //           <nav className="flex" aria-label="Tabs">
// //             <button
// //               className={`flex-1 px-6 py-3 text-sm font-medium transition-all duration-200 ${
// //                 activeTab === "welcome"
// //                   ? "text-emerald-700 border-b-2 border-emerald-500 bg-emerald-50/30"
// //                   : "text-gray-500 hover:text-gray-700 hover:bg-gray-50"
// //               }`}
// //               onClick={() => setActiveTab("welcome")}
// //             >
// //               <div className="flex items-center justify-center space-x-2">
// //                 <span className="text-base">üéâ</span>
// //                 <span>Welcome</span>
// //               </div>
// //             </button>
// //             <button
// //               className={`flex-1 px-6 py-3 text-sm font-medium transition-all duration-200 ${
// //                 activeTab === "overview"
// //                   ? "text-emerald-700 border-b-2 border-emerald-500 bg-emerald-50/30"
// //                   : "text-gray-500 hover:text-gray-700 hover:bg-gray-50"
// //               }`}
// //               onClick={() => setActiveTab("overview")}
// //             >
// //               <div className="flex items-center justify-center space-x-2">
// //                 <span className="text-base">üìä</span>
// //                 <span>Overview</span>
// //               </div>
// //             </button>
// //             <button
// //               className={`flex-1 px-6 py-3 text-sm font-medium transition-all duration-200 ${
// //                 activeTab === "engagement"
// //                   ? "text-emerald-700 border-b-2 border-emerald-500 bg-emerald-50/30"
// //                   : "text-gray-500 hover:text-gray-700 hover:bg-gray-50"
// //               }`}
// //               onClick={() => setActiveTab("engagement")}
// //             >
// //               <div className="flex items-center justify-center space-x-2">
// //                 <span className="text-base">üí¨</span>
// //                 <span>Engagement</span>
// //               </div>
// //             </button>
// //           </nav>
// //         </div>

// //         {activeTab === "overview" && (
// //           <div className="bg-white rounded-b-lg shadow-sm border border-gray-200 border-t-0 p-6">
// //             {/* Filter Controls - Only for Overview tab */}
// //             <div className="flex justify-between items-center mb-6">
// //               <div className="flex items-center gap-3">
// //                 <select
// //                   value={selectedRange}
// //                   onChange={handleRangeChange}
// //                   className="bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
// //                 >
// //                   <option>Last 7 days</option>
// //                   <option>Last 30 days</option>
// //                   <option>This month</option>
// //                 </select>
// //                 <button className="bg-white border border-gray-200 rounded-lg px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 hover:border-gray-300 transition-colors">
// //                   Export
// //                 </button>
// //               </div>
// //             </div>

// //             {/* KPI widgets */}
// //             <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-6 mb-8">
// //               {kpis.map((kpi, i) => (
// //                 <div
// //                   key={i}
// //                   className="group bg-white rounded-xl p-6 shadow-lg border border-gray-200 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 hover:border-gray-300"
// //                 >
// //                   <div className="flex items-center justify-between mb-3">
// //                     <div
// //                       className={`inline-flex items-center justify-center w-10 h-10 rounded-xl ${
// //                         widgetColors[i % widgetColors.length].bg
// //                       }`}
// //                     >
// //                       <span className="text-lg">
// //                         {widgetColors[i % widgetColors.length].icon}
// //                       </span>
// //                     </div>
// //                     <div
// //                       className={`w-3 h-3 rounded-full ${
// //                         widgetColors[i % widgetColors.length].bg
// //                       }`}
// //                     />
// //                   </div>
// //                   <div>
// //                     <p className="text-sm text-gray-600 font-medium mb-1">
// //                       {kpi.label}
// //                     </p>
// //                     <p className="text-2xl font-bold text-gray-900">
// //                       {kpi.value}
// //                     </p>
// //                   </div>
// //                 </div>
// //               ))}
// //             </div>

// //             {/* Charts */}
// //             <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
// //               <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hover:border-gray-300 transition-all duration-200 col-span-2">
// //                 <div className="flex items-center gap-2 mb-4">
// //                   <div className="w-8 h-8 bg-emerald-100 rounded-lg flex items-center justify-center">
// //                     <span className="text-emerald-600">üìà</span>
// //                   </div>
// //                   <h3 className="text-lg font-semibold text-gray-900">
// //                     Messages Sent (Weekly)
// //                   </h3>
// //                 </div>
// //                 <Bar
// //                   data={messagesData}
// //                   options={{
// //                     responsive: true,
// //                     plugins: { legend: { display: false } },
// //                     scales: {
// //                       y: {
// //                         beginAtZero: true,
// //                         grid: { color: "#f3f4f6" },
// //                         ticks: { color: "#6b7280" },
// //                       },
// //                       x: {
// //                         grid: { color: "#f3f4f6" },
// //                         ticks: { color: "#6b7280" },
// //                       },
// //                     },
// //                   }}
// //                   height={200}
// //                 />
// //               </div>
// //               <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hover:border-gray-300 transition-all duration-200">
// //                 <div className="flex items-center gap-2 mb-4">
// //                   <div className="w-8 h-8 bg-cyan-100 rounded-lg flex items-center justify-center">
// //                     <span className="text-cyan-600">üìä</span>
// //                   </div>
// //                   <h3 className="text-lg font-semibold text-gray-900">
// //                     Delivery Status
// //                   </h3>
// //                 </div>
// //                 <Doughnut
// //                   data={deliveryData}
// //                   options={{
// //                     responsive: true,
// //                     plugins: {
// //                       legend: {
// //                         position: "bottom",
// //                         labels: { color: "#6b7280", font: { size: 12 } },
// //                       },
// //                     },
// //                   }}
// //                 />
// //               </div>
// //             </div>

// //             {/* Compact widgets */}
// //             <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
// //               <div className="bg-white rounded-xl p-6 shadow-lg border border-gray-200 hover:shadow-xl hover:border-gray-300 transition-all duration-200">
// //                 <div className="flex items-center gap-3 mb-3">
// //                   <div className="w-8 h-8 bg-emerald-100 rounded-lg flex items-center justify-center">
// //                     <span className="text-emerald-600">üéØ</span>
// //                   </div>
// //                   <h4 className="text-sm font-semibold text-gray-900">
// //                     Top Performing CTA
// //                   </h4>
// //                 </div>
// //                 <p className="text-xl font-bold text-gray-900 mb-1">
// //                   Get Quote Now
// //                 </p>
// //                 <p className="text-sm text-emerald-600 font-medium">
// //                   CTR: 42.3%
// //                 </p>
// //               </div>
// //               <div className="bg-white rounded-xl p-6 shadow-lg border border-gray-200 hover:shadow-xl hover:border-gray-300 transition-all duration-200">
// //                 <div className="flex items-center gap-3 mb-3">
// //                   <div className="w-8 h-8 bg-cyan-100 rounded-lg flex items-center justify-center">
// //                     <span className="text-cyan-600">üì±</span>
// //                   </div>
// //                   <h4 className="text-sm font-semibold text-gray-900">
// //                     Most Used Channel
// //                   </h4>
// //                 </div>
// //                 <p className="text-xl font-bold text-gray-900 mb-1">WhatsApp</p>
// //                 <p className="text-sm text-cyan-600 font-medium">
// //                   68% of total campaigns
// //                 </p>
// //               </div>
// //               <div className="bg-white rounded-xl p-6 shadow-lg border border-gray-200 hover:shadow-xl hover:border-gray-300 transition-all duration-200">
// //                 <div className="flex items-center gap-3 mb-3">
// //                   <div className="w-8 h-8 bg-sapphire-100 rounded-lg flex items-center justify-center">
// //                     <span className="text-sapphire-600">‚è±Ô∏è</span>
// //                   </div>
// //                   <h4 className="text-sm font-semibold text-gray-900">
// //                     Avg. Response Time
// //                   </h4>
// //                 </div>
// //                 <p className="text-xl font-bold text-gray-900 mb-1">3m 28s</p>
// //                 <p className="text-sm text-sapphire-600 font-medium">
// //                   Based on last 100 events
// //                 </p>
// //               </div>
// //             </div>
// //           </div>
// //         )}

// //         {activeTab === "engagement" && (
// //           <div className="bg-white rounded-b-lg shadow-sm border border-gray-200 border-t-0 p-12 text-center">
// //             <div className="w-20 h-20 bg-gradient-to-br from-emerald-100 to-cyan-100 rounded-full flex items-center justify-center mx-auto mb-4">
// //               <span className="text-3xl">üí¨</span>
// //             </div>
// //             <h3 className="text-xl font-semibold text-gray-900 mb-2">
// //               Engagement Metrics
// //             </h3>
// //             <p className="text-gray-600 mb-6">
// //               Detailed engagement analytics coming soon...
// //             </p>
// //             <div className="inline-flex items-center gap-2 px-4 py-2 bg-emerald-50 text-emerald-700 rounded-lg text-sm font-medium">
// //               <span>üöÄ</span>
// //               <span>Stay tuned for updates</span>
// //             </div>
// //           </div>
// //         )}

// //         {activeTab === "welcome" && (
// //           <div className="bg-white rounded-b-lg shadow-sm border border-gray-200 border-t-0 overflow-hidden">
// //             <WelcomeCenter />
// //           </div>
// //         )}
// //       </div>
// //       {/* Migration Help Popup */}
// //       {showMigration && (
// //         <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50">
// //           <div className="bg-gradient-to-br from-emerald-50 via-cyan-50 to-white max-w-2xl w-full rounded-2xl shadow-lg p-8 text-emerald-900 relative border border-emerald-100">
// //             <div className="absolute right-5 top-5">
// //               <button
// //                 onClick={() => setShowMigration(false)}
// //                 className="bg-emerald-100 hover:bg-emerald-200 rounded-full w-8 h-8 flex items-center justify-center"
// //               >
// //                 <span className="text-xl text-emerald-900 font-bold">√ó</span>
// //               </button>
// //             </div>
// //             <h2 className="text-2xl font-bold mb-1 flex items-center gap-2">
// //               Migration <span className="text-lg">üìñ</span>
// //               <span className="text-base font-medium text-slate-700">
// //                 How to Migrate?
// //               </span>
// //             </h2>
// //             <p className="mb-4 mt-1 text-slate-700">
// //               Before migrating, please check the following to ensure a smooth
// //               migration process:
// //             </p>
// //             <ol className="list-decimal ml-5 mb-5 space-y-1 text-slate-700">
// //               <li>Ensure your WhatsApp Display Name is approved</li>
// //               <li>
// //                 Turn off two-factor authentication for your WhatsApp account
// //               </li>
// //               <li>
// //                 Make sure your phone number is active and can receive SMS OTP
// //               </li>
// //             </ol>
// //             <div className="flex gap-4 mt-6">
// //               {!migrationSubmitted ? (
// //                 <button
// //                   className="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-6 py-2 rounded-md shadow hover:bg-emerald-700 transition"
// //                   onClick={() => setMigrationSubmitted(true)}
// //                 >
// //                   Start Migration
// //                 </button>
// //               ) : null}
// //               <button
// //                 className="border border-emerald-400 text-emerald-900 px-6 py-2 rounded-md flex items-center gap-2 hover:bg-emerald-50 transition"
// //                 onClick={() => setShowMigration(false)}
// //               >
// //                 <span className="text-xl">‚Üê</span> Go back
// //               </button>
// //             </div>
// //             <div className="absolute right-8 -bottom-6 md:right-2 md:bottom-6">
// //               <img
// //                 src="/img/otp.webp"
// //                 alt="Migrate requirements illustration"
// //                 className="h-24 w-auto select-none"
// //               />
// //             </div>
// //             {migrationSubmitted && (
// //               <div className="absolute inset-0 bg-white flex flex-col items-center justify-center z-30 rounded-2xl px-6 py-16 text-center">
// //                 <div className="flex items-center justify-center mb-3">
// //                   <span className="inline-flex items-center justify-center w-12 h-12 rounded-full bg-emerald-100">
// //                     <svg
// //                       width="28"
// //                       height="28"
// //                       viewBox="0 0 40 40"
// //                       fill="none"
// //                       xmlns="http://www.w3.org/2000/svg"
// //                     >
// //                       <circle cx="20" cy="20" r="20" fill="#10B981" />
// //                       <path
// //                         d="M13.5 21.5L18 26L27 17"
// //                         stroke="white"
// //                         strokeWidth="3"
// //                         strokeLinecap="round"
// //                         strokeLinejoin="round"
// //                       />
// //                     </svg>
// //                   </span>
// //                 </div>
// //                 <h3 className="text-xl font-bold mb-2 text-emerald-900">
// //                   Migration Request Submitted!
// //                 </h3>
// //                 <p className="mb-5 text-slate-700 max-w-md">
// //                   Your migration request has been successfully registered! One
// //                   of our representatives will contact you within 48 hours to
// //                   assist with your migration. If you have any questions or
// //                   require urgent help, feel free to contact our support team.
// //                 </p>
// //                 <button
// //                   className="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-8 py-2 rounded-md shadow mt-4 mb-4"
// //                   onClick={() => {
// //                     setShowMigration(false);
// //                     setMigrationSubmitted(false);
// //                   }}
// //                 >
// //                   Close
// //                 </button>
// //               </div>
// //             )}
// //           </div>
// //         </div>
// //       )}
// //       {/* Apply for WhatsApp Business API Modal */}
// //       {showApplyModal && (
// //         <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50">
// //           <div className="bg-white max-w-2xl w-full rounded-2xl shadow-lg p-8 text-gray-900 relative border border-gray-200">
// //             <button
// //               onClick={() => setShowApplyModal(false)}
// //               className="absolute right-5 top-5 bg-gray-100 hover:bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center"
// //             >
// //               <span className="text-xl">√ó</span>
// //             </button>
// //             <h2 className="text-xl md:text-2xl font-bold mb-2 text-emerald-900">
// //               Apply for WhatsApp Business API
// //             </h2>
// //             <p className="mb-2 text-[15px] font-medium text-emerald-700">
// //               Click on Continue With Facebook to apply for WhatsApp Business API
// //             </p>
// //             <div className="mb-4">
// //               <span className="block font-semibold text-gray-700 mb-1">
// //                 Requirements to apply for WhatsApp Business API
// //               </span>
// //               <ul className="text-gray-600 text-[15px] mb-2 list-disc ml-6">
// //                 <li>A Registered Business & Working Website.</li>
// //               </ul>
// //               <div className="flex items-center gap-2 text-emerald-700 mb-2">
// //                 <span className="text-lg">üìñ</span>
// //                 <a
// //                   href="https://help.xplorebyte.com"
// //                   target="_blank"
// //                   rel="noopener noreferrer"
// //                   className="underline hover:text-emerald-900 font-semibold"
// //                 >
// //                   How to apply for WhatsApp Business API?
// //                 </a>
// //               </div>
// //             </div>
// //             <div className="flex flex-col md:flex-row gap-5 items-start md:items-center mb-6">
// //               <div className="flex-1">
// //                 <div className="aspect-video w-full max-w-md rounded-lg overflow-hidden border border-gray-200">
// //                   <iframe
// //                     width="100%"
// //                     height="260"
// //                     src="https://www.youtube.com/embed/YOUR_VIDEO_ID"
// //                     title="How to get FREE WhatsApp API"
// //                     frameBorder="0"
// //                     allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
// //                     allowFullScreen
// //                   ></iframe>
// //                 </div>
// //               </div>
// //             </div>
// //             <div className="flex flex-col md:flex-row gap-3 justify-end mt-3">
// //               <button
// //                 className="border border-emerald-400 text-emerald-900 px-6 py-2 rounded-md flex items-center gap-2 hover:bg-emerald-50 transition"
// //                 onClick={() => {
// //                   setShowApplyModal(false);
// //                   setShowMigration(true);
// //                 }}
// //               >
// //                 Migrate from another vendor
// //               </button>
// //               {/* <button
// //                 className="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-md font-semibold shadow transition"
// //                 onClick={() => {
// //                   setShowApplyModal(false);
// //                   setTimeout(() => navigate("/app/settings/whatsapp"), 300);
// //                 }}
// //               >
// //                 Continue With Facebook
// //               </button> */}
// //               <button
// //                 className="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-md font-semibold shadow transition disabled:opacity-60"
// //                 disabled={connecting}
// //                 onClick={async () => {
// //                   // optional: hide the modal before redirect
// //                   setShowApplyModal(false);
// //                   await startFacebookConnect();
// //                 }}
// //               >
// //                 {connecting ? "Connecting‚Ä¶" : "Continue With Facebook"}
// //               </button>
// //             </div>
// //           </div>
// //         </div>
// //       )}
// //     </div>
// //   );
// // }
// import { useState } from "react";
// import { useNavigate } from "react-router-dom";
// import { Bar, Doughnut } from "react-chartjs-2";
// import {
//   Chart as ChartJS,
//   CategoryScale,
//   LinearScale,
//   BarElement,
//   Title,
//   Tooltip,
//   Legend,
//   ArcElement,
// } from "chart.js";
// // ‚úÖ server-authoritative permissions

// import { useAuth } from "../auth/context/pld_AuthContext";
// import WelcomeCenter from "./WelcomeCenter";
// import React from "react";
// import axiosClient from "../../api/axiosClient";
// import { toast } from "react-toastify";

// ChartJS.register(
//   CategoryScale,
//   LinearScale,
//   BarElement,
//   Title,
//   Tooltip,
//   Legend,
//   ArcElement
// );

// const widgetColors = [
//   {
//     icon: "üí∞",
//     bg: "bg-emerald-50",
//     ring: "ring-emerald-500",
//     text: "text-emerald-600",
//   },
//   {
//     icon: "üìà",
//     bg: "bg-cyan-50",
//     ring: "ring-cyan-500",
//     text: "text-cyan-600",
//   },
//   {
//     icon: "üìä",
//     bg: "bg-sapphire-50",
//     ring: "ring-sapphire-500",
//     text: "text-sapphire-600",
//   },
//   {
//     icon: "üí≥",
//     bg: "bg-emerald-50",
//     ring: "ring-emerald-500",
//     text: "text-emerald-600",
//   },
//   {
//     icon: "üë•",
//     bg: "bg-cyan-50",
//     ring: "ring-cyan-500",
//     text: "text-cyan-600",
//   },
//   { icon: "‚Ü©Ô∏è", bg: "bg-red-50", ring: "ring-red-500", text: "text-red-600" },
// ];

// export default function DashboardWorkspace() {
//   const { isLoading, hasAllAccess, can, userName } = useAuth();
//   const navigate = useNavigate();

//   // if you‚Äôve seeded "dashboard.view" on the server, this will gate the page
//   const allowed =
//     hasAllAccess || (typeof can === "function" && can("dashboard.view"));

//   const [selectedRange, setSelectedRange] = useState("Last 7 days");
//   const [activeTab, setActiveTab] = useState("welcome");
//   const [showMigration, setShowMigration] = useState(false);
//   const [showApplyModal, setShowApplyModal] = useState(false);
//   const [migrationSubmitted, setMigrationSubmitted] = useState(false);
//   const [connecting, setConnecting] = useState(false);

//   const handleRangeChange = e => setSelectedRange(e.target.value);

//   // === ESU START: call backend to get authUrl and redirect to Meta ===
//   const startFacebookConnect = async () => {
//     try {
//       setConnecting(true);

//       // where the user should land after Meta sends them back
//       const returnUrlAfterSuccess = "/app/settings/whatsapp";

//       // BusinessId stored by your auth flow
//       const businessId =
//         localStorage.getItem("businessId") ||
//         localStorage.getItem("business_id");

//       if (!businessId) {
//         toast.error("Business context missing. Please re-login.");
//         return;
//       }

//       const res = await axiosClient.post(
//         "esu/facebook/start",
//         { returnUrlAfterSuccess },
//         { headers: { "X-Business-Id": businessId } }
//       );

//       const authUrl = res?.data?.data?.authUrl;
//       if (!authUrl) {
//         const msg = res?.data?.message || "Could not get Facebook connect URL.";
//         toast.error(msg);
//         return;
//       }

//       // hand-off to Meta ESU
//       window.location.href = authUrl;
//     } catch (err) {
//       const msg =
//         err?.response?.data?.message ||
//         err?.message ||
//         "Failed to start Facebook Connect.";
//       toast.error(msg);
//     } finally {
//       setConnecting(false);
//     }
//   };
//   // === ESU END ===

//   const kpis = [
//     { label: "Total Revenue", value: "$12.5K" },
//     { label: "New Leads", value: "384" },
//     { label: "Conv. Rate", value: "3.7%" },
//     { label: "Active Users", value: "1.2K" },
//     { label: "Sessions", value: "3.4K" },
//     { label: "Bounce Rate", value: "41%" },
//   ];

//   const messagesData = {
//     labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
//     datasets: [
//       {
//         label: "Messages Sent",
//         data: [150, 200, 180, 220, 300, 250, 270],
//         backgroundColor: "rgba(16, 185, 129, 0.8)",
//         borderColor: "rgba(16, 185, 129, 1)",
//         borderRadius: 6,
//         borderWidth: 2,
//         barThickness: 20,
//       },
//     ],
//   };

//   const deliveryData = {
//     labels: ["Delivered", "Pending", "Failed"],
//     datasets: [
//       {
//         label: "Delivery Status",
//         data: [70, 20, 10],
//         backgroundColor: ["#10b981", "#06b6d4", "#ef4444"],
//         borderColor: ["#059669", "#0891b2", "#dc2626"],
//         borderWidth: 2,
//       },
//     ],
//   };

//   if (isLoading) {
//     return (
//       <div className="min-h-screen bg-gradient-to-br from-emerald-50 to-cyan-50 flex items-center justify-center">
//         <div className="text-center">
//           <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600 mx-auto mb-4"></div>
//           <p className="text-emerald-700 font-semibold">Loading dashboard‚Ä¶</p>
//         </div>
//       </div>
//     );
//   }

//   if (!allowed) {
//     return (
//       <div className="min-h-screen bg-gradient-to-br from-emerald-50 to-cyan-50 flex items-center justify-center p-6">
//         <div className="bg-white rounded-xl shadow-lg border border-red-200 p-8 max-w-md text-center">
//           <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
//             <span className="text-2xl">üö´</span>
//           </div>
//           <h3 className="text-lg font-semibold text-gray-900 mb-2">
//             Access Denied
//           </h3>
//           <p className="text-red-700">
//             You don't have access to the Dashboard.
//           </p>
//         </div>
//       </div>
//     );
//   }

//   return (
//     <div className="min-h-screen">
//       <div className="max-w-7xl mx-auto px-4 pt-4 pb-8">
//         <div className="mb-4">
//           <h1 className="text-2xl font-bold text-gray-900 mb-1">Dashboard</h1>
//         </div>

//         {/* Start WhatsApp Engagement Section */}
//         <div className="relative rounded-xl bg-gradient-to-br from-emerald-50 via-cyan-50 to-white border border-emerald-100 shadow-md overflow-hidden mb-6">
//           <div className="hidden md:block absolute right-6 bottom-0 opacity-10 pointer-events-none select-none">
//             <div className="bg-emerald-200 rounded-full w-36 h-36 flex items-center justify-center">
//               <svg width="64" height="64" fill="none" viewBox="0 0 64 64">
//                 <rect width="64" height="64" rx="32" fill="#059669" />
//                 <path
//                   d="M32 19c-5.523 0-10 4.252-10 9.5 0 2.5 1.23 4.523 3.073 6.223l-1.073 3.527c-.124.412.328.779.705.567l3.51-2.076c1.151.334 2.343.505 3.785.505 5.523 0 10-4.253 10-9.5C42 23.252 37.523 19 32 19z"
//                   fill="#fff"
//                 />
//               </svg>
//             </div>
//           </div>
//           <div className="relative z-10 flex flex-col md:flex-row gap-6 items-center md:items-stretch justify-between p-6">
//             <div className="max-w-xl flex-1">
//               <h3 className="text-xl md:text-2xl font-bold text-emerald-900 mb-2">
//                 Start WhatsApp Engagement for your Business
//               </h3>
//               <p className="text-slate-700 mb-3">
//                 You'll need to Apply for WhatsApp Business API to use XploreByte
//                 for your Business. Start your API application by choosing one of
//                 the options.
//               </p>
//               <div className="flex flex-col gap-2 sm:flex-row">
//                 <button
//                   onClick={() => setShowApplyModal(true)}
//                   className="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg font-semibold shadow hover:shadow-md focus:outline-none focus:ring-2 focus:ring-emerald-300 transition"
//                 >
//                   Apply for WhatsApp Business API (FREE)
//                 </button>
//                 <button
//                   className="border-2 border-emerald-500 text-emerald-700 hover:bg-emerald-50 hover:border-emerald-600 px-6 py-2 rounded-lg font-semibold transition"
//                   onClick={() => setShowMigration(true)}
//                 >
//                   Migrate from Another Vendor
//                 </button>
//               </div>
//               <p className="text-xs text-emerald-700 mt-3">
//                 Want to know more about XploreByte?{" "}
//                 <button className="underline font-semibold hover:text-emerald-900">
//                   Click to schedule a Live Demo
//                 </button>
//               </p>
//             </div>
//             <div className="flex-shrink-0 flex justify-center items-center md:justify-end mt-6 md:mt-0">
//               <img
//                 src="/img/applyforwhatsappapi.webp"
//                 alt="Apply for WhatsApp API"
//                 className="h-52 w-auto md:h-64 object-contain drop-shadow-xl"
//               />
//             </div>
//           </div>
//         </div>

//         {/* Tabs */}
//         <div className="bg-white rounded-t-lg shadow-sm border border-gray-200 border-b-0">
//           <nav className="flex" aria-label="Tabs">
//             <button
//               className={`flex-1 px-6 py-3 text-sm font-medium transition-all duration-200 ${
//                 activeTab === "welcome"
//                   ? "text-emerald-700 border-b-2 border-emerald-500 bg-emerald-50/30"
//                   : "text-gray-500 hover:text-gray-700 hover:bg-gray-50"
//               }`}
//               onClick={() => setActiveTab("welcome")}
//             >
//               <div className="flex items-center justify-center space-x-2">
//                 <span className="text-base">üéâ</span>
//                 <span>Welcome</span>
//               </div>
//             </button>
//             <button
//               className={`flex-1 px-6 py-3 text-sm font-medium transition-all duration-200 ${
//                 activeTab === "overview"
//                   ? "text-emerald-700 border-b-2 border-emerald-500 bg-emerald-50/30"
//                   : "text-gray-500 hover:text-gray-700 hover:bg-gray-50"
//               }`}
//               onClick={() => setActiveTab("overview")}
//             >
//               <div className="flex items-center justify-center space-x-2">
//                 <span className="text-base">üìä</span>
//                 <span>Overview</span>
//               </div>
//             </button>
//             <button
//               className={`flex-1 px-6 py-3 text-sm font-medium transition-all duration-200 ${
//                 activeTab === "engagement"
//                   ? "text-emerald-700 border-b-2 border-emerald-500 bg-emerald-50/30"
//                   : "text-gray-500 hover:text-gray-700 hover:bg-gray-50"
//               }`}
//               onClick={() => setActiveTab("engagement")}
//             >
//               <div className="flex items-center justify-center space-x-2">
//                 <span className="text-base">üí¨</span>
//                 <span>Engagement</span>
//               </div>
//             </button>
//           </nav>
//         </div>

//         {activeTab === "overview" && (
//           <div className="bg-white rounded-b-lg shadow-sm border border-gray-200 border-t-0 p-6">
//             <div className="flex justify-between items-center mb-6">
//               <div className="flex items-center gap-3">
//                 <select
//                   value={selectedRange}
//                   onChange={handleRangeChange}
//                   className="bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
//                 >
//                   <option>Last 7 days</option>
//                   <option>Last 30 days</option>
//                   <option>This month</option>
//                 </select>
//                 <button className="bg-white border border-gray-200 rounded-lg px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 hover:border-gray-300 transition-colors">
//                   Export
//                 </button>
//               </div>
//             </div>

//             <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-6 mb-8">
//               {kpis.map((kpi, i) => (
//                 <div
//                   key={i}
//                   className="group bg-white rounded-xl p-6 shadow-lg border border-gray-200 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 hover:border-gray-300"
//                 >
//                   <div className="flex items-center justify-between mb-3">
//                     <div
//                       className={`inline-flex items-center justify-center w-10 h-10 rounded-xl ${
//                         widgetColors[i % widgetColors.length].bg
//                       }`}
//                     >
//                       <span className="text-lg">
//                         {widgetColors[i % widgetColors.length].icon}
//                       </span>
//                     </div>
//                     <div
//                       className={`w-3 h-3 rounded-full ${
//                         widgetColors[i % widgetColors.length].bg
//                       }`}
//                     />
//                   </div>
//                   <div>
//                     <p className="text-sm text-gray-600 font-medium mb-1">
//                       {kpi.label}
//                     </p>
//                     <p className="text-2xl font-bold text-gray-900">
//                       {kpi.value}
//                     </p>
//                   </div>
//                 </div>
//               ))}
//             </div>

//             <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
//               <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hover:border-gray-300 transition-all duration-200 col-span-2">
//                 <div className="flex items-center gap-2 mb-4">
//                   <div className="w-8 h-8 bg-emerald-100 rounded-lg flex items-center justify-center">
//                     <span className="text-emerald-600">üìà</span>
//                   </div>
//                   <h3 className="text-lg font-semibold text-gray-900">
//                     Messages Sent (Weekly)
//                   </h3>
//                 </div>
//                 <Bar
//                   data={messagesData}
//                   options={{
//                     responsive: true,
//                     plugins: { legend: { display: false } },
//                     scales: {
//                       y: {
//                         beginAtZero: true,
//                         grid: { color: "#f3f4f6" },
//                         ticks: { color: "#6b7280" },
//                       },
//                       x: {
//                         grid: { color: "#f3f4f6" },
//                         ticks: { color: "#6b7280" },
//                       },
//                     },
//                   }}
//                   height={200}
//                 />
//               </div>
//               <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hover:border-gray-300 transition-all duration-200">
//                 <div className="flex items-center gap-2 mb-4">
//                   <div className="w-8 h-8 bg-cyan-100 rounded-lg flex items-center justify-center">
//                     <span className="text-cyan-600">üìä</span>
//                   </div>
//                   <h3 className="text-lg font-semibold text-gray-900">
//                     Delivery Status
//                   </h3>
//                 </div>
//                 <Doughnut
//                   data={deliveryData}
//                   options={{
//                     responsive: true,
//                     plugins: {
//                       legend: {
//                         position: "bottom",
//                         labels: { color: "#6b7280", font: { size: 12 } },
//                       },
//                     },
//                   }}
//                 />
//               </div>
//             </div>

//             <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
//               <div className="bg-white rounded-xl p-6 shadow-lg border border-gray-200 hover:shadow-xl hover:border-gray-300 transition-all duration-200">
//                 <div className="flex items-center gap-3 mb-3">
//                   <div className="w-8 h-8 bg-emerald-100 rounded-lg flex items-center justify-center">
//                     <span className="text-emerald-600">üéØ</span>
//                   </div>
//                   <h4 className="text-sm font-semibold text-gray-900">
//                     Top Performing CTA
//                   </h4>
//                 </div>
//                 <p className="text-xl font-bold text-gray-900 mb-1">
//                   Get Quote Now
//                 </p>
//                 <p className="text-sm text-emerald-600 font-medium">
//                   CTR: 42.3%
//                 </p>
//               </div>
//               <div className="bg-white rounded-xl p-6 shadow-lg border border-gray-200 hover:shadow-xl hover:border-gray-300 transition-all duration-200">
//                 <div className="flex items-center gap-3 mb-3">
//                   <div className="w-8 h-8 bg-cyan-100 rounded-lg flex items-center justify-center">
//                     <span className="text-cyan-600">üì±</span>
//                   </div>
//                   <h4 className="text-sm font-semibold text-gray-900">
//                     Most Used Channel
//                   </h4>
//                 </div>
//                 <p className="text-xl font-bold text-gray-900 mb-1">WhatsApp</p>
//                 <p className="text-sm text-cyan-600 font-medium">
//                   68% of total campaigns
//                 </p>
//               </div>
//               <div className="bg-white rounded-xl p-6 shadow-lg border border-gray-200 hover:shadow-xl hover:border-gray-300 transition-all duration-200">
//                 <div className="flex items-center gap-3 mb-3">
//                   <div className="w-8 h-8 bg-sapphire-100 rounded-lg flex items-center justify-center">
//                     <span className="text-sapphire-600">‚è±Ô∏è</span>
//                   </div>
//                   <h4 className="text-sm font-semibold text-gray-900">
//                     Avg. Response Time
//                   </h4>
//                 </div>
//                 <p className="text-xl font-bold text-gray-900 mb-1">3m 28s</p>
//                 <p className="text-sm text-sapphire-600 font-medium">
//                   Based on last 100 events
//                 </p>
//               </div>
//             </div>
//           </div>
//         )}

//         {activeTab === "engagement" && (
//           <div className="bg-white rounded-b-lg shadow-sm border border-gray-200 border-t-0 p-12 text-center">
//             <div className="w-20 h-20 bg-gradient-to-br from-emerald-100 to-cyan-100 rounded-full flex items-center justify-center mx-auto mb-4">
//               <span className="text-3xl">üí¨</span>
//             </div>
//             <h3 className="text-xl font-semibold text-gray-900 mb-2">
//               Engagement Metrics
//             </h3>
//             <p className="text-gray-600 mb-6">
//               Detailed engagement analytics coming soon...
//             </p>
//             <div className="inline-flex items-center gap-2 px-4 py-2 bg-emerald-50 text-emerald-700 rounded-lg text-sm font-medium">
//               <span>üöÄ</span>
//               <span>Stay tuned for updates</span>
//             </div>
//           </div>
//         )}

//         {activeTab === "welcome" && (
//           <div className="bg-white rounded-b-lg shadow-sm border border-gray-200 border-t-0 overflow-hidden">
//             <WelcomeCenter />
//           </div>
//         )}
//       </div>

//       {/* Migration Help Popup */}
//       {showMigration && (
//         <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50">
//           <div className="bg-gradient-to-br from-emerald-50 via-cyan-50 to-white max-w-2xl w-full rounded-2xl shadow-lg p-8 text-emerald-900 relative border border-emerald-100">
//             <div className="absolute right-5 top-5">
//               <button
//                 onClick={() => setShowMigration(false)}
//                 className="bg-emerald-100 hover:bg-emerald-200 rounded-full w-8 h-8 flex items-center justify-center"
//               >
//                 <span className="text-xl text-emerald-900 font-bold">√ó</span>
//               </button>
//             </div>
//             <h2 className="text-2xl font-bold mb-1 flex items-center gap-2">
//               Migration <span className="text-lg">üìñ</span>
//               <span className="text-base font-medium text-slate-700">
//                 How to Migrate?
//               </span>
//             </h2>
//             <p className="mb-4 mt-1 text-slate-700">
//               Before migrating, please check the following to ensure a smooth
//               migration process:
//             </p>
//             <ol className="list-decimal ml-5 mb-5 space-y-1 text-slate-700">
//               <li>Ensure your WhatsApp Display Name is approved</li>
//               <li>
//                 Turn off two-factor authentication for your WhatsApp account
//               </li>
//               <li>
//                 Make sure your phone number is active and can receive SMS OTP
//               </li>
//             </ol>
//             <div className="flex gap-4 mt-6">
//               {!migrationSubmitted ? (
//                 <button
//                   className="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-6 py-2 rounded-md shadow hover:bg-emerald-700 transition"
//                   onClick={() => setMigrationSubmitted(true)}
//                 >
//                   Start Migration
//                 </button>
//               ) : null}
//               <button
//                 className="border border-emerald-400 text-emerald-900 px-6 py-2 rounded-md flex items-center gap-2 hover:bg-emerald-50 transition"
//                 onClick={() => setShowMigration(false)}
//               >
//                 <span className="text-xl">‚Üê</span> Go back
//               </button>
//             </div>
//             <div className="absolute right-8 -bottom-6 md:right-2 md:bottom-6">
//               <img
//                 src="/img/otp.webp"
//                 alt="Migrate requirements illustration"
//                 className="h-24 w-auto select-none"
//               />
//             </div>
//             {migrationSubmitted && (
//               <div className="absolute inset-0 bg-white flex flex-col items-center justify-center z-30 rounded-2xl px-6 py-16 text-center">
//                 <div className="flex items-center justify-center mb-3">
//                   <span className="inline-flex items-center justify-center w-12 h-12 rounded-full bg-emerald-100">
//                     <svg
//                       width="28"
//                       height="28"
//                       viewBox="0 0 40 40"
//                       fill="none"
//                       xmlns="http://www.w3.org/2000/svg"
//                     >
//                       <circle cx="20" cy="20" r="20" fill="#10B981" />
//                       <path
//                         d="M13.5 21.5L18 26L27 17"
//                         stroke="white"
//                         strokeWidth="3"
//                         strokeLinecap="round"
//                         strokeLinejoin="round"
//                       />
//                     </svg>
//                   </span>
//                 </div>
//                 <h3 className="text-xl font-bold mb-2 text-emerald-900">
//                   Migration Request Submitted!
//                 </h3>
//                 <p className="mb-5 text-slate-700 max-w-md">
//                   Your migration request has been successfully registered! One
//                   of our representatives will contact you within 48 hours to
//                   assist with your migration. If you have any questions or
//                   require urgent help, feel free to contact our support team.
//                 </p>
//                 <button
//                   className="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-8 py-2 rounded-md shadow mt-4 mb-4"
//                   onClick={() => {
//                     setShowMigration(false);
//                     setMigrationSubmitted(false);
//                   }}
//                 >
//                   Close
//                 </button>
//               </div>
//             )}
//           </div>
//         </div>
//       )}

//       {/* Apply for WhatsApp Business API Modal */}
//       {showApplyModal && (
//         <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50">
//           <div className="bg-white max-w-2xl w-full rounded-2xl shadow-lg p-8 text-gray-900 relative border border-gray-200">
//             <button
//               onClick={() => setShowApplyModal(false)}
//               className="absolute right-5 top-5 bg-gray-100 hover:bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center"
//             >
//               <span className="text-xl">√ó</span>
//             </button>
//             <h2 className="text-xl md:text-2xl font-bold mb-2 text-emerald-900">
//               Apply for WhatsApp Business API
//             </h2>
//             <p className="mb-2 text-[15px] font-medium text-emerald-700">
//               Click on Continue With Facebook to apply for WhatsApp Business API
//             </p>
//             <div className="mb-4">
//               <span className="block font-semibold text-gray-700 mb-1">
//                 Requirements to apply for WhatsApp Business API
//               </span>
//               <ul className="text-gray-600 text-[15px] mb-2 list-disc ml-6">
//                 <li>A Registered Business & Working Website.</li>
//               </ul>
//               <div className="flex items-center gap-2 text-emerald-700 mb-2">
//                 <span className="text-lg">üìñ</span>
//                 <a
//                   href="https://help.xplorebyte.com"
//                   target="_blank"
//                   rel="noopener noreferrer"
//                   className="underline hover:text-emerald-900 font-semibold"
//                 >
//                   How to apply for WhatsApp Business API?
//                 </a>
//               </div>
//             </div>
//             <div className="flex flex-col md:flex-row gap-5 items-start md:items-center mb-6">
//               <div className="flex-1">
//                 <div className="aspect-video w/full max-w-md rounded-lg overflow-hidden border border-gray-200">
//                   <iframe
//                     width="100%"
//                     height="260"
//                     src="https://www.youtube.com/embed/YOUR_VIDEO_ID"
//                     title="How to get FREE WhatsApp API"
//                     frameBorder="0"
//                     allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
//                     allowFullScreen
//                   ></iframe>
//                 </div>
//               </div>
//             </div>
//             <div className="flex flex-col md:flex-row gap-3 justify-end mt-3">
//               <button
//                 className="border border-emerald-400 text-emerald-900 px-6 py-2 rounded-md flex items-center gap-2 hover:bg-emerald-50 transition"
//                 onClick={() => {
//                   setShowApplyModal(false);
//                   setShowMigration(true);
//                 }}
//               >
//                 Migrate from another vendor
//               </button>
//               <button
//                 className="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-md font-semibold shadow transition disabled:opacity-60"
//                 disabled={connecting}
//                 onClick={async () => {
//                   setShowApplyModal(false);
//                   await startFacebookConnect();
//                 }}
//               >
//                 {connecting ? "Connecting‚Ä¶" : "Continue With Facebook"}
//               </button>
//             </div>
//           </div>
//         </div>
//       )}
//     </div>
//   );
// }
// src/pages/dashboard/DashboardWorkspace.jsx
import { useState } from "react";
import { useNavigate } from "react-router-dom";
import { Bar, Doughnut } from "react-chartjs-2";
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  BarElement,
  Title,
  Tooltip,
  Legend,
  ArcElement,
} from "chart.js";
import { useAuth } from "../../app/providers/AuthProvider";
import WelcomeCenter from "./WelcomeCenter";
import React from "react";
import axiosClient from "../../api/axiosClient";
import { toast } from "react-toastify";

ChartJS.register(
  CategoryScale,
  LinearScale,
  BarElement,
  Title,
  Tooltip,
  Legend,
  ArcElement
);

const isGuid = v =>
  !!v &&
  /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(
    v
  );

const widgetColors = [
  {
    icon: "üí∞",
    bg: "bg-emerald-50",
    ring: "ring-emerald-500",
    text: "text-emerald-600",
  },
  {
    icon: "üìà",
    bg: "bg-cyan-50",
    ring: "ring-cyan-500",
    text: "text-cyan-600",
  },
  {
    icon: "üìä",
    bg: "bg-sapphire-50",
    ring: "ring-sapphire-500",
    text: "text-sapphire-600",
  },
  {
    icon: "üí≥",
    bg: "bg-emerald-50",
    ring: "ring-emerald-500",
    text: "text-emerald-600",
  },
  {
    icon: "üë•",
    bg: "bg-cyan-50",
    ring: "ring-cyan-500",
    text: "text-cyan-600",
  },
  { icon: "‚Ü©Ô∏è", bg: "bg-red-50", ring: "ring-red-500", text: "text-red-600" },
];

export default function DashboardWorkspace() {
  const { isLoading, hasAllAccess, can, userName, businessId } = useAuth();
  const navigate = useNavigate();

  const allowed =
    hasAllAccess || (typeof can === "function" && can("dashboard.view"));

  const [selectedRange, setSelectedRange] = useState("Last 7 days");
  const [activeTab, setActiveTab] = useState("welcome");
  const [showMigration, setShowMigration] = useState(false);
  const [showApplyModal, setShowApplyModal] = useState(false);
  const [migrationSubmitted, setMigrationSubmitted] = useState(false);
  const [connecting, setConnecting] = useState(false);

  const handleRangeChange = e => setSelectedRange(e.target.value);

  // ESU: start connect
  const startFacebookConnect = async () => {
    try {
      setConnecting(true);
      const returnUrlAfterSuccess = "/app/settings/whatsapp";

      if (!isGuid(businessId)) {
        toast.error("Business context missing. Please re-login.");
        return;
      }

      const res = await axiosClient.post(
        "esu/facebook/start",
        { returnUrlAfterSuccess },
        { headers: { "X-Business-Id": businessId } }
      );

      const authUrl =
        res?.data?.data?.authUrl || res?.data?.authUrl || res?.data?.url;

      if (!authUrl) {
        toast.error(
          res?.data?.message || "Could not get Facebook connect URL."
        );
        return;
      }

      window.location.href = authUrl;
    } catch (err) {
      toast.error(
        err?.response?.data?.message ||
          err?.message ||
          "Failed to start Facebook Connect."
      );
    } finally {
      setConnecting(false);
    }
  };

  const kpis = [
    { label: "Total Revenue", value: "$12.5K" },
    { label: "New Leads", value: "384" },
    { label: "Conv. Rate", value: "3.7%" },
    { label: "Active Users", value: "1.2K" },
    { label: "Sessions", value: "3.4K" },
    { label: "Bounce Rate", value: "41%" },
  ];

  const messagesData = {
    labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
    datasets: [
      {
        label: "Messages Sent",
        data: [150, 200, 180, 220, 300, 250, 270],
        backgroundColor: "rgba(16, 185, 129, 0.8)",
        borderColor: "rgba(16, 185, 129, 1)",
        borderRadius: 6,
        borderWidth: 2,
        barThickness: 20,
      },
    ],
  };

  const deliveryData = {
    labels: ["Delivered", "Pending", "Failed"],
    datasets: [
      {
        label: "Delivery Status",
        data: [70, 20, 10],
        backgroundColor: ["#10b981", "#06b6d4", "#ef4444"],
        borderColor: ["#059669", "#0891b2", "#dc2626"],
        borderWidth: 2,
      },
    ],
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-emerald-50 to-cyan-50 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600 mx-auto mb-4"></div>
          <p className="text-emerald-700 font-semibold">Loading dashboard‚Ä¶</p>
        </div>
      </div>
    );
  }

  if (!allowed) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-emerald-50 to-cyan-50 flex items-center justify-center p-6">
        <div className="bg-white rounded-xl shadow-lg border border-red-200 p-8 max-w-md text-center">
          <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <span className="text-2xl">üö´</span>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen">
      <div className="max-w-7xl mx-auto px-4 pt-4 pb-8">
        <div className="mb-4">
          <h1 className="text-2xl font-bold text-gray-900 mb-1">Dashboard</h1>
        </div>

        {/* WhatsApp Engagement CTA */}
        <div className="relative rounded-xl bg-gradient-to-br from-emerald-50 via-cyan-50 to-white border border-emerald-100 shadow-md overflow-hidden mb-6">
          <div className="hidden md:block absolute right-6 bottom-0 opacity-10 pointer-events-none select-none">
            <div className="bg-emerald-200 rounded-full w-36 h-36 flex items-center justify-center">
              <svg width="64" height="64" fill="none" viewBox="0 0 64 64">
                <rect width="64" height="64" rx="32" fill="#059669" />
                <path
                  d="M32 19c-5.523 0-10 4.252-10 9.5 0 2.5 1.23 4.523 3.073 6.223l-1.073 3.527c-.124.412.328.779.705.567l3.51-2.076c1.151.334 2.343.505 3.785.505 5.523 0 10-4.253 10-9.5C42 23.252 37.523 19 32 19z"
                  fill="#fff"
                />
              </svg>
            </div>
          </div>
          <div className="relative z-10 flex flex-col md:flex-row gap-6 items-center md:items-stretch justify-between p-6">
            <div className="max-w-xl flex-1">
              <h3 className="text-xl md:text-2xl font-bold text-emerald-900 mb-2">
                Start WhatsApp Engagement for your Business
              </h3>
              <p className="text-slate-700 mb-3">
                Apply for WhatsApp Business API or migrate from your current
                provider.
              </p>
              <div className="flex flex-col gap-2 sm:flex-row">
                <button
                  onClick={() => setShowApplyModal(true)}
                  className="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg font-semibold shadow hover:shadow-md focus:outline-none focus:ring-2 focus:ring-emerald-300 transition"
                >
                  Apply for WhatsApp Business API (FREE)
                </button>
                <button
                  className="border-2 border-emerald-500 text-emerald-700 hover:bg-emerald-50 hover:border-emerald-600 px-6 py-2 rounded-lg font-semibold transition"
                  onClick={() => setShowMigration(true)}
                >
                  Migrate from Another Vendor
                </button>
              </div>
            </div>
            <div className="flex-shrink-0 flex justify-center items-center md:justify-end mt-6 md:mt-0">
              <img
                src="/img/applyforwhatsappapi.webp"
                alt="Apply for WhatsApp API"
                className="h-52 w-auto md:h-64 object-contain drop-shadow-xl"
              />
            </div>
          </div>
        </div>

        {/* Tabs */}
        <div className="bg-white rounded-t-lg shadow-sm border border-gray-200 border-b-0">
          <nav className="flex" aria-label="Tabs">
            <button
              className={`flex-1 px-6 py-3 text-sm font-medium transition-all duration-200 ${
                activeTab === "welcome"
                  ? "text-emerald-700 border-b-2 border-emerald-500 bg-emerald-50/30"
                  : "text-gray-500 hover:text-gray-700 hover:bg-gray-50"
              }`}
              onClick={() => setActiveTab("welcome")}
            >
              <div className="flex items-center justify-center space-x-2">
                <span className="text-base">üéâ</span>
                <span>Welcome</span>
              </div>
            </button>
            <button
              className={`flex-1 px-6 py-3 text-sm font-medium transition-all duration-200 ${
                activeTab === "overview"
                  ? "text-emerald-700 border-b-2 border-emerald-500 bg-emerald-50/30"
                  : "text-gray-500 hover:text-gray-700 hover:bg-gray-50"
              }`}
              onClick={() => setActiveTab("overview")}
            >
              <div className="flex items-center justify-center space-x-2">
                <span className="text-base">üìä</span>
                <span>Overview</span>
              </div>
            </button>
            <button
              className={`flex-1 px-6 py-3 text-sm font-medium transition-all duration-200 ${
                activeTab === "engagement"
                  ? "text-emerald-700 border-b-2 border-emerald-500 bg-emerald-50/30"
                  : "text-gray-500 hover:text-gray-700 hover:bg-gray-50"
              }`}
              onClick={() => setActiveTab("engagement")}
            >
              <div className="flex items-center justify-center space-x-2">
                <span className="text-base">üí¨</span>
                <span>Engagement</span>
              </div>
            </button>
          </nav>
        </div>

        {activeTab === "overview" && (
          <div className="bg-white rounded-b-lg shadow-sm border border-gray-200 border-t-0 p-6">
            <div className="flex justify-between items-center mb-6">
              <div className="flex items-center gap-3">
                <select
                  value={selectedRange}
                  onChange={handleRangeChange}
                  className="bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors"
                >
                  <option>Last 7 days</option>
                  <option>Last 30 days</option>
                  <option>This month</option>
                </select>
                <button className="bg-white border border-gray-200 rounded-lg px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 hover:border-gray-300 transition-colors">
                  Export
                </button>
              </div>
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-6 mb-8">
              {kpis.map((kpi, i) => (
                <div
                  key={i}
                  className="group bg-white rounded-xl p-6 shadow-lg border border-gray-200 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 hover:border-gray-300"
                >
                  <div className="flex items-center justify-between mb-3">
                    <div
                      className={`inline-flex items-center justify-center w-10 h-10 rounded-xl ${
                        widgetColors[i % widgetColors.length].bg
                      }`}
                    >
                      <span className="text-lg">
                        {widgetColors[i % widgetColors.length].icon}
                      </span>
                    </div>
                    <div
                      className={`w-3 h-3 rounded-full ${
                        widgetColors[i % widgetColors.length].bg
                      }`}
                    />
                  </div>
                  <div>
                    <p className="text-sm text-gray-600 font-medium mb-1">
                      {kpi.label}
                    </p>
                    <p className="text-2xl font-bold text-gray-900">
                      {kpi.value}
                    </p>
                  </div>
                </div>
              ))}
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
              <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hover:border-gray-300 transition-all duration-200 col-span-2">
                <div className="flex items-center gap-2 mb-4">
                  <div className="w-8 h-8 bg-emerald-100 rounded-lg flex items-center justify-center">
                    <span className="text-emerald-600">üìà</span>
                  </div>
                  <h3 className="text-lg font-semibold text-gray-900">
                    Messages Sent (Weekly)
                  </h3>
                </div>
                <Bar
                  data={messagesData}
                  options={{
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                      y: {
                        beginAtZero: true,
                        grid: { color: "#f3f4f6" },
                        ticks: { color: "#6b7280" },
                      },
                      x: {
                        grid: { color: "#f3f4f6" },
                        ticks: { color: "#6b7280" },
                      },
                    },
                  }}
                  height={200}
                />
              </div>
              <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hover:border-gray-300 transition-all duration-200">
                <div className="flex items-center gap-2 mb-4">
                  <div className="w-8 h-8 bg-cyan-100 rounded-lg flex items-center justify-center">
                    <span className="text-cyan-600">üìä</span>
                  </div>
                  <h3 className="text-lg font-semibold text-gray-900">
                    Delivery Status
                  </h3>
                </div>
                <Doughnut
                  data={deliveryData}
                  options={{
                    responsive: true,
                    plugins: {
                      legend: {
                        position: "bottom",
                        labels: { color: "#6b7280", font: { size: 12 } },
                      },
                    },
                  }}
                />
              </div>
            </div>
          </div>
        )}

        {activeTab === "engagement" && (
          <div className="bg-white rounded-b-lg shadow-sm border border-gray-200 border-t-0 p-12 text-center">
            <div className="w-20 h-20 bg-gradient-to-br from-emerald-100 to-cyan-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <span className="text-3xl">üí¨</span>
            </div>
            <h3 className="text-xl font-semibold text-gray-900 mb-2">
              Engagement Metrics
            </h3>
            <p className="text-gray-600 mb-6">
              Detailed engagement analytics coming soon...
            </p>
            <div className="inline-flex items-center gap-2 px-4 py-2 bg-emerald-50 text-emerald-700 rounded-lg text-sm font-medium">
              <span>üöÄ</span>
              <span>Stay tuned for updates</span>
            </div>
          </div>
        )}

        {activeTab === "welcome" && (
          <div className="bg-white rounded-b-lg shadow-sm border border-gray-200 border-t-0 overflow-hidden">
            <WelcomeCenter />
          </div>
        )}
      </div>

      {/* Migration Modal */}
      {showMigration && (
        <div className="fixed inset-0 flex items-center justify-center bg-black/40 z-[100]">
          <div className="bg-gradient-to-br from-emerald-50 via-cyan-50 to-white max-w-2xl w-full rounded-2xl shadow-lg p-8 text-emerald-900 relative border border-emerald-100">
            <button
              onClick={() => setShowMigration(false)}
              className="absolute right-5 top-5 bg-emerald-100 hover:bg-emerald-200 rounded-full w-8 h-8 flex items-center justify-center"
              aria-label="Close Migration Modal"
            >
              <span className="text-xl text-emerald-900 font-bold">√ó</span>
            </button>
            <h2 className="text-2xl font-bold mb-1 flex items-center gap-2">
              Migration <span className="text-lg">üìñ</span>
              <span className="text-base font-medium text-slate-700">
                How to Migrate?
              </span>
            </h2>
            <p className="mb-4 mt-1 text-slate-700">
              Before migrating, please check the following to ensure a smooth
              process:
            </p>
            <ol className="list-decimal ml-5 mb-5 space-y-1 text-slate-700">
              <li>Ensure your WhatsApp Display Name is approved</li>
              <li>Turn off two-factor authentication on your WA number</li>
              <li>Make sure the number is active and can receive SMS OTP</li>
            </ol>
            <div className="flex gap-4 mt-6">
              {!migrationSubmitted ? (
                <button
                  className="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-6 py-2 rounded-md shadow transition"
                  onClick={() => setMigrationSubmitted(true)}
                >
                  Start Migration
                </button>
              ) : null}
              <button
                className="border border-emerald-400 text-emerald-900 px-6 py-2 rounded-md flex items-center gap-2 hover:bg-emerald-50 transition"
                onClick={() => setShowMigration(false)}
              >
                <span className="text-xl">‚Üê</span> Go back
              </button>
            </div>

            {migrationSubmitted && (
              <div className="absolute inset-0 bg-white/95 flex flex-col items-center justify-center z-30 rounded-2xl px-6 py-16 text-center">
                <div className="flex items-center justify-center mb-3">
                  <span className="inline-flex items-center justify-center w-12 h-12 rounded-full bg-emerald-100">
                    <svg
                      width="28"
                      height="28"
                      viewBox="0 0 40 40"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <circle cx="20" cy="20" r="20" fill="#10B981" />
                      <path
                        d="M13.5 21.5L18 26L27 17"
                        stroke="white"
                        strokeWidth="3"
                        strokeLinecap="round"
                        strokeLinejoin="round"
                      />
                    </svg>
                  </span>
                </div>
                <h3 className="text-xl font-bold mb-2 text-emerald-900">
                  Migration Request Submitted!
                </h3>
                <p className="mb-5 text-slate-700 max-w-md">
                  Our team will contact you within 48 hours to assist with your
                  migration.
                </p>
                <button
                  className="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-8 py-2 rounded-md shadow mt-4 mb-4"
                  onClick={() => {
                    setShowMigration(false);
                    setMigrationSubmitted(false);
                  }}
                >
                  Close
                </button>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Apply for WhatsApp Business API Modal */}
      {showApplyModal && (
        <div className="fixed inset-0 flex items-center justify-center bg-black/40 z-[100]">
          <div className="bg-white max-w-2xl w-full rounded-2xl shadow-lg p-8 text-gray-900 relative border border-gray-200">
            <button
              onClick={() => setShowApplyModal(false)}
              className="absolute right-5 top-5 bg-gray-100 hover:bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center"
              aria-label="Close Apply Modal"
            >
              <span className="text-xl">√ó</span>
            </button>

            <h2 className="text-xl md:text-2xl font-bold mb-2 text-emerald-900">
              Apply for WhatsApp Business API
            </h2>
            <p className="mb-2 text-[15px] font-medium text-emerald-700">
              Click on Continue With Facebook to apply for WhatsApp Business API
            </p>

            <div className="mb-4">
              <span className="block font-semibold text-gray-700 mb-1">
                Requirements
              </span>
              <ul className="text-gray-600 text-[15px] mb-2 list-disc ml-6">
                <li>A registered business & working website</li>
              </ul>
              <div className="flex items-center gap-2 text-emerald-700 mb-2">
                <span className="text-lg">üìñ</span>
                <a
                  href="https://help.xplorebyte.com"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="underline hover:text-emerald-900 font-semibold"
                >
                  How to apply for WhatsApp Business API?
                </a>
              </div>
            </div>

            <div className="flex flex-col md:flex-row gap-5 items-start md:items-center mb-6">
              <div className="flex-1">
                <div className="aspect-video w-full max-w-md rounded-lg overflow-hidden border border-gray-200">
                  <iframe
                    width="100%"
                    height="260"
                    src="https://www.youtube.com/embed/YOUR_VIDEO_ID"
                    title="How to get FREE WhatsApp API"
                    frameBorder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowFullScreen
                  />
                </div>
              </div>
            </div>

            <div className="flex flex-col md:flex-row gap-3 justify-end mt-3">
              <button
                className="border border-emerald-400 text-emerald-900 px-6 py-2 rounded-md flex items-center gap-2 hover:bg-emerald-50 transition"
                onClick={() => {
                  setShowApplyModal(false);
                  setShowMigration(true);
                }}
              >
                Migrate from another vendor
              </button>
              <button
                className="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-md font-semibold shadow transition disabled:opacity-60"
                disabled={connecting}
                onClick={async () => {
                  // close, then start connect
                  setShowApplyModal(false);
                  await startFacebookConnect();
                }}
              >
                {connecting ? "Connecting‚Ä¶" : "Continue With Facebook"}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Workspaces\InboxWorkspace.jsx 
====================================================== 
 
// üìÑ src/pages/Workspaces/InboxWorkspace.jsx

import {
  MessageSquareText,
  MoreVertical,
  Archive,
  Pin,
  ArrowRightCircle,
} from "lucide-react";
import { useNavigate } from "react-router-dom";
import { useMemo, useState } from "react";
import { DragDropContext, Droppable, Draggable } from "react-beautiful-dnd";

import { useAuth } from "../../app/providers/AuthProvider";
import { FK } from "../../capabilities/featureKeys";

// Map tiles ‚Üí required permission(s)
const PERM_BY_BLOCK = {
  "inbox-view": [FK.INBOX_VIEW],
};

// Workspace tiles
const inboxBlocks = [
  {
    id: "inbox-view",
    label: "Live Chat Inbox",
    description:
      "Switch to a real-time inbox to manage and respond to conversations instantly.",
    path: "/app/inbox/inboxwarpper",
    icon: <MessageSquareText className="text-emerald-800" size={22} />,
    action: "Live Chat",
  },
];

export default function InboxWorkspace() {
  const navigate = useNavigate();
  const { isLoading, can, hasAllAccess } = useAuth();

  const [pinned, setPinned] = useState(
    JSON.parse(localStorage.getItem("inbox-pinned") || "[]")
  );
  const [archived, setArchived] = useState(
    JSON.parse(localStorage.getItem("inbox-archived") || "[]")
  );

  // Reconcile saved order with current block ids
  const allIds = useMemo(() => inboxBlocks.map(b => b.id), []);
  const storedOrder =
    JSON.parse(localStorage.getItem("inbox-order") || "null") || [];
  const initialOrder = useMemo(() => {
    if (!Array.isArray(storedOrder) || storedOrder.length === 0) return allIds;
    const known = storedOrder.filter(id => allIds.includes(id));
    const missing = allIds.filter(id => !known.includes(id));
    return [...known, ...missing];
  }, [allIds]); // eslint-disable-line react-hooks/exhaustive-deps

  const [order, setOrder] = useState(initialOrder);
  const [showArchived, setShowArchived] = useState(false);

  const togglePin = (e, id) => {
    e.stopPropagation();
    const updated = pinned.includes(id)
      ? pinned.filter(i => i !== id)
      : [...pinned, id];
    setPinned(updated);
    localStorage.setItem("inbox-pinned", JSON.stringify(updated));
  };

  const toggleArchive = (e, id) => {
    e.stopPropagation();
    const updated = archived.includes(id)
      ? archived.filter(i => i !== id)
      : [...archived, id];
    setArchived(updated);
    localStorage.setItem("inbox-archived", JSON.stringify(updated));
  };

  const onDragEnd = result => {
    if (!result.destination) return;
    const newOrder = Array.from(order);
    const [moved] = newOrder.splice(result.source.index, 1);
    newOrder.splice(result.destination.index, 0, moved);
    setOrder(newOrder);
    localStorage.setItem("inbox-order", JSON.stringify(newOrder));
  };

  const canAny = codes =>
    hasAllAccess || (codes || []).filter(Boolean).some(code => can(code));

  const visibleBlocks = order
    .map(id => inboxBlocks.find(b => b.id === id))
    .filter(Boolean)
    .filter(b => (showArchived ? true : !archived.includes(b.id)))
    .filter(b => canAny(PERM_BY_BLOCK[b.id]));

  if (isLoading)
    return (
      <div className="p-10 text-center text-lg text-gray-500">
        Loading inbox‚Ä¶
      </div>
    );

  return (
    <div className="p-6">
      {/* Sequential border animation (top‚Üíright‚Üíbottom‚Üíleft) with gradient */}
      <style>{`
        @keyframes drawRight { from { transform: scaleX(0) } to { transform: scaleX(1) } }
        @keyframes drawDown  { from { transform: scaleY(0) } to { transform: scaleY(1) } }
        @keyframes drawLeft  { from { transform: scaleX(0) } to { transform: scaleX(1) } }
        @keyframes drawUp    { from { transform: scaleY(0) } to { transform: scaleY(1) } }

        .tile:hover .topline    { animation: drawRight .9s ease forwards; }
        .tile:hover .rightline  { animation: drawDown  .9s ease .18s forwards; }
        .tile:hover .bottomline { animation: drawLeft  .9s ease .36s forwards; }
        .tile:hover .leftline   { animation: drawUp    .9s ease .54s forwards; }
      `}</style>

      <div className="flex justify-between items-center mb-4">
        <h2 className="text-2xl font-bold text-emerald-800">
          üì® Inbox Workspace
        </h2>
        <label className="flex items-center gap-2 text-sm text-gray-700">
          <input
            type="checkbox"
            checked={showArchived}
            onChange={() => setShowArchived(!showArchived)}
            className="accent-purple-600"
          />
          Show Archived Tools
        </label>
      </div>

      <DragDropContext onDragEnd={onDragEnd}>
        <Droppable droppableId="inbox-blocks" direction="horizontal">
          {provided => (
            <div
              className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"
              ref={provided.innerRef}
              {...provided.droppableProps}
            >
              {visibleBlocks.map((block, index) => (
                <Draggable key={block.id} draggableId={block.id} index={index}>
                  {provided => (
                    <div
                      ref={provided.innerRef}
                      {...provided.draggableProps}
                      role="button"
                      tabIndex={0}
                      aria-label={`${block.label}: ${block.action}`}
                      onKeyDown={e => {
                        if (e.key === "Enter") navigate(block.path);
                      }}
                      onClick={() => navigate(block.path)}
                      className="tile group relative overflow-hidden cursor-pointer bg-white rounded-md border shadow-sm hover:shadow-md transition transform hover:-translate-y-0.5 duration-200 focus:outline-none focus:ring-2 focus:ring-purple-300"
                      style={{ userSelect: "none" }}
                    >
                      {/* Animated border segments (gray ‚Üí dark gray ‚Üí very-light purple) */}
                      <span
                        aria-hidden
                        className="topline pointer-events-none absolute left-0 -top-[2px] h-[2px] w-full origin-left rounded opacity-0 group-hover:opacity-100"
                        style={{
                          background:
                            "linear-gradient(90deg, #6B7280, #374151, #F3E8FF)",
                          transform: "scaleX(0)",
                        }}
                      />
                      <span
                        aria-hidden
                        className="rightline pointer-events-none absolute right-0 -top-[2px] h-[calc(100%+4px)] w-[2px] origin-top rounded opacity-0 group-hover:opacity-100"
                        style={{
                          background:
                            "linear-gradient(180deg, #6B7280, #374151, #F3E8FF)",
                          transform: "scaleY(0)",
                        }}
                      />
                      <span
                        aria-hidden
                        className="bottomline pointer-events-none absolute left-0 -bottom-[2px] h-[2px] w-full origin-right rounded opacity-0 group-hover:opacity-100"
                        style={{
                          background:
                            "linear-gradient(270deg, #6B7280, #374151, #F3E8FF)",
                          transform: "scaleX(0)",
                        }}
                      />
                      <span
                        aria-hidden
                        className="leftline pointer-events-none absolute left-0 -top-[2px] h-[calc(100%+4px)] w-[2px] origin-bottom rounded opacity-0 group-hover:opacity-100"
                        style={{
                          background:
                            "linear-gradient(0deg, #6B7280, #374151, #F3E8FF)",
                          transform: "scaleY(0)",
                        }}
                      />

                      {/* Card content */}
                      <div className="flex items-start gap-4 p-5">
                        <div className="bg-emerald-50 rounded-md p-2">
                          {block.icon}
                        </div>
                        <div className="flex-1">
                          <h3 className="text-md font-semibold text-emerald-800 group-hover:text-emerald-900">
                            {block.label}
                          </h3>
                          <p className="text-sm text-slate-600">
                            {block.description}
                          </p>
                        </div>

                        {/* Kebab = drag handle (doesn't navigate) */}
                        <div
                          {...provided.dragHandleProps}
                          title="Drag to re-order"
                          className="ml-2 rounded p-1 text-gray-400 hover:text-gray-600 cursor-grab active:cursor-grabbing"
                          onClick={e => e.stopPropagation()}
                        >
                          <MoreVertical size={16} />
                        </div>
                      </div>

                      <div className="px-5 py-3 border-t border-gray-200 flex items-center justify-between">
                        <button
                          onClick={e => {
                            e.stopPropagation();
                            navigate(block.path);
                          }}
                          className="text-sm text-gray-700 font-medium flex items-center gap-1 hover:text-gray-900"
                        >
                          {block.action} <ArrowRightCircle size={18} />
                        </button>
                        <div className="flex items-center gap-3">
                          <button
                            onClick={e => togglePin(e, block.id)}
                            title="Pin this"
                          >
                            <Pin
                              size={18}
                              className={
                                pinned.includes(block.id)
                                  ? "text-red-600"
                                  : "text-gray-400 hover:text-red-500"
                              }
                            />
                          </button>
                          <button
                            onClick={e => toggleArchive(e, block.id)}
                            title="Archive this"
                          >
                            <Archive
                              size={18}
                              className={
                                archived.includes(block.id)
                                  ? "text-indigo-600"
                                  : "text-gray-400 hover:text-indigo-500"
                              }
                            />
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                </Draggable>
              ))}
              {provided.placeholder}
            </div>
          )}
        </Droppable>
      </DragDropContext>
    </div>
  );
}

// // üìÑ src/pages/Workspaces/InboxWorkspace.jsx

// import {
//   MessageSquareText,
//   MoreVertical,
//   Archive,
//   Pin,
//   ArrowRightCircle,
// } from "lucide-react";
// import { useNavigate } from "react-router-dom";
// import { useMemo, useState } from "react";
// import { DragDropContext, Droppable, Draggable } from "react-beautiful-dnd";

// import { useAuth } from "../../app/providers/AuthProvider";
// import { FK } from "../../capabilities/featureKeys";

// // Map tiles ‚Üí required permission(s)
// const PERM_BY_BLOCK = {
//   "inbox-view": [FK.INBOX_VIEW],
//   // open shared inbox
// };

// // Define the tiles in this workspace
// const inboxBlocks = [
//   // {
//   //   id: "open-inbox",
//   //   label: "Open Inbox",
//   //   description: "Shared WhatsApp inbox for your whole team.",
//   //   path: "/app/inbox", // your existing inbox route
//   //   icon: <Inbox className="text-purple-600" size={22} />,
//   //   action: "Go to Inbox",
//   // },

//   {
//     id: "inbox-view",
//     label: "Live Chat Inbox",
//     description:
//       "Switch to a real-time inbox to manage and respond to conversations instantly.",
//     // keep legacy typo route to match App.jsx
//     path: "/app/inbox/inboxwarpper",
//     icon: <MessageSquareText className="text-green-600" size={22} />,

//     action: "Live Chat",
//   },
// ];

// export default function InboxWorkspace() {
//   const navigate = useNavigate();
//   const { isLoading, can, hasAllAccess } = useAuth();

//   const [pinned, setPinned] = useState(
//     JSON.parse(localStorage.getItem("inbox-pinned") || "[]")
//   );
//   const [archived, setArchived] = useState(
//     JSON.parse(localStorage.getItem("inbox-archived") || "[]")
//   );

//   // Reconcile saved order with current block ids (so new tiles appear)
//   const allIds = useMemo(() => inboxBlocks.map(b => b.id), []);
//   const storedOrder =
//     JSON.parse(localStorage.getItem("inbox-order") || "null") || [];
//   const initialOrder = useMemo(() => {
//     if (!Array.isArray(storedOrder) || storedOrder.length === 0) return allIds;
//     const known = storedOrder.filter(id => allIds.includes(id));
//     const missing = allIds.filter(id => !known.includes(id));
//     return [...known, ...missing];
//   }, [allIds]); // eslint-disable-line react-hooks/exhaustive-deps

//   const [order, setOrder] = useState(initialOrder);
//   const [showArchived, setShowArchived] = useState(false);

//   const togglePin = id => {
//     const updated = pinned.includes(id)
//       ? pinned.filter(i => i !== id)
//       : [...pinned, id];
//     setPinned(updated);
//     localStorage.setItem("inbox-pinned", JSON.stringify(updated));
//   };

//   const toggleArchive = id => {
//     const updated = archived.includes(id)
//       ? archived.filter(i => i !== id)
//       : [...archived, id];
//     setArchived(updated);
//     localStorage.setItem("inbox-archived", JSON.stringify(updated));
//   };

//   const onDragEnd = result => {
//     if (!result.destination) return;
//     const newOrder = Array.from(order);
//     const [moved] = newOrder.splice(result.source.index, 1);
//     newOrder.splice(result.destination.index, 0, moved);
//     setOrder(newOrder);
//     localStorage.setItem("inbox-order", JSON.stringify(newOrder));
//   };

//   const canAny = codes =>
//     hasAllAccess || (codes || []).filter(Boolean).some(code => can(code));

//   const visibleBlocks = order
//     .map(id => inboxBlocks.find(b => b.id === id))
//     .filter(Boolean)
//     .filter(b => (showArchived ? true : !archived.includes(b.id)))
//     .filter(b => canAny(PERM_BY_BLOCK[b.id]));

//   if (isLoading)
//     return (
//       <div className="p-10 text-center text-lg text-gray-500">
//         Loading inbox‚Ä¶
//       </div>
//     );

//   return (
//     <div className="p-6">
//       <div className="flex justify-between items-center mb-4">
//         <h2 className="text-2xl font-bold text-purple-800">
//           üì® Inbox Workspace
//         </h2>
//         <label className="flex items-center gap-2 text-sm text-gray-700">
//           <input
//             type="checkbox"
//             checked={showArchived}
//             onChange={() => setShowArchived(!showArchived)}
//             className="accent-purple-600"
//           />
//           Show Archived Tools
//         </label>
//       </div>

//       <DragDropContext onDragEnd={onDragEnd}>
//         <Droppable droppableId="inbox-blocks" direction="horizontal">
//           {provided => (
//             <div
//               className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"
//               ref={provided.innerRef}
//               {...provided.droppableProps}
//             >
//               {visibleBlocks.map((block, index) => (
//                 <Draggable key={block.id} draggableId={block.id} index={index}>
//                   {provided => (
//                     <div
//                       ref={provided.innerRef}
//                       {...provided.draggableProps}
//                       {...provided.dragHandleProps}
//                       className="bg-white rounded-md border shadow-sm hover:shadow-md transition transform hover:-translate-y-0.5 duration-200"
//                     >
//                       <div className="flex items-start gap-4 p-5">
//                         <div className="bg-gray-100 rounded-md p-2">
//                           {block.icon}
//                         </div>
//                         <div className="flex-1">
//                           <h3 className="text-md font-semibold text-purple-700">
//                             {block.label}
//                           </h3>
//                           <p className="text-sm text-gray-600">
//                             {block.description}
//                           </p>
//                         </div>
//                         <MoreVertical size={16} className="text-gray-400" />
//                       </div>
//                       <div className="px-5 py-3 border-t border-gray-200 flex items-center justify-between">
//                         <button
//                           onClick={() => navigate(block.path)}
//                           className="text-sm text-purple-600 font-medium flex items-center gap-1 hover:text-purple-800"
//                         >
//                           {block.action} <ArrowRightCircle size={18} />
//                         </button>
//                         <div className="flex items-center gap-3">
//                           <button
//                             onClick={() => togglePin(block.id)}
//                             title="Pin this"
//                           >
//                             <Pin
//                               size={18}
//                               className={
//                                 pinned.includes(block.id)
//                                   ? "text-red-600"
//                                   : "text-gray-400 hover:text-red-500"
//                               }
//                             />
//                           </button>
//                           <button
//                             onClick={() => toggleArchive(block.id)}
//                             title="Archive this"
//                           >
//                             <Archive
//                               size={18}
//                               className={
//                                 archived.includes(block.id)
//                                   ? "text-indigo-600"
//                                   : "text-gray-400 hover:text-indigo-500"
//                               }
//                             />
//                           </button>
//                         </div>
//                       </div>
//                     </div>
//                   )}
//                 </Draggable>
//               ))}
//               {provided.placeholder}
//             </div>
//           )}
//         </Droppable>
//       </DragDropContext>
//     </div>
//   );
// }
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Workspaces\InsightsWorkspacePage.jsx 
====================================================== 
 
// // üìÑ File: src/pages/Workspaces/InsightsWorkspacePage.jsx

// import { Card } from "../../components/ui/card";
// import { useNavigate } from "react-router-dom";
// import { useAuth } from "../auth/context/pld_AuthContext";

// export default function InsightsWorkspacePage() {
//   const navigate = useNavigate();
//   const { availableFeatures = {}, isLoading } = useAuth();

//   // üö© Feature-based cards
//   const insightCards = [
//     {
//       key: "CatalogInsights",
//       label: "üõçÔ∏è Catalog Dashboard",
//       desc: "Track catalog performance ‚Äî clicks, shares, and product views.",
//       onClick: () => navigate("/app/catalog/insights"),
//     },
//     {
//       key: "CRMInsights",
//       label: "ü§ù CRM Insights",
//       desc: "Understand lead behavior, contact activity, and follow-up stats.",
//       onClick: () => navigate("/app/insights/crm"),
//     },
//     {
//       key: "FlowInsights",
//       label: "üîÅ Flow Analytics",
//       desc: "Analyze CTA performance, click-through rates, and automation flows.",
//       onClick: () => navigate("/app/campaigns/FlowAnalyticsDashboard"),
//     },
//   ];

//   if (isLoading)
//     return (
//       <div className="p-10 text-center text-lg text-gray-500">
//         Loading features‚Ä¶
//       </div>
//     );

//   return (
//     <div className="p-6">
//       <h2 className="text-2xl font-bold text-purple-800 mb-6">
//         üìä Insights & Analytics Workspace
//       </h2>

//       <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
//         {insightCards
//           .filter(card => availableFeatures[card.key])
//           .map(card => (
//             <Card
//               key={card.key}
//               className="hover:shadow-lg transition cursor-pointer"
//               onClick={card.onClick}
//             >
//               <div className="p-6 space-y-4">
//                 <h3 className="text-lg font-semibold text-gray-800">
//                   {card.label}
//                 </h3>
//                 <p className="text-gray-600 text-sm">{card.desc}</p>
//               </div>
//             </Card>
//           ))}
//       </div>
//     </div>
//   );
// }
// üìÑ File: src/pages/Workspaces/InsightsWorkspacePage.jsx

import { Card } from "../../components/ui/card";
import { useNavigate } from "react-router-dom";
// Keep using your current auth hook location
import { useAuth } from "../auth/context/pld_AuthContext";

export default function InsightsWorkspacePage() {
  const navigate = useNavigate();

  // supports both legacy (availableFeatures) and new (hasAllAccess)
  const {
    availableFeatures = {},
    isLoading,
    role = "",
    hasAllAccess = false,
  } = useAuth?.() || {};

  const isSuperAdmin =
    hasAllAccess || String(role).toLowerCase() === "superadmin";

  // üö© Feature-based cards
  const insightCards = [
    {
      key: "CatalogInsights",
      label: "üõçÔ∏è Catalog Dashboard",
      desc: "Track catalog performance ‚Äî clicks, shares, and product views.",
      onClick: () => navigate("/app/catalog/insights"),
    },
    {
      key: "CRMInsights",
      label: "ü§ù CRM Insights",
      desc: "Understand lead behavior, contact activity, and follow-up stats.",
      onClick: () => navigate("/app/insights/crm"),
    },
    {
      key: "FlowInsights",
      label: "üîÅ Flow Analytics",
      desc: "Analyze CTA performance, click-through rates, and automation flows.",
      onClick: () => navigate("/app/campaigns/FlowAnalyticsDashboard"),
    },
  ];

  const visibleCards = isSuperAdmin
    ? insightCards
    : insightCards.filter(card => availableFeatures[card.key]);

  if (isLoading) {
    return (
      <div className="p-10 text-center text-lg text-gray-500">
        Loading features‚Ä¶
      </div>
    );
  }

  return (
    <div className="p-6">
      <h2 className="text-2xl font-bold text-purple-800 mb-6">
        üìä Insights & Analytics Workspace
      </h2>

      {visibleCards.length === 0 ? (
        <div className="bg-yellow-50 border border-yellow-200 text-yellow-800 rounded-md p-4">
          No insights available for your plan. If this seems wrong, check your
          feature toggles or contact an admin.
        </div>
      ) : (
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {visibleCards.map(card => (
            <Card
              key={card.key}
              className="hover:shadow-lg transition cursor-pointer"
              onClick={card.onClick}
            >
              <div className="p-6 space-y-4">
                <h3 className="text-lg font-semibold text-gray-800">
                  {card.label}
                </h3>
                <p className="text-gray-600 text-sm">{card.desc}</p>
              </div>
            </Card>
          ))}
        </div>
      )}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Workspaces\MessagingWorkspacePage.jsx 
====================================================== 
 
// üìÑ File: src/pages/Messaging/MessagingWorkspacePage.jsx

import {
  MessageSquareText,
  ArrowRightCircle,
  MoreVertical,
  Archive,
  Pin,
  Send,
  Clock4,
} from "lucide-react";
import { useNavigate } from "react-router-dom";
import { useState } from "react";
import { DragDropContext, Droppable, Draggable } from "react-beautiful-dnd";

// ‚úÖ server-authoritative permissions (can/hasAllAccess)
import { useAuth } from "../../app/providers/AuthProvider";
// ‚úÖ centralized permission codes (FK) ‚Äì falls back to string literals if missing
import { FK } from "../../capabilities/featureKeys";

// --- Permission map for each block (add/update codes here) ---
const PERM_BY_BLOCK = {
  "message-history": [FK?.MESSAGING_REPORT_VIEW ?? "messaging.report.view"],
  "status-logs": [FK?.MESSAGING_STATUS_VIEW ?? "messaging.status.view"],
  "open-chat": [FK?.MESSAGING_INBOX_VIEW ?? "messaging.inbox.view"],
  "send-direct-text": [FK?.MESSAGING_SEND_TEXT ?? "messaging.send.text"],
  "send-message": [FK?.MESSAGING_SEND ?? "messaging.send"], // ensure it renders
};

// --- Cards ---
const messageBlocks = [
  {
    id: "send-direct-text",
    label: "Send Non-Template Message",
    description: "Send Non-Template messages to one or multiple contacts.",
    path: "/app/messaging/send-direct-text",
    icon: <Send className="text-emerald-800" size={22} />,
    action: "Send-Direct-Text",
  },
  {
    id: "message-history",
    label: "Message History",
    description: "View all sent messages, delivery status, and logs.",
    path: "/app/messaging/reporting/direct-message-history",
    icon: <Clock4 className="text-emerald-800" size={22} />,
    action: "View Logs",
  },
];

export default function MessagingWorkspacePage() {
  const navigate = useNavigate();
  const { isLoading, can, hasAllAccess } = useAuth();

  const [pinned, setPinned] = useState(
    JSON.parse(localStorage.getItem("messaging-pinned") || "[]")
  );
  const [archived, setArchived] = useState(
    JSON.parse(localStorage.getItem("messaging-archived") || "[]")
  );
  const [order, setOrder] = useState(
    JSON.parse(localStorage.getItem("messaging-order")) ||
      messageBlocks.map(b => b.id)
  );
  const [showArchived, setShowArchived] = useState(false);

  const togglePin = (e, id) => {
    e.stopPropagation(); // keep card click from firing
    const updated = pinned.includes(id)
      ? pinned.filter(i => i !== id)
      : [...pinned, id];
    setPinned(updated);
    localStorage.setItem("messaging-pinned", JSON.stringify(updated));
  };

  const toggleArchive = (e, id) => {
    e.stopPropagation(); // keep card click from firing
    const updated = archived.includes(id)
      ? archived.filter(i => i !== id)
      : [...archived, id];
    setArchived(updated);
    localStorage.setItem("messaging-archived", JSON.stringify(updated));
  };

  const onDragEnd = result => {
    if (!result.destination) return;
    const newOrder = Array.from(order);
    const [moved] = newOrder.splice(result.source.index, 1);
    newOrder.splice(result.destination.index, 0, moved);
    setOrder(newOrder);
    localStorage.setItem("messaging-order", JSON.stringify(newOrder));
  };

  const canAny = codes =>
    hasAllAccess || (Array.isArray(codes) && codes.some(code => can(code)));

  const visibleBlocks = order
    .map(id => messageBlocks.find(b => b.id === id))
    .filter(Boolean)
    .filter(b => (showArchived ? true : !archived.includes(b.id)))
    .filter(b => canAny(PERM_BY_BLOCK[b.id] || []));

  if (isLoading)
    return (
      <div className="p-10 text-center text-lg text-gray-500">
        Loading features‚Ä¶
      </div>
    );

  return (
    <div className="p-6">
      {/* Local CSS for animated ‚Äúhand-drawn‚Äù border (keeps system hand cursor color) */}
      <style>{`
        @keyframes drawRight { from { transform: scaleX(0) } to { transform: scaleX(1) } }
        @keyframes drawDown  { from { transform: scaleY(0) } to { transform: scaleY(1) } }
        @keyframes drawLeft  { from { transform: scaleX(0) } to { transform: scaleX(1) } }
        @keyframes drawUp    { from { transform: scaleY(0) } to { transform: scaleY(1) } }

        .tile:hover .topline    { animation: drawRight .9s ease forwards; }
        .tile:hover .rightline  { animation: drawDown  .9s ease .18s forwards; }
        .tile:hover .bottomline { animation: drawLeft  .9s ease .36s forwards; }
        .tile:hover .leftline   { animation: drawUp    .9s ease .54s forwards; }

        /* Standard pointer ensures OS hand color remains unchanged */
        .cursor-finger { cursor: pointer; }
      `}</style>

      <div className="flex items-center justify-between mb-4">
        <h2 className="text-2xl font-bold text-emerald-800">
          üí¨ Messaging Workspace
        </h2>
        <label className="flex items-center gap-2 text-sm font-medium text-gray-700">
          <input
            type="checkbox"
            checked={showArchived}
            onChange={() => setShowArchived(!showArchived)}
            className="accent-purple-600"
          />
          Show Archived
        </label>
      </div>

      <DragDropContext onDragEnd={onDragEnd}>
        <Droppable droppableId="messaging-blocks" direction="horizontal">
          {provided => (
            <div
              className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"
              ref={provided.innerRef}
              {...provided.droppableProps}
            >
              {visibleBlocks.map((block, index) => (
                <Draggable key={block.id} draggableId={block.id} index={index}>
                  {provided => (
                    <div
                      ref={provided.innerRef}
                      {...provided.draggableProps}
                      {...provided.dragHandleProps}
                      role="button"
                      tabIndex={0}
                      aria-label={`${block.label}: ${block.action}`}
                      onKeyDown={e => {
                        if (e.key === "Enter") navigate(block.path);
                      }}
                      onClick={() => navigate(block.path)}
                      className="tile group relative overflow-hidden rounded-md border bg-white shadow-sm transition duration-200 hover:-translate-y-0.5 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-purple-300 cursor-finger"
                    >
                      {/* Animated border: top ‚Üí right ‚Üí bottom ‚Üí left */}
                      <span
                        aria-hidden
                        className="topline pointer-events-none absolute left-0 -top-[2px] h-[2px] w-full origin-left rounded opacity-0 group-hover:opacity-100"
                        style={{
                          background:
                            "linear-gradient(90deg, #374151, #D1D5DB, #F3E8FF)",
                          transform: "scaleX(0)",
                        }}
                      />
                      <span
                        aria-hidden
                        className="rightline pointer-events-none absolute right-0 -top-[2px] h-[calc(100%+4px)] w-[2px] origin-top rounded opacity-0 group-hover:opacity-100"
                        style={{
                          background:
                            "linear-gradient(180deg, #374151, #D1D5DB, #F3E8FF)",
                          transform: "scaleY(0)",
                        }}
                      />
                      <span
                        aria-hidden
                        className="bottomline pointer-events-none absolute left-0 -bottom-[2px] h-[2px] w-full origin-right rounded opacity-0 group-hover:opacity-100"
                        style={{
                          background:
                            "linear-gradient(270deg, #374151, #D1D5DB, #F3E8FF)",
                          transform: "scaleX(0)",
                        }}
                      />
                      <span
                        aria-hidden
                        className="leftline pointer-events-none absolute left-0 -top-[2px] h-[calc(100%+4px)] w-[2px] origin-bottom rounded opacity-0 group-hover:opacity-100"
                        style={{
                          background:
                            "linear-gradient(0deg, #374151, #D1D5DB, #F3E8FF)",
                          transform: "scaleY(0)",
                        }}
                      />

                      {/* Card body */}
                      <div className="flex items-start gap-4 p-5">
                        <div className="bg-emerald-50 rounded-md p-2">
                          {block.icon}
                        </div>
                        <div className="flex-1">
                          <h3 className="text-md font-semibold text-emerald-800 group-hover:text-emerald-900">
                            {block.label}
                          </h3>
                          <p className="text-sm text-slate-600">
                            {block.description}
                          </p>
                        </div>
                        <MoreVertical size={16} className="text-gray-400" />
                      </div>

                      {/* Footer (buttons stop card click) */}
                      <div className="px-5 py-3 border-t border-gray-200 flex items-center justify-between">
                        <button
                          onClick={e => {
                            e.stopPropagation();
                            navigate(block.path);
                          }}
                          className="text-sm text-gray-700 font-medium flex items-center gap-1 hover:text-gray-900"
                        >
                          {block.action} <ArrowRightCircle size={18} />
                        </button>
                        <div className="flex items-center gap-3">
                          <button
                            onClick={e => togglePin(e, block.id)}
                            title="Pin this"
                          >
                            <Pin
                              size={18}
                              className={
                                pinned.includes(block.id)
                                  ? "text-red-600"
                                  : "text-gray-400 hover:text-red-500"
                              }
                            />
                          </button>
                          <button
                            onClick={e => toggleArchive(e, block.id)}
                            title="Archive this"
                          >
                            <Archive
                              size={18}
                              className={
                                archived.includes(block.id)
                                  ? "text-indigo-600"
                                  : "text-gray-400 hover:text-indigo-500"
                              }
                            />
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                </Draggable>
              ))}
              {provided.placeholder}
            </div>
          )}
        </Droppable>
      </DragDropContext>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Workspaces\SettingsWorkspacePage.jsx 
====================================================== 
 
// üìÑ src/pages/Workspaces/SettingsWorkspace.jsx
import { useNavigate } from "react-router-dom";
import { useAuth } from "../../app/providers/AuthProvider";
import { FK } from "../../capabilities/featureKeys";
import { Phone, Palette, Lock, Globe, BarChart3 } from "lucide-react";

function Card({ icon, title, desc, onClick }) {
  return (
    <button
      type="button"
      onClick={onClick}
      className="w-full text-left rounded-xl border p-5 transition hover:shadow-md bg-white"
    >
      <div className="flex items-start gap-3">
        <div className="p-2 rounded-md bg-emerald-50 text-emerald-800">
          {icon}
        </div>
        <div>
          <div className="text-emerald-800 font-semibold group-hover:text-emerald-900">
            {title}
          </div>
          <div className="text-sm text-slate-600">{desc}</div>
        </div>
      </div>
    </button>
  );
}

export default function SettingsWorkspace() {
  const nav = useNavigate();
  const { can, hasAllAccess, isLoading } = useAuth();

  if (isLoading) return null;

  const allow = perm => hasAllAccess || can(perm);

  // Define tiles with their required permission and where they go
  const tiles = [
    {
      key: "whatsapp",
      perm: FK.SETTINGS_WHATSAPP_VIEW,
      icon: <Phone size={20} />,
      title: "WhatsApp Settings",
      desc: "Configure WhatsApp credentials and integration.",
      onClick: () => nav("/app/settings/whatsapp"),
    },
    {
      key: "theme",
      perm: FK.SETTINGS_THEME_UPDATE,
      icon: <Palette size={20} />,
      title: "Theme & Colors",
      desc: "Choose light/dark mode and accent colors.",
      onClick: () => nav("/app/settings/theme"),
    },
    {
      key: "password",
      perm: FK.SETTINGS_PASSWORD_UPDATE,
      icon: <Lock size={20} />,
      title: "Change Password",
      desc: "Update your account password.",
      onClick: () => nav("/app/settings/password"),
    },
    {
      key: "meta-account",
      perm: FK.SETTINGS_WHATSAPP_VIEW, // reuse existing permission for now
      icon: <Globe size={20} />,
      title: "Meta Account Management",
      desc: "Disconnect WhatsApp or handle Meta data deletion.",
      onClick: () => nav("/app/settings/meta-account"),
    },
    {
      key: "billing",
      perm: FK.SETTINGS_WHATSAPP_VIEW, // or create a proper FK if you want
      icon: (
        <svg
          className="w-5 h-5 text-purple-600"
          fill="none"
          stroke="currentColor"
          strokeWidth="1.8"
          viewBox="0 0 24 24"
        >
          <rect x="3" y="5" width="18" height="14" rx="2" ry="2" />
          <path d="M3 9h18" />
          <path d="M8 14h2" />
        </svg>
      ),
      title: "Billing & Subscription",
      desc: "View your current plan, invoices, and manage payments.",
      onClick: () => nav("/app/settings/billing"),
    },
  ];

  const visibleTiles = tiles.filter(t => allow(t.perm));

  return (
    <div className="p-6">
      <h1 className="text-2xl font-bold text-emerald-800 mb-4">Settings</h1>

      {visibleTiles.length === 0 ? (
        <div className="text-sm text-gray-500">
          You don‚Äôt have access to any settings here.
        </div>
      ) : (
        <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
          {visibleTiles.map(t => (
            <Card
              key={t.key}
              icon={t.icon}
              title={t.title}
              desc={t.desc}
              onClick={t.onClick}
            />
          ))}
        </div>
      )}
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Workspaces\TemplateBuilderWorkspacePage.jsx 
====================================================== 
 
import {
  FolderKanban,
  PlusCircle,
  ListChecks,
  Archive,
  Pin,
  ArrowRightCircle,
  MoreVertical,
  FileBarChart,
} from "lucide-react";
import { useNavigate } from "react-router-dom";
import { useState } from "react";
import { DragDropContext, Draggable, Droppable } from "react-beautiful-dnd";

import { useAuth } from "../../app/providers/AuthProvider";
import { FK } from "../../capabilities/featureKeys";
// Map UI blocks ‚Üí required permissions (reuse your FK set for now)
const PERM_BY_BLOCK = {
  "template.builder.view": [FK.TEMPLATE_BUILDER_VIEW],
  "template.builder.create.draft": [FK.TEMPLATE_BUILDER_CREATE_DRAFT],

  "template.builder.approved.templates.view": [
    FK.TEMPLATE_BUILDER_APPROVED_TEMPLATES_VIEW,
  ],
  "template.builder.library.browse": [FK.TEMPLATE_BUILDER_LIBRARY_BROWSE],
};

// Tiles (routes align with steps we built on backend)
const templateBlocks = [
  {
    id: "template.builder.approved.templates.view",
    label: "Approved Templates",
    description: "View approved templates and delete at Meta if needed.",
    // (You can wire this to a simple list/grid that reads WhatsAppTemplates and calls DELETE /api/template-builder/templates/{name})
    path: "/app/template-builder/approved",
    icon: <FileBarChart className="text-pink-500" size={22} />,
    action: "Manage Approved",
  },
  {
    id: "template.builder.library.browse",
    label: "Template Library",
    description:
      "Browse segmented templates (Salon, Gym, Doctor, etc.) and preview.",
    path: "/app/template-builder/library",
    icon: <FolderKanban className="text-indigo-600" size={22} />,
    action: "Open Library",
  },
  {
    id: "template.builder.create.draft",
    label: "My Drafts",
    description:
      "Edit header/body/buttons, upload media, preview & submit to Meta.",
    // (If you later add a Drafts list page, point here. For now, you can navigate directly when a draft is created.)
    path: "/app/template-builder/drafts",
    icon: <ListChecks className="text-purple-600" size={22} />,
    action: "Manage Drafts",
  },
];

export default function TemplateBuilderWorkspacePage() {
  const navigate = useNavigate();
  const { isLoading, can, hasAllAccess } = useAuth();

  const [pinned, setPinned] = useState(
    JSON.parse(localStorage.getItem("tpl-pinned") || "[]")
  );
  const [archived, setArchived] = useState(
    JSON.parse(localStorage.getItem("tpl-archived") || "[]")
  );
  const [order, setOrder] = useState(
    JSON.parse(localStorage.getItem("tpl-order")) ||
      templateBlocks.map(b => b.id)
  );

  const togglePin = (e, id) => {
    e.stopPropagation();
    const updated = pinned.includes(id)
      ? pinned.filter(i => i !== id)
      : [...pinned, id];
    setPinned(updated);
    localStorage.setItem("tpl-pinned", JSON.stringify(updated));
  };

  const toggleArchive = (e, id) => {
    e.stopPropagation();
    const updated = archived.includes(id)
      ? archived.filter(i => i !== id)
      : [...archived, id];
    setArchived(updated);
    localStorage.setItem("tpl-archived", JSON.stringify(updated));
  };

  const onDragEnd = result => {
    if (!result.destination) return;
    const newOrder = Array.from(order);
    const [moved] = newOrder.splice(result.source.index, 1);
    newOrder.splice(result.destination.index, 0, moved);
    setOrder(newOrder);
    localStorage.setItem("tpl-order", JSON.stringify(newOrder));
  };

  const canAny = codes => hasAllAccess || (codes || []).some(code => can(code));
  const isAllowed = block => canAny(PERM_BY_BLOCK[block.id]);

  const visibleBlocks = order
    .map(id => templateBlocks.find(b => b && b.id === id))
    .filter(Boolean)
    .filter(b => !archived.includes(b.id))
    .filter(isAllowed);

  if (isLoading)
    return (
      <div className="p-10 text-center text-lg text-gray-500">
        Loading features‚Ä¶
      </div>
    );

  return (
    <div className="p-6">
      {/* Animated ‚Äúhand-drawn‚Äù border like your Campaign workspace */}
      <style>{`
        @keyframes drawRight { from { transform: scaleX(0) } to { transform: scaleX(1) } }
        @keyframes drawDown  { from { transform: scaleY(0) } to { transform: scaleY(1) } }
        @keyframes drawLeft  { from { transform: scaleX(0) } to { transform: scaleX(1) } }
        @keyframes drawUp    { from { transform: scaleY(0) } to { transform: scaleY(1) } }

        .tile:hover .topline    { animation: drawRight .9s ease forwards; }
        .tile:hover .rightline  { animation: drawDown  .9s ease .18s forwards; }
        .tile:hover .bottomline { animation: drawLeft  .9s ease .36s forwards; }
        .tile:hover .leftline   { animation: drawUp    .9s ease .54s forwards; }
      `}</style>

      <h2 className="text-2xl font-bold text-purple-800 mb-4">
        ‚ú® Template Builder
      </h2>
      <p className="text-sm text-gray-600 mb-6">
        Create professional WhatsApp templates in minutes. Start from our
        segmented library, customize drafts, preview, and submit for approval.
      </p>

      <DragDropContext onDragEnd={onDragEnd}>
        <Droppable droppableId="template-blocks" direction="horizontal">
          {provided => (
            <div
              className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"
              ref={provided.innerRef}
              {...provided.droppableProps}
            >
              {visibleBlocks.map((block, index) => (
                <Draggable key={block.id} draggableId={block.id} index={index}>
                  {provided => (
                    <div
                      ref={provided.innerRef}
                      {...provided.draggableProps}
                      role="button"
                      tabIndex={0}
                      aria-label={`${block.label}: ${block.action}`}
                      onKeyDown={e => {
                        if (e.key === "Enter") navigate(block.path);
                      }}
                      onClick={() => navigate(block.path)}
                      className="tile group relative overflow-hidden cursor-pointer bg-white rounded-md border shadow-sm hover:shadow-md transition transform hover:-translate-y-0.5 duration-200 focus:outline-none focus:ring-2 focus:ring-purple-300"
                      style={{ userSelect: "none" }}
                    >
                      {/* Animated borders */}
                      <span
                        aria-hidden
                        className="topline pointer-events-none absolute left-0 -top-[2px] h-[2px] w-full origin-left rounded opacity-0 group-hover:opacity-100"
                        style={{
                          background:
                            "linear-gradient(90deg, #6B7280, #374151, #F3E8FF)",
                          transform: "scaleX(0)",
                        }}
                      />
                      <span
                        aria-hidden
                        className="rightline pointer-events-none absolute right-0 -top-[2px] h-[calc(100%+4px)] w-[2px] origin-top rounded opacity-0 group-hover:opacity-100"
                        style={{
                          background:
                            "linear-gradient(180deg, #6B7280, #374151, #F3E8FF)",
                          transform: "scaleY(0)",
                        }}
                      />
                      <span
                        aria-hidden
                        className="bottomline pointer-events-none absolute left-0 -bottom-[2px] h-[2px] w-full origin-right rounded opacity-0 group-hover:opacity-100"
                        style={{
                          background:
                            "linear-gradient(270deg, #6B7280, #374151, #F3E8FF)",
                          transform: "scaleX(0)",
                        }}
                      />
                      <span
                        aria-hidden
                        className="leftline pointer-events-none absolute left-0 -top-[2px] h-[calc(100%+4px)] w-[2px] origin-bottom rounded opacity-0 group-hover:opacity-100"
                        style={{
                          background:
                            "linear-gradient(0deg, #6B7280, #374151, #F3E8FF)",
                          transform: "scaleY(0)",
                        }}
                      />

                      <div className="flex items-start gap-4 p-5">
                        <div className="bg-gray-100 rounded-md p-2">
                          {block.icon}
                        </div>
                        <div className="flex-1">
                          <h3 className="text-md font-semibold text-purple-700">
                            {block.label}
                          </h3>
                          <p className="text-sm text-gray-600">
                            {block.description}
                          </p>
                        </div>

                        {/* Drag handle only on kebab */}
                        <div
                          {...provided.dragHandleProps}
                          title="Drag to re-order"
                          className="ml-2 rounded p-1 text-gray-400 hover:text-gray-600 cursor-grab active:cursor-grabbing"
                          onClick={e => e.stopPropagation()}
                        >
                          <MoreVertical size={16} />
                        </div>
                      </div>

                      <div className="px-5 py-3 border-t border-gray-200 flex items-center justify-between">
                        <button
                          onClick={e => {
                            e.stopPropagation();
                            navigate(block.path);
                          }}
                          className="text-sm text-purple-600 font-medium flex items-center gap-1 hover:text-purple-800"
                        >
                          {block.action} <ArrowRightCircle size={18} />
                        </button>

                        <div className="flex items-center gap-3">
                          <button
                            onClick={e => togglePin(e, block.id)}
                            title="Pin this"
                          >
                            <Pin
                              size={18}
                              className={
                                pinned.includes(block.id)
                                  ? "text-red-600"
                                  : "text-gray-400 hover:text-red-500"
                              }
                            />
                          </button>
                          <button
                            onClick={e => toggleArchive(e, block.id)}
                            title="Archive this"
                          >
                            <Archive
                              size={18}
                              className={
                                archived.includes(block.id)
                                  ? "text-indigo-600"
                                  : "text-gray-400 hover:text-indigo-500"
                              }
                            />
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                </Draggable>
              ))}
              {provided.placeholder}
            </div>
          )}
        </Droppable>
      </DragDropContext>
    </div>
  );
}
 
 
====================================================== 
FILE: D:\xbytechat\xbytechat-ui\src\pages\Workspaces\WelcomeCenter.jsx 
====================================================== 
 
import { useState } from "react";
import { useNavigate } from "react-router-dom";
import {
  Play,
  UsersRound,
  CheckCircle,
  ChevronRight,
  Lock,
  ArrowRight,
} from "lucide-react";
import { useAuth } from "../../app/providers/AuthProvider";
import { usePlan } from "../auth/hooks/usePlan";

export default function WelcomeCenter() {
  const navigate = useNavigate();
  const { userName } = useAuth();
  const { planObj } = usePlan();

  const [accessCode, setAccessCode] = useState("");
  const [expandedSteps, setExpandedSteps] = useState({
    step1: true,
    step2: false,
    step3: false,
  });

  // Mock credit data - replace with actual API call
  const [credits] = useState({
    ai: 500.0,
    ads: 0.0,
    freeConversations: 0,
    wcc: 50.0,
  });

  const handleStartFreeTrial = () => {
    navigate("/app/upgrade");
  };

  const handleApplyWhatsAppAPI = () => {
    navigate("/app/settings/whatsapp");
  };

  const handleActivateCode = () => {
    // TODO: Implement access code activation
    console.log("Activate code:", accessCode);
  };

  const toggleStep = step => {
    setExpandedSteps(prev => ({
      ...prev,
      [step]: !prev[step],
    }));
  };

  return (
    <div className="min-h-screen bg-gray-50 p-4 md:p-6 lg:p-8">
      {/* Welcome Bar moved to Dashboard header */}

      {/* Main Content Grid */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Left Column */}
        <div className="lg:col-span-2 space-y-6">
          {/* Free Trial Banner */}
          <div className="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-400 rounded-lg p-4 shadow-sm hover:shadow-md transition-all duration-200">
            <div className="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
              <div className="flex items-start gap-3">
                <div className="text-3xl">üíé</div>
                <div>
                  <h3 className="text-lg font-bold text-green-900">
                    Unlock Everything for 1 Month‚ÄîFree!
                  </h3>
                  <p className="text-sm text-green-700 mt-1 flex items-center gap-1">
                    <UsersRound size={14} />
                    Join thousands of satisfied users today
                  </p>
                  <p className="text-xs text-green-600 mt-2">
                    Get full access to all features across the platform
                  </p>
                  <ul className="text-xs text-green-700 mt-1 list-disc list-inside">
                    <li>
                      Experience a complete 1-month free trial of the entire
                      platform
                    </li>
                    <li>
                      Access all Pro + Flow plan features and capabilities
                    </li>
                  </ul>
                </div>
              </div>
              <button
                onClick={handleStartFreeTrial}
                className="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold shadow hover:shadow-md transition flex items-center gap-2 shrink-0"
              >
                Start Free Trial Now
                <ArrowRight size={18} />
              </button>
            </div>
          </div>

          {/* Access Code Section */}
          <div className="bg-gradient-to-r from-orange-50 to-amber-50 border border-orange-400 rounded-lg p-4 shadow-sm hover:shadow-md transition-all duration-200">
            <div className="flex items-start gap-3">
              <div className="text-3xl">üéÅ</div>
              <div className="flex-1">
                <h3 className="text-lg font-bold text-orange-900">
                  Got any offer access code?
                </h3>
                <p className="text-sm text-orange-700 mt-1">
                  Activate your special discounted offer now!
                </p>
                <div className="flex gap-2 mt-3">
                  <input
                    type="text"
                    placeholder="Enter access code"
                    value={accessCode}
                    onChange={e => setAccessCode(e.target.value)}
                    className="flex-1 px-3 py-2 border border-orange-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-orange-500"
                  />
                  <button
                    onClick={handleActivateCode}
                    className="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-md font-medium transition"
                  >
                    Activate ‚Üí
                  </button>
                  <button className="bg-white hover:bg-orange-50 text-orange-700 px-4 py-2 rounded-md border border-orange-300 font-medium transition">
                    View Offers
                  </button>
                </div>
              </div>
            </div>
          </div>

          {/* Setup WhatsApp Business API */}
          <div className="bg-white border rounded-lg p-4 shadow-sm">
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-lg font-bold text-gray-900">
                Setup FREE WhatsApp Business Account
              </h3>
              <span className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">
                3 steps left
              </span>
            </div>

            {/* Step 1 - Apply for WhatsApp Business API */}
            <div className="border border-gray-300 rounded-lg mb-2 hover:border-gray-400 transition-colors duration-200">
              <button
                onClick={() => toggleStep("step1")}
                className="w-full flex items-center justify-between p-4 text-left hover:bg-gray-50 transition"
              >
                <div className="flex items-center gap-3">
                  <CheckCircle className="text-green-600" size={20} />
                  <span className="font-semibold text-gray-900">
                    Apply for WhatsApp Business API
                  </span>
                </div>
                <ChevronRight
                  className={`transition-transform ${
                    expandedSteps.step1 ? "rotate-90" : ""
                  }`}
                  size={16}
                />
              </button>

              {expandedSteps.step1 && (
                <div className="px-4 pb-4 border-t border-gray-200">
                  <div className="pt-4">
                    <p className="text-sm text-gray-600 mb-3">
                      Click on Continue With Facebook to apply for WhatsApp
                      Business API
                    </p>
                    <p className="text-xs text-gray-500 mb-3">
                      Requirements to apply for WhatsApp Business API: A
                      Registered Business & Working Website.
                    </p>

                    {/* Video Tutorial */}
                    <div className="relative bg-gray-200 rounded-lg aspect-video mb-3">
                      <div className="absolute inset-0 flex items-center justify-center">
                        <Play className="text-purple-600" size={40} />
                      </div>
                      <div className="absolute top-2 left-2 bg-white px-2 py-1 rounded text-xs font-semibold">
                        Tutorial
                      </div>
                      <div className="absolute bottom-2 left-2 right-2">
                        <div className="bg-white rounded p-2">
                          <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                              <Play className="text-purple-600" size={16} />
                            </div>
                            <div>
                              <p className="text-xs font-semibold text-gray-700">
                                How to get FREE WhatsApp API
                              </p>
                              <span className="text-xs text-purple-600">
                                in 10 Mins
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Action Buttons */}
                    <div className="flex gap-2 mt-3">
                      <button className="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-md text-sm font-medium transition">
                        Schedule Meetings
                      </button>
                      <button
                        onClick={handleApplyWhatsAppAPI}
                        className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md text-sm font-medium transition shadow"
                      >
                        Continue With Facebook
                      </button>
                    </div>

                    {/* Link to tutorial */}
                    <button className="text-xs text-blue-600 hover:underline mt-2">
                      How to apply for WhatsApp Business API?
                    </button>
                  </div>
                </div>
              )}
            </div>

            {/* Step 2 - Increase messaging limit & get display name approved */}
            <div className="border border-gray-300 rounded-lg mb-2 hover:border-gray-400 transition-colors duration-200">
              <button
                onClick={() => toggleStep("step2")}
                className="w-full flex items-center justify-between p-4 text-left hover:bg-gray-50 transition"
              >
                <div className="flex items-center gap-3">
                  <CheckCircle className="text-orange-500" size={20} />
                  <span className="font-semibold text-gray-900">
                    Increase your messaging limit & get your display name
                    approved
                  </span>
                </div>
                <ChevronRight
                  className={`transition-transform ${
                    expandedSteps.step2 ? "rotate-90" : ""
                  }`}
                  size={16}
                />
              </button>

              {expandedSteps.step2 && (
                <div className="px-4 pb-4 border-t border-gray-200">
                  <div className="pt-4">
                    <p className="text-sm text-gray-600 mb-4">
                      Verify your business identity to unlock higher messaging
                      capacity and get your business name verified
                    </p>

                    {/* KYC Requirements */}
                    <div className="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-4">
                      <h5 className="text-sm font-semibold text-orange-900 mb-3">
                        Verification Checklist:
                      </h5>
                      <ul className="text-sm text-orange-800 space-y-2 list-disc list-inside">
                        <li>
                          Business name on your GST registration must be
                          identical to your Facebook Business Manager account
                        </li>
                        <li>
                          Your company website must be live and accessible
                          before submitting verification documents
                        </li>
                        <li>
                          Submit the Aadhaar card of the director whose name
                          appears on your GST certificate
                        </li>
                      </ul>
                      <p className="text-xs text-orange-700 mt-3">
                        Need additional guidance? Check our{" "}
                        <button className="underline font-semibold">
                          verification guide
                        </button>
                      </p>
                    </div>

                    <button className="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-md text-sm font-medium transition">
                      Start KYC
                    </button>
                  </div>
                </div>
              )}
            </div>

            {/* Step 3 - Setup Your Profile */}
            <div className="border border-gray-300 rounded-lg mb-2 hover:border-gray-400 transition-colors duration-200">
              <button
                onClick={() => toggleStep("step3")}
                className="w-full flex items-center justify-between p-4 text-left hover:bg-gray-50 transition"
              >
                <div className="flex items-center gap-3">
                  <CheckCircle className="text-blue-500" size={20} />
                  <span className="font-semibold text-gray-900">
                    Setup Your Profile
                  </span>
                </div>
                <ChevronRight
                  className={`transition-transform ${
                    expandedSteps.step3 ? "rotate-90" : ""
                  }`}
                  size={16}
                />
              </button>

              {expandedSteps.step3 && (
                <div className="px-4 pb-4 border-t border-gray-200">
                  <div className="pt-4">
                    <p className="text-sm text-gray-600 mb-3">
                      Complete your business profile with logo, description, and
                      contact information.
                    </p>
                    <button
                      onClick={() =>
                        window.open(
                          "https://business.facebook.com/latest/whatsapp_manager/overview/?business_id=1691627885569206&tab=home&nav_ref=whatsapp_manager&asset_id=1777503206267612",
                          "_blank"
                        )
                      }
                      className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium transition"
                    >
                      Edit Profile
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* Start WhatsApp Engagement Section moved to dashboard header */}

          {/* Tutorials Section */}
          <div className="bg-white border rounded-lg p-4 shadow-sm">
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-lg font-bold text-gray-900">
                Platform Walkthrough & Tutorials
              </h3>
              <button className="text-sm text-purple-600 hover:underline">
                Read Platform Guide
              </button>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {/* Video 1 */}
              <div className="relative bg-gray-200 rounded-lg aspect-video">
                <div className="absolute inset-0 flex items-center justify-center">
                  <Play className="text-purple-600" size={40} />
                </div>
                <div className="absolute bottom-2 right-2 bg-purple-600 text-white px-2 py-1 rounded text-xs font-semibold">
                  HINDI
                </div>
                <p className="absolute bottom-2 left-2 text-xs font-semibold text-gray-800 bg-white px-2 py-1 rounded">
                  XploreByte Platform Demo
                </p>
              </div>

              {/* Video 2 */}
              <div className="relative bg-gray-200 rounded-lg aspect-video">
                <div className="absolute inset-0 flex items-center justify-center">
                  <Play className="text-purple-600" size={40} />
                </div>
                <p className="absolute bottom-2 left-2 text-xs font-semibold text-gray-800 bg-white px-2 py-1 rounded">
                  XploreByte Smartest WhatsApp Engagement Platform
                </p>
              </div>
            </div>
          </div>

          {/* Feature Lists */}
          <div className="bg-white border rounded-lg p-4 shadow-sm">
            <h3 className="text-lg font-bold text-gray-900 mb-4">
              Quick Links & Resources
            </h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {/* Left Column */}
              <div>
                <h4 className="font-semibold text-gray-700 mb-2">
                  üìÑ Templates
                </h4>
                <ul className="space-y-2 text-sm">
                  <li className="text-blue-600 hover:underline cursor-pointer">
                    How to Create WhatsApp Template Message?
                  </li>
                  <li className="text-blue-600 hover:underline cursor-pointer">
                    Use chatbot parameters for leads
                  </li>
                  <li className="text-blue-600 hover:underline cursor-pointer">
                    Add Quick Reply to WhatsApp Template Message
                  </li>
                  <li className="text-blue-600 hover:underline cursor-pointer">
                    Message formatting guideline (Bold, Italic & more)
                  </li>
                </ul>

                <h4 className="font-semibold text-gray-700 mb-2 mt-6">
                  üí¨ Live Chat & Attributes
                </h4>
                <ul className="space-y-2 text-sm">
                  <li className="text-blue-600 hover:underline cursor-pointer">
                    Add user attributes manually
                  </li>
                  <li className="text-blue-600 hover:underline cursor-pointer">
                    Add/Remove Tag & update attribute
                  </li>
                  <li className="text-blue-600 hover:underline cursor-pointer">
                    Send & Generate media link
                  </li>
                  <li className="text-blue-600 hover:underline cursor-pointer">
                    Chat Profile & First Message Tag
                  </li>
                  <li className="text-blue-600 hover:underline cursor-pointer">
                    How to create & add tags to contacts
                  </li>
                </ul>
              </div>

              {/* Right Column */}
              <div>
                <h4 className="font-semibold text-gray-700 mb-2">
                  üì¢ Campaigns
                </h4>
                <ul className="space-y-2 text-sm">
                  <li className="text-blue-600 hover:underline cursor-pointer">
                    Audience segregation for WhatsApp Broadcast
                  </li>
                  <li className="text-blue-600 hover:underline cursor-pointer">
                    Upgrade WhatsApp Tier Limit
                  </li>
                  <li className="text-blue-600 hover:underline cursor-pointer">
                    Import upto 2 lakh contacts in one go
                  </li>
                </ul>

                <h4 className="font-semibold text-gray-700 mb-2 mt-6">
                  ü§ñ Chatbot & Integration
                </h4>
                <ul className="space-y-2 text-sm">
                  <li className="text-blue-600 hover:underline cursor-pointer">
                    Setup Welcome WhatsApp Chatbot
                  </li>
                  <li className="text-blue-600 hover:underline cursor-pointer">
                    Create WhatsApp Button for Free
                  </li>
                  <li className="text-blue-600 hover:underline cursor-pointer">
                    Create WhatsApp Link for Free
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        {/* Right Column */}
        <div className="space-y-6">
          {/* Credits Section */}
          <div className="bg-white border rounded-lg p-4 shadow-sm">
            <div className="flex items-center justify-between mb-4">
              <h3 className="font-semibold text-gray-900">Credits</h3>
              <div className="w-2 h-2 bg-gray-400 rounded-full"></div>
            </div>

            <div className="space-y-3">
              {/* WhatsApp Conversation Credits */}
              <div className="bg-gray-50 rounded-lg p-3 border border-gray-300 hover:border-gray-400 transition-colors duration-200">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center">
                      <span className="text-gray-600 text-sm">üì±</span>
                    </div>
                    <div>
                      <span className="text-sm font-medium text-gray-900">
                        WhatsApp Credits
                      </span>
                      <div className="text-lg font-bold text-gray-900">
                        ‚Çπ{credits.wcc.toFixed(2)}
                      </div>
                    </div>
                  </div>
                  <button className="px-3 py-1.5 border-2 border-gray-800 text-gray-800 hover:bg-gray-800 hover:text-white rounded text-xs font-medium transition-all duration-200">
                    Buy More
                  </button>
                </div>
              </div>

              {/* Advertisement Credits */}
              <div className="bg-gray-50 rounded-lg p-3 border border-gray-300 hover:border-gray-400 transition-colors duration-200">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center">
                      <span className="text-gray-600 text-sm">üì¢</span>
                    </div>
                    <div>
                      <span className="text-sm font-medium text-gray-900">
                        Advertisement Credits
                      </span>
                      <div className="text-lg font-bold text-gray-900">
                        ‚Çπ{credits.ads.toFixed(2)}
                      </div>
                    </div>
                  </div>
                  <button className="px-3 py-1.5 border-2 border-gray-800 text-gray-800 hover:bg-gray-800 hover:text-white rounded text-xs font-medium transition-all duration-200">
                    Buy Credits
                  </button>
                </div>
              </div>

              {/* Free Service Conversation */}
              <div className="bg-gray-50 rounded-lg p-3 border border-gray-300 hover:border-gray-400 transition-colors duration-200">
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-3">
                    <div className="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center">
                      <span className="text-gray-600 text-sm">üí¨</span>
                    </div>
                    <span className="text-sm font-medium text-gray-900">
                      Free Conversations
                    </span>
                  </div>
                  <span className="text-lg font-bold text-gray-900">
                    {credits.freeConversations} / ‚àû
                  </span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-2">
                  <div
                    className="bg-gray-600 h-2 rounded-full"
                    style={{ width: "100%" }}
                  ></div>
                </div>
              </div>
            </div>
          </div>

          {/* Customize WhatsApp Link */}
          <div className="bg-gradient-to-br from-green-50 to-emerald-50 border border-green-300 rounded-lg p-4 shadow-sm cursor-pointer hover:shadow-md hover:border-green-400 transition-all duration-200">
            <div className="flex items-center gap-3">
              <div className="text-3xl">üîó</div>
              <div>
                <h4 className="font-semibold text-green-900">
                  Customize WhatsApp Link
                </h4>
                <p className="text-xs text-green-700 mt-1">
                  Create shareable links & QR for your WA business number.
                </p>
              </div>
            </div>
          </div>

          {/* WhatsApp Website Button */}
          <div className="bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-300 rounded-lg p-4 shadow-sm cursor-pointer hover:shadow-md hover:border-blue-400 transition-all duration-200">
            <div className="flex items-center gap-3">
              <div className="text-3xl">üåê</div>
              <div>
                <h4 className="font-semibold text-blue-900">
                  WhatsApp Website Button
                </h4>
                <p className="text-xs text-blue-700 mt-1">
                  Drive WhatsApp sales with personalised CTAs.
                </p>
              </div>
            </div>
          </div>

          {/* Unlock Premium Features */}
          <div className="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-300 rounded-lg p-4 shadow-sm">
            <div className="flex items-start gap-3">
              <Lock className="text-green-600 mt-1" size={24} />
              <div>
                <h4 className="font-bold text-green-900">
                  Unlock All Premium Features
                </h4>
                <p className="text-sm text-green-700 mt-1">Free for 1 Month!</p>
                <button
                  onClick={handleStartFreeTrial}
                  className="mt-3 w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white py-2 rounded-lg font-semibold transition-all duration-200 shadow hover:shadow-lg flex items-center justify-center gap-2"
                >
                  Start Free Trial Now
                  <ArrowRight size={16} />
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
 
 
